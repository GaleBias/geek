<audio title="05 _ å¤šçº¿ç¨‹ï¼šå¤šçº¿ç¨‹ç¼–ç¨‹æœ‰å“ªäº›å¸¸è§çš„è®¾è®¡æ¨¡å¼ï¼Ÿ" src="https://static001.geekbang.org/resource/audio/ef/77/ef38b6f0c1f919066d6cdbc3077b9977.mp3" controls="controls"></audio> 
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ä¸å¨ã€‚</p><p>ä»è¿™èŠ‚è¯¾å¼€å§‹ï¼Œæˆ‘ä»¬å¼€å§‹å­¦ä¹ Javaå¤šçº¿ç¨‹ç¼–ç¨‹ã€‚</p><p>å¤šçº¿ç¨‹æ˜¯å¾ˆå¤šäººåœ¨æå‡æŠ€æœ¯èƒ½åŠ›çš„è¿‡ç¨‹ä¸­é‡åˆ°çš„ç¬¬ä¸€ä¸ªåï¼Œå…³äºè¿™éƒ¨åˆ†çš„èµ„æ–™åœ¨ç½‘ç»œä¸Šå·²ç»å¾ˆå¤šäº†ï¼Œä½†æ˜¯è¿™äº›èµ„æ–™å¾€å¾€åªé‡çŸ¥è¯†ç‚¹çš„è¾“å‡ºï¼Œå¾ˆå°‘å’Œå®é™…çš„ç”Ÿäº§å®è·µç›¸æŒ‚é’©ã€‚ä½†æ˜¯æˆ‘ä¸æƒ³ç»™ä½ æœºæ¢°åœ°é‡å¤â€œå…«è‚¡æ–‡â€ï¼Œæ¥ä¸‹æ¥çš„ä¸¤èŠ‚è¯¾ï¼Œæˆ‘ä¼šç»“åˆè¿™äº›å¹´æ¥åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹é¢†åŸŸçš„ç»éªŒï¼Œä»å®é™…æ¡ˆä¾‹å‡ºå‘ï¼Œå¸¦ä½ æŒæ¡å¤šçº¿ç¨‹ç¼–ç¨‹çš„è¦é¢†ï¼Œæ·±å…¥å¤šçº¿ç¨‹çš„åº•å±‚è¿ä½œåœºæ™¯ï¼Œå®ç°ç†è§£èƒ½åŠ›çš„è·ƒå‡ã€‚</p><h2>å¦‚ä½•å¤ç”¨çº¿ç¨‹ï¼Ÿ</h2><p>çº¿ç¨‹æ˜¯å—æ“ä½œç³»ç»Ÿç®¡ç†çš„æœ€æ ¸å¿ƒçš„èµ„æºï¼Œåå¤åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¼šç»™ç³»ç»Ÿå±‚é¢å¸¦æ¥æ¯”è¾ƒå¤§çš„å¼€é”€ã€‚æ‰€ä»¥ï¼Œä¸ºäº†èŠ‚çº¦èµ„æºï¼Œæˆ‘ä»¬éœ€è¦å¤ç”¨çº¿ç¨‹ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­é‡åˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜ã€‚é‚£æ€ä¹ˆå¤ç”¨çº¿ç¨‹å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€å°æ®µä»£ç ï¼š</p><pre><code class="language-plain">Thread t = new Thread(new UserTask());
</code></pre><p>è¯·ä½ æ€è€ƒä¸€ä¸‹ï¼Œè¿™æ®µä»£ç ä¼šåˆ›å»ºä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹å—ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ä¸ä¼šã€‚è¿™æ®µä»£ç åªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ™®é€šçš„Javaå¯¹è±¡ï¼Œè¦æƒ³æˆä¸ºä¸€ä¸ªçœŸå®çš„çº¿ç¨‹ï¼Œå¿…é¡»è°ƒç”¨çº¿ç¨‹çš„startæ–¹æ³•ï¼Œè®©çº¿ç¨‹çœŸæ­£å—æ“ä½œç³»ç»Ÿè°ƒåº¦ã€‚è€Œçº¿ç¨‹çš„ç»“æŸå’Œrunæ–¹æ³•çš„æ‰§è¡Œæƒ…å†µæœ‰å…³ï¼Œä¸€æ—¦çº¿ç¨‹çš„runæ–¹æ³•ç»“æŸè¿è¡Œï¼Œçº¿ç¨‹å°±ä¼šè¿›å…¥æ¶ˆäº¡é˜¶æ®µï¼Œç›¸å…³èµ„æºä¹Ÿä¼šè¢«æ“ä½œç³»ç»Ÿå›æ”¶ã€‚</p><p><strong>æ‰€ä»¥è¦æƒ³å¤ç”¨çº¿ç¨‹ï¼Œä¸€ä¸ªéå¸¸å¯è¡Œçš„æ€è·¯å°±æ˜¯ï¼Œä¸è®©runæ–¹æ³•ç»“æŸã€‚</strong></p><!-- [[[read_end]]] --><p>é€šå¸¸æˆ‘ä»¬ä¼šæƒ³åˆ°ä¸‹é¢è¿™ç§åŠæ³•ï¼š</p><pre><code class="language-plain">class Task implements Runnable {
 &nbsp; &nbsp; &nbsp; &nbsp;@Override
 &nbsp; &nbsp; &nbsp; &nbsp;public void run() {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;while(true) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if( shouldRun() ) {// ç¬¦åˆä¸šåŠ¡è§„åˆ™å°±è¿è¡Œ
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;doSomething();
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } else {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;try {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//ä¼‘çœ 1s,ç»§ç»­å»åˆ¤æ–­æ˜¯å¦å¯è¿è¡Œ
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Thread.sleep(1000);
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } catch (InterruptedException e) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;e.printStackTrace();
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp; &nbsp;private void doSomething() {
 &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp; &nbsp;private boolean shouldRun() {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//æ ¹æ®å…·ä½“ä¸šåŠ¡è§„åˆ™è¿›è¡Œåˆ¤æ–­
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return false;
 &nbsp; &nbsp; &nbsp;  }
 &nbsp;  }
</code></pre><p>é€šè¿‡ä¸€ä¸ªwhile(true)æ­»å¾ªç¯ç¡®ä¿runæ–¹æ³•ä¸ä¼šç»“æŸï¼Œç„¶åä¸æ–­åœ°åˆ¤æ–­å½“å‰æ˜¯å¦å¯ä»¥æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼›å¦‚æœä¸ç¬¦åˆæ‰§è¡Œæ¡ä»¶ï¼Œå°±è®©çº¿ç¨‹ä¼‘çœ ä¸€æ®µæ—¶é—´ï¼Œç„¶åå†æ¬¡è¿›è¡Œåˆ¤æ–­ã€‚</p><p>è¿™ä¸ªæ–¹æ³•ç¡®å®å¯ä»¥å¤ç”¨çº¿ç¨‹ï¼Œä½†å­˜åœ¨æ˜æ˜¾çš„ç¼ºé™·ã€‚å› ä¸ºä¸€æ—¦ä¸æ»¡è¶³è¿è¡Œæ¡ä»¶ï¼Œå°±ä¼šè¿›è¡Œåå¤æ— æ„ä¹‰çš„åˆ¤æ–­ï¼Œé€ æˆCPUèµ„æºçš„æµªè´¹ã€‚å¦å¤–ï¼Œåœ¨çº¿ç¨‹å¤„äºä¼‘çœ çŠ¶æ€æ—¶ï¼Œå°±ç®—æ»¡è¶³æ‰§è¡Œæ¡ä»¶ï¼Œä¹Ÿéœ€è¦ç­‰ä¼‘çœ ç»“æŸåæ‰èƒ½è§¦å‘æ£€æµ‹ï¼Œæ—¶æ•ˆæ€§ä¼šå¤§æ‰“æŠ˜æ‰£ã€‚</p><p>é‚£æˆ‘ä»¬èƒ½ä¸èƒ½ä¸€æœ‰ä»»åŠ¡å°±ç«‹é©¬æ‰§è¡Œï¼Œæ²¡æœ‰ä»»åŠ¡å°±é˜»å¡çº¿ç¨‹å‘¢ï¼Ÿæ¯•ç«Ÿï¼Œå¦‚æœçº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œå°±ä¸ä¼šå‚ä¸CPUè°ƒåº¦ï¼Œè‡ªç„¶ä¹Ÿå°±ä¸ä¼šå ç”¨CPUæ—¶é—´äº†ã€‚</p><p>ç­”æ¡ˆå½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œä¸šç•Œæœ‰ä¸€ç§éå¸¸ç»å…¸çš„çº¿ç¨‹å¤ç”¨æ¨¡å‹ï¼š<strong>whileå¾ªç¯+é˜»å¡é˜Ÿåˆ—</strong>ï¼Œä¸‹é¢æ˜¯ä¸€æ®µç¤ºèŒƒä»£ç ï¼š</p><pre><code class="language-plain">class Task implements Runnable {
 &nbsp; &nbsp; &nbsp; &nbsp;private LinkedBlockingQueue taskQueue = new LinkedBlockingQueue();
 &nbsp; &nbsp; &nbsp; &nbsp;private AtomicBoolean running = new AtomicBoolean(true);
â€‹
 &nbsp; &nbsp; &nbsp; &nbsp;public void submitTask(Object task) throws InterruptedException {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;taskQueue.put(task);
 &nbsp; &nbsp; &nbsp;  }
â€‹
 &nbsp; &nbsp; &nbsp; &nbsp;@Override
 &nbsp; &nbsp; &nbsp; &nbsp;public void run() {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;while(running.get()) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;try {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Object task = taskQueue.take(); // å¦‚æœæ²¡æœ‰ä»»åŠ¡ï¼Œä¼šä½¿çº¿ç¨‹é˜»å¡ï¼Œä¸€æ—¦æœ‰ä»»åŠ¡ï¼Œä¼šè¢«å”¤é†’
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;doSomething(task);
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } catch (Throwable e) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;e.printStackTrace();
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp;  }
â€‹
 &nbsp; &nbsp; &nbsp; &nbsp;public void shutdown() {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if(running.compareAndSet(true, false)) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;System.out.println(Thread.currentThread() + " is stoped");
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp;  }
â€‹
 &nbsp; &nbsp; &nbsp; &nbsp;private void doSomething(Object task) {
 &nbsp; &nbsp; &nbsp;  }
 &nbsp;  }
</code></pre><p>æˆ‘ä»¬æ¥è§£è¯»ä¸€ä¸‹ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ç”¨AtomicBooleanå˜é‡æ¥æ ‡è¯†çº¿ç¨‹æ˜¯å¦åœ¨è¿è¡Œä¸­ï¼Œç”¨while(running.get())æ›¿æ¢while(true)ï¼Œæ–¹ä¾¿ä¼˜é›…åœ°é€€å‡ºçº¿ç¨‹ã€‚</p><p>çº¿ç¨‹ä¼šä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–å¾…æ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰å¯æ‰§è¡Œçš„ä»»åŠ¡ï¼Œé‚£ä¹ˆçº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸æ¶ˆè€—CPUèµ„æºï¼›ä¸€æ—¦æœ‰ä»»åŠ¡è¿›å…¥åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œçº¿ç¨‹ä¼šè¢«å”¤é†’æ‰§è¡Œä»»åŠ¡ï¼Œè¿™å°±å¾ˆå¥½åœ°ä¿è¯äº†æ—¶æ•ˆæ€§ã€‚</p><p><strong>é‚£æ€ä¹ˆåœæ­¢ä¸€ä¸ªçº¿ç¨‹å‘¢ï¼Ÿè°ƒç”¨çº¿ç¨‹çš„shutdownæ–¹æ³•ä¸€å®šèƒ½åœæ­¢çº¿ç¨‹å—ï¼Ÿ</strong></p><p>ç­”æ¡ˆæ˜¯ä¸ä¸€å®šã€‚ å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡ï¼Œé‚£ä¹ˆçº¿ç¨‹ä¼šä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸èƒ½è¢«åœæ­¢ã€‚è€Œä¸”ï¼ŒJavaä¸­Threadå¯¹è±¡çš„stopæ–¹æ³•è¢«å£°æ˜ä¸ºå·²è¿‡æœŸï¼Œç›´æ¥è°ƒç”¨å¹¶ä¸èƒ½åœæ­¢çº¿ç¨‹ã€‚é‚£æ€ä¹ˆä¼˜é›…åœ°åœæ­¢ä¸€ä¸ªçº¿ç¨‹å‘¢ï¼Ÿ</p><p>åŸæ¥ï¼ŒJavaä¸­æä¾›äº†ä¸­æ–­æœºåˆ¶ï¼Œåœ¨Threadç±»ä¸­ä¸ä¸­æ–­ç›¸å…³çš„æ–¹æ³•æœ‰ä¸‰ä¸ªã€‚</p><ul>
<li>public void interrupt()ï¼šThreadå®ä¾‹æ–¹æ³•ï¼Œç”¨äºè®¾ç½®ä¸­æ–­æ ‡è®°ï¼Œä½†æ˜¯ä¸èƒ½ç«‹å³ä¸­æ–­çº¿ç¨‹ã€‚</li>
<li>public boolean isInterrupted()ï¼šThreadå®ä¾‹æ–¹æ³•ï¼Œç”¨äºè·å–å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°ã€‚</li>
<li>public static boolean interrupted()ï¼šThreadé™æ€æ–¹æ³•ï¼Œç”¨äºè·å–å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°ï¼Œå¹¶ä¸”ä¼šæ¸…é™¤ä¸­æ–­æ ‡è®°ã€‚</li>
</ul><p>å¦‚æœè°ƒç”¨çº¿ç¨‹å¯¹è±¡çš„interrupt()æ–¹æ³•ï¼Œä¼šé¦–å…ˆè®¾ç½®çº¿ç¨‹çš„ä¸­æ–­ä½ï¼Œè¿™æ—¶åˆä¼šå‡ºç°ä¸¤ç§æƒ…å†µï¼š</p><ul>
<li>å¦‚æœçº¿ç¨‹é˜»å¡åœ¨æ”¯æŒä¸­æ–­çš„æ–¹æ³•ä¸Šï¼Œä¼šç«‹å³ç»“æŸé˜»å¡ï¼Œå¹¶å‘å¤–æŠ›å‡ºInterruptedException(ä¸­æ–­å¼‚å¸¸)ï¼›</li>
<li>å¦‚æœçº¿ç¨‹æ²¡æœ‰é˜»å¡åœ¨æ”¯æŒä¸­æ–­çš„æ–¹æ³•ä¸Šï¼Œåˆ™è¯¥æ–¹æ³•ä¸èƒ½ç«‹å³åœæ­¢çº¿ç¨‹ã€‚</li>
</ul><p>ä¸è¿‡è¦è¯´æ˜çš„æ˜¯ï¼ŒJUCç±»åº“ä¸­çš„æ‰€æœ‰é˜»å¡é˜Ÿåˆ—ã€é”ã€Objectçš„waitç­‰æ–¹æ³•éƒ½æ”¯æŒä¸­æ–­ã€‚</p><p>é€šå¸¸ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä»£ç ä¸­æ·»åŠ æ˜¾ç¤ºçš„ä¸­æ–­æ£€æµ‹ä»£ç ï¼Œæˆ‘è¿˜æ˜¯ç”¨å‰é¢çš„ä¾‹å­ç»™å‡ºç¤ºä¾‹ä»£ç ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹ï¼š</p><pre><code class="language-plain">static class Task implements Runnable {
 &nbsp; &nbsp; &nbsp; &nbsp;private LinkedBlockingQueue taskQueue = new LinkedBlockingQueue();
 &nbsp; &nbsp; &nbsp; &nbsp;private AtomicBoolean running = new AtomicBoolean(true);
â€‹
 &nbsp; &nbsp; &nbsp; &nbsp;public void submitTask(Object task) throws InterruptedException {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;taskQueue.put(task);
 &nbsp; &nbsp; &nbsp;  }
â€‹
 &nbsp; &nbsp; &nbsp; &nbsp;@Override
 &nbsp; &nbsp; &nbsp; &nbsp;public void run() {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;while(running.get()) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;try {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Object task = taskQueue.take(); // å¦‚æœæ²¡æœ‰ä»»åŠ¡ï¼Œä¼šä½¿çº¿ç¨‹é˜»å¡ï¼Œä¸€æ—¦æœ‰ä»»åŠ¡ï¼Œä¼šè¢«å”¤é†’
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;doSomething(task);
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if(Thread.currentThread().isInterrupted()) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//çº¿ç¨‹è¢«ä¸­æ–­ï¼Œè·³å‡ºå¾ªç¯ï¼Œçº¿ç¨‹åœæ­¢
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;break;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//è¿™æ˜¯ä¸€ä¸ªè€—æ—¶å¾ˆé•¿çš„æ–¹æ³•
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;doSomething2(task);
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } catch (Throwable e) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;e.printStackTrace();
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp;  }
â€‹
 &nbsp; &nbsp; &nbsp; &nbsp;public void shutdown() {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if(running.compareAndSet(true, false)) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;System.out.println(Thread.currentThread() + " is stoped");
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp;  }
â€‹
 &nbsp; &nbsp; &nbsp; &nbsp;private void doSomething(Object task) {
 &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp; &nbsp;
 &nbsp; &nbsp; &nbsp; &nbsp;private void doSomething2(Object task) {
 &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp; &nbsp;
 &nbsp;  }
</code></pre><p>æˆ‘ä»¬ç»§ç»­è¯´å›çº¿ç¨‹çš„å¤ç”¨ã€‚JUCæ¡†æ¶æä¾›äº†çº¿ç¨‹æ± ä¾›æˆ‘ä»¬ä½¿ç”¨ã€‚å…³äºçº¿ç¨‹æ± ç›¸å…³çš„åŸºç¡€çŸ¥è¯†ï¼Œä½ å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç« <a href="https://mp.weixin.qq.com/s/3E6qdOci-B7h532GTbKUnQ">ã€Šå¦‚ä½•è¯„ä¼°ä¸€ä¸ªçº¿ç¨‹æ± éœ€è¦è®¾ç½®å¤šå°‘ä¸ªçº¿ç¨‹ã€‹</a>ï¼Œè¿™é‡Œæˆ‘å°±ä¸è¿‡å¤šå±•å¼€äº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å°±ç»“åˆè‡ªå·±çš„å·¥ä½œç»éªŒåˆ†äº«ä¸€ä¸‹æ€ä¹ˆåœ¨å®æˆ˜ä¸­ä½¿ç”¨çº¿ç¨‹æ± ã€‚</p><p>æˆ‘éå¸¸ä¸å»ºè®®ä½ ç›´æ¥ä½¿ç”¨Executorsç›¸å…³çš„APIæ¥åˆ›å»ºçº¿ç¨‹æ± ï¼Œå› ä¸ºé€šè¿‡è¿™ç§æ–¹å¼åˆ›å»ºçš„çº¿ç¨‹æ± å†…éƒ¨ä¼šé»˜è®¤åˆ›å»ºä¸€ä¸ªæ— ç•Œçš„é˜»å¡é˜Ÿåˆ—ï¼Œä¸€æ—¦ä½¿ç”¨ä¸å½“å°±ä¼šé€ æˆå†…å­˜æ³„éœ²ã€‚</p><p>æˆ‘æ›´æ¨èä½ ä½¿ç”¨newçš„æ–¹å¼åˆ›å»ºçº¿ç¨‹ï¼Œç„¶åç»™çº¿ç¨‹æŒ‡å®šä¸€ä¸ªå¯é˜…è¯»çš„åç§°ï¼š</p><pre><code class="language-plain">ThreadPoolExecutor executor = new ThreadPoolExecutor(5, 5, 0, TimeUnit.MILLISECONDS, 
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new LinkedBlockingQueue&lt;&gt;(), new ThreadFactory() {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;private AtomicInteger threadNum = new AtomicInteger(0);
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;@Override
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;public Thread newThread(Runnable r) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Thread t = new Thread(r);
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;t.setName("pull-service-" + threadNum.incrementAndGet());
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return t;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp;  });
</code></pre><p>è¿™æ ·ï¼Œå½“ç³»ç»Ÿå‘ç”Ÿæ•…éšœæ—¶ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦åˆ†æçº¿ç¨‹æ ˆä¿¡æ¯ï¼Œå°±èƒ½å¾ˆå¿«å®šä½å„ä¸ªçº¿ç¨‹çš„èŒè´£ã€‚ä¾‹å¦‚ï¼ŒRocketMQçš„æ¶ˆè´¹çº¿ç¨‹æˆ‘å°±ä¼šä»¥â€œConsumeMessageThread_â€å¼€å¤´ã€‚</p><h4></h4><p>ä½¿ç”¨çº¿ç¨‹æ± å¦ä¸€ä¸ªå€¼å¾—å…³æ³¨çš„é—®é¢˜æ˜¯æ€ä¹ˆé€‰æ‹©é˜»å¡é˜Ÿåˆ—ï¼Œæ˜¯ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—è¿˜æ˜¯æœ‰ç•Œé˜Ÿåˆ—ã€‚</p><p>é€šå¸¸ï¼Œæˆ‘ä»¬å¯ä»¥éµå¾ªè¿™æ ·çš„åŸåˆ™ï¼š<strong>å¯¹äºRequest-Responseç­‰éœ€è¦ç”¨æˆ·äº¤äº’çš„åœºæ™¯ï¼Œå»ºè®®ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ï¼Œé¿å…å†…å­˜æº¢å‡ºï¼›å¯¹äºæ¡†æ¶å†…éƒ¨çº¿ç¨‹ä¹‹é—´çš„äº¤äº’ï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µåŠ ä»¥é€‰æ‹©ã€‚</strong></p><p>æˆ‘ä»¬é€šè¿‡å‡ ä¸ªä¾‹å­æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„åœºæ™¯ã€‚</p><p>é¡¹ç›®å¼€å‘ä¸­é€šå¸¸ä¼šé‡åˆ°æ–‡ä»¶ä¸‹è½½ã€DevOpsçš„ç³»ç»Ÿå‘å¸ƒç­‰æ¯”è¾ƒè€—æ—¶çš„è¯·æ±‚ï¼Œè¿™ç±»åœºæ™¯å°±éå¸¸é€‚åˆä½¿ç”¨çº¿ç¨‹æ± ã€‚åŸºæœ¬çš„å·¥ä½œæ–¹å¼å¦‚å›¾ï¼š</p><p><img src="https://static001.geekbang.org/resource/image/98/87/987b4a04eb0a92bfac98ffd8bae93687.jpg?wh=1900x977" alt="å›¾ç‰‡"></p><p>åœ¨ä¸ç”¨æˆ·äº¤äº’çš„åœºæ™¯ä¸­ï¼Œå¦‚æœå‡ åä¸‡ä¸ªæ–‡ä»¶ä¸‹è½½è¯·æ±‚åŒæ—¶æäº¤åˆ°çº¿ç¨‹æ± ï¼Œå½“çº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½åœ¨å¤„ç†ä»»åŠ¡æ—¶ï¼Œæ— æ³•åŠæ—¶å¤„ç†çš„è¯·æ±‚å°±ä¼šå­˜å‚¨åˆ°çº¿ç¨‹æ± ä¸­çš„é˜»å¡é˜Ÿåˆ—ä¸­ã€‚è¿™å°±å¾ˆå®¹æ˜“ä½¿å†…å­˜è€—å°½ï¼Œä»è€Œè§¦å‘Full-GCï¼Œå¯¼è‡´ç³»ç»Ÿæ— æ³•æ­£å¸¸è¿ä½œã€‚</p><p>å› æ­¤ï¼Œè¿™ç±»åœºæ™¯æˆ‘å»ºè®®ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ï¼Œç›´æ¥æ‹’ç»æš‚æ—¶å¤„ç†ä¸äº†çš„è¯·æ±‚ï¼Œå¹¶ç»™ç”¨æˆ·è¿”å›ä¸€æ¡æ¶ˆæ¯â€œè¯·æ±‚æ’é˜Ÿä¸­ï¼Œè¯·ç¨åå†è¯•â€ï¼Œè¿™å°±ä¿è¯äº†ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚</p><p><strong>åœ¨ä¸€ä¸ªçº¿ç¨‹æˆ–å¤šä¸ªçº¿ç¨‹å‘ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ä¸­æ·»åŠ æ•°æ®æ—¶ï¼Œé€šå¸¸ä¹Ÿä¼šä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ã€‚</strong>è®°å¾—æˆ‘åœ¨å¼€å‘æ•°æ®åŒæ­¥äº§å“æ—¶ï¼Œä¸ºäº†å®ç°æºç«¯ä¸ç›®æ ‡ç«¯çº¿ç¨‹ï¼Œå°±é‡‡ç”¨äº†é˜»å¡é˜Ÿåˆ—ï¼Œä¸‹é¢æ˜¯ä¸€å¼ ç¤ºæ„å›¾ï¼š</p><p><img src="https://static001.geekbang.org/resource/image/3a/cb/3af7bc6d5d3ddc1dfec08c595cfe18cb.jpg?wh=1920x636" alt="å›¾ç‰‡"></p><p>ä¸ºäº†å®ç°MySQLå¢é‡åŒæ­¥ï¼ŒCanalçº¿ç¨‹æºæºä¸æ–­åœ°å°†MySQLæ•°æ®å†™å…¥åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œç„¶åç›®æ ‡ç«¯çº¿ç¨‹ä»é˜Ÿåˆ—ä¸­è¯»å–æ•°æ®å¹¶å†™å…¥åˆ°MQã€‚å¦‚æœå†™å…¥ç«¯çš„å†™å…¥é€Ÿåº¦å˜æ…¢ï¼Œé˜»å¡é˜Ÿåˆ—ä¸­çš„æ•°æ®å°±å˜å¾—è¶Šæ¥è¶Šå¤šï¼Œä¸€æ—¦ä¸åŠ ä»¥æ§åˆ¶å°±å¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºã€‚æ‰€ä»¥ï¼Œä¸ºäº†é¿å…ç”±äºå†™å…¥ç«¯æ€§èƒ½ç“¶é¢ˆé€ æˆçš„æ•´ä¸ªç³»ç»Ÿçš„ä¸å¯ç”¨ï¼Œè¿™æ—¶å€™éœ€è¦å¼•å…¥æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚è¿™æ ·ï¼Œé˜Ÿåˆ—æ»¡äº†ä¹‹åï¼Œæˆ‘ä»¬å°±èƒ½è®©æºç«¯çº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œä»è€Œå¯¹æºç«¯è¿›è¡Œé™æµã€‚</p><p><strong>ä½†åœ¨é€‰æ‹©é˜»å¡é˜Ÿåˆ—æ—¶è¿˜å¯èƒ½æœ‰å¦å¤–ä¸€ç§æƒ…å†µï¼Œé‚£å°±æ˜¯ä¸€ä¸ªçº¿ç¨‹å¯¹åº”å¤šä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œè¿™æ—¶æˆ‘ä»¬ä¸€èˆ¬ä¼šé‡‡ç”¨æ— ç•Œé˜»å¡é˜Ÿåˆ—+sizeçš„æœºåˆ¶ï¼Œå®ç°ç»†ç²’åº¦é™æµ</strong>ã€‚å½“æ—¶ï¼Œæˆ‘è®¾è®¡çš„RocketMQæ¶ˆè´¹æ¨¡å‹æ˜¯ä¸‹é¢è¿™æ ·ï¼š</p><p><img src="https://static001.geekbang.org/resource/image/bc/fc/bcaf3ee4ce2d22532c01977f694b43fc.jpg?wh=1920x787" alt="å›¾ç‰‡"></p><p>ä¸€ä¸ªæ‹‰å–çº¿ç¨‹è½®æµä»Brokerç«¯é˜Ÿåˆ—(q0ã€q1)ä¸­æ‹‰å–æ¶ˆæ¯ï¼Œç„¶åæ ¹æ®é˜Ÿåˆ—åˆ†åˆ«æ”¾åˆ°ä¸åŒçš„é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œæ¯ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ä¼šå•ç‹¬åˆ†é…å•ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹å»å¤„ç†ã€‚</p><p>è¿™ä¸ªæ—¶å€™ï¼Œé‡‡ç”¨æœ‰ç•Œé˜Ÿåˆ—å¯èƒ½å‡ºç°é—®é¢˜ã€‚å¦‚æœæˆ‘ä»¬é‡‡ç”¨æœ‰ç•Œé˜Ÿåˆ—ï¼Œä¸€æ—¦å…¶ä¸­ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—å¯¹åº”çš„ä¸‹æ¸¸æ¶ˆè´¹è€…å¤„ç†æ€§èƒ½é™ä½ï¼Œé˜»å¡é˜Ÿåˆ—ä¸­æ²¡æœ‰å‰©ä½™ç©ºé—´å­˜å‚¨æ¶ˆæ¯ï¼Œå°±ä¼šé˜»å¡æ¶ˆæ¯å‘é€çº¿ç¨‹ï¼Œæœ€ç»ˆé€ æˆå¦å¤–ä¸€ä¸ªä»»åŠ¡ä¹Ÿæ— æ³•æ‹‰å–æ–°çš„æ¶ˆæ¯ã€‚æ˜¾ç„¶ï¼Œè¿™ä¼šè®©æ•´ä½“å¹¶å‘åº¦é™ä½ï¼Œå½±å“æ€§èƒ½ã€‚</p><p>é‚£å¦‚æœé‡‡ç”¨æ— ç•Œé˜Ÿåˆ—å‘¢ï¼Ÿå•çº¯ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—å®¹æ˜“å¯¼è‡´å†…å­˜æ³„éœ²ï¼Œè§¦å‘æ›´ä¸¥é‡çš„åæœï¼Œå¥½åƒä¹Ÿä¸æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ã€‚</p><p>å…¶å®æˆ‘ä»¬å¯ä»¥åœ¨æ— ç•Œé˜Ÿåˆ—çš„åŸºç¡€ä¸Šé¢å¤–å¼•å…¥ä¸€ä¸ªå‚æ•°ï¼Œç”¨å®ƒæ¥æ§åˆ¶é˜»å¡é˜Ÿåˆ—ä¸­å…è®¸å­˜æ”¾çš„æ¶ˆæ¯æ¡æ•°ã€‚å½“é˜»å¡é˜Ÿåˆ—ä¸­çš„æ•°æ®å¤§äºå…è®¸å­˜æ”¾çš„é˜”å€¼æ—¶ï¼Œæ–°çš„æ¶ˆæ¯è¿˜å¯ä»¥ç»§ç»­å†™å…¥é˜Ÿåˆ—ï¼Œä¸ä¼šé˜»å¡æ¶ˆæ¯å‘é€çº¿ç¨‹ã€‚ä½†æˆ‘ä»¬éœ€è¦ç»™æ¶ˆæ¯æ‹‰å–çº¿ç¨‹ä¸€ä¸ªåé¦ˆï¼Œæš‚æ—¶åœæ­¢ä»å¯¹åº”é˜Ÿåˆ—ä¸­æ‹‰å–æ¶ˆæ¯ï¼Œä»è€Œå®ç°é™æµã€‚</p><p>é˜»å¡é˜Ÿåˆ—æ˜¯å¤šçº¿ç¨‹åä½œçš„æ ¸å¿ƒçº½å¸¦ï¼Œé™¤äº†æ¸…æ¥šå®ƒçš„ä½¿ç”¨æ–¹æ³•ï¼Œæˆ‘ä»¬è¿˜åº”è¯¥ç†è§£å®ƒçš„ä½¿ç”¨åŸç†ï¼Œä¹Ÿå°±æ˜¯ <strong>â€œé” + æ¡ä»¶ç­‰å¾…ä¸å”¤é†’â€</strong>ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹LinkedBlockingQueue çš„putçš„å®ç°ä»£ç ï¼š</p><pre><code class="language-plain">public void put(E e) throws InterruptedException {
 &nbsp; &nbsp; &nbsp; &nbsp;if (e == null) throw new NullPointerException();
â€‹
 &nbsp; &nbsp; &nbsp; &nbsp;int c = -1;
 &nbsp; &nbsp; &nbsp; &nbsp;Node&lt;E&gt; node = new Node&lt;E&gt;(e);
 &nbsp; &nbsp; &nbsp; &nbsp;final ReentrantLock putLock = this.putLock;
 &nbsp; &nbsp; &nbsp; &nbsp;final AtomicInteger count = this.count;
 &nbsp; &nbsp; &nbsp; &nbsp;putLock.lockInterruptibly(); // @1
 &nbsp; &nbsp; &nbsp; &nbsp;try {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;while (count.get() == capacity) { // @2
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;  private final ReentrantLock putLock = new ReentrantLock();
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;  private final Condition notFull = putLock.newCondition();
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;notFull.await(); &nbsp;// @3
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;enqueue(node); &nbsp;// @4
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c = count.getAndIncrement();
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (c + 1 &lt; capacity)
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;notFull.signal();
 &nbsp; &nbsp; &nbsp;  } finally {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;putLock.unlock();
 &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp; &nbsp;if (c == 0)
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;signalNotEmpty();
 &nbsp;  }
</code></pre><p>è¿™é‡Œï¼Œæˆ‘é‡ç‚¹è§£è¯»ä¸€ä¸‹å…³é”®ä»£ç ã€‚</p><p>ç¬¬8è¡Œï¼šæˆ‘ä»¬è¦ç”³è¯·é”ï¼Œè·å–é˜Ÿåˆ—å†…éƒ¨æ•°æ®å­˜å‚¨ç»“æ„(LinkedBlockingQueueåº•å±‚ç»“æ„ä¸ºé“¾è¡¨)çš„ä¿®æ”¹æ§åˆ¶æƒï¼Œä¹Ÿå°±æ˜¯è®©ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—åŒä¸€æ—¶åˆ»åªèƒ½æ“ä½œä¸€ä¸ªçº¿ç¨‹ã€‚</p><p>ç¬¬10è¡Œï¼šåˆ¤æ–­é˜Ÿåˆ—ä¸­å…ƒç´ çš„æ•°é‡æ˜¯å¦ç­‰äºå…¶æœ€å¤§å®¹é‡ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™çº¿ç¨‹è¿›å…¥åˆ°æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—(ç¬¬13è¡Œ)ï¼Œè°ƒç”¨putçš„çº¿ç¨‹ä¼šé‡Šæ”¾é”è¿›å…¥åˆ°é˜»å¡é˜Ÿåˆ—ã€‚å½“é˜Ÿåˆ—ä¸­å­˜åœ¨ç©ºé—²ç©ºé—´æ—¶ï¼Œè¯¥çº¿ç¨‹ä¼šå¾—åˆ°é€šçŸ¥ï¼Œä»è€Œç»“æŸé˜»å¡çŠ¶æ€è¿›å…¥åˆ°å¯è°ƒåº¦çŠ¶æ€ã€‚</p><p>é˜Ÿåˆ—ä¸­æœ‰å¯ç”¨ç©ºé—´ä¹‹åï¼Œçº¿ç¨‹è¢«å”¤é†’ï¼Œä½†æ˜¯ä¸èƒ½ç«‹å³æ‰§è¡Œä»£ç ï¼ˆç¬¬15è¡Œï¼‰ï¼Œå®ƒéœ€è¦é‡æ–°å’Œå…¶ä»–çº¿ç¨‹ç«äº‰é”ï¼Œè·å¾—é”åå°†æ•°æ®å­˜å‚¨åˆ°åº•å±‚æ•°æ®ç»“æ„ä¸­ã€‚å…³äºé”çš„åº•å±‚åŸç†ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹èŠ‚è¯¾è¯¦ç»†ä»‹ç»ã€‚</p><p>è¿™é‡Œä¹Ÿè¯·ä½ æ€è€ƒä¸€ä¸‹ï¼šä¸ºä»€ä¹ˆä¸Šé¢çš„ä»£ç æˆ‘ä»¬è¦é‡‡ç”¨while(count.get() == capacity)è€Œä¸ä½¿ç”¨if(count.get() == capacity)å‘¢ï¼Ÿ</p><h2>å¤šçº¿ç¨‹ç¼–ç¨‹å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼</h2><p>å¦‚æœä½ åˆšå¼€å§‹å­¦ä¹ å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå¯èƒ½ä¼šè§‰å¾—è¿™ä¸ªé—®é¢˜å¾ˆéš¾ã€‚ä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œä¸šç•Œå¤§ä½¬æ—©å°±æ€»ç»“å‡ºäº†å¾ˆå¤šå’Œå¤šçº¿ç¨‹ç¼–ç¨‹ç›¸å…³çš„è®¾è®¡æ¨¡å¼ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å°±å¸¦ä½ ä¸€èµ·çœ‹çœ‹å…¶ä¸­åº”ç”¨æœ€å¹¿çš„å‡ ä¸ªã€‚</p><h3>Futureæ¨¡å¼</h3><p>å¤šçº¿ç¨‹é¢†åŸŸä¸€ä¸ªéå¸¸ç»å…¸çš„è®¾è®¡æ¨¡å¼æ˜¯Futureæ¨¡å¼ã€‚å®ƒæŒ‡çš„æ˜¯ä¸»çº¿ç¨‹å‘å¦å¤–ä¸€ä¸ªçº¿ç¨‹æäº¤ä»»åŠ¡æ—¶ï¼Œæ— é¡»ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè€Œæ˜¯ç«‹å³è¿”å›ä¸€ä¸ªå‡­è¯ï¼Œä¹Ÿå°±æ˜¯Futureã€‚è¿™æ—¶ä¸»çº¿ç¨‹è¿˜å¯ä»¥åšå…¶ä»–çš„äº‹æƒ…ï¼Œä¸ä¼šé˜»å¡ã€‚ç­‰åˆ°éœ€è¦å¼‚æ­¥æ‰§è¡Œç»“æœæ—¶ï¼Œä¸»çº¿ç¨‹è°ƒç”¨Futureçš„getæ–¹æ³•ï¼Œå¦‚æœå¼‚æ­¥ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™ç«‹å³è·å–ç»“æœï¼›å¦‚æœä»»åŠ¡è¿˜æ²¡æ‰§è¡Œå®Œï¼Œåˆ™ä¸»çº¿ç¨‹é˜»å¡ï¼Œç­‰å¾…æ‰§è¡Œç»“æœã€‚</p><p>Futureæ¨¡å¼çš„æ ¸å¿ƒè¦é¢†æ˜¯å°†å¤šä¸ªè¯·æ±‚è¿›è¡Œå¼‚æ­¥åŒ–å¤„ç†ï¼Œå¹¶ä¸”å¯ä»¥å¾—åˆ°è¿”å›ç»“æœã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç¤ºä¾‹ï¼š</p><p><img src="https://static001.geekbang.org/resource/image/d7/5d/d747892fb50087110ce994b010356d5d.jpg?wh=1920x1110" alt="å›¾ç‰‡"></p><p>å½“ä¸€ä¸ªè¯·æ±‚åœ¨å¤„ç†æ—¶ï¼Œéœ€è¦å‘èµ·å¤šä¸ªè¿œç¨‹è°ƒç”¨ï¼Œå¹¶ä¸”è¿”å›å¤šä¸ªè¯·æ±‚ï¼Œå†æ ¹æ®ç»“æœè¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†ã€‚å®ƒçš„ä¼ªä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="language-plain">Object result1 = sendRpcToUserCenter(); // @1
Object result2 = sendRpcToOrgCenter(0); // @2
Object result = evalBusiness(result1,result2);
</code></pre><p>è¯´æ˜ä¸€ä¸‹ï¼Œåœ¨ä¸ä½¿ç”¨Futureæ¨¡å¼çš„æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªè¿œç¨‹RPCè°ƒç”¨æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ã€‚ä¾‹å¦‚ï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚éœ€è¦1sæ‰èƒ½è¿”å›ï¼Œç¬¬äºŒä¸ªè¯·æ±‚éœ€è¦1.5sæ‰èƒ½è¿”å›ï¼Œè¿™ä¸¤ä¸ªè¿‡ç¨‹å°±éœ€è¦2.5sã€‚ä¸ºäº†æé«˜æ€§èƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸¤ä¸ªè¯·æ±‚è¿›è¡Œå¼‚æ­¥å¤„ç†ï¼Œç„¶ååˆ†åˆ«å¾—åˆ°å¤„ç†ç»“æœã€‚è¿™å°±åˆ°äº†Futureæ¨¡å¼å‘æŒ¥ä½œç”¨çš„æ—¶å€™äº†ã€‚</p><p><strong>ä¸šåŠ¡å¼€å‘é¢†åŸŸé€šå¸¸ä¼šé‡‡ç”¨çº¿ç¨‹æ± çš„æ–¹å¼æ¥å®ç°Futureæ¨¡å¼ï¼Œ</strong>ä½ å¯ä»¥çœ‹ä¸‹å…·ä½“çš„å®ç°ä»£ç ï¼š</p><pre><code class="language-plain">package net.codingw.jk02;
import java.util.concurrent.Callable;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Future;
public class FutureTask {
 &nbsp; &nbsp;static class Rpc2UserCenterTask implements Callable&lt;Object&gt; {
 &nbsp; &nbsp; &nbsp; &nbsp;@Override
 &nbsp; &nbsp; &nbsp; &nbsp;public Object call() throws Exception {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return sendRpcToUserCenter();
 &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp; &nbsp;private Object sendRpcToUserCenter() {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// å…·ä½“ä¸šåŠ¡é€»è¾‘çœç•¥
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return new Object();
 &nbsp; &nbsp; &nbsp;  }
 &nbsp;  }
â€‹
 &nbsp; &nbsp;static class Rpc2OrgCenterTask implements Callable&lt;Object&gt; {
 &nbsp; &nbsp; &nbsp; &nbsp;@Override
 &nbsp; &nbsp; &nbsp; &nbsp;public Object call() throws Exception {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return sendRpcToOrgCenter();
 &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp; &nbsp;private Object sendRpcToOrgCenter() {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// å…·ä½“ä¸šåŠ¡é€»è¾‘çœç•¥
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return new Object();
 &nbsp; &nbsp; &nbsp;  }
 &nbsp;  }
 &nbsp; &nbsp;
 &nbsp; &nbsp;public static void main(String[] args) throws Exception {
 &nbsp; &nbsp; &nbsp; &nbsp;// ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ new ThreadPoolExecutoræ–¹å¼åˆ›å»ºçº¿ç¨‹æ± 
 &nbsp; &nbsp; &nbsp; &nbsp;ExecutorService executorService = Executors.newFixedThreadPool(5);
 &nbsp; &nbsp; &nbsp; &nbsp;// å‘èµ·
 &nbsp; &nbsp; &nbsp; &nbsp;Future&lt;Object&gt; userRpcResultFuture = executorService.submit(new Rpc2UserCenterTask()); //å¼‚æ­¥æ‰§è¡Œ
 &nbsp; &nbsp; &nbsp; &nbsp;Future&lt;Object&gt; orgRpcResultFuture = executorService.submit(new Rpc2OrgCenterTask()); &nbsp; // å¼‚æ­¥æ‰§è¡Œ
 &nbsp; &nbsp; &nbsp; &nbsp;Object userRpcResult = userRpcResultFuture.get(); // å¦‚æœä»»åŠ¡æœªæ‰§è¡Œå®Œæˆï¼Œåˆ™è¯¥æ–¹æ³•ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å¤„ç†å®Œæˆ
 &nbsp; &nbsp; &nbsp; &nbsp;Object orgRpcResult = orgRpcResultFuture.get(); &nbsp; // å¦‚æœä»»åŠ¡æœªæ‰§è¡Œå®Œæˆï¼Œåˆ™è¯¥æ–¹æ³•ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å¤„ç†å®Œæˆ
 &nbsp; &nbsp; &nbsp; &nbsp;doTask(userRpcResult, orgRpcResult);
 &nbsp;  }
â€‹
 &nbsp; &nbsp;private static void doTask(Object userRpcResult, Object orgRpcResult) {
 &nbsp; &nbsp; &nbsp; &nbsp;// doSomeThing
 &nbsp;  }
}
</code></pre><p>æˆ‘ä»¬è¿˜æ˜¯è§£è¯»ä¸€ä¸‹è¿™æ®µä»£ç çš„è¦ç‚¹ã€‚</p><ul>
<li>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ã€‚</li>
<li>æ¥ç€ï¼Œè¦å°†éœ€è¦æ‰§è¡Œçš„å…·ä½“ä»»åŠ¡è¿›è¡Œå°è£…ï¼Œå¹¶å®ç°java.util.concurrent.Callableæ¥å£(å¦‚ä¸Šè¿°ä»£ç ä¸­çš„Rpc2UserCenterTask)ï¼Œå¹¶é‡å†™å…¶Callæ–¹æ³•ã€‚</li>
<li>ç„¶åå°†ä¸€ä¸ªå…·ä½“çš„ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± ä¸­å»æ‰§è¡Œï¼Œè¿”å›ä¸€ä¸ªFutureå¯¹è±¡ã€‚</li>
<li>åœ¨æƒ³è¦è·å–å¼‚æ­¥æ‰§è¡Œç»“æœæ—¶ï¼Œå¯ä»¥è°ƒç”¨Futureçš„getæ–¹æ³•ã€‚å¦‚æœä»»åŠ¡å·²ç»æ‰§è¡ŒæˆåŠŸï¼Œåˆ™ç›´æ¥è¿”å›ï¼›å¦åˆ™å°±ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæˆåè¢«å”¤é†’ã€‚</li>
</ul><p>å› ä¸ºçº¿ç¨‹æ± æ˜¯ä¸€ä¸ªè¾ƒé‡çš„èµ„æºï¼Œè€Œä¸­é—´ä»¶é¢†åŸŸçš„å¼€å‘è¿½æ±‚æè‡´çš„æ€§èƒ½ï¼Œæ‰€ä»¥åœ¨ä¸­é—´ä»¶å¼€å‘é¢†åŸŸé€šå¸¸ä¸ä¼šç›´æ¥ä½¿ç”¨çº¿ç¨‹æ± æ¥å®ç°Futureæ¨¡å¼ã€‚</p><p>RocketMQä¼šä½¿ç”¨CountDownLatchæ¥å®ç°Futureæ¨¡å¼ï¼Œå®ƒçš„è®¾è®¡éå¸¸ç²¾å¦™ï¼Œæˆ‘ä»¬å…ˆä¸€èµ·æ¥çœ‹ä¸€ä¸‹å®ƒçš„åºåˆ—å›¾ï¼š</p><p><img src="https://static001.geekbang.org/resource/image/2d/6d/2dfeb68590951c60cfbf4242fefd026d.jpg?wh=1920x1082" alt="å›¾ç‰‡"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒSendMessageThreadä¼šé¦–å…ˆåˆ›å»ºä¸€ä¸ªGroupCommitRequestè¯·æ±‚å¯¹è±¡ï¼Œå¹¶æäº¤åˆ°åˆ·ç›˜çº¿ç¨‹ï¼Œç„¶åå‘é€çº¿ç¨‹é˜»å¡ï¼Œç­‰å¾…åˆ·ç›˜åŠ¨ä½œå®Œæˆã€‚åˆ·ç›˜çº¿ç¨‹åœ¨æ‰§è¡Œå…·ä½“åˆ·ç›˜é€»è¾‘åï¼Œä¼šè°ƒç”¨requestçš„é€šçŸ¥æ–¹æ³•ï¼Œå”¤é†’å‘é€çº¿ç¨‹ã€‚</p><p>ä¹ä¸€çœ‹ï¼Œä¸»çº¿ç¨‹æäº¤åˆ·ç›˜ä»»åŠ¡ä¹‹åå¹¶æ²¡æœ‰è¿”å›ä¸€ä¸ªFutureï¼Œé‚£ä¸ºä»€ä¹ˆè¯´è¿™æ˜¯Futureæ¨¡å¼å‘¢ï¼Ÿè¿™å°±æ˜¯RocketMQçš„å·§å¦™ä¹‹å¤„äº†ã€‚å®ƒå…¶å®æ˜¯æŠŠè¯·æ±‚å¯¹è±¡å½“ä½œFutureæ¥ä½¿ç”¨äº†ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹GroupCommitRequestçš„å®ç°ä»£ç ï¼š</p><pre><code class="language-plain">public static class GroupCommitRequest {
 &nbsp; &nbsp; &nbsp; &nbsp;private final long nextOffset;
 &nbsp; &nbsp; &nbsp; &nbsp;private final CountDownLatch countDownLatch = new CountDownLatch(1); 
 &nbsp; &nbsp; &nbsp; &nbsp;private volatile boolean flushOK = false;
â€‹
 &nbsp; &nbsp; &nbsp; &nbsp;public GroupCommitRequest(long nextOffset) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;this.nextOffset = nextOffset;
 &nbsp; &nbsp; &nbsp;  }
â€‹
 &nbsp; &nbsp; &nbsp; &nbsp;public long getNextOffset() {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return nextOffset;
 &nbsp; &nbsp; &nbsp;  }
â€‹
 &nbsp; &nbsp; &nbsp; &nbsp;public void wakeupCustomer(final boolean flushOK) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;this.flushOK = flushOK;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;this.countDownLatch.countDown();
 &nbsp; &nbsp; &nbsp;  }
â€‹
 &nbsp; &nbsp; &nbsp; &nbsp;public boolean waitForFlush(long timeout) { 
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;try {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;this.countDownLatch.await(timeout, TimeUnit.MILLISECONDS);
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return this.flushOK;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } catch (InterruptedException e) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;e.printStackTrace();
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return false;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp;  }
 &nbsp;  }
</code></pre><p>åœ¨è¿™é‡Œï¼ŒGroupCommitRequest ä¸­çš„ waitForFlush æ–¹æ³•ç›¸å½“äº Future çš„ get æ–¹æ³•ã€‚å…·ä½“å®ç°æ˜¯ï¼Œè°ƒç”¨CountDownLatchçš„awaitæ–¹æ³•ä½¿è‡ªå·±å¤„äºé˜»å¡çŠ¶æ€ï¼Œç„¶åå½“å…·ä½“çš„åˆ·ç›˜çº¿ç¨‹å®Œæˆåˆ·ç›˜ä¹‹åï¼Œé€šè¿‡è°ƒç”¨wakeupCustomeræ–¹æ³•ï¼Œå®é™…ä¸Šè°ƒç”¨äº†CountDownLatchçš„countDownæ–¹æ³•ï¼Œå®ç°å”¤é†’ä¸»çº¿ç¨‹çš„ç›®çš„ã€‚</p><p>åŸºäºCountDownLatchå®ç°çš„Futureæ¨¡å¼éå¸¸å·§å¦™ï¼Œæ›´åŠ å¾—è½»é‡çº§ï¼Œæ€§èƒ½ä¹Ÿä¼šæ›´å¥½ã€‚ä¸è¿‡è¦è¯´æ˜çš„æ˜¯ï¼Œåœ¨ä¸šåŠ¡å¼€å‘é¢†åŸŸï¼Œç›´æ¥ä½¿ç”¨çº¿ç¨‹æ± å°†è·å¾—æ›´é«˜çš„å¼€å‘æ•ˆç‡å’Œæ›´ä½çš„ä½¿ç”¨æˆæœ¬ã€‚</p><h3><strong>ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼</strong></h3><p>Futureæ¨¡å¼å°±è¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å¤šçº¿ç¨‹ç¼–ç¨‹é¢†åŸŸä¸­æœ€å¸¸è§çš„è®¾è®¡æ¨¡å¼ï¼š<strong>ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ã€‚</strong></p><p>ç¨‹åºè®¾è®¡ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„æ€æƒ³æ˜¯è§£è€¦åˆï¼Œåœ¨Javaè®¾è®¡é¢†åŸŸä¹Ÿæœ‰ä¸€æ¡é‡è¦çš„è®¾è®¡åŸåˆ™å°±æ˜¯è¦èŒè´£å•ä¸€ã€‚åŸºäºè¿™äº›åŸåˆ™ï¼Œé€šå¸¸ä¸€ä¸ªåŠŸèƒ½éœ€è¦å¤šä¸ªè§’è‰²ç›¸äº’åä½œæ‰èƒ½æ­£å¸¸å®Œæˆã€‚</p><p>ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼æ­£æ˜¯è¿™ç§æ€æƒ³çš„ä½“ç°ï¼Œå®ƒçš„ç†è®ºä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬è¿™é‡Œä¸ä¼šæ·±å…¥ä»‹ç»ã€‚ä½†æˆ‘æƒ³ç”¨RocketMQä¸¾ä¸€ä¸ªå®æ“çš„ä¾‹å­ã€‚</p><p>åœ¨RocketMQæ¶ˆè´¹çº¿ç¨‹æ¨¡å‹ä¸­ï¼Œåº”ç”¨ç¨‹åºåœ¨å¯åŠ¨æ¶ˆè´¹è€…æ—¶ï¼Œé¦–å…ˆéœ€è¦æ ¹æ®è´Ÿè½½ç®—æ³•è¿›è¡Œé˜Ÿåˆ—è´Ÿè½½ï¼Œç„¶åæ¶ˆæ¯æ‹‰å–çº¿ç¨‹ä¼šæ ¹æ®è´Ÿè½½çº¿ç¨‹è®¡ç®—çš„ç»“æœæœ‰é’ˆå¯¹æ€§åœ°æ‹‰å–æ¶ˆæ¯ã€‚äº¤äº’æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://static001.geekbang.org/resource/image/38/a8/38d8604ea92661009fc711d226b345a8.jpg?wh=1920x1081" alt="å›¾ç‰‡"></p><p>Rebalaceçº¿ç¨‹ä½œä¸ºç”Ÿäº§è€…ï¼Œä¼šæ ¹æ®ä¸šåŠ¡é€»è¾‘ç”Ÿæˆæ¶ˆæ¯æ‹‰å–ä»»åŠ¡ï¼Œç„¶åPullçº¿ç¨‹ä½œä¸ºæ¶ˆè´¹è€…ä¼šä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ï¼Œæ‰§è¡Œå¯¹åº”çš„é€»è¾‘ï¼›å¦‚æœå½“å‰æ²¡æœ‰å¯æ‰§è¡Œçš„é€»è¾‘ï¼ŒPullçº¿ç¨‹åˆ™ä¼šé˜»å¡ç­‰å¾…ï¼Œå½“ç”Ÿäº§è€…å°†æ–°çš„ä»»åŠ¡å­˜å…¥åˆ°é˜»å¡é˜Ÿåˆ—ä¸­åï¼ŒPullçº¿ç¨‹ä¼šå†æ¬¡è¢«å”¤é†’ã€‚</p><p>ç³»ç»Ÿçš„è¿è¡Œè¿‡ç¨‹ä¸­ä¼šå­˜åœ¨å¾ˆå¤šæ„æ–™ä¹‹å¤–çš„çªå‘äº‹ä»¶ï¼Œåœ¨é«˜å¹¶å‘é¢†åŸŸæ›´æ˜¯è¿™æ ·ã€‚æ‰€ä»¥åœ¨è¿›è¡Œç³»ç»Ÿæ¶æ„è®¾è®¡æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»å…·å¤‡åº•çº¿æ€ç»´ï¼Œå¯¹ç³»ç»Ÿè¿›è¡Œå¿…è¦çš„å…œåº•ï¼Œé˜²æ­¢æœ€åçš„æƒ…å†µå‘ç”Ÿï¼Œè¿™é‡Œæœ€å¸¸è§çš„åšæ³•å°±æ˜¯é‡‡ç”¨é™æµæœºåˆ¶ã€‚</p><p>æ‰€ä»¥åœ¨è¿™èŠ‚è¯¾çš„æœ€åï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹å¹¶å‘ç¼–ç¨‹é¢†åŸŸå¦‚ä½•å®ç°<strong>é™æµ</strong>ã€‚</p><p>çº¿ç¨‹æ± è‡ªå¸¦ä¸€å®šçš„é™æµæ•ˆæœï¼Œå› ä¸ºå·¥ä½œçº¿ç¨‹æ•°é‡æ˜¯ä¸€å®šçš„ï¼Œçº¿ç¨‹æ± å…è®¸çš„æœ€å¤§å¹¶å‘ä¹Ÿæ˜¯ç¡®å®šçš„ã€‚ä¸€æ—¦è¾¾åˆ°æœ€å¤§å¹¶å‘ï¼Œæ–°çš„è¯·æ±‚å°±ä¼šè¿›å…¥åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œæˆ–è€…å¹²è„†è¢«æ‹’ç»ã€‚ä¸è¿‡è¿™èŠ‚è¯¾æˆ‘æƒ³ç»™ä½ ä»‹ç»å¦ä¸€ç§é™æµçš„æ–¹æ³•ï¼šä½¿ç”¨ä¿¡å·é‡ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªå…·ä½“çš„ç¤ºä¾‹ï¼š</p><pre><code class="language-plain">public static void main(String[] args) {
 &nbsp; &nbsp; &nbsp; &nbsp;Semaphore semaphore = new Semaphore(10);
 &nbsp; &nbsp; &nbsp; &nbsp;for(int i = 0; i &lt; 100; i++) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Thread t = new Thread(new Runnable() {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;@Override
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;public void run() {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;doSomething(semaphore);
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  });
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;t.start();
 &nbsp; &nbsp; &nbsp;  }
 &nbsp;  }
 &nbsp; &nbsp;private static &nbsp;void doSomething(Semaphore semaphore) {
 &nbsp; &nbsp; &nbsp; &nbsp;boolean acquired = false;
 &nbsp; &nbsp; &nbsp; &nbsp;try {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;acquired = semaphore.tryAcquire(3000, TimeUnit.MILLISECONDS);
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if(acquired) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;System.out.println("æ‰§è¡Œä¸šåŠ¡é€»è¾‘");
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } else {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;System.out.println("ä¿¡å·é‡æœªè·å–æ‰§è¡Œçš„é€»è¾‘");
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp;  } catch (Throwable e) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;e.printStackTrace();
 &nbsp; &nbsp; &nbsp;  } finally {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if(acquired) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;semaphore.release();
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }
 &nbsp; &nbsp; &nbsp;  }
 &nbsp;  }
</code></pre><p>è¿™æ®µä»£ç éå¸¸ç®€å•ï¼Œå…¶å®å°±æ˜¯é€šè¿‡ä¿¡å·é‡æ¥æ§åˆ¶doSomethingæ–¹æ³•çš„å¹¶å‘åº¦ï¼Œä½¿ç”¨äº†ä¿¡å·é‡çš„ä¸¤ä¸ªä¸»è¦çš„æ–¹æ³•ã€‚</p><ul>
<li>tryAcquireï¼šè¿™ç§æ–¹æ³•æ˜¯å°è¯•è·å–ä¸€ä¸ªä¿¡å·ï¼Œå¦‚æœå½“å‰æ²¡æœ‰å‰©ä½™çš„è®¸å¯ï¼Œè¿‡äº†æŒ‡å®šç­‰å¾…æ—¶é—´ä¹‹åä¼šè¿”å›falseï¼Œè¡¨ç¤ºæœªè·å–è®¸å¯ï¼›</li>
<li>releaseï¼šå½’è¿˜è®¸å¯ï¼Œè¯¥æ–¹æ³•å¿…é¡»åœ¨tryAcquireæ–¹æ³•è¿”å›trueæ—¶è°ƒç”¨ï¼Œä¸ç„¶ä¼šå‘ç”Ÿâ€œè®¸å¯è¶…å‘â€ã€‚</li>
</ul><p>ä½†æ˜¯å¦‚æœåœºæ™¯å†å¤æ‚ä¸€ç‚¹ï¼Œæ¯”å¦‚doSomethingæ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œå‰é¢è¿™æ®µä»£ç çš„æ•ˆæœå°±ä¼šå¤§æ‰“æŠ˜æ‰£äº†ã€‚å¦‚æœdoSomethingçš„åˆ†æ”¯éå¸¸å¤šï¼Œæˆ–è€…é‡åˆ°å¼‚æ­¥è°ƒç”¨ç­‰å¤æ‚æƒ…å†µä¸‹ï¼Œå½’è¿˜è®¸å¯å°†å˜å¾—éå¸¸å¤æ‚ã€‚</p><p>å› ä¸ºåœ¨ä½¿ç”¨ä¿¡å·é‡æ—¶ï¼Œå¦‚æœå¤šæ¬¡è°ƒç”¨releaseï¼Œåº”ç”¨ç¨‹åºå®é™…çš„å¹¶å‘æ•°é‡ä¼šè¶…è¿‡è®¾ç½®çš„è®¸å¯å€¼ã€‚æ‰€ä»¥é¿å…é‡å¤è°ƒç”¨releaseæ–¹æ³•æ˜¾å¾—éå¸¸å…³é”®ã€‚RocketMQç»™å‡ºçš„è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><pre><code class="language-plain">public class SemaphoreReleaseOnlyOnce {
 &nbsp;private final AtomicBoolean released = new AtomicBoolean(false);
 &nbsp;private final Semaphore semaphore;
â€‹
 &nbsp;public SemaphoreReleaseOnlyOnce(Semaphore semaphore) {
 &nbsp; &nbsp;this.semaphore = semaphore;
  }
 &nbsp;public void release() {
 &nbsp; &nbsp;if (this.semaphore != null) {
 &nbsp; &nbsp; &nbsp;if (this.released.compareAndSet(false, true)) {
 &nbsp; &nbsp; &nbsp; &nbsp;this.semaphore.release();
 &nbsp; &nbsp;  }
 &nbsp;  }
  }
 &nbsp;public Semaphore getSemaphore() {
 &nbsp; &nbsp;return semaphore;
  }
}
</code></pre><p>è¿™å¥—æ–¹æ¡ˆçš„æ ¸å¿ƒæ€æƒ³æ˜¯å¯¹Semaphoreè¿›è¡Œä¸€æ¬¡åŒ…è£…ï¼Œç„¶åå°†åŒ…è£…å¯¹è±¡ï¼ˆSemaphoreReleaseOnlyOnceï¼‰ä¼ åˆ°ä¸šåŠ¡æ–¹æ³•ä¸­ã€‚å°±åƒä¸Šé¢è¿™æ®µä»£ç ï¼Œå…¶ä¸­çš„doSomethingæ–¹æ³•æ— è®ºè°ƒç”¨releaseå¤šå°‘æ¬¡éƒ½å¯ä»¥ä¿è¯åº•å±‚çš„Semaphoreåªä¼šè¢«é‡Šæ”¾ä¸€æ¬¡ã€‚</p><p>SemaphoreReleaseOnlyOnceçš„releaseæ–¹æ³•å¼•å…¥äº†CASæœºåˆ¶ï¼Œå¦‚æœreleaseæ–¹æ³•è¢«è°ƒç”¨ï¼Œå°±ä½¿ç”¨CASå°†releasedè®¾ç½®ä¸ºtrueã€‚ä¸‹æ¬¡å…¶ä»–çº¿ç¨‹å†è¯•å›¾å½’è¿˜è®¸å¯æ—¶ï¼Œç”±äºçŠ¶æ€ä¸ºtrueï¼Œæ‰€ä»¥ä¸ä¼šå†æ¬¡è°ƒç”¨Semaphoreçš„releaseæ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥æœ‰æ•ˆæ§åˆ¶å¹¶å‘æ•°é‡äº†ã€‚</p><h2>æ€»ç»“</h2><p>å¥½äº†ï¼Œè¿™èŠ‚è¯¾å°±è®²åˆ°è¿™é‡Œã€‚</p><p>è¿™èŠ‚è¯¾ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬å°±è®²äº†ä¸€ä¸ªå¤§å®¶åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­å¸¸ä¼šé‡åˆ°çš„é—®é¢˜ï¼šå¦‚ä½•å¤ç”¨çº¿ç¨‹ï¼Ÿæˆ‘ä»¬é‡ç‚¹ä»‹ç»äº†çº¿ç¨‹æ± è¿™ç§å¤ç”¨æ–¹æ³•ã€‚å®ƒçš„å†…éƒ¨çš„åŸç†æ˜¯é‡‡ç”¨ while + é˜»å¡é˜Ÿåˆ—çš„æœºåˆ¶ï¼Œç¡®ä¿çº¿ç¨‹çš„runæ–¹æ³•ä¸ä¼šç»“æŸã€‚åœ¨æœ‰ä»»åŠ¡æ‰§è¡Œæ—¶è¿è¡Œä»»åŠ¡ï¼Œæ— ä»»åŠ¡è¿è¡Œæ—¶åˆ™é€šè¿‡é˜»å¡é˜Ÿåˆ—é˜»å¡çº¿ç¨‹ã€‚æˆ‘ä»¬è¿˜é¡ºä¾¿è®²äº†è®²æ€ä¹ˆé€šè¿‡ä¸­æ–­æŠ€æœ¯ä¼˜é›…åœ°åœæ­¢çº¿ç¨‹ã€‚</p><p>ä½¿ç”¨çº¿ç¨‹æ± æ—¶ï¼Œè¿˜æœ‰ä¸€ä¸ªå¸¸è§çš„é—®é¢˜å°±æ˜¯æ€ä¹ˆé€‰æ‹©é˜»å¡é˜Ÿåˆ—ï¼Œæˆ‘æ€»ç»“äº†ä¸‹é¢ä¸‰ä¸ªå°çªé—¨ï¼š</p><ul>
<li>Request-Responseç­‰éœ€è¦ç”¨æˆ·äº¤äº’çš„åœºæ™¯ï¼Œå»ºè®®ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ï¼Œé¿å…å†…å­˜æº¢å‡ºï¼›</li>
<li>å¦‚æœä¸€ä¸ªçº¿ç¨‹å‘å¤šä¸ªé˜Ÿåˆ—å†™å…¥æ¶ˆæ¯ï¼Œå»ºè®®ä½¿ç”¨â€œæ— ç•Œé˜Ÿåˆ—+sizeâ€æœºåˆ¶ï¼Œä¸é˜»å¡é˜Ÿåˆ—ï¼›</li>
<li>å¦‚æœä¸€ä¸ªçº¿ç¨‹å‘ä¸€ä¸ªé˜Ÿåˆ—å†™å…¥æ¶ˆæ¯ï¼Œå»ºè®®ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ï¼Œé¿å…å†…å­˜æº¢å‡ºã€‚</li>
</ul><p>è¿™èŠ‚è¯¾çš„ååŠéƒ¨åˆ†ï¼Œæˆ‘ä»¬è¯¦ç»†ä»‹ç»äº†å¤šçº¿ç¨‹é¢†åŸŸFutureæ¨¡å¼ã€ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼çš„å·¥ä½œåŸç†å’Œä½¿ç”¨åœºæ™¯ã€‚æˆ‘è¿˜æåˆ°äº†é«˜å¹¶å‘æ¶æ„è®¾è®¡ä¸­çš„åº•çº¿æ€ç»´ï¼šé™æµæœºåˆ¶ã€‚åŸºäºä¿¡å·é‡æ¥å®ç°é™æµï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­é¿å…ä¿¡å·é‡çš„è¶…å‘å¯ä»¥é˜²æ­¢ä½ è¸©åˆ°å¾ˆå¤šå‘ã€‚</p><h2>è¯¾åé¢˜</h2><p>åœ¨è¯¾ç¨‹çš„æœ€åï¼Œæˆ‘è¿˜æ˜¯ç…§ä¾‹ç»™ä½ ç•™ä¸¤é“æ€è€ƒé¢˜ã€‚</p><ol>
<li>ä½ æ˜¯æ€ä¹ˆç†è§£Futureæ¨¡å¼çš„ï¼Ÿåˆä¼šæ€ä¹ˆå®ç°å®ƒå‘¢ï¼Ÿ</li>
<li>åœºæ™¯é¢˜ï¼šæœ‰ä¸€å®¶ä¸»è¦ç”Ÿäº§é¢åŒ…çš„å·¥å‚ï¼Œä½†æ˜¯å·¥å‚çš„ä»“åº“å®¹é‡éå¸¸æœ‰é™ã€‚ä¸€æ—¦ä»“åº“å­˜æ»¡é¢åŒ…ï¼Œå°±æ²¡æ³•ç”Ÿäº§æ–°çš„é¢åŒ…äº†ã€‚é¡¾å®¢æ¥è´­ä¹°é¢åŒ…åï¼Œä»“åº“å®¹é‡ä¼šå¾—åˆ°é‡Šæ”¾ã€‚è¯·ä½ ç”¨Javaå¤šçº¿ç¨‹ç›¸å…³çš„æŠ€æœ¯å®ç°è¿™ä¸ªåœºæ™¯ã€‚</li>
</ol><p>å®Œæˆè¿™ä¸ªåœºæ™¯å¯ä»¥è®©æˆ‘ä»¬è¿…é€Ÿç†è§£å¤šçº¿ç¨‹ç¼–ç¨‹çš„è¦é¢†ï¼Œæ‰€ä»¥è¯·ä½ ä¸€å®šè¦é‡è§†ç¬¬äºŒé¢˜ã€‚å¦‚æœä½ æƒ³è¦åˆ†äº«ä½ çš„ä¿®æ”¹æˆ–è€…æƒ³å¬å¬æˆ‘çš„æ„è§ï¼Œå¯ä»¥æäº¤ä¸€ä¸ª <a href="https://github.com/dingwpmz/infoq_question">GitHub</a>çš„pushè¯·æ±‚æˆ–issuesï¼Œå¹¶æŠŠå¯¹åº”åœ°å€è´´åˆ°ç•™è¨€é‡Œã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï¼</p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/18/a0/5f/cf72d453.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å°è±¹å“¥</span>
  </div>
  <div class="_2_QraFYR_0">çœŸå¹²ï¼Œ æœ‰ç‚¹  æ¶ˆåŒ–ä¸äº† ï¼Œè¿™ä¸ªå¤ªé¡¶äº†</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: è°¢è°¢ï¼Œä½ çš„è®¤å¯æ˜¯æˆ‘æœ€å¤§çš„åŠ¨åŠ›ï¼Œå¦‚æœå¯¹å…¶ä¸­æŸä¸€ä¸ªç‚¹ä¸å¤ªç†è§£çš„è¯ï¼Œæˆ‘ä»¬å¤šå¤šäº¤æµï¼Œåœ¨äº¤æµè¿‡ç¨‹ä¸­ï¼Œæˆ‘ç›¸ä¿¡èƒ½ç¢°å‡ºæ›´å¤§çš„ç«èŠ±ï¼Œæˆ‘ä»¬å…±åŒæˆé•¿ï¼Œè¿›æ­¥ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-06-24 16:10:22</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLm8skz4F7FGGBTXWUMia6qVEc00BddeXapicv5FkAx62GmOnUNEcE4scSR60AmappQoNdIQhccKsBA/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æœ«æ—¥ï¼Œæˆæ¬¢</span>
  </div>
  <div class="_2_QraFYR_0">åœºæ™¯é¢˜ï¼š<br>1. æœ‰ä¸ªä»“åº“ï¼Œè¯¥ä»“åº“å­˜å‚¨å®¹é‡æœ‰é™<br>2. ã€çº¿ç¨‹Aã€‘å·¥äººç”Ÿäº§é¢åŒ…ç»™ä»“åº“ï¼Œä»“åº“å®¹é‡++, è¾¾åˆ°å®¹é‡åï¼Œå·¥äººä¸éœ€è¦å†ç”Ÿäº§<br>3. ã€çº¿ç¨‹Bã€‘é¡¾å®¢è´­ä¹°é¢åŒ…ï¼Œä»“åº“å®¹é‡--ï¼Œå®¹é‡æ²¡æœ‰æ—¶ï¼Œæ— æ³•è´­ä¹°<br><br>æˆ‘ä¸€æ­¥ä¸€æ­¥é€»è¾‘å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š<br>1. å°†ä»“åº“å°è£…ä¸ºä¸€ä¸ªç±»ï¼Œè¯¥ç±»ä¸­æœ‰ä¸€ä¸ªæˆå‘˜å±æ€§: ä»“åº“å®¹é‡ã€‚ <br>2. æä¾›çº¿ç¨‹å®‰å…¨çš„æ·»åŠ å®¹é‡ã€æ‰£å‡å®¹é‡çš„æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯ä½¿ç”¨synchronizedä¿æŠ¤èµ·æ¥<br>3. é€šè¿‡è¿™æ ·å¯ä»¥è®©æ·»åŠ ã€æ‰£å‡æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ ä¸ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨æ€§é—®é¢˜ã€‚<br><br>ä½†æ˜¯é€šè¿‡è¿™æ ·è¿˜æ˜¯å­˜åœ¨é—®é¢˜çš„ã€‚<br>ä¹Ÿå°±æ˜¯å·¥äººç”Ÿæˆé¢åŒ…è¾¾åˆ°å®¹é‡åï¼Œæˆ‘ä»¬é€šè¿‡æä¾›çš„æ·»åŠ æ–¹æ³•æ·»åŠ å¤±è´¥åï¼Œå¯ä»¥çŸ¥é“å·²ç»åˆ°è¾¾ä»“åº“å®¹é‡äº†ï¼Œæ­¤æ—¶æ— éœ€ç”Ÿäº§ã€‚<br>è€Œä»€ä¹ˆæ—¶å€™å·¥äººç»§ç»­ç”Ÿäº§æ˜¯ä¸çŸ¥é“çš„ï¼Œå¯èƒ½éœ€è¦ä¸€ä¸ªwhile(true)ä¸€ç›´è°ƒç”¨æ·»åŠ æ–¹æ³•åˆ¤æ–­æ˜¯å¦æœ‰é¡¾å®¢è´­ä¹°ã€‚<br><br>åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œå¯èƒ½ä¼šé¡¾å®¢ä¸€ç›´éƒ½ä¸æ¥ä¹°çš„æƒ…å†µï¼Œå°±ä¼šå¯¼è‡´ä¸€ç›´æ­»å¾ªç¯çš„è·å–é”ï¼Œåˆ¤æ–­ï¼Œé‡Šæ”¾é”ã€‚ æå…¶è€—è´¹CPUèµ„æºã€‚<br>è€Œæœ€å¥½çš„æ–¹æ¡ˆå°±æ˜¯ä½¿ç”¨ï¼Œç­‰å¾…-é€šçŸ¥æœºåˆ¶ã€‚ ä¹Ÿå°±æ˜¯å®¹é‡åˆ°è¾¾é˜ˆå€¼æ—¶ï¼Œçº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œå®¹å™¨ä¸å¤Ÿæ—¶ï¼Œçº¿ç¨‹è¢«å”¤é†’é‡æ–°è¿è¡Œã€‚<br><br><br>è¿™é‡Œå¯ä»¥ä½¿ç”¨å¤šçº¿ç¨‹ä¸­çš„ã€ä¿æŠ¤æ€§æš‚æŒ‚æ¨¡å¼ã€‘<br>è¯¥æ¨¡å¼ä¹Ÿå°±æ˜¯waitã€notifyAllçš„ä¸€ä¸ªè§„èŒƒå®ç°,é€šè¿‡è¿™ç§æœºåˆ¶å¯ä»¥å¤§å¤§é™ä½è·å–çº¿ç¨‹çš„æ— æ•ˆåŠ¨ä½œã€‚ã€æ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œå°±é˜»å¡ã€‘</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ä½ å¥½ï¼Œå›ç­”çš„éå¸¸ä¸é”™ï¼Œæ€è·¯æ¸…æ™°ğŸ‘</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-07-23 20:16:31</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/19/6b/e9/7620ae7e.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>é›¨è½ï½ç´«ç«¹</span>
  </div>
  <div class="_2_QraFYR_0">è¿™ç¯‡ æœ€åçš„å¹²è´§  çœŸè®©çœ¼å‰ä¸€äº®</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: è°¢è°¢è®¤å¯ğŸ™</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-06-22 13:58:29</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src=""
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_341657</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆæ‚¨å¥½ï¼Œæˆ‘æƒ³é—®ä¸€ä¸‹ä½¿ç”¨ä¿¡å·é‡è¿›è¡Œé™æµçš„éƒ¨åˆ†ï¼Œä¸ºä»€ä¹ˆä¿¡å·é‡ä¼šè¶…å‘å‘¢</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-02-26 17:19:01</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/14/d6/46/5eb5261b.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Sudouble</span>
  </div>
  <div class="_2_QraFYR_0">å¤šçº¿ç¨‹çš„é—¨é—¨é“é“ä¸å°‘ã€‚è®¤è¯†åˆ°äº†ä¸Šå±‚è®¾è®¡ï¼Œå†³å®šä¸‹å±‚å®ç°ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å—¯ï¼Œå¯¹çš„ï¼ŒæŒ‰ç…§æˆ‘çš„ç»éªŒï¼Œå¤šçº¿ç¨‹æœ€é‡è¦çš„å…¶å®å°±æ˜¯ç†è§£çº¿ç¨‹å®‰å…¨ï¼Œä»¥åŠé”çš„å®ç°åŸç†ï¼ˆé€šè¿‡ç ”è¯»jucæºç ï¼‰ï¼Œé˜…è¯»jucæ¡†æ¶ï¼Œä¸€å®šä¼šç»™æˆ‘ä»¬å¸¦æ¥ä¸ä¸€æ ·çš„æ„Ÿæ‚Ÿã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-12-28 08:25:11</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqgVXa8DyW0YsrdYtPNMOdGH6hfdwfjwyBPRyoc9yuS4Ml18l0kApOoOKwYkF6NlDPYpX1bVEWomw/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æœ€æ‘‡æ‘†çš„é±¼</span>
  </div>
  <div class="_2_QraFYR_0">catch (Throwable e) { e.printStackTrace(); } è¿™é‡Œæœ‰é—®é¢˜å§ï¼Ÿè¿™ä¸æ˜¯åæ‰äº†taskQueue.take()æŠ›å‡ºçš„InterruptedExceptionå—ï¼Ÿè¿™æ ·åœ¨ç­‰å¾…taskçš„æ—¶å€™å°±ä¸ä¼šè¢«ä¸­æ–­äº†ã€‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-10-26 10:31:45</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/19/b1/ef/2356b51e.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>dudu-benny</span>
  </div>
  <div class="_2_QraFYR_0">â€œä¸ºäº†å®ç° MySQL å¢é‡åŒæ­¥ï¼ŒCanal çº¿ç¨‹æºæºä¸æ–­åœ°å°† MySQL æ•°æ®å†™å…¥åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œç„¶åç›®æ ‡ç«¯çº¿ç¨‹ä»é˜Ÿåˆ—ä¸­è¯»å–æ•°æ®å¹¶å†™å…¥åˆ° MQ   â€ è¿™é‡Œä¸ºä»€ä¹ˆä¸ç›´æ¥ä»canal è¯»å–çš„æ•°æ®ç›´æ¥å†™å…¥ MQ , çœå»é˜Ÿåˆ—å¸¦æ¥çš„å¯èƒ½é˜»å¡å’Œé˜Ÿé‡Œé˜»å¡å¸¦æ¥canalçš„è·å–é€Ÿåº¦ç­‰ç­‰é—®é¢˜ </div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-07-16 10:31:01</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/19/b1/ef/2356b51e.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>dudu-benny</span>
  </div>
  <div class="_2_QraFYR_0">1.Future  å¯ä»¥ç†è§£ä¸ºnio çº¿ç¨‹æ¨¡å‹ï¼ŒåŒæ­¥éé˜»å¡ioæ¨¡å‹ï¼Œreactoræ¨¡å¼    nettyçš„åº”ç”¨ç­‰<br>2.å·¥å‚æ˜¯ç”Ÿäº§è€… é¡¾å®¢æ˜¯æ¶ˆè´¹è€…  ä»“åº“æ˜¯æœ‰ç•Œé˜Ÿåˆ—ï¼Œå…¶å®å¯ä»¥ä½¿ç”¨æˆ‘ä»¬åˆšåˆšå­¦ä¹ çš„LinkedBlockingQueueæ¥å®ç°   </div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-07-16 01:09:30</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/14/2f/2d/dce49b2b.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æµ…qiançš„ç—•è¿¹</span>
  </div>
  <div class="_2_QraFYR_0">åœºæ™¯é¢˜å¯ä»¥ä½¿ç”¨ wait()å’ŒnotifyAll()æ¥å®ç°ï¼Œè®¾ç½®ä¸€ä¸ªå®¹é‡é˜ˆå€¼ï¼Œifå½“å‰å®¹é‡è¾¾åˆ°å®¹é‡é˜ˆå€¼ï¼Œå°±wait()ï¼Œè®©ç”Ÿäº§çº¿ç¨‹é˜»å¡ï¼Œ å½“é¡¾å®¢è´­ä¹°é¢åŒ…åï¼Œä»“åº“å®¹é‡ä¼šå¾—åˆ°é‡Šæ”¾ï¼Œå°±notifyAll(), è®©ç”Ÿäº§çº¿ç¨‹ç»§ç»­ç”Ÿäº§</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-07-11 16:44:42</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/18/4b/d7/f46c6dfd.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>William Ning</span>
  </div>
  <div class="_2_QraFYR_0">éœ€è¦æ¶ˆåŒ–ï½<br></div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-07-08 20:58:54</div>
  </div>
</div>
</div>
</li>
</ul>