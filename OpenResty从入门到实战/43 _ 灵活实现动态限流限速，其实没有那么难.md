<audio title="43 _ çµæ´»å®ç°åŠ¨æ€é™æµé™é€Ÿï¼Œå…¶å®æ²¡æœ‰é‚£ä¹ˆéš¾" src="https://static001.geekbang.org/resource/audio/1e/00/1e9f66a8020ff7deae491ed0eee45a00.mp3" controls="controls"></audio> 
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æ¸©é“­ã€‚</p><p>å‰é¢çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä¸ºä½ ä»‹ç»äº†æ¼æ¡¶å’Œä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œå®ƒä»¬éƒ½æ˜¯åº”å¯¹çªå‘æµé‡çš„å¸¸ç”¨æ‰‹æ®µã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå­¦ä¹ äº†å¦‚ä½•é€šè¿‡ Nginx é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œæ¥å®ç°å¯¹è¯·æ±‚çš„é™æµé™é€Ÿã€‚ä¸è¿‡å¾ˆæ˜¾ç„¶ï¼Œä½¿ç”¨ Nginx é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œä»…ä»…åœç•™åœ¨å¯ç”¨çš„å±‚é¢ï¼Œè·ç¦»å¥½ç”¨è¿˜æ˜¯æœ‰ä¸å°çš„è·ç¦»çš„ã€‚</p><p>ç¬¬ä¸€ä¸ªé—®é¢˜ä¾¿æ˜¯ï¼Œé™é€Ÿçš„ key è¢«é™åˆ¶åœ¨ Nginx çš„å˜é‡èŒƒå›´å†…ï¼Œä¸èƒ½çµæ´»åœ°è®¾ç½®ã€‚æ¯”å¦‚ï¼Œæ ¹æ®ä¸åŒçš„çœä»½å’Œä¸åŒçš„å®¢æˆ·ç«¯æ¸ é“ï¼Œæ¥è®¾ç½®ä¸åŒçš„é™é€Ÿé˜ˆå€¼ï¼Œè¿™ç§å¸¸è§çš„éœ€æ±‚ç”¨ Nginx å°±æ²¡æœ‰åŠæ³•å®ç°ã€‚</p><p>å¦å¤–ä¸€ä¸ªæ›´å¤§çš„é—®é¢˜æ˜¯ï¼Œä¸èƒ½åŠ¨æ€åœ°è°ƒæ•´é€Ÿç‡ï¼Œæ¯æ¬¡ä¿®æ”¹éƒ½éœ€è¦é‡è½½ Nginx æœåŠ¡ï¼Œè¿™ä¸€ç‚¹æˆ‘ä»¬åœ¨ä¸ŠèŠ‚è¯¾çš„æœ€åä¹Ÿæåˆ°è¿‡ã€‚è¿™æ ·ä¸€æ¥ï¼Œæ ¹æ®ä¸åŒçš„æ—¶é—´æ®µé™é€Ÿè¿™ç§éœ€æ±‚ï¼Œå°±åªèƒ½é€šè¿‡å¤–ç½®çš„è„šæœ¬æ¥è¹©è„šåœ°å®ç°äº†ã€‚</p><p>è¦çŸ¥é“ï¼ŒæŠ€æœ¯æ˜¯ä¸ºä¸šåŠ¡æœåŠ¡çš„ï¼ŒåŒæ—¶ï¼Œä¸šåŠ¡ä¹Ÿåœ¨é©±åŠ¨ç€æŠ€æœ¯çš„è¿›æ­¥ã€‚åœ¨ Nginx è¯ç”Ÿçš„æ—¶ä»£ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆåŠ¨æ€è°ƒæ•´é…ç½®çš„éœ€æ±‚ï¼Œæ›´å¤šçš„æ˜¯åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ã€ä½å†…å­˜å ç”¨ç­‰ç±»ä¼¼çš„éœ€æ±‚ï¼Œåœ¨é©±åŠ¨ç€ Nginx çš„æˆé•¿ã€‚åœ¨æŠ€æœ¯çš„æ¶æ„å’Œå®ç°ä¸Šï¼Œå¹¶æ²¡æœ‰äººèƒ½å¤Ÿé¢„æ–™åˆ°ï¼Œåœ¨ç§»åŠ¨äº’è”ç½‘ã€IoTã€å¾®æœåŠ¡ç­‰åœºæ™¯ä¸‹ï¼Œå¯¹äºåŠ¨æ€å’Œç²¾ç»†æ§åˆ¶çš„éœ€æ±‚ä¼šå¤§é‡çˆ†å‘ã€‚</p><p>è€Œ OpenResty ä½¿ç”¨ Lua è„šæœ¬çš„æ–¹å¼ï¼Œæ°å¥½èƒ½å¤Ÿå¼¥è¡¥ Nginx åœ¨è¿™æ–¹é¢çš„ç¼ºå¤±ï¼Œå½¢æˆäº†æœ‰æ•ˆçš„äº’è¡¥ã€‚è¿™ä¹Ÿæ˜¯ OpenResty è¢«å¹¿æ³›åœ°ç”¨äºæ›¿æ¢ Nginx çš„æ ¹æºæ‰€åœ¨ã€‚åœ¨åé¢å‡ èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä¼šä¸ºä½ ç»§ç»­ä»‹ç»æ›´å¤š OpenResty ä¸­åŠ¨æ€çš„åœºæ™¯å’Œç¤ºä¾‹ã€‚ä»Šå¤©ï¼Œå°±è®©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ï¼Œå¦‚ä½•ä½¿ç”¨ OpenResty æ¥å®ç°åŠ¨æ€é™æµå’Œé™é€Ÿã€‚</p><!-- [[[read_end]]] --><p>åœ¨ OpenResty ä¸­ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨ <a href="https://github.com/openresty/lua-resty-limit-traffic">lua-resty-limit-traffic</a> æ¥åšæµé‡çš„é™åˆ¶ã€‚å®ƒé‡Œé¢åŒ…å«äº† <code>limit-req</code>ï¼ˆé™åˆ¶è¯·æ±‚é€Ÿç‡ï¼‰ã€ <code>limit-count</code>ï¼ˆé™åˆ¶è¯·æ±‚æ•°ï¼‰ å’Œ <code>limit-conn</code> ï¼ˆé™åˆ¶å¹¶å‘è¿æ¥æ•°ï¼‰è¿™ä¸‰ç§ä¸åŒçš„é™åˆ¶æ–¹å¼ï¼›å¹¶ä¸”æä¾›äº†<code>limit.traffic</code> ï¼Œå¯ä»¥æŠŠè¿™ä¸‰ç§æ–¹å¼è¿›è¡Œèšåˆä½¿ç”¨ã€‚</p><h2>é™åˆ¶è¯·æ±‚é€Ÿç‡</h2><p>è®©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ <code>limit-req</code>ï¼Œå®ƒä½¿ç”¨çš„æ˜¯æ¼æ¡¶ç®—æ³•æ¥é™åˆ¶è¯·æ±‚çš„é€Ÿç‡ã€‚</p><p>åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»ç®€è¦ä»‹ç»äº†è¿™ä¸ª resty åº“ä¸­æ¼æ¡¶ç®—æ³•çš„å…³é”®å®ç°ä»£ç ï¼Œç°åœ¨æˆ‘ä»¬å°±æ¥å­¦ä¹ å¦‚ä½•ä½¿ç”¨è¿™ä¸ªåº“ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™æ®µç¤ºä¾‹ä»£ç ï¼š</p><pre><code>resty --shdict='my_limit_req_store 100m' -e 'local limit_req = require &quot;resty.limit.req&quot;
local lim, err = limit_req.new(&quot;my_limit_req_store&quot;, 200, 100)
local delay, err = lim:incoming(&quot;key&quot;, true)
if not delay then
    if err == &quot;rejected&quot; then
        return ngx.exit(503)
    end
    return ngx.exit(500)
end

 if delay &gt;= 0.001 then
    ngx.sleep(delay)
end'
</code></pre><p>æˆ‘ä»¬çŸ¥é“ï¼Œ<code>lua-resty-limit-traffic</code> æ˜¯ä½¿ç”¨å…±äº«å­—å…¸æ¥å¯¹ key è¿›è¡Œä¿å­˜å’Œè®¡æ•°çš„ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ <code>limit-req</code> å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå£°æ˜ <code>my_limit_req_store</code> è¿™ä¸ª 100m çš„ç©ºé—´ã€‚è¿™ä¸€ç‚¹å¯¹äº <code>limit-conn</code> å’Œ <code>limit-count</code> ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œå®ƒä»¬éƒ½éœ€è¦è‡ªå·±å•ç‹¬çš„å…±äº«å­—å…¸ç©ºé—´ï¼Œä»¥ä¾¿åŒºåˆ†å¼€ã€‚</p><pre><code>limit_req.new(&quot;my_limit_req_store&quot;, 200, 100)
</code></pre><p>ä¸Šé¢è¿™è¡Œä»£ç ï¼Œä¾¿æ˜¯å…¶ä¸­æœ€å…³é”®çš„ä¸€è¡Œä»£ç ã€‚å®ƒçš„å«ä¹‰ï¼Œæ˜¯ä½¿ç”¨åä¸º <code>my_limit_req_store</code> çš„å…±äº«å­—å…¸æ¥å­˜æ”¾ç»Ÿè®¡æ•°æ®ï¼Œå¹¶æŠŠæ¯ç§’çš„é€Ÿç‡è®¾ç½®ä¸º 200ã€‚è¿™æ ·ï¼Œå¦‚æœè¶…è¿‡ 200 ä½†å°äº 300ï¼ˆè¿™ä¸ªå€¼æ˜¯ 200 + 100 è®¡ç®—å¾—åˆ°çš„ï¼‰ çš„è¯ï¼Œå°±éœ€è¦æ’é˜Ÿç­‰å€™ï¼›å¦‚æœè¶…è¿‡ 300 çš„è¯ï¼Œå°±ä¼šç›´æ¥æ‹’ç»ã€‚</p><p>åœ¨è®¾ç½®å®Œæˆåï¼Œæˆ‘ä»¬å°±è¦å¯¹ç»ˆç«¯çš„è¯·æ±‚è¿›è¡Œå¤„ç†äº†ï¼Œ<code>lim: incoming("key", true)</code> å°±æ˜¯æ¥åšè¿™ä»¶äº‹æƒ…çš„ã€‚<code>incoming</code>è¿™ä¸ªå‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬éœ€è¦è¯¦ç»†è§£è¯»ä¸€ä¸‹ã€‚</p><p>ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ˜¯ç”¨æˆ·æŒ‡å®šçš„é™é€Ÿçš„ keyã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­å®ƒæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡ï¼Œè¿™å°±æ„å‘³ç€è¦å¯¹æ‰€æœ‰ç»ˆç«¯éƒ½ç»Ÿä¸€é™é€Ÿã€‚å¦‚æœè¦å®ç°æ ¹æ®ä¸åŒçœä»½å’Œæ¸ é“æ¥é™é€Ÿï¼Œå…¶å®ä¹Ÿå¾ˆç®€å•ï¼ŒæŠŠè¿™ä¸¤ä¸ªä¿¡æ¯éƒ½ä½œä¸º key å³å¯ï¼Œä¸‹é¢æ˜¯å®ç°è¿™ä¸€éœ€æ±‚çš„ä¼ªä»£ç ï¼š</p><pre><code>local  province = get_ province(ngx.var.binary_remote_addr)
local channel = ngx.req.get_headers()[&quot;channel&quot;]
local key = province .. channel
lim:incoming(key, true)
</code></pre><p>å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä¸¾ä¸€åä¸‰ï¼Œè‡ªå®šä¹‰ key çš„å«ä¹‰ä»¥åŠè°ƒç”¨ <code>incoming</code> çš„æ¡ä»¶ï¼Œè¿™æ ·ä½ å°±èƒ½æ”¶åˆ°éå¸¸çµæ´»çš„é™æµé™é€Ÿæ•ˆæœäº†ã€‚</p><p>æˆ‘ä»¬å†æ¥çœ‹<code>incoming</code> å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œé»˜è®¤æ˜¯ falseï¼Œæ„å‘³ç€è¿™ä¸ªè¯·æ±‚ä¸ä¼šè¢«è®°å½•åˆ°å…±äº«å­—å…¸ä¸­åšç»Ÿè®¡ï¼Œè¿™åªæ˜¯ä¸€æ¬¡ <code>æ¼”ä¹ </code>ã€‚å¦‚æœè®¾ç½®ä¸º trueï¼Œå°±ä¼šäº§ç”Ÿå®é™…çš„æ•ˆæœäº†ã€‚å› æ­¤ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ éƒ½éœ€è¦æ˜¾å¼åœ°æŠŠå®ƒè®¾ç½®ä¸º trueã€‚</p><p>ä½ å¯èƒ½ä¼šçº³é—·å„¿ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ªå‚æ•°çš„å­˜åœ¨å‘¢ï¼Ÿæˆ‘ä»¬ä¸å¦¨è€ƒè™‘ä¸€ä¸‹è¿™æ ·çš„ä¸€ä¸ªåœºæ™¯ï¼Œä½ è®¾ç½®äº†ä¸¤ä¸ªä¸åŒçš„ <code>limit-req</code> å®ä¾‹ï¼Œé’ˆå¯¹ä¸åŒçš„ keyï¼Œä¸€ä¸ª key æ˜¯ä¸»æœºåï¼Œå¦å¤–ä¸€ä¸ª key æ˜¯å®¢æˆ·ç«¯çš„ IP åœ°å€ã€‚é‚£ä¹ˆï¼Œå½“ä¸€ä¸ªç»ˆç«¯è¯·æ±‚è¢«å¤„ç†çš„æ—¶å€™ï¼Œä¼šæŒ‰ç…§å…ˆåé¡ºåºè°ƒç”¨è¿™ä¸¤ä¸ªå®ä¾‹çš„ <code>incoming</code> æ–¹æ³•ï¼Œå°±åƒä¸‹é¢è¿™æ®µä¼ªç è¡¨ç¤ºçš„ä¸€æ ·ï¼š</p><pre><code>local limiter_one, err = limit_req.new(&quot;my_limit_req_store&quot;, 200, 100)
local limiter_two, err = limit_req.new(&quot;my_limit_req_store&quot;, 20, 10)

limiter_one :incoming(ngx.var.host, true)
limiter_two:incoming(ngx.var.binary_remote_addr, true)
</code></pre><p>å¦‚æœç”¨æˆ·çš„è¯·æ±‚é€šè¿‡äº† <code>limiter_one</code> çš„é˜ˆå€¼æ£€æµ‹ï¼Œä½†è¢« <code>limiter_two</code> çš„æ£€æµ‹æ‹’ç»ï¼Œé‚£ä¹ˆ <code>limiter_one:incoming</code> è¿™æ¬¡å‡½æ•°è°ƒç”¨å°±åº”è¯¥è¢«è®¤ä¸ºæ˜¯ä¸€æ¬¡ <code>æ¼”ä¹ </code>ï¼Œä¸åº”è¯¥çœŸçš„å»è®¡æ•°ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼Œä¸Šè¿°çš„ä»£ç é€»è¾‘å°±ä¸å¤Ÿä¸¥è°¨äº†ã€‚æˆ‘ä»¬éœ€è¦äº‹å…ˆå¯¹æ‰€æœ‰çš„ limiter åšä¸€æ¬¡æ¼”ä¹ ï¼Œå¦‚æœæœ‰ limiter çš„é˜ˆå€¼è¢«è§¦å‘ï¼Œå¯ä»¥ rejected ç»ˆç«¯è¯·æ±‚ï¼Œå°±å¯ä»¥ç›´æ¥è¿”å›ï¼š</p><pre><code>for i = 1, n do
    local lim = limiters[i]
    local delay, err = lim:incoming(keys[i], i == n)
    if not delay then
        return nil, err
    end
end
</code></pre><p>è¿™å…¶å®å°±æ˜¯ <code>incoming</code> å‡½æ•°ç¬¬äºŒä¸ªå‚æ•°çš„æ„ä¹‰æ‰€åœ¨ã€‚åˆšåˆšè¿™æ®µä»£ç å°±æ˜¯ <code>limit.traffic</code> æ¨¡å—æœ€æ ¸å¿ƒçš„ä¸€æ®µä»£ç ï¼Œä¸“é—¨ç”¨ä½œå¤šä¸ªé™æµå™¨çš„ç»„åˆæ‰€ç”¨ã€‚</p><h2>é™åˆ¶è¯·æ±‚æ•°</h2><p>å†æ¥çœ‹ä¸‹ <code>limit.count</code> è¿™ä¸ªé™åˆ¶è¯·æ±‚æ•°çš„åº“ï¼Œå®ƒçš„æ•ˆæœå’Œ GitHub API çš„ Rate Limiting ä¸€æ ·ï¼Œå¯ä»¥é™åˆ¶å›ºå®šæ—¶é—´çª—å£å†…æœ‰å¤šå°‘æ¬¡ç”¨æˆ·è¯·æ±‚ã€‚è€è§„çŸ©ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€æ®µç¤ºä¾‹ä»£ç ï¼š</p><pre><code>local limit_count = require &quot;resty.limit.count&quot;

local lim, err = limit_count.new(&quot;my_limit_count_store&quot;, 5000, 3600)

local key = ngx.req.get_headers()[&quot;Authorization&quot;]
local delay, remaining = lim:incoming(key, true)
</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œ<code>limit.count</code> å’Œ <code>limit.req</code> çš„ä½¿ç”¨æ–¹æ³•æ˜¯ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬å…ˆåœ¨ Nginx.conf ä¸­å®šä¹‰ä¸€ä¸ªå­—å…¸ï¼š</p><pre><code>lua_shared_dict my_limit_count_store 100m;
</code></pre><p>ç„¶å <code>new</code> ä¸€ä¸ª limiter å¯¹è±¡ï¼Œæœ€åç”¨ <code>incoming</code> å‡½æ•°æ¥åˆ¤æ–­å’Œå¤„ç†ã€‚</p><p>ä¸è¿‡ï¼Œä¸åŒçš„æ˜¯ï¼Œ<code>limit-count</code> ä¸­çš„<code>incoming</code> å‡½æ•°çš„ç¬¬äºŒä¸ªè¿”å›å€¼ï¼Œä»£è¡¨ç€è¿˜å‰©ä½™çš„è°ƒç”¨æ¬¡æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æ®æ­¤åœ¨å“åº”å¤´ä¸­å¢åŠ å­—æ®µï¼Œç»™ç»ˆç«¯æ›´å¥½çš„æç¤ºï¼š</p><pre><code>ngx.header[&quot;X-RateLimit-Limit&quot;] = &quot;5000&quot;
ngx.header[&quot;X-RateLimit-Remaining&quot;] = remaining
</code></pre><h2>é™åˆ¶å¹¶å‘è¿æ¥æ•°</h2><p>ç¬¬ä¸‰ç§æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯<code>limit.conn</code> ï¼Œæ˜¯ç”¨æ¥é™åˆ¶å¹¶å‘è¿æ¥æ•°çš„åº“ã€‚å®ƒå’Œå‰é¢æåˆ°çš„ä¸¤ä¸ªåº“æœ‰æ‰€ä¸åŒï¼Œæœ‰ä¸€ä¸ªç‰¹åˆ«çš„ <code>leaving</code> APIï¼Œè¿™é‡Œæˆ‘æ¥ç®€å•ä»‹ç»ä¸‹ã€‚</p><p>å‰é¢æ‰€è®²çš„é™åˆ¶è¯·æ±‚é€Ÿç‡å’Œé™åˆ¶è¯·æ±‚æ•°ï¼Œéƒ½æ˜¯å¯ä»¥ç›´æ¥åœ¨ access è¿™ä¸€ä¸ªé˜¶æ®µå†…å®Œæˆçš„ã€‚è€Œé™åˆ¶å¹¶å‘è¿æ¥æ•°åˆ™ä¸åŒï¼Œå®ƒä¸ä»…éœ€è¦åœ¨ access é˜¶æ®µåˆ¤æ–­æ˜¯å¦è¶…è¿‡é˜ˆå€¼ï¼Œè€Œä¸”éœ€è¦åœ¨ log é˜¶æ®µè°ƒç”¨ <code>leaving</code> æ¥å£ï¼š</p><pre><code>log_by_lua_block {
    local latency = tonumber(ngx.var.request_time) - ctx.limit_conn_delay
    local key = ctx.limit_conn_key

    local conn, err = lim:leaving(key, latency)
}
</code></pre><p>ä¸è¿‡ï¼Œè¿™ä¸ªæ¥å£çš„æ ¸å¿ƒä»£ç å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢è¿™ä¸€è¡Œä»£ç ï¼Œå®é™…ä¸Šå°±æ˜¯æŠŠè¿æ¥æ•°å‡ä¸€çš„æ“ä½œã€‚å¦‚æœä½ æ²¡æœ‰åœ¨ log é˜¶æ®µåšè¿™ä¸ªæ¸…ç†çš„åŠ¨ä½œï¼Œé‚£ä¹ˆè¿æ¥æ•°å°±ä¼šä¸€ç›´ä¸Šæ¶¨ï¼Œå¾ˆå¿«å°±ä¼šè¾¾åˆ°å¹¶å‘çš„é˜ˆå€¼ã€‚</p><pre><code>local conn, err = dict:incr(key, -1)
</code></pre><h2>é™é€Ÿå™¨çš„ç»„åˆ</h2><p>åˆ°è¿™é‡Œï¼Œè¿™ä¸‰ç§æ–¹å¼æˆ‘ä»¬å°±åˆ†åˆ«ä»‹ç»å®Œäº†ã€‚æœ€åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ï¼Œæ€ä¹ˆæŠŠ <code>limit.rate</code>ã€<code>limit.conn</code> å’Œ <code>limit.count</code> ç»„åˆèµ·æ¥ä½¿ç”¨ã€‚è¿™å°±éœ€è¦ç”¨åˆ° <code>limit.traffic</code> ä¸­çš„ <code>combine</code> å‡½æ•°äº†ï¼š</p><pre><code>local lim1, err = limit_req.new(&quot;my_req_store&quot;, 300, 200)
local lim2, err = limit_req.new(&quot;my_req_store&quot;, 200, 100)
local lim3, err = limit_conn.new(&quot;my_conn_store&quot;, 1000, 1000, 0.5)

local limiters = {lim1, lim2, lim3}
local host = ngx.var.host
local client = ngx.var.binary_remote_addr
local keys = {host, client, client}

local delay, err = limit_traffic.combine(limiters, keys, states)
</code></pre><p>æœ‰äº†åˆšåˆšçš„çŸ¥è¯†åŸºç¡€ï¼Œè¿™æ®µä»£ç ä½ åº”è¯¥å¾ˆå®¹æ˜“çœ‹æ˜ç™½ã€‚<code>combine</code> å‡½æ•°çš„æ ¸å¿ƒä»£ç ï¼Œåœ¨æˆ‘ä»¬ä¸Šé¢åˆ†æ <code>limit.rate</code> çš„æ—¶å€™å·²ç»æåˆ°äº†ä¸€éƒ¨åˆ†ï¼Œå®ƒä¸»è¦æ˜¯å€ŸåŠ©äº†æ¼”ä¹ åŠŸèƒ½å’Œ uncommit å‡½æ•°æ¥å®ç°ã€‚è¿™æ ·ç»„åˆä»¥åï¼Œä½ å°±å¯ä»¥ä¸ºå¤šä¸ªé™æµå™¨è®¾ç½®ä¸åŒçš„é˜ˆå€¼å’Œ keyï¼Œå®ç°æ›´å¤æ‚çš„ä¸šåŠ¡éœ€æ±‚äº†ã€‚</p><h2>å†™åœ¨æœ€å</h2><p><code>limit.traffic</code> ä¸ä»…æ”¯æŒä»Šå¤©æ‰€è®²çš„è¿™ä¸‰ç§é™é€Ÿå™¨ï¼Œå®é™…ä¸Šï¼Œåªè¦æŸä¸ªé™é€Ÿå™¨æœ‰ <code>incoming</code> å’Œ <code>uncommit</code> æ¥å£ï¼Œéƒ½å¯ä»¥è¢« <code>limit.traffic</code> çš„ <code>combine</code> å‡½æ•°ç®¡ç†ã€‚</p><p>æœ€åï¼Œç»™ä½ ç•™ä¸€ä¸ªä½œä¸šé¢˜ã€‚ä½ å¯ä»¥å†™ä¸€ä¸ªä¾‹å­ï¼ŒæŠŠä¹‹å‰æˆ‘ä»¬ä»‹ç»è¿‡çš„åŸºäºä»¤ç‰Œæ¡¶çš„<a href="https://github.com/upyun/lua-resty-limit-rate">é™é€Ÿå™¨</a>ç»„åˆèµ·æ¥å—ï¼Ÿæ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„ç­”æ¡ˆä¸æˆ‘è®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„åŒäº‹æœ‹å‹ï¼Œä¸€èµ·å­¦ä¹ å’Œäº¤æµã€‚</p><p></p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/5a/37/8775d714.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>jackstraw</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œè¿™é‡Œçš„é™æµéƒ½æ˜¯é’ˆå¯¹ä¸€å°NGINXçš„ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡æ˜¯Nå°NGINXåŒæ—¶æä¾›æœåŠ¡çš„ï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥æ€ä¹ˆåšé™æµå•Šï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-12-20 07:34:25</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/17/24/35/6728ba94.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æ¸©æš–å²æœˆ</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œè¯·æ•™ä¸ªé—®é¢˜ï¼Œå¯¹äºlimit_rateé™é€Ÿé…ç½®ï¼Œå¦‚æœæ˜¯åŠ¨æ€å»æ”¹è¿™ä¸ªå€¼ï¼Œå¯¹äºå·²ç»åœ¨ä¸‹è½½çš„è¿æ¥æ¥è¯´æ˜¯æ²¡æœ‰ä½œç”¨çš„ï¼Œè¯¥å¦‚ä½•è®©å·²ç»è¿ä¸Šçš„ä¹Ÿç”Ÿæ•ˆï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-12-29 16:13:37</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/48/8f/7ecd4eed.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>FF</span>
  </div>
  <div class="_2_QraFYR_0">è¯·æ•™ä¸ªé—®é¢˜ã€‚å¦‚æœæŠŠ lua æ¨¡å—ç”¨ lua_by_* çš„æ–¹å¼å¼•å…¥ ngx çš„ location æŒ‡ä»¤å—é‡Œé¢ï¼Œé‚£æ¯æ¬¡è¯·æ±‚ï¼Œéƒ½ä¼šæ‰§è¡Œä¸€é lua æ¨¡å—ä¸­çš„ top level å˜é‡å’Œé‚£äº›ä¸æ˜¯å®šä¹‰åœ¨å‡½æ•°ä¸­çš„å…¨å±€ä»£ç å—å— ï¼Ÿ<br><br> <br>æˆ‘æµ‹äº†ä¸€ä¸‹å¥½åƒæ¯æ¬¡è¯·æ±‚éƒ½æ‰§è¡Œä¸€é ï¼Ÿé‚£å…¨å±€å˜é‡ä¸æ˜¯æ¯æ¬¡è¯·æ±‚éƒ½è¦åˆå§‹åŒ–ä¸€æ¬¡å•Š ï¼Ÿè¿™æ ·çš„è¯å¦‚æœæƒ³åœ¨å‡½æ•°æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ä¸­å†å°†ä¸€äº›æ•°æ®ä¿å­˜åˆ°å…¨å±€å˜é‡é‡Œé¢ï¼Œé‚£ä¸æ˜¯æ²¡åŠæ³•ç”¨å…¨å±€å˜é‡å®ç°äº† ï¼Ÿ<br><br><br>ç›¼æ¸©è€å¸ˆè§£æƒ‘ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å¦‚æœä½ è¦ä½¿ç”¨å…¨å±€å˜é‡ï¼Œ å¯ä»¥å†™åˆ° init é˜¶æ®µï¼Œè¿™æ ·å°±åªä¼šæ‰§è¡Œä¸€éäº†ã€‚ä½†æ˜¯å…¨å±€å˜é‡æ˜¯ä¸æ¨èä½¿ç”¨çš„ï¼Œåœ¨æœ€æ–°çš„OpenResty 1.15.8 ç‰ˆæœ¬ä¸­ï¼Œå¢åŠ äº†å…¨å±€å˜é‡çš„æ£€æµ‹ï¼Œå¦‚æœå‘ç°å°±ä¼šæ‰“å°ä¸€æ¡ warn çº§åˆ«çš„æ—¥å¿—ã€‚<br>å¦‚æœä½ å¸Œæœ›ä¿æŒå‡½æ•°ä¸Šä¸‹æ–‡çš„å…¨å±€æ•°æ®ï¼Œå¯ä»¥è¯•è¯•æ¨¡å—çš„ top level å˜é‡ã€‚<br>åŒæ—¶ï¼Œåœ¨ä½ æµ‹è¯•çš„æ—¶å€™ï¼Œè®°å¾—ä¿æŒ lua_code_cache onï¼Œå¹¶ä¸”ä¸è¦åœ¨ Windows ä¸‹æµ‹è¯•ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-09-03 09:19:29</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/da/36/ac0ff6a7.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>wusiration</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œé™åˆ¶å™¨çš„ç»„åˆå°èŠ‚é‡Œé¢çš„ä»£ç ï¼Œlimit_reqé‡å¤äº†ï¼Œåº”è¯¥æœ‰ä¸€ä¸ªlimit_countã€‚<br>è¯¾åä¹ é¢˜ï¼š<br>local limit_rate = require &quot;resty.limit.rate&quot;<br>local limit_count = require &quot;resty.limit.count&quot;<br>local limit_conn = require &quot;resty.limit.conn&quot;<br><br>local lim_rate, err = limit_rate.new(&quot;my_rate_store&quot;, 100, 6000, 2) -- å°†resty.limit.reqæ›¿æ¢æˆresty.limit.rateå³å¯<br>local lim_count, err = limit_count.new(&quot;my_count_store&quot;, 200, 100)<br>local lim_conn, err = limit_conn.new(&quot;my_conn_store&quot;, 1000, 1000, 0.5)<br><br>local limiters = {lim_rate, lim_count, lim_conn}<br>local host = ngx.var.host<br>local client = ngx.var.binary_remote_addr<br>local keys = {host, client, client}<br><br>local delay, err = limit_traffic.combine(limiters, keys, states)<br></div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å¤šè°¢æŒ‡æ­£ï¼Œçœ‹çš„çœŸä»”ç»†ğŸ‘</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-09-02 22:53:40</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/28/73/9a/5197bbbd.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å¼ é³</span>
  </div>
  <div class="_2_QraFYR_0">ä¹‹å‰æœ‰ç”¨è¿‡limit-reqæ–¹æ³•ï¼Œtpsæ¯”è¾ƒé«˜çš„æ—¶å€™ä¸æ˜¯å¾ˆå‡†ï¼Œè€å¸ˆæœ‰é‡åˆ°è¿‡å—</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-02-08 17:06:27</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/19/25/74/77db9f6c.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æ˜¥å¤ç§‹å†¬</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œæˆ‘æƒ³è¦å°†é™é€Ÿé™æµå‚æ•°æ”¾ç½®åœ¨memcachedä¸­ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶é€šè¿‡è¯»å–ç›¸å…³çš„é…ç½®æ¥è¾¾åˆ°åŠ¨æ€é…ç½®é™æµé™é€Ÿçš„åŠŸèƒ½ï¼ˆä»£ç å¦‚ä¸‹ï¼‰ï¼Œå½“æˆ‘æ‰©å¤§memcachedä¸­limit_numå€¼åï¼Œå‘ç°è¿”å›çš„å‰©ä½™çš„è°ƒç”¨æ¬¡æ•°ï¼ˆremainingï¼‰å¹¶æœªå‘ç”Ÿå˜åŒ–ï¼Œå…¶ä¸­åŸç†å¹¶ä¸æ¸…æ¥šï¼ŒæœŸæœ›è€å¸ˆè§£æƒ‘æˆ–è€…æä¾›æ›´å¥½çš„åŠ¨æ€ä¿®æ”¹é™æµé…ç½®çš„æ–¹å‘<br><br>local memcached = require &quot;resty.memcached&quot;<br>local memc, err = memcached:new()<br>memc:set_timeout(1000)<br>local ok, err = memc:connect(&quot;127.0.0.1&quot;, 11211)<br>local limit_num, flags, err = memc:get(&quot;limit_num&quot;)<br>local limit_time, flags, err = memc:get(&quot;limit_time&quot;)<br><br>local limit_count = require &quot;resty.limit.count&quot;<br>local lim, err = limit_count.new(&quot;global_count_limit&quot;, tonumber(limit_num), tonumber(limit_time))<br>local delay, remaining = lim:incoming(&#39;global&#39;, true)<br>if not delay then<br>    return ngx.exit(503)<br>end<br>ngx.say(remaining)</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-11-10 23:26:07</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/60/9f/f939681f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Sir</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆå¥½ï¼Œæˆ‘æŠŠè¿™æ®µä»£ç ä¹Ÿåœ¨locationä¸­ï¼Œæ˜¯ä¸æ˜¯ç›¸å½“äºæˆ‘æ¯æ¬¡è¯·æ±‚éƒ½newäº†ä¸€æ¬¡ï¼Œæ¯”è¾ƒè¿·æƒ‘<br>local lim, err = limit_req.new(&quot;my_limit_req_store&quot;, 200, 100)</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: è¿™ç§å¯¹è±¡çš„ new ä¸€èˆ¬éƒ½æ˜¯æ”¾åœ¨ module çš„ top level ä¸­ï¼Œé¿å…é‡å¤åˆ›å»º</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-09-18 23:33:44</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>è®¸ç«¥ç«¥</span>
  </div>
  <div class="_2_QraFYR_0">è·Ÿç€è€å¸ˆä¸€èµ·ç²¾è¿›ã€‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-09-02 14:49:08</div>
  </div>
</div>
</div>
</li>
</ul>