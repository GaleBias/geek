<audio title="55 _ ç½‘ç»œè™šæ‹ŸåŒ–ï¼šå¦‚ä½•æˆç«‹ç‹¬ç«‹çš„åˆä½œéƒ¨ï¼Ÿ" src="https://static001.geekbang.org/resource/audio/17/dc/17dd6491d3f574bceea1b2d7ce0029dc.mp3" controls="controls"></audio> 
<p>ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬è®²äº†å­˜å‚¨è™šæ‹ŸåŒ–ï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬æ¥è®²ç½‘ç»œè™šæ‹ŸåŒ–ã€‚</p><p>ç½‘ç»œè™šæ‹ŸåŒ–æœ‰å’Œå­˜å‚¨è™šæ‹ŸåŒ–ç±»ä¼¼çš„åœ°æ–¹ï¼Œä¾‹å¦‚ï¼Œå®ƒä»¬éƒ½æ˜¯åŸºäºvirtioçš„ï¼Œå› è€Œæˆ‘ä»¬åœ¨çœ‹ç½‘ç»œè™šæ‹ŸåŒ–çš„è¿‡ç¨‹ä¸­ï¼Œä¼šçœ‹åˆ°å’Œå­˜å‚¨è™šæ‹ŸåŒ–å¾ˆåƒçš„æ•°æ®ç»“æ„å’ŒåŸç†ã€‚ä½†æ˜¯ï¼Œç½‘ç»œè™šæ‹ŸåŒ–ä¹Ÿæœ‰è‡ªå·±çš„ç‰¹æ®Šæ€§ã€‚ä¾‹å¦‚ï¼Œå­˜å‚¨è™šæ‹ŸåŒ–æ˜¯å°†å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶ä½œä¸ºå®¢æˆ·æœºä¸Šçš„ç¡¬ç›˜ï¼Œè€Œç½‘ç»œè™šæ‹ŸåŒ–éœ€è¦ä¾èµ–äºå†…æ ¸åè®®æ ˆè¿›è¡Œç½‘ç»œåŒ…çš„å°è£…ä¸è§£å°è£…ã€‚é‚£æ€ä¹ˆå®ç°å®¢æˆ·æœºå’Œå®¿ä¸»æœºä¹‹é—´çš„äº’é€šå‘¢ï¼Ÿæˆ‘ä»¬å°±ä¸€èµ·æ¥çœ‹ä¸€çœ‹ã€‚</p><h2>è§£æåˆå§‹åŒ–è¿‡ç¨‹</h2><p>æˆ‘ä»¬è¿˜æ˜¯ä»Virtio Network Deviceè¿™ä¸ªè®¾å¤‡çš„åˆå§‹åŒ–è®²èµ·ã€‚</p><pre><code>static const TypeInfo device_type_info = {
    .name = TYPE_DEVICE,
    .parent = TYPE_OBJECT,
    .instance_size = sizeof(DeviceState),
    .instance_init = device_initfn,
    .instance_post_init = device_post_init,
    .instance_finalize = device_finalize,
    .class_base_init = device_class_base_init,
    .class_init = device_class_init,
    .abstract = true,
    .class_size = sizeof(DeviceClass),
};

static const TypeInfo virtio_device_info = {
    .name = TYPE_VIRTIO_DEVICE,
    .parent = TYPE_DEVICE,
    .instance_size = sizeof(VirtIODevice),
    .class_init = virtio_device_class_init,
    .instance_finalize = virtio_device_instance_finalize,
    .abstract = true,
    .class_size = sizeof(VirtioDeviceClass),
};

static const TypeInfo virtio_net_info = {
    .name = TYPE_VIRTIO_NET,
    .parent = TYPE_VIRTIO_DEVICE,
    .instance_size = sizeof(VirtIONet),
    .instance_init = virtio_net_instance_init,
    .class_init = virtio_net_class_init,
};

static void virtio_register_types(void)
{
    type_register_static(&amp;virtio_net_info);
}

type_init(virtio_register_types)
</code></pre><p>Virtio Network Deviceè¿™ç§ç±»çš„å®šä¹‰æ˜¯æœ‰å¤šå±‚ç»§æ‰¿å…³ç³»çš„ï¼ŒTYPE_VIRTIO_NETçš„çˆ¶ç±»æ˜¯TYPE_VIRTIO_DEVICEï¼ŒTYPE_VIRTIO_DEVICEçš„çˆ¶ç±»æ˜¯TYPE_DEVICEï¼ŒTYPE_DEVICEçš„çˆ¶ç±»æ˜¯TYPE_OBJECTï¼Œç»§æ‰¿å…³ç³»åˆ°å¤´äº†ã€‚</p><p>type_initç”¨äºæ³¨å†Œè¿™ç§ç±»ã€‚è¿™é‡Œé¢æ¯ä¸€å±‚éƒ½æœ‰class_initï¼Œç”¨äºä»TypeImplç”ŸæˆxxxClassï¼Œä¹Ÿæœ‰instance_initï¼Œä¼šå°†xxxClassåˆå§‹åŒ–ä¸ºå®ä¾‹ã€‚</p><p>TYPE_VIRTIO_NETå±‚çš„class_initå‡½æ•°virtio_net_class_initï¼Œå®šä¹‰äº†DeviceClassçš„realizeå‡½æ•°ä¸ºvirtio_net_device_realizeï¼Œè¿™ä¸€ç‚¹å’Œå­˜å‚¨å—è®¾å¤‡æ˜¯ä¸€æ ·çš„ã€‚</p><!-- [[[read_end]]] --><pre><code>static void virtio_net_device_realize(DeviceState *dev, Error **errp)
{
    VirtIODevice *vdev = VIRTIO_DEVICE(dev);
    VirtIONet *n = VIRTIO_NET(dev);
    NetClientState *nc;
    int i;
......
    virtio_init(vdev, &quot;virtio-net&quot;, VIRTIO_ID_NET, n-&gt;config_size);

    /*
     * We set a lower limit on RX queue size to what it always was.
     * Guests that want a smaller ring can always resize it without
     * help from us (using virtio 1 and up).
     */
    if (n-&gt;net_conf.rx_queue_size &lt; VIRTIO_NET_RX_QUEUE_MIN_SIZE ||
        n-&gt;net_conf.rx_queue_size &gt; VIRTQUEUE_MAX_SIZE ||
        !is_power_of_2(n-&gt;net_conf.rx_queue_size)) {
......
        return;
    }

    if (n-&gt;net_conf.tx_queue_size &lt; VIRTIO_NET_TX_QUEUE_MIN_SIZE ||
        n-&gt;net_conf.tx_queue_size &gt; VIRTQUEUE_MAX_SIZE ||
        !is_power_of_2(n-&gt;net_conf.tx_queue_size)) {
......
        return;
    }

    n-&gt;max_queues = MAX(n-&gt;nic_conf.peers.queues, 1);
    if (n-&gt;max_queues * 2 + 1 &gt; VIRTIO_QUEUE_MAX) {
......
        return;
    }
    n-&gt;vqs = g_malloc0(sizeof(VirtIONetQueue) * n-&gt;max_queues);
    n-&gt;curr_queues = 1;
......
    n-&gt;net_conf.tx_queue_size = MIN(virtio_net_max_tx_queue_size(n),
                                    n-&gt;net_conf.tx_queue_size);

    for (i = 0; i &lt; n-&gt;max_queues; i++) {
        virtio_net_add_queue(n, i);
    }

    n-&gt;ctrl_vq = virtio_add_queue(vdev, 64, virtio_net_handle_ctrl);
    qemu_macaddr_default_if_unset(&amp;n-&gt;nic_conf.macaddr);
    memcpy(&amp;n-&gt;mac[0], &amp;n-&gt;nic_conf.macaddr, sizeof(n-&gt;mac));
    n-&gt;status = VIRTIO_NET_S_LINK_UP;

    if (n-&gt;netclient_type) {
        n-&gt;nic = qemu_new_nic(&amp;net_virtio_info, &amp;n-&gt;nic_conf,
                              n-&gt;netclient_type, n-&gt;netclient_name, n);
    } else {
        n-&gt;nic = qemu_new_nic(&amp;net_virtio_info, &amp;n-&gt;nic_conf,
                              object_get_typename(OBJECT(dev)), dev-&gt;id, n);
    }
......
}
</code></pre><p>è¿™é‡Œé¢åˆ›å»ºäº†ä¸€ä¸ªVirtIODeviceï¼Œè¿™ä¸€ç‚¹å’Œå­˜å‚¨è™šæ‹ŸåŒ–ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚virtio_initç”¨æ¥åˆå§‹åŒ–è¿™ä¸ªè®¾å¤‡ã€‚VirtIODeviceç»“æ„é‡Œé¢æœ‰ä¸€ä¸ªVirtQueueæ•°ç»„ï¼Œè¿™å°±æ˜¯virtioå‰ç«¯å’Œåç«¯äº’ç›¸ä¼ æ•°æ®çš„é˜Ÿåˆ—ï¼Œæœ€å¤šæœ‰VIRTIO_QUEUE_MAXä¸ªã€‚</p><p>åˆšæ‰æˆ‘ä»¬è¯´çš„éƒ½æ˜¯ä¸€æ ·çš„åœ°æ–¹ï¼Œå…¶å®ä¹Ÿæœ‰ä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œæˆ‘ä»¬ä¸‹é¢æ¥çœ‹ã€‚</p><p>ä½ ä¼šå‘ç°ï¼Œè¿™é‡Œé¢æœ‰è¿™æ ·çš„è¯­å¥n-&gt;max_queues * 2 + 1 &gt; VIRTIO_QUEUE_MAXã€‚ä¸ºä»€ä¹ˆè¦ä¹˜ä»¥2å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºï¼Œå¯¹äºç½‘ç»œè®¾å¤‡æ¥è®²ï¼Œåº”è¯¥åˆ†å‘é€é˜Ÿåˆ—å’Œæ¥æ”¶é˜Ÿåˆ—ä¸¤ä¸ªæ–¹å‘ï¼Œæ‰€ä»¥ä¹˜ä»¥2ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è°ƒç”¨virtio_net_add_queueæ¥åˆå§‹åŒ–é˜Ÿåˆ—ï¼Œå¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™é‡Œé¢å°±æœ‰å‘é€tx_vqå’Œæ¥æ”¶rx_vqä¸¤ä¸ªé˜Ÿåˆ—ã€‚</p><pre><code>typedef struct VirtIONetQueue {
    VirtQueue *rx_vq;
    VirtQueue *tx_vq;
    QEMUTimer *tx_timer;
    QEMUBH *tx_bh;
    uint32_t tx_waiting;
    struct {
        VirtQueueElement *elem;
    } async_tx;
    struct VirtIONet *n;
} VirtIONetQueue;

static void virtio_net_add_queue(VirtIONet *n, int index)
{
    VirtIODevice *vdev = VIRTIO_DEVICE(n);

    n-&gt;vqs[index].rx_vq = virtio_add_queue(vdev, n-&gt;net_conf.rx_queue_size, virtio_net_handle_rx);

......

    n-&gt;vqs[index].tx_vq = virtio_add_queue(vdev, n-&gt;net_conf.tx_queue_size, virtio_net_handle_tx_bh);
    n-&gt;vqs[index].tx_bh = qemu_bh_new(virtio_net_tx_bh, &amp;n-&gt;vqs[index]);
    n-&gt;vqs[index].n = n;
}
</code></pre><p>æ¯ä¸ªVirtQueueä¸­ï¼Œéƒ½æœ‰ä¸€ä¸ªvringç”¨æ¥ç»´æŠ¤è¿™ä¸ªé˜Ÿåˆ—é‡Œé¢çš„æ•°æ®ï¼›å¦å¤–è¿˜æœ‰å‡½æ•°virtio_net_handle_rxç”¨äºå¤„ç†ç½‘ç»œåŒ…çš„æ¥æ”¶ï¼›å‡½æ•°virtio_net_handle_tx_bhç”¨äºç½‘ç»œåŒ…çš„å‘é€ï¼Œè¿™ä¸ªå‡½æ•°æˆ‘ä»¬åé¢ä¼šç”¨åˆ°ã€‚</p><pre><code>NICState *qemu_new_nic(NetClientInfo *info,
                       NICConf *conf,
                       const char *model,
                       const char *name,
                       void *opaque)
{
    NetClientState **peers = conf-&gt;peers.ncs;
    NICState *nic;
    int i, queues = MAX(1, conf-&gt;peers.queues);
......
    nic = g_malloc0(info-&gt;size + sizeof(NetClientState) * queues);
    nic-&gt;ncs = (void *)nic + info-&gt;size;
    nic-&gt;conf = conf;
    nic-&gt;opaque = opaque;

    for (i = 0; i &lt; queues; i++) {
        qemu_net_client_setup(&amp;nic-&gt;ncs[i], info, peers[i], model, name, NULL);
        nic-&gt;ncs[i].queue_index = i;
    }

    return nic;
}

static void qemu_net_client_setup(NetClientState *nc,
                                  NetClientInfo *info,
                                  NetClientState *peer,
                                  const char *model,
                                  const char *name,
                                  NetClientDestructor *destructor)
{
    nc-&gt;info = info;
    nc-&gt;model = g_strdup(model);
    if (name) {
        nc-&gt;name = g_strdup(name);
    } else {
        nc-&gt;name = assign_name(nc, model);
    }

    QTAILQ_INSERT_TAIL(&amp;net_clients, nc, next);

    nc-&gt;incoming_queue = qemu_new_net_queue(qemu_deliver_packet_iov, nc);
    nc-&gt;destructor = destructor;
    QTAILQ_INIT(&amp;nc-&gt;filters);
}
</code></pre><p>æ¥ä¸‹æ¥ï¼Œqemu_new_nicä¼šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºé‡Œé¢çš„ç½‘å¡ã€‚</p><h2>qemuçš„å¯åŠ¨è¿‡ç¨‹ä¸­çš„ç½‘ç»œè™šæ‹ŸåŒ–</h2><p>åˆå§‹åŒ–è¿‡ç¨‹è§£æå®Œæ¯•ä»¥åï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä»qemuçš„å¯åŠ¨è¿‡ç¨‹çœ‹èµ·ã€‚</p><p>å¯¹äºç½‘å¡çš„è™šæ‹ŸåŒ–ï¼Œqemuçš„å¯åŠ¨å‚æ•°é‡Œé¢æœ‰å…³çš„æ˜¯ä¸‹é¢ä¸¤è¡Œï¼š</p><pre><code>-netdev tap,fd=32,id=hostnet0,vhost=on,vhostfd=37
-device virtio-net-pci,netdev=hostnet0,id=net0,mac=fa:16:3e:d1:2d:99,bus=pci.0,addr=0x3
</code></pre><p>qemuçš„mainå‡½æ•°ä¼šè°ƒç”¨net_init_clientsè¿›è¡Œç½‘ç»œè®¾å¤‡çš„åˆå§‹åŒ–ï¼Œå¯ä»¥è§£ænetå‚æ•°ï¼Œä¹Ÿå¯ä»¥åœ¨net_init_clientsä¸­è§£ænetdevå‚æ•°ã€‚</p><pre><code>int net_init_clients(Error **errp)
{
    QTAILQ_INIT(&amp;net_clients);
    if (qemu_opts_foreach(qemu_find_opts(&quot;netdev&quot;),
                          net_init_netdev, NULL, errp)) {
        return -1;
    }
    if (qemu_opts_foreach(qemu_find_opts(&quot;nic&quot;), net_param_nic, NULL, errp)) {
        return -1;
   }
    if (qemu_opts_foreach(qemu_find_opts(&quot;net&quot;), net_init_client, NULL, errp)) {
        return -1;
    }
    return 0;
}  
</code></pre><p>net_init_clientsä¼šè§£æå‚æ•°ã€‚ä¸Šé¢çš„å‚æ•°netdevä¼šè°ƒç”¨net_init_netdev-&gt;net_client_init-&gt;net_client_init1ã€‚</p><p>net_client_init1ä¼šæ ¹æ®ä¸åŒçš„driverç±»å‹ï¼Œè°ƒç”¨ä¸åŒçš„åˆå§‹åŒ–å‡½æ•°ã€‚</p><pre><code>static int (* const net_client_init_fun[NET_CLIENT_DRIVER__MAX])(
    const Netdev *netdev,
    const char *name,
    NetClientState *peer, Error **errp) = {
        [NET_CLIENT_DRIVER_NIC]       = net_init_nic,
        [NET_CLIENT_DRIVER_TAP]       = net_init_tap,
        [NET_CLIENT_DRIVER_SOCKET]    = net_init_socket,
        [NET_CLIENT_DRIVER_HUBPORT]   = net_init_hubport,
......
};
</code></pre><p>ç”±äºæˆ‘ä»¬é…ç½®çš„driverçš„ç±»å‹æ˜¯tapï¼Œå› è€Œè¿™é‡Œä¼šè°ƒç”¨net_init_tap-&gt;net_tap_init-&gt;tap_openã€‚</p><pre><code>#define PATH_NET_TUN &quot;/dev/net/tun&quot;

int tap_open(char *ifname, int ifname_size, int *vnet_hdr,
             int vnet_hdr_required, int mq_required, Error **errp)
{
    struct ifreq ifr;
    int fd, ret;
    int len = sizeof(struct virtio_net_hdr);
    unsigned int features;

    TFR(fd = open(PATH_NET_TUN, O_RDWR));
    memset(&amp;ifr, 0, sizeof(ifr));
    ifr.ifr_flags = IFF_TAP | IFF_NO_PI;

    if (ioctl(fd, TUNGETFEATURES, &amp;features) == -1) {
        features = 0;
    }

    if (features &amp; IFF_ONE_QUEUE) {
        ifr.ifr_flags |= IFF_ONE_QUEUE;
    }

    if (*vnet_hdr) {
        if (features &amp; IFF_VNET_HDR) {
            *vnet_hdr = 1;
            ifr.ifr_flags |= IFF_VNET_HDR;
        } else {
            *vnet_hdr = 0;
        }
        ioctl(fd, TUNSETVNETHDRSZ, &amp;len);
    }
......
    ret = ioctl(fd, TUNSETIFF, (void *) &amp;ifr);
......
    fcntl(fd, F_SETFL, O_NONBLOCK);
    return fd;
}
</code></pre><p>åœ¨tap_openä¸­ï¼Œæˆ‘ä»¬æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶"/dev/net/tun"ï¼Œç„¶åé€šè¿‡ioctlæ“ä½œè¿™ä¸ªæ–‡ä»¶ã€‚è¿™æ˜¯Linuxå†…æ ¸çš„ä¸€é¡¹æœºåˆ¶ï¼Œå’ŒKVMæœºåˆ¶å¾ˆåƒã€‚å…¶å®è¿™å°±æ˜¯ä¸€ç§é€šè¿‡æ‰“å¼€è¿™ä¸ªå­—ç¬¦è®¾å¤‡æ–‡ä»¶ï¼Œç„¶åé€šè¿‡ioctlæ“ä½œè¿™ä¸ªæ–‡ä»¶å’Œå†…æ ¸æ‰“äº¤é“ï¼Œæ¥ä½¿ç”¨å†…æ ¸çš„èƒ½åŠ›ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/24/d3/243e93913b18c3ab00be5676bef334d3.png?wh=1546*1303" alt=""></p><p>ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨å†…æ ¸çš„æœºåˆ¶å‘¢ï¼Ÿå› ä¸ºç½‘ç»œåŒ…éœ€è¦ä»è™šæ‹Ÿæœºé‡Œé¢å‘é€åˆ°è™šæ‹Ÿæœºå¤–é¢ï¼Œå‘é€åˆ°å®¿ä¸»æœºä¸Šçš„æ—¶å€™ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªæ­£å¸¸çš„ç½‘ç»œåŒ…æ‰èƒ½è¢«è½¬å‘ã€‚è¦å½¢æˆä¸€ä¸ªç½‘ç»œåŒ…ï¼Œæˆ‘ä»¬é‚£å°±éœ€è¦ç»è¿‡å¤æ‚çš„åè®®æ ˆï¼Œåè®®æ ˆçš„å¤æ‚å’±ä»¬åœ¨<a href="https://time.geekbang.org/column/article/106490">å‘é€ç½‘ç»œåŒ…</a>é‚£ä¸€èŠ‚è®²è¿‡äº†ã€‚</p><p>å®¢æˆ·æœºä¼šå°†ç½‘ç»œåŒ…å‘é€ç»™qemuã€‚qemuè‡ªå·±æ²¡æœ‰ç½‘ç»œåè®®æ ˆï¼Œç°å»å®ç°ä¸€ä¸ªä¹Ÿä¸å¯èƒ½ï¼Œå¤ªå¤æ‚äº†ã€‚äºæ˜¯ï¼Œå®ƒå°±è¦å€ŸåŠ©å†…æ ¸çš„åŠ›é‡ã€‚</p><p>qemuä¼šå°†å®¢æˆ·æœºå‘é€ç»™å®ƒçš„ç½‘ç»œåŒ…ï¼Œç„¶åè½¬æ¢æˆä¸ºæ–‡ä»¶æµï¼Œå†™å…¥"/dev/net/tun"å­—ç¬¦è®¾å¤‡ã€‚å°±åƒå†™ä¸€ä¸ªæ–‡ä»¶ä¸€æ ·ã€‚å†…æ ¸ä¸­TUN/TAPå­—ç¬¦è®¾å¤‡é©±åŠ¨ä¼šæ”¶åˆ°è¿™ä¸ªå†™å…¥çš„æ–‡ä»¶æµï¼Œç„¶åäº¤ç»™TUN/TAPçš„è™šæ‹Ÿç½‘å¡é©±åŠ¨ã€‚è¿™ä¸ªé©±åŠ¨ä¼šå°†æ–‡ä»¶æµå†æ¬¡è½¬æˆç½‘ç»œåŒ…ï¼Œäº¤ç»™TCP/IPæ ˆï¼Œæœ€ç»ˆä»è™šæ‹ŸTAPç½‘å¡tap0å‘å‡ºæ¥ï¼Œæˆä¸ºæ ‡å‡†çš„ç½‘ç»œåŒ…ã€‚åé¢æˆ‘ä»¬ä¼šçœ‹åˆ°è¿™ä¸ªè¿‡ç¨‹ã€‚</p><p>ç°åœ¨æˆ‘ä»¬åˆ°å†…æ ¸é‡Œé¢ï¼Œçœ‹ä¸€çœ‹æ‰“å¼€"/dev/net/tun"å­—ç¬¦è®¾å¤‡åï¼Œå†…æ ¸ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ã€‚å†…æ ¸çš„å®ç°åœ¨drivers/net/tun.cæ–‡ä»¶ä¸­ã€‚è¿™æ˜¯ä¸€ä¸ªå­—ç¬¦è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œåº”è¯¥ç¬¦åˆå­—ç¬¦è®¾å¤‡çš„æ ¼å¼ã€‚</p><pre><code>module_init(tun_init);
module_exit(tun_cleanup);
MODULE_DESCRIPTION(DRV_DESCRIPTION);
MODULE_AUTHOR(DRV_COPYRIGHT);
MODULE_LICENSE(&quot;GPL&quot;);
MODULE_ALIAS_MISCDEV(TUN_MINOR);
MODULE_ALIAS(&quot;devname:net/tun&quot;);

static int __init tun_init(void)
{
......
	ret = rtnl_link_register(&amp;tun_link_ops);
......
	ret = misc_register(&amp;tun_miscdev);
......
	ret = register_netdevice_notifier(&amp;tun_notifier_block);
......
}
</code></pre><p>è¿™é‡Œé¢æ³¨å†Œäº†ä¸€ä¸ªtun_miscdevå­—ç¬¦è®¾å¤‡ï¼Œä»å®ƒçš„å®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œè¿™å°±æ˜¯"/dev/net/tun"å­—ç¬¦è®¾å¤‡ã€‚</p><pre><code>static struct miscdevice tun_miscdev = {
	.minor = TUN_MINOR,
	.name = &quot;tun&quot;,
	.nodename = &quot;net/tun&quot;,
	.fops = &amp;tun_fops,
};

static const struct file_operations tun_fops = {
	.owner	= THIS_MODULE,
	.llseek = no_llseek,
	.read_iter  = tun_chr_read_iter,
	.write_iter = tun_chr_write_iter,
	.poll	= tun_chr_poll,
	.unlocked_ioctl	= tun_chr_ioctl,
	.open	= tun_chr_open,
	.release = tun_chr_close,
	.fasync = tun_chr_fasync,
};
</code></pre><p>qemuçš„tap_openå‡½æ•°ä¼šæ‰“å¼€è¿™ä¸ªå­—ç¬¦è®¾å¤‡PATH_NET_TUNã€‚æ‰“å¼€å­—ç¬¦è®¾å¤‡çš„è¿‡ç¨‹æˆ‘ä»¬ä¸å†é‡å¤ã€‚æˆ‘å°±è¯´ä¸€ä¸‹ï¼Œåˆ°äº†é©±åŠ¨è¿™ä¸€å±‚ï¼Œè°ƒç”¨çš„æ˜¯tun_chr_openã€‚</p><pre><code>static int tun_chr_open(struct inode *inode, struct file * file)
{
	struct tun_file *tfile;
	tfile = (struct tun_file *)sk_alloc(net, AF_UNSPEC, GFP_KERNEL,
					    &amp;tun_proto, 0);
	RCU_INIT_POINTER(tfile-&gt;tun, NULL);
	tfile-&gt;flags = 0;
	tfile-&gt;ifindex = 0;

	init_waitqueue_head(&amp;tfile-&gt;wq.wait);
	RCU_INIT_POINTER(tfile-&gt;socket.wq, &amp;tfile-&gt;wq);

	tfile-&gt;socket.file = file;
	tfile-&gt;socket.ops = &amp;tun_socket_ops;

	sock_init_data(&amp;tfile-&gt;socket, &amp;tfile-&gt;sk);

	tfile-&gt;sk.sk_write_space = tun_sock_write_space;
	tfile-&gt;sk.sk_sndbuf = INT_MAX;

	file-&gt;private_data = tfile;
	INIT_LIST_HEAD(&amp;tfile-&gt;next);

	sock_set_flag(&amp;tfile-&gt;sk, SOCK_ZEROCOPY);

	return 0;
}
</code></pre><p>åœ¨tun_chr_opençš„å‚æ•°é‡Œé¢ï¼Œæœ‰ä¸€ä¸ªstruct fileï¼Œè¿™æ˜¯ä»£è¡¨ä»€ä¹ˆæ–‡ä»¶å‘¢ï¼Ÿå®ƒä»£è¡¨çš„å°±æ˜¯æ‰“å¼€çš„å­—ç¬¦è®¾å¤‡æ–‡ä»¶"/dev/net/tun"ï¼Œå› è€Œå¾€è¿™ä¸ªå­—ç¬¦è®¾å¤‡æ–‡ä»¶ä¸­å†™æ•°æ®ï¼Œå°±ä¼šé€šè¿‡è¿™ä¸ªstruct fileå†™å…¥ã€‚è¿™ä¸ªstruct fileé‡Œé¢çš„file_operationsï¼ŒæŒ‰ç…§å­—ç¬¦è®¾å¤‡æ‰“å¼€çš„è§„åˆ™ï¼ŒæŒ‡å‘çš„å°±æ˜¯tun_fopsã€‚</p><p>å¦å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨tun_chr_openåˆ›å»ºäº†ä¸€ä¸ªç»“æ„struct tun_fileï¼Œå¹¶ä¸”å°†struct fileçš„private_dataæŒ‡å‘å®ƒã€‚</p><pre><code>/* A tun_file connects an open character device to a tuntap netdevice. It
 * also contains all socket related structures 
 * to serve as one transmit queue for tuntap device. 
 */
struct tun_file {
	struct sock sk;
	struct socket socket;
	struct socket_wq wq;
	struct tun_struct __rcu *tun;
	struct fasync_struct *fasync;
	/* only used for fasnyc */
	unsigned int flags;
	union {
		u16 queue_index;
		unsigned int ifindex;
	};
	struct list_head next;
	struct tun_struct *detached;
	struct skb_array tx_array;
};

struct tun_struct {
	struct tun_file __rcu	*tfiles[MAX_TAP_QUEUES];
	unsigned int            numqueues;
	unsigned int 		flags;
	kuid_t			owner;
	kgid_t			group;

	struct net_device	*dev;
	netdev_features_t	set_features;
	int			align;
	int			vnet_hdr_sz;
	int			sndbuf;
	struct tap_filter	txflt;
	struct sock_fprog	fprog;
	/* protected by rtnl lock */
	bool			filter_attached;
	spinlock_t lock;
	struct hlist_head flows[TUN_NUM_FLOW_ENTRIES];
	struct timer_list flow_gc_timer;
	unsigned long ageing_time;
	unsigned int numdisabled;
	struct list_head disabled;
	void *security;
	u32 flow_count;
	u32 rx_batched;
	struct tun_pcpu_stats __percpu *pcpu_stats;
};

static const struct proto_ops tun_socket_ops = {
	.peek_len = tun_peek_len,
	.sendmsg = tun_sendmsg,
	.recvmsg = tun_recvmsg,
};
</code></pre><p>åœ¨struct tun_fileä¸­ï¼Œæœ‰ä¸€ä¸ªæˆå‘˜struct tun_structï¼Œå®ƒé‡Œé¢æœ‰ä¸€ä¸ªstruct net_deviceï¼Œè¿™ä¸ªç”¨æ¥è¡¨ç¤ºå®¿ä¸»æœºä¸Šçš„tuntapç½‘ç»œè®¾å¤‡ã€‚åœ¨struct tun_fileä¸­ï¼Œè¿˜æœ‰struct socketå’Œstruct sockï¼Œå› ä¸ºè¦ç”¨åˆ°å†…æ ¸çš„ç½‘ç»œåè®®æ ˆï¼Œæ‰€ä»¥å°±éœ€è¦è¿™ä¸¤ä¸ªç»“æ„ï¼Œè¿™åœ¨<a href="https://time.geekbang.org/column/article/105338">ç½‘ç»œåè®®</a>é‚£ä¸€èŠ‚å·²ç»åˆ†æè¿‡äº†ã€‚</p><p>æ‰€ä»¥ï¼ŒæŒ‰ç…§struct tun_fileçš„æ³¨é‡Šè¯´çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ•°æ®ç»“æ„ã€‚"/dev/net/tun"å¯¹åº”çš„struct fileçš„private_dataæŒ‡å‘å®ƒï¼Œå› è€Œå¯ä»¥æ¥æ”¶qemuå‘è¿‡æ¥çš„æ•°æ®ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒè¿˜å¯ä»¥é€šè¿‡struct sockæ¥æ“ä½œå†…æ ¸åè®®æ ˆï¼Œç„¶åå°†ç½‘ç»œåŒ…ä»å®¿ä¸»æœºä¸Šçš„tuntapç½‘ç»œè®¾å¤‡å‘å‡ºå»ï¼Œå®¿ä¸»æœºä¸Šçš„tuntapç½‘ç»œè®¾å¤‡å¯¹åº”çš„struct net_deviceä¹Ÿå½’å®ƒç®¡ã€‚</p><p>åœ¨qemuçš„tap_openå‡½æ•°ä¸­ï¼Œæ‰“å¼€è¿™ä¸ªå­—ç¬¦è®¾å¤‡æ–‡ä»¶ä¹‹åï¼Œæ¥ä¸‹æ¥è¦åšçš„äº‹æƒ…æ˜¯ï¼Œé€šè¿‡ioctlæ¥è®¾ç½®å®¿ä¸»æœºçš„ç½‘å¡TUNSETIFFã€‚</p><p>æ¥ä¸‹æ¥ï¼Œioctlåˆ°äº†å†…æ ¸é‡Œé¢ï¼Œä¼šè°ƒç”¨tun_chr_ioctlã€‚</p><pre><code>static long __tun_chr_ioctl(struct file *file, unsigned int cmd,
			    unsigned long arg, int ifreq_len)
{
	struct tun_file *tfile = file-&gt;private_data;
	struct tun_struct *tun;
	void __user* argp = (void __user*)arg;
	struct ifreq ifr;
	kuid_t owner;
	kgid_t group;
	int sndbuf;
	int vnet_hdr_sz;
	unsigned int ifindex;
	int le;
	int ret;

	if (cmd == TUNSETIFF || cmd == TUNSETQUEUE || _IOC_TYPE(cmd) == SOCK_IOC_TYPE) {
		if (copy_from_user(&amp;ifr, argp, ifreq_len))
			return -EFAULT;
	} 
......
	tun = __tun_get(tfile);
	if (cmd == TUNSETIFF) {
		ifr.ifr_name[IFNAMSIZ-1] = '\0';
		ret = tun_set_iff(sock_net(&amp;tfile-&gt;sk), file, &amp;ifr);
......
		if (copy_to_user(argp, &amp;ifr, ifreq_len))
			ret = -EFAULT;
	}
......
}
</code></pre><p>åœ¨__tun_chr_ioctlä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡copy_from_useræŠŠé…ç½®ä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œè°ƒç”¨tun_set_iffè®¾ç½®tuntapç½‘ç»œè®¾å¤‡ï¼Œç„¶åè°ƒç”¨copy_to_userå°†é…ç½®ç»“æœè¿”å›ã€‚</p><pre><code>static int tun_set_iff(struct net *net, struct file *file, struct ifreq *ifr)
{
	struct tun_struct *tun;
	struct tun_file *tfile = file-&gt;private_data;
	struct net_device *dev;
......
	char *name;
	unsigned long flags = 0;
	int queues = ifr-&gt;ifr_flags &amp; IFF_MULTI_QUEUE ?
			     MAX_TAP_QUEUES : 1;

	if (ifr-&gt;ifr_flags &amp; IFF_TUN) {
		/* TUN device */
		flags |= IFF_TUN;
		name = &quot;tun%d&quot;;
	} else if (ifr-&gt;ifr_flags &amp; IFF_TAP) {
		/* TAP device */
		flags |= IFF_TAP;
		name = &quot;tap%d&quot;;
	} else
		return -EINVAL;

	if (*ifr-&gt;ifr_name)
		name = ifr-&gt;ifr_name;

	dev = alloc_netdev_mqs(sizeof(struct tun_struct), name,
				       NET_NAME_UNKNOWN, tun_setup, queues,
				       queues);

	err = dev_get_valid_name(net, dev, name);
	dev_net_set(dev, net);
	dev-&gt;rtnl_link_ops = &amp;tun_link_ops;
	dev-&gt;ifindex = tfile-&gt;ifindex;
	dev-&gt;sysfs_groups[0] = &amp;tun_attr_group;

	tun = netdev_priv(dev);
	tun-&gt;dev = dev;
	tun-&gt;flags = flags;
	tun-&gt;txflt.count = 0;
	tun-&gt;vnet_hdr_sz = sizeof(struct virtio_net_hdr);

	tun-&gt;align = NET_SKB_PAD;
	tun-&gt;filter_attached = false;
	tun-&gt;sndbuf = tfile-&gt;socket.sk-&gt;sk_sndbuf;
	tun-&gt;rx_batched = 0;

	tun_net_init(dev);
	tun_flow_init(tun);

	err = tun_attach(tun, file, false);
	err = register_netdevice(tun-&gt;dev);

	netif_carrier_on(tun-&gt;dev);

	if (netif_running(tun-&gt;dev))
		netif_tx_wake_all_queues(tun-&gt;dev);

	strcpy(ifr-&gt;ifr_name, tun-&gt;dev-&gt;name);
	return 0;
}
</code></pre><p>tun_set_iffåˆ›å»ºäº†struct tun_structå’Œstruct net_deviceï¼Œå¹¶ä¸”å°†è¿™ä¸ªtuntapç½‘ç»œè®¾å¤‡é€šè¿‡register_netdeviceæ³¨å†Œåˆ°å†…æ ¸ä¸­ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½åœ¨å®¿ä¸»æœºä¸Šé€šè¿‡ip addrçœ‹åˆ°è¿™ä¸ªç½‘å¡äº†ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/98/fd/9826223c7375bec19bd13588f3875ffd.png?wh=3463*1903" alt=""></p><p>è‡³æ­¤å®¿ä¸»æœºä¸Šçš„å†…æ ¸çš„æ•°æ®ç»“æ„ä¹Ÿå®Œæˆäº†ã€‚</p><h2>å…³è”å‰ç«¯è®¾å¤‡é©±åŠ¨å’Œåç«¯è®¾å¤‡é©±åŠ¨</h2><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥è§£æåœ¨å®¢æˆ·æœºä¸­å‘é€ä¸€ä¸ªç½‘ç»œåŒ…çš„æ—¶å€™ï¼Œä¼šå‘ç”Ÿå“ªäº›äº‹æƒ…ã€‚</p><p>è™šæ‹Ÿæœºé‡Œé¢çš„è¿›ç¨‹å‘é€ä¸€ä¸ªç½‘ç»œåŒ…ï¼Œé€šè¿‡æ–‡ä»¶ç³»ç»Ÿå’ŒSocketè°ƒç”¨ç½‘ç»œåè®®æ ˆï¼Œåˆ°è¾¾ç½‘ç»œè®¾å¤‡å±‚ã€‚åªä¸è¿‡è¿™ä¸ªä¸æ˜¯æ™®é€šçš„ç½‘ç»œè®¾å¤‡ï¼Œè€Œæ˜¯virtio_netçš„é©±åŠ¨ã€‚</p><p>virtio_netçš„é©±åŠ¨ç¨‹åºä»£ç åœ¨Linuxæ“ä½œç³»ç»Ÿçš„æºä»£ç é‡Œé¢ï¼Œæ–‡ä»¶åä¸ºdrivers/net/virtio_net.cã€‚</p><pre><code>static __init int virtio_net_driver_init(void)
{
    ret = register_virtio_driver(&amp;virtio_net_driver);
......
}
module_init(virtio_net_driver_init);
module_exit(virtio_net_driver_exit);

MODULE_DEVICE_TABLE(virtio, id_table);
MODULE_DESCRIPTION(&quot;Virtio network driver&quot;);
MODULE_LICENSE(&quot;GPL&quot;);

static struct virtio_driver virtio_net_driver = {
	.driver.name =	KBUILD_MODNAME,
	.driver.owner =	THIS_MODULE,
	.id_table =	id_table,
	.validate =	virtnet_validate,
	.probe =	virtnet_probe,
	.remove =	virtnet_remove,
	.config_changed = virtnet_config_changed,
......
};
</code></pre><p>åœ¨virtio_netçš„é©±åŠ¨ç¨‹åºçš„åˆå§‹åŒ–ä»£ç ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ³¨å†Œä¸€ä¸ªé©±åŠ¨å‡½æ•°virtio_net_driverã€‚</p><p>å½“ä¸€ä¸ªè®¾å¤‡é©±åŠ¨ä½œä¸ºä¸€ä¸ªå†…æ ¸æ¨¡å—è¢«åˆå§‹åŒ–çš„æ—¶å€™ï¼Œprobeå‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå› è€Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹virtnet_probeã€‚</p><pre><code>static int virtnet_probe(struct virtio_device *vdev)
{
	int i, err;
	struct net_device *dev;
	struct virtnet_info *vi;
	u16 max_queue_pairs;
	int mtu;

	/* Allocate ourselves a network device with room for our info */
	dev = alloc_etherdev_mq(sizeof(struct virtnet_info), max_queue_pairs);

	/* Set up network device as normal. */
	dev-&gt;priv_flags |= IFF_UNICAST_FLT | IFF_LIVE_ADDR_CHANGE;
	dev-&gt;netdev_ops = &amp;virtnet_netdev;
	dev-&gt;features = NETIF_F_HIGHDMA;

	dev-&gt;ethtool_ops = &amp;virtnet_ethtool_ops;
	SET_NETDEV_DEV(dev, &amp;vdev-&gt;dev);
......
	/* MTU range: 68 - 65535 */
	dev-&gt;min_mtu = MIN_MTU;
	dev-&gt;max_mtu = MAX_MTU;

	/* Set up our device-specific information */
	vi = netdev_priv(dev);
	vi-&gt;dev = dev;
	vi-&gt;vdev = vdev;
	vdev-&gt;priv = vi;
	vi-&gt;stats = alloc_percpu(struct virtnet_stats);
	INIT_WORK(&amp;vi-&gt;config_work, virtnet_config_changed_work);
......
	vi-&gt;max_queue_pairs = max_queue_pairs;

	/* Allocate/initialize the rx/tx queues, and invoke find_vqs */
	err = init_vqs(vi);
	netif_set_real_num_tx_queues(dev, vi-&gt;curr_queue_pairs);
	netif_set_real_num_rx_queues(dev, vi-&gt;curr_queue_pairs);

	virtnet_init_settings(dev);

	err = register_netdev(dev);
	virtio_device_ready(vdev);
	virtnet_set_queues(vi, vi-&gt;curr_queue_pairs);
......
}
</code></pre><p>åœ¨virtnet_probeä¸­ï¼Œä¼šåˆ›å»ºstruct net_deviceï¼Œå¹¶ä¸”é€šè¿‡register_netdevæ³¨å†Œè¿™ä¸ªç½‘ç»œè®¾å¤‡ï¼Œè¿™æ ·åœ¨å®¢æˆ·æœºé‡Œé¢ï¼Œå°±èƒ½çœ‹åˆ°è¿™ä¸ªç½‘å¡äº†ã€‚</p><p>åœ¨virtnet_probeä¸­ï¼Œè¿˜æœ‰ä¸€ä»¶é‡è¦çš„äº‹æƒ…å°±æ˜¯ï¼Œinit_vqsä¼šåˆå§‹åŒ–å‘é€å’Œæ¥æ”¶çš„virtqueueã€‚</p><pre><code>static int init_vqs(struct virtnet_info *vi)
{
	int ret;

	/* Allocate send &amp; receive queues */
	ret = virtnet_alloc_queues(vi);
	ret = virtnet_find_vqs(vi);
......
	get_online_cpus();
	virtnet_set_affinity(vi);
	put_online_cpus();

	return 0;
}

static int virtnet_alloc_queues(struct virtnet_info *vi)
{
	int i;

	vi-&gt;sq = kzalloc(sizeof(*vi-&gt;sq) * vi-&gt;max_queue_pairs, GFP_KERNEL);
	vi-&gt;rq = kzalloc(sizeof(*vi-&gt;rq) * vi-&gt;max_queue_pairs, GFP_KERNEL);

	INIT_DELAYED_WORK(&amp;vi-&gt;refill, refill_work);
	for (i = 0; i &lt; vi-&gt;max_queue_pairs; i++) {
		vi-&gt;rq[i].pages = NULL;
		netif_napi_add(vi-&gt;dev, &amp;vi-&gt;rq[i].napi, virtnet_poll,
			       napi_weight);
		netif_tx_napi_add(vi-&gt;dev, &amp;vi-&gt;sq[i].napi, virtnet_poll_tx,
				  napi_tx ? napi_weight : 0);

		sg_init_table(vi-&gt;rq[i].sg, ARRAY_SIZE(vi-&gt;rq[i].sg));
		ewma_pkt_len_init(&amp;vi-&gt;rq[i].mrg_avg_pkt_len);
		sg_init_table(vi-&gt;sq[i].sg, ARRAY_SIZE(vi-&gt;sq[i].sg));
	}

	return 0;
}
</code></pre><p>æŒ‰ç…§ä¸Šä¸€èŠ‚çš„virtioåŸç†ï¼Œvirtqueueæ˜¯ä¸€ä¸ªä»‹äºå®¢æˆ·æœºå‰ç«¯å’Œqemuåç«¯çš„ä¸€ä¸ªç»“æ„ï¼Œç”¨äºåœ¨è¿™ä¸¤ç«¯ä¹‹é—´ä¼ é€’æ•°æ®ï¼Œå¯¹äºç½‘ç»œè®¾å¤‡æ¥è®²æœ‰å‘é€å’Œæ¥æ”¶ä¸¤ä¸ªæ–¹å‘çš„é˜Ÿåˆ—ã€‚è¿™é‡Œå»ºç«‹çš„struct virtqueueæ˜¯å®¢æˆ·æœºå‰ç«¯å¯¹äºé˜Ÿåˆ—çš„ç®¡ç†çš„æ•°æ®ç»“æ„ã€‚</p><p>é˜Ÿåˆ—çš„å®ä½“éœ€è¦é€šè¿‡å‡½æ•°virtnet_find_vqsæŸ¥æ‰¾æˆ–è€…ç”Ÿæˆï¼Œè¿™é‡Œè¿˜ä¼šæŒ‡å®šæ¥æ”¶é˜Ÿåˆ—çš„callbackå‡½æ•°ä¸ºskb_recv_doneï¼Œå‘é€é˜Ÿåˆ—çš„callbackå‡½æ•°ä¸ºskb_xmit_doneã€‚é‚£å½“bufferä½¿ç”¨å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨è¿™ä¸ªcallbackå‡½æ•°è¿›è¡Œé€šçŸ¥ã€‚</p><pre><code>static int virtnet_find_vqs(struct virtnet_info *vi)
{
	vq_callback_t **callbacks;
	struct virtqueue **vqs;
	int ret = -ENOMEM;
	int i, total_vqs;
	const char **names;

	/* Allocate space for find_vqs parameters */
	vqs = kzalloc(total_vqs * sizeof(*vqs), GFP_KERNEL);
	callbacks = kmalloc(total_vqs * sizeof(*callbacks), GFP_KERNEL);
	names = kmalloc(total_vqs * sizeof(*names), GFP_KERNEL);

	/* Allocate/initialize parameters for send/receive virtqueues */
	for (i = 0; i &lt; vi-&gt;max_queue_pairs; i++) {
		callbacks[rxq2vq(i)] = skb_recv_done;
		callbacks[txq2vq(i)] = skb_xmit_done;
		names[rxq2vq(i)] = vi-&gt;rq[i].name;
		names[txq2vq(i)] = vi-&gt;sq[i].name;
	}

	ret = vi-&gt;vdev-&gt;config-&gt;find_vqs(vi-&gt;vdev, total_vqs, vqs, callbacks, names, ctx, NULL);
......
	for (i = 0; i &lt; vi-&gt;max_queue_pairs; i++) {
		vi-&gt;rq[i].vq = vqs[rxq2vq(i)];
		vi-&gt;rq[i].min_buf_len = mergeable_min_buf_len(vi, vi-&gt;rq[i].vq);
		vi-&gt;sq[i].vq = vqs[txq2vq(i)];
	}
......
}
</code></pre><p>è¿™é‡Œçš„find_vqsæ˜¯åœ¨struct virtnet_infoé‡Œçš„struct virtio_deviceé‡Œçš„struct virtio_config_ops *configé‡Œé¢å®šä¹‰çš„ã€‚</p><p>æ ¹æ®virtio_config_opsçš„å®šä¹‰ï¼Œfind_vqsä¼šè°ƒç”¨vp_modern_find_vqsï¼Œåˆ°è¿™ä¸€æ­¥å’Œå—è®¾å¤‡æ˜¯ä¸€æ ·çš„äº†ã€‚</p><p>åœ¨vp_modern_find_vqsä¸­ï¼Œvp_find_vqsä¼šè°ƒç”¨vp_find_vqs_intxã€‚åœ¨vp_find_vqs_intxä¸­ï¼Œé€šè¿‡request_irqæ³¨å†Œä¸€ä¸ªä¸­æ–­å¤„ç†å‡½æ•°vp_interruptã€‚å½“è®¾å¤‡å‘é˜Ÿåˆ—ä¸­å†™å…¥ä¿¡æ¯æ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªä¸­æ–­ï¼Œä¹Ÿå°±æ˜¯vqä¸­æ–­ã€‚ä¸­æ–­å¤„ç†å‡½æ•°éœ€è¦è°ƒç”¨ç›¸åº”çš„é˜Ÿåˆ—çš„å›è°ƒå‡½æ•°ï¼Œç„¶åæ ¹æ®é˜Ÿåˆ—çš„æ•°ç›®ï¼Œä¾æ¬¡è°ƒç”¨vp_setup_vqå®Œæˆvirtqueueã€vringçš„åˆ†é…å’Œåˆå§‹åŒ–ã€‚</p><p>åŒæ ·ï¼Œè¿™äº›æ•°æ®ç»“æ„ä¼šå’Œvirtioåç«¯çš„VirtIODeviceã€VirtQueueã€vringå¯¹åº”èµ·æ¥ï¼Œéƒ½åº”è¯¥æŒ‡å‘åˆšæ‰åˆ›å»ºçš„é‚£ä¸€æ®µå†…å­˜ã€‚</p><p>å®¢æˆ·æœºåŒæ ·ä¼šé€šè¿‡è°ƒç”¨ä¸“é—¨ç»™å¤–éƒ¨è®¾å¤‡å‘é€æŒ‡ä»¤çš„å‡½æ•°iowriteå‘Šè¯‰å¤–éƒ¨çš„pciè®¾å¤‡ï¼Œè¿™äº›å…±äº«å†…å­˜çš„åœ°å€ã€‚</p><p>è‡³æ­¤å‰ç«¯è®¾å¤‡é©±åŠ¨å’Œåç«¯è®¾å¤‡é©±åŠ¨ä¹‹é—´çš„ä¸¤ä¸ªæ”¶å‘é˜Ÿåˆ—å°±å…³è”å¥½äº†ï¼Œè¿™ä¸¤ä¸ªé˜Ÿåˆ—çš„æ ¼å¼å’Œå—è®¾å¤‡æ˜¯ä¸€æ ·çš„ã€‚</p><h2>å‘é€ç½‘ç»œåŒ…è¿‡ç¨‹</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹å½“çœŸçš„å‘é€ä¸€ä¸ªç½‘ç»œåŒ…çš„æ—¶å€™ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p><p>å½“ç½‘ç»œåŒ…ç»è¿‡å®¢æˆ·æœºçš„åè®®æ ˆåˆ°è¾¾virtio_neté©±åŠ¨çš„æ—¶å€™ï¼ŒæŒ‰ç…§net_device_opsçš„å®šä¹‰ï¼Œstart_xmitä¼šè¢«è°ƒç”¨ã€‚</p><pre><code>static const struct net_device_ops virtnet_netdev = {
	.ndo_open            = virtnet_open,
	.ndo_stop   	     = virtnet_close,
	.ndo_start_xmit      = start_xmit,
	.ndo_validate_addr   = eth_validate_addr,
	.ndo_set_mac_address = virtnet_set_mac_address,
	.ndo_set_rx_mode     = virtnet_set_rx_mode,
	.ndo_get_stats64     = virtnet_stats,
	.ndo_vlan_rx_add_vid = virtnet_vlan_rx_add_vid,
	.ndo_vlan_rx_kill_vid = virtnet_vlan_rx_kill_vid,
	.ndo_xdp		= virtnet_xdp,
	.ndo_features_check	= passthru_features_check,
};
</code></pre><p>æ¥ä¸‹æ¥çš„è°ƒç”¨é“¾ä¸ºï¼šstart_xmit-&gt;xmit_skb-&gt; virtqueue_add_outbuf-&gt;virtqueue_addï¼Œå°†ç½‘ç»œåŒ…æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶è°ƒç”¨virtqueue_notifyé€šçŸ¥æ¥æ”¶æ–¹ã€‚</p><pre><code>static netdev_tx_t start_xmit(struct sk_buff *skb, struct net_device *dev)
{
	struct virtnet_info *vi = netdev_priv(dev);
	int qnum = skb_get_queue_mapping(skb);
	struct send_queue *sq = &amp;vi-&gt;sq[qnum];
	int err;
	struct netdev_queue *txq = netdev_get_tx_queue(dev, qnum);
	bool kick = !skb-&gt;xmit_more;
	bool use_napi = sq-&gt;napi.weight;
......
	/* Try to transmit */
	err = xmit_skb(sq, skb);
......
	if (kick || netif_xmit_stopped(txq))
		virtqueue_kick(sq-&gt;vq);
	return NETDEV_TX_OK;
}

bool virtqueue_kick(struct virtqueue *vq)
{
	if (virtqueue_kick_prepare(vq))
		return virtqueue_notify(vq);
	return true;
}
</code></pre><p>å†™å…¥ä¸€ä¸ªI/Oä¼šä½¿å¾—qemuè§¦å‘VM exitï¼Œè¿™ä¸ªé€»è¾‘æˆ‘ä»¬åœ¨è§£æCPUçš„æ—¶å€™çœ‹åˆ°è¿‡ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é‚£ä¼šè°ƒç”¨VirtQueueçš„handle_outputå‡½æ•°ã€‚å‰é¢æˆ‘ä»¬å·²ç»è®¾ç½®è¿‡è¿™ä¸ªå‡½æ•°äº†ï¼Œå…¶å®å°±æ˜¯virtio_net_handle_tx_bhã€‚</p><pre><code>static void virtio_net_handle_tx_bh(VirtIODevice *vdev, VirtQueue *vq)
{
    VirtIONet *n = VIRTIO_NET(vdev);
    VirtIONetQueue *q = &amp;n-&gt;vqs[vq2q(virtio_get_queue_index(vq))];

    q-&gt;tx_waiting = 1;

    virtio_queue_set_notification(vq, 0);
    qemu_bh_schedule(q-&gt;tx_bh);
}
</code></pre><p>virtio_net_handle_tx_bhè°ƒç”¨äº†qemu_bh_scheduleï¼Œè€Œåœ¨virtio_net_add_queueä¸­è°ƒç”¨qemu_bh_newï¼Œå¹¶æŠŠå‡½æ•°è®¾ç½®ä¸ºvirtio_net_tx_bhã€‚</p><p>virtio_net_tx_bhå‡½æ•°è°ƒç”¨å‘é€å‡½æ•°virtio_net_flush_txã€‚</p><pre><code>static int32_t virtio_net_flush_tx(VirtIONetQueue *q)
{
    VirtIONet *n = q-&gt;n;
    VirtIODevice *vdev = VIRTIO_DEVICE(n);
    VirtQueueElement *elem;
    int32_t num_packets = 0;
    int queue_index = vq2q(virtio_get_queue_index(q-&gt;tx_vq));

    for (;;) {
        ssize_t ret;
        unsigned int out_num;
        struct iovec sg[VIRTQUEUE_MAX_SIZE], sg2[VIRTQUEUE_MAX_SIZE + 1], *out_sg;
        struct virtio_net_hdr_mrg_rxbuf mhdr;

        elem = virtqueue_pop(q-&gt;tx_vq, sizeof(VirtQueueElement));
        out_num = elem-&gt;out_num;
        out_sg = elem-&gt;out_sg;
......
        ret = qemu_sendv_packet_async(qemu_get_subqueue(n-&gt;nic, queue_index),out_sg, out_num, virtio_net_tx_complete);
    }
......
    return num_packets;
}
</code></pre><p>virtio_net_flush_txä¼šè°ƒç”¨virtqueue_popã€‚è¿™é‡Œé¢ï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°å¯¹äºvringçš„æ“ä½œï¼Œä¹Ÿå³ä»è¿™é‡Œé¢å°†å®¢æˆ·æœºé‡Œé¢å†™å…¥çš„æ•°æ®è¯»å–å‡ºæ¥ã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬è°ƒç”¨qemu_sendv_packet_asyncå‘é€ç½‘ç»œåŒ…ã€‚æ¥ä¸‹æ¥çš„è°ƒç”¨é“¾ä¸ºï¼šqemu_sendv_packet_async-&gt;qemu_net_queue_send_iov-&gt;qemu_net_queue_flush-&gt;qemu_net_queue_deliverã€‚</p><p>åœ¨qemu_net_queue_deliverä¸­ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨NetQueueçš„deliverå‡½æ•°ã€‚å‰é¢qemu_new_net_queueä¼šæŠŠdeliverå‡½æ•°è®¾ç½®ä¸ºqemu_deliver_packet_iovã€‚å®ƒä¼šè°ƒç”¨nc-&gt;info-&gt;receive_iovã€‚</p><pre><code>static NetClientInfo net_tap_info = {
    .type = NET_CLIENT_DRIVER_TAP,
    .size = sizeof(TAPState),
    .receive = tap_receive,
    .receive_raw = tap_receive_raw,
    .receive_iov = tap_receive_iov,
    .poll = tap_poll,
    .cleanup = tap_cleanup,
    .has_ufo = tap_has_ufo,
    .has_vnet_hdr = tap_has_vnet_hdr,
    .has_vnet_hdr_len = tap_has_vnet_hdr_len,
    .using_vnet_hdr = tap_using_vnet_hdr,
    .set_offload = tap_set_offload,
    .set_vnet_hdr_len = tap_set_vnet_hdr_len,
    .set_vnet_le = tap_set_vnet_le,
    .set_vnet_be = tap_set_vnet_be,
};
</code></pre><p>æ ¹æ®net_tap_infoçš„å®šä¹‰è°ƒç”¨çš„æ˜¯tap_receive_iovã€‚ä»–ä¼šè°ƒç”¨tap_write_packet-&gt;writevå†™å…¥è¿™ä¸ªå­—ç¬¦è®¾å¤‡ã€‚</p><p>åœ¨å†…æ ¸çš„å­—ç¬¦è®¾å¤‡é©±åŠ¨ä¸­ï¼Œtun_chr_write_iterä¼šè¢«è°ƒç”¨ã€‚</p><pre><code>static ssize_t tun_chr_write_iter(struct kiocb *iocb, struct iov_iter *from)
{
	struct file *file = iocb-&gt;ki_filp;
	struct tun_struct *tun = tun_get(file);
	struct tun_file *tfile = file-&gt;private_data;
	ssize_t result;

	result = tun_get_user(tun, tfile, NULL, from,
			      file-&gt;f_flags &amp; O_NONBLOCK, false);

	tun_put(tun);
	return result;
}
</code></pre><p>å½“æˆ‘ä»¬ä½¿ç”¨writev()ç³»ç»Ÿè°ƒç”¨å‘tun/tapè®¾å¤‡çš„å­—ç¬¦è®¾å¤‡æ–‡ä»¶å†™å…¥æ•°æ®æ—¶ï¼Œtun_chr_writeå‡½æ•°å°†è¢«è°ƒç”¨ã€‚å®ƒä¼šä½¿ç”¨tun_get_userï¼Œä»ç”¨æˆ·åŒºæ¥æ”¶æ•°æ®ï¼Œå°†æ•°æ®å­˜å…¥skbä¸­ï¼Œç„¶åè°ƒç”¨å…³é”®çš„å‡½æ•°netif_rx_ni(skb) ï¼Œå°†skbé€ç»™tcp/ipåè®®æ ˆå¤„ç†ï¼Œæœ€ç»ˆå®Œæˆè™šæ‹Ÿç½‘å¡çš„æ•°æ®æ¥æ”¶ã€‚</p><p>è‡³æ­¤ï¼Œä»è™šæ‹Ÿæœºå†…éƒ¨åˆ°å®¿ä¸»æœºçš„ç½‘ç»œä¼ è¾“è¿‡ç¨‹æ‰ç®—ç»“æŸã€‚</p><h2>æ€»ç»“æ—¶åˆ»</h2><p>æœ€åï¼Œæˆ‘ä»¬æŠŠç½‘ç»œè™šæ‹ŸåŒ–åœºæ™¯ä¸‹ç½‘ç»œåŒ…çš„å‘é€è¿‡ç¨‹æ€»ç»“ä¸€ä¸‹ã€‚</p><ul>
<li>åœ¨è™šæ‹Ÿæœºé‡Œé¢çš„ç”¨æˆ·æ€ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡writeç³»ç»Ÿè°ƒç”¨å†™å…¥socketã€‚</li>
<li>å†™å…¥çš„å†…å®¹ç»è¿‡VFSå±‚ï¼Œå†…æ ¸åè®®æ ˆï¼Œåˆ°è¾¾è™šæ‹Ÿæœºé‡Œé¢çš„å†…æ ¸çš„ç½‘ç»œè®¾å¤‡é©±åŠ¨ï¼Œä¹Ÿå³virtio_netã€‚</li>
<li>virtio_netç½‘ç»œè®¾å¤‡æœ‰ä¸€ä¸ªæ“ä½œç»“æ„struct net_device_opsï¼Œé‡Œé¢å®šä¹‰äº†å‘é€ä¸€ä¸ªç½‘ç»œåŒ…è°ƒç”¨çš„å‡½æ•°ä¸ºstart_xmitã€‚</li>
<li>åœ¨virtio_netçš„å‰ç«¯é©±åŠ¨å’Œqemuä¸­çš„åç«¯é©±åŠ¨ä¹‹é—´ï¼Œæœ‰ä¸¤ä¸ªé˜Ÿåˆ—virtqueueï¼Œä¸€ä¸ªç”¨äºå‘é€ï¼Œä¸€ä¸ªç”¨äºæ¥æ”¶ã€‚ç„¶åï¼Œæˆ‘ä»¬éœ€è¦åœ¨start_xmitä¸­è°ƒç”¨virtqueue_addï¼Œå°†ç½‘ç»œåŒ…æ”¾å…¥å‘é€é˜Ÿåˆ—ï¼Œç„¶åè°ƒç”¨virtqueue_notifyé€šçŸ¥qemuã€‚</li>
<li>qemuæœ¬æ¥å¤„äºKVM_RUNçš„çŠ¶æ€ï¼Œæ”¶åˆ°é€šçŸ¥åï¼Œé€šè¿‡VM exitæŒ‡ä»¤é€€å‡ºå®¢æˆ·æœºæ¨¡å¼ï¼Œè¿›å…¥å®¿ä¸»æœºæ¨¡å¼ã€‚å‘é€ç½‘ç»œåŒ…çš„æ—¶å€™ï¼Œvirtio_net_handle_tx_bhå‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚</li>
<li>æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªforå¾ªç¯ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¾ªç¯ä¸­è°ƒç”¨virtqueue_popï¼Œä»ä¼ è¾“é˜Ÿåˆ—ä¸­è·å–è¦å‘é€çš„æ•°æ®ï¼Œç„¶åè°ƒç”¨qemu_sendv_packet_asyncè¿›è¡Œå‘é€ã€‚</li>
<li>qemuä¼šè°ƒç”¨writevå‘å­—ç¬¦è®¾å¤‡æ–‡ä»¶å†™å…¥ï¼Œè¿›å…¥å®¿ä¸»æœºçš„å†…æ ¸ã€‚</li>
<li>åœ¨å®¿ä¸»æœºå†…æ ¸ä¸­å­—ç¬¦è®¾å¤‡æ–‡ä»¶çš„file_operationsé‡Œé¢çš„write_iterä¼šè¢«è°ƒç”¨ï¼Œä¹Ÿå³ä¼šè°ƒç”¨tun_chr_write_iterã€‚</li>
<li>åœ¨tun_chr_write_iterå‡½æ•°ä¸­ï¼Œtun_get_userå°†è¦å‘é€çš„ç½‘ç»œåŒ…ä»qemuæ‹·è´åˆ°å®¿ä¸»æœºå†…æ ¸é‡Œé¢æ¥ï¼Œç„¶åè°ƒç”¨netif_rx_niå¼€å§‹è°ƒç”¨å®¿ä¸»æœºå†…æ ¸åè®®æ ˆè¿›è¡Œå¤„ç†ã€‚</li>
<li>å®¿ä¸»æœºå†…æ ¸åè®®æ ˆå¤„ç†å®Œæ¯•ä¹‹åï¼Œä¼šå‘é€ç»™tapè™šæ‹Ÿç½‘å¡ï¼Œå®Œæˆä»è™šæ‹Ÿæœºé‡Œé¢åˆ°å®¿ä¸»æœºçš„æ•´ä¸ªå‘é€è¿‡ç¨‹ã€‚</li>
</ul><p><img src="https://static001.geekbang.org/resource/image/e3/44/e329505cfcd367612f8ae47054ec8e44.jpg?wh=3586*5503" alt=""></p><h2>è¯¾å ‚ç»ƒä¹ </h2><p>è¿™ä¸€èŠ‚æˆ‘ä»¬è§£æçš„æ˜¯å‘é€è¿‡ç¨‹ï¼Œè¯·ä½ æ ¹æ®ç±»ä¼¼çš„æ€è·¯ï¼Œè§£æä¸€ä¸‹æ¥æ”¶è¿‡ç¨‹ã€‚</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„ç–‘æƒ‘å’Œè§è§£ï¼Œä¹Ÿæ¬¢è¿æ”¶è—æœ¬èŠ‚å†…å®¹ï¼Œåå¤ç ”è¯»ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·å­¦ä¹ å’Œè¿›æ­¥ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/8c/37/8c0a95fa07a8b9a1abfd394479bdd637.jpg?wh=1110*659" alt=""></p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/23/f8/24fcccea.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ğŸ’¢ æ˜Ÿæ˜ŸğŸ’¢</span>
  </div>
  <div class="_2_QraFYR_0">æˆ‘æ„Ÿè§‰æ¯æ¬¡çœ‹çœ‹æ€»ç»“å°±å·®ä¸å¤šäº†ã€‚ã€‚ä¸€çœ‹åˆ°æ–‡ä¸­çš„ä»£ç ï¼Œå¤´å¾ˆç–¼ï¼Œæœ¬äººcè¯­è¨€åŸºç¡€ä¸€èˆ¬ï¼Œè°ƒç”¨æ¥è°ƒç”¨å»ã€‚å¤´å¾ˆæ™•ã€‚æ¯æ¬¡çœ‹è€å¸ˆçš„æ–‡ç« ã€‚æˆ‘å…ˆæ˜¯å¤§è‡´çœ‹ä¸€ä¸‹æ–‡ç« çš„å¤§æ¦‚æ„æ€ï¼Œæœ€åè®¤çœŸçœ‹ä¸€ä¸‹æ€»ç»“ã€‚ä½†æ˜¯ç¬¬äºŒå¤©å¥½åƒåˆå¿˜å¾—ä¸ƒä¸ƒå…«å…«äº†ã€‚è‡ªå·±åŸºç¡€è¿˜æ˜¯å¤ªå·®äº†ã€‚åˆ˜è€å¸ˆçš„åŠŸåº•ï¼Œå¤ªè¿‡äºæ·±åšã€‚ä½©æœã€‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-11-07 10:44:01</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/14/04/1c/b0c6c009.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>zhj</span>
  </div>
  <div class="_2_QraFYR_0">ä¸ä»…æ˜¯èµ°äº†ä¸¤æ¬¡åè®®æ ˆï¼Œå…³é”®æ˜¯å®¢æˆ·æœºå†…æ ¸æ ˆå°åŒ…--&gt;å®¿ä¸»æœºå†…æ ¸æ ˆè§£åŒ…ï¼Œç„¶ååˆåˆ©ç”¨å®¿ä¸»æœºåè®®æ ˆå°åŒ…å‘å‡ºå»ï¼Œè¿™ä¸ªæµç¨‹æ„Ÿè§‰å¥½æ€ªå¼‚ï¼Œä¸¤æ¬¡èµ°åè®®æ ˆï¼Œä¸‰æ¬¡åŠ¨åŒ…ï¼Œè¿™ä¸ªä¸èƒ½ä¼˜åŒ–å—</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å½“ç„¶èƒ½ä¼˜åŒ–å‘€ï¼Œæ‰€ä»¥æ‰æœ‰DPDKï¼Œvirio vhostï¼ŒSR-IOVç­‰ï¼Œæ‰€ä»¥è¿™é‡Œåˆ†æçš„æ˜¯ä¼ ç»Ÿçš„æ¨¡å¼</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-08-20 19:52:08</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/99/af/d29273e2.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>é¥­ç²’</span>
  </div>
  <div class="_2_QraFYR_0">å†™çš„çœŸå¥½ï¼Œå°¤å…¶æ€»ç»“ç²¾åã€‚ä¸€ç¯‡å†…å®¹è¦æ–­æ–­ç»­ç»­çœ‹å¥½ä¹…ã€‚ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: åŠ æ²¹</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-08-15 17:56:50</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/ac/96/46b13896.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>williamcai</span>
  </div>
  <div class="_2_QraFYR_0">èƒ½å¤§æ¦‚ç†è§£è™šæ‹ŸåŒ–åŸæ¥æ˜¯è¿™ä¹ˆå›äº‹ï¼Œç”¨è½¯ä»¶æ¥æ¨¡æ‹Ÿè®¾å¤‡ï¼Œæœ€åè¿˜æ˜¯è¦çœŸæ­£çš„è®¾å¤‡æ¥å¤„ç†</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-12-24 08:30:05</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/36/94/0b969588.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>é’å¹´ç¥­å¸</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå®¿ä¸»æœºä¸Šçš„ä¸¤ä¸ªè™šæ‹Ÿæœºä¹‹é—´äº’ç›¸å‘é€æ•°æ®ï¼Œä¼šæœ‰ä¼˜åŒ–å—</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-07-24 14:17:50</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/b2/e0/bf56878a.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>kkxue</span>
  </div>
  <div class="_2_QraFYR_0">å­¦äº†è¿™ä¹ˆå¤šå¹´çš„è™šæ‹Ÿç½‘ç»œï¼Œä¸åŠè€å¸ˆä¸€èŠ‚è¯¾çš„æ·±åº¦å•Š</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: åˆ«è¿™æ ·è¯´ï¼Œè¯šæƒ¶è¯šæ</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-08-04 10:35:29</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>leslie</span>
  </div>
  <div class="_2_QraFYR_0">       å­¦ä¹ äº†ï¼šè·Ÿå®Œåˆ˜è€å¸ˆçš„è¶£è°ˆç½‘ç»œåè®®å†è·Ÿç€linuxç³»ç»Ÿï¼Œå‘ç°æ”¶è·åˆä¸ä¸€æ ·ï¼›åŒæ—¶åœ¨è·Ÿè€å¸ˆçš„ç½‘ç»œåè®®çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜è¢«è¿«å»è·Ÿç€å­¦ä¹ åˆ˜æ–‡æµ©è€å¸ˆçš„è®¡ç®—æœºç»„æˆåŸç†-å¦åˆ™æ²¡æ³•ç†è§£è€å¸ˆçš„ä¸€äº›æ¦‚å¿µã€‚<br>       è¿™å¤§æ¦‚å°±æ˜¯è€å¸ˆä¹‹å‰è¯´çš„å­¦ä¹ æ–¹æ³•å§ï¼šä¹¦é˜…è¯»è¶Šåšã€è¯»ä¹¦çš„è¿‡ç¨‹ä¸­ä¸æ–­å»ç›¸åº”çš„æ‰©å±•ã€å­¦ä¹ ã€æå‡ç†è§£ï¼Œç„¶åæ•´ç†å‡ºè‡ªå·±çš„ä¸œè¥¿-ä¹¦å°±è–„äº†ï¼›è™½ç„¶ä¹¦è–„äº†ï¼Œå¯æ˜¯ç¬”è®°å’Œè‡ªå·±çš„å­¦ä¹ ç¬”å½•å´åè€Œè¶Šæ¥è¶Šåšäº†ï¼›æ„Ÿè°¢è€å¸ˆç®€å•å½¢è±¡çš„æ•™è¯²ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: è°¢è°¢å¤¸å¥–</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-08-03 12:04:57</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å®‰æ’</span>
  </div>
  <div class="_2_QraFYR_0">ç½‘ç»œåŒ…æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿç»è¿‡åè®®æ ˆå¤„ç†ä¹‹å‰çš„è¿˜æ˜¯ä¹‹åçš„ï¼Ÿè¿™æ ·çœ‹æ¥è™šæ‹Ÿæœºé‡Œé¢å‘é€ç½‘ç»œæ•°æ®è¦èµ°ä¸¤æ¬¡åè®®æ ˆå—ï¼Ÿå› ä¸ºè™šæ‹Ÿæœºæœ¬èº«ä¹Ÿæœ‰è‡ªå·±çš„åè®®æ ˆï¼Œç»è¿‡è™šæ‹Ÿæœºåè®®æ ˆå¤„ç†çš„æ•°æ®qemuä¼šè¿›è¡Œæ‹†åŒ…é‡æ–°è¿˜åŸå‡ºåŸå§‹çš„æ•°æ®å—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ˜¯çš„ï¼Œä¸¤æ¬¡åè®®æ ˆ</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-08-02 07:48:04</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/9b/06/a1b0bd54.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å‘†èŒç™½çš„å¤§ç™½ã€‚</span>
  </div>
  <div class="_2_QraFYR_0">æœ‰å‡ ä¸ªé—®é¢˜è¿˜æ˜¯æƒ³è¯·æ•™ä¸€ä¸‹ä½œè€…ï¼š<br>ä¸€:è¯¾ç¨‹ä¸­è®²çš„virtio-netåç«¯æ˜¯vhost-netå—?<br>äºŒ:vhost-netæ¨¡å¼ä¸‹,guestosä¸­çš„ç½‘ç»œIOä¸€å®šä¼šå¼•èµ·vmexitå—?<br>ä¸‰:vmexitä¹‹å,KVMæ˜¯æ€ä¹ˆé€šçŸ¥ç»™vhost-netå†…æ ¸çº¿ç¨‹çš„,KVMç›´æ¥è°ƒç”¨vhost-netæ¨¡å—å—?<br>å››:å‰ç«¯è‚¯å®šéƒ½æ˜¯virtio-netäº†,vhost-netåç«¯è·Ÿvirtio-netåç«¯,vmexitä¹‹åéƒ½æ˜¯KVMæ¨¡å—ç›´æ¥è°ƒç”¨åç«¯çš„é©±åŠ¨ä»£ç å—,é‚£è¿™æ®µæ—¶é—´guestoså§‹ç»ˆå‡ºå»vmexitçŠ¶æ€,ä¸åšä»»ä½•æ“ä½œå—?<br>äº”:vhost-netæ€ä¹ˆæŠŠåŒ…ä¼ é€’ç»™guestoså•Š,ä¹Ÿæ˜¯KVMç›´æ¥è°ƒç”¨ä»£ç å—?é‚£æ˜¯guestoså‘åŒ…,vmexitç„¶åä¸€ç›´ç­‰ç€,å¯¹ç«¯å›åŒ…ä¹‹åKVMå†vmentryå—?å› ä¸ºIOä¸­æ–­å°±ä¸€ç›´é˜»å¡æ˜¯ä¸æ˜¯æ•ˆç‡å¤ªå·®äº†,è€Œä¸”éå¸¸ç”¨å¯èƒ½å¤–éƒ¨è®¿é—®è™šæ‹Ÿæœºæä¾›çš„æœåŠ¡å•Š,è¿™æ—¶å€™è™šæ‹Ÿæœºæœ¬èº«å°±æ˜¯åœ¨vmentryå·²è¿›å…¥çš„çŠ¶æ€å•Š,è¿™å°±çŸ›ç›¾äº†å•Š.</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-04-25 10:56:17</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/dd/5e/2354204d.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å¤å¤æƒ‘æƒ‘</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆåŠŸåŠ›å¤ªæ·±äº†ï¼Œè†œæ‹œã€‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-09-07 13:09:54</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>è«å</span>
  </div>
  <div class="_2_QraFYR_0">ğŸ®ğŸº</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-09-25 19:53:53</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/19/44/84/4da14994.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å‘†ç“œ</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆå†…åŠ›å¤ªè¿‡æ·±åš,å¾ç­‰éš¾ä»¥æœ›å…¶é¡¹èƒŒ!</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-09-20 16:34:56</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJnRUibp7LV1lyHFWEUz5pIwvuXVIJ9ZlFKFOOQQEc7FO3Umt03FUrvYHa3gXQbvT3M70m6V0LibXvw/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_366a52</span>
  </div>
  <div class="_2_QraFYR_0">å›¾ä¸­çš„è™šæ‹Ÿç½‘å¡tap0å’Œç‰©ç†ç½‘å¡åº”è¯¥æ˜¯åœ¨å†…æ ¸æ€éƒ¨åˆ†çš„å§ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-11-08 00:16:54</div>
  </div>
</div>
</div>
</li>
</ul>