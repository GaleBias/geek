<audio title="48 _ æ¥æ”¶ç½‘ç»œåŒ…ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•ææ˜ç™½åˆä½œä¼™ä¼´è®©æˆ‘ä»¬åšä»€ä¹ˆï¼Ÿ" src="https://static001.geekbang.org/resource/audio/46/35/469ce452d6a394e9c4048082bd8e1b35.mp3" controls="controls"></audio> 
<p>ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬è§£æäº†ç½‘ç»œåŒ…æ¥æ”¶çš„ä¸ŠåŠéƒ¨åˆ†ï¼Œä»ç¡¬ä»¶ç½‘å¡åˆ°IPå±‚ã€‚è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬æ¥ç€æ¥è§£æTCPå±‚å’ŒSocketå±‚éƒ½åšäº†å“ªäº›äº‹æƒ…ã€‚</p><h2>ç½‘ç»œåè®®æ ˆçš„TCPå±‚</h2><p>ä»tcp_v4_rcvå‡½æ•°å¼€å§‹ï¼Œæˆ‘ä»¬çš„å¤„ç†é€»è¾‘å°±ä»IPå±‚åˆ°äº†TCPå±‚ã€‚</p><pre><code>int tcp_v4_rcv(struct sk_buff *skb)
{
	struct net *net = dev_net(skb-&gt;dev);
	const struct iphdr *iph;
	const struct tcphdr *th;
	bool refcounted;
	struct sock *sk;
	int ret;
......
	th = (const struct tcphdr *)skb-&gt;data;
	iph = ip_hdr(skb);
......
	TCP_SKB_CB(skb)-&gt;seq = ntohl(th-&gt;seq);
	TCP_SKB_CB(skb)-&gt;end_seq = (TCP_SKB_CB(skb)-&gt;seq + th-&gt;syn + th-&gt;fin + skb-&gt;len - th-&gt;doff * 4);
	TCP_SKB_CB(skb)-&gt;ack_seq = ntohl(th-&gt;ack_seq);
	TCP_SKB_CB(skb)-&gt;tcp_flags = tcp_flag_byte(th);
	TCP_SKB_CB(skb)-&gt;tcp_tw_isn = 0;
	TCP_SKB_CB(skb)-&gt;ip_dsfield = ipv4_get_dsfield(iph);
	TCP_SKB_CB(skb)-&gt;sacked	 = 0;

lookup:
	sk = __inet_lookup_skb(&amp;tcp_hashinfo, skb, __tcp_hdrlen(th), th-&gt;source, th-&gt;dest, &amp;refcounted);

process:
	if (sk-&gt;sk_state == TCP_TIME_WAIT)
		goto do_time_wait;

	if (sk-&gt;sk_state == TCP_NEW_SYN_RECV) {
......
	}
......
	th = (const struct tcphdr *)skb-&gt;data;
	iph = ip_hdr(skb);

	skb-&gt;dev = NULL;

	if (sk-&gt;sk_state == TCP_LISTEN) {
		ret = tcp_v4_do_rcv(sk, skb);
		goto put_and_return;
	}
......
	if (!sock_owned_by_user(sk)) {
		if (!tcp_prequeue(sk, skb))
			ret = tcp_v4_do_rcv(sk, skb);
	} else if (tcp_add_backlog(sk, skb)) {
		goto discard_and_relse;
	}
......
}
</code></pre><p>åœ¨tcp_v4_rcvä¸­ï¼Œå¾—åˆ°TCPçš„å¤´ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å¤„ç†TCPå±‚çš„äº‹æƒ…ã€‚å› ä¸ºTCPå±‚æ˜¯åˆ†çŠ¶æ€çš„ï¼ŒçŠ¶æ€è¢«ç»´æŠ¤åœ¨æ•°æ®ç»“æ„struct socké‡Œé¢ï¼Œå› è€Œæˆ‘ä»¬è¦æ ¹æ®IPåœ°å€ä»¥åŠTCPå¤´é‡Œé¢çš„å†…å®¹ï¼Œåœ¨tcp_hashinfoä¸­æ‰¾åˆ°è¿™ä¸ªåŒ…å¯¹åº”çš„struct sockï¼Œä»è€Œå¾—åˆ°è¿™ä¸ªåŒ…å¯¹åº”çš„è¿æ¥çš„çŠ¶æ€ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ ¹æ®ä¸åŒçš„çŠ¶æ€åšä¸åŒçš„å¤„ç†ï¼Œä¾‹å¦‚ï¼Œä¸Šé¢ä»£ç ä¸­çš„TCP_LISTENã€TCP_NEW_SYN_RECVçŠ¶æ€å±äºè¿æ¥å»ºç«‹è¿‡ç¨‹ä¸­ã€‚è¿™ä¸ªæˆ‘ä»¬åœ¨è®²ä¸‰æ¬¡æ¡æ‰‹çš„æ—¶å€™è®²è¿‡äº†ã€‚å†å¦‚ï¼ŒTCP_TIME_WAITçŠ¶æ€æ˜¯è¿æ¥ç»“æŸçš„æ—¶å€™çš„çŠ¶æ€ï¼Œè¿™ä¸ªæˆ‘ä»¬æš‚æ—¶å¯ä»¥ä¸ç”¨çœ‹ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥åˆ†ææœ€ä¸»æµçš„ç½‘ç»œåŒ…çš„æ¥æ”¶è¿‡ç¨‹ï¼Œè¿™é‡Œé¢æ¶‰åŠä¸‰ä¸ªé˜Ÿåˆ—ï¼š</p><ul>
<li>backlogé˜Ÿåˆ—</li>
<li>prequeueé˜Ÿåˆ—</li>
<li>sk_receive_queueé˜Ÿåˆ—</li>
</ul><p>ä¸ºä»€ä¹ˆæ¥æ”¶ç½‘ç»œåŒ…çš„è¿‡ç¨‹ï¼Œéœ€è¦åœ¨è¿™ä¸‰ä¸ªé˜Ÿåˆ—é‡Œé¢å€’è…¾è¿‡æ¥ã€å€’è…¾è¿‡å»å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºï¼ŒåŒæ ·ä¸€ä¸ªç½‘ç»œåŒ…è¦åœ¨ä¸‰ä¸ªä¸»ä½“ä¹‹é—´äº¤æ¥ã€‚</p><!-- [[[read_end]]] --><p>ç¬¬ä¸€ä¸ªä¸»ä½“æ˜¯<strong>è½¯ä¸­æ–­çš„å¤„ç†è¿‡ç¨‹</strong>ã€‚å¦‚æœä½ æ²¡å¿˜è®°çš„è¯ï¼Œæˆ‘ä»¬åœ¨æ‰§è¡Œtcp_v4_rcvå‡½æ•°çš„æ—¶å€™ï¼Œä¾ç„¶å¤„äºè½¯ä¸­æ–­çš„å¤„ç†é€»è¾‘é‡Œï¼Œæ‰€ä»¥å¿…ç„¶ä¼šå ç”¨è¿™ä¸ªè½¯ä¸­æ–­ã€‚</p><p>ç¬¬äºŒä¸ªä¸»ä½“å°±æ˜¯<strong>ç”¨æˆ·æ€è¿›ç¨‹</strong>ã€‚å¦‚æœç”¨æˆ·æ€è§¦å‘ç³»ç»Ÿè°ƒç”¨readè¯»å–ç½‘ç»œåŒ…ï¼Œä¹Ÿè¦ä»é˜Ÿåˆ—é‡Œé¢æ‰¾ã€‚</p><p>ç¬¬ä¸‰ä¸ªä¸»ä½“å°±æ˜¯<strong>å†…æ ¸åè®®æ ˆ</strong>ã€‚å“ªæ€•ç”¨æˆ·è¿›ç¨‹æ²¡æœ‰è°ƒç”¨readï¼Œè¯»å–ç½‘ç»œåŒ…ï¼Œå½“ç½‘ç»œåŒ…æ¥çš„æ—¶å€™ï¼Œä¹Ÿå¾—æœ‰ä¸€ä¸ªåœ°æ–¹æ”¶ç€å‘€ã€‚</p><p>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿäº†è§£ä¸Šé¢ä»£ç ä¸­sock_owned_by_userçš„æ„æ€äº†ï¼Œå…¶å®å°±æ˜¯è¯´ï¼Œå½“å‰è¿™ä¸ªsockæ˜¯ä¸æ˜¯æ­£æœ‰ä¸€ä¸ªç”¨æˆ·æ€è¿›ç¨‹ç­‰ç€è¯»æ•°æ®å‘¢ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†…æ ¸åè®®æ ˆä¹Ÿè°ƒç”¨tcp_add_backlogï¼Œæš‚å­˜åœ¨backlogé˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”æŠ“ç´§ç¦»å¼€è½¯ä¸­æ–­çš„å¤„ç†è¿‡ç¨‹ã€‚</p><p>å¦‚æœæœ‰ä¸€ä¸ªç”¨æˆ·æ€è¿›ç¨‹ç­‰å¾…è¯»å–æ•°æ®å‘¢ï¼Ÿæˆ‘ä»¬å…ˆè°ƒç”¨tcp_prequeueï¼Œä¹Ÿå³èµ¶ç´§æ”¾å…¥prequeueé˜Ÿåˆ—ï¼Œå¹¶ä¸”ç¦»å¼€è½¯ä¸­æ–­çš„å¤„ç†è¿‡ç¨‹ã€‚åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°å¯¹äºsysctl_tcp_low_latencyçš„åˆ¤æ–­ï¼Œä¹Ÿå³æ˜¯ä¸æ˜¯è¦ä½æ—¶å»¶åœ°å¤„ç†ç½‘ç»œåŒ…ã€‚</p><p>å¦‚æœæŠŠsysctl_tcp_low_latencyè®¾ç½®ä¸º0ï¼Œé‚£å°±è¦æ”¾åœ¨prequeueé˜Ÿåˆ—ä¸­æš‚å­˜ï¼Œè¿™æ ·ä¸ç”¨ç­‰å¾…ç½‘ç»œåŒ…å¤„ç†å®Œæ¯•ï¼Œå°±å¯ä»¥ç¦»å¼€è½¯ä¸­æ–­çš„å¤„ç†è¿‡ç¨‹ï¼Œä½†æ˜¯ä¼šé€ æˆæ¯”è¾ƒé•¿çš„æ—¶å»¶ã€‚å¦‚æœæŠŠsysctl_tcp_low_latencyè®¾ç½®ä¸º1ï¼Œæˆ‘ä»¬è¿˜æ˜¯è°ƒç”¨tcp_v4_do_rcvã€‚</p><pre><code>int tcp_v4_do_rcv(struct sock *sk, struct sk_buff *skb)
{
	struct sock *rsk;

	if (sk-&gt;sk_state == TCP_ESTABLISHED) { /* Fast path */
		struct dst_entry *dst = sk-&gt;sk_rx_dst;
......
		tcp_rcv_established(sk, skb, tcp_hdr(skb), skb-&gt;len);
		return 0;
	}
......
	if (tcp_rcv_state_process(sk, skb)) {
......
	}
	return 0;
......
}
</code></pre><p>åœ¨tcp_v4_do_rcvä¸­ï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æƒ…å†µæ˜¯è¿æ¥å·²ç»å»ºç«‹ï¼Œå¤„äºTCP_ESTABLISHEDçŠ¶æ€ï¼Œè°ƒç”¨tcp_rcv_establishedã€‚å¦ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯å…¶ä»–çš„çŠ¶æ€ï¼Œè°ƒç”¨tcp_rcv_state_processã€‚</p><pre><code>int tcp_rcv_state_process(struct sock *sk, struct sk_buff *skb)
{
	struct tcp_sock *tp = tcp_sk(sk);
	struct inet_connection_sock *icsk = inet_csk(sk);
	const struct tcphdr *th = tcp_hdr(skb);
	struct request_sock *req;
	int queued = 0;
	bool acceptable;

	switch (sk-&gt;sk_state) {
	case TCP_CLOSE:
......
	case TCP_LISTEN:
......
	case TCP_SYN_SENT:
......
	}
......
	switch (sk-&gt;sk_state) {
	case TCP_SYN_RECV:
......
	case TCP_FIN_WAIT1: 
......
	case TCP_CLOSING:
......
	case TCP_LAST_ACK:
......
    }

	/* step 7: process the segment text */
	switch (sk-&gt;sk_state) {
	case TCP_CLOSE_WAIT:
	case TCP_CLOSING:
	case TCP_LAST_ACK:
......
	case TCP_FIN_WAIT1:
	case TCP_FIN_WAIT2:
......
	case TCP_ESTABLISHED:
......
	}
}
</code></pre><p>åœ¨tcp_rcv_state_processä¸­ï¼Œå¦‚æœæˆ‘ä»¬å¯¹ç€TCPçš„çŠ¶æ€å›¾è¿›è¡Œæ¯”å¯¹ï¼Œèƒ½çœ‹åˆ°ï¼Œå¯¹äºTCPæ‰€æœ‰çŠ¶æ€çš„å¤„ç†ï¼Œå…¶ä¸­å’Œè¿æ¥å»ºç«‹ç›¸å…³çš„çŠ¶æ€ï¼Œå’±ä»¬å·²ç»åˆ†æè¿‡ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡ç‚¹å…³æ³¨è¿æ¥çŠ¶æ€ä¸‹çš„å·¥ä½œæ¨¡å¼ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/38/c6/385ff4a348dfd2f64feb0d7ba81e2bc6.png?wh=1423*1963" alt=""></p><p>åœ¨è¿æ¥çŠ¶æ€ä¸‹ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨tcp_rcv_establishedã€‚åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨tcp_data_queueï¼Œå°†å…¶æ”¾å…¥sk_receive_queueé˜Ÿåˆ—è¿›è¡Œå¤„ç†ã€‚</p><pre><code>static void tcp_data_queue(struct sock *sk, struct sk_buff *skb)
{
	struct tcp_sock *tp = tcp_sk(sk);
	bool fragstolen = false;
......
	if (TCP_SKB_CB(skb)-&gt;seq == tp-&gt;rcv_nxt) {
		if (tcp_receive_window(tp) == 0)
			goto out_of_window;

		/* Ok. In sequence. In window. */
		if (tp-&gt;ucopy.task == current &amp;&amp;
		    tp-&gt;copied_seq == tp-&gt;rcv_nxt &amp;&amp; tp-&gt;ucopy.len &amp;&amp;
		    sock_owned_by_user(sk) &amp;&amp; !tp-&gt;urg_data) {
			int chunk = min_t(unsigned int, skb-&gt;len,
					  tp-&gt;ucopy.len);

			__set_current_state(TASK_RUNNING);

			if (!skb_copy_datagram_msg(skb, 0, tp-&gt;ucopy.msg, chunk)) {
				tp-&gt;ucopy.len -= chunk;
				tp-&gt;copied_seq += chunk;
				eaten = (chunk == skb-&gt;len);
				tcp_rcv_space_adjust(sk);
			}
		}

		if (eaten &lt;= 0) {
queue_and_out:
......
			eaten = tcp_queue_rcv(sk, skb, 0, &amp;fragstolen);
		}
		tcp_rcv_nxt_update(tp, TCP_SKB_CB(skb)-&gt;end_seq);
......
		if (!RB_EMPTY_ROOT(&amp;tp-&gt;out_of_order_queue)) {
			tcp_ofo_queue(sk);
......
		}
......
		return;
	}

	if (!after(TCP_SKB_CB(skb)-&gt;end_seq, tp-&gt;rcv_nxt)) {
		/* A retransmit, 2nd most common case.  Force an immediate ack. */
		tcp_dsack_set(sk, TCP_SKB_CB(skb)-&gt;seq, TCP_SKB_CB(skb)-&gt;end_seq);

out_of_window:
		tcp_enter_quickack_mode(sk);
		inet_csk_schedule_ack(sk);
drop:
		tcp_drop(sk, skb);
		return;
	}

	/* Out of window. F.e. zero window probe. */
	if (!before(TCP_SKB_CB(skb)-&gt;seq, tp-&gt;rcv_nxt + tcp_receive_window(tp)))
		goto out_of_window;

	tcp_enter_quickack_mode(sk);

	if (before(TCP_SKB_CB(skb)-&gt;seq, tp-&gt;rcv_nxt)) {
		/* Partial packet, seq &lt; rcv_next &lt; end_seq */
		tcp_dsack_set(sk, TCP_SKB_CB(skb)-&gt;seq, tp-&gt;rcv_nxt);
		/* If window is closed, drop tail of packet. But after
		 * remembering D-SACK for its head made in previous line.
		 */
		if (!tcp_receive_window(tp))
			goto out_of_window;
		goto queue_and_out;
	}

	tcp_data_queue_ofo(sk, skb);
}
</code></pre><p>åœ¨tcp_data_queueä¸­ï¼Œå¯¹äºæ”¶åˆ°çš„ç½‘ç»œåŒ…ï¼Œæˆ‘ä»¬è¦åˆ†æƒ…å†µè¿›è¡Œå¤„ç†ã€‚</p><p>ç¬¬ä¸€ç§æƒ…å†µï¼Œseq == tp-&gt;rcv_nxtï¼Œè¯´æ˜æ¥çš„ç½‘ç»œåŒ…æ­£æ˜¯æˆ‘æœåŠ¡ç«¯æœŸæœ›çš„ä¸‹ä¸€ä¸ªç½‘ç»œåŒ…ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åˆ¤æ–­sock_owned_by_userï¼Œä¹Ÿå³ç”¨æˆ·è¿›ç¨‹ä¹Ÿæ˜¯æ­£åœ¨ç­‰å¾…è¯»å–ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå°±ç›´æ¥skb_copy_datagram_msgï¼Œå°†ç½‘ç»œåŒ…æ‹·è´ç»™ç”¨æˆ·è¿›ç¨‹å°±å¯ä»¥äº†ã€‚</p><p>å¦‚æœç”¨æˆ·è¿›ç¨‹æ²¡æœ‰æ­£åœ¨ç­‰å¾…è¯»å–ï¼Œæˆ–è€…å› ä¸ºå†…å­˜åŸå› æ²¡æœ‰èƒ½å¤Ÿæ‹·è´æˆåŠŸï¼Œtcp_queue_rcvé‡Œé¢è¿˜æ˜¯å°†ç½‘ç»œåŒ…æ”¾å…¥sk_receive_queueé˜Ÿåˆ—ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œtcp_rcv_nxt_updateå°†tp-&gt;rcv_nxtè®¾ç½®ä¸ºend_seqï¼Œä¹Ÿå³å½“å‰çš„ç½‘ç»œåŒ…æ¥æ”¶æˆåŠŸåï¼Œæ›´æ–°ä¸‹ä¸€ä¸ªæœŸå¾…çš„ç½‘ç»œåŒ…ã€‚</p><p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬è¿˜ä¼šåˆ¤æ–­ä¸€ä¸‹å¦ä¸€ä¸ªé˜Ÿåˆ—ï¼Œout_of_order_queueï¼Œä¹Ÿçœ‹çœ‹ä¹±åºé˜Ÿåˆ—çš„æƒ…å†µï¼Œçœ‹çœ‹ä¹±åºé˜Ÿåˆ—é‡Œé¢çš„åŒ…ï¼Œä¼šä¸ä¼šå› ä¸ºè¿™ä¸ªæ–°çš„ç½‘ç»œåŒ…çš„åˆ°æ¥ï¼Œä¹Ÿèƒ½æ”¾å…¥åˆ°sk_receive_queueé˜Ÿåˆ—ä¸­ã€‚</p><p>ä¾‹å¦‚ï¼Œå®¢æˆ·ç«¯å‘é€çš„ç½‘ç»œåŒ…åºå·ä¸º5ã€6ã€7ã€8ã€9ã€‚åœ¨5è¿˜æ²¡æœ‰åˆ°è¾¾çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯çš„rcv_nxtåº”è¯¥æ˜¯5ï¼Œä¹Ÿå³æœŸæœ›ä¸‹ä¸€ä¸ªç½‘ç»œåŒ…æ˜¯5ã€‚ä½†æ˜¯ç”±äºä¸­é—´ç½‘ç»œé€šè·¯çš„é—®é¢˜ï¼Œ5ã€6è¿˜æ²¡åˆ°è¾¾æœåŠ¡ç«¯ï¼Œ7ã€8å·²ç»åˆ°è¾¾äº†æœåŠ¡ç«¯äº†ï¼Œè¿™å°±å‡ºç°äº†ä¹±åºã€‚</p><p>ä¹±åºçš„åŒ…ä¸èƒ½è¿›å…¥sk_receive_queueé˜Ÿåˆ—ã€‚å› ä¸ºä¸€æ—¦è¿›å…¥åˆ°è¿™ä¸ªé˜Ÿåˆ—ï¼Œæ„å‘³ç€å¯ä»¥å‘é€ç»™ç”¨æˆ·è¿›ç¨‹ã€‚ç„¶è€Œï¼ŒæŒ‰ç…§TCPçš„å®šä¹‰ï¼Œç”¨æˆ·è¿›ç¨‹åº”è¯¥æ˜¯æŒ‰é¡ºåºæ”¶åˆ°åŒ…çš„ï¼Œæ²¡æœ‰æ’å¥½åºï¼Œå°±ä¸èƒ½ç»™ç”¨æˆ·è¿›ç¨‹ã€‚æ‰€ä»¥ï¼Œ7ã€8ä¸èƒ½è¿›å…¥sk_receive_queueé˜Ÿåˆ—ï¼Œåªèƒ½æš‚æ—¶æ”¾åœ¨out_of_order_queueä¹±åºé˜Ÿåˆ—ä¸­ã€‚</p><p>å½“5ã€6åˆ°è¾¾çš„æ—¶å€™ï¼Œ5ã€6å…ˆè¿›å…¥sk_receive_queueé˜Ÿåˆ—ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†æ¥çœ‹out_of_order_queueä¹±åºé˜Ÿåˆ—ä¸­çš„7ã€8ï¼Œå‘ç°èƒ½å¤Ÿæ¥ä¸Šã€‚äºæ˜¯ï¼Œ7ã€8ä¹Ÿèƒ½è¿›å…¥sk_receive_queueé˜Ÿåˆ—äº†ã€‚tcp_ofo_queueå‡½æ•°å°±æ˜¯åšè¿™ä¸ªäº‹æƒ…çš„ã€‚</p><p>è‡³æ­¤ç¬¬ä¸€ç§æƒ…å†µå¤„ç†å®Œæ¯•ã€‚</p><p>ç¬¬äºŒç§æƒ…å†µï¼Œend_seqä¸å¤§äºrcv_nxtï¼Œä¹Ÿå³æœåŠ¡ç«¯æœŸæœ›ç½‘ç»œåŒ…5ã€‚ä½†æ˜¯ï¼Œæ¥äº†ä¸€ä¸ªç½‘ç»œåŒ…3ï¼Œæ€æ ·æ‰ä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿè‚¯å®šæ˜¯æœåŠ¡ç«¯æ—©å°±æ”¶åˆ°äº†ç½‘ç»œåŒ…3ï¼Œä½†æ˜¯ACKæ²¡æœ‰åˆ°è¾¾å®¢æˆ·ç«¯ï¼Œä¸­é€”ä¸¢äº†ï¼Œé‚£å®¢æˆ·ç«¯å°±è®¤ä¸ºç½‘ç»œåŒ…3æ²¡æœ‰å‘é€æˆåŠŸï¼Œäºæ˜¯åˆå‘é€äº†ä¸€éï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œè¦èµ¶ç´§ç»™å®¢æˆ·ç«¯å†å‘é€ä¸€æ¬¡ACKï¼Œè¡¨ç¤ºæ—©å°±æ”¶åˆ°äº†ã€‚</p><p>ç¬¬ä¸‰ç§æƒ…å†µï¼Œseqä¸å°äºrcv_nxt + tcp_receive_windowã€‚è¿™è¯´æ˜å®¢æˆ·ç«¯å‘é€å¾—å¤ªçŒ›äº†ã€‚æœ¬æ¥seqè‚¯å®šåº”è¯¥åœ¨æ¥æ”¶çª—å£é‡Œé¢çš„ï¼Œè¿™æ ·æœåŠ¡ç«¯æ‰æ¥å¾—åŠå¤„ç†ï¼Œç»“æœç°åœ¨è¶…å‡ºäº†æ¥æ”¶çª—å£ï¼Œè¯´æ˜å®¢æˆ·ç«¯ä¸€ä¸‹å­æŠŠæœåŠ¡ç«¯ç»™å¡æ»¡äº†ã€‚</p><p>è¿™ç§æƒ…å†µä¸‹ï¼ŒæœåŠ¡ç«¯ä¸èƒ½å†æ¥æ”¶æ•°æ®åŒ…äº†ï¼Œåªèƒ½å‘é€ACKäº†ï¼Œåœ¨ACKä¸­ä¼šå°†æ¥æ”¶çª—å£ä¸º0çš„æƒ…å†µå‘ŠçŸ¥å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å°±çŸ¥é“ä¸èƒ½å†å‘é€äº†ã€‚è¿™ä¸ªæ—¶å€™åŒæ–¹åªèƒ½äº¤äº’çª—å£æ¢æµ‹æ•°æ®åŒ…ï¼Œç›´åˆ°æœåŠ¡ç«¯å› ä¸ºç”¨æˆ·è¿›ç¨‹æŠŠæ•°æ®è¯»èµ°äº†ï¼Œç©ºå‡ºæ¥æ”¶çª—å£ï¼Œæ‰èƒ½åœ¨ACKé‡Œé¢å†æ¬¡å‘Šè¯‰å®¢æˆ·ç«¯ï¼Œåˆæœ‰çª—å£äº†ï¼Œåˆèƒ½å‘é€æ•°æ®åŒ…äº†ã€‚</p><p>ç¬¬å››ç§æƒ…å†µï¼Œseqå°äºrcv_nxtï¼Œä½†æ˜¯end_seqå¤§äºrcv_nxtï¼Œè¿™è¯´æ˜ä»seqåˆ°rcv_nxtè¿™éƒ¨åˆ†ç½‘ç»œåŒ…åŸæ¥çš„ACKå®¢æˆ·ç«¯æ²¡æœ‰æ”¶åˆ°ï¼Œæ‰€ä»¥é‡æ–°å‘é€äº†ä¸€æ¬¡ï¼Œä»rcv_nxtåˆ°end_seqæ—¶æ–°å‘é€çš„ï¼Œå¯ä»¥æ”¾å…¥sk_receive_queueé˜Ÿåˆ—ã€‚</p><p>å½“å‰å››ç§æƒ…å†µéƒ½æ’é™¤æ‰äº†ï¼Œè¯´æ˜ç½‘ç»œåŒ…ä¸€å®šæ˜¯ä¸€ä¸ªä¹±åºåŒ…äº†ã€‚è¿™é‡Œæœ‰ç‚¹å„¿éš¾ç†è§£ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç”¨ä¸Šé¢é‚£ä¸ªä¹±åºçš„ä¾‹å­ä»”ç»†åˆ†æä¸€ä¸‹rcv_nxt=5ã€‚</p><p>æˆ‘ä»¬å‡è®¾tcp_receive_windowä¹Ÿæ˜¯5ï¼Œä¹Ÿå³è¶…è¿‡10æœåŠ¡ç«¯å°±æ¥æ”¶ä¸äº†äº†ã€‚å½“å‰æ¥çš„è¿™ä¸ªç½‘ç»œåŒ…æ—¢ä¸åœ¨rcv_nxtä¹‹å‰ï¼ˆä¸æ˜¯3è¿™ç§ï¼‰ï¼Œä¹Ÿä¸åœ¨rcv_nxt + tcp_receive_windowä¹‹åï¼ˆä¸æ˜¯11è¿™ç§ï¼‰ï¼Œè¯´æ˜è¿™æ­£åœ¨æˆ‘ä»¬æœŸæœ›çš„æ¥æ”¶çª—å£é‡Œé¢ï¼Œä½†æ˜¯åˆä¸æ˜¯rcv_nxtï¼ˆä¸æ˜¯æˆ‘ä»¬é©¬ä¸ŠæœŸæœ›çš„ç½‘ç»œåŒ…5ï¼‰ï¼Œè¿™æ­£æ˜¯ä¸Šé¢çš„ä¾‹å­ä¸­ç½‘ç»œåŒ…7ã€8çš„æƒ…å†µã€‚</p><p>å¯¹äºç½‘ç»œåŒ…7ã€8ï¼Œæˆ‘ä»¬åªå¥½è°ƒç”¨tcp_data_queue_ofoè¿›å…¥out_of_order_queueä¹±åºé˜Ÿåˆ—ï¼Œä½†æ˜¯æ²¡æœ‰å…³ç³»ï¼Œå½“ç½‘ç»œåŒ…5ã€6åˆ°æ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šèµ°ç¬¬ä¸€ç§æƒ…å†µï¼ŒæŠŠ7ã€8æ‹¿å‡ºæ¥æ”¾åˆ°sk_receive_queueé˜Ÿåˆ—ä¸­ã€‚</p><p>è‡³æ­¤ï¼Œç½‘ç»œåè®®æ ˆçš„å¤„ç†è¿‡ç¨‹å°±ç»“æŸäº†ã€‚</p><h2>Socketå±‚</h2><p>å½“æ¥æ”¶çš„ç½‘ç»œåŒ…è¿›å…¥å„ç§é˜Ÿåˆ—ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦ç­‰å¾…ç”¨æˆ·è¿›ç¨‹å»è¯»å–å®ƒä»¬äº†ã€‚</p><p>è¯»å–ä¸€ä¸ªsocketï¼Œå°±åƒè¯»å–ä¸€ä¸ªæ–‡ä»¶ä¸€æ ·ï¼Œè¯»å–socketçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé€šè¿‡readç³»ç»Ÿè°ƒç”¨ã€‚</p><p>readç³»ç»Ÿè°ƒç”¨å¯¹äºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œï¼Œå¤§è‡´è¿‡ç¨‹éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œåœ¨æ–‡ä»¶ç³»ç»Ÿé‚£ä¸€èŠ‚ï¼Œæˆ‘ä»¬å·²ç»è¯¦ç»†è§£æè¿‡ã€‚æœ€ç»ˆå®ƒä¼šè°ƒç”¨åˆ°ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªæ‰“å¼€æ–‡ä»¶çš„ç»“æ„stuct fileæŒ‡å‘çš„file_operationsæ“ä½œã€‚</p><p>å¯¹äºsocketæ¥è®²ï¼Œå®ƒçš„file_operationså®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code>static const struct file_operations socket_file_ops = {
	.owner =	THIS_MODULE,
	.llseek =	no_llseek,
	.read_iter =	sock_read_iter,
	.write_iter =	sock_write_iter,
	.poll =		sock_poll,
	.unlocked_ioctl = sock_ioctl,
	.mmap =		sock_mmap,
	.release =	sock_close,
	.fasync =	sock_fasync,
	.sendpage =	sock_sendpage,
	.splice_write = generic_splice_sendpage,
	.splice_read =	sock_splice_read,
};
</code></pre><p>æŒ‰ç…§æ–‡ä»¶ç³»ç»Ÿçš„è¯»å–æµç¨‹ï¼Œè°ƒç”¨çš„æ˜¯sock_read_iterã€‚</p><pre><code>static ssize_t sock_read_iter(struct kiocb *iocb, struct iov_iter *to)
{
	struct file *file = iocb-&gt;ki_filp;
	struct socket *sock = file-&gt;private_data;
	struct msghdr msg = {.msg_iter = *to,
			     .msg_iocb = iocb};
	ssize_t res;

	if (file-&gt;f_flags &amp; O_NONBLOCK)
		msg.msg_flags = MSG_DONTWAIT;
......
	res = sock_recvmsg(sock, &amp;msg, msg.msg_flags);
	*to = msg.msg_iter;
	return res;
}
</code></pre><p>åœ¨sock_read_iterä¸­ï¼Œé€šè¿‡VFSä¸­çš„struct fileï¼Œå°†åˆ›å»ºå¥½çš„socketç»“æ„æ‹¿å‡ºæ¥ï¼Œç„¶åè°ƒç”¨sock_recvmsgï¼Œsock_recvmsgä¼šè°ƒç”¨sock_recvmsg_nosecã€‚</p><pre><code>static inline int sock_recvmsg_nosec(struct socket *sock, struct msghdr *msg, int flags)
{
	return sock-&gt;ops-&gt;recvmsg(sock, msg, msg_data_left(msg), flags);
}
</code></pre><p>è¿™é‡Œè°ƒç”¨äº†socketçš„opsçš„recvmsgï¼Œè¿™ä¸ªæˆ‘ä»¬é‡åˆ°å¥½å‡ æ¬¡äº†ã€‚æ ¹æ®inet_stream_opsçš„å®šä¹‰ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯inet_recvmsgã€‚</p><pre><code>int inet_recvmsg(struct socket *sock, struct msghdr *msg, size_t size,
		 int flags)
{
	struct sock *sk = sock-&gt;sk;
	int addr_len = 0;
	int err;
......
	err = sk-&gt;sk_prot-&gt;recvmsg(sk, msg, size, flags &amp; MSG_DONTWAIT,
				   flags &amp; ~MSG_DONTWAIT, &amp;addr_len);
......
}
</code></pre><p>è¿™é‡Œé¢ï¼Œä»socketç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°æ›´åº•å±‚çš„sockç»“æ„ï¼Œç„¶åè°ƒç”¨sk_protçš„recvmsgæ–¹æ³•ã€‚è¿™ä¸ªåŒæ ·é‡åˆ°å¥½å‡ æ¬¡äº†ï¼Œæ ¹æ®tcp_protçš„å®šä¹‰ï¼Œè°ƒç”¨çš„æ˜¯tcp_recvmsgã€‚</p><pre><code>int tcp_recvmsg(struct sock *sk, struct msghdr *msg, size_t len, int nonblock,
		int flags, int *addr_len)
{
	struct tcp_sock *tp = tcp_sk(sk);
	int copied = 0;
	u32 peek_seq;
	u32 *seq;
	unsigned long used;
	int err;
	int target;		/* Read at least this many bytes */
	long timeo;
	struct task_struct *user_recv = NULL;
	struct sk_buff *skb, *last;
.....
	do {
		u32 offset;
......
		/* Next get a buffer. */
		last = skb_peek_tail(&amp;sk-&gt;sk_receive_queue);
		skb_queue_walk(&amp;sk-&gt;sk_receive_queue, skb) {
			last = skb;
			offset = *seq - TCP_SKB_CB(skb)-&gt;seq;
			if (offset &lt; skb-&gt;len)
				goto found_ok_skb;
......
		}
......
		if (!sysctl_tcp_low_latency &amp;&amp; tp-&gt;ucopy.task == user_recv) {
			/* Install new reader */
			if (!user_recv &amp;&amp; !(flags &amp; (MSG_TRUNC | MSG_PEEK))) {
				user_recv = current;
				tp-&gt;ucopy.task = user_recv;
				tp-&gt;ucopy.msg = msg;
			}

			tp-&gt;ucopy.len = len;
			/* Look: we have the following (pseudo)queues:
			 *
			 * 1. packets in flight
			 * 2. backlog
			 * 3. prequeue
			 * 4. receive_queue
			 *
			 * Each queue can be processed only if the next ones
			 * are empty. 
			 */
			if (!skb_queue_empty(&amp;tp-&gt;ucopy.prequeue))
				goto do_prequeue;
		}

		if (copied &gt;= target) {
			/* Do not sleep, just process backlog. */
			release_sock(sk);
			lock_sock(sk);
		} else {
			sk_wait_data(sk, &amp;timeo, last);
		}

		if (user_recv) {
			int chunk;
			chunk = len - tp-&gt;ucopy.len;
			if (chunk != 0) {
				len -= chunk;
				copied += chunk;
			}

			if (tp-&gt;rcv_nxt == tp-&gt;copied_seq &amp;&amp;
			    !skb_queue_empty(&amp;tp-&gt;ucopy.prequeue)) {
do_prequeue:
				tcp_prequeue_process(sk);

				chunk = len - tp-&gt;ucopy.len;
				if (chunk != 0) {
					len -= chunk;
					copied += chunk;
				}
			}
		}
		continue;
	found_ok_skb:
		/* Ok so how much can we use? */
		used = skb-&gt;len - offset;
		if (len &lt; used)
			used = len;

		if (!(flags &amp; MSG_TRUNC)) {
			err = skb_copy_datagram_msg(skb, offset, msg, used);
......
		}

		*seq += used;
		copied += used;
		len -= used;

		tcp_rcv_space_adjust(sk);
......
	} while (len &gt; 0);
......
}
</code></pre><p>tcp_recvmsgè¿™ä¸ªå‡½æ•°æ¯”è¾ƒé•¿ï¼Œé‡Œé¢é€»è¾‘ä¹Ÿå¾ˆå¤æ‚ï¼Œå¥½åœ¨é‡Œé¢æœ‰ä¸€æ®µæ³¨é‡Šæ¦‚æ‹¬äº†è¿™é‡Œé¢çš„é€»è¾‘ã€‚æ³¨é‡Šé‡Œé¢æåˆ°äº†ä¸‰ä¸ªé˜Ÿåˆ—ï¼Œreceive_queueé˜Ÿåˆ—ã€prequeueé˜Ÿåˆ—å’Œbacklogé˜Ÿåˆ—ã€‚è¿™é‡Œé¢ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå‰ä¸€ä¸ªé˜Ÿåˆ—å¤„ç†å®Œæ¯•ï¼Œæ‰å¤„ç†åä¸€ä¸ªé˜Ÿåˆ—ã€‚</p><p>tcp_recvmsgçš„æ•´ä¸ªé€»è¾‘ä¹Ÿæ˜¯è¿™æ ·æ‰§è¡Œçš„ï¼šè¿™é‡Œé¢æœ‰ä¸€ä¸ªwhileå¾ªç¯ï¼Œä¸æ–­åœ°è¯»å–ç½‘ç»œåŒ…ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘ä»¬ä¼šå…ˆå¤„ç†sk_receive_queueé˜Ÿåˆ—ã€‚å¦‚æœæ‰¾åˆ°äº†ç½‘ç»œåŒ…ï¼Œå°±è·³åˆ°found_ok_skbè¿™é‡Œã€‚è¿™é‡Œä¼šè°ƒç”¨skb_copy_datagram_msgï¼Œå°†ç½‘ç»œåŒ…æ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹ä¸­ï¼Œç„¶åç›´æ¥è¿›å…¥ä¸‹ä¸€å±‚å¾ªç¯ã€‚</p><p>ç›´åˆ°sk_receive_queueé˜Ÿåˆ—å¤„ç†å®Œæ¯•ï¼Œæˆ‘ä»¬æ‰åˆ°äº†sysctl_tcp_low_latencyåˆ¤æ–­ã€‚å¦‚æœä¸éœ€è¦ä½æ—¶å»¶ï¼Œåˆ™ä¼šæœ‰prequeueé˜Ÿåˆ—ã€‚äºæ˜¯ï¼Œæˆ‘ä»¬èƒ½å°±è·³åˆ°do_prequeueè¿™é‡Œï¼Œè°ƒç”¨tcp_prequeue_processè¿›è¡Œå¤„ç†ã€‚</p><p>å¦‚æœsysctl_tcp_low_latencyè®¾ç½®ä¸º1ï¼Œä¹Ÿå³æ²¡æœ‰prequeueé˜Ÿåˆ—ï¼Œæˆ–è€…prequeueé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™éœ€è¦å¤„ç†backlogé˜Ÿåˆ—ï¼Œåœ¨release_sockå‡½æ•°ä¸­å¤„ç†ã€‚</p><p>release_sockä¼šè°ƒç”¨__release_sockï¼Œè¿™é‡Œé¢ä¼šä¾æ¬¡å¤„ç†é˜Ÿåˆ—ä¸­çš„ç½‘ç»œåŒ…ã€‚</p><pre><code>void release_sock(struct sock *sk)
{
......
	if (sk-&gt;sk_backlog.tail)
		__release_sock(sk);
......
}

static void __release_sock(struct sock *sk)
	__releases(&amp;sk-&gt;sk_lock.slock)
	__acquires(&amp;sk-&gt;sk_lock.slock)
{
	struct sk_buff *skb, *next;

	while ((skb = sk-&gt;sk_backlog.head) != NULL) {
		sk-&gt;sk_backlog.head = sk-&gt;sk_backlog.tail = NULL;
		do {
			next = skb-&gt;next;
			prefetch(next);
			skb-&gt;next = NULL;
			sk_backlog_rcv(sk, skb);
			cond_resched();
			skb = next;
		} while (skb != NULL);
	}
......
}
</code></pre><p>æœ€åï¼Œå“ªé‡Œéƒ½æ²¡æœ‰ç½‘ç»œåŒ…ï¼Œæˆ‘ä»¬åªå¥½è°ƒç”¨sk_wait_dataï¼Œç»§ç»­ç­‰å¾…åœ¨å“ªé‡Œï¼Œç­‰å¾…ç½‘ç»œåŒ…çš„åˆ°æ¥ã€‚</p><p>è‡³æ­¤ï¼Œç½‘ç»œåŒ…çš„æ¥æ”¶è¿‡ç¨‹åˆ°æ­¤ç»“æŸã€‚</p><h2>æ€»ç»“æ—¶åˆ»</h2><p>è¿™ä¸€èŠ‚æˆ‘ä»¬è®²å®Œäº†æ¥æ”¶ç½‘ç»œåŒ…ï¼Œæˆ‘ä»¬æ¥ä»å¤´ä¸²ä¸€ä¸‹ï¼Œæ•´ä¸ªè¿‡ç¨‹å¯ä»¥åˆ†æˆä»¥ä¸‹å‡ ä¸ªå±‚æ¬¡ã€‚</p><ul>
<li>ç¡¬ä»¶ç½‘å¡æ¥æ”¶åˆ°ç½‘ç»œåŒ…ä¹‹åï¼Œé€šè¿‡DMAæŠ€æœ¯ï¼Œå°†ç½‘ç»œåŒ…æ”¾å…¥Ring Bufferï¼›</li>
<li>ç¡¬ä»¶ç½‘å¡é€šè¿‡ä¸­æ–­é€šçŸ¥CPUæ–°çš„ç½‘ç»œåŒ…çš„åˆ°æ¥ï¼›</li>
<li>ç½‘å¡é©±åŠ¨ç¨‹åºä¼šæ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°ixgb_intrï¼›</li>
<li>ä¸­æ–­å¤„ç†å‡½æ•°å¤„ç†å®Œéœ€è¦æš‚æ—¶å±è”½ä¸­æ–­çš„æ ¸å¿ƒæµç¨‹ä¹‹åï¼Œé€šè¿‡è½¯ä¸­æ–­NET_RX_SOFTIRQè§¦å‘æ¥ä¸‹æ¥çš„å¤„ç†è¿‡ç¨‹ï¼›</li>
<li>NET_RX_SOFTIRQè½¯ä¸­æ–­å¤„ç†å‡½æ•°net_rx_actionï¼Œnet_rx_actionä¼šè°ƒç”¨napi_pollï¼Œè¿›è€Œè°ƒç”¨ixgb_clean_rx_irqï¼Œä»Ring Bufferä¸­è¯»å–æ•°æ®åˆ°å†…æ ¸struct sk_buffï¼›</li>
<li>è°ƒç”¨netif_receive_skbè¿›å…¥å†…æ ¸ç½‘ç»œåè®®æ ˆï¼Œè¿›è¡Œä¸€äº›å…³äºVLANçš„äºŒå±‚é€»è¾‘å¤„ç†åï¼Œè°ƒç”¨ip_rcvè¿›å…¥ä¸‰å±‚IPå±‚ï¼›</li>
<li>åœ¨IPå±‚ï¼Œä¼šå¤„ç†iptablesè§„åˆ™ï¼Œç„¶åè°ƒç”¨ip_local_deliveräº¤ç»™æ›´ä¸Šå±‚TCPå±‚ï¼›</li>
<li>åœ¨TCPå±‚è°ƒç”¨tcp_v4_rcvï¼Œè¿™é‡Œé¢æœ‰ä¸‰ä¸ªé˜Ÿåˆ—éœ€è¦å¤„ç†ï¼Œå¦‚æœå½“å‰çš„Socketä¸æ˜¯æ­£åœ¨è¢«è¯»ï¼›å–ï¼Œåˆ™æ”¾å…¥backlogé˜Ÿåˆ—ï¼Œå¦‚æœæ­£åœ¨è¢«è¯»å–ï¼Œä¸éœ€è¦å¾ˆå®æ—¶çš„è¯ï¼Œåˆ™æ”¾å…¥prequeueé˜Ÿåˆ—ï¼Œå…¶ä»–æƒ…å†µè°ƒç”¨tcp_v4_do_rcvï¼›</li>
<li>åœ¨tcp_v4_do_rcvä¸­ï¼Œå¦‚æœæ˜¯å¤„äºTCP_ESTABLISHEDçŠ¶æ€ï¼Œè°ƒç”¨tcp_rcv_establishedï¼Œå…¶ä»–çš„çŠ¶æ€ï¼Œè°ƒç”¨tcp_rcv_state_processï¼›</li>
<li>åœ¨tcp_rcv_establishedä¸­ï¼Œè°ƒç”¨tcp_data_queueï¼Œå¦‚æœåºåˆ—å·èƒ½å¤Ÿæ¥çš„ä¸Šï¼Œåˆ™æ”¾å…¥sk_receive_queueé˜Ÿåˆ—ï¼›å¦‚æœåºåˆ—å·æ¥ä¸ä¸Šï¼Œåˆ™æš‚æ—¶æ”¾å…¥out_of_order_queueé˜Ÿåˆ—ï¼Œç­‰åºåˆ—å·èƒ½å¤Ÿæ¥ä¸Šçš„æ—¶å€™ï¼Œå†æ”¾å…¥sk_receive_queueé˜Ÿåˆ—ã€‚</li>
</ul><p>è‡³æ­¤å†…æ ¸æ¥æ”¶ç½‘ç»œåŒ…çš„è¿‡ç¨‹åˆ°æ­¤ç»“æŸï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç”¨æˆ·æ€è¯»å–ç½‘ç»œåŒ…çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹åˆ†æˆå‡ ä¸ªå±‚æ¬¡ã€‚</p><ul>
<li>VFSå±‚ï¼šreadç³»ç»Ÿè°ƒç”¨æ‰¾åˆ°struct fileï¼Œæ ¹æ®é‡Œé¢çš„file_operationsçš„å®šä¹‰ï¼Œè°ƒç”¨sock_read_iterå‡½æ•°ã€‚sock_read_iterå‡½æ•°è°ƒç”¨sock_recvmsgå‡½æ•°ã€‚</li>
<li>Socketå±‚ï¼šä»struct fileé‡Œé¢çš„private_dataå¾—åˆ°struct socketï¼Œæ ¹æ®é‡Œé¢opsçš„å®šä¹‰ï¼Œè°ƒç”¨inet_recvmsgå‡½æ•°ã€‚</li>
<li>Sockå±‚ï¼šä»struct socketé‡Œé¢çš„skå¾—åˆ°struct sockï¼Œæ ¹æ®é‡Œé¢sk_protçš„å®šä¹‰ï¼Œè°ƒç”¨tcp_recvmsgå‡½æ•°ã€‚</li>
<li>TCPå±‚ï¼štcp_recvmsgå‡½æ•°ä¼šä¾æ¬¡è¯»å–receive_queueé˜Ÿåˆ—ã€prequeueé˜Ÿåˆ—å’Œbacklogé˜Ÿåˆ—ã€‚</li>
</ul><p><img src="https://static001.geekbang.org/resource/image/20/52/20df32a842495d0f629ca5da53e47152.png?wh=3865*5080" alt=""></p><h2>è¯¾å ‚ç»ƒä¹ </h2><p>å¯¹äºTCPåè®®ã€ä¸‰æ¬¡æ¡æ‰‹ã€å‘é€å’Œæ¥æ”¶çš„è¿æ¥ç»´æŠ¤ã€æ‹¥å¡æ§åˆ¶ã€æ»‘åŠ¨çª—å£ï¼Œæˆ‘ä»¬éƒ½è§£æè¿‡äº†ã€‚å”¯ç‹¬å››æ¬¡æŒ¥æ‰‹æˆ‘ä»¬æ²¡æœ‰è§£æï¼Œå¯¹åº”çš„ä»£ç ä½ åº”è¯¥çŸ¥é“åœ¨ä»€ä¹ˆåœ°æ–¹äº†ï¼Œä½ å¯ä»¥è‡ªå·±è¯•ç€è§£æä¸€ä¸‹å››æ¬¡æŒ¥æ‰‹çš„è¿‡ç¨‹ã€‚</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„ç–‘æƒ‘å’Œè§è§£ ï¼Œä¹Ÿæ¬¢è¿å¯ä»¥æ”¶è—æœ¬èŠ‚å†…å®¹ï¼Œåå¤ç ”è¯»ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·å­¦ä¹ å’Œè¿›æ­¥ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/8c/37/8c0a95fa07a8b9a1abfd394479bdd637.jpg?wh=1110*659" alt=""></p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epZhOmpZpicOzalVU7kibd59dMJc25N9cfGu9icBAIUPzYNYDedtzlYHZBiazaYiadgqvlotrjM4CA6KOQ/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_ty</span>
  </div>
  <div class="_2_QraFYR_0">è¿™é‡Œè¯´ä¸€ä¸‹ï¼Œåœ¨17å¹´åçš„Linuxç‰ˆæœ¬ä¸­å·²ç»å–æ¶ˆäº†prequeueä»¥åŠç›¸å…³çš„æ“ä½œï¼Œå¦‚æœé˜…è¯»è¾ƒæ–°çš„Linuxå†…æ ¸çš„åŒå­¦ä»¬è¯·ä¸è¦è¯¯è§£ã€‚ç°åœ¨åªå‰©2ä¸ªé˜Ÿåˆ—äº†ã€‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-08-15 22:20:06</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/bf/aa/abb7bfe3.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å…è´¹çš„äºº</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆæœ‰è®¡åˆ’è®²epollçš„å®ç°å—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: è®²ä¸äº†äº†ï¼Œè¦ä¸è¿™ä¸ªä¸“æ å°±å¤ªé•¿äº†ã€‚åœ¨ç½‘ç»œåè®®é‡Œé¢å¤§è‡´è®²äº†ä¸€ä¸‹epollçš„å†…æ ¸å®ç°ï¼Œä½†æ˜¯åˆ†æçš„ä¸ç»†</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-07-17 09:47:01</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/bf/aa/abb7bfe3.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å…è´¹çš„äºº</span>
  </div>
  <div class="_2_QraFYR_0">ä»kernel docé‡Œå‘ç°è¿™ä¸ªè¯´æ˜ï¼š<br>tcp_low_latency - BOOLEAN<br>	This is a legacy option, it has no effect anymore.<br><br>è¿™ä¸ªé€‰é¡¹æ²¡ç”¨äº†ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: 4.13é‡Œé¢æ˜¯tcp_low_latency - BOOLEAN<br>        If set, the TCP stack makes decisions that prefer lower<br>        latency as opposed to higher throughput.  By default, this<br>        option is not set meaning that higher throughput is preferred.<br>        An example of an application where this default should be<br>        changed would be a Beowulf compute cluster.<br>        Default: 0<br><br>5.0é‡Œé¢å°±æ˜¯<br><br>cp_low_latency - BOOLEAN<br>	This is a legacy option, it has no effect anymore.</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-07-17 10:39:12</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/ae/0c/f39f847a.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>D</span>
  </div>
  <div class="_2_QraFYR_0">è¿™ä¸ª out_of_order_queue æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œ å‡å¦‚5ï¼Œ6å·²ç»“åˆ°äº†ï¼Œä¸‹ä¸ªæœŸå¾…7ï¼Œ8ï¼Œä½†æ˜¯ä»é˜Ÿå¤´æ‹¿å‡ºçš„æ˜¯9ï¼Œ10ï¼Œæ€ä¹ˆåŠï¼Œé‡æ–°å…¥é˜Ÿå—ï¼Œè¿™æ ·æ•ˆç‡æœ‰ç‚¹ä½å§ï¼Œè€å¸ˆèƒ½è®²è®²å—</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: çº¢é»‘æ ‘ï¼Œå¯ä»¥å…ˆåˆ¤æ–­ä¸€æŠŠå†æ‹¿</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-07-17 15:27:49</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/1d/05/b2/93b64021.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_jikuo</span>
  </div>
  <div class="_2_QraFYR_0">é—®é¢˜ï¼šä¸‰å±‚ä¸Šé€å››å±‚çš„æ—¶å€™ï¼Œæ•°æ®åŒ…æ˜¯æ€æ ·çŸ¥é“è‡ªå·±å±äºå“ªä¸ªsockçš„ï¼Ÿ<br>ç­”ï¼štcp_v4_rcv()  -&gt; __inet_lookup_skb<br>æ ¹æ®æ•°æ®åŒ…çš„ip+ç«¯å£ä»tcp_hashinfoä¸­æ‰¾åˆ°ï¼Œä¼šæœ‰ä¸¤ä¸ªhashè¡¨ï¼šlistening_hashå’Œestablish_hashå“ˆå¸Œè¡¨<br>(æ³¨ï¼šå‚è€ƒæ–‡ä¸­ä¸€æ¡ç¬”è®°)</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-21 07:34:30</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/b9/af/f59b4c7c.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æ·±æµ·æå…‰</span>
  </div>
  <div class="_2_QraFYR_0">è¯·é—®ä¸‹è€å¸ˆï¼Œæ˜¯linuxåè®®æ ˆé€šè¿‡tcpè§£æå®Œæˆï¼Œæ”¾å…¥åˆ°receive queueæˆ–è€…backlog queue å†å»å”¤é†’ç”¨æˆ·è¿›ç¨‹æ¥è¯»çš„å—ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯epollè¯»ï¼Œè€Œepollæ˜¯æ ¹æ®äº‹ä»¶å˜åŒ–çš„ï¼Œä¹Ÿæ˜¯åœ¨fdçš„ç­‰å¾…é˜Ÿåˆ—ä¸Šç¡çœ ï¼Œå°±æ˜¯è¿™ä¸€æ­¥æ˜¯æ€ä¹ˆå…³è”çš„</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-04-11 23:00:53</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/e1/0e/dde741d7.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å°é©¬</span>
  </div>
  <div class="_2_QraFYR_0">å¤§ä½¬ä½ ç”¨çš„linux å†…æ ¸æ˜¯å“ªä¸ªç‰ˆæœ¬ï¼Œä»¥åŠç”¨ä»€ä¹ˆå·¥å…·æŸ¥çœ‹æºç çš„ï¼Ÿæˆ‘ç”¨çš„æ˜¯ source insight</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-12-31 18:29:45</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/16/97/ba/b5b56c25.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>caryr</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆæ‚¨å¥½ï¼Œæœ‰ä¸ªå›°æƒ‘ï¼š <br>if (!sock_owned_by_user(sk)) {    if (!tcp_prequeue(sk, skb))      ret = tcp_v4_do_rcv(sk, skb);  } <br>else if (tcp_add_backlog(sk, skb)) {    goto discard_and_relse;  }<br>è¿™ä»£ç ä¸æ˜¯ sockå±äºæˆ‘çš„æ—¶å€™æ‰§è¡Œadd_backlogå—ï¼Ÿ<br>å¯ä¸ºä»€ä¹ˆæ–‡ä¸­åˆè¯´ï¼šï¼ˆå¤§æ„ï¼šsockä¸å±äºä»»ä½•ç”¨æˆ·ï¼Œåˆ™è°ƒç”¨add_backlog ã€‚æ˜¯æˆ‘å“ªé‡Œç†è§£åå·®äº†å—ï¼Ÿï¼‰<br>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿäº†è§£ä¸Šé¢ä»£ç ä¸­ sock_owned_by_user çš„æ„æ€äº†ï¼Œå…¶å®å°±æ˜¯è¯´ï¼Œå½“å‰è¿™ä¸ª sock æ˜¯ä¸æ˜¯æ­£æœ‰ä¸€ä¸ªç”¨æˆ·æ€è¿›ç¨‹ç­‰ç€è¯»æ•°æ®å‘¢ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†…æ ¸åè®®æ ˆä¹Ÿè°ƒç”¨ tcp_add_backlogï¼Œæš‚å­˜åœ¨ backlog é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”æŠ“ç´§ç¦»å¼€è½¯ä¸­æ–­çš„å¤„ç†è¿‡ç¨‹ã€‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-11-04 04:18:36</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src=""
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å–åå­—å¥½éº»çƒ¦</span>
  </div>
  <div class="_2_QraFYR_0">å¤§æ¦‚ä¹Ÿå°±çœ‹äº†äº”å…­ä¸ƒå…«é</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: èµï¼ŒåŠ æ²¹</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-08-16 16:53:13</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/b9/af/f59b4c7c.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æ·±æµ·æå…‰</span>
  </div>
  <div class="_2_QraFYR_0">çœ‹äº†å¥½å¤šéï¼Œå¹¶ç»“åˆå…¶ä»–çš„èµ„æ–™ï¼Œæœ‰ä¸ªç–‘é—®å°±æ˜¯æ”¾å…¥backlog queueçš„æ¡ä»¶ï¼Œè€å¸ˆæ˜¯è¯´æ²¡æœ‰ç”¨æˆ·è¿›ç¨‹åœ¨ç­‰å¾…è¯»æ•°æ®ï¼Œç»¼åˆå…¶å®ƒçš„èµ„æ–™æ˜¯è¯´socketçš„é”æ˜¯å¦æ­£åœ¨è¢«å…¶å®ƒä½¿ç”¨ï¼Œå¦‚æœæ˜¯å°±æ”¾å…¥backlog queue,å› ä¸ºä¸èƒ½è®©è½¯ä¸­æ–­ç­‰ï¼Œå¦‚æœèƒ½æ‹¿åˆ°å°±æ”¾å…¥rece queue æ„Ÿè§‰è¿™æ ·æ˜¯æ›´åˆç†ï¼Œè¯·è€å¸ˆè§£ç­”</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-04-12 13:36:51</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/41/c7/3aead12b.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æ—å…ˆæ£®</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨ç½‘ç»œåŒ…æ¥æ”¶è¿‡ç¨‹ä¸­ï¼Œåœ¨å“ªä¸€ä¸ªç¯èŠ‚ç¡®è®¤åæ‰ä¼šå‘å¯¹ç«¯å‘é€ackåŒ…å•Šï¼Ÿæ˜¯ç­‰åº”ç”¨ç¨‹åºè¯»å–ä¹‹åå—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-01-12 23:55:58</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIC2Ww3swYiaMalnpA1f87xgzV8Hs1Y27M2CbNQqgR27Il72hibXn5FvhU7mbr3XKsxYDZdjY4GMDbg/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>wjh_all_in</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œprequeue é˜Ÿåˆ—å’Œ backlog é˜Ÿåˆ—éœ€è¦åšä¹±åºçš„ä¿è¯å—ï¼Ÿå¦‚æœæ²¡æœ‰ï¼Œæ€ä¹ˆä¿è¯å¯é æ€§?</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: è¦çš„ï¼Œå¦‚æœåˆ¤æ–­æ¥ä¸ä¸Šï¼Œå°±å›é€€åˆ°é»˜è®¤æµç¨‹</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-08-30 23:22:24</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/35/73/46d6dadc.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æ²¡å¿ƒæ²¡è‚º</span>
  </div>
  <div class="_2_QraFYR_0">ç»ˆäºå¿«ç»“æŸäº†ğŸ™„</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ç»ˆäº....</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-07-17 15:26:46</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>è¥¿é—¨å¹ç‰›</span>
  </div>
  <div class="_2_QraFYR_0">ä¸ºä»€ä¹ˆmmap ä¸å¯ç”¨åœ¨ç½‘ç»œIO ä¸­é¿å…ç”¨æˆ·æ€å’Œå†…æ ¸æ€æ•°æ®å¤åˆ¶çš„å¼€é”€ï¼Œè€Œæ–‡ä»¶IOå¯ä»¥</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-08-11 10:16:18</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/18/0e/40/49a71ed8.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å…«æˆ’</span>
  </div>
  <div class="_2_QraFYR_0">å‘ç°å…ˆçœ‹æ€»ç»“å†çœ‹æ–‡ç« ï¼Œæ›´æ˜“ç†è§£â€¦â€¦</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-06-03 15:46:42</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/4a/15/106eaaa8.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>stackWarn</span>
  </div>
  <div class="_2_QraFYR_0">ä½œä¸ºä¸€ä¸ªè¿ç»´ï¼Œè¿™4ç¯‡è¦å¥½å¥½ç ”è¯» å¯¹ç…§å†…æ ¸çœ‹å‡ éäº†ã€‚ åŠ æ²¹1åˆ·</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-10-14 20:54:44</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/16/83/0c/b9e39db4.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>éŸ©ä¿Šè‡£</span>
  </div>
  <div class="_2_QraFYR_0">å‘ç°ï¼Œå¾—å…ˆå¯¹ç€å›¾æ¦‚è§ˆä¸€éï¼Œç„¶åå»çœ‹è°ƒç”¨é“¾ï¼Œæ‰èƒ½å‹‰å¼ºçœ‹æ‡‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-06-19 08:51:23</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/ed/b9/825b2411.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>è¡¡å­</span>
  </div>
  <div class="_2_QraFYR_0">è¿˜æ˜¯æœ‰å¾ˆå¤šç»†èŠ‚éœ€è¦æ…¢æ…¢åƒé€ï¼Œä¾‹å¦‚ï¼šclientå‘é€ä¸€èˆ¬æ–­æ‰å‘¢ï¼Ÿé˜Ÿåˆ—é‡Œé¢çš„å·²æ¥æ”¶çš„åŒ…ä¼šä¸¢å¼ƒä¹ˆï¼Ÿsocketåº”è¯¥æœ‰ç±»ä¼¼å¿ƒè·³æˆ–è€…è¯´çŠ¶æ€ç»´æŠ¤çš„æœºåˆ¶ï¼Œæ˜¯åœ¨è¶…æ—¶å…³é—­è¿æ¥çš„æ—¶å€™å»æ¸…ç†æ•°æ®ä¹ˆï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-03-21 12:37:32</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/58/66/7afd8da5.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>yew</span>
  </div>
  <div class="_2_QraFYR_0">æ•´ä¸ªæ¥æ”¶è¿‡ç¨‹ é‚£å‡ æ­¥å‘ç”Ÿå†…å­˜æ‹·è´</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-12-03 20:52:39</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLh73kPzAKhz7YxUribqF6QKFiahhVAbwpgVLSRicA68c6ZFA7vUBJY1ves3LVvibrypROyI7awv47eSA/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ZYecho</span>
  </div>
  <div class="_2_QraFYR_0">ä¸ºä»€ä¹ˆæ”¾å…¥prequeueé˜Ÿåˆ—å°±ä¼šå¯¼è‡´ä¸€ä¸ªå¤§çš„æ—¶å»¶ï¼Ÿ æ˜¯å› ä¸ºå¦‚æœä¸æ”¾å…¥çš„è¯ï¼Œå°±å¯ä»¥ç›´æ¥åœ¨è½¯ä¸­æ–­ä¸­å¤„ç†äº†ä¹ˆï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-09-19 15:27:55</div>
  </div>
</div>
</div>
</li>
</ul>