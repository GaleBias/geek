<audio title="46 _ å‘é€ç½‘ç»œåŒ…ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•è¡¨è¾¾æˆ‘ä»¬æƒ³è®©åˆä½œä¼™ä¼´åšä»€ä¹ˆï¼Ÿ" src="https://static001.geekbang.org/resource/audio/e7/99/e7ee28d7548651dffc3504e3b4e65299.mp3" controls="controls"></audio> 
<p>ä¸Šä¸€èŠ‚æˆ‘ä»¬è®²ç½‘ç»œåŒ…çš„å‘é€ï¼Œè®²äº†ä¸ŠåŠéƒ¨åˆ†ï¼Œä¹Ÿå³ä»VFSå±‚ä¸€ç›´åˆ°IPå±‚ï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬æ¥ç€çœ‹ä¸‹å»ï¼Œçœ‹IPå±‚å’ŒMACå±‚æ˜¯å¦‚ä½•å‘é€æ•°æ®çš„ã€‚</p><h2>è§£æip_queue_xmitå‡½æ•°</h2><p>ä»ip_queue_xmitå‡½æ•°å¼€å§‹ï¼Œæˆ‘ä»¬å°±è¦è¿›å…¥IPå±‚çš„å‘é€é€»è¾‘äº†ã€‚</p><pre><code>int ip_queue_xmit(struct sock *sk, struct sk_buff *skb, struct flowi *fl)
{
    struct inet_sock *inet = inet_sk(sk);
    struct net *net = sock_net(sk);
    struct ip_options_rcu *inet_opt;
    struct flowi4 *fl4;
    struct rtable *rt;
    struct iphdr *iph;
    int res;

    inet_opt = rcu_dereference(inet-&gt;inet_opt);
    fl4 = &amp;fl-&gt;u.ip4;
    rt = skb_rtable(skb);
    /* Make sure we can route this packet. */
    rt = (struct rtable *)__sk_dst_check(sk, 0);
    if (!rt) {
        __be32 daddr;
        /* Use correct destination address if we have options. */
        daddr = inet-&gt;inet_daddr;
 ......
        rt = ip_route_output_ports(net, fl4, sk,
                       daddr, inet-&gt;inet_saddr,
                       inet-&gt;inet_dport,
                       inet-&gt;inet_sport,
                       sk-&gt;sk_protocol,
                       RT_CONN_FLAGS(sk),
                       sk-&gt;sk_bound_dev_if);
        if (IS_ERR(rt))
            goto no_route;
        sk_setup_caps(sk, &amp;rt-&gt;dst);
    }
    skb_dst_set_noref(skb, &amp;rt-&gt;dst);

packet_routed:
    /* OK, we know where to send it, allocate and build IP header. */
    skb_push(skb, sizeof(struct iphdr) + (inet_opt ? inet_opt-&gt;opt.optlen : 0));
    skb_reset_network_header(skb);
    iph = ip_hdr(skb);
    *((__be16 *)iph) = htons((4 &lt;&lt; 12) | (5 &lt;&lt; 8) | (inet-&gt;tos &amp; 0xff));
    if (ip_dont_fragment(sk, &amp;rt-&gt;dst) &amp;&amp; !skb-&gt;ignore_df)
        iph-&gt;frag_off = htons(IP_DF);
    else
        iph-&gt;frag_off = 0;
    iph-&gt;ttl      = ip_select_ttl(inet, &amp;rt-&gt;dst);
    iph-&gt;protocol = sk-&gt;sk_protocol;
    ip_copy_addrs(iph, fl4);

    /* Transport layer set skb-&gt;h.foo itself. */

    if (inet_opt &amp;&amp; inet_opt-&gt;opt.optlen) {
        iph-&gt;ihl += inet_opt-&gt;opt.optlen &gt;&gt; 2;
        ip_options_build(skb, &amp;inet_opt-&gt;opt, inet-&gt;inet_daddr, rt, 0);
    }

    ip_select_ident_segs(net, skb, sk,
                 skb_shinfo(skb)-&gt;gso_segs ?: 1);

    /* TODO : should we use skb-&gt;sk here instead of sk ? */
    skb-&gt;priority = sk-&gt;sk_priority;
    skb-&gt;mark = sk-&gt;sk_mark;

    res = ip_local_out(net, sk, skb);
......
}
</code></pre><p>åœ¨ip_queue_xmitä¸­ï¼Œä¹Ÿå³IPå±‚çš„å‘é€å‡½æ•°é‡Œé¢ï¼Œæœ‰ä¸‰éƒ¨åˆ†é€»è¾‘ã€‚</p><p>ç¬¬ä¸€éƒ¨åˆ†ï¼Œé€‰å–è·¯ç”±ï¼Œä¹Ÿå³æˆ‘è¦å‘é€è¿™ä¸ªåŒ…åº”è¯¥ä»å“ªä¸ªç½‘å¡å‡ºå»ã€‚</p><p>è¿™ä»¶äº‹æƒ…ä¸»è¦ç”±ip_route_output_portså‡½æ•°å®Œæˆã€‚æ¥ä¸‹æ¥çš„è°ƒç”¨é“¾ä¸ºï¼šip_route_output_ports-&gt;ip_route_output_flow-&gt;__ip_route_output_key-&gt;ip_route_output_key_hash-&gt;ip_route_output_key_hash_rcuã€‚</p><pre><code>struct rtable *ip_route_output_key_hash_rcu(struct net *net, struct flowi4 *fl4, struct fib_result *res, const struct sk_buff *skb)
{
	struct net_device *dev_out = NULL;
	int orig_oif = fl4-&gt;flowi4_oif;
	unsigned int flags = 0;
	struct rtable *rth;
......
    err = fib_lookup(net, fl4, res, 0);
......
make_route:
	rth = __mkroute_output(res, fl4, orig_oif, dev_out, flags);
......
}
</code></pre><p>ip_route_output_key_hash_rcuå…ˆä¼šè°ƒç”¨fib_lookupã€‚</p><p><strong>FIB</strong>å…¨ç§°æ˜¯Forwarding Information Baseï¼Œ<strong>è½¬å‘ä¿¡æ¯è¡¨ã€‚</strong>å…¶å®å°±æ˜¯å’±ä»¬å¸¸è¯´çš„è·¯ç”±è¡¨ã€‚</p><pre><code>static inline int fib_lookup(struct net *net, const struct flowi4 *flp, struct fib_result *res, unsigned int flags)
{	struct fib_table *tb;
......
	tb = fib_get_table(net, RT_TABLE_MAIN);
	if (tb)
		err = fib_table_lookup(tb, flp, res, flags | FIB_LOOKUP_NOREF);
......
}

</code></pre><p>è·¯ç”±è¡¨å¯ä»¥æœ‰å¤šä¸ªï¼Œä¸€èˆ¬ä¼šæœ‰ä¸€ä¸ªä¸»è¡¨ï¼ŒRT_TABLE_MAINã€‚ç„¶åfib_table_lookupå‡½æ•°åœ¨è¿™ä¸ªè¡¨é‡Œé¢è¿›è¡ŒæŸ¥æ‰¾ã€‚</p><!-- [[[read_end]]] --><p>è·¯ç”±è¡¨æ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„ç»“æ„å‘¢ï¼Ÿ</p><p>è·¯ç”±å°±æ˜¯åœ¨LinuxæœåŠ¡å™¨ä¸Šçš„è·¯ç”±è¡¨é‡Œé¢é…ç½®çš„ä¸€æ¡ä¸€æ¡è§„åˆ™ã€‚è¿™äº›è§„åˆ™å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼šæƒ³è®¿é—®æŸä¸ªç½‘æ®µï¼Œä»æŸä¸ªç½‘å¡å‡ºå»ï¼Œä¸‹ä¸€è·³æ˜¯æŸä¸ªIPã€‚</p><p>ä¹‹å‰æˆ‘ä»¬è®²è¿‡ä¸€ä¸ªç®€å•çš„æ‹“æ‰‘å›¾ï¼Œé‡Œé¢çš„ä¸‰å°Linuxæœºå™¨çš„è·¯ç”±è¡¨éƒ½å¯ä»¥é€šè¿‡ip routeå‘½ä»¤æŸ¥çœ‹ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/f6/0e/f6982eb85dc66bd04200474efb3a050e.png?wh=3650*2255" alt=""></p><pre><code># LinuxæœåŠ¡å™¨A
default via 192.168.1.1 dev eth0
192.168.1.0/24 dev eth0 proto kernel scope link src 192.168.1.100 metric 100

# LinuxæœåŠ¡å™¨B
default via 192.168.2.1 dev eth0
192.168.2.0/24 dev eth0 proto kernel scope link src 192.168.2.100 metric 100

# LinuxæœåŠ¡å™¨åšè·¯ç”±å™¨
192.168.1.0/24 dev eth0 proto kernel scope link src 192.168.1.1  
192.168.2.0/24 dev eth1 proto kernel scope link src 192.168.2.1  
</code></pre><p>å…¶å®ï¼Œå¯¹äºä¸¤ç«¯çš„æœåŠ¡å™¨æ¥è®²ï¼Œæˆ‘ä»¬æ²¡æœ‰å¤ªå¤šè·¯ç”±å¯ä»¥é€‰ï¼Œä½†æ˜¯å¯¹äºä¸­é—´çš„LinuxæœåŠ¡å™¨åšè·¯ç”±å™¨æ¥è®²ï¼Œè¿™é‡Œæœ‰ä¸¤æ¡è·¯å¯ä»¥é€‰ï¼Œä¸€ä¸ªæ˜¯å¾€å·¦é¢è½¬å‘ï¼Œä¸€ä¸ªæ˜¯å¾€å³é¢è½¬å‘ï¼Œå°±éœ€è¦è·¯ç”±è¡¨çš„æŸ¥æ‰¾ã€‚</p><p>fib_table_lookupçš„ä»£ç é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œå¥½åœ¨æ³¨é‡Šæ¯”è¾ƒæ¸…æ¥šã€‚å› ä¸ºè·¯ç”±è¡¨è¦æŒ‰ç…§å‰ç¼€è¿›è¡ŒæŸ¥è¯¢ï¼Œå¸Œæœ›æ‰¾åˆ°æœ€é•¿åŒ¹é…çš„é‚£ä¸€ä¸ªï¼Œä¾‹å¦‚192.168.2.0/24å’Œ192.168.0.0/16éƒ½èƒ½åŒ¹é…192.168.2.100/24ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨192.168.2.0/24çš„è¿™ä¸€æ¡ã€‚</p><p>ä¸ºäº†æ›´æ–¹é¢çš„åšè¿™ä¸ªäº‹æƒ…ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Trieæ ‘è¿™ç§ç»“æ„ã€‚æ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ç³»åˆ—çš„å­—ç¬¦ä¸²ï¼š{bcs#, badge#, baby#, back#, badger#, badness#}ã€‚ä¹‹æ‰€ä»¥æ¯ä¸ªå­—ç¬¦ä¸²éƒ½åŠ ä¸Š#ï¼Œæ˜¯å¸Œæœ›ä¸è¦ä¸€ä¸ªå­—ç¬¦ä¸²æˆä¸ºå¦å¤–ä¸€ä¸ªå­—ç¬¦ä¸²çš„å‰ç¼€ã€‚ç„¶åæˆ‘ä»¬æŠŠå®ƒä»¬æ”¾åœ¨Trieæ ‘ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://static001.geekbang.org/resource/image/3f/11/3f0a99cf1c47afcd0bd740c4b7802511.png?wh=1543*2143" alt=""></p><p>å¯¹äºå°†IPåœ°å€è½¬æˆäºŒè¿›åˆ¶æ”¾å…¥trieæ ‘ï¼Œä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼Œå¯ä»¥å¾ˆå¿«è¿›è¡Œè·¯ç”±çš„æŸ¥è¯¢ã€‚</p><p>æ‰¾åˆ°äº†è·¯ç”±ï¼Œå°±çŸ¥é“äº†åº”è¯¥ä»å“ªä¸ªç½‘å¡å‘å‡ºå»ã€‚</p><p>ç„¶åï¼Œip_route_output_key_hash_rcuä¼šè°ƒç”¨__mkroute_outputï¼Œåˆ›å»ºä¸€ä¸ªstruct rtableï¼Œè¡¨ç¤ºæ‰¾åˆ°çš„è·¯ç”±è¡¨é¡¹ã€‚è¿™ä¸ªç»“æ„æ˜¯ç”±rt_dst_allocå‡½æ•°åˆ†é…çš„ã€‚</p><pre><code>struct rtable *rt_dst_alloc(struct net_device *dev,
			    unsigned int flags, u16 type,
			    bool nopolicy, bool noxfrm, bool will_cache)
{
	struct rtable *rt;

	rt = dst_alloc(&amp;ipv4_dst_ops, dev, 1, DST_OBSOLETE_FORCE_CHK,
		       (will_cache ? 0 : DST_HOST) |
		       (nopolicy ? DST_NOPOLICY : 0) |
		       (noxfrm ? DST_NOXFRM : 0));

	if (rt) {
		rt-&gt;rt_genid = rt_genid_ipv4(dev_net(dev));
		rt-&gt;rt_flags = flags;
		rt-&gt;rt_type = type;
		rt-&gt;rt_is_input = 0;
		rt-&gt;rt_iif = 0;
		rt-&gt;rt_pmtu = 0;
		rt-&gt;rt_gateway = 0;
		rt-&gt;rt_uses_gateway = 0;
		rt-&gt;rt_table_id = 0;
		INIT_LIST_HEAD(&amp;rt-&gt;rt_uncached);

		rt-&gt;dst.output = ip_output;
		if (flags &amp; RTCF_LOCAL)
			rt-&gt;dst.input = ip_local_deliver;
	}

	return rt;
}
</code></pre><p>æœ€ç»ˆè¿”å›struct rtableå®ä¾‹ï¼Œç¬¬ä¸€éƒ¨åˆ†ä¹Ÿå°±å®Œæˆäº†ã€‚</p><p>ç¬¬äºŒéƒ¨åˆ†ï¼Œå°±æ˜¯å‡†å¤‡IPå±‚çš„å¤´ï¼Œå¾€é‡Œé¢å¡«å……å†…å®¹ã€‚è¿™å°±è¦å¯¹ç€IPå±‚çš„å¤´çš„æ ¼å¼è¿›è¡Œç†è§£ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/6b/2b/6b2ea7148a8e04138a2228c5dbc7182b.png?wh=1066*1666" alt=""></p><p>åœ¨è¿™é‡Œé¢ï¼ŒæœåŠ¡ç±»å‹è®¾ç½®ä¸ºtosï¼Œæ ‡è¯†ä½é‡Œé¢è®¾ç½®æ˜¯å¦å…è®¸åˆ†ç‰‡frag_offã€‚å¦‚æœä¸å…è®¸ï¼Œè€Œé‡åˆ°MTUå¤ªå°è¿‡ä¸å»çš„æƒ…å†µï¼Œå°±å‘é€ICMPæŠ¥é”™ã€‚TTLæ˜¯è¿™ä¸ªåŒ…çš„å­˜æ´»æ—¶é—´ï¼Œä¸ºäº†é˜²æ­¢ä¸€ä¸ªIPåŒ…è¿·è·¯ä»¥åä¸€ç›´å­˜æ´»ä¸‹å»ï¼Œæ¯ç»è¿‡ä¸€ä¸ªè·¯ç”±å™¨TTLéƒ½å‡ä¸€ï¼Œå‡ä¸ºé›¶åˆ™â€œæ­»å»â€ã€‚è®¾ç½®protocolï¼ŒæŒ‡çš„æ˜¯æ›´ä¸Šå±‚çš„åè®®ï¼Œè¿™é‡Œæ˜¯TCPã€‚æºåœ°å€å’Œç›®æ ‡åœ°å€ç”±ip_copy_addrsè®¾ç½®ã€‚æœ€åï¼Œè®¾ç½®optionsã€‚</p><p>ç¬¬ä¸‰éƒ¨åˆ†ï¼Œå°±æ˜¯è°ƒç”¨ip_local_outå‘é€IPåŒ…ã€‚</p><pre><code>int ip_local_out(struct net *net, struct sock *sk, struct sk_buff *skb)
{
	int err;

	err = __ip_local_out(net, sk, skb);
	if (likely(err == 1))
		err = dst_output(net, sk, skb);

	return err;
}

int __ip_local_out(struct net *net, struct sock *sk, struct sk_buff *skb)
{
	struct iphdr *iph = ip_hdr(skb);
	iph-&gt;tot_len = htons(skb-&gt;len);
	skb-&gt;protocol = htons(ETH_P_IP);

	return nf_hook(NFPROTO_IPV4, NF_INET_LOCAL_OUT,
		       net, sk, skb, NULL, skb_dst(skb)-&gt;dev,
		       dst_output);
}
</code></pre><p>ip_local_outå…ˆæ˜¯è°ƒç”¨__ip_local_outï¼Œç„¶åé‡Œé¢è°ƒç”¨äº†nf_hookã€‚è¿™æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿnfçš„æ„æ€æ˜¯Netfilterï¼Œè¿™æ˜¯Linuxå†…æ ¸çš„ä¸€ä¸ªæœºåˆ¶ï¼Œç”¨äºåœ¨ç½‘ç»œå‘é€å’Œè½¬å‘çš„å…³é”®èŠ‚ç‚¹ä¸ŠåŠ ä¸Šhookå‡½æ•°ï¼Œè¿™äº›å‡½æ•°å¯ä»¥æˆªè·æ•°æ®åŒ…ï¼Œå¯¹æ•°æ®åŒ…è¿›è¡Œå¹²é¢„ã€‚</p><p>ä¸€ä¸ªè‘—åçš„å®ç°ï¼Œå°±æ˜¯å†…æ ¸æ¨¡å—ip_tablesã€‚åœ¨ç”¨æˆ·æ€ï¼Œè¿˜æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯ç¨‹åºiptablesï¼Œç”¨å‘½ä»¤è¡Œæ¥å¹²é¢„å†…æ ¸çš„è§„åˆ™ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/75/4d/75c8257049eed99499e802fcc2eacf4d.png?wh=2416*1423" alt=""></p><p>iptablesæœ‰è¡¨å’Œé“¾çš„æ¦‚å¿µï¼Œæœ€ç»ˆè¦çš„æ˜¯ä¸¤ä¸ªè¡¨ã€‚</p><p>filterè¡¨å¤„ç†è¿‡æ»¤åŠŸèƒ½ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªé“¾ã€‚</p><ul>
<li>INPUTé“¾ï¼šè¿‡æ»¤æ‰€æœ‰ç›®æ ‡åœ°å€æ˜¯æœ¬æœºçš„æ•°æ®åŒ…</li>
<li>FORWARDé“¾ï¼šè¿‡æ»¤æ‰€æœ‰è·¯è¿‡æœ¬æœºçš„æ•°æ®åŒ…</li>
<li>OUTPUTé“¾ï¼šè¿‡æ»¤æ‰€æœ‰ç”±æœ¬æœºäº§ç”Ÿçš„æ•°æ®åŒ…</li>
</ul><p>natè¡¨ä¸»è¦å¤„ç†ç½‘ç»œåœ°å€è½¬æ¢ï¼Œå¯ä»¥è¿›è¡ŒSNATï¼ˆæ”¹å˜æºåœ°å€ï¼‰ã€DNATï¼ˆæ”¹å˜ç›®æ ‡åœ°å€ï¼‰ï¼ŒåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªé“¾ã€‚</p><ul>
<li>PREROUTINGé“¾ï¼šå¯ä»¥åœ¨æ•°æ®åŒ…åˆ°è¾¾æ—¶æ”¹å˜ç›®æ ‡åœ°å€</li>
<li>OUTPUTé“¾ï¼šå¯ä»¥æ”¹å˜æœ¬åœ°äº§ç”Ÿçš„æ•°æ®åŒ…çš„ç›®æ ‡åœ°å€</li>
<li>POSTROUTINGé“¾ï¼šåœ¨æ•°æ®åŒ…ç¦»å¼€æ—¶æ”¹å˜æ•°æ®åŒ…çš„æºåœ°å€</li>
</ul><p><img src="https://static001.geekbang.org/resource/image/76/da/765e5431fe4b17f62b1b5712cc82abda.png?wh=2143*943" alt=""></p><p>åœ¨è¿™é‡Œï¼Œç½‘ç»œåŒ…é©¬ä¸Šå°±è¦å‘å‡ºå»äº†ï¼Œå› è€Œæ˜¯NF_INET_LOCAL_OUTï¼Œä¹Ÿå³ouputé“¾ï¼Œå¦‚æœç”¨æˆ·æ›¾ç»åœ¨iptablesé‡Œé¢å†™è¿‡æŸäº›è§„åˆ™ï¼Œå°±ä¼šåœ¨nf_hookè¿™ä¸ªå‡½æ•°é‡Œé¢èµ·ä½œç”¨ã€‚</p><p>ip_local_outå†è°ƒç”¨dst_outputï¼Œå°±æ˜¯çœŸæ­£çš„å‘é€æ•°æ®ã€‚</p><pre><code>/* Output packet to network from transport.  */
static inline int dst_output(struct net *net, struct sock *sk, struct sk_buff *skb)
{
	return skb_dst(skb)-&gt;output(net, sk, skb);
}
</code></pre><p>è¿™é‡Œè°ƒç”¨çš„å°±æ˜¯struct rtableæˆå‘˜dstçš„ouputå‡½æ•°ã€‚åœ¨rt_dst_allocä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œoutputå‡½æ•°æŒ‡å‘çš„æ˜¯ip_outputã€‚</p><pre><code>int ip_output(struct net *net, struct sock *sk, struct sk_buff *skb)
{
	struct net_device *dev = skb_dst(skb)-&gt;dev;
	skb-&gt;dev = dev;
	skb-&gt;protocol = htons(ETH_P_IP);

	return NF_HOOK_COND(NFPROTO_IPV4, NF_INET_POST_ROUTING,
			    net, sk, skb, NULL, dev,
			    ip_finish_output,
			    !(IPCB(skb)-&gt;flags &amp; IPSKB_REROUTED));
}
</code></pre><p>åœ¨ip_outputé‡Œé¢ï¼Œæˆ‘ä»¬åˆçœ‹åˆ°äº†ç†Ÿæ‚‰çš„NF_HOOKã€‚è¿™ä¸€æ¬¡æ˜¯NF_INET_POST_ROUTINGï¼Œä¹Ÿå³POSTROUTINGé“¾ï¼Œå¤„ç†å®Œä¹‹åï¼Œè°ƒç”¨ip_finish_outputã€‚</p><h2>è§£æip_finish_outputå‡½æ•°</h2><p>ä»ip_finish_outputå‡½æ•°å¼€å§‹ï¼Œå‘é€ç½‘ç»œåŒ…çš„é€»è¾‘ç”±ç¬¬ä¸‰å±‚åˆ°è¾¾ç¬¬äºŒå±‚ã€‚ip_finish_outputæœ€ç»ˆè°ƒç”¨ip_finish_output2ã€‚</p><pre><code>static int ip_finish_output2(struct net *net, struct sock *sk, struct sk_buff *skb)
{
	struct dst_entry *dst = skb_dst(skb);
	struct rtable *rt = (struct rtable *)dst;
	struct net_device *dev = dst-&gt;dev;
	unsigned int hh_len = LL_RESERVED_SPACE(dev);
	struct neighbour *neigh;
	u32 nexthop;
......
	nexthop = (__force u32) rt_nexthop(rt, ip_hdr(skb)-&gt;daddr);
	neigh = __ipv4_neigh_lookup_noref(dev, nexthop);
	if (unlikely(!neigh))
		neigh = __neigh_create(&amp;arp_tbl, &amp;nexthop, dev, false);
	if (!IS_ERR(neigh)) {
		int res;
		sock_confirm_neigh(skb, neigh);
		res = neigh_output(neigh, skb);
		return res;
	}
......
}
</code></pre><p>åœ¨ip_finish_output2ä¸­ï¼Œå…ˆæ‰¾åˆ°struct rtableè·¯ç”±è¡¨é‡Œé¢çš„ä¸‹ä¸€è·³ï¼Œä¸‹ä¸€è·³ä¸€å®šå’Œæœ¬æœºåœ¨åŒä¸€ä¸ªå±€åŸŸç½‘ä¸­ï¼Œå¯ä»¥é€šè¿‡äºŒå±‚è¿›è¡Œé€šä¿¡ï¼Œå› è€Œé€šè¿‡__ipv4_neigh_lookup_norefï¼ŒæŸ¥æ‰¾å¦‚ä½•é€šè¿‡äºŒå±‚è®¿é—®ä¸‹ä¸€è·³ã€‚</p><pre><code>static inline struct neighbour *__ipv4_neigh_lookup_noref(struct net_device *dev, u32 key)
{
	return ___neigh_lookup_noref(&amp;arp_tbl, neigh_key_eq32, arp_hashfn, &amp;key, dev);
}
</code></pre><p>__ipv4_neigh_lookup_norefæ˜¯ä»æœ¬åœ°çš„ARPè¡¨ä¸­æŸ¥æ‰¾ä¸‹ä¸€è·³çš„MACåœ°å€ã€‚ARPè¡¨çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code>struct neigh_table arp_tbl = {
    .family     = AF_INET,
    .key_len    = 4,    
    .protocol   = cpu_to_be16(ETH_P_IP),
    .hash       = arp_hash,
    .key_eq     = arp_key_eq,
    .constructor    = arp_constructor,
    .proxy_redo = parp_redo,
    .id     = &quot;arp_cache&quot;,
......
    .gc_interval    = 30 * HZ, 
    .gc_thresh1 = 128,  
    .gc_thresh2 = 512,  
    .gc_thresh3 = 1024,
};
</code></pre><p>å¦‚æœåœ¨ARPè¡¨ä¸­æ²¡æœ‰æ‰¾åˆ°ç›¸åº”çš„é¡¹ï¼Œåˆ™è°ƒç”¨__neigh_createè¿›è¡Œåˆ›å»ºã€‚</p><pre><code>struct neighbour *__neigh_create(struct neigh_table *tbl, const void *pkey, struct net_device *dev, bool want_ref)
{
    u32 hash_val;
    int key_len = tbl-&gt;key_len;
    int error;
    struct neighbour *n1, *rc, *n = neigh_alloc(tbl, dev);
    struct neigh_hash_table *nht;

    memcpy(n-&gt;primary_key, pkey, key_len);
    n-&gt;dev = dev;
    dev_hold(dev);

    /* Protocol specific setup. */
    if (tbl-&gt;constructor &amp;&amp; (error = tbl-&gt;constructor(n)) &lt; 0) {
......
    }
......
    if (atomic_read(&amp;tbl-&gt;entries) &gt; (1 &lt;&lt; nht-&gt;hash_shift))
        nht = neigh_hash_grow(tbl, nht-&gt;hash_shift + 1);

    hash_val = tbl-&gt;hash(pkey, dev, nht-&gt;hash_rnd) &gt;&gt; (32 - nht-&gt;hash_shift);

    for (n1 = rcu_dereference_protected(nht-&gt;hash_buckets[hash_val],
                        lockdep_is_held(&amp;tbl-&gt;lock));
         n1 != NULL;
         n1 = rcu_dereference_protected(n1-&gt;next,
            lockdep_is_held(&amp;tbl-&gt;lock))) {
        if (dev == n1-&gt;dev &amp;&amp; !memcmp(n1-&gt;primary_key, pkey, key_len)) {
            if (want_ref)
                neigh_hold(n1);
            rc = n1;
            goto out_tbl_unlock;
        }
    }
......
    rcu_assign_pointer(n-&gt;next,
               rcu_dereference_protected(nht-&gt;hash_buckets[hash_val],
                             lockdep_is_held(&amp;tbl-&gt;lock)));
    rcu_assign_pointer(nht-&gt;hash_buckets[hash_val], n);
......
}
</code></pre><p>__neigh_createå…ˆè°ƒç”¨neigh_allocï¼Œåˆ›å»ºä¸€ä¸ªstruct neighbourç»“æ„ï¼Œç”¨äºç»´æŠ¤MACåœ°å€å’ŒARPç›¸å…³çš„ä¿¡æ¯ã€‚è¿™ä¸ªåå­—ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå¤§å®¶éƒ½æ˜¯åœ¨ä¸€ä¸ªå±€åŸŸç½‘é‡Œé¢ï¼Œå¯ä»¥é€šè¿‡MACåœ°å€è®¿é—®åˆ°ï¼Œå½“ç„¶æ˜¯é‚»å±…äº†ã€‚</p><pre><code>static struct neighbour *neigh_alloc(struct neigh_table *tbl, struct net_device *dev)
{
	struct neighbour *n = NULL;
	unsigned long now = jiffies;
	int entries;
......
	n = kzalloc(tbl-&gt;entry_size + dev-&gt;neigh_priv_len, GFP_ATOMIC);
	if (!n)
		goto out_entries;

	__skb_queue_head_init(&amp;n-&gt;arp_queue);
	rwlock_init(&amp;n-&gt;lock);
	seqlock_init(&amp;n-&gt;ha_lock);
	n-&gt;updated	  = n-&gt;used = now;
	n-&gt;nud_state	  = NUD_NONE;
	n-&gt;output	  = neigh_blackhole;
	seqlock_init(&amp;n-&gt;hh.hh_lock);
	n-&gt;parms	  = neigh_parms_clone(&amp;tbl-&gt;parms);
	setup_timer(&amp;n-&gt;timer, neigh_timer_handler, (unsigned long)n);

	NEIGH_CACHE_STAT_INC(tbl, allocs);
	n-&gt;tbl		  = tbl;
	refcount_set(&amp;n-&gt;refcnt, 1);
	n-&gt;dead		  = 1;
......
}
</code></pre><p>åœ¨neigh_allocä¸­ï¼Œæˆ‘ä»¬å…ˆåˆ†é…ä¸€ä¸ªstruct neighbourç»“æ„å¹¶ä¸”åˆå§‹åŒ–ã€‚è¿™é‡Œé¢æ¯”è¾ƒé‡è¦çš„æœ‰ä¸¤ä¸ªæˆå‘˜ï¼Œä¸€ä¸ªæ˜¯arp_queueï¼Œæ‰€ä»¥ä¸Šå±‚æƒ³é€šè¿‡ARPè·å–MACåœ°å€çš„ä»»åŠ¡ï¼Œéƒ½æ”¾åœ¨è¿™ä¸ªé˜Ÿåˆ—é‡Œé¢ã€‚å¦ä¸€ä¸ªæ˜¯timerå®šæ—¶å™¨ï¼Œæˆ‘ä»¬è®¾ç½®æˆï¼Œè¿‡ä¸€æ®µæ—¶é—´å°±è°ƒç”¨neigh_timer_handlerï¼Œæ¥å¤„ç†è¿™äº›ARPä»»åŠ¡ã€‚</p><p>__neigh_createç„¶åè°ƒç”¨äº†arp_tblçš„constructorå‡½æ•°ï¼Œä¹Ÿå³è°ƒç”¨äº†arp_constructorï¼Œåœ¨è¿™é‡Œé¢å®šä¹‰äº†ARPçš„æ“ä½œarp_hh_opsã€‚</p><pre><code>static int arp_constructor(struct neighbour *neigh)
{
	__be32 addr = *(__be32 *)neigh-&gt;primary_key;
	struct net_device *dev = neigh-&gt;dev;
	struct in_device *in_dev;
	struct neigh_parms *parms;
......
	neigh-&gt;type = inet_addr_type_dev_table(dev_net(dev), dev, addr);

	parms = in_dev-&gt;arp_parms;
	__neigh_parms_put(neigh-&gt;parms);
	neigh-&gt;parms = neigh_parms_clone(parms);
......
	neigh-&gt;ops = &amp;arp_hh_ops;
......
	neigh-&gt;output = neigh-&gt;ops-&gt;output;
......
}

static const struct neigh_ops arp_hh_ops = {
	.family =		AF_INET,
	.solicit =		arp_solicit,
	.error_report =		arp_error_report,
	.output =		neigh_resolve_output,
	.connected_output =	neigh_resolve_output,
};
</code></pre><p>__neigh_createæœ€åæ˜¯å°†åˆ›å»ºçš„struct neighbourç»“æ„æ”¾å…¥ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œä»é‡Œé¢çš„ä»£ç é€»è¾‘æ¯”è¾ƒå®¹æ˜“çœ‹å‡ºï¼Œè¿™æ˜¯ä¸€ä¸ªæ•°ç»„åŠ é“¾è¡¨çš„é“¾å¼å“ˆå¸Œè¡¨ï¼Œå…ˆè®¡ç®—å‡ºå“ˆå¸Œå€¼hash_valï¼Œå¾—åˆ°ç›¸åº”çš„é“¾è¡¨ï¼Œç„¶åå¾ªç¯è¿™ä¸ªé“¾è¡¨æ‰¾åˆ°å¯¹åº”çš„é¡¹ï¼Œå¦‚æœæ‰¾ä¸åˆ°å°±åœ¨æœ€åæ’å…¥ä¸€é¡¹ã€‚</p><p>æˆ‘ä»¬å›åˆ°ip_finish_output2ï¼Œåœ¨__neigh_createä¹‹åï¼Œä¼šè°ƒç”¨neigh_outputå‘é€ç½‘ç»œåŒ…ã€‚</p><pre><code>static inline int neigh_output(struct neighbour *n, struct sk_buff *skb)
{
......
	return n-&gt;output(n, skb);
}

</code></pre><p>æŒ‰ç…§ä¸Šé¢å¯¹äºstruct neighbourçš„æ“ä½œå‡½æ•°arp_hh_ops çš„å®šä¹‰ï¼Œoutputè°ƒç”¨çš„æ˜¯neigh_resolve_outputã€‚</p><pre><code>int neigh_resolve_output(struct neighbour *neigh, struct sk_buff *skb)
{
	if (!neigh_event_send(neigh, skb)) {
......
		rc = dev_queue_xmit(skb);
	}
......
}
</code></pre><p>åœ¨neigh_resolve_outputé‡Œé¢ï¼Œé¦–å…ˆneigh_event_sendè§¦å‘ä¸€ä¸ªäº‹ä»¶ï¼Œçœ‹èƒ½å¦æ¿€æ´»ARPã€‚</p><pre><code>int __neigh_event_send(struct neighbour *neigh, struct sk_buff *skb)
{
	int rc;
	bool immediate_probe = false;

	if (!(neigh-&gt;nud_state &amp; (NUD_STALE | NUD_INCOMPLETE))) {
		if (NEIGH_VAR(neigh-&gt;parms, MCAST_PROBES) +
		    NEIGH_VAR(neigh-&gt;parms, APP_PROBES)) {
			unsigned long next, now = jiffies;

			atomic_set(&amp;neigh-&gt;probes,
				   NEIGH_VAR(neigh-&gt;parms, UCAST_PROBES));
			neigh-&gt;nud_state     = NUD_INCOMPLETE;
			neigh-&gt;updated = now;
			next = now + max(NEIGH_VAR(neigh-&gt;parms, RETRANS_TIME),
					 HZ/2);
			neigh_add_timer(neigh, next);
			immediate_probe = true;
		} 
......
	} else if (neigh-&gt;nud_state &amp; NUD_STALE) {
		neigh_dbg(2, &quot;neigh %p is delayed\n&quot;, neigh);
		neigh-&gt;nud_state = NUD_DELAY;
		neigh-&gt;updated = jiffies;
		neigh_add_timer(neigh, jiffies +
				NEIGH_VAR(neigh-&gt;parms, DELAY_PROBE_TIME));
	}

	if (neigh-&gt;nud_state == NUD_INCOMPLETE) {
		if (skb) {
.......
			__skb_queue_tail(&amp;neigh-&gt;arp_queue, skb);
			neigh-&gt;arp_queue_len_Bytes += skb-&gt;truesize;
		}
		rc = 1;
	}
out_unlock_bh:
	if (immediate_probe)
		neigh_probe(neigh);
.......
}
</code></pre><p>åœ¨__neigh_event_sendä¸­ï¼Œæ¿€æ´»ARPåˆ†ä¸¤ç§æƒ…å†µï¼Œç¬¬ä¸€ç§æƒ…å†µæ˜¯é©¬ä¸Šæ¿€æ´»ï¼Œä¹Ÿå³immediate_probeã€‚å¦ä¸€ç§æƒ…å†µæ˜¯å»¶è¿Ÿæ¿€æ´»åˆ™ä»…ä»…è®¾ç½®ä¸€ä¸ªtimerã€‚ç„¶åå°†ARPåŒ…æ”¾åœ¨arp_queueä¸Šã€‚å¦‚æœé©¬ä¸Šæ¿€æ´»ï¼Œå°±ç›´æ¥è°ƒç”¨neigh_probeï¼›å¦‚æœå»¶è¿Ÿæ¿€æ´»ï¼Œåˆ™å®šæ—¶å™¨åˆ°äº†å°±ä¼šè§¦å‘neigh_timer_handlerï¼Œåœ¨è¿™é‡Œé¢è¿˜æ˜¯ä¼šè°ƒç”¨neigh_probeã€‚</p><p>æˆ‘ä»¬å°±æ¥çœ‹neigh_probeçš„å®ç°ï¼Œåœ¨è¿™é‡Œé¢ä¼šä»arp_queueä¸­æ‹¿å‡ºARPåŒ…æ¥ï¼Œç„¶åè°ƒç”¨struct neighbourçš„solicitæ“ä½œã€‚</p><pre><code>static void neigh_probe(struct neighbour *neigh)
        __releases(neigh-&gt;lock)
{
        struct sk_buff *skb = skb_peek_tail(&amp;neigh-&gt;arp_queue);
......
        if (neigh-&gt;ops-&gt;solicit)
                neigh-&gt;ops-&gt;solicit(neigh, skb);
......
}
</code></pre><p>æŒ‰ç…§ä¸Šé¢å¯¹äºstruct neighbourçš„æ“ä½œå‡½æ•°arp_hh_ops çš„å®šä¹‰ï¼Œsolicitè°ƒç”¨çš„æ˜¯arp_solicitï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¯¹äºarp_send_dstçš„è°ƒç”¨ï¼Œåˆ›å»ºå¹¶å‘é€ä¸€ä¸ªarpåŒ…ï¼Œå¾—åˆ°ç»“æœæ”¾åœ¨struct dst_entryé‡Œé¢ã€‚</p><pre><code>static void arp_send_dst(int type, int ptype, __be32 dest_ip,
                         struct net_device *dev, __be32 src_ip,
                         const unsigned char *dest_hw,
                         const unsigned char *src_hw,
                         const unsigned char *target_hw,
                         struct dst_entry *dst)
{
        struct sk_buff *skb;
......
        skb = arp_create(type, ptype, dest_ip, dev, src_ip,
                         dest_hw, src_hw, target_hw);
......
        skb_dst_set(skb, dst_clone(dst));
        arp_xmit(skb);
}

</code></pre><p>æˆ‘ä»¬å›åˆ°neigh_resolve_outputä¸­ï¼Œå½“ARPå‘é€å®Œæ¯•ï¼Œå°±å¯ä»¥è°ƒç”¨dev_queue_xmitå‘é€äºŒå±‚ç½‘ç»œåŒ…äº†ã€‚</p><pre><code>/**
 *	__dev_queue_xmit - transmit a buffer
 *	@skb: buffer to transmit
 *	@accel_priv: private data used for L2 forwarding offload
 *
 *	Queue a buffer for transmission to a network device. 
 */
static int __dev_queue_xmit(struct sk_buff *skb, void *accel_priv)
{
	struct net_device *dev = skb-&gt;dev;
	struct netdev_queue *txq;
	struct Qdisc *q;
......
	txq = netdev_pick_tx(dev, skb, accel_priv);
	q = rcu_dereference_bh(txq-&gt;qdisc);

	if (q-&gt;enqueue) {
		rc = __dev_xmit_skb(skb, q, dev, txq);
		goto out;
	}
......
}
</code></pre><p>å°±åƒå’±ä»¬åœ¨è®²è¿°ç¡¬ç›˜å—è®¾å¤‡çš„æ—¶å€™è®²è¿‡ï¼Œæ¯ä¸ªå—è®¾å¤‡éƒ½æœ‰é˜Ÿåˆ—ï¼Œç”¨äºå°†å†…æ ¸çš„æ•°æ®æ”¾åˆ°é˜Ÿåˆ—é‡Œé¢ï¼Œç„¶åè®¾å¤‡é©±åŠ¨ä»é˜Ÿåˆ—é‡Œé¢å–å‡ºåï¼Œå°†æ•°æ®æ ¹æ®å…·ä½“è®¾å¤‡çš„ç‰¹æ€§å‘é€ç»™è®¾å¤‡ã€‚</p><p>ç½‘ç»œè®¾å¤‡ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œå¯¹äºå‘é€æ¥è¯´ï¼Œæœ‰ä¸€ä¸ªå‘é€é˜Ÿåˆ—struct netdev_queue *txqã€‚</p><p>è¿™é‡Œè¿˜æœ‰å¦ä¸€ä¸ªå˜é‡å«åšstruct Qdiscï¼Œè¿™ä¸ªæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬åœ¨ä¸€å°Linuxæœºå™¨ä¸Šè¿è¡Œip addrï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°å¯¹äºä¸€ä¸ªç½‘å¡ï¼Œéƒ½æœ‰ä¸‹é¢çš„è¾“å‡ºã€‚</p><pre><code># ip addr
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1400 qdisc pfifo_fast state UP group default qlen 1000
    link/ether fa:16:3e:75:99:08 brd ff:ff:ff:ff:ff:ff
    inet 10.173.32.47/21 brd 10.173.39.255 scope global noprefixroute dynamic eth0
       valid_lft 67104sec preferred_lft 67104sec
    inet6 fe80::f816:3eff:fe75:9908/64 scope link 
       valid_lft forever preferred_lft forever
</code></pre><p>è¿™é‡Œé¢æœ‰ä¸ªå…³é”®å­—qdisc pfifo_fastæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿqdiscå…¨ç§°æ˜¯queueing disciplineï¼Œä¸­æ–‡å«æ’é˜Ÿè§„åˆ™ã€‚å†…æ ¸å¦‚æœéœ€è¦é€šè¿‡æŸä¸ªç½‘ç»œæ¥å£å‘é€æ•°æ®åŒ…ï¼Œéƒ½éœ€è¦æŒ‰ç…§ä¸ºè¿™ä¸ªæ¥å£é…ç½®çš„qdiscï¼ˆæ’é˜Ÿè§„åˆ™ï¼‰æŠŠæ•°æ®åŒ…åŠ å…¥é˜Ÿåˆ—ã€‚</p><p>æœ€ç®€å•çš„qdiscæ˜¯pfifoï¼Œå®ƒä¸å¯¹è¿›å…¥çš„æ•°æ®åŒ…åšä»»ä½•çš„å¤„ç†ï¼Œæ•°æ®åŒ…é‡‡ç”¨å…ˆå…¥å…ˆå‡ºçš„æ–¹å¼é€šè¿‡é˜Ÿåˆ—ã€‚pfifo_fastç¨å¾®å¤æ‚ä¸€äº›ï¼Œå®ƒçš„é˜Ÿåˆ—åŒ…æ‹¬ä¸‰ä¸ªæ³¢æ®µï¼ˆbandï¼‰ã€‚åœ¨æ¯ä¸ªæ³¢æ®µé‡Œé¢ï¼Œä½¿ç”¨å…ˆè¿›å…ˆå‡ºè§„åˆ™ã€‚</p><p>ä¸‰ä¸ªæ³¢æ®µçš„ä¼˜å…ˆçº§ä¹Ÿä¸ç›¸åŒã€‚band 0çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œband 2çš„æœ€ä½ã€‚å¦‚æœband 0é‡Œé¢æœ‰æ•°æ®åŒ…ï¼Œç³»ç»Ÿå°±ä¸ä¼šå¤„ç†band 1é‡Œé¢çš„æ•°æ®åŒ…ï¼Œband 1å’Œband 2ä¹‹é—´ä¹Ÿæ˜¯ä¸€æ ·ã€‚</p><p>æ•°æ®åŒ…æ˜¯æŒ‰ç…§æœåŠ¡ç±»å‹ï¼ˆType of Serviceï¼ŒTOSï¼‰è¢«åˆ†é…åˆ°ä¸‰ä¸ªæ³¢æ®µé‡Œé¢çš„ã€‚TOSæ˜¯IPå¤´é‡Œé¢çš„ä¸€ä¸ªå­—æ®µï¼Œä»£è¡¨äº†å½“å‰çš„åŒ…æ˜¯é«˜ä¼˜å…ˆçº§çš„ï¼Œè¿˜æ˜¯ä½ä¼˜å…ˆçº§çš„ã€‚</p><p>pfifo_faståˆ†ä¸ºä¸‰ä¸ªå…ˆå…¥å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œæˆ‘ä»¬èƒ½ç§°ä¸ºä¸‰ä¸ªBandã€‚æ ¹æ®ç½‘ç»œåŒ…é‡Œé¢çš„TOSï¼Œçœ‹è¿™ä¸ªåŒ…åˆ°åº•åº”è¯¥è¿›å…¥å“ªä¸ªé˜Ÿåˆ—ã€‚TOSæ€»å…±å››ä½ï¼Œæ¯ä¸€ä½è¡¨ç¤ºçš„æ„æ€ä¸åŒï¼Œæ€»å…±åå…­ç§ç±»å‹ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/ab/d9/ab6af2f9e1a64868636080a05cfde0d9.png?wh=1948*853" alt=""></p><p>é€šè¿‡å‘½ä»¤è¡Œtc qdisc show dev eth0ï¼Œæˆ‘ä»¬å¯ä»¥è¾“å‡ºç»“æœpriomapï¼Œä¹Ÿæ˜¯åå…­ä¸ªæ•°å­—ã€‚åœ¨0åˆ°2ä¹‹é—´ï¼Œå’ŒTOSçš„åå…­ç§ç±»å‹å¯¹åº”èµ·æ¥ã€‚ä¸åŒçš„TOSå¯¹åº”ä¸åŒçš„é˜Ÿåˆ—ã€‚å…¶ä¸­Band 0ä¼˜å…ˆçº§æœ€é«˜ï¼Œå‘é€å®Œæ¯•åæ‰è½®åˆ°Band 1å‘é€ï¼Œæœ€åæ‰æ˜¯Band 2ã€‚</p><pre><code># tc qdisc show dev eth0
qdisc pfifo_fast 0: root refcnt 2 bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1
</code></pre><p>æ¥ä¸‹æ¥ï¼Œ__dev_xmit_skbå¼€å§‹è¿›è¡Œç½‘ç»œåŒ…å‘é€ã€‚</p><pre><code>static inline int __dev_xmit_skb(struct sk_buff *skb, struct Qdisc *q,
                 struct net_device *dev,
                 struct netdev_queue *txq)
{
......
    rc = q-&gt;enqueue(skb, q, &amp;to_free) &amp; NET_XMIT_MASK;
    if (qdisc_run_begin(q)) {
......
        __qdisc_run(q);
    }
......    
}

void __qdisc_run(struct Qdisc *q)
{
    int quota = dev_tx_weight;
    int packets;
     while (qdisc_restart(q, &amp;packets)) {
        /*
         * Ordered by possible occurrence: Postpone processing if
         * 1. we've exceeded packet quota
         * 2. another process needs the CPU;
         */
        quota -= packets;
        if (quota &lt;= 0 || need_resched()) {
            __netif_schedule(q);
            break;
        }
     }
     qdisc_run_end(q);
}
</code></pre><p>__dev_xmit_skbä¼šå°†è¯·æ±‚æ”¾å…¥é˜Ÿåˆ—ï¼Œç„¶åè°ƒç”¨__qdisc_runå¤„ç†é˜Ÿåˆ—ä¸­çš„æ•°æ®ã€‚qdisc_restartç”¨äºæ•°æ®çš„å‘é€ã€‚æ ¹æ®æ³¨é‡Šä¸­çš„è¯´æ³•ï¼Œqdiscçš„å¦ä¸€ä¸ªåŠŸèƒ½æ˜¯ç”¨äºæ§åˆ¶ç½‘ç»œåŒ…çš„å‘é€é€Ÿåº¦ï¼Œå› è€Œå¦‚æœè¶…è¿‡é€Ÿåº¦ï¼Œå°±éœ€è¦é‡æ–°è°ƒåº¦ï¼Œåˆ™ä¼šè°ƒç”¨__netif_scheduleã€‚</p><pre><code>static void __netif_reschedule(struct Qdisc *q)
{
    struct softnet_data *sd;
    unsigned long flags;
    local_irq_save(flags);
    sd = this_cpu_ptr(&amp;softnet_data);
    q-&gt;next_sched = NULL;
    *sd-&gt;output_queue_tailp = q;
    sd-&gt;output_queue_tailp = &amp;q-&gt;next_sched;
    raise_softirq_irqoff(NET_TX_SOFTIRQ);
    local_irq_restore(flags);
}
</code></pre><p>__netif_scheduleä¼šè°ƒç”¨__netif_rescheduleï¼Œå‘èµ·ä¸€ä¸ªè½¯ä¸­æ–­NET_TX_SOFTIRQã€‚å’±ä»¬è®²è®¾å¤‡é©±åŠ¨ç¨‹åºçš„æ—¶å€™è®²è¿‡ï¼Œè®¾å¤‡é©±åŠ¨ç¨‹åºå¤„ç†ä¸­æ–­ï¼Œåˆ†ä¸¤ä¸ªè¿‡ç¨‹ï¼Œä¸€ä¸ªæ˜¯å±è”½ä¸­æ–­çš„å…³é”®å¤„ç†é€»è¾‘ï¼Œä¸€ä¸ªæ˜¯å»¶è¿Ÿå¤„ç†é€»è¾‘ã€‚å½“æ—¶è¯´å·¥ä½œé˜Ÿåˆ—æ˜¯å»¶è¿Ÿå¤„ç†é€»è¾‘çš„å¤„ç†æ–¹æ¡ˆï¼Œè½¯ä¸­æ–­ä¹Ÿæ˜¯ä¸€ç§æ–¹æ¡ˆã€‚</p><p>åœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå®šä¹‰è½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°ã€‚ä¾‹å¦‚ï¼ŒNET_TX_SOFTIRQçš„å¤„ç†å‡½æ•°æ˜¯net_tx_actionï¼Œç”¨äºå‘é€ç½‘ç»œåŒ…ã€‚è¿˜æœ‰ä¸€ä¸ªNET_RX_SOFTIRQçš„å¤„ç†å‡½æ•°æ˜¯net_rx_actionï¼Œç”¨äºæ¥æ”¶ç½‘ç»œåŒ…ã€‚æ¥æ”¶ç½‘ç»œåŒ…çš„è¿‡ç¨‹å’±ä»¬ä¸‹ä¸€èŠ‚è§£æã€‚</p><pre><code>open_softirq(NET_TX_SOFTIRQ, net_tx_action);
open_softirq(NET_RX_SOFTIRQ, net_rx_action);

</code></pre><p>è¿™é‡Œæˆ‘ä»¬æ¥è§£æä¸€ä¸‹net_tx_actionã€‚</p><pre><code>static __latent_entropy void net_tx_action(struct softirq_action *h)
{
    struct softnet_data *sd = this_cpu_ptr(&amp;softnet_data);
......
    if (sd-&gt;output_queue) {
        struct Qdisc *head;

        local_irq_disable();
        head = sd-&gt;output_queue;
        sd-&gt;output_queue = NULL;
        sd-&gt;output_queue_tailp = &amp;sd-&gt;output_queue;
        local_irq_enable();

        while (head) {
            struct Qdisc *q = head;
            spinlock_t *root_lock;

            head = head-&gt;next_sched;
......
            qdisc_run(q);
        }
    }
}
</code></pre><p>æˆ‘ä»¬ä¼šå‘ç°ï¼Œnet_tx_actionè¿˜æ˜¯è°ƒç”¨äº†qdisc_runï¼Œè¿˜æ˜¯ä¼šè°ƒç”¨__qdisc_runï¼Œç„¶åè°ƒç”¨qdisc_restartå‘é€ç½‘ç»œåŒ…ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹qdisc_restartçš„å®ç°ã€‚</p><pre><code>static inline int qdisc_restart(struct Qdisc *q, int *packets)
{
        struct netdev_queue *txq;
        struct net_device *dev;
        spinlock_t *root_lock;
        struct sk_buff *skb;
        bool validate;

        /* Dequeue packet */
        skb = dequeue_skb(q, &amp;validate, packets);
        if (unlikely(!skb))
                return 0;

        root_lock = qdisc_lock(q);
        dev = qdisc_dev(q);
        txq = skb_get_tx_queue(dev, skb);

        return sch_direct_xmit(skb, q, dev, txq, root_lock, validate);
}
</code></pre><p>qdisc_restartå°†ç½‘ç»œåŒ…ä»Qdiscçš„é˜Ÿåˆ—ä¸­æ‹¿ä¸‹æ¥ï¼Œç„¶åè°ƒç”¨sch_direct_xmitè¿›è¡Œå‘é€ã€‚</p><pre><code>int sch_direct_xmit(struct sk_buff *skb, struct Qdisc *q,
            struct net_device *dev, struct netdev_queue *txq,
            spinlock_t *root_lock, bool validate)
{
    int ret = NETDEV_TX_BUSY;

    if (likely(skb)) {
        if (!netif_xmit_frozen_or_stopped(txq))
            skb = dev_hard_start_xmit(skb, dev, txq, &amp;ret); 
    } 
......
    if (dev_xmit_complete(ret)) {
        /* Driver sent out skb successfully or skb was consumed */
        ret = qdisc_qlen(q);
    } else {
        /* Driver returned NETDEV_TX_BUSY - requeue skb */
        ret = dev_requeue_skb(skb, q);
    }   
......
}
</code></pre><p>åœ¨sch_direct_xmitä¸­ï¼Œè°ƒç”¨dev_hard_start_xmitè¿›è¡Œå‘é€ï¼Œå¦‚æœå‘é€ä¸æˆåŠŸï¼Œä¼šè¿”å›NETDEV_TX_BUSYã€‚è¿™è¯´æ˜ç½‘ç»œå¡å¾ˆå¿™ï¼Œäºæ˜¯å°±è°ƒç”¨dev_requeue_skbï¼Œé‡æ–°æ”¾å…¥é˜Ÿåˆ—ã€‚</p><pre><code>struct sk_buff *dev_hard_start_xmit(struct sk_buff *first, struct net_device *dev, struct netdev_queue *txq, int *ret) 
{
    struct sk_buff *skb = first;
    int rc = NETDEV_TX_OK;

    while (skb) {
        struct sk_buff *next = skb-&gt;next;
        rc = xmit_one(skb, dev, txq, next != NULL);
        skb = next; 
        if (netif_xmit_stopped(txq) &amp;&amp; skb) {
            rc = NETDEV_TX_BUSY;
            break;      
        }       
    }   
......
}
</code></pre><p>åœ¨dev_hard_start_xmitä¸­ï¼Œæ˜¯ä¸€ä¸ªwhileå¾ªç¯ã€‚æ¯æ¬¡åœ¨é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªsk_buffï¼Œè°ƒç”¨xmit_oneå‘é€ã€‚</p><p>æ¥ä¸‹æ¥çš„è°ƒç”¨é“¾ä¸ºï¼šxmit_one-&gt;netdev_start_xmit-&gt;__netdev_start_xmitã€‚</p><pre><code>static inline netdev_tx_t __netdev_start_xmit(const struct net_device_ops *ops, struct sk_buff *skb, struct net_device *dev, bool more)          
{
    skb-&gt;xmit_more = more ? 1 : 0;
    return ops-&gt;ndo_start_xmit(skb, dev);
}
</code></pre><p>è¿™ä¸ªæ—¶å€™ï¼Œå·²ç»åˆ°äº†è®¾å¤‡é©±åŠ¨å±‚äº†ã€‚æˆ‘ä»¬èƒ½çœ‹åˆ°ï¼Œdrivers/net/ethernet/intel/ixgb/ixgb_main.cé‡Œé¢æœ‰å¯¹äºè¿™ä¸ªç½‘å¡çš„æ“ä½œçš„å®šä¹‰ã€‚</p><pre><code>static const struct net_device_ops ixgb_netdev_ops = {
        .ndo_open               = ixgb_open,
        .ndo_stop               = ixgb_close,
        .ndo_start_xmit         = ixgb_xmit_frame,
        .ndo_set_rx_mode        = ixgb_set_multi,
        .ndo_validate_addr      = eth_validate_addr,
        .ndo_set_mac_address    = ixgb_set_mac,
        .ndo_change_mtu         = ixgb_change_mtu,
        .ndo_tx_timeout         = ixgb_tx_timeout,
        .ndo_vlan_rx_add_vid    = ixgb_vlan_rx_add_vid,
        .ndo_vlan_rx_kill_vid   = ixgb_vlan_rx_kill_vid,
        .ndo_fix_features       = ixgb_fix_features,
        .ndo_set_features       = ixgb_set_features,
};
</code></pre><p>åœ¨è¿™é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¯¹äºndo_start_xmitçš„å®šä¹‰ï¼Œè°ƒç”¨ixgb_xmit_frameã€‚</p><pre><code>static netdev_tx_t
ixgb_xmit_frame(struct sk_buff *skb, struct net_device *netdev)
{
    struct ixgb_adapter *adapter = netdev_priv(netdev);
......
    if (count) {
        ixgb_tx_queue(adapter, count, vlan_id, tx_flags);
        /* Make sure there is space in the ring for the next send. */
        ixgb_maybe_stop_tx(netdev, &amp;adapter-&gt;tx_ring, DESC_NEEDED);

    } 
......
    return NETDEV_TX_OK;
}
</code></pre><p>åœ¨ixgb_xmit_frameä¸­ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°è¿™ä¸ªç½‘å¡å¯¹åº”çš„é€‚é…å™¨ï¼Œç„¶åå°†å…¶æ”¾å…¥ç¡¬ä»¶ç½‘å¡çš„é˜Ÿåˆ—ä¸­ã€‚</p><p>è‡³æ­¤ï¼Œæ•´ä¸ªå‘é€æ‰ç®—ç»“æŸã€‚</p><h2>æ€»ç»“æ—¶åˆ»</h2><p>è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬ç»§ç»­è§£æäº†å‘é€ä¸€ä¸ªç½‘ç»œåŒ…çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬æ•´ä¸ªè¿‡ç¨‹çš„å›¾ç”»åœ¨äº†ä¸‹é¢ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/79/6f/79cc42f3163d159a66e163c006d9f36f.png?wh=6064*7303" alt=""></p><p>è¿™ä¸ªè¿‡ç¨‹åˆ†æˆå‡ ä¸ªå±‚æ¬¡ã€‚</p><ul>
<li>VFSå±‚ï¼šwriteç³»ç»Ÿè°ƒç”¨æ‰¾åˆ°struct fileï¼Œæ ¹æ®é‡Œé¢çš„file_operationsçš„å®šä¹‰ï¼Œè°ƒç”¨sock_write_iterå‡½æ•°ã€‚sock_write_iterå‡½æ•°è°ƒç”¨sock_sendmsgå‡½æ•°ã€‚</li>
<li>Socketå±‚ï¼šä»struct fileé‡Œé¢çš„private_dataå¾—åˆ°struct socketï¼Œæ ¹æ®é‡Œé¢opsçš„å®šä¹‰ï¼Œè°ƒç”¨inet_sendmsgå‡½æ•°ã€‚</li>
<li>Sockå±‚ï¼šä»struct socketé‡Œé¢çš„skå¾—åˆ°struct sockï¼Œæ ¹æ®é‡Œé¢sk_protçš„å®šä¹‰ï¼Œè°ƒç”¨tcp_sendmsgå‡½æ•°ã€‚</li>
<li>TCPå±‚ï¼štcp_sendmsgå‡½æ•°ä¼šè°ƒç”¨tcp_write_xmitå‡½æ•°ï¼Œtcp_write_xmitå‡½æ•°ä¼šè°ƒç”¨tcp_transmit_skbï¼Œåœ¨è¿™é‡Œå®ç°äº†TCPå±‚é¢å‘è¿æ¥çš„é€»è¾‘ã€‚</li>
<li>IPå±‚ï¼šæ‰©å±•struct sockï¼Œå¾—åˆ°struct inet_connection_sockï¼Œæ ¹æ®é‡Œé¢icsk_af_opsçš„å®šä¹‰ï¼Œè°ƒç”¨ip_queue_xmitå‡½æ•°ã€‚</li>
<li>IPå±‚ï¼šip_route_output_portså‡½æ•°é‡Œé¢ä¼šè°ƒç”¨fib_lookupæŸ¥æ‰¾è·¯ç”±è¡¨ã€‚FIBå…¨ç§°æ˜¯Forwarding Information Baseï¼Œè½¬å‘ä¿¡æ¯è¡¨ï¼Œä¹Ÿå°±æ˜¯è·¯ç”±è¡¨ã€‚</li>
<li>åœ¨IPå±‚é‡Œé¢è¦åšçš„å¦ä¸€ä¸ªäº‹æƒ…æ˜¯å¡«å†™IPå±‚çš„å¤´ã€‚</li>
<li>åœ¨IPå±‚è¿˜è¦åšçš„ä¸€ä»¶äº‹æƒ…å°±æ˜¯é€šè¿‡iptablesè§„åˆ™ã€‚</li>
<li>MACå±‚ï¼šIPå±‚è°ƒç”¨ip_finish_outputè¿›è¡ŒMACå±‚ã€‚</li>
<li>MACå±‚éœ€è¦ARPè·å¾—MACåœ°å€ï¼Œå› è€Œè¦è°ƒç”¨___neigh_lookup_norefæŸ¥æ‰¾å±äºåŒä¸€ä¸ªç½‘æ®µçš„é‚»å±…ï¼Œä»–ä¼šè°ƒç”¨neigh_probeå‘é€ARPã€‚</li>
<li>æœ‰äº†MACåœ°å€ï¼Œå°±å¯ä»¥è°ƒç”¨dev_queue_xmitå‘é€äºŒå±‚ç½‘ç»œåŒ…äº†ï¼Œå®ƒä¼šè°ƒç”¨__dev_xmit_skbä¼šå°†è¯·æ±‚æ”¾å…¥é˜Ÿåˆ—ã€‚</li>
<li>è®¾å¤‡å±‚ï¼šç½‘ç»œåŒ…çš„å‘é€ä¼šè§¦å‘ä¸€ä¸ªè½¯ä¸­æ–­NET_TX_SOFTIRQæ¥å¤„ç†é˜Ÿåˆ—ä¸­çš„æ•°æ®ã€‚è¿™ä¸ªè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°æ˜¯net_tx_actionã€‚</li>
<li>åœ¨è½¯ä¸­æ–­å¤„ç†å‡½æ•°ä¸­ï¼Œä¼šå°†ç½‘ç»œåŒ…ä»é˜Ÿåˆ—ä¸Šæ‹¿ä¸‹æ¥ï¼Œè°ƒç”¨ç½‘ç»œè®¾å¤‡çš„ä¼ è¾“å‡½æ•°ixgb_xmit_frameï¼Œå°†ç½‘ç»œåŒ…å‘åˆ°è®¾å¤‡çš„é˜Ÿåˆ—ä¸Šå»ã€‚</li>
</ul><h2>è¯¾å ‚ç»ƒä¹ </h2><p>ä¸Šä¸€èŠ‚ä½ åº”è¯¥é€šè¿‡tcpdumpçœ‹åˆ°äº†TCPåŒ…å¤´çš„æ ¼å¼ï¼Œè¿™ä¸€èŠ‚ï¼Œè¯·ä½ æŸ¥çœ‹ä¸€ä¸‹IPåŒ…çš„æ ¼å¼ä»¥åŠARPçš„è¿‡ç¨‹ã€‚</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„ç–‘æƒ‘å’Œè§è§£ ï¼Œä¹Ÿæ¬¢è¿å¯ä»¥æ”¶è—æœ¬èŠ‚å†…å®¹ï¼Œåå¤ç ”è¯»ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·å­¦ä¹ å’Œè¿›æ­¥ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/8c/37/8c0a95fa07a8b9a1abfd394479bdd637.jpg?wh=1110*659" alt=""></p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/08/ab/caec7bca.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>humor</span>
  </div>
  <div class="_2_QraFYR_0">è¿™ä¹ˆå¤æ‚çš„è°ƒç”¨å…³ç³»ï¼Œè€å¸ˆæ˜¯æ€ä¹ˆè®°ä½çš„å•Šï¼Ÿ æˆ‘çœ‹ä¸€éå°±ä¼šå¿˜æ‰â€¦â€¦</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-11-18 17:48:46</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å®‰æ’</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆã€‚åº”ç”¨å±‚è°ƒç”¨socket  æ¥å£å‘é€æ•°æ®æ˜¯åˆ°å“ªä¸ªé˜¶æ®µå°±è¿”å›äº†ï¼Ÿæ˜¯æ•°æ®å†™åˆ°qdiscä¸­åº”ç”¨å°±å¯ä»¥è¿”å›äº†å—ï¼Ÿè¿˜æ˜¯è¦ç­‰åˆ°å†™åˆ°ç¡¬ä»¶ç½‘å¡ä¸­ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å‘èµ·è½¯ä¸­æ–­å°±è¿”å›</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-07-14 09:57:35</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/a6/5e/b05254a6.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Mhy</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆè¯·é—®neigh_probe å‘é€ ARPåè¿˜éœ€è¦é˜»å¡ç­‰å¾…å…¶ä»–ä¸»æœºè¿”å›macå—ï¼Œå¦‚æœæ²¡æœ‰æ”¶åˆ°å‘¢</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: è¦ç­‰å¾…è¿”å›ï¼Œè¦ä¸ç„¶ä¸çŸ¥é“macå‘ä¸å‡ºå»</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-05-13 15:41:46</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/92/7c/12c571b6.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Slience-0Â°C</span>
  </div>
  <div class="_2_QraFYR_0">ä¸æ˜¯å¾ˆè¶£å‘³å•Š</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-09-05 06:00:26</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å®‰æ’</span>
  </div>
  <div class="_2_QraFYR_0">å‘é€æ•°æ®åŒ…æ—¶ï¼ŒæºMacåœ°å€æ˜¯ç”±åè®®æ ˆè½¯ä»¶åŠ ä¸Šçš„å—ï¼Œè¿˜æ˜¯ç­‰æ•°æ®åŒ…åˆ°ç½‘å¡åç”±ç½‘å¡ç¡¬ä»¶è‡ªåŠ¨åŠ ä¸Šçš„ï¼Ÿ<br><br>æºMacåœ°å€ç°åœ¨ä¸€èˆ¬æ˜¯å†™æ­»åœ¨ç½‘å¡é‡Œçš„å—ï¼Ÿè¿˜æ˜¯ç»´æŠ¤åœ¨è½¯ä»¶åè®®æ ˆé‡Œçš„ä¸€ä¸ªå˜é‡ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å†…æ ¸åè®®æ ˆåŠ ä¸Šçš„ã€‚macåœ°å€å¯ä»¥é€šè¿‡å‘½ä»¤ä¿®æ”¹çš„</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-07-12 00:34:26</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å®‰æ’</span>
  </div>
  <div class="_2_QraFYR_0">ä¾‹å¦‚ 192.168.2.0&#47;24 å’Œ 192.168.0.0&#47;16 éƒ½èƒ½åŒ¹é… 192.168.2.100&#47;24ã€‚<br>      192.168.0.0&#47;16ä¸ºä»€ä¹ˆèƒ½åŒ¹é…192.168.2.100&#47;24 å‘¢ï¼Ÿå…¶å®å¯¹äºç›®çš„IPæˆ‘ä»¬æ˜¯ä¸çŸ¥é“å­ç½‘æ©ç çš„ï¼Œæ‰€ä»¥192.168.2.100&#47;24è¿™é‡Œçš„24æ„Ÿè§‰æœ‰ç‚¹è¿·æƒ‘ï¼Œå¦‚æœç¡®å®šå®ƒçš„æ©ç æ˜¯24ä½ï¼Œé‚£å’Œ16ä½æ©ç çš„é‚£ä¸ªè§„åˆ™å°±ä¸åŒ¹é…äº†å§ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: åªè¦é€šè¿‡æœ¬åœ°çš„å­ç½‘æ©ç ç®—ä¸€ä¸‹ã€‚192.168.2.100çš„å‰16ä½èƒ½å¤Ÿå’Œ192.168ï¼ˆ192.168.0.0&#47;16ï¼‰å®Œå…¨ä¸€è‡´ï¼Œåˆ™è¯´æ˜èƒ½å¤ŸåŒ¹é…192.168.0.0&#47;16ã€‚åŒç†192.168.2.100çš„å‰24ä½èƒ½å¤Ÿå’Œ192.168.2ï¼ˆ192.168.2.0&#47;24ï¼‰å®Œå…¨ä¸€è‡´ï¼Œåˆ™è¯´æ˜èƒ½å¤ŸåŒ¹é…192.168.2.0&#47;24</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-07-12 00:30:54</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/19/00/1b/eee13196.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æåœ£æ‚¦</span>
  </div>
  <div class="_2_QraFYR_0">å‘ä¸ªåŒ…å°±å¹²äº†è¿™ä¹ˆå¤šäº‹ï¼æ‰€ä»¥æ€§èƒ½å¹¶ä¸å¾ˆå¥½ï¼Œè¿½æ±‚æ€§èƒ½è¿˜æ˜¯è¦ç”¨dpdk</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-07-03 08:17:25</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/55/f2/ba68d931.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æœ‰ç±³</span>
  </div>
  <div class="_2_QraFYR_0">è°ƒç”¨æµç¨‹å·²ç»æ˜ç™½äº†ï¼Œä½†è¿˜ä¸å¤ªæ˜ç™½æ•°æ®çš„ç‰©ç†ç©ºé—´æ˜¯æ€ä¹ˆæµåŠ¨çš„ï¼Ÿæ¯”å¦‚æˆ‘ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶ï¼Œæ˜¯ä»ç£ç›˜æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç„¶åæ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œå†æ‹·è´åˆ°ç½‘å¡ç¼“å­˜ï¼Ÿç»“åˆé›¶æ‹·è´åŸç†æ¥çœ‹ï¼Œè¿˜æ˜¯æœ‰ç‚¹æ¨¡ç³Šã€‚è¯·è€å¸ˆå¸®å¿™æ‹ä¸€æ‹</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-05-03 18:43:33</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/16/d0/d6/f335954b.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ä¸€ç¬”ä¸€ç”»</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œè¯·æ•™ä¸‹qosåŠŸèƒ½æ˜¯å¦ä¹Ÿå’Œç¡¬ä»¶æœ‰å…³ç³»ï¼Ÿpfifo_fastæ˜¯éœ€è¦ç¡¬ä»¶æ”¯æŒçš„å—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ä¸éœ€è¦ï¼Œæ˜¯å†…æ ¸çš„åŠŸèƒ½</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-07-17 00:10:03</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>LeonğŸ“·</span>
  </div>
  <div class="_2_QraFYR_0">æœ€è¿‘ç”¨goå®ç°äº†rtpçš„åè®®ï¼Œåè®®å¤´å¡«å……å’Œå­—èŠ‚å¤§å°è®¡ç®—ç­‰ç­‰å¾ˆç±»ä¼¼ï¼Œè¿™èŠ‚å†…å®¹æœ‰ç§ä¼¼æ›¾ç›¸è¯†çš„æ„Ÿè§‰ï¼Œå€Ÿé‰´ä¸‹å¯ä»¥å®ç°çš„æ›´ç‰›é€¼ï¼Œå“ˆ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: èµï¼Œè‡ªå·±å®ç°RTPï¼Œç‰›</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-07-14 09:23:34</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src=""
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_bb8d16</span>
  </div>
  <div class="_2_QraFYR_0">å¦å¤–ä¸€ä¸ªè§’åº¦ï¼Œçœ‹åˆ°äº†é˜Ÿåˆ—ï¼Œå“ˆå¸Œè¡¨ï¼Œå‰ç¼€æ ‘ï¼Œè´£ä»»é“¾æ¨¡å¼ï¼Œæ–‡ä»¶çš„æŠ½è±¡å’Œç»§æ‰¿ã€‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-01-08 22:21:31</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/1f/68/12/031a05c3.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Aå…å¸…å«å“¥</span>
  </div>
  <div class="_2_QraFYR_0">å°†ARPåŒ…æ”¾åˆ°arp_queueï¼Œè¿™é‡Œåº”è¯¥æ˜¯æè¿°é”™äº†ï¼Œarp_queueä¸­ä¿å­˜çš„æ˜¯çœŸå®çš„æ•°æ®åŒ…ï¼Œä¸æ˜¯arpåŒ…ï¼Œå¾…æ¥æ”¶åˆ°arpå“åº”ä¹‹åå†å»å¤„ç†arp_queueçš„æ•°æ®åŒ…ï¼Œé€ä¸ªå‘é€ï¼Œã€‚åœ¨neighprobeçš„æ—¶å€™ï¼Œæ‰ä¼šç”ŸæˆarpåŒ…ï¼Œå¹¶å‘é€ã€‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-09-24 18:16:37</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/2c/9a/7b/aa937172.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>LiL</span>
  </div>
  <div class="_2_QraFYR_0">è¯·é—®åˆ˜è€å¸ˆï¼Œè¾“å…¥ä¸€ä¸ªæ— æ•ˆIPï¼Œè·¯ç”±å™¨æ˜¯æ€ä¹ˆåˆ¤å®šä»–æ˜¯æ— æ•ˆçš„ï¼Ÿæ‰€æœ‰è·¯ç”±è·¯å¾„å°è¯•ä¸€è¾¹éƒ½å¤±è´¥æ‰ç®—ï¼Ÿè¿˜æ˜¯æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-07-16 15:32:28</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/39/e0/8b74c083.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æ˜æœˆåƒé‡Œ</span>
  </div>
  <div class="_2_QraFYR_0">å¤ªç¡¬æ ¸äº†</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-01-16 08:38:41</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/fa/20/0f06b080.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å‡Œç©ºé£èµ·çš„å‰ªåˆ€è…¿</span>
  </div>
  <div class="_2_QraFYR_0">socket---&gt;route list----&gt;netfilter(iptables)--&gt;tc---&gt;mac</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-04-07 09:54:17</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src=""
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_211784</span>
  </div>
  <div class="_2_QraFYR_0">æ‚¨å¥½ï¼Œæˆ‘è¯•ç€å¾ªç¯alloc_skbåˆ›å»ºskbå¹¶è°ƒç”¨ip_queue_xmitå‘å‡ºå»ï¼Œæ¥æ”¶ç«¯èƒ½æ”¶åˆ°åŒ…ï¼Œä½†å¾ªç¯30æ¬¡ï¼Œå‘ç°è€—æ—¶æœ€å°‘éƒ½æœ‰4100usä¹Ÿå°±æ˜¯4æ¯«ç§’å¤šï¼Œæ„Ÿè§‰è¿™ä¸ªè€—æ—¶å¾ˆå¤§ï¼Œæ˜¯ä¸æ˜¯æœ‰å•¥é—®é¢˜ã€‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-03-06 15:40:24</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/af/00/9b49f42b.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>skye</span>
  </div>
  <div class="_2_QraFYR_0">è¯·é—®è€å¸ˆï¼Œnets tat çœ‹åˆ°çš„recv-q å’Œsend-qæ˜¯å±äºç½‘å¡çš„é˜Ÿåˆ—å—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-12-21 11:59:04</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/16/d0/d6/f335954b.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ä¸€ç¬”ä¸€ç”»</span>
  </div>
  <div class="_2_QraFYR_0">è¯·æ•™ä¸‹ï¼ŒMACå±‚ä¹Ÿè´Ÿè´£vlan tagçš„å¡«å……å—</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-10-15 23:59:27</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLh73kPzAKhz7YxUribqF6QKFiahhVAbwpgVLSRicA68c6ZFA7vUBJY1ves3LVvibrypROyI7awv47eSA/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ZYecho</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œå†…æ ¸ä¸­è¿˜æœ‰ä¸ªfdbè¡¨ï¼Œè¯·é—®è¿™ä¸ªè¡¨æ˜¯ç”¨æ¥å¹²å˜›çš„ï¼Ÿåœ¨å“ªä¸ªç¯èŠ‚çš„å¤„ç†è¿‡ç¨‹ä¸­ä¼šè¢«ä½¿ç”¨åˆ°ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-09-19 11:12:35</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/9b/ba/333b59e5.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Linuxer</span>
  </div>
  <div class="_2_QraFYR_0">è®¾å¤‡å±‚ï¼šç½‘ç»œåŒ…çš„å‘é€å›(è¿™é‡Œåº”è¯¥æ˜¯ä¼šå§ï¼Ÿ)è§¦å‘ä¸€ä¸ªè½¯ä¸­æ–­ NET_TX_SOFTIRQ æ¥å¤„ç†é˜Ÿåˆ—ä¸­çš„æ•°æ®ã€‚è¿™ä¸ªè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°æ˜¯ net_tx_actionã€‚<br>åœ¨è½¯ä¸­æ–­å¤„ç†å‡½æ•°ä¸­ï¼Œä¼šå°†ç½‘ç»œåŒ…ä»é˜Ÿåˆ—ä¸Šæ‹¿ä¸‹æ¥ï¼Œè°ƒç”¨ç½‘ç»œè®¾å¤‡çš„ä¼ è¾“å‡½æ•° ixgb_xmit_frameï¼Œå°†ç½‘ç»œåŒ…å‘çš„(è¿™é‡Œåº”è¯¥æ˜¯åˆ°å§ï¼Ÿ)è®¾å¤‡çš„é˜Ÿåˆ—ä¸Šå»</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ˜¯çš„ï¼Œè°¢è°¢æŒ‡æ­£</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-07-13 08:21:04</div>
  </div>
</div>
</div>
</li>
</ul>