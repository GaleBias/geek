<audio title="33 _ å­—ç¬¦è®¾å¤‡ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•å»ºç«‹ç›´é”€æ¨¡å¼ï¼Ÿ" src="https://static001.geekbang.org/resource/audio/33/51/33307f82ecdb7940a6a0003abd72ca51.mp3" controls="controls"></audio> 
<p>ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬è®²äº†ä¸€ä¸ªè®¾å¤‡èƒ½å¤Ÿè¢«æ‰“å¼€ã€èƒ½å¤Ÿè¯»å†™ï¼Œä¸»æµçš„åŠŸèƒ½åŸºæœ¬å°±å®Œæˆäº†ã€‚æˆ‘ä»¬è®²è¾“å…¥è¾“å‡ºè®¾å¤‡çš„æ—¶å€™è¯´åˆ°ï¼Œå¦‚æœä¸€ä¸ªè®¾å¤‡æœ‰äº‹æƒ…éœ€è¦é€šçŸ¥æ“ä½œç³»ç»Ÿï¼Œä¼šé€šè¿‡ä¸­æ–­å’Œè®¾å¤‡é©±åŠ¨ç¨‹åºè¿›è¡Œäº¤äº’ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥è§£æä¸­æ–­å¤„ç†æœºåˆ¶ã€‚</p><p>é¼ æ ‡å°±æ˜¯é€šè¿‡ä¸­æ–­ï¼Œå°†è‡ªå·±çš„ä½ç½®å’ŒæŒ‰é”®ä¿¡æ¯ï¼Œä¼ é€’ç»™è®¾å¤‡é©±åŠ¨ç¨‹åºã€‚</p><pre><code>static int logibm_open(struct input_dev *dev)
{
	if (request_irq(logibm_irq, logibm_interrupt, 0, &quot;logibm&quot;, NULL)) {
		printk(KERN_ERR &quot;logibm.c: Can't allocate irq %d\n&quot;, logibm_irq);
		return -EBUSY;
	}
	outb(LOGIBM_ENABLE_IRQ, LOGIBM_CONTROL_PORT);
	return 0;
}


static irqreturn_t logibm_interrupt(int irq, void *dev_id)
{
	char dx, dy;
	unsigned char buttons;


	outb(LOGIBM_READ_X_LOW, LOGIBM_CONTROL_PORT);
	dx = (inb(LOGIBM_DATA_PORT) &amp; 0xf);
	outb(LOGIBM_READ_X_HIGH, LOGIBM_CONTROL_PORT);
	dx |= (inb(LOGIBM_DATA_PORT) &amp; 0xf) &lt;&lt; 4;
	outb(LOGIBM_READ_Y_LOW, LOGIBM_CONTROL_PORT);
	dy = (inb(LOGIBM_DATA_PORT) &amp; 0xf);
	outb(LOGIBM_READ_Y_HIGH, LOGIBM_CONTROL_PORT);
	buttons = inb(LOGIBM_DATA_PORT);
	dy |= (buttons &amp; 0xf) &lt;&lt; 4;
	buttons = ~buttons &gt;&gt; 5;


	input_report_rel(logibm_dev, REL_X, dx);
	input_report_rel(logibm_dev, REL_Y, dy);
	input_report_key(logibm_dev, BTN_RIGHT,  buttons &amp; 1);
	input_report_key(logibm_dev, BTN_MIDDLE, buttons &amp; 2);
	input_report_key(logibm_dev, BTN_LEFT,   buttons &amp; 4);
	input_sync(logibm_dev);


	outb(LOGIBM_ENABLE_IRQ, LOGIBM_CONTROL_PORT);
	return IRQ_HANDLED
</code></pre><p>è¦å¤„ç†ä¸­æ–­ï¼Œéœ€è¦æœ‰ä¸€ä¸ªä¸­æ–­å¤„ç†å‡½æ•°ã€‚å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code>irqreturn_t (*irq_handler_t)(int irq, void * dev_id);


/**
 * enum irqreturn
 * @IRQ_NONE		interrupt was not from this device or was not handled
 * @IRQ_HANDLED		interrupt was handled by this device
 * @IRQ_WAKE_THREAD	handler requests to wake the handler thread
 */
enum irqreturn {
	IRQ_NONE		= (0 &lt;&lt; 0),
	IRQ_HANDLED		= (1 &lt;&lt; 0),
	IRQ_WAKE_THREAD		= (1 &lt;&lt; 1),
};
</code></pre><p>å…¶ä¸­ï¼Œirqæ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œæ˜¯ä¸­æ–­ä¿¡å·ã€‚dev_idæ˜¯ä¸€ä¸ªvoid *çš„é€šç”¨æŒ‡é’ˆï¼Œä¸»è¦ç”¨äºåŒºåˆ†åŒä¸€ä¸ªä¸­æ–­å¤„ç†å‡½æ•°å¯¹äºä¸åŒè®¾å¤‡çš„å¤„ç†ã€‚</p><p>è¿™é‡Œçš„è¿”å›å€¼æœ‰ä¸‰ç§ï¼šIRQ_NONEè¡¨ç¤ºä¸æ˜¯æˆ‘çš„ä¸­æ–­ï¼Œä¸å½’æˆ‘ç®¡ï¼›IRQ_HANDLEDè¡¨ç¤ºå¤„ç†å®Œäº†çš„ä¸­æ–­ï¼›IRQ_WAKE_THREADè¡¨ç¤ºæœ‰ä¸€ä¸ªè¿›ç¨‹æ­£åœ¨ç­‰å¾…è¿™ä¸ªä¸­æ–­ï¼Œä¸­æ–­å¤„ç†å®Œäº†ï¼Œåº”è¯¥å”¤é†’å®ƒã€‚</p><p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œlogibm_interruptè¿™ä¸ªä¸­æ–­å¤„ç†å‡½æ•°ï¼Œå…ˆæ˜¯è·å–äº†xå’Œyçš„ç§»åŠ¨åæ ‡ï¼Œä»¥åŠå·¦ä¸­å³çš„æŒ‰é”®ï¼Œä¸ŠæŠ¥ä¸Šå»ï¼Œç„¶åè¿”å›IRQ_HANDLEDï¼Œè¿™è¡¨ç¤ºå¤„ç†å®Œæ¯•ã€‚</p><p>å…¶å®ï¼Œå†™ä¸€ä¸ªçœŸæ­£ç”Ÿäº§ç”¨çš„ä¸­æ–­å¤„ç†ç¨‹åºè¿˜æ˜¯å¾ˆå¤æ‚çš„ã€‚å½“ä¸€ä¸ªä¸­æ–­ä¿¡å·Aè§¦å‘åï¼Œæ­£åœ¨å¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªä¸­æ–­ä¿¡å·Aæ˜¯åº”è¯¥æš‚æ—¶å…³é—­çš„ï¼Œè¿™æ ·æ˜¯ä¸ºäº†é˜²æ­¢å†æ¥ä¸€ä¸ªä¸­æ–­ä¿¡å·Aï¼Œåœ¨å½“å‰çš„ä¸­æ–­ä¿¡å·Açš„å¤„ç†è¿‡ç¨‹ä¸­æ’ä¸€æ å­ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªæš‚æ—¶å…³é—­çš„æ—¶é—´åº”è¯¥å¤šé•¿å‘¢ï¼Ÿ</p><!-- [[[read_end]]] --><p>å¦‚æœå¤ªçŸ­äº†ï¼Œåº”è¯¥åŸå­åŒ–å¤„ç†å®Œæ¯•çš„æ²¡æœ‰å¤„ç†å®Œæ¯•ï¼Œåˆè¢«å¦ä¸€ä¸ªä¸­æ–­ä¿¡å·Aä¸­æ–­äº†ï¼Œå¾ˆå¤šæ“ä½œå°±ä¸æ­£ç¡®äº†ï¼›å¦‚æœå¤ªé•¿äº†ï¼Œä¸€ç›´å…³é—­ç€ï¼Œæ–°çš„ä¸­æ–­ä¿¡å·Aè¿›ä¸æ¥ï¼Œç³»ç»Ÿå°±æ˜¾å¾—å¾ˆæ…¢ã€‚æ‰€ä»¥ï¼Œå¾ˆå¤šä¸­æ–­å¤„ç†ç¨‹åºå°†æ•´ä¸ªä¸­æ–­è¦åšçš„äº‹æƒ…åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œç§°ä¸ºä¸ŠåŠéƒ¨å’Œä¸‹åŠéƒ¨ï¼Œæˆ–è€…æˆä¸ºå…³é”®å¤„ç†éƒ¨åˆ†å’Œå»¶è¿Ÿå¤„ç†éƒ¨åˆ†ã€‚åœ¨ä¸­æ–­å¤„ç†å‡½æ•°ä¸­ï¼Œä»…ä»…å¤„ç†å…³é”®éƒ¨åˆ†ï¼Œå®Œæˆäº†å°±å°†ä¸­æ–­ä¿¡å·æ‰“å¼€ï¼Œä½¿å¾—æ–°çš„ä¸­æ–­å¯ä»¥è¿›æ¥ï¼Œéœ€è¦æ¯”è¾ƒé•¿æ—¶é—´å¤„ç†çš„éƒ¨åˆ†ï¼Œä¹Ÿå³å»¶è¿Ÿéƒ¨åˆ†ï¼Œå¾€å¾€é€šè¿‡å·¥ä½œé˜Ÿåˆ—ç­‰æ–¹å¼æ…¢æ…¢å¤„ç†ã€‚</p><p>è¿™ä¸ªå†™èµ·æ¥å¯ä»¥æ˜¯ä¸€æœ¬ä¹¦äº†ï¼Œæ¨èä½ å¥½å¥½è¯»ä¸€è¯»ã€ŠLinux Device Driversã€‹è¿™æœ¬ä¹¦ï¼Œè¿™é‡Œæˆ‘å°±ä¸è¯¦ç»†ä»‹ç»äº†ã€‚</p><p>æœ‰äº†ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œæ¥ä¸‹æ¥è¦è°ƒç”¨request_irqæ¥æ³¨å†Œè¿™ä¸ªä¸­æ–­å¤„ç†å‡½æ•°ã€‚request_irqæœ‰è¿™æ ·å‡ ä¸ªå‚æ•°ï¼š</p><ul>
<li>unsigned int irqæ˜¯ä¸­æ–­ä¿¡å·ï¼›</li>
<li>irq_handler_t handleræ˜¯ä¸­æ–­å¤„ç†å‡½æ•°ï¼›</li>
<li>unsigned long flagsæ˜¯ä¸€äº›æ ‡è¯†ä½ï¼›</li>
<li>const char *nameæ˜¯è®¾å¤‡åç§°ï¼›</li>
<li>void *devè¿™ä¸ªé€šç”¨æŒ‡é’ˆåº”è¯¥å’Œä¸­æ–­å¤„ç†å‡½æ•°çš„void *devç›¸å¯¹åº”ã€‚</li>
</ul><pre><code>static inline int __must_check
request_irq(unsigned int irq, irq_handler_t handler, unsigned long flags, const char *name, void *dev)
{
	return request_threaded_irq(irq, handler, NULL, flags, name, dev);
}
</code></pre><p>ä¸­æ–­å¤„ç†å‡½æ•°è¢«æ³¨å†Œåˆ°å“ªé‡Œå»å‘¢ï¼Ÿè®©æˆ‘ä»¬æ²¿ç€request_irqçœ‹ä¸‹å»ã€‚request_irqè°ƒç”¨çš„æ˜¯request_threaded_irqã€‚ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>int request_threaded_irq(unsigned int irq, irq_handler_t handler,
			 irq_handler_t thread_fn, unsigned long irqflags,
			 const char *devname, void *dev_id)
{
	struct irqaction *action;
	struct irq_desc *desc;
	int retval;
......
	desc = irq_to_desc(irq);
......
	action = kzalloc(sizeof(struct irqaction), GFP_KERNEL);
	action-&gt;handler = handler;
	action-&gt;thread_fn = thread_fn;
	action-&gt;flags = irqflags;
	action-&gt;name = devname;
	action-&gt;dev_id = dev_id;
......
	retval = __setup_irq(irq, desc, action);
......
}
</code></pre><p>å¯¹äºæ¯ä¸€ä¸ªä¸­æ–­ï¼Œéƒ½æœ‰ä¸€ä¸ªå¯¹ä¸­æ–­çš„æè¿°ç»“æ„struct irq_descã€‚å®ƒæœ‰ä¸€ä¸ªé‡è¦çš„æˆå‘˜å˜é‡æ˜¯struct irqactionï¼Œç”¨äºè¡¨ç¤ºå¤„ç†è¿™ä¸ªä¸­æ–­çš„åŠ¨ä½œã€‚å¦‚æœæˆ‘ä»¬ä»”ç»†çœ‹è¿™ä¸ªç»“æ„ï¼Œä¼šå‘ç°ï¼Œå®ƒé‡Œé¢æœ‰nextæŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œå¯¹äºè¿™ä¸ªä¸­æ–­çš„æ‰€æœ‰å¤„ç†åŠ¨ä½œï¼Œéƒ½ä¸²åœ¨è¿™ä¸ªé“¾è¡¨ä¸Šã€‚</p><pre><code>struct irq_desc {
......
	struct irqaction	*action;	/* IRQ action list */
......
	struct module		*owner;
	const char		*name;
};


/**
 * struct irqaction - per interrupt action descriptor
 * @handler:	interrupt handler function
 * @name:	name of the device
 * @dev_id:	cookie to identify the device
 * @percpu_dev_id:	cookie to identify the device
 * @next:	pointer to the next irqaction for shared interrupts
 * @irq:	interrupt number
 * @flags:	flags (see IRQF_* above)
 * @thread_fn:	interrupt handler function for threaded interrupts
 * @thread:	thread pointer for threaded interrupts
 * @secondary:	pointer to secondary irqaction (force threading)
 * @thread_flags:	flags related to @thread
 * @thread_mask:	bitmask for keeping track of @thread activity
 * @dir:	pointer to the proc/irq/NN/name entry
 */
struct irqaction {
	irq_handler_t		handler;
	void			*dev_id;
	void __percpu		*percpu_dev_id;
	struct irqaction	*next;
	irq_handler_t		thread_fn;
	struct task_struct	*thread;
	struct irqaction	*secondary;
	unsigned int		irq;
	unsigned int		flags;
	unsigned long		thread_flags;
	unsigned long		thread_mask;
	const char		*name;
	struct proc_dir_entry	*dir;
};
</code></pre><p>æ¯ä¸€ä¸ªä¸­æ–­å¤„ç†åŠ¨ä½œçš„ç»“æ„struct irqactionï¼Œéƒ½æœ‰ä»¥ä¸‹æˆå‘˜ï¼š</p><ul>
<li>ä¸­æ–­å¤„ç†å‡½æ•°handlerï¼›</li>
<li>void *dev_idä¸ºè®¾å¤‡idï¼›</li>
<li>irqä¸ºä¸­æ–­ä¿¡å·ï¼›</li>
<li>å¦‚æœä¸­æ–­å¤„ç†å‡½æ•°åœ¨å•ç‹¬çš„çº¿ç¨‹è¿è¡Œï¼Œåˆ™æœ‰thread_fnæ˜¯çº¿ç¨‹çš„æ‰§è¡Œå‡½æ•°ï¼Œthreadæ˜¯çº¿ç¨‹çš„task_structã€‚</li>
</ul><p>åœ¨request_threaded_irqå‡½æ•°ä¸­ï¼Œirq_to_descæ ¹æ®ä¸­æ–­ä¿¡å·æŸ¥æ‰¾ä¸­æ–­æè¿°ç»“æ„ã€‚å¦‚ä½•æŸ¥æ‰¾å‘¢ï¼Ÿè¿™å°±è¦åŒºåˆ†æƒ…å†µã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„struct irq_descéƒ½æ”¾åœ¨ä¸€ä¸ªæ•°ç»„é‡Œé¢ï¼Œæˆ‘ä»¬ç›´æ¥æŒ‰ä¸‹æ ‡æŸ¥æ‰¾å°±å¯ä»¥äº†ã€‚å¦‚æœé…ç½®äº†CONFIG_SPARSE_IRQï¼Œé‚£ä¸­æ–­å·æ˜¯ä¸è¿ç»­çš„ï¼Œå°±ä¸é€‚åˆç”¨æ•°ç»„ä¿å­˜äº†ï¼Œ</p><p>æˆ‘ä»¬å¯ä»¥æ”¾åœ¨ä¸€æ£µåŸºæ•°æ ‘ä¸Šã€‚æˆ‘ä»¬ä¸æ˜¯ç¬¬ä¸€æ¬¡é‡åˆ°è¿™ä¸ªæ•°æ®ç»“æ„äº†ã€‚è¿™ç§ç»“æ„å¯¹äºä»æŸä¸ªæ•´å‹keyæ‰¾åˆ°valueé€Ÿåº¦å¾ˆå¿«ï¼Œä¸­æ–­ä¿¡å·irqæ˜¯è¿™ä¸ªæ•´æ•°ã€‚é€šè¿‡å®ƒï¼Œæˆ‘ä»¬å¾ˆå¿«å°±èƒ½å®šä½åˆ°å¯¹åº”çš„struct irq_descã€‚</p><pre><code>#ifdef CONFIG_SPARSE_IRQ
static RADIX_TREE(irq_desc_tree, GFP_KERNEL);
struct irq_desc *irq_to_desc(unsigned int irq)
{
	return radix_tree_lookup(&amp;irq_desc_tree, irq);
}
#else /* !CONFIG_SPARSE_IRQ */
struct irq_desc irq_desc[NR_IRQS] __cacheline_aligned_in_smp = {
	[0 ... NR_IRQS-1] = {
	}
};
struct irq_desc *irq_to_desc(unsigned int irq)
{
	return (irq &lt; NR_IRQS) ? irq_desc + irq : NULL;
}
#endif /* !CONFIG_SPARSE_IRQ */
</code></pre><p>ä¸ºä»€ä¹ˆä¸­æ–­ä¿¡å·ä¼šæœ‰ç¨€ç–ï¼Œä¹Ÿå°±æ˜¯ä¸è¿ç»­çš„æƒ…å†µå‘¢ï¼Ÿè¿™é‡Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œè¿™é‡Œçš„irqå¹¶ä¸æ˜¯çœŸæ­£çš„ã€ç‰©ç†çš„ä¸­æ–­ä¿¡å·ï¼Œè€Œæ˜¯ä¸€ä¸ªæŠ½è±¡çš„ã€è™šæ‹Ÿçš„ä¸­æ–­ä¿¡å·ã€‚å› ä¸ºç‰©ç†çš„ä¸­æ–­ä¿¡å·å’Œç¡¬ä»¶å…³è”æ¯”è¾ƒå¤§ï¼Œä¸­æ–­æ§åˆ¶å™¨ä¹Ÿæ˜¯å„ç§å„æ ·çš„ã€‚</p><p>ä½œä¸ºå†…æ ¸ï¼Œæˆ‘ä»¬ä¸å¯èƒ½å†™ç¨‹åºçš„æ—¶å€™ï¼Œé€‚é…å„ç§å„æ ·çš„ç¡¬ä»¶ä¸­æ–­æ§åˆ¶å™¨ï¼Œå› è€Œå°±éœ€è¦æœ‰ä¸€å±‚ä¸­æ–­æŠ½è±¡å±‚ã€‚è¿™é‡Œè™šæ‹Ÿä¸­æ–­ä¿¡å·åˆ°ä¸­æ–­æè¿°ç»“æ„çš„æ˜ å°„ï¼Œå°±æ˜¯æŠ½è±¡ä¸­æ–­å±‚çš„ä¸»è¦é€»è¾‘ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬è®²çœŸæ­£ä¸­æ–­å“åº”çš„æ—¶å€™ï¼Œä¼šæ¶‰åŠç‰©ç†ä¸­æ–­ä¿¡å·ã€‚å¯ä»¥æƒ³è±¡ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªCPUï¼Œä¸€ä¸ªä¸­æ–­æ§åˆ¶å™¨ï¼Œåˆ™åŸºæœ¬èƒ½å¤Ÿä¿è¯ä»ç‰©ç†ä¸­æ–­ä¿¡å·åˆ°è™šæ‹Ÿä¸­æ–­ä¿¡å·çš„æ˜ å°„æ˜¯çº¿æ€§çš„ï¼Œè¿™æ ·ç”¨æ•°ç»„è¡¨ç¤ºå°±æ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœæœ‰å¤šä¸ªCPUï¼Œå¤šä¸ªä¸­æ–­æ§åˆ¶å™¨ï¼Œæ¯ä¸ªä¸­æ–­æ§åˆ¶å™¨å„æœ‰å„çš„ç‰©ç†ä¸­æ–­ä¿¡å·ï¼Œå°±æ²¡åŠæ³•ä¿è¯è™šæ‹Ÿä¸­æ–­ä¿¡å·æ˜¯è¿ç»­çš„ï¼Œæ‰€ä»¥å°±è¦ç”¨åˆ°åŸºæ•°æ ‘äº†ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œrequest_threaded_irqå‡½æ•°åˆ†é…äº†ä¸€ä¸ªstruct irqactionï¼Œå¹¶ä¸”åˆå§‹åŒ–å®ƒï¼Œæ¥ç€è°ƒç”¨__setup_irqã€‚åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢ï¼Œå¦‚æœstruct irq_descé‡Œé¢å·²ç»æœ‰struct irqactionäº†ï¼Œæˆ‘ä»¬å°±å°†æ–°çš„struct irqactionæŒ‚åœ¨é“¾è¡¨çš„æœ«ç«¯ã€‚å¦‚æœè®¾å®šäº†ä»¥å•ç‹¬çš„çº¿ç¨‹è¿è¡Œä¸­æ–­å¤„ç†å‡½æ•°ï¼Œsetup_irq_threadå°±ä¼šåˆ›å»ºè¿™ä¸ªå†…æ ¸çº¿ç¨‹ï¼Œwake_up_processä¼šå”¤é†’å®ƒã€‚</p><pre><code>static int
__setup_irq(unsigned int irq, struct irq_desc *desc, struct irqaction *new)
{
	struct irqaction *old, **old_ptr;
	unsigned long flags, thread_mask = 0;
	int ret, nested, shared = 0;
......
	new-&gt;irq = irq;
......
	/*
	 * Create a handler thread when a thread function is supplied
	 * and the interrupt does not nest into another interrupt
	 * thread.
	 */
	if (new-&gt;thread_fn &amp;&amp; !nested) {
		ret = setup_irq_thread(new, irq, false);
	}
......
	old_ptr = &amp;desc-&gt;action;
	old = *old_ptr;
	if (old) {
		/* add new interrupt at end of irq queue */
		do {
			thread_mask |= old-&gt;thread_mask;
			old_ptr = &amp;old-&gt;next;
			old = *old_ptr;
		} while (old);
	}
......
	*old_ptr = new;
......
	if (new-&gt;thread)
		wake_up_process(new-&gt;thread);
......
}


static int
setup_irq_thread(struct irqaction *new, unsigned int irq, bool secondary)
{
	struct task_struct *t;
	struct sched_param param = {
		.sched_priority = MAX_USER_RT_PRIO/2,
	};


	t = kthread_create(irq_thread, new, &quot;irq/%d-%s&quot;, irq, new-&gt;name);
	sched_setscheduler_nocheck(t, SCHED_FIFO, &amp;param);
	get_task_struct(t);
	new-&gt;thread = t;
......
	return 0;
</code></pre><p>è‡³æ­¤ä¸ºæ­¢ï¼Œrequest_irqå®Œæˆäº†å®ƒçš„ä½¿å‘½ã€‚æ€»ç»“æ¥è¯´ï¼Œå®ƒå°±æ˜¯æ ¹æ®ä¸­æ–­ä¿¡å·irqï¼Œæ‰¾åˆ°åŸºæ•°æ ‘ä¸Šå¯¹åº”çš„irq_descï¼Œç„¶åå°†æ–°çš„irqactionæŒ‚åœ¨é“¾è¡¨ä¸Šã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ï¼ŒçœŸæ­£ä¸­æ–­æ¥äº†çš„æ—¶å€™ï¼Œä¼šå‘ç”Ÿä¸€äº›ä»€ä¹ˆã€‚</p><p>çœŸæ­£ä¸­æ–­çš„å‘ç”Ÿè¿˜æ˜¯è¦ä»ç¡¬ä»¶å¼€å§‹ã€‚è¿™é‡Œé¢æœ‰å››ä¸ªå±‚æ¬¡ã€‚</p><ul>
<li>ç¬¬ä¸€ä¸ªå±‚æ¬¡æ˜¯å¤–éƒ¨è®¾å¤‡ç»™ä¸­æ–­æ§åˆ¶å™¨å‘é€ç‰©ç†ä¸­æ–­ä¿¡å·ã€‚</li>
<li>ç¬¬äºŒä¸ªå±‚æ¬¡æ˜¯ä¸­æ–­æ§åˆ¶å™¨å°†ç‰©ç†ä¸­æ–­ä¿¡å·è½¬æ¢æˆä¸ºä¸­æ–­å‘é‡interrupt vectorï¼Œå‘ç»™å„ä¸ªCPUã€‚</li>
<li>ç¬¬ä¸‰ä¸ªå±‚æ¬¡æ˜¯æ¯ä¸ªCPUéƒ½ä¼šæœ‰ä¸€ä¸ªä¸­æ–­å‘é‡è¡¨ï¼Œæ ¹æ®interrupt vectorè°ƒç”¨ä¸€ä¸ªIRQå¤„ç†å‡½æ•°ã€‚æ³¨æ„è¿™é‡Œçš„IRQå¤„ç†å‡½æ•°è¿˜ä¸æ˜¯å’±ä»¬ä¸Šé¢æŒ‡å®šçš„irq_handler_tï¼Œåˆ°è¿™ä¸€å±‚è¿˜æ˜¯CPUç¡¬ä»¶çš„è¦æ±‚ã€‚</li>
<li>ç¬¬å››ä¸ªå±‚æ¬¡æ˜¯åœ¨IRQå¤„ç†å‡½æ•°ä¸­ï¼Œå°†interrupt vectorè½¬åŒ–ä¸ºæŠ½è±¡ä¸­æ–­å±‚çš„ä¸­æ–­ä¿¡å·irqï¼Œè°ƒç”¨ä¸­æ–­ä¿¡å·irqå¯¹åº”çš„ä¸­æ–­æè¿°ç»“æ„é‡Œé¢çš„irq_handler_tã€‚</li>
</ul><p><img src="https://static001.geekbang.org/resource/image/dd/13/dd492efdcf956cb22ce3d51592cdc113.png?wh=2074*1063" alt=""></p><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸è§£æç¡¬ä»¶çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä»CPUæ”¶åˆ°ä¸­æ–­å‘é‡å¼€å§‹åˆ†æã€‚</p><p>CPUæ”¶åˆ°çš„ä¸­æ–­å‘é‡æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿè¿™ä¸ªå®šä¹‰åœ¨æ–‡ä»¶arch/x86/include/asm/irq_vectors.hä¸­ã€‚è¿™é‡Œé¢çš„æ³¨é‡Šéå¸¸å¥½ï¼Œå»ºè®®ä½ ä»”ç»†é˜…è¯»ã€‚</p><pre><code>/*
 * Linux IRQ vector layout.
 *
 * There are 256 IDT entries (per CPU - each entry is 8 bytes) which can
 * be defined by Linux. They are used as a jump table by the CPU when a
 * given vector is triggered - by a CPU-external, CPU-internal or
 * software-triggered event.
 *
 * Linux sets the kernel code address each entry jumps to early during
 * bootup, and never changes them. This is the general layout of the
 * IDT entries:
 *
 *  Vectors   0 ...  31 : system traps and exceptions - hardcoded events
 *  Vectors  32 ... 127 : device interrupts
 *  Vector  128         : legacy int80 syscall interface
 *  Vectors 129 ... INVALIDATE_TLB_VECTOR_START-1 except 204 : device interrupts
 *  Vectors INVALIDATE_TLB_VECTOR_START ... 255 : special interrupts
 *
 * 64-bit x86 has per CPU IDT tables, 32-bit has one shared IDT table.
 *
 * This file enumerates the exact layout of them:
 */
#define FIRST_EXTERNAL_VECTOR		0x20
#define IA32_SYSCALL_VECTOR		0x80
#define NR_VECTORS			 256
#define FIRST_SYSTEM_VECTOR		NR_VECTORS
</code></pre><p>é€šè¿‡è¿™äº›æ³¨é‡Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒCPUèƒ½å¤Ÿå¤„ç†çš„ä¸­æ–­æ€»å…±256ä¸ªï¼Œç”¨å®NR_VECTORæˆ–è€…FIRST_SYSTEM_VECTORè¡¨ç¤ºã€‚</p><p>ä¸ºäº†å¤„ç†ä¸­æ–­ï¼ŒCPUç¡¬ä»¶è¦æ±‚æ¯ä¸€ä¸ªCPUéƒ½æœ‰ä¸€ä¸ªä¸­æ–­å‘é‡è¡¨ï¼Œé€šè¿‡load_idtåŠ è½½ï¼Œé‡Œé¢è®°å½•ç€æ¯ä¸€ä¸ªä¸­æ–­å¯¹åº”çš„å¤„ç†æ–¹æ³•ï¼Œè¿™ä¸ªä¸­æ–­å‘é‡è¡¨å®šä¹‰åœ¨æ–‡ä»¶arch/x86/kernel/traps.cä¸­ã€‚</p><pre><code>gate_desc idt_table[NR_VECTORS] __page_aligned_bss;
</code></pre><p>å¯¹äºä¸€ä¸ªCPUå¯ä»¥å¤„ç†çš„ä¸­æ–­è¢«åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†0åˆ°31çš„å‰32ä½æ˜¯ç³»ç»Ÿé™·å…¥æˆ–è€…ç³»ç»Ÿå¼‚å¸¸ï¼Œè¿™äº›é”™è¯¯æ— æ³•å±è”½ï¼Œä¸€å®šè¦å¤„ç†ã€‚</p><p>è¿™äº›ä¸­æ–­çš„å¤„ç†å‡½æ•°åœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™ï¼Œåœ¨start_kernelå‡½æ•°ä¸­è°ƒç”¨è¿‡trap_init()ã€‚è¿™ä¸ªå’±ä»¬è®²ç³»ç»Ÿåˆå§‹åŒ–å’Œç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ï¼Œéƒ½å¤§æ¦‚è®²è¿‡è¿™ä¸ªå‡½æ•°ï¼Œè¿™é‡Œè¿˜éœ€è¦ä»”ç»†çœ‹ä¸€ä¸‹ã€‚</p><pre><code>void __init trap_init(void)
{
	int i;
...
	set_intr_gate(X86_TRAP_DE, divide_error);
//å„ç§å„æ ·çš„set_intr_gateï¼Œä¸éƒ½è´´åœ¨è¿™é‡Œäº†ï¼Œåªè´´ä¸€å¤´ä¸€å°¾
...
	set_intr_gate(X86_TRAP_XF, simd_coprocessor_error);


	/* Reserve all the builtin and the syscall vector: */
	for (i = 0; i &lt; FIRST_EXTERNAL_VECTOR; i++)
		set_bit(i, used_vectors);


#ifdef CONFIG_X86_32
	set_system_intr_gate(IA32_SYSCALL_VECTOR, entry_INT80_32);
	set_bit(IA32_SYSCALL_VECTOR, used_vectors);
#endif


	/*
	 * Set the IDT descriptor to a fixed read-only location, so that the
	 * &quot;sidt&quot; instruction will not leak the location of the kernel, and
	 * to defend the IDT against arbitrary memory write vulnerabilities.
	 * It will be reloaded in cpu_init() */
	__set_fixmap(FIX_RO_IDT, __pa_symbol(idt_table), PAGE_KERNEL_RO);
	idt_descr.address = fix_to_virt(FIX_RO_IDT);
......
</code></pre><p>æˆ‘è¿™é‡Œè´´çš„ä»£ç çœç•¥äº†å¾ˆå¤šï¼Œåœ¨trap_initå‡½æ•°çš„ä¸€å¼€å§‹ï¼Œè°ƒç”¨äº†å¤§é‡çš„set_intr_gateï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨_set_gateï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code>static inline void _set_gate(int gate, unsigned type, void *addr,
			     unsigned dpl, unsigned ist, unsigned seg)
{
	gate_desc s;
	pack_gate(&amp;s, type, (unsigned long)addr, dpl, ist, seg);
	write_idt_entry(idt_table, gate, &amp;s);
}
</code></pre><p>ä»ä»£ç å¯ä»¥çœ‹å‡ºï¼Œset_intr_gateå…¶å®å°±æ˜¯å°†æ¯ä¸ªä¸­æ–­éƒ½è®¾ç½®äº†ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œæ”¾åœ¨ä¸­æ–­å‘é‡è¡¨idt_tableä¸­ã€‚</p><p>åœ¨trap_initä¸­ï¼Œç”±äºset_intr_gateè°ƒç”¨çš„å¤ªå¤šï¼Œå®¹æ˜“è®©äººçœ¼èŠ±ç¼­ä¹±ã€‚å…¶å®arch/x86/include/asm/traps.hæ–‡ä»¶ä¸­ï¼Œæ—©å°±å®šä¹‰å¥½äº†å‰32ä¸ªä¸­æ–­ã€‚å¦‚æœä»”ç»†å¯¹æ¯”ä¸€ä¸‹ï¼Œä½ ä¼šå‘ç°ï¼Œè¿™äº›éƒ½åœ¨trap_initä¸­ä½¿ç”¨set_intr_gateè®¾ç½®è¿‡äº†ã€‚</p><pre><code>/* Interrupts/Exceptions */
enum {
	X86_TRAP_DE = 0,	/*  0, Divide-by-zero */
	X86_TRAP_DB,		/*  1, Debug */
	X86_TRAP_NMI,		/*  2, Non-maskable Interrupt */
	X86_TRAP_BP,		/*  3, Breakpoint */
	X86_TRAP_OF,		/*  4, Overflow */
	X86_TRAP_BR,		/*  5, Bound Range Exceeded */
	X86_TRAP_UD,		/*  6, Invalid Opcode */
	X86_TRAP_NM,		/*  7, Device Not Available */
	X86_TRAP_DF,		/*  8, Double Fault */
	X86_TRAP_OLD_MF,	/*  9, Coprocessor Segment Overrun */
	X86_TRAP_TS,		/* 10, Invalid TSS */
	X86_TRAP_NP,		/* 11, Segment Not Present */
	X86_TRAP_SS,		/* 12, Stack Segment Fault */
	X86_TRAP_GP,		/* 13, General Protection Fault */
	X86_TRAP_PF,		/* 14, Page Fault */
	X86_TRAP_SPURIOUS,	/* 15, Spurious Interrupt */
	X86_TRAP_MF,		/* 16, x87 Floating-Point Exception */
	X86_TRAP_AC,		/* 17, Alignment Check */
	X86_TRAP_MC,		/* 18, Machine Check */
	X86_TRAP_XF,		/* 19, SIMD Floating-Point Exception */
	X86_TRAP_IRET = 32,	/* 32, IRET Exception */
};
</code></pre><p>æˆ‘ä»¬å›åˆ°trap_initä¸­ï¼Œå½“å‰32ä¸ªä¸­æ–­éƒ½ç”¨set_intr_gateè®¾ç½®å®Œæ¯•ã€‚åœ¨ä¸­æ–­å‘é‡è¡¨idt_tableä¸­å¡«å®Œäº†ä¹‹åï¼Œæ¥ä¸‹æ¥çš„forå¾ªç¯ï¼Œfor (i = 0; i &lt; FIRST_EXTERNAL_VECTOR; i++)ï¼Œå°†å‰32ä¸ªä¸­æ–­éƒ½åœ¨used_vectorsä¸­æ ‡è®°ä¸º1ï¼Œè¡¨ç¤ºè¿™äº›éƒ½è®¾ç½®è¿‡ä¸­æ–­å¤„ç†å‡½æ•°äº†ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œtrap_initå•ç‹¬è°ƒç”¨set_intr_gateæ¥è®¾ç½®32ä½ç³»ç»Ÿè°ƒç”¨çš„ä¸­æ–­ã€‚IA32_SYSCALL_VECTORï¼Œä¹Ÿå³128ï¼Œå•ç‹¬å°†used_vectorsä¸­çš„ç¬¬128ä½æ ‡è®°ä¸º1ã€‚</p><p>åœ¨trap_initçš„æœ€åï¼Œæˆ‘ä»¬å°†idt_tableæ”¾åœ¨ä¸€ä¸ªå›ºå®šçš„è™šæ‹Ÿåœ°å€ä¸Šã€‚trap_initç»“æŸåï¼Œä¸­æ–­å‘é‡è¡¨ä¸­å·²ç»å¡«å¥½äº†å‰32ä½ï¼Œå¤–åŠ ä¸€ä½32ä½ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶ä»–çš„éƒ½æ˜¯ç”¨äºè®¾å¤‡ä¸­æ–­ã€‚</p><p>åœ¨start_kernelè°ƒç”¨å®Œæ¯•trap_initä¹‹åï¼Œè¿˜ä¼šè°ƒç”¨init_IRQ()æ¥åˆå§‹åŒ–å…¶ä»–çš„è®¾å¤‡ä¸­æ–­ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°native_init_IRQã€‚</p><pre><code>void __init native_init_IRQ(void)
{
	int i;
	i = FIRST_EXTERNAL_VECTOR;
#ifndef CONFIG_X86_LOCAL_APIC
#define first_system_vector NR_VECTORS
#endif
	for_each_clear_bit_from(i, used_vectors, first_system_vector) {
		/* IA32_SYSCALL_VECTOR could be used in trap_init already. */
		set_intr_gate(i, irq_entries_start +
				8 * (i - FIRST_EXTERNAL_VECTOR));
	}
......
}
</code></pre><p>è¿™é‡Œé¢ä»ç¬¬32ä¸ªä¸­æ–­å¼€å§‹ï¼Œåˆ°æœ€åNR_VECTORSä¸ºæ­¢ï¼Œå¯¹äºused_vectorsä¸­æ²¡æœ‰æ ‡è®°ä¸º1çš„ä½ç½®ï¼Œéƒ½ä¼šè°ƒç”¨set_intr_gateè®¾ç½®ä¸­æ–­å‘é‡è¡¨ã€‚</p><p>å…¶å®used_vectorsä¸­æ²¡æœ‰æ ‡è®°ä¸º1çš„ï¼Œéƒ½æ˜¯è®¾å¤‡ä¸­æ–­çš„éƒ¨åˆ†ã€‚</p><p>ä¹Ÿå³æ‰€æœ‰çš„è®¾å¤‡ä¸­æ–­çš„ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œåœ¨ä¸­æ–­å‘é‡è¡¨é‡Œé¢éƒ½ä¼šè®¾ç½®ä¸ºä»irq_entries_startå¼€å§‹ï¼Œåç§»é‡ä¸ºi - FIRST_EXTERNAL_VECTORçš„ä¸€é¡¹ã€‚</p><p>çœ‹æ¥ä¸­æ–­å¤„ç†å‡½æ•°æ˜¯å®šä¹‰åœ¨irq_entries_startè¿™ä¸ªè¡¨é‡Œé¢çš„ï¼Œæˆ‘ä»¬åœ¨arch\x86\entry\entry_32.Så’Œarch\x86\entry\entry_64.Séƒ½èƒ½æ‰¾åˆ°è¿™ä¸ªå‡½æ•°è¡¨çš„å®šä¹‰ã€‚</p><p>è¿™åˆæ˜¯æ±‡ç¼–è¯­è¨€ï¼Œä¸éœ€è¦å®Œå…¨çœ‹æ‡‚ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯èƒ½çœ‹å‡ºæ¥ï¼Œè¿™é‡Œé¢å®šä¹‰äº†FIRST_SYSTEM_VECTOR - FIRST_EXTERNAL_VECTORé¡¹ã€‚æ¯ä¸€é¡¹éƒ½æ˜¯ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œä¼šè·³åˆ°common_interruptå»æ‰§è¡Œã€‚è¿™é‡Œä¼šæœ€ç»ˆè°ƒç”¨do_IRQï¼Œè°ƒç”¨å®Œæ¯•åï¼Œå°±ä»ä¸­æ–­è¿”å›ã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦åŒºåˆ†è¿”å›ç”¨æˆ·æ€è¿˜æ˜¯å†…æ ¸æ€ã€‚è¿™é‡Œä¼šæœ‰ä¸€ä¸ªæœºä¼šè§¦å‘æŠ¢å ï¼Œå’±ä»¬è®²è¿›ç¨‹åˆ‡æ¢çš„æ—¶å€™è®²è¿‡çš„ã€‚</p><pre><code>ENTRY(irq_entries_start)
    vector=FIRST_EXTERNAL_VECTOR
    .rept (FIRST_SYSTEM_VECTOR - FIRST_EXTERNAL_VECTOR)
	pushl	$(~vector+0x80)			/* Note: always in signed byte range */
    vector=vector+1
	jmp	common_interrupt /* ä¼šè°ƒç”¨åˆ°do_IRQ */
	.align	8
    .endr
END(irq_entries_start)


common_interrupt:
	ASM_CLAC
	addq	$-0x80, (%rsp)			/* Adjust vector to [-256, -1] range */
	interrupt do_IRQ
	/* 0(%rsp): old RSP */
ret_from_intr:
......
	/* Interrupt came from user space */
GLOBAL(retint_user)
......
/* Returning to kernel space */
retint_kernel:
......
</code></pre><p>è¿™æ ·ä»»ä½•ä¸€ä¸ªä¸­æ–­å‘é‡åˆ°è¾¾ä»»ä½•ä¸€ä¸ªCPUï¼Œæœ€ç»ˆéƒ½ä¼šèµ°åˆ°do_IRQã€‚æˆ‘ä»¬æ¥çœ‹do_IRQçš„å®ç°ã€‚</p><pre><code>/*
 * do_IRQ handles all normal device IRQ's (the special
 * SMP cross-CPU interrupts have their own specific
 * handlers).
 */
__visible unsigned int __irq_entry do_IRQ(struct pt_regs *regs)
{
	struct pt_regs *old_regs = set_irq_regs(regs);
	struct irq_desc * desc;
	/* high bit used in ret_from_ code  */
	unsigned vector = ~regs-&gt;orig_ax;
......
	desc = __this_cpu_read(vector_irq[vector]);
	if (!handle_irq(desc, regs)) {
......
	}
......
	set_irq_regs(old_regs);
	return 1;
}
</code></pre><p>åœ¨è¿™é‡Œé¢ï¼Œä»AXå¯„å­˜å™¨é‡Œé¢æ‹¿åˆ°äº†ä¸­æ–­å‘é‡vectorï¼Œä½†æ˜¯åˆ«å¿˜äº†ä¸­æ–­æ§åˆ¶å™¨å‘é€ç»™æ¯ä¸ªCPUçš„ä¸­æ–­å‘é‡éƒ½æ˜¯æ¯ä¸ªCPUå±€éƒ¨çš„ï¼Œè€ŒæŠ½è±¡ä¸­æ–­å¤„ç†å±‚çš„è™šæ‹Ÿä¸­æ–­ä¿¡å·irqä»¥åŠå®ƒå¯¹åº”çš„ä¸­æ–­æè¿°ç»“æ„irq_descæ˜¯å…¨å±€çš„ï¼Œä¹Ÿå³è¿™ä¸ªCPUçš„200å·çš„ä¸­æ–­å‘é‡å’Œå¦ä¸€ä¸ªCPUçš„200å·ä¸­æ–­å‘é‡å¯¹åº”çš„è™šæ‹Ÿä¸­æ–­ä¿¡å·irqå’Œä¸­æ–­æè¿°ç»“æ„irq_descå¯èƒ½ä¸ä¸€æ ·ï¼Œè¿™å°±éœ€è¦ä¸€ä¸ªæ˜ å°„å…³ç³»ã€‚è¿™ä¸ªæ˜ å°„å…³ç³»æ”¾åœ¨Per CPUå˜é‡vector_irqé‡Œé¢ã€‚</p><pre><code>DECLARE_PER_CPU(vector_irq_t, vector_irq);
</code></pre><p>åœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨__assign_irq_vectorï¼Œå°†è™šæ‹Ÿä¸­æ–­ä¿¡å·irqåˆ†é…åˆ°æŸä¸ªCPUä¸Šçš„ä¸­æ–­å‘é‡ã€‚</p><pre><code>static int __assign_irq_vector(int irq, struct apic_chip_data *d,
			       const struct cpumask *mask,
			       struct irq_data *irqdata)
{
	static int current_vector = FIRST_EXTERNAL_VECTOR + VECTOR_OFFSET_START;
	static int current_offset = VECTOR_OFFSET_START % 16;
	int cpu, vector;
......
	while (cpu &lt; nr_cpu_ids) {
		int new_cpu, offset;
......
		vector = current_vector;
		offset = current_offset;
next:
		vector += 16;
		if (vector &gt;= first_system_vector) {
			offset = (offset + 1) % 16;
			vector = FIRST_EXTERNAL_VECTOR + offset;
		}


		/* If the search wrapped around, try the next cpu */
		if (unlikely(current_vector == vector))
			goto next_cpu;




		if (test_bit(vector, used_vectors))
			goto next;


......
		/* Found one! */
		current_vector = vector;
		current_offset = offset;
		/* Schedule the old vector for cleanup on all cpus */
		if (d-&gt;cfg.vector)
			cpumask_copy(d-&gt;old_domain, d-&gt;domain);
		for_each_cpu(new_cpu, vector_searchmask)
			per_cpu(vector_irq, new_cpu)[vector] = irq_to_desc(irq);
		goto update;


next_cpu:
		cpumask_or(searched_cpumask, searched_cpumask, vector_cpumask);
		cpumask_andnot(vector_cpumask, mask, searched_cpumask);
		cpu = cpumask_first_and(vector_cpumask, cpu_online_mask);
		continue;
	}
....
</code></pre><p>åœ¨è¿™é‡Œï¼Œä¸€æ—¦æ‰¾åˆ°æŸä¸ªå‘é‡ï¼Œå°±å°†CPUçš„æ­¤å‘é‡å¯¹åº”çš„å‘é‡æè¿°ç»“æ„irq_descï¼Œè®¾ç½®ä¸ºè™šæ‹Ÿä¸­æ–­ä¿¡å·irqå¯¹åº”çš„å‘é‡æè¿°ç»“æ„irq_to_desc(irq)ã€‚</p><p>è¿™æ ·do_IRQä¼šæ ¹æ®ä¸­æ–­å‘é‡vectorå¾—åˆ°å¯¹åº”çš„irq_descï¼Œç„¶åè°ƒç”¨handle_irqã€‚handle_irqä¼šè°ƒç”¨generic_handle_irq_descï¼Œé‡Œé¢è°ƒç”¨irq_descçš„handle_irqã€‚</p><pre><code>static inline void generic_handle_irq_desc(struct irq_desc *desc)
{
	desc-&gt;handle_irq(desc);
}
</code></pre><p>è¿™é‡Œçš„handle_irqï¼Œæœ€ç»ˆä¼šè°ƒç”¨__handle_irq_event_percpuã€‚ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>irqreturn_t __handle_irq_event_percpu(struct irq_desc *desc, unsigned int *flags)
{
	irqreturn_t retval = IRQ_NONE;
	unsigned int irq = desc-&gt;irq_data.irq;
	struct irqaction *action;


	record_irq_time(desc);


	for_each_action_of_desc(desc, action) {
		irqreturn_t res;
		res = action-&gt;handler(irq, action-&gt;dev_id);
		switch (res) {
		case IRQ_WAKE_THREAD:
			__irq_wake_thread(desc, action);
		case IRQ_HANDLED:
			*flags |= action-&gt;flags;
			break;
		default:
			break;
		}
		retval |= res;
	}
	return retval;
</code></pre><p>__handle_irq_event_percpué‡Œé¢è°ƒç”¨äº†irq_descé‡Œæ¯ä¸ªhanderï¼Œè¿™äº›handeræ˜¯æˆ‘ä»¬åœ¨æ‰€æœ‰actionåˆ—è¡¨ä¸­æ³¨å†Œçš„ï¼Œè¿™æ‰æ˜¯æˆ‘ä»¬è®¾ç½®çš„é‚£ä¸ªä¸­æ–­å¤„ç†å‡½æ•°ã€‚å¦‚æœè¿”å›å€¼æ˜¯IRQ_HANDLEDï¼Œå°±è¯´æ˜å¤„ç†å®Œæ¯•ï¼›å¦‚æœè¿”å›å€¼æ˜¯IRQ_WAKE_THREADå°±å”¤é†’çº¿ç¨‹ã€‚</p><p>è‡³æ­¤ï¼Œä¸­æ–­çš„æ•´ä¸ªè¿‡ç¨‹å°±ç»“æŸäº†ã€‚</p><h2>æ€»ç»“æ—¶åˆ»</h2><p>è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬è®²äº†ä¸­æ–­çš„æ•´ä¸ªå¤„ç†è¿‡ç¨‹ã€‚ä¸­æ–­æ˜¯ä»å¤–éƒ¨è®¾å¤‡å‘èµ·çš„ï¼Œä¼šå½¢æˆå¤–éƒ¨ä¸­æ–­ã€‚å¤–éƒ¨ä¸­æ–­ä¼šåˆ°è¾¾ä¸­æ–­æ§åˆ¶å™¨ï¼Œä¸­æ–­æ§åˆ¶å™¨ä¼šå‘é€ä¸­æ–­å‘é‡Interrupt Vectorç»™CPUã€‚</p><p>å¯¹äºæ¯ä¸€ä¸ªCPUï¼Œéƒ½è¦æ±‚æœ‰ä¸€ä¸ªidt_tableï¼Œé‡Œé¢å­˜æ”¾äº†ä¸åŒçš„ä¸­æ–­å‘é‡çš„å¤„ç†å‡½æ•°ã€‚ä¸­æ–­å‘é‡è¡¨ä¸­å·²ç»å¡«å¥½äº†å‰32ä½ï¼Œå¤–åŠ ä¸€ä½32ä½ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶ä»–çš„éƒ½æ˜¯ç”¨äºè®¾å¤‡ä¸­æ–­ã€‚</p><p>ç¡¬ä»¶ä¸­æ–­çš„å¤„ç†å‡½æ•°æ˜¯do_IRQè¿›è¡Œç»Ÿä¸€å¤„ç†ï¼Œåœ¨è¿™é‡Œä¼šè®©ä¸­æ–­å‘é‡ï¼Œé€šè¿‡vector_irqæ˜ å°„ä¸ºirq_descã€‚</p><p>irq_descæ˜¯ä¸€ä¸ªç”¨äºæè¿°ç”¨æˆ·æ³¨å†Œçš„ä¸­æ–­å¤„ç†å‡½æ•°çš„ç»“æ„ï¼Œä¸ºäº†èƒ½å¤Ÿæ ¹æ®ä¸­æ–­å‘é‡å¾—åˆ°irq_descç»“æ„ï¼Œä¼šæŠŠè¿™äº›ç»“æ„æ”¾åœ¨ä¸€ä¸ªåŸºæ•°æ ‘é‡Œé¢ï¼Œæ–¹ä¾¿æŸ¥æ‰¾ã€‚</p><p>irq_descé‡Œé¢æœ‰ä¸€ä¸ªæˆå‘˜æ˜¯irqactionï¼ŒæŒ‡å‘è®¾å¤‡é©±åŠ¨ç¨‹åºé‡Œé¢æ³¨å†Œçš„ä¸­æ–­å¤„ç†å‡½æ•°ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/26/8f/26bde4fa2279f66098856c5b2b6d308f.png?wh=2563*2233" alt=""></p><h2>è¯¾å ‚ç»ƒä¹ </h2><p>ä½ çŸ¥é“å¦‚ä½•æŸ¥çœ‹æ¯ä¸ªCPUéƒ½æ”¶åˆ°äº†å“ªäº›ä¸­æ–­å—ï¼Ÿ</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„ç–‘æƒ‘å’Œè§è§£ ï¼Œä¹Ÿæ¬¢è¿å¯ä»¥æ”¶è—æœ¬èŠ‚å†…å®¹ï¼Œåå¤ç ”è¯»ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·å­¦ä¹ å’Œè¿›æ­¥ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/8c/37/8c0a95fa07a8b9a1abfd394479bdd637.jpg?wh=1110*659" alt=""></p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/4a/2c/f8451d77.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>çŸ³ç»´åº·</span>
  </div>
  <div class="_2_QraFYR_0">cat &#47;proc&#47;interrupts</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-06-12 10:16:17</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLh73kPzAKhz7YxUribqF6QKFiahhVAbwpgVLSRicA68c6ZFA7vUBJY1ves3LVvibrypROyI7awv47eSA/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ZYecho</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆæ‚¨å¥½ï¼Œç¬¬äºŒä¸ªå±‚æ¬¡æ˜¯ä¸­æ–­æ§åˆ¶å™¨å°†ç‰©ç†ä¸­æ–­ä¿¡å·è½¬æ¢æˆä¸ºä¸­æ–­å‘é‡ intå‘é€ç»™å„ä¸ªcpuï¼Œæƒ³è¯·æ•™ä¸€ä¸‹ å¦‚æœè¿™ä¸ªåœ°æ–¹æ¯ä¸ªcpuéƒ½æ”¶åˆ°ä¸­æ–­åï¼Œå¦‚æœä¿è¯è¿™ä¸ªä¸­æ–­åªä¼šè¢«å¤„ç†ä¸€æ¬¡ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-09-12 10:14:03</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/15/f2/c0/bf148d4f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>è¥¿å±±è–„å‡‰</span>
  </div>
  <div class="_2_QraFYR_0">è¯¾ä»£è¡¨åœ¨è¿™é‡Œã€‚<br>- è®¾å¤‡ä¸­æ–­å¤„ç†<br>    - å®šä¹‰ä¸­æ–­å¤„ç†å‡½æ•°:irq_handler_t<br>        - å‡½æ•°å…¥å‚<br>            - int irq:ä¸­æ–­ä¿¡å·<br>            - void * dev_id:é€šç”¨æŒ‡é’ˆï¼Œä¸»è¦ç”¨äºåŒºåˆ†åŒä¸€ä¸ªä¸­æ–­å¤„ç†å‡½æ•°å¯¹äºä¸åŒè®¾å¤‡çš„å¤„ç†<br>        - è¿”å›å€¼<br>            - IRQ_NONE:è®¾å¤‡ä¸æ˜¯ä¸­æ–­æ¥æ”¶è€…<br>            - IRQ_HANDLED:å¤„ç†å®Œäº†çš„ä¸­æ–­<br>            - IRQ_WAKE_THREAD:æœ‰ä¸€ä¸ªè¿›ç¨‹æ­£åœ¨ç­‰å¾…è¿™ä¸ªä¸­æ–­ï¼Œä¸­æ–­å¤„ç†å®Œäº†ï¼Œåº”è¯¥å”¤é†’å®ƒ<br>        - å¾ˆå¤šä¸­æ–­å¤„ç†ç¨‹åºå°†æ•´ä¸ªä¸­æ–­è¦åšçš„äº‹æƒ…åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œç§°ä¸ºä¸ŠåŠéƒ¨å’Œä¸‹åŠéƒ¨ï¼Œæˆ–è€…æˆä¸ºå…³é”®å¤„ç†éƒ¨åˆ†å’Œå»¶è¿Ÿå¤„ç†éƒ¨åˆ†ã€‚åœ¨ä¸­æ–­å¤„ç†å‡½æ•°ä¸­ï¼Œä»…ä»…å¤„ç†å…³é”®éƒ¨åˆ†ï¼Œå®Œæˆäº†å°±å°†ä¸­æ–­ä¿¡å·æ‰“å¼€ï¼Œä½¿å¾—æ–°çš„ä¸­æ–­å¯ä»¥è¿›æ¥ï¼Œéœ€è¦æ¯”è¾ƒé•¿æ—¶é—´å¤„ç†çš„éƒ¨åˆ†ï¼Œä¹Ÿå³å»¶è¿Ÿéƒ¨åˆ†ï¼Œå¾€å¾€é€šè¿‡å·¥ä½œé˜Ÿåˆ—ç­‰æ–¹å¼æ…¢æ…¢å¤„ç†ã€‚<br>    - æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°:request_irq<br>        - å‡½æ•°å…¥å‚<br>            - unsigned int irq æ˜¯ä¸­æ–­ä¿¡å·<br>            - irq_handler_t handler æ˜¯ä¸­æ–­å¤„ç†å‡½æ•°<br>            - unsigned long flags æ˜¯ä¸€äº›æ ‡è¯†ä½<br>            - const char *name æ˜¯è®¾å¤‡åç§°<br>            - void *dev è¿™ä¸ªé€šç”¨æŒ‡é’ˆåº”è¯¥å’Œä¸­æ–­å¤„ç†å‡½æ•°çš„ void *dev ç›¸å¯¹åº”<br>        - åˆå§‹åŒ–æè¿°ä¸­æ–­çš„ç»“æ„ä½“ irq_descï¼Œå…¶ä¸­ struct irqactionï¼Œç”¨äºè¡¨ç¤ºå¤„ç†è¿™ä¸ªä¸­æ–­çš„åŠ¨ä½œï¼Œirqaction éƒ½æœ‰ä»¥ä¸‹æˆå‘˜<br>            - ä¸­æ–­å¤„ç†å‡½æ•° handler<br>            - void *dev_id ä¸ºè®¾å¤‡ id<br>            - irq ä¸ºä¸­æ–­ä¿¡å·<br>            - next ä¸ºæŒ‡å‘ä¸‹ä¸€ä¸ª action çš„é“¾è¡¨æŒ‡é’ˆ<br>            - å¦‚æœä¸­æ–­å¤„ç†å‡½æ•°åœ¨å•ç‹¬çš„çº¿ç¨‹è¿è¡Œï¼Œåˆ™æœ‰ thread_fn æ˜¯çº¿ç¨‹çš„æ‰§è¡Œå‡½æ•°ï¼Œthread æ˜¯çº¿ç¨‹çš„ task_struct<br>            - irpaction çš„å­˜å‚¨æ•°æ®ç»“æ„é€šè¿‡å® CONFIG_SPARSE_IRQ é…ç½®<br>                - å¦‚æœä¸ºè¿ç»­ä¸‹æ ‡åˆ™ä½¿ç”¨æ•°ç»„<br>                - å¦‚æœä¸ºä¸è¿ç»­ä¸‹æ ‡åˆ™ä½¿ç”¨åŸºæ•°æ ‘<br>            - irq å¹¶ä¸æ˜¯çœŸæ­£çš„ã€ç‰©ç†çš„ä¸­æ–­ä¿¡å·ï¼Œè€Œæ˜¯ä¸€ä¸ªæŠ½è±¡çš„ã€è™šæ‹Ÿçš„ä¸­æ–­ä¿¡å·<br>        - å†…éƒ¨è°ƒç”¨ request_threaded_irq-&gt;__setup_irq<br>            - æŸ¥æ‰¾ irq_desc æ˜¯å¦å·²ç»æœ‰ irqaction<br>            - irq æœ‰ä¸€ä¸ª next çš„å‚æ•°ï¼Œå¦‚æœå·²ç»æœ‰åŒç±»çš„ actionï¼Œåˆ™å°†å…¶æŒ‚åœ¨é“¾è¡¨æœ«å°¾<br>        - å¦‚æœè®¾å®šäº†ä»¥å•ç‹¬çš„çº¿ç¨‹è¿è¡Œä¸­æ–­å¤„ç†å‡½æ•°ï¼Œsetup_irq_thread å°±ä¼šåˆ›å»ºè¿™ä¸ªå†…æ ¸çº¿ç¨‹ï¼Œwake_up_process ä¼šå”¤é†’å®ƒ<br>    - ä¸­æ–­å¤„ç†æµç¨‹<br>        - å¤–éƒ¨è®¾å¤‡ç»™ä¸­æ–­æ§åˆ¶å™¨å‘é€ç‰©ç†ä¸­æ–­ä¿¡å·<br>        - ä¸­æ–­æ§åˆ¶å™¨å°†ç‰©ç†ä¸­æ–­ä¿¡å·è½¬æ¢æˆä¸ºä¸­æ–­å‘é‡ interrupt vectorï¼Œå‘ç»™å„ä¸ª CPU<br>        - æ¯ä¸ª CPU éƒ½ä¼šæœ‰ä¸€ä¸ªä¸­æ–­å‘é‡è¡¨ï¼Œæ ¹æ® interrupt vector è°ƒç”¨ä¸€ä¸ª IRQ å¤„ç†å‡½æ•°ã€‚æ³¨æ„è¿™é‡Œçš„ IRQ å¤„ç†å‡½æ•°è¿˜ä¸æ˜¯å’±ä»¬ä¸Šé¢æŒ‡å®šçš„ irq_handler_tï¼Œåˆ°è¿™ä¸€å±‚è¿˜æ˜¯ CPU ç¡¬ä»¶çš„è¦æ±‚<br>        - åœ¨ IRQ å¤„ç†å‡½æ•°ä¸­ï¼Œå°† interrupt vector è½¬åŒ–ä¸ºæŠ½è±¡ä¸­æ–­å±‚çš„ä¸­æ–­ä¿¡å· irqï¼Œè°ƒç”¨ä¸­æ–­ä¿¡å· irq å¯¹åº”çš„ä¸­æ–­æè¿°ç»“æ„é‡Œé¢çš„ irq_handler_t<br>    </div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-03-01 10:30:54</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/15/f2/c0/bf148d4f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>è¥¿å±±è–„å‡‰</span>
  </div>
  <div class="_2_QraFYR_0">ä¸‹åŠéƒ¨åˆ†-----<br>- ç¡¬ä»¶ ä¸­æ–­å¤„ç†<br>        - CPU èƒ½å¤Ÿå¤„ç†çš„ä¸­æ–­æ€»å…± 256 ä¸ªï¼Œç”¨å® NR_VECTOR æˆ–è€… FIRST_SYSTEM_VECTOR è¡¨ç¤º<br>        - CPU ç¡¬ä»¶è¦æ±‚æ¯ä¸€ä¸ª CPU éƒ½æœ‰ä¸€ä¸ªä¸­æ–­å‘é‡è¡¨ idt_tableï¼Œé€šè¿‡ load_idt åŠ è½½ï¼Œé‡Œé¢è®°å½•ç€æ¯ä¸€ä¸ªä¸­æ–­å¯¹åº”çš„å¤„ç†å‡½æ•°<br>        - ä¸­æ–­è¢«åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†<br>            - 0 åˆ° 31 çš„å‰ 32 ä½æ˜¯ç³»ç»Ÿé™·å…¥æˆ–è€…ç³»ç»Ÿå¼‚å¸¸ï¼Œè¿™äº›é”™è¯¯æ— æ³•å±è”½ï¼Œä¸€å®šè¦å¤„ç†ï¼›ä¸­æ–­å‘é‡è¡¨ä¸­å·²ç»å¡«å¥½äº†å‰ 32 ä½ï¼Œå¤–åŠ ä¸€ä½ 32 ä½ç³»ç»Ÿè°ƒç”¨<br>            - å…¶ä»–çš„éƒ½æ˜¯ç”¨äºè®¾å¤‡ä¸­æ–­<br>        - ç¡¬ä»¶ä¸­æ–­çš„å¤„ç†å‡½æ•°æ˜¯ do_IRQ è¿›è¡Œç»Ÿä¸€å¤„ç†ï¼Œåœ¨è¿™é‡Œä¼šè®©ä¸­æ–­å‘é‡ï¼Œé€šè¿‡ vector_irq æ˜ å°„ä¸º irq_desc<br>        - æ‰¾åˆ°æ³¨å†Œçš„ä¸­æ–­å¤„ç† action å¹¶æ‰§è¡Œ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-03-01 10:31:05</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/16/11/e7/044a9a6c.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>bookå°¾æ±</span>
  </div>
  <div class="_2_QraFYR_0">æ€»ç»“ä¸‹:<br>ç³»ç»Ÿæœ‰256ä¸ªä¸­æ–­å‘é‡,å®šä¹‰åœ¨ä¸­æ–­å‘é‡è¡¨ä¸­,å…¶ä¸­å‰32ä½[0-31]ç”¨äºç³»ç»Ÿè‡ªèº«çš„å†…éƒ¨ä¸­æ–­,ç¬¬32ä½ç”¨äº32ä½ä¸­æ–­(?),å‰©ä½™ç”¨ä»¥è®¾å¤‡ä¸­æ–­,è¿™æ˜¯ç¡¬ä»¶çš„ä¸­æ–­å‘é‡è¡¨,è¡¨é‡Œé¢æ˜¯ä¸­æ–­ä¿¡å·ä¸å…¶å¯¹åº”çš„ä¸­æ–­å¤„ç†å‡½æ•°,æœ€ç»ˆéƒ½ä¼šèµ°åˆ°do_irq<br>å¯¹äºæ¯ä¸ªcpuæ¥è¯´ä¼šæœ‰ä¸€å±‚è™šæ‹Ÿä¸­æ–­å±‚,å› ä¸ºå¯¹äºå¤šæ ¸ç³»ç»Ÿ,å¤šä¸ªä¸­æ–­å¤„ç†å™¨,æ¯ä¸ªcpuä¼šæœ‰è‡ªå·±çš„ä¸­æ–­æ˜ å°„è¡¨æ¥è®²ç¡¬ä»¶çš„ä¸­æ–­å‘é‡å¯¹åº”äºè™šæ‹Ÿä¸­æ–­å‘é‡,å…¶å®å°±æ˜¯å°†ä¸­æ–­å‘é‡è¡¨ä¸­å¯¹åº”çš„ä¸­æ–­å‘é‡æè¿°ç»“æ„è®¾ç½®ä¸ºè™šæ‹Ÿä¸­æ–­ä¿¡å·çš„ä¸­æ–­æè¿°ç»“æ„.<br>ä¸­æ–­æè¿°ç»“æ„æ¯”è¾ƒé‡è¦,å…¶æˆå‘˜æœ‰ä¸­æ–­å¤„ç†çš„åŠ¨ä½œç»“æ„é“¾è¡¨,è®¾å¤‡çš„åå­—.<br>ä¸­æ–­å¤„ç†çš„åŠ¨ä½œç»“æ„ä½“å…¶ç»„æˆæˆå‘˜æœ‰ å¯¹åº”çš„ä¸­æ–­å¤„ç†å‡½æ•° è™šæ‹Ÿä¸­æ–­å· è¯¥ä¸­æ–­å¤„ç†å‡½æ•°æ˜¯å¦æ”¾åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­æ‰§è¡Œ,ä»¥åŠå¯¹åº”çš„çº¿ç¨‹ç­‰<br><br>ä¸­æ–­çš„æµç¨‹:<br>å½“ç³»ç»Ÿæ”¶åˆ°ä¸­æ–­ç‰©ç†ä¿¡å·,ä¼šç”±ä¸­æ–­æ§åˆ¶å™¨å°†ç‰©ç†ä¿¡å·è½¬åŒ–ä¸ºä¸­æ–­å‘é‡,ç„¶åå‘é€ç»™å„ä¸ªcpu<br>å„ä¸ªcpué€šè¿‡ç¡¬ä»¶çš„ä¸­æ–­å‘é‡è¡¨è°ƒç”¨å¯¹åº”çš„ä¸­æ–­å¤„ç†å‡½æ•°,åœ¨ä¸­æ–­å¤„ç†å‡½æ•°ä¸­ä¼šæŠŠç‰©ç†ä¸­æ–­ä¿¡å·è½¬åŒ–ä¸ºè™šæ‹Ÿä¸­æ–­ä¿¡å·,ç„¶åè°ƒç”¨ä¸­æ–­ä¿¡å·çš„ä¸­æ–­å¤„ç†å‡½æ•°(é€šè¿‡ä¸­æ–­æ˜ å°„è¡¨é‡Œå¯¹åº”çš„ä¸­æ–­æè¿°ç»“æ„æ¥æ‰¾åˆ°å¯¹åº”çš„ä¸­æ–­å¤„ç†å‡½æ•°)</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: èµ</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-04-26 11:13:25</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/a6/43/cb6ab349.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Spring</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œæ¯ä¸ªCPUçš„ä¸­æ–­å‘é‡è¡¨åªæœ‰256é¡¹ï¼Œç•™ç»™è®¾å¤‡çš„åªæœ‰å‰©ä¸‹çš„223é¡¹ï¼Œè¯·é—®æ˜¯æœ€å¤šèƒ½å¤„ç†223ä¸ªä¸åŒè®¾å¤‡çš„ä¸­æ–­å—ï¼Ÿä¸­æ–­å‘é‡è¡¨ä¸­çš„æ¯ä¸€é¡¹è·Ÿè®¾å¤‡ä¹‹é—´æ˜¯ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æœ‰ä¸­æ–­çš„ä¸€èŠ‚ä¼šè®²è¿™ä¸ª</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-06-23 14:46:10</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/16/88/18/a88cdaf5.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>alexgzh</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆ, system call, interrupå’Œexceptionå¤„ç†çš„ç›¸åŒç‚¹å’Œä¸åŒç‚¹èƒ½è®²ä¸€ä¸‹å—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: system callåŸæ¥æ˜¯è½¯ä¸­æ–­ï¼Œåæ¥æ˜¯ç‰¹æ®Šçš„æŒ‡ä»¤äº†ã€‚interruptæ˜¯ä¸­æ–­ï¼Œexceptionå¾€å¾€ä¼šå› ä¸ºæŒ‡ä»¤éæ³•ï¼Œä»¥ä¸­æ–­çš„å½¢å¼ä¸­æ­¢æŒ‡ä»¤è¿è¡Œï¼Œè¿˜æ˜¯èµ°ä¸­æ–­çš„æ­£å¸¸æµç¨‹ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-06-15 14:17:36</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>LeonğŸ“·</span>
  </div>
  <div class="_2_QraFYR_0">ä¸­æ–­æ³¨å†Œï¼Œä¸­æ–­å¤„ç†ï¼Œæœ‰ç‚¹ç±»ä¼¼äºrpcæ¡†æ¶è°ƒç”¨ï¼Œå…·ä½“çš„è¯·æ±‚é€šè¿‡äº‹å…ˆæ³¨å†Œçš„å‡½æ•°æŸ¥æ‰¾ï¼Œç„¶åè¿”å›ç»“æœç»™è°ƒç”¨æ–¹</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-06-12 08:11:58</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/14/1c/6f/3ea2a599.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å˜‰æœ¨</span>
  </div>
  <div class="_2_QraFYR_0">è¿™æ · do_IRQ ä¼šæ ¹æ®ä¸­æ–­å‘é‡ vector å¾—åˆ°å¯¹åº”çš„irq_descï¼Œç„¶åè°ƒç”¨ handle_irqã€‚handle_irq ä¼šè°ƒç”¨ generic_handle_irq_descï¼Œé‡Œé¢è°ƒç”¨ irq_desc çš„ handle_irq<br><br>è€å¸ˆè¿™ä¸ªåœ°æ–¹ç»•ä¸å‡ºæ¥äº†ã€‚ã€‚ã€‚handle_irqæœ€ååˆè°ƒç”¨åˆ°handle_irqï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ä¸¤ä¸ªhandle_irqï¼Œåå­—ä¸€æ ·è€Œå·²</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-08-03 12:36:15</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/fd/08/c039f840.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å°é³„é±¼</span>
  </div>
  <div class="_2_QraFYR_0">è¿™ï¼Œæ˜æ˜¾çœ‹å‡ºæ¥å‘½ä»¤æ¨¡å¼ï¼å°±åƒè¿™ä¸ªæ¨¡å¼çš„demoè¯´çš„å¨å¸ˆåšèœï¼Œæˆ‘ä¸éœ€è¦çŸ¥é“åˆ°åº•æ˜¯è°èƒ½å“åº”è¿™ä¸ªä¸­æ–­ï¼Œåªè¦ä¸‹ä»¤å¤„ç†è¿™ä¸ªä¸­æ–­å³å¯ï¼</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-05-23 08:48:41</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKkzrezV2dOBAgickt9DLzabz3dNFYyDEVXENMQ5ibrWhFbFqXIOia3ZaR21pozvB7UfoxJx4Ar688sA/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å¼€å¿ƒ</span>
  </div>
  <div class="_2_QraFYR_0">1. ä¹Ÿå³è¿™ä¸ª CPU çš„ 200 å·çš„ä¸­æ–­å‘é‡å’Œå¦ä¸€ä¸ª CPU çš„ 200 å·ä¸­æ–­å‘é‡å¯¹åº”çš„è™šæ‹Ÿä¸­æ–­ä¿¡å· irq å’Œä¸­æ–­æè¿°ç»“æ„ irq_desc å¯èƒ½ä¸ä¸€æ ·ï¼Ÿï¼Ÿï¼Ÿ<br>å…·ä½“èƒ½ä¸¾ä¸ªä¾‹å­ä¹ˆã€‚<br>2. è¿™ä¸ª200å·è¦æ€ä¹ˆæ˜ å°„æˆè™šæ‹Ÿä¸­æ–­ä¿¡å·ï¼Ÿæœ‰ä»€ä¹ˆè§„åˆ™ä¹ˆ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-06-30 23:02:50</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/NyFOEueITjaGLpakMEuWAqVQjo1uDIXlpDdpCxXGfaWiaXzibLQ3WgOFCe8D9FvCmyjsGT7jDsLUbkt8jt2aVs9g/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>geek</span>
  </div>
  <div class="_2_QraFYR_0">ä¸ºä»€ä¹ˆä¸€ä¸ªirq_descä¸­å¯èƒ½ä¼šæœ‰å¤šä¸ªirqactionå‘¢ï¼Ÿä¸€ä¸ªä¸­æ–­ä¿¡å·ä¼šå¯¹åº”å¤šä¸ªå¤„ç†å‡½æ•°å—</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-04-11 22:11:12</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/18/0e/40/49a71ed8.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å…«æˆ’</span>
  </div>
  <div class="_2_QraFYR_0">vector_irq[]ä¸åŸºæ•°æ ‘irq_descæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ<br>çœ‹å›¾å¥½åƒæœ‰å…³ç³»ï¼Œä½†åˆä¸æ¸…æ¥šä»€ä¹ˆå…³ç³»</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-03-30 15:26:33</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/15/25/4b/4cbd001e.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ä½³ä¿Š</span>
  </div>
  <div class="_2_QraFYR_0">æ¯ä¸€ä¸ªcpuéƒ½ä¼šæœ‰ä¸€ä¸ªä¸­æ–­å‘é‡è¡¨ï¼Œéƒ½æ˜¯ä¸€æ ·çš„å—ï¼Ÿå¦‚æœä¸€ä¸ªæ§åˆ¶å™¨ä¸­æ–­æ¥äº†ä¹‹åï¼Œä»–ä¼šæŠŠä¸­æ–­ç»™å“ªä¸ªcpuå‘¢?</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ä¸­æ–­ä¹Ÿæœ‰è·¯ç”±ï¼Œå“ªä¸ªå¤„ç†éƒ½è¡Œ</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-05-22 11:21:06</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/18/90/8f/9c691a5f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å¥”è·‘çš„ç ä»”</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œx86æ¶æ„ä¸‹ï¼Œç‰©ç†ä¸­æ–­ä¿¡å·å¦‚ä½•ä¸è™šæ‹Ÿä¸­æ–­ä¿¡å·è¿›è¡Œæ˜ å°„å‘¢ï¼Ÿå“ªé‡Œè¿›è¡Œæ˜ å°„å‘¢ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-09-23 14:16:06</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/18/90/8f/9c691a5f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å¥”è·‘çš„ç ä»”</span>
  </div>
  <div class="_2_QraFYR_0">&quot;ä¸ºäº†å¤„ç†ä¸­æ–­ï¼ŒCPU ç¡¬ä»¶è¦æ±‚æ¯ä¸€ä¸ª CPU éƒ½æœ‰ä¸€ä¸ªä¸­æ–­å‘é‡è¡¨ï¼Œé€šè¿‡ load_idt åŠ è½½ï¼Œé‡Œé¢è®°å½•ç€<br>æ¯ä¸€ä¸ªä¸­æ–­å¯¹åº”çš„å¤„ç†æ–¹æ³•ï¼Œè¿™ä¸ªä¸­æ–­å‘é‡è¡¨å®šä¹‰åœ¨æ–‡ä»¶ arch&#47;x86&#47;kernel&#47;traps.c ä¸­ã€‚&quot;ï¼Œåœ¨arch&#47;x86&#47;include&#47;asm&#47;irq_vectors.hçš„æ³¨é‡Šé‡Œï¼Œâ€œ64-bit x86 has per CPU IDT tables, 32-bit has one shared IDT table.â€ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯ä¸æ˜¯è¯¥æ³¨æ˜åœ¨64-bit x86æ¶æ„ä¸‹ï¼Œæ¯ä¸ªCPUå¿…é¡»éƒ½æœ‰ä¸€ä¸ªä¸­æ–­å‘é‡è¡¨ï¼ŒIDTï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-09-23 11:40:22</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å®‰æ’</span>
  </div>
  <div class="_2_QraFYR_0">æ¯ä¸ªCPUçš„å‰32ä¸ªä¸­æ–­ä¹Ÿä¼šè°ƒç”¨åˆ°do_IRQå—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ˜¯çš„</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-06-12 22:50:38</div>
  </div>
</div>
</div>
</li>
</ul>