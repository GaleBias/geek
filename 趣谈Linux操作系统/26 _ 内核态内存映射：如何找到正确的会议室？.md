<audio title="26 _ å†…æ ¸æ€å†…å­˜æ˜ å°„ï¼šå¦‚ä½•æ‰¾åˆ°æ­£ç¡®çš„ä¼šè®®å®¤ï¼Ÿ" src="https://static001.geekbang.org/resource/audio/13/96/1378c56588e2a2a95c61f04d963df796.mp3" controls="controls"></audio> 
<p>å‰é¢è®²ç”¨æˆ·æ€å†…å­˜æ˜ å°„æœºåˆ¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬å·²ç»å¤šæ¬¡å¼•ç”³å‡ºäº†å†…æ ¸çš„æ˜ å°„æœºåˆ¶ï¼Œä½†æ˜¯å’±ä»¬éƒ½æš‚æ—¶æ”¾äº†æ”¾ï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬å°±æ¥è¯¦ç»†è§£æä¸€ä¸‹ï¼Œè®©ä½ å½»åº•ææ‡‚å®ƒã€‚</p><p>é¦–å…ˆï¼Œä½ è¦çŸ¥é“ï¼Œå†…æ ¸æ€çš„å†…å­˜æ˜ å°„æœºåˆ¶ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ul>
<li>
<p>å†…æ ¸æ€å†…å­˜æ˜ å°„å‡½æ•°vmallocã€kmap_atomicæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼›</p>
</li>
<li>
<p>å†…æ ¸æ€é¡µè¡¨æ˜¯æ”¾åœ¨å“ªé‡Œçš„ï¼Œå¦‚ä½•å·¥ä½œçš„ï¼Ÿswapper_pg_diræ˜¯æ€ä¹ˆå›äº‹ï¼›</p>
</li>
<li>
<p>å‡ºç°äº†å†…æ ¸æ€ç¼ºé¡µå¼‚å¸¸åº”è¯¥æ€ä¹ˆåŠï¼Ÿ</p>
</li>
</ul><h2>å†…æ ¸é¡µè¡¨</h2><p>å’Œç”¨æˆ·æ€é¡µè¡¨ä¸åŒï¼Œåœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±è¦åˆ›å»ºå†…æ ¸é¡µè¡¨äº†ã€‚</p><p>æˆ‘ä»¬ä»å†…æ ¸é¡µè¡¨çš„æ ¹swapper_pg_dirå¼€å§‹æ‰¾çº¿ç´¢ï¼Œåœ¨arch/x86/include/asm/pgtable_64.hä¸­å°±èƒ½æ‰¾åˆ°å®ƒçš„å®šä¹‰ã€‚</p><pre><code>extern pud_t level3_kernel_pgt[512];
extern pud_t level3_ident_pgt[512];
extern pmd_t level2_kernel_pgt[512];
extern pmd_t level2_fixmap_pgt[512];
extern pmd_t level2_ident_pgt[512];
extern pte_t level1_fixmap_pgt[512];
extern pgd_t init_top_pgt[];


#define swapper_pg_dir init_top_pgt
</code></pre><p>swapper_pg_diræŒ‡å‘å†…æ ¸æœ€é¡¶çº§çš„ç›®å½•pgdï¼ŒåŒæ—¶å‡ºç°çš„è¿˜æœ‰å‡ ä¸ªé¡µè¡¨ç›®å½•ã€‚æˆ‘ä»¬å¯ä»¥å›å¿†ä¸€ä¸‹ï¼Œ64ä½ç³»ç»Ÿçš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„å¸ƒå±€ï¼Œå…¶ä¸­XXX_ident_pgtå¯¹åº”çš„æ˜¯ç›´æ¥æ˜ å°„åŒºï¼ŒXXX_kernel_pgtå¯¹åº”çš„æ˜¯å†…æ ¸ä»£ç åŒºï¼ŒXXX_fixmap_pgtå¯¹åº”çš„æ˜¯å›ºå®šæ˜ å°„åŒºã€‚</p><p>å®ƒä»¬æ˜¯åœ¨å“ªé‡Œåˆå§‹åŒ–çš„å‘¢ï¼Ÿåœ¨æ±‡ç¼–è¯­è¨€çš„æ–‡ä»¶é‡Œé¢çš„arch\x86\kernel\head_64.Sã€‚è¿™æ®µä»£ç æ¯”è¾ƒéš¾çœ‹æ‡‚ï¼Œä½ åªè¦æ˜ç™½å®ƒæ˜¯å¹²ä»€ä¹ˆçš„å°±è¡Œäº†ã€‚</p><!-- [[[read_end]]] --><pre><code>__INITDATA


NEXT_PAGE(init_top_pgt)
	.quad   level3_ident_pgt - __START_KERNEL_map + _KERNPG_TABLE
	.org    init_top_pgt + PGD_PAGE_OFFSET*8, 0
	.quad   level3_ident_pgt - __START_KERNEL_map + _KERNPG_TABLE
	.org    init_top_pgt + PGD_START_KERNEL*8, 0
	/* (2^48-(2*1024*1024*1024))/(2^39) = 511 */
	.quad   level3_kernel_pgt - __START_KERNEL_map + _PAGE_TABLE


NEXT_PAGE(level3_ident_pgt)
	.quad	level2_ident_pgt - __START_KERNEL_map + _KERNPG_TABLE
	.fill	511, 8, 0
NEXT_PAGE(level2_ident_pgt)
	/* Since I easily can, map the first 1G.
	 * Don't set NX because code runs from these pages.
	 */
	PMDS(0, __PAGE_KERNEL_IDENT_LARGE_EXEC, PTRS_PER_PMD)


NEXT_PAGE(level3_kernel_pgt)
	.fill	L3_START_KERNEL,8,0
	/* (2^48-(2*1024*1024*1024)-((2^39)*511))/(2^30) = 510 */
	.quad	level2_kernel_pgt - __START_KERNEL_map + _KERNPG_TABLE
	.quad	level2_fixmap_pgt - __START_KERNEL_map + _PAGE_TABLE


NEXT_PAGE(level2_kernel_pgt)
	/*
	 * 512 MB kernel mapping. We spend a full page on this pagetable
	 * anyway.
	 *
	 * The kernel code+data+bss must not be bigger than that.
	 *
	 * (NOTE: at +512MB starts the module area, see MODULES_VADDR.
	 *  If you want to increase this then increase MODULES_VADDR
	 *  too.)
	 */
	PMDS(0, __PAGE_KERNEL_LARGE_EXEC,
		KERNEL_IMAGE_SIZE/PMD_SIZE)


NEXT_PAGE(level2_fixmap_pgt)
	.fill	506,8,0
	.quad	level1_fixmap_pgt - __START_KERNEL_map + _PAGE_TABLE
	/* 8MB reserved for vsyscalls + a 2MB hole = 4 + 1 entries */
	.fill	5,8,0


NEXT_PAGE(level1_fixmap_pgt)
	.fill	51
</code></pre><p>å†…æ ¸é¡µè¡¨çš„é¡¶çº§ç›®å½•init_top_pgtï¼Œå®šä¹‰åœ¨__INITDATAé‡Œé¢ã€‚å’±ä»¬è®²è¿‡ELFçš„æ ¼å¼ï¼Œä¹Ÿè®²è¿‡è™šæ‹Ÿå†…å­˜ç©ºé—´çš„å¸ƒå±€ã€‚å®ƒä»¬éƒ½æœ‰ä»£ç æ®µï¼Œè¿˜æœ‰ä¸€äº›åˆå§‹åŒ–äº†çš„å…¨å±€å˜é‡ï¼Œæ”¾åœ¨.initåŒºåŸŸã€‚è¿™äº›è¯´çš„å°±æ˜¯è¿™ä¸ªåŒºåŸŸã€‚å¯ä»¥çœ‹åˆ°ï¼Œé¡µè¡¨çš„æ ¹å…¶å®æ˜¯å…¨å±€å˜é‡ï¼Œè¿™å°±ä½¿å¾—æˆ‘ä»¬åˆå§‹åŒ–çš„æ—¶å€™ï¼Œç”šè‡³å†…å­˜ç®¡ç†è¿˜æ²¡æœ‰åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå¾ˆå®¹æ˜“å°±å¯ä»¥å®šä½åˆ°ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œå®šä¹‰init_top_pgtåŒ…å«å“ªäº›é¡¹ï¼Œè¿™ä¸ªæ±‡ç¼–ä»£ç æ¯”è¾ƒéš¾æ‡‚äº†ã€‚ä½ å¯ä»¥ç®€å•åœ°è®¤ä¸ºï¼Œquadæ˜¯å£°æ˜äº†ä¸€é¡¹çš„å†…å®¹ï¼Œorgæ˜¯è·³åˆ°äº†æŸä¸ªä½ç½®ã€‚</p><p>æ‰€ä»¥ï¼Œinit_top_pgtæœ‰ä¸‰é¡¹ï¼Œä¸Šæ¥å…ˆæœ‰ä¸€é¡¹ï¼ŒæŒ‡å‘çš„æ˜¯level3_ident_pgtï¼Œä¹Ÿå³ç›´æ¥æ˜ å°„åŒºé¡µè¡¨çš„ä¸‰çº§ç›®å½•ã€‚ä¸ºä»€ä¹ˆè¦å‡å»__START_KERNEL_mapå‘¢ï¼Ÿå› ä¸ºlevel3_ident_pgtæ˜¯å®šä¹‰åœ¨å†…æ ¸ä»£ç é‡Œçš„ï¼Œå†™ä»£ç çš„æ—¶å€™ï¼Œå†™çš„éƒ½æ˜¯è™šæ‹Ÿåœ°å€ï¼Œè°å†™ä»£ç çš„æ—¶å€™ä¹Ÿä¸çŸ¥é“å°†æ¥åŠ è½½çš„ç‰©ç†åœ°å€æ˜¯å¤šå°‘å‘€ï¼Œå¯¹ä¸å¯¹ï¼Ÿ</p><p>å› ä¸ºlevel3_ident_pgtæ˜¯åœ¨è™šæ‹Ÿåœ°å€çš„å†…æ ¸ä»£ç æ®µé‡Œçš„ï¼Œè€Œ__START_KERNEL_mapæ­£æ˜¯è™šæ‹Ÿåœ°å€ç©ºé—´çš„å†…æ ¸ä»£ç æ®µçš„èµ·å§‹åœ°å€ï¼Œè¿™åœ¨è®²64ä½è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ—¶å€™éƒ½è®²è¿‡äº†ï¼Œè¦æ˜¯æƒ³ä¸èµ·æ¥å°±èµ¶ç´§å»å›é¡¾ä¸€ä¸‹ã€‚è¿™æ ·ï¼Œlevel3_ident_pgtå‡å»__START_KERNEL_mapæ‰æ˜¯ç‰©ç†åœ°å€ã€‚</p><p>ç¬¬ä¸€é¡¹å®šä¹‰å®Œäº†ä»¥åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è·³åˆ°PGD_PAGE_OFFSETçš„ä½ç½®ï¼Œå†å®šä¹‰ä¸€é¡¹ã€‚ä»å®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸€é¡¹å°±åº”è¯¥æ˜¯__PAGE_OFFSET_BASEå¯¹åº”çš„ã€‚__PAGE_OFFSET_BASEæ˜¯è™šæ‹Ÿåœ°å€ç©ºé—´é‡Œé¢å†…æ ¸çš„èµ·å§‹åœ°å€ã€‚ç¬¬äºŒé¡¹ä¹ŸæŒ‡å‘level3_ident_pgtï¼Œç›´æ¥æ˜ å°„åŒºã€‚</p><pre><code>PGD_PAGE_OFFSET = pgd_index(__PAGE_OFFSET_BASE)
PGD_START_KERNEL = pgd_index(__START_KERNEL_map)
L3_START_KERNEL = pud_index(__START_KERNEL_map)
</code></pre><p>ç¬¬äºŒé¡¹å®šä¹‰å®Œäº†ä»¥åï¼Œæ¥ä¸‹æ¥è·³åˆ°PGD_START_KERNELçš„ä½ç½®ï¼Œå†å®šä¹‰ä¸€é¡¹ã€‚ä»å®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸€é¡¹åº”è¯¥æ˜¯__START_KERNEL_mapå¯¹åº”çš„é¡¹ï¼Œ__START_KERNEL_mapæ˜¯è™šæ‹Ÿåœ°å€ç©ºé—´é‡Œé¢å†…æ ¸ä»£ç æ®µçš„èµ·å§‹åœ°å€ã€‚ç¬¬ä¸‰é¡¹æŒ‡å‘level3_kernel_pgtï¼Œå†…æ ¸ä»£ç åŒºã€‚</p><p>æ¥ä¸‹æ¥çš„ä»£ç å°±å¾ˆç±»ä¼¼äº†ï¼Œå°±æ˜¯åˆå§‹åŒ–ä¸ªè¡¨é¡¹ï¼Œç„¶åæŒ‡å‘ä¸‹ä¸€çº§ç›®å½•ï¼Œæœ€ç»ˆå½¢æˆä¸‹é¢è¿™å¼ å›¾ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/78/6d/78c8d44d7d8c08c03eee6f7a94652d6d.png?wh=2188*2623" alt=""></p><p>å†…æ ¸é¡µè¡¨å®šä¹‰å®Œäº†ï¼Œä¸€å¼€å§‹è¿™é‡Œé¢çš„é¡µè¡¨èƒ½å¤Ÿè¦†ç›–çš„å†…å­˜èŒƒå›´æ¯”è¾ƒå°ã€‚ä¾‹å¦‚ï¼Œå†…æ ¸ä»£ç åŒº512Mï¼Œç›´æ¥æ˜ å°„åŒº1Gã€‚è¿™ä¸ªæ—¶å€™ï¼Œå…¶å®åªè¦èƒ½å¤Ÿæ˜ å°„åŸºæœ¬çš„å†…æ ¸ä»£ç å’Œæ•°æ®ç»“æ„å°±å¯ä»¥äº†ã€‚å¯ä»¥çœ‹å‡ºï¼Œé‡Œé¢è¿˜ç©ºç€å¾ˆå¤šé¡¹ï¼Œå¯ä»¥ç”¨äºå°†æ¥æ˜ å°„å·¨å¤§çš„å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œç­‰ç”¨åˆ°çš„æ—¶å€™å†è¿›è¡Œæ˜ å°„ã€‚</p><p>å¦‚æœæ˜¯ç”¨æˆ·æ€è¿›ç¨‹é¡µè¡¨ï¼Œä¼šæœ‰mm_structæŒ‡å‘è¿›ç¨‹é¡¶çº§ç›®å½•pgdï¼Œå¯¹äºå†…æ ¸æ¥è®²ï¼Œä¹Ÿå®šä¹‰äº†ä¸€ä¸ªmm_structï¼ŒæŒ‡å‘swapper_pg_dirã€‚</p><pre><code>struct mm_struct init_mm = {
	.mm_rb		= RB_ROOT,
	.pgd		= swapper_pg_dir,
	.mm_users	= ATOMIC_INIT(2),
	.mm_count	= ATOMIC_INIT(1),
	.mmap_sem	= __RWSEM_INITIALIZER(init_mm.mmap_sem),
	.page_table_lock =  __SPIN_LOCK_UNLOCKED(init_mm.page_table_lock),
	.mmlist		= LIST_HEAD_INIT(init_mm.mmlist),
	.user_ns	= &amp;init_user_ns,
	INIT_MM_CONTEXT(init_mm)
};
</code></pre><p>å®šä¹‰å®Œäº†å†…æ ¸é¡µè¡¨ï¼Œæ¥ä¸‹æ¥æ˜¯åˆå§‹åŒ–å†…æ ¸é¡µè¡¨ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™start_kernelä¼šè°ƒç”¨setup_archã€‚</p><pre><code>void __init setup_arch(char **cmdline_p)
{
	/*
	 * copy kernel address range established so far and switch
	 * to the proper swapper page table
	 */
	clone_pgd_range(swapper_pg_dir     + KERNEL_PGD_BOUNDARY,
			initial_page_table + KERNEL_PGD_BOUNDARY,
			KERNEL_PGD_PTRS);


	load_cr3(swapper_pg_dir);
	__flush_tlb_all();
......
	init_mm.start_code = (unsigned long) _text;
	init_mm.end_code = (unsigned long) _etext;
	init_mm.end_data = (unsigned long) _edata;
	init_mm.brk = _brk_end;
......
	init_mem_mapping();
......
}
</code></pre><p>åœ¨setup_archä¸­ï¼Œload_cr3(swapper_pg_dir)è¯´æ˜å†…æ ¸é¡µè¡¨è¦å¼€å§‹èµ·ä½œç”¨äº†ï¼Œå¹¶ä¸”åˆ·æ–°äº†TLBï¼Œåˆå§‹åŒ–init_mmçš„æˆå‘˜å˜é‡ï¼Œæœ€é‡è¦çš„å°±æ˜¯init_mem_mappingã€‚æœ€ç»ˆå®ƒä¼šè°ƒç”¨kernel_physical_mapping_initã€‚</p><pre><code>/*
 * Create page table mapping for the physical memory for specific physical
 * addresses. The virtual and physical addresses have to be aligned on PMD level
 * down. It returns the last physical address mapped.
 */
unsigned long __meminit
kernel_physical_mapping_init(unsigned long paddr_start,
			     unsigned long paddr_end,
			     unsigned long page_size_mask)
{
	unsigned long vaddr, vaddr_start, vaddr_end, vaddr_next, paddr_last;


	paddr_last = paddr_end;
	vaddr = (unsigned long)__va(paddr_start);
	vaddr_end = (unsigned long)__va(paddr_end);
	vaddr_start = vaddr;


	for (; vaddr &lt; vaddr_end; vaddr = vaddr_next) {
		pgd_t *pgd = pgd_offset_k(vaddr);
		p4d_t *p4d;


		vaddr_next = (vaddr &amp; PGDIR_MASK) + PGDIR_SIZE;


		if (pgd_val(*pgd)) {
			p4d = (p4d_t *)pgd_page_vaddr(*pgd);
			paddr_last = phys_p4d_init(p4d, __pa(vaddr),
						   __pa(vaddr_end),
						   page_size_mask);
			continue;
		}


		p4d = alloc_low_page();
		paddr_last = phys_p4d_init(p4d, __pa(vaddr), __pa(vaddr_end),
					   page_size_mask);


		p4d_populate(&amp;init_mm, p4d_offset(pgd, vaddr), (pud_t *) p4d);
	}
	__flush_tlb_all();


	return paddr_l
</code></pre><p>åœ¨kernel_physical_mapping_inité‡Œï¼Œæˆ‘ä»¬å…ˆé€šè¿‡__vaå°†ç‰©ç†åœ°å€è½¬æ¢ä¸ºè™šæ‹Ÿåœ°å€ï¼Œç„¶åå†åˆ›å»ºè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€çš„æ˜ å°„é¡µè¡¨ã€‚</p><p>ä½ å¯èƒ½ä¼šé—®ï¼Œæ€ä¹ˆè¿™ä¹ˆéº»çƒ¦å•Šï¼Ÿæ—¢ç„¶å¯¹äºå†…æ ¸æ¥è®²ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨__vaå’Œ__paç›´æ¥åœ¨è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€ä¹‹é—´ç›´æ¥è½¬æ¥è½¬å»ï¼Œä¸ºå•¥è¿˜è¦è¾›è¾›è‹¦è‹¦å»ºç«‹é¡µè¡¨å‘¢ï¼Ÿå› ä¸ºè¿™æ˜¯CPUå’Œå†…å­˜çš„ç¡¬ä»¶çš„éœ€æ±‚ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒCPUåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹è®¿é—®è™šæ‹Ÿåœ°å€çš„æ—¶å€™ï¼Œå°±ä¼šç”¨CR3è¿™ä¸ªå¯„å­˜å™¨ï¼Œè¿™ä¸ªå¯„å­˜å™¨æ˜¯CPUå®šä¹‰çš„ï¼Œä½œä¸ºæ“ä½œç³»ç»Ÿï¼Œæˆ‘ä»¬æ˜¯è½¯ä»¶ï¼Œåªèƒ½æŒ‰ç…§ç¡¬ä»¶çš„è¦æ±‚æ¥ã€‚</p><p>ä½ å¯èƒ½åˆä¼šé—®äº†ï¼ŒæŒ‰ç…§å’±ä»¬è®²åˆå§‹åŒ–çš„æ—¶å€™çš„è¿‡ç¨‹ï¼Œç³»ç»Ÿæ—©æ—©å°±è¿›å…¥äº†ä¿æŠ¤æ¨¡å¼ï¼Œåˆ°äº†setup_arché‡Œé¢æ‰load_cr3ï¼Œå¦‚æœä½¿ç”¨cr3æ˜¯ç¡¬ä»¶çš„è¦æ±‚ï¼Œé‚£ä¹‹å‰æ˜¯æ€ä¹ˆåŠçš„å‘¢ï¼Ÿå¦‚æœä½ ä»”ç»†å»çœ‹arch\x86\kernel\head_64.Sï¼Œè¿™é‡Œé¢é™¤äº†åˆå§‹åŒ–å†…æ ¸é¡µè¡¨ä¹‹å¤–ï¼Œåœ¨è¿™ä¹‹å‰ï¼Œè¿˜æœ‰å¦ä¸€ä¸ªé¡µè¡¨early_top_pgtã€‚çœ‹åˆ°å…³é”®å­—earlyäº†å˜›ï¼Ÿè¿™ä¸ªé¡µè¡¨å°±æ˜¯ä¸“é—¨ç”¨åœ¨çœŸæ­£çš„å†…æ ¸é¡µè¡¨åˆå§‹åŒ–ä¹‹å‰ï¼Œä¸ºäº†éµå¾ªç¡¬ä»¶çš„è¦æ±‚è€Œè®¾ç½®çš„ã€‚æ—©æœŸé¡µè¡¨ä¸æ˜¯æˆ‘ä»¬è¿™èŠ‚çš„é‡ç‚¹ï¼Œè¿™é‡Œæˆ‘å°±ä¸å±•å¼€å¤šè¯´äº†ã€‚</p><h2>vmallocå’Œkmap_atomicåŸç†</h2><p>åœ¨ç”¨æˆ·æ€å¯ä»¥é€šè¿‡mallocå‡½æ•°åˆ†é…å†…å­˜ï¼Œå½“ç„¶mallocåœ¨åˆ†é…æ¯”è¾ƒå¤§çš„å†…å­˜çš„æ—¶å€™ï¼Œåº•å±‚è°ƒç”¨çš„æ˜¯mmapï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡mmapåšå†…å­˜æ˜ å°„ï¼Œåœ¨å†…æ ¸é‡Œé¢ä¹Ÿæœ‰ç›¸åº”çš„å‡½æ•°ã€‚</p><p>åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´é‡Œé¢ï¼Œæœ‰ä¸ªvmallocåŒºåŸŸï¼Œä»VMALLOC_STARTå¼€å§‹åˆ°VMALLOC_ENDï¼Œå¯ä»¥ç”¨äºæ˜ å°„ä¸€æ®µç‰©ç†å†…å­˜ã€‚</p><pre><code>/**
 *	vmalloc  -  allocate virtually contiguous memory
 *	@size:		allocation size
 *	Allocate enough pages to cover @size from the page level
 *	allocator and map them into contiguous kernel virtual space.
 *
 *	For tight control over page level allocator and protection flags
 *	use __vmalloc() instead.
 */
void *vmalloc(unsigned long size)
{
	return __vmalloc_node_flags(size, NUMA_NO_NODE,
				    GFP_KERNEL);
}


static void *__vmalloc_node(unsigned long size, unsigned long align,
			    gfp_t gfp_mask, pgprot_t prot,
			    int node, const void *caller)
{
	return __vmalloc_node_range(size, align, VMALLOC_START, VMALLOC_END,
				gfp_mask, prot, 0, node, caller);
}
</code></pre><p>æˆ‘ä»¬å†æ¥çœ‹å†…æ ¸çš„ä¸´æ—¶æ˜ å°„å‡½æ•°kmap_atomicçš„å®ç°ã€‚ä»ä¸‹é¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæ˜¯32ä½æœ‰é«˜ç«¯åœ°å€çš„ï¼Œå°±éœ€è¦è°ƒç”¨set_pteé€šè¿‡å†…æ ¸é¡µè¡¨è¿›è¡Œä¸´æ—¶æ˜ å°„ï¼›å¦‚æœæ˜¯64ä½æ²¡æœ‰é«˜ç«¯åœ°å€çš„ï¼Œå°±è°ƒç”¨page_addressï¼Œé‡Œé¢ä¼šè°ƒç”¨lowmem_page_addressã€‚å…¶å®ä½ç«¯å†…å­˜çš„æ˜ å°„ï¼Œä¼šç›´æ¥ä½¿ç”¨__vaè¿›è¡Œä¸´æ—¶æ˜ å°„ã€‚</p><pre><code>void *kmap_atomic_prot(struct page *page, pgprot_t prot)
{
......
	if (!PageHighMem(page))
		return page_address(page);
......
	vaddr = __fix_to_virt(FIX_KMAP_BEGIN + idx);
	set_pte(kmap_pte-idx, mk_pte(page, prot));
......
	return (void *)vaddr;
}


void *kmap_atomic(struct page *page)
{
	return kmap_atomic_prot(page, kmap_prot);
}


static __always_inline void *lowmem_page_address(const struct page *page)
{
	return page_to_virt(page);
}


#define page_to_virt(x)	__va(PFN_PHYS(page_to_pfn(x)
</code></pre><h2>å†…æ ¸æ€ç¼ºé¡µå¼‚å¸¸</h2><p>å¯ä»¥çœ‹å‡ºï¼Œkmap_atomicå’Œvmallocä¸åŒã€‚kmap_atomicå‘ç°ï¼Œæ²¡æœ‰é¡µè¡¨çš„æ—¶å€™ï¼Œå°±ç›´æ¥åˆ›å»ºé¡µè¡¨è¿›è¡Œæ˜ å°„äº†ã€‚è€Œvmallocæ²¡æœ‰ï¼Œå®ƒåªåˆ†é…äº†å†…æ ¸çš„è™šæ‹Ÿåœ°å€ã€‚æ‰€ä»¥ï¼Œè®¿é—®å®ƒçš„æ—¶å€™ï¼Œä¼šäº§ç”Ÿç¼ºé¡µå¼‚å¸¸ã€‚</p><p>å†…æ ¸æ€çš„ç¼ºé¡µå¼‚å¸¸è¿˜æ˜¯ä¼šè°ƒç”¨do_page_faultï¼Œä½†æ˜¯ä¼šèµ°åˆ°å’±ä»¬ä¸Šé¢ç”¨æˆ·æ€ç¼ºé¡µå¼‚å¸¸ä¸­æ²¡æœ‰è§£æçš„é‚£éƒ¨åˆ†vmalloc_faultã€‚è¿™ä¸ªå‡½æ•°å¹¶ä¸å¤æ‚ï¼Œä¸»è¦ç”¨äºå…³è”å†…æ ¸é¡µè¡¨é¡¹ã€‚</p><pre><code>/*
 * 32-bit:
 *
 *   Handle a fault on the vmalloc or module mapping area
 */
static noinline int vmalloc_fault(unsigned long address)
{
	unsigned long pgd_paddr;
	pmd_t *pmd_k;
	pte_t *pte_k;


	/* Make sure we are in vmalloc area: */
	if (!(address &gt;= VMALLOC_START &amp;&amp; address &lt; VMALLOC_END))
		return -1;


	/*
	 * Synchronize this task's top level page-table
	 * with the 'reference' page table.
	 *
	 * Do _not_ use &quot;current&quot; here. We might be inside
	 * an interrupt in the middle of a task switch..
	 */
	pgd_paddr = read_cr3_pa();
	pmd_k = vmalloc_sync_one(__va(pgd_paddr), address);
	if (!pmd_k)
		return -1;


	pte_k = pte_offset_kernel(pmd_k, address);
	if (!pte_present(*pte_k))
		return -1;


	return 0
</code></pre><h2>æ€»ç»“æ—¶åˆ»</h2><p>è‡³æ­¤ï¼Œå†…æ ¸æ€çš„å†…å­˜æ˜ å°„ä¹Ÿè®²å®Œäº†ã€‚è¿™ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•´ä¸ªå†…å­˜ç®¡ç†çš„ä½“ç³»ä¸²èµ·æ¥äº†ã€‚</p><p>ç‰©ç†å†…å­˜æ ¹æ®NUMAæ¶æ„åˆ†èŠ‚ç‚¹ã€‚æ¯ä¸ªèŠ‚ç‚¹é‡Œé¢å†åˆ†åŒºåŸŸã€‚æ¯ä¸ªåŒºåŸŸé‡Œé¢å†åˆ†é¡µã€‚</p><p>ç‰©ç†é¡µé¢é€šè¿‡ä¼™ä¼´ç³»ç»Ÿè¿›è¡Œåˆ†é…ã€‚åˆ†é…çš„ç‰©ç†é¡µé¢è¦å˜æˆè™šæ‹Ÿåœ°å€è®©ä¸Šå±‚å¯ä»¥è®¿é—®ï¼Œkswapdå¯ä»¥æ ¹æ®ç‰©ç†é¡µé¢çš„ä½¿ç”¨æƒ…å†µå¯¹é¡µé¢è¿›è¡Œæ¢å…¥æ¢å‡ºã€‚</p><p>å¯¹äºå†…å­˜çš„åˆ†é…éœ€æ±‚ï¼Œå¯èƒ½æ¥è‡ªå†…æ ¸æ€ï¼Œä¹Ÿå¯èƒ½æ¥è‡ªç”¨æˆ·æ€ã€‚</p><p>å¯¹äºå†…æ ¸æ€ï¼Œkmallocåœ¨åˆ†é…å¤§å†…å­˜çš„æ—¶å€™ï¼Œä»¥åŠvmallocåˆ†é…ä¸è¿ç»­ç‰©ç†é¡µçš„æ—¶å€™ï¼Œç›´æ¥ä½¿ç”¨ä¼™ä¼´ç³»ç»Ÿï¼Œåˆ†é…åè½¬æ¢ä¸ºè™šæ‹Ÿåœ°å€ï¼Œè®¿é—®çš„æ—¶å€™éœ€è¦é€šè¿‡å†…æ ¸é¡µè¡¨è¿›è¡Œæ˜ å°„ã€‚</p><p>å¯¹äºkmem_cacheä»¥åŠkmallocåˆ†é…å°å†…å­˜ï¼Œåˆ™ä½¿ç”¨slubåˆ†é…å™¨ï¼Œå°†ä¼™ä¼´ç³»ç»Ÿåˆ†é…å‡ºæ¥çš„å¤§å—å†…å­˜åˆ‡æˆä¸€å°å—ä¸€å°å—è¿›è¡Œåˆ†é…ã€‚</p><p>kmem_cacheå’Œkmallocçš„éƒ¨åˆ†ä¸ä¼šè¢«æ¢å‡ºï¼Œå› ä¸ºç”¨è¿™ä¸¤ä¸ªå‡½æ•°åˆ†é…çš„å†…å­˜å¤šç”¨äºä¿æŒå†…æ ¸å…³é”®çš„æ•°æ®ç»“æ„ã€‚å†…æ ¸æ€ä¸­vmallocåˆ†é…çš„éƒ¨åˆ†ä¼šè¢«æ¢å‡ºï¼Œå› è€Œå½“è®¿é—®çš„æ—¶å€™ï¼Œå‘ç°ä¸åœ¨ï¼Œå°±ä¼šè°ƒç”¨do_page_faultã€‚</p><p>å¯¹äºç”¨æˆ·æ€çš„å†…å­˜åˆ†é…ï¼Œæˆ–è€…ç›´æ¥è°ƒç”¨mmapç³»ç»Ÿè°ƒç”¨åˆ†é…ï¼Œæˆ–è€…è°ƒç”¨mallocã€‚è°ƒç”¨mallocçš„æ—¶å€™ï¼Œå¦‚æœåˆ†é…å°çš„å†…å­˜ï¼Œå°±ç”¨sys_brkç³»ç»Ÿè°ƒç”¨ï¼›å¦‚æœåˆ†é…å¤§çš„å†…å­˜ï¼Œè¿˜æ˜¯ç”¨sys_mmapç³»ç»Ÿè°ƒç”¨ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œç”¨æˆ·æ€çš„å†…å­˜éƒ½æ˜¯å¯ä»¥æ¢å‡ºçš„ï¼Œå› è€Œä¸€æ—¦å‘ç°å†…å­˜ä¸­ä¸å­˜åœ¨ï¼Œå°±ä¼šè°ƒç”¨do_page_faultã€‚</p><p><img src="https://static001.geekbang.org/resource/image/27/9a/274e22b3f5196a4c68bb6813fb643f9a.png?wh=2368*2248" alt=""></p><h2>è¯¾å ‚ç»ƒä¹ </h2><p>ä¼™ä¼´ç³»ç»Ÿåˆ†é…å¥½äº†ç‰©ç†é¡µé¢ä¹‹åï¼Œå¦‚ä½•è½¬æ¢æˆä¸ºè™šæ‹Ÿåœ°å€å‘¢ï¼Ÿè¯·ç ”ç©¶ä¸€ä¸‹page_addresså‡½æ•°çš„å®ç°ã€‚</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„ç–‘æƒ‘å’Œè§è§£ï¼Œä¹Ÿæ¬¢è¿ä½ æ”¶è—æœ¬èŠ‚å†…å®¹ï¼Œåå¤ç ”è¯»ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·å­¦ä¹ ã€è¿›æ­¥ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/8c/37/8c0a95fa07a8b9a1abfd394479bdd637.jpg?wh=1110*659" alt=""></p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/74/c9/d3439ca4.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>why</span>
  </div>
  <div class="_2_QraFYR_0">- æ¶‰åŠä¸‰å—å†…å®¹:<br>    - å†…å­˜æ˜ å°„å‡½æ•° vmalloc, kmap_atomic<br>    - å†…æ ¸æ€é¡µè¡¨å­˜æ”¾ä½ç½®å’Œå·¥ä½œæµç¨‹<br>    - å†…æ ¸æ€ç¼ºé¡µå¼‚å¸¸å¤„ç†<br>- å†…æ ¸æ€é¡µè¡¨, ç³»ç»Ÿåˆå§‹åŒ–æ—¶å°±åˆ›å»º<br>    - swapper_pg_dir æŒ‡å‘å†…æ ¸é¡¶çº§é¡µç›®å½• pgd<br>        - xxx_ident&#47;kernel&#47;fixmap_pgt åˆ†åˆ«æ˜¯ç›´æ¥æ˜ å°„&#47;å†…æ ¸ä»£ç &#47;å›ºå®šæ˜ å°„çš„ xxx çº§é¡µè¡¨ç›®å½•<br>    - åˆ›å»ºå†…æ ¸æ€é¡µè¡¨<br>        - swapper_pg_dir æŒ‡å‘ init_top_pgt, æ˜¯ ELF æ–‡ä»¶çš„å…¨å±€å˜é‡, å› æ­¤å†å†…å­˜ç®¡ç†åˆå§‹åŒ–ä¹‹é—´å°±å­˜åœ¨<br>        - init_top_pgt å…ˆåˆå§‹åŒ–äº†ä¸‰é¡¹<br>            - ç¬¬ä¸€é¡¹æŒ‡å‘ level3_ident_pgt (å†…æ ¸ä»£ç æ®µçš„æŸä¸ªè™šæ‹Ÿåœ°å€) å‡å» __START_KERNEL_MAP (å†…æ ¸ä»£ç èµ·å§‹è™šæ‹Ÿåœ°å€) å¾—åˆ°å®é™…ç‰©ç†åœ°å€<br>            - ç¬¬äºŒé¡¹ä¹Ÿæ˜¯æŒ‡å‘ level3_ident_pgt<br>            - ç¬¬ä¸‰é¡¹æŒ‡å‘ level3_kernel_pgt å†…æ ¸ä»£ç åŒº<br>    - åˆå§‹åŒ–å„é¡µè¡¨é¡¹, æŒ‡å‘ä¸‹ä¸€é›†ç›®å½•<br>        - é¡µè¡¨è¦†ç›–èŒƒå›´è¾ƒå°, å†…æ ¸ä»£ç  512MB, ç›´æ¥æ˜ å°„åŒº 1GB<br>        - å†…æ ¸æ€ä¹Ÿå®šä¹‰ mm_struct æŒ‡å‘ swapper_pg_dir<br>        - åˆå§‹åŒ–å†…æ ¸æ€é¡µè¡¨,  start_kernelâ†’ setup_arch<br>            - load_cr3(swapper_pg_dir) å¹¶åˆ·æ–° TLB<br>            - è°ƒç”¨ init_mem_mappingâ†’kernel_physical_mapping_init, ç”¨ __va å°†ç‰©ç†åœ°å€æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€, å†åˆ›å»ºæ˜ å°„é¡µè¡¨é¡¹<br>            - CPU åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹è®¿é—®è™šæ‹Ÿåœ°å€éƒ½å¿…é¡»é€šè¿‡ cr3, ç³»ç»Ÿåªèƒ½ç…§åš<br>            - åœ¨ load_cr3 ä¹‹å‰, é€šè¿‡ early_top_pgt å®Œæˆæ˜ å°„<br>- vmalloc å’Œ kmap_atomic<br>    - å†…æ ¸çš„è™šæ‹Ÿåœ°å€ç©ºé—´ vmalloc åŒºåŸŸç”¨äºæ˜ å°„<br>    - kmap_atomic ä¸´æ—¶æ˜ å°„<br>        - 32 ä½, è°ƒç”¨ set_pte é€šè¿‡å†…æ ¸é¡µè¡¨ä¸´æ—¶æ˜ å°„<br>        - 64 ä½, è°ƒç”¨ page_addressâ†’lowmem_page_address è¿›è¡Œæ˜ å°„<br>- å†…æ ¸æ€ç¼ºé¡µå¼‚å¸¸<br>    - kmap_atomic ç›´æ¥åˆ›å»ºé¡µè¡¨è¿›è¡Œæ˜ å°„<br>    - vmalloc åªåˆ†é…å†…æ ¸è™šæ‹Ÿåœ°å€, è®¿é—®æ—¶è§¦å‘ç¼ºé¡µä¸­æ–­, è°ƒç”¨ do_page_faultâ†’vmalloc_fault ç”¨äºå…³è”å†…æ ¸é¡µè¡¨é¡¹<br>- kmem_cache å’Œ kmalloc ç”¨äºä¿å­˜å†…æ ¸æ•°æ®ç»“æ„, ä¸ä¼šè¢«æ¢å‡º; è€Œå†…æ ¸ vmalloc ä¼šè¢«æ¢å‡º</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-05-27 21:02:29</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/e7/2e/1522a7d6.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æ´»çš„æ½‡æ´’</span>
  </div>
  <div class="_2_QraFYR_0">å†³å¿ƒä»å¤´æŠŠè®¡ç®—æœºæ‰€æœ‰çš„åŸºç¡€è¯¾ç¨‹å…¨éƒ¨è¡¥ä¸Šï¼Œå¤¯å®åŸºç¡€ï¼Œä¸€å®šè¦åšæŒåˆ°æœ€å<br>day26ç¬”è®°ï¼šhttps:&#47;&#47;www.cnblogs.com&#47;luoahong&#47;p&#47;10931320.html</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-05-29 15:16:28</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/35/73/46d6dadc.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æ²¡å¿ƒæ²¡è‚º</span>
  </div>
  <div class="_2_QraFYR_0">å¥½ææ€–ï¼Œçœ‹åˆ°è¿™é‡Œï¼Œæ˜¯ç¡¬çœ‹äº†</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ä¸æ€•ä¸æ€•</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-07-05 18:08:07</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/78/f5/6821ac5f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ezra.xu</span>
  </div>
  <div class="_2_QraFYR_0">å†…æ ¸èƒ½ç”¨cè¯­è¨€ç¼–å†™ï¼Œæ˜¯ä¸æ˜¯æ„å‘³ç€ç”¨cå¯ä»¥ç›´æ¥æ“ä½œç‰©ç†å†…å­˜ï¼Œå¦å¤–linuxä¸Šçš„cè¯­è¨€ç¼–è¯‘å™¨æ˜¯ç”¨ä»€ä¹ˆè¯­è¨€å¼€å‘çš„ï¼Œcè¯­è¨€å®ç°äº†è‡ªä¸¾å—ï¼Œcè¯­è¨€è·¨å¹³å°åº•å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Œè¯·è€å¸ˆç­”ç–‘è§£æƒ‘ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ˜¯å› ä¸ºCè¯­è¨€ç¼–è¯‘å®Œäº†å°±ç›´æ¥æ˜¯ç¡¬ä»¶èƒ½å¤Ÿè¯†åˆ«çš„äºŒè¿›åˆ¶ï¼Œä¸åƒjavaï¼Œéœ€è¦jvmæ‰èƒ½è¿è¡Œã€‚Cè¯­è¨€ä¸ç”¨è‡ªä¸¾ï¼Œé™¤äº†ç¬¬ä¸€ä¸ªå¼€å‘Cè¯­è¨€çš„ï¼Œéœ€è¦ç”¨æ±‡ç¼–æ¥åšï¼Œåé¢éƒ½å¯ä»¥ç”¨é”¤å­é€ é”¤å­</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-05-27 22:44:27</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/af/a6/3f15ba2f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>czh</span>
  </div>
  <div class="_2_QraFYR_0">æ•´ä¸ªå†…å­˜çš„è®²è§£ï¼ˆè¿™ä¸ªä¸“æ å†…å®¹å¦‚æœä¸€ä¸‹çœ‹ä¸æ‡‚ç›´æ¥è·³æ€»ç»“éƒ¨åˆ†ï¼Œç”šè‡³æ¯ç« çš„æœ€åï¼Œç°æœ‰ä¸ªæ•´ä½“è®¤è¯†ï¼Œå†è¿”å›å»çœ‹ç»†èŠ‚ï¼Œä¼šå®¹æ˜“å¾ˆå¤šï¼‰</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-11-25 19:26:43</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>è«å</span>
  </div>
  <div class="_2_QraFYR_0">ğŸ‘çœ‹èµ·æ¥å¾ˆæœ‰æ„Ÿè§‰ï¼Œå…ˆè®²ç”¨æˆ·æ€ã€å†…æ ¸æ€è™šæ‹Ÿå†…å­˜çš„ç®¡ç†ï¼Œç„¶åè®²ç‰©ç†å†…å­˜çš„ç®¡ç†ï¼Œæœ€åè®²ç”¨æˆ·æ€ã€å†…æ ¸æ€è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜å¦‚ä½•å»ºç«‹å…³è”ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: èµï¼Œæœ‰æ„Ÿè§‰å°±å¥½ï¼Œè¦çš„å°±æ˜¯å¿ƒåŠ¨</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-07-18 22:26:46</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/8e/bb/c039dc11.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>garlic</span>
  </div>
  <div class="_2_QraFYR_0">ä¼™ä¼´ç³»ç»Ÿåˆ†é…å¥½äº†ç‰©ç†é¡µé¢åˆ°è™šæ‹Ÿåœ°å€:æœ‰ä¸¤ç§æƒ…å†µ<br>1. ç”³è¯·æ—¶è½¬æ¢ï¼Œ <br>ç›´æ¥ä½¿ç”¨ä¼™ä¼´ç³»ç»Ÿç”³è¯·é¡µ,é€šè¿‡page_addressè¿›è¡Œåœ°å€è½¬æ¢ï¼Œå¦‚kmallocç”³è¯·å¤§äº2ä¸ªé¡µé¢æ—¶<br>é€šè¿‡SLABä»ä¼™ä¼´ç³»ç»Ÿç”³è¯·é¡µ,åˆ›å»ºnew slabæ—¶é€šè¿‡page_addressè¿›è¡Œåœ°å€è½¬æ¢, å¦‚vmalloc, VMAç»“æ„ä½“ç”³è¯·æ—¶<br>2. æœ‰è™šæ‹Ÿåœ°å€æŒ‚è½½é¡µé¢<br>æœ‰æŒ‡å®šè™šæ‹Ÿåœ°å€èŒƒå›´ï¼Œå†é€šè¿‡ä¼™ä¼´ç³»ç»Ÿç”³è¯·ç©ºé—´ï¼Œç”³è¯·é‡Šæ”¾æ—¶ç»Ÿä¸€è¿›è¡Œæ›´æ–°é¡µè¡¨é¡¹, å¦‚vmalloc<br>è¯¾å ‚å­¦ä¹ ç¬”è®°ï¼š https:&#47;&#47;garlicspace.com&#47;2020&#47;08&#47;12&#47;%e4%bc%99%e4%bc%b4%e7%b3%bb%e7%bb%9f%e5%88%86%e9%85%8d%e7%89%a9%e7%90%86%e9%a1%b5%e5%90%8e%e5%a6%82%e4%bd%95%e8%bd%ac%e6%8d%a2%e6%88%90%e4%b8%ba%e8%99%9a%e6%8b%9f%e5%9c%b0%e5%9d%80&#47;</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-08-12 05:48:52</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/4b/11/d7e08b5b.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>dll</span>
  </div>
  <div class="_2_QraFYR_0">çœŸçš„åå¤çœ‹äº†å‡ éï¼Œæ²¡ç†è§£init_top_pgté‡Œçš„ä¸‰é¡¹æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Œæˆ‘è§‰å¾—æœ‰æ—¶å€™æ–‡ç« è¿˜æ˜¯æœ‰ç‚¹å†™çš„è¯ä¸è¾¾æ„ï¼Œä»£ç æœ‰ç‚¹ç¼ºå¤±ï¼ŒçœŸçš„çœ‹èµ·æ¥å¥½å¹¸è‹¦</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-03-25 17:00:36</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/e7/2e/1522a7d6.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æ´»çš„æ½‡æ´’</span>
  </div>
  <div class="_2_QraFYR_0">åšæŒå®Œæ•´çš„å­¦åˆ°åº•ï¼ŒåšæŒå®Œæ•´çš„ç¬”è®°åˆ°åº•<br>day26 å­¦ä¹ ç¬”è®°ï¼šhttps:&#47;&#47;www.cnblogs.com&#47;luoahong&#47;p&#47;10931320.html</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: åŠ æ²¹</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-05-27 17:01:22</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/18/90/8f/9c691a5f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å¥”è·‘çš„ç ä»”</span>
  </div>
  <div class="_2_QraFYR_0">page_addressçš„å®ç°å¦‚ä¸‹ï¼š<br><br>```<br>&#47;**<br> * page_address - get the mapped virtual address of a page<br> * @page: &amp;struct page to get the virtual address of<br> *<br> * Returns the page&#39;s virtual address.<br> *&#47;<br>void *page_address(const struct page *page)<br>{<br>	unsigned long flags;<br>	void *ret;<br>	struct page_address_slot *pas;<br><br>	if (!PageHighMem(page))<br>		return lowmem_page_address(page);<br><br>	pas = page_slot(page);<br>	ret = NULL;<br>	spin_lock_irqsave(&amp;pas-&gt;lock, flags);<br>	if (!list_empty(&amp;pas-&gt;lh)) {<br>		struct page_address_map *pam;<br><br>		list_for_each_entry(pam, &amp;pas-&gt;lh, list) {<br>			if (pam-&gt;page == page) {<br>				ret = pam-&gt;virtual;<br>				goto done;<br>			}<br>		}<br>	}<br>done:<br>	spin_unlock_irqrestore(&amp;pas-&gt;lock, flags);<br>	return ret;<br>}<br>```<br><br>- å¦‚æœä¸æ˜¯é«˜ç«¯å†…å­˜ï¼Œç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€ä¹‹é—´çš„è½¬æ¢ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œç›´æ¥ä½¿ç”¨lowmme_page_addressè¿›è¡Œè½¬æ¢ï¼Œå‰é¢æåˆ°è¿‡è¿™ä¸ªå‡½æ•°ï¼›<br>- å¯¹äºéé«˜ç«¯å†…å­˜é¡µï¼Œé€šè¿‡page_slotè®¡ç®—å‡ºpasï¼Œpasä¿å­˜åœ¨ç”±pagezä½œä¸ºkeyçš„hashè¡¨page_address_htableä¸­ï¼›<br>- éå†pas-&gt;lhåŒå‘é“¾è¡¨ï¼Œé“¾è¡¨çš„èŠ‚ç‚¹ä¿å­˜æœ‰pageçš„åœ°å€å’Œpageæ‰€å¯¹åº”çš„è™šæ‹Ÿåœ°å€ï¼Œé€šè¿‡pageï¼Œå¯ä»¥ç¡®å®špageå¯¹åº”çš„è™šæ‹Ÿåœ°å€ã€‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-09-03 16:39:06</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/23/66/413c0bb5.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>LDxy</span>
  </div>
  <div class="_2_QraFYR_0">æ“ä½œç³»ç»Ÿæ˜¯å¦‚ä½•çŸ¥é“è®¡ç®—æœºä¸Šæœ‰å¤šå°‘ç‰©ç†å†…å­˜çš„å‘¢ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šæ£€æµ‹ç¡¬ä»¶</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-06-02 11:35:48</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/NyFOEueITjaGLpakMEuWAqVQjo1uDIXlpDdpCxXGfaWiaXzibLQ3WgOFCe8D9FvCmyjsGT7jDsLUbkt8jt2aVs9g/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>geek</span>
  </div>
  <div class="_2_QraFYR_0">page_address_mapç»“æ„ä½“ä¸­ä¿å­˜äº†pageå’Œå¯¹åº”è™šæ‹Ÿåœ°å€çš„æ˜ å°„å…³ç³»ã€‚<br>æ¯ä¸ªpageå¯¹è±¡ä¿å­˜åœ¨page_address_htableä¸­ï¼Œæ˜ å°„åˆ°ç›¸åŒslotçš„pagesä¼šå½¢æˆä¸€ä¸ªé“¾è¡¨ã€‚page_addressæ–¹æ³•å°±æ˜¯æ ¹æ®pageæ‰¾åˆ°slotï¼Œéå†å¯¹åº”slotçš„é“¾è¡¨ï¼Œæ‰¾åˆ°pageç›¸åŒçš„é‚£é¡¹ï¼Œè¿”å›å…¶å¯¹åº”çš„è™šæ‹Ÿåœ°å€ã€‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-04-04 13:11:40</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/a6/5e/b05254a6.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Mhy</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œçœ‹åˆ°è¿™é‡Œæˆ‘æ˜¯ä¸æ˜¯å¯ä»¥è®¤ä¸ºåœ¨ç”¨æˆ·æ€ä½¿ç”¨mmapå’Œå†…æ ¸æ€ä½¿ç”¨mmapæ˜¯ä¸¤ç äº‹ï¼Œæˆ‘ä»¬ä¸€èˆ¬åº”ç”¨åœºæ™¯æ¯”å¦‚å°†å›¾ç‰‡å†…å­˜ç›´æ¥æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ä¸Šè®¿é—®é¿å…å¤šæ¬¡æ‹·è´ä»è€Œæé«˜å›¾ç‰‡åŠ è½½é€Ÿåº¦ï¼Œé‚£ä¹ˆè¿™ä¸ªåœºæ™¯æ˜¯å‘ç”Ÿåœ¨ç”¨æˆ·æ€ä¸Šé¢ï¼ŒæœŸé—´ä¸éœ€è¦é€šè¿‡å†…æ ¸æ€å—ï¼Ÿè°ƒç”¨ç³»ç»Ÿå‡½æ•°è§¦å‘çš„mmapæ˜¯å‘ç”Ÿåœ¨å†…æ ¸æ€å—ï¼Œæ¯”å¦‚strace ls -l</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ä¸æ˜¯çš„ï¼Œmmapæ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œä¸å­˜åœ¨å†…æ ¸è°ƒç”¨ä»–çš„</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-05-08 14:47:32</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/df/6c/5af32271.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Dylan</span>
  </div>
  <div class="_2_QraFYR_0">æˆ‘è®°å¾—kmalloc åˆ†é…çš„å†…å­˜å¤§å°æœ‰é™åˆ¶çš„ï¼Œ128k</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-01-31 23:56:06</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/54/b2/8811d29f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Bing</span>
  </div>
  <div class="_2_QraFYR_0">ç”¨mallocç”³è¯·çš„å†…å­˜ï¼Œè¿›ç¨‹é€€å‡ºæ—¶ï¼Œæ“ä½œç³»ç»Ÿæ˜¯å¦ä¼šé‡Šæ”¾</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å½“ç„¶ä¼šå•Šï¼Œè™šæ‹Ÿå†…å­˜å˜›</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2019-08-15 19:12:38</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/14/2e/6c/7499cbd4.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>wang</span>
  </div>
  <div class="_2_QraFYR_0">kernel spaceå ç”¨å¯ä»¥è®¡ç®—ä¹ˆï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-04-13 08:12:50</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/56/4e/9291fac0.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Jay</span>
  </div>
  <div class="_2_QraFYR_0">å®šä¹‰çš„æ•°æ®ç»“æ„åå­—å®åœ¨å¤ªå¤šäº†ï¼Œçœ‹ç€çœ‹ç€å°±æ™•äº†ï¼Œå¾ˆç—›è‹¦ã€‚<br><br>è¿˜æ˜¯å¾—æŠŠå†…å­˜ç®¡ç†çš„åŸºæœ¬æ€æƒ³å’Œæ•´ä½“æµç¨‹ææ¸…æ¥šï¼Œæœ€å¥½äº†ç„¶äºèƒ¸ï¼Œè¯»èµ·æ¥æ‰èˆ’æœä¸€äº›ã€‚<br><br>å¦å¤–é‡åˆ°è¿™äº›ç¼©å†™ï¼Œæ¯æ¬¡éƒ½è¦æƒ³è¿™åˆ°åº•æŒ‡ä»£ä»€ä¹ˆç»“æ„ï¼Œæ¯æ¬¡éƒ½å¾—è½¬åŒ–ä¸‹ï¼Œç‰¹åˆ«è´¹è„‘å­ï¼Œæƒ³ç€æƒ³ç€å°±ç´¯äº†ï¼Œä¸€æ¥ä¸€å›ï¼Œå°±è¿·å¤±äº†...... æˆ‘è¦å»éš”å£ä¸“æ è¡¥ä¸€ä¸‹å†…å­˜çš„åŸºç¡€çŸ¥è¯†ã€‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-10-26 11:16:22</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIKoEicqUZTJly55qoUXRmK4wia7YbnibsMncJaO6tKgKAQNJRfpMsibvfeiaukIibsCsuaic8QjQ3gOoTGA/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å¼ å¯å¤«æ–¯åŸº</span>
  </div>
  <div class="_2_QraFYR_0">åšæŒåªçœ‹æ€»ç»“ã€‚ã€‚ã€‚ã€‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-02-27 18:21:29</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/c6/3c/8ab9deb0.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>@è®¸è¿˜çœŸ</span>
  </div>
  <div class="_2_QraFYR_0">å›æ¥å†çœ‹ </div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-01-27 16:52:55</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/2f/7a/ab6c811c.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ç›¸é€¢æ˜¯ç¼˜</span>
  </div>
  <div class="_2_QraFYR_0">ä¸€ç›´æœ‰ä¸€ä¸ªç–‘é—®ï¼Œåº”ç”¨ç©ºé—´å’Œå†…å­˜ç©ºé—´æœ‰å„è‡ªçš„é¡µè¡¨ï¼Œè™šæ‹Ÿå†…å­˜ä¸ºä»€ä¹ˆè¦åˆ’åˆ†ä¸ºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´å‘¢ï¼Œæœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿå†…æ ¸ç©ºé—´å’Œåº”ç”¨ç©ºé—´ä»è™šæ‹Ÿå†…å­˜çœ‹éƒ½èƒ½ç”³è¯·0~4Gçš„å†…å­˜ï¼ˆå‡å¦‚æ˜¯32ä½æœºï¼‰ï¼Œä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸ºå†…æ ¸åˆ†é…å†…å­˜çš„æ—¶å€™ç¡¬è¦è§„å®š3Gä»¥ä¸Šçš„æ‰æ˜¯å†…æ ¸ç”¨çš„å‘¢ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-09 14:19:56</div>
  </div>
</div>
</div>
</li>
</ul>