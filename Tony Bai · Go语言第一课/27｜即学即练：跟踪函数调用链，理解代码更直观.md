<audio title="27ï½œå³å­¦å³ç»ƒï¼šè·Ÿè¸ªå‡½æ•°è°ƒç”¨é“¾ï¼Œç†è§£ä»£ç æ›´ç›´è§‚" src="https://static001.geekbang.org/resource/audio/c1/09/c15c48b02881e79ac737a53481f99209.mp3" controls="controls"></audio> 
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯Tony Baiã€‚</p><p>æ—¶é—´è¿‡å¾—çœŸå¿«ï¼è½¬çœ¼é—´æˆ‘ä»¬å·²ç»å®Œæˆäº†è¿™é—¨è¯¾åŸºç¡€ç¯‡Goè¯­æ³•éƒ¨åˆ†çš„å­¦ä¹ ã€‚åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬ä»å˜é‡å£°æ˜å¼€å§‹ï¼Œä¸€ç›´å­¦åˆ°äº†Goå‡½æ•°ä¸æ–¹æ³•çš„è®¾è®¡ï¼Œä¸çŸ¥é“ä½ æŒæ¡å¾—æ€ä¹ˆæ ·å‘¢ï¼ŸåŸºç¡€ç¯‡çš„é‡ç‚¹æ˜¯<strong>å¯¹GoåŸºç¡€è¯­æ³•éƒ¨åˆ†çš„ç†è§£</strong>ï¼Œåªæœ‰ç†è§£é€äº†ï¼Œæˆ‘ä»¬æ‰èƒ½åœ¨åŠ¨æ‰‹å®è·µçš„ç¯èŠ‚è¿ç”¨è‡ªå¦‚ã€‚</p><p>åŒæ—¶ï¼ŒåŸºç¡€ç¯‡ä¹Ÿæ˜¯æ•´ä¸ªè¯¾ç¨‹ç¯‡å¹…æœ€å¤šçš„éƒ¨åˆ†ï¼Œæƒ³å¿…å­¦åˆ°è¿™é‡Œï¼Œä½ å·®ä¸å¤šä¹Ÿè¿›å…¥äº†ä¸€ä¸ªâ€œç–²åŠ³æœŸâ€ã€‚ä¸ºäº†ç»™ä½ çš„å¤§è„‘â€œå……å……ç”µâ€ï¼Œæˆ‘åœ¨è¿™ä¸€è®²ï¼Œä¹Ÿå°±æ˜¯åŸºç¡€ç¯‡çš„æœ€åä¸€è®²ä¸­å®‰æ’äº†ä¸€ä¸ªå°å®æˆ˜é¡¹ç›®ï¼Œé€‚å½“æ”¾æ¾ä¸€ä¸‹ï¼Œä¹Ÿå¸Œæœ›ä½ åœ¨å®ç°è¿™ä¸ªå®æˆ˜é¡¹ç›®çš„è¿‡ç¨‹ä¸­ï¼Œèƒ½å¯¹åŸºç¡€ç¯‡æ‰€å­¦çš„å†…å®¹åšä¸€ä¸ªå›é¡¾ä¸æ€»ç»“ï¼Œå¤¯å®ä¸€ä¸‹Goçš„è¯­æ³•åŸºç¡€ã€‚</p><h2>å¼•å­</h2><p>åœ¨å‰é¢çš„<a href="https://time.geekbang.org/column/article/464273">ç¬¬23è®²</a>ä¸­ï¼Œæˆ‘æ›¾ç•™è¿‡è¿™æ ·çš„ä¸€é“æ€è€ƒé¢˜ï¼šâ€œé™¤äº†æ•æ‰panicã€å»¶è¿Ÿé‡Šæ”¾èµ„æºå¤–ï¼Œæˆ‘ä»¬æ—¥å¸¸ç¼–ç ä¸­è¿˜æœ‰å“ªäº›ä½¿ç”¨deferçš„å°æŠ€å·§å‘¢ï¼Ÿâ€</p><p>è¿™ä¸ªæ€è€ƒé¢˜å¾—åˆ°äº†åŒå­¦ä»¬çš„çƒ­çƒˆå“åº”ï¼Œæœ‰åŒå­¦åœ¨ç•™è¨€åŒºæåˆ°ï¼š<strong>ä½¿ç”¨deferå¯ä»¥è·Ÿè¸ªå‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹</strong>ã€‚æ²¡é”™ï¼è¿™çš„ç¡®æ˜¯deferçš„ä¸€ä¸ªå¸¸è§çš„ä½¿ç”¨æŠ€å·§ï¼Œå¾ˆå¤šGoæ•™ç¨‹åœ¨è®²è§£deferæ—¶ä¹Ÿä¼šç»å¸¸ä½¿ç”¨è¿™ä¸ªç”¨é€”ä¸¾ä¾‹ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å…·ä½“æ˜¯æ€ä¹ˆç”¨deferæ¥å®ç°å‡½æ•°æ‰§è¡Œè¿‡ç¨‹çš„è·Ÿè¸ªå‘¢ï¼Ÿè¿™é‡Œï¼Œæˆ‘ç»™å‡ºäº†ä¸€ä¸ªæœ€ç®€å•çš„å®ç°ï¼š</p><pre><code class="language-plain">// trace.go
package main
  
func Trace(name string) func() {
    println("enter:", name)
    return func() {
        println("exit:", name)
    }
}

func foo() {
    defer Trace("foo")()
    bar()
}

func bar() {
    defer Trace("bar")()
}

func main() {
    defer Trace("main")()
    foo()
}
</code></pre><!-- [[[read_end]]] --><p>åœ¨è®²è§£è¿™æ®µä»£ç çš„åŸç†ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¿™æ®µä»£ç çš„æ‰§è¡Œç»“æœï¼Œç›´è§‚æ„Ÿå—ä¸€ä¸‹ä»€ä¹ˆæ˜¯<strong>å‡½æ•°è°ƒç”¨è·Ÿè¸ª</strong>ï¼š</p><pre><code class="language-plain">enter: main
enter: foo
enter: bar
exit: bar
exit: foo
exit: main
</code></pre><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œè¿™ä¸ªGoç¨‹åºçš„å‡½æ•°è°ƒç”¨çš„å…¨è¿‡ç¨‹ä¸€ç›®äº†ç„¶åœ°å±•ç°åœ¨äº†æˆ‘ä»¬é¢å‰ï¼šç¨‹åºæŒ‰<code>main -&gt; foo -&gt; bar</code>çš„å‡½æ•°è°ƒç”¨æ¬¡åºæ‰§è¡Œï¼Œä»£ç åœ¨å‡½æ•°çš„å…¥å£ä¸å‡ºå£å¤„åˆ†åˆ«è¾“å‡ºäº†è·Ÿè¸ªæ—¥å¿—ã€‚</p><p>é‚£è¿™æ®µä»£ç æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿæˆ‘ä»¬ç®€è¦åˆ†æä¸€ä¸‹ã€‚</p><p>åœ¨è¿™æ®µå®ç°ä¸­ï¼Œæˆ‘ä»¬åœ¨æ¯ä¸ªå‡½æ•°çš„å…¥å£å¤„éƒ½ä½¿ç”¨deferè®¾ç½®äº†ä¸€ä¸ªdeferredå‡½æ•°ã€‚æ ¹æ®<a href="https://time.geekbang.org/column/article/464273">ç¬¬23è®²</a>ä¸­è®²è§£çš„deferçš„è¿ä½œæœºåˆ¶ï¼ŒGoä¼šåœ¨deferè®¾ç½®deferredå‡½æ•°æ—¶å¯¹deferåé¢çš„è¡¨è¾¾å¼è¿›è¡Œæ±‚å€¼ã€‚</p><p>æˆ‘ä»¬ä»¥fooå‡½æ•°ä¸­çš„<code>defer Trace("foo")()</code>è¿™è¡Œä»£ç ä¸ºä¾‹ï¼ŒGoä¼šå¯¹deferåé¢çš„è¡¨è¾¾å¼<code>Trace("foo")()</code>è¿›è¡Œæ±‚å€¼ã€‚ç”±äºè¿™ä¸ªè¡¨è¾¾å¼åŒ…å«ä¸€ä¸ªå‡½æ•°è°ƒç”¨<code>Trace("foo")</code>ï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°ä¼šè¢«æ‰§è¡Œã€‚</p><p>ä¸Šé¢çš„Traceå‡½æ•°åªæ¥å—ä¸€ä¸ªå‚æ•°ï¼ŒË™è¿™ä¸ªå‚æ•°ä»£è¡¨å‡½æ•°åï¼ŒTraceä¼šé¦–å…ˆæ‰“å°è¿›å…¥æŸå‡½æ•°çš„æ—¥å¿—ï¼Œæ¯”å¦‚ï¼š<code>â€œenter: fooâ€</code>ã€‚ç„¶åè¿”å›ä¸€ä¸ªé—­åŒ…å‡½æ•°ï¼Œè¿™ä¸ªé—­åŒ…å‡½æ•°ä¸€æ—¦è¢«æ‰§è¡Œï¼Œå°±ä¼šè¾“å‡ºç¦»å¼€æŸå‡½æ•°çš„æ—¥å¿—ã€‚åœ¨fooå‡½æ•°ä¸­ï¼Œè¿™ä¸ªç”±Traceå‡½æ•°è¿”å›çš„é—­åŒ…å‡½æ•°å°±è¢«è®¾ç½®ä¸ºäº†deferredå‡½æ•°ï¼Œäºæ˜¯å½“fooå‡½æ•°è¿”å›åï¼Œè¿™ä¸ªé—­åŒ…å‡½æ•°å°±ä¼šè¢«æ‰§è¡Œï¼Œè¾“å‡º<code>â€œexit: fooâ€</code>çš„æ—¥å¿—ã€‚</p><p>ææ¸…æ¥šä¸Šé¢è·Ÿè¸ªå‡½æ•°è°ƒç”¨é“¾çš„å®ç°åŸç†åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™ä¸ªå®ç°ã€‚æˆ‘ä»¬ä¼šå‘ç°è¿™é‡Œè¿˜æ˜¯æœ‰ä¸€äº›<strong>â€œç‘•ç–µâ€</strong>ï¼Œä¹Ÿå°±æ˜¯ç¦»æˆ‘ä»¬æœŸæœ›çš„â€œè·Ÿè¸ªå‡½æ•°è°ƒç”¨é“¾â€çš„å®ç°è¿˜æœ‰ä¸€äº›ä¸è¶³ä¹‹å¤„ã€‚è¿™é‡Œæˆ‘åˆ—ä¸¾äº†å‡ ç‚¹ï¼š</p><ul>
<li>è°ƒç”¨Traceæ—¶éœ€æ‰‹åŠ¨æ˜¾å¼ä¼ å…¥è¦è·Ÿè¸ªçš„å‡½æ•°åï¼›</li>
<li>å¦‚æœæ˜¯å¹¶å‘åº”ç”¨ï¼Œä¸åŒGoroutineä¸­å‡½æ•°é“¾è·Ÿè¸ªæ··åœ¨ä¸€èµ·æ— æ³•åˆ†è¾¨ï¼›</li>
<li>è¾“å‡ºçš„è·Ÿè¸ªç»“æœç¼ºå°‘å±‚æ¬¡æ„Ÿï¼Œè°ƒç”¨å…³ç³»ä¸æ˜“è¯†åˆ«ï¼›</li>
<li>å¯¹è¦è·Ÿè¸ªçš„å‡½æ•°ï¼Œéœ€æ‰‹åŠ¨è°ƒç”¨Traceå‡½æ•°ã€‚</li>
</ul><p>é‚£ä¹ˆï¼Œè¿™ä¸€è®²æˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯é€ä¸€åˆ†æå¹¶è§£å†³ä¸Šé¢æå‡ºçš„è¿™å‡ ç‚¹é—®é¢˜è¿›è¡Œï¼Œç»è¿‡é€æ­¥åœ°ä»£ç æ¼”è¿›ï¼Œæœ€ç»ˆ<strong>å®ç°ä¸€ä¸ªè‡ªåŠ¨æ³¨å…¥è·Ÿè¸ªä»£ç ï¼Œå¹¶è¾“å‡ºæœ‰å±‚æ¬¡æ„Ÿçš„å‡½æ•°è°ƒç”¨é“¾è·Ÿè¸ªå‘½ä»¤è¡Œå·¥å…·</strong>ã€‚</p><p>å¥½ï¼Œä¸‹é¢æˆ‘ä»¬å…ˆæ¥è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ã€‚</p><h2>è‡ªåŠ¨è·å–æ‰€è·Ÿè¸ªå‡½æ•°çš„å‡½æ•°å</h2><p>è¦è§£å†³â€œè°ƒç”¨Traceæ—¶éœ€è¦æ‰‹åŠ¨æ˜¾å¼ä¼ å…¥è¦è·Ÿè¸ªçš„å‡½æ•°åâ€çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¦è®©æˆ‘ä»¬çš„Traceå‡½æ•°èƒ½å¤Ÿè‡ªåŠ¨è·å–åˆ°å®ƒè·Ÿè¸ªå‡½æ•°çš„å‡½æ•°åä¿¡æ¯ã€‚æˆ‘ä»¬ä»¥è·Ÿè¸ªfooä¸ºä¾‹ï¼Œçœ‹çœ‹è¿™æ ·åšèƒ½ç»™æˆ‘ä»¬å¸¦æ¥ä»€ä¹ˆå¥½å¤„ã€‚</p><p>åœ¨æ‰‹åŠ¨æ˜¾å¼ä¼ å…¥çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ä¸‹é¢è¿™ä¸ªä»£ç å¯¹fooè¿›è¡Œè·Ÿè¸ªï¼š</p><pre><code class="language-plain">defer Trace("foo")()
</code></pre><p>ä¸€æ—¦å®ç°äº†è‡ªåŠ¨è·å–å‡½æ•°åï¼Œæ‰€æœ‰æ”¯æŒå‡½æ•°è°ƒç”¨é“¾è·Ÿè¸ªçš„å‡½æ•°éƒ½åªéœ€ä½¿ç”¨ä¸‹é¢è°ƒç”¨å½¢å¼çš„Traceå‡½æ•°å°±å¯ä»¥äº†ï¼š</p><pre><code class="language-plain">defer Trace()()
</code></pre><p>è¿™ç§ä¸€è‡´çš„Traceå‡½æ•°è°ƒç”¨æ–¹å¼ä¹Ÿä¸ºåç»­çš„è‡ªåŠ¨å‘ä»£ç ä¸­æ³¨å…¥Traceå‡½æ•°å¥ å®šäº†åŸºç¡€ã€‚é‚£ä¹ˆå¦‚ä½•å®ç°Traceå‡½æ•°å¯¹å®ƒè·Ÿè¸ªå‡½æ•°åçš„è‡ªåŠ¨è·å–å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦å€ŸåŠ©Goæ ‡å‡†åº“runtimeåŒ…çš„å¸®åŠ©ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘ç»™å‡ºäº†æ–°ç‰ˆTraceå‡½æ•°çš„å®ç°ä»¥åŠå®ƒçš„ä½¿ç”¨æ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ï¼š</p><pre><code class="language-plain">// trace1/trace.go

func Trace() func() {
    pc, _, _, ok := runtime.Caller(1)
    if !ok {
        panic("not found caller")
    }

    fn := runtime.FuncForPC(pc)
    name := fn.Name()

    println("enter:", name)
    return func() { println("exit:", name) }
}

func foo() {
    defer Trace()()
    bar()
}

func bar() {
    defer Trace()()
}

func main() {
    defer Trace()()
    foo()
}
</code></pre><p>åœ¨è¿™ä¸€ç‰ˆTraceå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡runtime.Callerå‡½æ•°è·å¾—å½“å‰Goroutineçš„å‡½æ•°è°ƒç”¨æ ˆä¸Šçš„ä¿¡æ¯ï¼Œruntime.Callerçš„å‚æ•°æ ‡è¯†çš„æ˜¯è¦è·å–çš„æ˜¯å“ªä¸€ä¸ªæ ˆå¸§çš„ä¿¡æ¯ã€‚å½“å‚æ•°ä¸º0æ—¶ï¼Œè¿”å›çš„æ˜¯Callerå‡½æ•°çš„è°ƒç”¨è€…çš„å‡½æ•°ä¿¡æ¯ï¼Œåœ¨è¿™é‡Œå°±æ˜¯Traceå‡½æ•°ã€‚ä½†æˆ‘ä»¬éœ€è¦çš„æ˜¯Traceå‡½æ•°çš„è°ƒç”¨è€…çš„ä¿¡æ¯ï¼Œäºæ˜¯æˆ‘ä»¬ä¼ å…¥1ã€‚</p><p>Callerå‡½æ•°æœ‰å››ä¸ªè¿”å›å€¼ï¼šç¬¬ä¸€ä¸ªè¿”å›å€¼ä»£è¡¨çš„æ˜¯ç¨‹åºè®¡æ•°ï¼ˆpcï¼‰ï¼›ç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªå‚æ•°ä»£è¡¨å¯¹åº”å‡½æ•°æ‰€åœ¨çš„æºæ–‡ä»¶åä»¥åŠæ‰€åœ¨è¡Œæ•°ï¼Œè¿™é‡Œæˆ‘ä»¬æš‚æ—¶ä¸éœ€è¦ï¼›æœ€åä¸€ä¸ªå‚æ•°ä»£è¡¨æ˜¯å¦èƒ½æˆåŠŸè·å–è¿™äº›ä¿¡æ¯ï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œæˆ‘ä»¬æŠ›å‡ºpanicã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡runtime.FuncForPCå‡½æ•°å’Œç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰å¾—åˆ°è¢«è·Ÿè¸ªå‡½æ•°çš„å‡½æ•°åç§°ã€‚æˆ‘ä»¬è¿è¡Œä¸€ä¸‹æ”¹é€ åä»£ç ï¼š</p><pre><code class="language-plain">enter: main.main
enter: main.foo
enter: main.bar
exit: main.bar
exit: main.foo
exit: main.main
</code></pre><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œruntime.FuncForPCè¿”å›çš„åç§°ä¸­ä¸ä»…ä»…åŒ…å«å‡½æ•°åï¼Œè¿˜åŒ…å«äº†è¢«è·Ÿè¸ªå‡½æ•°æ‰€åœ¨çš„åŒ…åã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ç¬¬ä¸€ä¸ªé—®é¢˜å·²ç»åœ†æ»¡è§£å†³äº†ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è§£å†³ç¬¬äºŒä¸ªé—®é¢˜ï¼Œä¹Ÿå°±æ˜¯å½“ç¨‹åºä¸­æœ‰å¤šGoroutineæ—¶ï¼ŒTraceè¾“å‡ºçš„è·Ÿè¸ªä¿¡æ¯æ··æ‚åœ¨ä¸€èµ·éš¾ä»¥åˆ†è¾¨çš„é—®é¢˜ã€‚</p><h2>å¢åŠ Goroutineæ ‡è¯†</h2><p>ä¸Šé¢çš„Traceå‡½æ•°åœ¨é¢å¯¹åªæœ‰ä¸€ä¸ªGoroutineçš„æ—¶å€™ï¼Œè¿˜æ˜¯å¯ä»¥æ”¯æ’‘çš„ï¼Œä½†å½“ç¨‹åºä¸­å¹¶å‘è¿è¡Œå¤šä¸ªGoroutineçš„æ—¶å€™ï¼Œå¤šä¸ªå‡½æ•°è°ƒç”¨é“¾çš„å‡ºå…¥å£ä¿¡æ¯è¾“å‡ºå°±ä¼šæ··æ‚åœ¨ä¸€èµ·ï¼Œæ— æ³•åˆ†è¾¨ã€‚</p><p>é‚£ä¹ˆï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¿˜ç»§ç»­å¯¹Traceå‡½æ•°è¿›è¡Œæ”¹é€ ï¼Œè®©å®ƒæ”¯æŒå¤šGoroutineå‡½æ•°è°ƒç”¨é“¾çš„è·Ÿè¸ªã€‚æˆ‘ä»¬çš„æ–¹æ¡ˆå°±æ˜¯<strong>åœ¨è¾“å‡ºçš„å‡½æ•°å‡ºå…¥å£ä¿¡æ¯æ—¶ï¼Œå¸¦ä¸Šä¸€ä¸ªåœ¨ç¨‹åºæ¯æ¬¡æ‰§è¡Œæ—¶èƒ½å”¯ä¸€åŒºåˆ†Goroutineçš„Goroutine ID</strong>ã€‚</p><p>åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šè¯´ï¼ŒGoroutineä¹Ÿæ²¡æœ‰IDä¿¡æ¯å•Šï¼çš„ç¡®å¦‚æ­¤ï¼ŒGoæ ¸å¿ƒå›¢é˜Ÿä¸ºäº†é¿å…<a href="https://groups.google.com/g/golang-nuts/c/0HGyCOrhuuI/m/BjkXjGkMJrgJ">Goroutine IDçš„æ»¥ç”¨</a>ï¼Œæ•…æ„æ²¡æœ‰å°†Goroutine IDæš´éœ²ç»™å¼€å‘è€…ã€‚ä½†åœ¨Goæ ‡å‡†åº“çš„h2_bundle.goä¸­ï¼Œæˆ‘ä»¬å´å‘ç°äº†ä¸€ä¸ªè·å–Goroutine IDçš„æ ‡å‡†æ–¹æ³•ï¼Œçœ‹ä¸‹é¢ä»£ç ï¼š</p><pre><code class="language-plain">// $GOROOT/src/net/http/h2_bundle.go
var http2goroutineSpace = []byte("goroutine ")

func http2curGoroutineID() uint64 {
    bp := http2littleBuf.Get().(*[]byte)
    defer http2littleBuf.Put(bp)
    b := *bp
    b = b[:runtime.Stack(b, false)]
    // Parse the 4707 out of "goroutine 4707 ["
    b = bytes.TrimPrefix(b, http2goroutineSpace)
    i := bytes.IndexByte(b, ' ')
    if i &lt; 0 {
        panic(fmt.Sprintf("No space found in %q", b))
    }
    b = b[:i]
    n, err := http2parseUintBytes(b, 10, 64)
    if err != nil {
        panic(fmt.Sprintf("Failed to parse goroutine ID out of %q: %v", b, err))
    }
    return n
}
</code></pre><p>ä¸è¿‡ï¼Œç”±äºhttp2curGoroutineIDä¸æ˜¯ä¸€ä¸ªå¯¼å‡ºå‡½æ•°ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥ä½¿ç”¨ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒå¤åˆ¶å‡ºæ¥æ”¹é€ ä¸€ä¸‹ï¼š</p><pre><code class="language-plain">// trace2/trace.go
var goroutineSpace = []byte("goroutine ")

func curGoroutineID() uint64 {
    b := make([]byte, 64)
    b = b[:runtime.Stack(b, false)]
    // Parse the 4707 out of "goroutine 4707 ["
    b = bytes.TrimPrefix(b, goroutineSpace)
    i := bytes.IndexByte(b, ' ')
    if i &lt; 0 {
        panic(fmt.Sprintf("No space found in %q", b))
    }
    b = b[:i]
    n, err := strconv.ParseUint(string(b), 10, 64)
    if err != nil {
        panic(fmt.Sprintf("Failed to parse goroutine ID out of %q: %v", b, err))
    }
    return n
}
</code></pre><p>è¿™é‡Œï¼Œæˆ‘ä»¬æ”¹é€ äº†ä¸¤ä¸ªåœ°æ–¹ã€‚ä¸€ä¸ªåœ°æ–¹æ˜¯é€šè¿‡ç›´æ¥åˆ›å»ºä¸€ä¸ªbyteåˆ‡ç‰‡èµ‹å€¼ç»™bï¼Œæ›¿ä»£åŸhttp2curGoroutineIDå‡½æ•°ä¸­ä»ä¸€ä¸ªpoolæ± è·å–byteåˆ‡ç‰‡çš„æ–¹å¼ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ä½¿ç”¨strconv.ParseUintæ›¿ä»£äº†åŸå…ˆçš„http2parseUintBytesã€‚æ”¹é€ åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ä½¿ç”¨curGoroutineIDå‡½æ•°æ¥è·å–Goroutineçš„IDä¿¡æ¯äº†ã€‚</p><p>å¥½ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨Traceå‡½æ•°ä¸­æ·»åŠ Goroutine IDä¿¡æ¯çš„è¾“å‡ºï¼š</p><pre><code class="language-plain">// trace2/trace.go
func Trace() func() {
    pc, _, _, ok := runtime.Caller(1)
    if !ok {
        panic("not found caller")
    }

    fn := runtime.FuncForPC(pc)
    name := fn.Name()

    gid := curGoroutineID()
    fmt.Printf("g[%05d]: enter: [%s]\n", gid, name)
    return func() { fmt.Printf("g[%05d]: exit: [%s]\n", gid, name) }
}
</code></pre><p>ä»ä¸Šé¢ä»£ç çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨å‡ºå…¥å£è¾“å‡ºçš„è·Ÿè¸ªä¿¡æ¯ä¸­åŠ å…¥äº†Goroutine IDä¿¡æ¯ï¼Œæˆ‘ä»¬è¾“å‡ºçš„Goroutine IDä¸º5ä½æ•°å­—ï¼Œå¦‚æœIDå€¼ä¸è¶³5ä½ï¼Œåˆ™å·¦è¡¥é›¶ï¼Œè¿™ä¸€åˆ‡éƒ½æ˜¯Printfå‡½æ•°çš„æ ¼å¼æ§åˆ¶å­—ç¬¦ä¸²â€œ%05dâ€å¸®åŠ©æˆ‘ä»¬å®ç°çš„ã€‚è¿™æ ·å¯¹é½Goroutine IDçš„ä½æ•°ï¼Œä¸ºçš„æ˜¯è¾“å‡ºä¿¡æ¯æ ¼å¼çš„ä¸€è‡´æ€§æ›´å¥½ã€‚å¦‚æœä½ çš„Goç¨‹åºä¸­Goroutineçš„æ•°é‡è¶…è¿‡äº†5ä½æ•°å¯ä»¥è¡¨ç¤ºçš„æ•°å€¼èŒƒå›´ï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œè°ƒæ•´æ§åˆ¶å­—ç¬¦ä¸²ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¹Ÿè¦å¯¹ç¤ºä¾‹è¿›è¡Œä¸€äº›è°ƒæ•´ï¼Œå°†è¿™ä¸ªç¨‹åºç”±å•Goroutineæ”¹ä¸ºå¤šGoroutineå¹¶å‘çš„ï¼Œè¿™æ ·æ‰èƒ½éªŒè¯æ”¯æŒå¤šGoroutineçš„æ–°ç‰ˆTraceå‡½æ•°æ˜¯å¦å¥½ç”¨ï¼š</p><pre><code class="language-plain">// trace2/trace.go
func A1() {
    defer Trace()()
    B1()
}

func B1() {
    defer Trace()()
    C1()
}

func C1() {
    defer Trace()()
    D()
}

func D() {
    defer Trace()()
}

func A2() {
    defer Trace()()
    B2()
}
func B2() {
    defer Trace()()
    C2()
}
func C2() {
    defer Trace()()
    D()
}

func main() {
    var wg sync.WaitGroup
    wg.Add(1)
    go func() {
        A2()
        wg.Done()
    }()

    A1()
    wg.Wait()
}
</code></pre><p>æ–°ç¤ºä¾‹ç¨‹åºå…±æœ‰ä¸¤ä¸ªGoroutineï¼Œmain groutineçš„è°ƒç”¨é“¾ä¸º<code>A1 -&gt; B1 -&gt; C1 -&gt; D</code>ï¼Œè€Œå¦å¤–ä¸€ä¸ªGoroutineçš„å‡½æ•°è°ƒç”¨é“¾ä¸º<code>A2 -&gt; B2 -&gt; C2 -&gt; D</code>ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç¨‹åºçš„æ‰§è¡Œç»“æœæ˜¯å¦å’ŒåŸä»£ç ä¸­ä¸¤ä¸ªGoroutineçš„è°ƒç”¨é“¾ä¸€è‡´ï¼š</p><pre><code class="language-plain">g[00001]: enter: [main.A1]
g[00001]: enter: [main.B1]
g[00018]: enter: [main.A2]
g[00001]: enter: [main.C1]
g[00001]: enter: [main.D]
g[00001]: exit: [main.D]
g[00001]: exit: [main.C1]
g[00001]: exit: [main.B1]
g[00001]: exit: [main.A1]
g[00018]: enter: [main.B2]
g[00018]: enter: [main.C2]
g[00018]: enter: [main.D]
g[00018]: exit: [main.D]
g[00018]: exit: [main.C2]
g[00018]: exit: [main.B2]
g[00018]: exit: [main.A2]
</code></pre><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œæ–°ç¤ºä¾‹ç¨‹åºè¾“å‡ºäº†å¸¦æœ‰Goroutine IDçš„å‡ºå…¥å£è·Ÿè¸ªä¿¡æ¯ï¼Œé€šè¿‡Goroutine IDæˆ‘ä»¬å¯ä»¥å¿«é€Ÿç¡®è®¤æŸä¸€è¡Œè¾“å‡ºæ˜¯å±äºå“ªä¸ªGoroutineçš„ã€‚</p><p>ä½†ç”±äºGoè¿è¡Œæ—¶å¯¹Goroutineè°ƒåº¦é¡ºåºçš„ä¸ç¡®å®šæ€§ï¼Œå„ä¸ªGoroutineçš„è¾“å‡ºè¿˜æ˜¯ä¼šå­˜åœ¨äº¤ç»‡åœ¨ä¸€èµ·çš„é—®é¢˜ï¼Œè¿™ä¼šç»™ä½ æŸ¥çœ‹æŸä¸ªGoroutineçš„å‡½æ•°è°ƒç”¨é“¾è·Ÿè¸ªä¿¡æ¯å¸¦æ¥é˜»ç¢ã€‚è¿™é‡Œæˆ‘æä¾›ä¸€ä¸ª<strong>å°æŠ€å·§</strong>ï¼šä½ å¯ä»¥å°†ç¨‹åºçš„è¾“å‡ºé‡å®šå‘åˆ°ä¸€ä¸ªæœ¬åœ°æ–‡ä»¶ä¸­ï¼Œç„¶åé€šè¿‡Goroutine IDè¿‡æ»¤å‡ºï¼ˆå¯ä½¿ç”¨grepå·¥å…·ï¼‰ä½ æƒ³æŸ¥çœ‹çš„groutineçš„å…¨éƒ¨å‡½æ•°è·Ÿè¸ªä¿¡æ¯ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å®ç°äº†è¾“å‡ºå¸¦æœ‰Goroutine IDçš„å‡½æ•°è·Ÿè¸ªä¿¡æ¯ï¼Œä¸è¿‡ï¼Œä½ æ˜¯ä¸æ˜¯ä¹Ÿè§‰å¾—è¾“å‡ºçš„å‡½æ•°è°ƒç”¨é“¾ä¿¡æ¯è¿˜æ˜¯ä¸å¤Ÿç¾è§‚ï¼Œç¼ºå°‘å±‚æ¬¡æ„Ÿï¼Œä½“éªŒä¾æ—§ä¸é‚£ä¹ˆä¼˜ç§€å‘¢ï¼Ÿè‡³å°‘æˆ‘æ˜¯è¿™ä¹ˆè§‰å¾—çš„ã€‚æ‰€ä»¥ä¸‹é¢æˆ‘ä»¬å°±æ¥ç¾åŒ–ä¸€ä¸‹ä¿¡æ¯çš„è¾“å‡ºå½¢å¼ã€‚</p><h2>è®©è¾“å‡ºçš„è·Ÿè¸ªä¿¡æ¯æ›´å…·å±‚æ¬¡æ„Ÿ</h2><p>å¯¹äºç¨‹åºå‘˜æ¥è¯´ï¼Œç¼©è¿›æ˜¯æœ€èƒ½ä½“ç°å‡ºâ€œå±‚æ¬¡æ„Ÿâ€çš„æ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬å°†ä¸Šé¢ç¤ºä¾‹ä¸­Goroutine 00001çš„å‡½æ•°è°ƒç”¨è·Ÿè¸ªä¿¡æ¯ä»¥ä¸‹é¢çš„å½¢å¼å±•ç¤ºå‡ºæ¥ï¼Œå‡½æ•°çš„è°ƒç”¨é¡ºåºæ˜¯ä¸æ˜¯æ›´åŠ ä¸€ç›®äº†ç„¶äº†å‘¢ï¼Ÿ</p><pre><code class="language-plain">g[00001]:    -&gt;main.A1
g[00001]:        -&gt;main.B1
g[00001]:            -&gt;main.C1
g[00001]:                -&gt;main.D
g[00001]:                &lt;-main.D
g[00001]:            &lt;-main.C1
g[00001]:        &lt;-main.B1
g[00001]:    &lt;-main.A1
</code></pre><p>é‚£ä¹ˆæˆ‘ä»¬å°±ä»¥è¿™ä¸ªå½¢å¼ä¸ºç›®æ ‡ï¼Œè€ƒè™‘å¦‚ä½•å®ç°è¾“å‡ºè¿™ç§å¸¦ç¼©è¿›çš„å‡½æ•°è°ƒç”¨è·Ÿè¸ªä¿¡æ¯ã€‚æˆ‘ä»¬è¿˜æ˜¯ç›´æ¥ä¸Šä»£ç å§ï¼š</p><pre><code class="language-plain">// trace3/trace.go

func printTrace(id uint64, name, arrow string, indent int) {
    indents := ""
    for i := 0; i &lt; indent; i++ {
        indents += "    "
    }
    fmt.Printf("g[%05d]:%s%s%s\n", id, indents, arrow, name)
}

var mu sync.Mutex
var m = make(map[uint64]int)

func Trace() func() {
    pc, _, _, ok := runtime.Caller(1)
    if !ok {
        panic("not found caller")
    }

    fn := runtime.FuncForPC(pc)
    name := fn.Name()
    gid := curGoroutineID()

    mu.Lock()
    indents := m[gid]    // è·å–å½“å‰gidå¯¹åº”çš„ç¼©è¿›å±‚æ¬¡
    m[gid] = indents + 1 // ç¼©è¿›å±‚æ¬¡+1åå­˜å…¥map
    mu.Unlock()
    printTrace(gid, name, "-&gt;", indents+1)
    return func() {
        mu.Lock()
        indents := m[gid]    // è·å–å½“å‰gidå¯¹åº”çš„ç¼©è¿›å±‚æ¬¡
        m[gid] = indents - 1 // ç¼©è¿›å±‚æ¬¡-1åå­˜å…¥map
        mu.Unlock()
        printTrace(gid, name, "&lt;-", indents)
    }
}
</code></pre><p>åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªmapç±»å‹å˜é‡mæ¥ä¿å­˜æ¯ä¸ªGoroutineå½“å‰çš„ç¼©è¿›ä¿¡æ¯ï¼šmçš„keyä¸ºGoroutineçš„IDï¼Œå€¼ä¸ºç¼©è¿›çš„å±‚æ¬¡ã€‚ç„¶åï¼Œè€ƒè™‘åˆ°Traceå‡½æ•°å¯èƒ½åœ¨å¹¶å‘ç¯å¢ƒä¸­è¿è¡Œï¼Œæ ¹æ®æˆ‘ä»¬åœ¨<a href="https://time.geekbang.org/column/article/446032">ç¬¬16è®²</a>ä¸­æåˆ°çš„â€œmapä¸æ”¯æŒå¹¶å‘å†™â€çš„æ³¨æ„äº‹é¡¹ï¼Œæˆ‘ä»¬å¢åŠ äº†ä¸€ä¸ªsync.Mutexå®ä¾‹muç”¨äºåŒæ­¥å¯¹mçš„å†™æ“ä½œã€‚</p><p>è¿™æ ·ï¼Œå¯¹äºä¸€ä¸ªGoroutineæ¥è¯´ï¼Œæ¯æ¬¡åˆšè¿›å…¥ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œæˆ‘ä»¬å°±åœ¨è¾“å‡ºå…¥å£è·Ÿè¸ªä¿¡æ¯ä¹‹å‰ï¼Œå°†ç¼©è¿›å±‚æ¬¡åŠ ä¸€ï¼Œå¹¶è¾“å‡ºå…¥å£è·Ÿè¸ªä¿¡æ¯ï¼ŒåŠ ä¸€åçš„ç¼©è¿›å±‚æ¬¡å€¼ä¹Ÿä¿å­˜åˆ°mapä¸­ã€‚ç„¶åï¼Œåœ¨å‡½æ•°é€€å‡ºå‰ï¼Œæˆ‘ä»¬å–å‡ºå½“å‰ç¼©è¿›å±‚æ¬¡å€¼å¹¶è¾“å‡ºå‡ºå£è·Ÿè¸ªä¿¡æ¯ï¼Œä¹‹åå†å°†ç¼©è¿›å±‚æ¬¡å‡ä¸€åä¿å­˜åˆ°mapä¸­ã€‚</p><p>é™¤äº†å¢åŠ ç¼©è¿›å±‚æ¬¡ä¿¡æ¯å¤–ï¼Œåœ¨è¿™ä¸€ç‰ˆçš„Traceå‡½æ•°å®ç°ä¸­ï¼Œæˆ‘ä»¬ä¹ŸæŠŠè¾“å‡ºå‡ºå…¥å£è·Ÿè¸ªä¿¡æ¯çš„æ“ä½œæå–åˆ°äº†ä¸€ä¸ªç‹¬ç«‹çš„å‡½æ•°printTraceä¸­ï¼Œè¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®ä¼ å…¥çš„Goroutine IDã€å‡½æ•°åã€ç®­å¤´ç±»å‹ä¸ç¼©è¿›å±‚æ¬¡å€¼ï¼ŒæŒ‰é¢„å®šçš„æ ¼å¼æ‹¼æ¥è·Ÿè¸ªä¿¡æ¯å¹¶è¾“å‡ºã€‚</p><p>è¿è¡Œæ–°ç‰ˆç¤ºä¾‹ä»£ç ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸‹é¢çš„ç»“æœï¼š</p><pre><code class="language-plain">g[00001]:    -&gt;main.A1
g[00001]:        -&gt;main.B1
g[00001]:            -&gt;main.C1
g[00001]:                -&gt;main.D
g[00001]:                &lt;-main.D
g[00001]:            &lt;-main.C1
g[00001]:        &lt;-main.B1
g[00001]:    &lt;-main.A1
g[00018]:    -&gt;main.A2
g[00018]:        -&gt;main.B2
g[00018]:            -&gt;main.C2
g[00018]:                -&gt;main.D
g[00018]:                &lt;-main.D
g[00018]:            &lt;-main.C2
g[00018]:        &lt;-main.B2
g[00018]:    &lt;-main.A2
</code></pre><p>æ˜¾ç„¶ï¼Œé€šè¿‡è¿™ç§å¸¦æœ‰ç¼©è¿›å±‚æ¬¡çš„å‡½æ•°è°ƒç”¨è·Ÿè¸ªä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å®¹æ˜“åœ°è¯†åˆ«æŸä¸ªGoroutineçš„å‡½æ•°è°ƒç”¨å…³ç³»ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„å‡½æ•°è°ƒç”¨é“¾è·Ÿè¸ªå·²ç»æ”¯æŒäº†å¤šGoroutineï¼Œå¹¶ä¸”å¯ä»¥è¾“å‡ºæœ‰å±‚æ¬¡æ„Ÿçš„è·Ÿè¸ªä¿¡æ¯äº†ï¼Œä½†å¯¹äºTraceç‰¹æ€§çš„ä½¿ç”¨è€…è€Œè¨€ï¼Œä»–ä»¬ä¾ç„¶éœ€è¦æ‰‹å·¥åœ¨è‡ªå·±çš„å‡½æ•°ä¸­æ·»åŠ å¯¹Traceå‡½æ•°çš„è°ƒç”¨ã€‚é‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦å¯ä»¥å°†Traceç‰¹æ€§è‡ªåŠ¨æ³¨å…¥ç‰¹å®šé¡¹ç›®ä¸‹çš„å„ä¸ªæºç æ–‡ä»¶ä¸­å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­æ¥æ”¹è¿›æˆ‘ä»¬çš„Traceå·¥å…·ã€‚</p><h2>åˆ©ç”¨ä»£ç ç”Ÿæˆè‡ªåŠ¨æ³¨å…¥Traceå‡½æ•°</h2><p>è¦å®ç°å‘ç›®æ ‡ä»£ç ä¸­çš„å‡½æ•°/æ–¹æ³•è‡ªåŠ¨æ³¨å…¥Traceå‡½æ•°ï¼Œæˆ‘ä»¬é¦–å…ˆè¦åšçš„å°±æ˜¯å°†ä¸Šé¢Traceå‡½æ•°ç›¸å…³çš„ä»£ç æ‰“åŒ…åˆ°ä¸€ä¸ªmoduleä¸­ä»¥æ–¹ä¾¿å…¶ä»–moduleå¯¼å…¥ã€‚ä¸‹é¢æˆ‘ä»¬å°±å…ˆæ¥çœ‹çœ‹å°†Traceå‡½æ•°æ”¾å…¥ä¸€ä¸ªç‹¬ç«‹çš„moduleä¸­çš„æ­¥éª¤ã€‚</p><h3>å°†Traceå‡½æ•°æ”¾å…¥ä¸€ä¸ªç‹¬ç«‹çš„moduleä¸­</h3><p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸ºinstrument_traceçš„ç›®å½•ï¼Œè¿›å…¥è¿™ä¸ªç›®å½•åï¼Œé€šè¿‡go mod initå‘½ä»¤åˆ›å»ºä¸€ä¸ªåä¸ºgithub.com/bigwhite/instrument_traceçš„moduleï¼š</p><pre><code class="language-plain">$mkdir instrument_trace
$cd instrument_trace
$go mod init github.com/bigwhite/instrument_trace
go: creating new go.mod: module github.com/bigwhite/instrument_trace
</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æœ€æ–°ç‰ˆçš„trace.goæ”¾å…¥åˆ°è¯¥ç›®å½•ä¸‹ï¼Œå°†åŒ…åæ”¹ä¸ºtraceï¼Œå¹¶ä»…ä¿ç•™Traceå‡½æ•°ã€Traceä½¿ç”¨çš„å‡½æ•°ä»¥åŠåŒ…çº§å˜é‡ï¼Œå…¶ä»–å‡½æ•°ä¸€å¾‹åˆ é™¤æ‰ã€‚è¿™æ ·ï¼Œä¸€ä¸ªç‹¬ç«‹çš„traceåŒ…å°±æå–å®Œæ¯•äº†ã€‚</p><p><strong>ä½œä¸ºtraceåŒ…çš„ä½œè€…ï¼Œæˆ‘ä»¬æœ‰ä¹‰åŠ¡å‘Šè¯‰å¤§å®¶å¦‚ä½•ä½¿ç”¨traceåŒ…ã€‚</strong>åœ¨Goä¸­ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šç”¨ä¸€ä¸ªexample_test.goæ–‡ä»¶æ¥ç¼–å†™ä½¿ç”¨traceåŒ…çš„æ¼”ç¤ºä»£ç ï¼Œä¸‹é¢å°±æ˜¯æˆ‘ä»¬ä¸ºtraceåŒ…æä¾›çš„example_test.goæ–‡ä»¶ï¼š</p><pre><code class="language-plain">// instrument_trace/example_test.go
package trace_test
  
import (
    trace "github.com/bigwhite/instrument_trace"
)

func a() {
    defer trace.Trace()()
    b()
}

func b() {
    defer trace.Trace()()
    c()
}

func c() {
    defer trace.Trace()()
    d()
}

func d() {
    defer trace.Trace()()
}

func ExampleTrace() {
    a()
    // Output:
    // g[00001]:    -&gt;github.com/bigwhite/instrument_trace_test.a
    // g[00001]:        -&gt;github.com/bigwhite/instrument_trace_test.b
    // g[00001]:            -&gt;github.com/bigwhite/instrument_trace_test.c
    // g[00001]:                -&gt;github.com/bigwhite/instrument_trace_test.d
    // g[00001]:                &lt;-github.com/bigwhite/instrument_trace_test.d
    // g[00001]:            &lt;-github.com/bigwhite/instrument_trace_test.c
    // g[00001]:        &lt;-github.com/bigwhite/instrument_trace_test.b
    // g[00001]:    &lt;-github.com/bigwhite/instrument_trace_test.a
}
</code></pre><p>åœ¨example_test.goæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ç”¨ExampleXXXå½¢å¼çš„å‡½æ•°è¡¨ç¤ºä¸€ä¸ªç¤ºä¾‹ï¼Œgo testå‘½ä»¤ä¼šæ‰«æexample_test.goä¸­çš„ä»¥Exampleä¸ºå‰ç¼€çš„å‡½æ•°å¹¶æ‰§è¡Œè¿™äº›å‡½æ•°ã€‚</p><p>æ¯ä¸ªExampleXXXå‡½æ•°éœ€è¦åŒ…å«é¢„æœŸçš„è¾“å‡ºï¼Œå°±åƒä¸Šé¢ExampleTraceå‡½æ•°å°¾éƒ¨é‚£æ ·ï¼Œæˆ‘ä»¬åœ¨ä¸€å¤§æ®µæ³¨é‡Šä¸­æä¾›è¿™ä¸ªå‡½æ•°æ‰§è¡Œåçš„é¢„æœŸè¾“å‡ºï¼Œé¢„æœŸè¾“å‡ºçš„å†…å®¹ä»<code>// Output:</code>çš„ä¸‹ä¸€è¡Œå¼€å§‹ã€‚go testä¼šå°†ExampleTraceçš„è¾“å‡ºä¸é¢„æœŸè¾“å‡ºå¯¹æ¯”ï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œä¼šæŠ¥æµ‹è¯•é”™è¯¯ã€‚ä»è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºexample_test.goä¹Ÿæ˜¯traceåŒ…å•å…ƒæµ‹è¯•çš„ä¸€éƒ¨åˆ†ã€‚</p><p>ç°åœ¨Traceå‡½æ•°å·²ç»è¢«æ”¾å…¥åˆ°ç‹¬ç«‹çš„åŒ…ä¸­äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹çœ‹å¦‚ä½•å°†å®ƒè‡ªåŠ¨æ³¨å…¥åˆ°è¦è·Ÿè¸ªçš„å‡½æ•°ä¸­å»ã€‚</p><h3>è‡ªåŠ¨æ³¨å…¥Traceå‡½æ•°</h3><p>ç°åœ¨ï¼Œæˆ‘ä»¬åœ¨instrument_trace moduleä¸‹é¢å¢åŠ ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œè¿™ä¸ªå·¥å…·å¯ä»¥ä»¥ä¸€ä¸ªGoæºæ–‡ä»¶ä¸ºå•ä½ï¼Œè‡ªåŠ¨å‘è¿™ä¸ªGoæºæ–‡ä»¶ä¸­çš„æ‰€æœ‰å‡½æ•°æ³¨å…¥Traceå‡½æ•°ã€‚</p><p>æˆ‘ä»¬å†æ ¹æ®<a href="https://time.geekbang.org/column/article/429143">05è®²</a>ä¸­ä»‹ç»çš„å¸¦æœ‰å¯æ‰§è¡Œæ–‡ä»¶çš„Goé¡¹ç›®å¸ƒå±€ï¼Œåœ¨instrument_trace moduleä¸­å¢åŠ cmd/instrumentç›®å½•ï¼Œè¿™ä¸ªå·¥å…·çš„mainåŒ…å°±æ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼Œè€ŒçœŸæ­£å®ç°è‡ªåŠ¨æ³¨å…¥Traceå‡½æ•°çš„ä»£ç å‘¢ï¼Œè¢«æˆ‘ä»¬æ”¾åœ¨äº†instrumenterç›®å½•ä¸‹ã€‚</p><p>ä¸‹é¢æ˜¯å˜åŒ–åçš„instrument_trace moduleçš„ç›®å½•ç»“æ„ï¼š</p><pre><code class="language-plain">$tree ./instrument_trace -F
./instrument_trace
â”œâ”€â”€ Makefile
â”œâ”€â”€ cmd/
â”‚&nbsp;&nbsp; â””â”€â”€ instrument/
â”‚&nbsp;&nbsp;     â””â”€â”€ main.go  # instrumentå‘½ä»¤è¡Œå·¥å…·çš„mainåŒ…
â”œâ”€â”€ example_test.go
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ instrumenter/    # è‡ªåŠ¨æ³¨å…¥é€»è¾‘çš„ç›¸å…³ç»“æ„
â”‚&nbsp;&nbsp; â”œâ”€â”€ ast/
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ ast.go
â”‚&nbsp;&nbsp; â””â”€â”€ instrumenter.go
â””â”€â”€ trace.go
</code></pre><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹cmd/instrument/main.goæºç ï¼Œç„¶åè‡ªä¸Šè€Œä¸‹æ²¿ç€mainå‡½æ•°çš„è°ƒç”¨é€»è¾‘é€ä¸€çœ‹ä¸€ä¸‹è¿™ä¸ªåŠŸèƒ½çš„å®ç°ã€‚ä¸‹é¢æ˜¯main.goçš„æºç ï¼š</p><pre><code class="language-plain">//  instrument_trace/cmd/instrument/main.go

... ...

var (
    wrote bool
)

func init() {
    flag.BoolVar(&amp;wrote, "w", false, "write result to (source) file instead of stdout")
}

func usage() {
    fmt.Println("instrument [-w] xxx.go")
    flag.PrintDefaults()
}

func main() {
    fmt.Println(os.Args)
    flag.Usage = usage
    flag.Parse() // è§£æå‘½ä»¤è¡Œå‚æ•°

    if len(os.Args) &lt; 2 { // å¯¹å‘½ä»¤è¡Œå‚æ•°ä¸ªæ•°è¿›è¡Œæ ¡éªŒ
        usage()
        return
    }

    var file string
    if len(os.Args) == 3 {
        file = os.Args[2]
    }

    if len(os.Args) == 2 {
        file = os.Args[1]
    }
    if filepath.Ext(file) != ".go" { // å¯¹æºæ–‡ä»¶æ‰©å±•åè¿›è¡Œæ ¡éªŒ
        usage()
        return
    }

    var ins instrumenter.Instrumenter // å£°æ˜instrumenter.Instrumenteræ¥å£ç±»å‹å˜é‡
    
    // åˆ›å»ºä»¥astæ–¹å¼å®ç°Instrumenteræ¥å£çš„ast.instrumenterå®ä¾‹
    ins = ast.New("github.com/bigwhite/instrument_trace", "trace", "Trace") 
    newSrc, err := ins.Instrument(file) // å‘Goæºæ–‡ä»¶æ‰€æœ‰å‡½æ•°æ³¨å…¥Traceå‡½æ•°
    if err != nil {
        panic(err)
    }

    if newSrc == nil {
        // add nothing to the source file. no change
        fmt.Printf("no trace added for %s\n", file)
        return
    }

    if !wrote {
        fmt.Println(string(newSrc))  // å°†ç”Ÿæˆçš„æ–°ä»£ç å†…å®¹è¾“å‡ºåˆ°stdoutä¸Š
        return
    }

    // å°†ç”Ÿæˆçš„æ–°ä»£ç å†…å®¹å†™å›åŸGoæºæ–‡ä»¶
    if err = ioutil.WriteFile(file, newSrc, 0666); err != nil {
        fmt.Printf("write %s error: %v\n", file, err)
        return
    }
    fmt.Printf("instrument trace for %s ok\n", file)
}
</code></pre><p>ä½œä¸ºå‘½ä»¤è¡Œå·¥å…·ï¼Œinstrumentä½¿ç”¨æ ‡å‡†åº“çš„flagåŒ…å®ç°å¯¹å‘½ä»¤è¡Œå‚æ•°ï¼ˆè¿™é‡Œæ˜¯-wï¼‰çš„è§£æï¼Œé€šè¿‡os.Argsè·å–å¾…æ³¨å…¥çš„Goæºæ–‡ä»¶è·¯å¾„ã€‚åœ¨å®Œæˆå¯¹å‘½ä»¤è¡Œå‚æ•°ä¸ªæ•°ä¸å€¼çš„æ ¡éªŒåï¼Œinstrumentç¨‹åºå£°æ˜äº†ä¸€ä¸ªinstrumenter.Instrumenteræ¥å£ç±»å‹å˜é‡insï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ªå®ç°äº†Instrumenteræ¥å£ç±»å‹çš„ast.instrumenterç±»å‹çš„å®ä¾‹ï¼Œå¹¶èµ‹å€¼ç»™å˜é‡insã€‚</p><p>instrumenter.Instrumenteræ¥å£ç±»å‹çš„å£°æ˜æ”¾åœ¨äº†instrumenter/instrumenter.goä¸­ï¼š</p><pre><code class="language-plain">type Instrumenter interface {
    Instrument(string) ([]byte, error)
}
</code></pre><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°ï¼Œè¿™ä¸ªæ¥å£ç±»å‹çš„æ–¹æ³•åˆ—è¡¨ä¸­åªæœ‰ä¸€ä¸ªæ–¹æ³•Instrumentï¼Œè¿™ä¸ªæ–¹æ³•æ¥å—ä¸€ä¸ªGoæºæ–‡ä»¶è·¯å¾„ï¼Œè¿”å›æ³¨å…¥äº†Traceå‡½æ•°çš„æ–°æºæ–‡ä»¶å†…å®¹ä»¥åŠä¸€ä¸ªerrorç±»å‹å€¼ï¼Œä½œä¸ºé”™è¯¯çŠ¶æ€æ ‡è¯†ã€‚æˆ‘ä»¬ä¹‹æ‰€ä»¥è¦æŠ½è±¡å‡ºä¸€ä¸ªæ¥å£ç±»å‹ï¼Œè€ƒè™‘çš„å°±æ˜¯æ³¨å…¥Traceå‡½æ•°çš„å®ç°æ–¹æ³•ä¸ä¸€ï¼Œä¸ºåç»­çš„æ‰©å±•åšå¥½é¢„ç•™ã€‚</p><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é»˜è®¤æä¾›äº†ä¸€ç§è‡ªåŠ¨æ³¨å…¥Traceå‡½æ•°çš„å®ç°ï¼Œé‚£å°±æ˜¯ast.instrumenterï¼Œå®ƒæ³¨å…¥Traceçš„å®ç°åŸç†æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://static001.geekbang.org/resource/image/5b/a8/5be0efb3920c39cd9f252af0b26e7ca8.jpg?wh=1980x1080" alt=""></p><p>ä»åŸç†å›¾ä¸­æˆ‘ä»¬å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼Œåœ¨è¿™ä¸€å®ç°æ–¹æ¡ˆä¸­ï¼Œæˆ‘ä»¬å…ˆå°†ä¼ å…¥çš„Goæºç è½¬æ¢ä¸º<strong>æŠ½è±¡è¯­æ³•æ ‘</strong>ã€‚</p><p>åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼ˆabstract syntax treeï¼ŒASTï¼‰æ˜¯æºä»£ç çš„æŠ½è±¡è¯­æ³•ç»“æ„çš„æ ‘çŠ¶è¡¨ç°å½¢å¼ï¼Œæ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„ã€‚å› ä¸ºGoè¯­è¨€æ˜¯å¼€æºç¼–ç¨‹è¯­è¨€ï¼Œæ‰€ä»¥å®ƒçš„æŠ½è±¡è¯­æ³•æ ‘çš„æ“ä½œåŒ…ä¹Ÿå’Œè¯­è¨€ä¸€èµ·å¼€æ”¾ç»™äº†Goå¼€å‘äººå‘˜ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºGoæ ‡å‡†åº“ä»¥åŠ<a href="https://golang.org/x/tools">Goå®éªŒå·¥å…·åº“</a>æä¾›çš„astç›¸å…³åŒ…ï¼Œå¿«é€Ÿåœ°æ„å»ºåŸºäºASTçš„åº”ç”¨ï¼Œè¿™é‡Œçš„ast.instrumenterå°±æ˜¯ä¸€ä¸ªåº”ç”¨ASTçš„å…¸å‹ä¾‹å­ã€‚</p><p>ä¸€æ—¦æˆ‘ä»¬é€šè¿‡astç›¸å…³åŒ…è§£æGoæºç å¾—åˆ°ç›¸åº”çš„æŠ½è±¡è¯­æ³•æ ‘åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥æ“ä½œè¿™æ£µè¯­æ³•æ ‘ï¼Œå¹¶æŒ‰æˆ‘ä»¬çš„é€»è¾‘åœ¨è¯­æ³•æ ‘ä¸­æ³¨å…¥æˆ‘ä»¬çš„Traceå‡½æ•°ï¼Œæœ€åæˆ‘ä»¬å†å°†ä¿®æ”¹åçš„æŠ½è±¡è¯­æ³•æ ‘è½¬æ¢ä¸ºGoæºç ï¼Œå°±å®Œæˆäº†æ•´ä¸ªè‡ªåŠ¨æ³¨å…¥çš„å·¥ä½œäº†ã€‚</p><p>äº†è§£äº†åŸç†åï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹å…·ä½“çš„ä»£ç å®ç°ã€‚ä¸‹é¢æ˜¯ast.instrumenterçš„Instructmentæ–¹æ³•çš„ä»£ç ï¼š</p><pre><code class="language-plain">// instrument_trace/instrumenter/ast/ast.go

func (a instrumenter) Instrument(filename string) ([]byte, error) {
    fset := token.NewFileSet()
    curAST, err := parser.ParseFile(fset, filename, nil, parser.ParseComments) // è§£æGoæºç ï¼Œå¾—åˆ°AST
    if err != nil {
        return nil, fmt.Errorf("error parsing %s: %w", filename, err)
    }

    if !hasFuncDecl(curAST) { // å¦‚æœæ•´ä¸ªæºç éƒ½ä¸åŒ…å«å‡½æ•°å£°æ˜ï¼Œåˆ™æ— éœ€æ³¨å…¥æ“ä½œï¼Œç›´æ¥è¿”å›ã€‚
        return nil, nil
    }

    // åœ¨ASTä¸Šæ·»åŠ åŒ…å¯¼å…¥è¯­å¥
    astutil.AddImport(fset, curAST, a.traceImport)

    // å‘ASTä¸Šçš„æ‰€æœ‰å‡½æ•°æ³¨å…¥Traceå‡½æ•°
    a.addDeferTraceIntoFuncDecls(curAST)

    buf := &amp;bytes.Buffer{}
    err = format.Node(buf, fset, curAST) // å°†ä¿®æ”¹åçš„ASTè½¬æ¢å›Goæºç 
    if err != nil {
        return nil, fmt.Errorf("error formatting new code: %w", err)
    }
    return buf.Bytes(), nil // è¿”å›è½¬æ¢åçš„Goæºç 
}
</code></pre><p>é€šè¿‡ä»£ç ï¼Œæˆ‘ä»¬çœ‹åˆ°Instrumentæ–¹æ³•çš„åŸºæœ¬æ­¥éª¤ä¸ä¸Šé¢åŸç†å›¾å¤§åŒå°å¼‚ã€‚Instrumenté¦–å…ˆé€šè¿‡go/paserçš„ParserFileå‡½æ•°å¯¹ä¼ å…¥çš„Goæºæ–‡ä»¶ä¸­çš„æºç è¿›è¡Œè§£æï¼Œå¹¶å¾—åˆ°å¯¹åº”çš„æŠ½è±¡è¯­æ³•æ ‘ASTï¼Œç„¶åå‘ASTä¸­å¯¼å…¥Traceå‡½æ•°æ‰€åœ¨çš„åŒ…ï¼Œå¹¶å‘è¿™ä¸ªASTçš„æ‰€æœ‰å‡½æ•°å£°æ˜æ³¨å…¥Traceå‡½æ•°è°ƒç”¨ã€‚</p><p>å®é™…çš„æ³¨å…¥æ“ä½œå‘ç”Ÿåœ¨instrumenterçš„addDeferTraceIntoFuncDeclsæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼š</p><pre><code class="language-plain">// instrument_trace/instrumenter/ast/ast.go

func (a instrumenter) addDeferTraceIntoFuncDecls(f *ast.File) {
    for _, decl := range f.Decls { // éå†æ‰€æœ‰å£°æ˜è¯­å¥
        fd, ok := decl.(*ast.FuncDecl) // ç±»å‹æ–­è¨€ï¼šæ˜¯å¦ä¸ºå‡½æ•°å£°æ˜
        if ok { 
            // å¦‚æœæ˜¯å‡½æ•°å£°æ˜ï¼Œåˆ™æ³¨å…¥è·Ÿè¸ªè®¾æ–½
            a.addDeferStmt(fd)
        }
    }
}
</code></pre><p>è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘ååˆ†æ¸…æ™°ï¼Œå°±æ˜¯éå†è¯­æ³•æ ‘ä¸Šæ‰€æœ‰å£°æ˜è¯­å¥ï¼Œå¦‚æœæ˜¯å‡½æ•°å£°æ˜ï¼Œå°±è°ƒç”¨instrumenterçš„addDeferStmtæ–¹æ³•è¿›è¡Œæ³¨å…¥ï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±ç›´æ¥è¿”å›ã€‚addDeferStmtæ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p><pre><code class="language-plain">// instrument_trace/instrumenter/ast/ast.go

func (a instrumenter) addDeferStmt(fd *ast.FuncDecl) (added bool) {
    stmts := fd.Body.List

    // åˆ¤æ–­"defer trace.Trace()()"è¯­å¥æ˜¯å¦å·²ç»å­˜åœ¨
    for _, stmt := range stmts {
        ds, ok := stmt.(*ast.DeferStmt)
        if !ok {
            // å¦‚æœä¸æ˜¯deferè¯­å¥ï¼Œåˆ™ç»§ç»­forå¾ªç¯
            continue
        }

        // å¦‚æœæ˜¯deferè¯­å¥ï¼Œåˆ™è¦è¿›ä¸€æ­¥åˆ¤æ–­æ˜¯å¦æ˜¯defer trace.Trace()()
        ce, ok := ds.Call.Fun.(*ast.CallExpr)
        if !ok {
            continue
        }

        se, ok := ce.Fun.(*ast.SelectorExpr)
        if !ok {
            continue
        }

        x, ok := se.X.(*ast.Ident)
        if !ok {
            continue
        }
        if (x.Name == a.tracePkg) &amp;&amp; (se.Sel.Name == a.traceFunc) {
            // defer trace.Trace()()å·²å­˜åœ¨ï¼Œè¿”å›
            return false
        }
    }

    // æ²¡æœ‰æ‰¾åˆ°"defer trace.Trace()()"ï¼Œæ³¨å…¥ä¸€ä¸ªæ–°çš„è·Ÿè¸ªè¯­å¥
    // åœ¨ASTä¸Šæ„é€ ä¸€ä¸ªdefer trace.Trace()()
    ds := &amp;ast.DeferStmt{
        Call: &amp;ast.CallExpr{
            Fun: &amp;ast.CallExpr{
                Fun: &amp;ast.SelectorExpr{
                    X: &amp;ast.Ident{
                        Name: a.tracePkg,
                    },
                    Sel: &amp;ast.Ident{
                        Name: a.traceFunc,
                    },
                },
            },
        },
    }

    newList := make([]ast.Stmt, len(stmts)+1)
    copy(newList[1:], stmts)
    newList[0] = ds // æ³¨å…¥æ–°æ„é€ çš„deferè¯­å¥
    fd.Body.List = newList
    return true
}
</code></pre><p>è™½ç„¶addDeferStmtå‡½æ•°ä½“ç•¥é•¿ï¼Œä½†é€»è¾‘ä¹Ÿå¾ˆæ¸…æ™°ï¼Œå°±æ˜¯å…ˆåˆ¤æ–­å‡½æ•°æ˜¯å¦å·²ç»æ³¨å…¥äº†Traceï¼Œå¦‚æœæœ‰ï¼Œåˆ™ç•¥è¿‡ï¼›å¦‚æœæ²¡æœ‰ï¼Œå°±æ„é€ ä¸€ä¸ªTraceè¯­å¥èŠ‚ç‚¹ï¼Œå¹¶å°†å®ƒæ’å…¥åˆ°ASTä¸­ã€‚</p><p>Instrumentçš„æœ€åä¸€æ­¥å°±æ˜¯å°†æ³¨å…¥Traceåçš„ASTé‡æ–°è½¬æ¢ä¸ºGoä»£ç ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æœŸæœ›å¾—åˆ°çš„å¸¦æœ‰Traceç‰¹æ€§çš„Goä»£ç äº†ã€‚</p><h3>åˆ©ç”¨instrumentå·¥å…·æ³¨å…¥è·Ÿè¸ªä»£ç </h3><p>æœ‰äº†instrumentå·¥å…·åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼Œåœ¨ç›®æ ‡Goæºæ–‡ä»¶ä¸­è‡ªåŠ¨æ³¨å…¥è·Ÿè¸ªè®¾æ–½ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘åœ¨instrument_traceé¡¹ç›®çš„examplesç›®å½•ä¸‹å»ºç«‹äº†ä¸€ä¸ªåä¸ºdemoçš„é¡¹ç›®ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨instrumentå·¥å…·ä¸ºdemoé¡¹ç›®ä¸‹çš„demo.goæ–‡ä»¶è‡ªåŠ¨æ³¨å…¥è·Ÿè¸ªè®¾æ–½ã€‚demo.goæ–‡ä»¶å†…å®¹å¾ˆç®€å•ï¼š</p><pre><code class="language-plain">// instrument_trace/examples/demo/demo.go

package main

func foo() {
    bar()
}

func bar() {
}

func main() {
    foo()
}
</code></pre><p>æˆ‘ä»¬é¦–å…ˆæ„å»ºä¸€ä¸‹instrument_traceä¸‹çš„instrumentå·¥å…·ï¼š</p><pre><code class="language-plain">$cd instrument_trace
$go build github.com/bigwhite/instrument_trace/cmd/instrument
$instrument version 
[instrument version]
instrument [-w] xxx.go
  -w	write result to (source) file instead of stdout
</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨instrumentå·¥å…·å‘examples/demo/demo.goæºæ–‡ä»¶ä¸­çš„å‡½æ•°è‡ªåŠ¨æ³¨å…¥è·Ÿè¸ªè®¾æ–½ï¼š</p><pre><code class="language-plain">$instrument -w  examples/demo/demo.go
[instrument -w examples/demo/demo.go]
instrument trace for examples/demo/demo.go ok
</code></pre><p>æ³¨å…¥åçš„demo.goæ–‡ä»¶å˜ä¸ºäº†ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š</p><pre><code class="language-plain">// instrument_trace/examples/demo/demo.go

package main
  
import "github.com/bigwhite/instrument_trace"

func foo() {
    defer trace.Trace()()
    bar()
}

func bar() {
    defer trace.Trace()()
}

func main() {
    defer trace.Trace()()
    foo()
}
</code></pre><p>æ­¤æ—¶ï¼Œå¦‚æœæˆ‘ä»¬å†å¯¹å·²æ³¨å…¥Traceå‡½æ•°çš„demo.goæ‰§è¡Œä¸€æ¬¡instrumentå‘½ä»¤ï¼Œç”±äºinstrumentä¼šåˆ¤æ–­demo.goå„ä¸ªå‡½æ•°å·²ç»æ³¨å…¥äº†Traceï¼Œdemo.goçš„å†…å®¹å°†ä¿æŒä¸å˜ã€‚</p><p>ç”±äºgithub.com/bigwhite/instrument_traceå¹¶æ²¡æœ‰çœŸæ­£ä¸Šä¼ åˆ°github.comä¸Šï¼Œæ‰€ä»¥å¦‚æœä½ è¦è¿è¡Œdemo.goï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºå®ƒé…ç½®ä¸€ä¸ªä¸‹é¢è¿™æ ·çš„go.modï¼š</p><pre><code class="language-plain">

// instrument_trace/examples/demo/go.mod

module demo

go 1.17

require github.com/bigwhite/instrument_trace v1.0.0

replace github.com/bigwhite/instrument_trace v1.0.0 =&gt; ../../
</code></pre><p>è¿™æ ·è¿è¡Œdemo.goå°±ä¸ä¼šé‡åˆ°éšœç¢äº†ï¼š</p><pre><code class="language-plain">$go run demo.go
g[00001]:    -&gt;main.main
g[00001]:        -&gt;main.foo
g[00001]:            -&gt;main.bar
g[00001]:            &lt;-main.bar
g[00001]:        &lt;-main.foo
g[00001]:    &lt;-main.main
</code></pre><h2>å°ç»“</h2><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†è¿™èŠ‚è¯¾å¼€å§‹æ—¶è®¾å®šçš„ç›®æ ‡ï¼šå®ç°ä¸€ä¸ªè‡ªåŠ¨æ³¨å…¥è·Ÿè¸ªä»£ç å¹¶è¾“å‡ºæœ‰å±‚æ¬¡æ„Ÿçš„å‡½æ•°è°ƒç”¨é“¾è·Ÿè¸ªå‘½ä»¤è¡Œå·¥å…·ã€‚</p><p>å›é¡¾ä¸€ä¸‹è¿™ä¸ªå·¥å…·çš„å®ç°æ€è·¯ï¼šæˆ‘ä»¬å…ˆåŸºäºdeferå®ç°äº†ä¸€ä¸ªæœ€ç®€å•çš„å‡½æ•°è·Ÿè¸ªæœºåˆ¶ï¼Œç„¶åé’ˆå¯¹è¿™ä¸ªæœ€ç®€å•çš„å®ç°æå‡ºè‹¥å¹²é—®é¢˜ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é€ä¸€æŠŠè¿™äº›é—®é¢˜è§£å†³æ‰äº†ï¼Œæœ€ç»ˆå°†ç¬¬ä¸€ç‰ˆç›¸å¯¹ç²—ç³™çš„ä»£ç å®ç°æ¼”è¿›é‡æ„ä¸ºä¸€ä¸ªç›¸å¯¹å®Œå–„çš„å‘½ä»¤è¡Œå·¥å…·ã€‚</p><p>å…³äºè¿™ä¸ªå®æˆ˜é¡¹ç›®ï¼Œæœ‰ä¸¤ç‚¹æ³¨æ„äº‹é¡¹è¦å’Œä½ äº¤ä»£æ¸…æ¥šï¼š</p><p>ç¬¬ä¸€ï¼Œåœ¨ä»£ç ä¸­æ³¨å…¥å‡½æ•°è°ƒç”¨è·Ÿè¸ªä»£ç ä»…é€‚ç”¨äºæ—¥å¸¸è°ƒè¯•ä»£ç å’Œé˜…è¯»ç†è§£ä»£ç æ—¶ä½¿ç”¨ï¼Œè¢«æ³¨å…¥äº†è·Ÿè¸ªè®¾æ–½çš„ä»£ç æ˜¯ä¸é€‚åˆä¸Šç”Ÿäº§ç¯å¢ƒçš„ï¼›</p><p>ç¬¬äºŒï¼Œæˆ‘åœ¨è¿™é‡Œä½¿ç”¨åˆ°äº†Goæ ¸å¿ƒå›¢é˜Ÿä¸æ¨èä½¿ç”¨çš„Goroutine idï¼Œè¿™ä¹Ÿæ˜¯ç”±è¿™ä¸ªå®æˆ˜é¡¹ç›®çš„æ€§è´¨æ‰€å†³å®šçš„ã€‚å¦‚æœä½ çš„ä»£ç æ˜¯ä¸Šç”Ÿäº§ï¼Œæˆ‘å»ºè®®è¿˜æ˜¯å°½é‡å¬ä»Goæ ¸å¿ƒå›¢é˜Ÿçš„å»ºè®®ï¼Œ<strong>ä¸è¦ä¾èµ–Goroutine ID</strong>ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>é€šè¿‡instrumentå‘½ä»¤è¡Œå·¥å…·å¯¹Goæºæ–‡ä»¶è¿›è¡Œæ³¨å…¥åï¼Œdefer trace.Trace()()å°±ä¼šæˆä¸ºGoæºç çš„ä¸€éƒ¨åˆ†è¢«ç¼–è¯‘è¿›æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚æˆ‘ä»¬åœ¨å°ç»“ä¸­ä¹Ÿæåˆ°äº†ï¼Œå¼€å¯äº†Traceçš„ä»£ç ä¸è¦ä¸Šç”Ÿäº§ç¯å¢ƒï¼Œè¿™æ ·æˆ‘ä»¬åœ¨æ„å»ºä¸Šç”Ÿäº§çš„åº”ç”¨ä¹‹å‰éœ€è¦æ‰‹å·¥åˆ æ‰è¿™äº›Traceä»£ç ï¼Œæ“ä½œèµ·æ¥ååˆ†ç¹çæ˜“é”™ã€‚</p><p>æ‰€ä»¥ï¼Œè¿™é‡Œæˆ‘æƒ³è¯·ä½ ä¸ºTraceå¢åŠ ä¸€ä¸ªå¼€å…³åŠŸèƒ½ï¼Œæœ‰äº†è¿™ä¸ªå¼€å…³åï¼Œæ—¥å¸¸å¼€å‘è°ƒè¯•è¿‡ç¨‹ä¸­ç¼–è¯‘å‡ºçš„ç¨‹åºä¸­çš„Traceæ˜¯èµ·ä½œç”¨çš„ï¼Œä½†ä¸ºç”Ÿäº§ç¯å¢ƒç¼–è¯‘å‡ºçš„å¯æ‰§è¡Œç¨‹åºä¸­è™½ç„¶ä¹ŸåŒ…å«Traceï¼Œä½†Traceä¸ä¼šçœŸæ­£èµ·ä½œç”¨ï¼ˆæç¤ºï¼šä½¿ç”¨build tagï¼‰ã€‚</p><p>æ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ›´å¤šå¯¹Goè¯­è¨€æ„Ÿå…´è¶£çš„æœ‹å‹ã€‚æˆ‘æ˜¯Tony Baiï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p><h4><a href="https://github.com/bigwhite/publication/tree/master/column/timegeek/go-first-course/27/instrument_trace">è¿™ä¸ªé¡¹ç›®çš„æºç åœ¨è¿™é‡Œï¼</a></h4>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Darren</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œé—®ä¸ªå°ç™½çš„é—®é¢˜å“ˆï¼Œå°±æ˜¯Javaå’ŒPythonéƒ½æ”¯æŒæ³¨è§£å¢åŠ èƒ½åŠ›ï¼Œä¸ä¼šä¿®æ”¹æºä»£ç ã€‚<br>æˆ‘çœ‹æ‚¨è¿™èŠ‚è¯¾çš„æœ€ç»ˆç‰ˆæœ¬ï¼Œå°±æ˜¯å·¥å…·ä¿®æ”¹æºä»£ç ï¼Œé‚£ä¹ˆgoæœ‰æ²¡æœ‰ç±»ä¼¼Javaå’ŒPythoné‚£ç§æ³¨è§£çš„å¢å¼ºèƒ½åŠ›ï¼Ÿå¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆæ˜¯å› ä¸ºä»€ä¹ˆåŸå› ä¸æ”¯æŒå‘€ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: goåŸç”Ÿä¸æ”¯æŒæ³¨è§£åŠŸèƒ½ã€‚å®˜æ–¹å¯¹æ­¤åŸå› æ²¡æœ‰ä»»ä½•è¯´æ˜ã€‚goæ”¯æŒstruct tagï¼Œä¸€å®šç¨‹åº¦å…·å¤‡äº†annotationçš„æ€§è´¨ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-24 15:47:25</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/29/44/b5/7eba5a0e.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æœ¨æœ¨</span>
  </div>
  <div class="_2_QraFYR_0">æ„Ÿè°¢ï¼Œè¿™èŠ‚è¯¾è§‰å¾—å­¦åˆ°äº†å¾ˆå¤šã€‚æœ‰ä¸ªé—®é¢˜ï¼Œåœ¨æ–‡ä¸­æ¼”ç¤ºå¦‚ä½•è·å¾— Goroutine IDçš„traceä¾‹ç¨‹é‡Œï¼ŒwaitGroupçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘æœ¬æ¥ä»¥ä¸ºæ˜¯åƒä¿¡å·é‡ä¸€æ ·çš„åŒæ­¥æ‰‹æ®µï¼Œä½†æ˜¯æƒ³äº†ä¸€æƒ³å‘ç°å¹¶ä¸æ˜¯ï¼Œå› ä¸ºwaitåœ¨A1ï¼ˆï¼‰ä¹‹åã€‚å¦‚æœwaitåœ¨A1ï¼ˆï¼‰ä¹‹å‰çš„è¯ï¼Œå¯ä»¥ä¿è¯è®©A2å…ˆæ‰§è¡Œå®Œå†æ‰§è¡ŒA1ã€‚æ–‡ä¸­è¿™ç§åœ¨A1ï¼ˆï¼‰ä¹‹åwaitï¼ˆï¼‰çš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: waitgroupæ˜¯goæ ‡å‡†åº“syncåŒ…æä¾›çš„ä¸€ä¸ªåŠŸèƒ½ç‰¹æ€§ï¼Œå¸¸ç”¨ç”¨äºç­‰å¾…ä¸€ç»„å­goroutineçš„é€€å‡ºã€‚å¯ä»¥çœ‹çœ‹goå®˜æ–¹ç›¸å…³æ–‡æ¡£ä»¥åŠæ–‡æ¡£ä¸­çš„ç”¨æ³•ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-23 17:40:01</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/11/66/ac631a36.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geralt</span>
  </div>
  <div class="_2_QraFYR_0">æ€è€ƒé¢˜çš„ä¸€ä¸ªæ€è·¯ï¼š<br>åœ¨instrument_traceç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªconfigç›®å½•ï¼Œé‡Œé¢æœ‰dev.goå’Œprod.goä¸¤ä¸ªæ–‡ä»¶ï¼š<br>dev.go<br>&#47;&#47;go:build dev<br>package config<br><br>const ShouldPrint = true<br>------<br>prod.go<br><br>&#47;&#47;go:build prod<br>package config<br><br>const ShouldPrint = false<br><br>------<br><br>ä¿®æ”¹Trace()å‡½æ•°ï¼Œåœ¨æ–¹æ³•ä½“å†…å…ˆåˆ¤æ–­ShouldPrintçš„å€¼ï¼Œè‹¥ä¸ºfalseåˆ™è¿”å›ä¸€ä¸ªç©ºçš„åŒ¿åå‡½æ•°ã€‚<br><br>é€šè¿‡go build -tags dev(prod) å¯ä»¥æŒ‡å®šconfigç›®å½•ä¸‹å“ªä¸ªæ–‡ä»¶å‚ä¸ç¼–è¯‘ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: éƒ½ç”¨build tagäº†ï¼Œåº”è¯¥å°±ä¸éœ€è¦shouldprintäº†å§ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-23 04:01:41</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/0a/a4/828a431f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å¼ ç”³å‚²</span>
  </div>
  <div class="_2_QraFYR_0">å°±å–œæ¬¢è¿™ç§å®æˆ˜ï¼Œå¯ä»¥æŠŠå‰é¢çš„çŸ¥è¯†ç‚¹éƒ½ä¸²èµ·æ¥ï¼Œå¯¹äºåŠ æ·±ç†è§£å¾ˆæœ‰å¸®åŠ©~</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ğŸ‘</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-22 16:12:05</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/29/44/b5/7eba5a0e.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æœ¨æœ¨</span>
  </div>
  <div class="_2_QraFYR_0">ä¸€ä¸ªé—®é¢˜ï¼šè€å¸ˆä»£ç é‡Œå¥½å‡ å¤„ç”¨åˆ°äº†ç±»ä¼¼ fd, ok :=decl.(*ast.FuncDecl) è¿™ç§å†™æ³•ï¼Œçœ‹äº†ä¸€ä¸‹ï¼Œastæ˜¯packageï¼ŒFuncDeclæ˜¯ä¸€ä¸ªstructï¼Œdeclæ˜¯ä¸€ä¸ªast.Declç±»å‹çš„å˜é‡ï¼Œç»™æˆ‘ææ™•äº†ã€‚è¯·é—®ç­‰å·å³è¾¹çš„æ„æ€æ˜¯ä»€ä¹ˆï¼Ÿ </div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: è¿™ä¸èƒ½æ€ªä½ ï¼Œå› ä¸ºè¿™é‡Œä½¿ç”¨äº†æ¥å£çš„ç±»å‹æ–­è¨€(type assert)è¯­æ³•ï¼Œå¯ä»¥å…ˆçœ‹çœ‹ç¬¬28è®²åï¼Œå†å›æ¥çœ‹è¿™æ®µä»£ç ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-23 21:01:41</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>qinsi</span>
  </div>
  <div class="_2_QraFYR_0">ä¸€äº›ç–‘é—®ï¼š<br><br>1. åœ¨è¾“å‡ºå¸¦ç¼©è¿›çš„è·Ÿè¸ªä¿¡æ¯æ—¶ï¼Œç”¨ä¸€ä¸ªmapä¿å­˜äº†ä¸åŒgoroutineçš„å½“å‰ç¼©è¿›ã€‚ä½†ä¼¼ä¹æ¯ä¸ªgoroutineéƒ½åªä¼šè®¿é—®è‡ªå·±çš„idå¯¹åº”çš„kvï¼Œä¸å­˜åœ¨ä¸åŒçš„goroutineè®¿é—®åŒä¸€ä¸ªkeyçš„æƒ…å†µã€‚è¿™ç§æƒ…å†µä¸‹èƒ½å¦ä¸åŠ é”å‘¢ï¼Ÿ<br><br>2. åœ¨å…¶ä»–è¯­è¨€çš„ç”Ÿæ€ä¸­ï¼Œå®ç°æ— ä¾µå…¥çš„é“¾è·¯è·Ÿè¸ªé€šå¸¸éƒ½æ˜¯åœ¨è¯­è¨€çš„ä¸­é—´è¡¨ç¤ºä¸Šåšæ–‡ç« ï¼Œæ¯”å¦‚JVMå­—èŠ‚ç æˆ–æ˜¯LLVM IRã€‚æŸ¥äº†ä¸‹goä¼¼ä¹ä¹Ÿæœ‰è‡ªå·±çš„ä¸€ç§ssa irï¼Œé‚£ä¹ˆæ˜¯å¦æœ‰å¯èƒ½ä¹Ÿåœ¨è¿™ç§irä¸Šåšåšæ–‡ç« ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: 1. goçš„mapç±»å‹å¦‚æœå‘ç°å¤šä¸ªgoroutineå°è¯•å¯¹å…¶è¿›è¡Œå†™æ“ä½œï¼Œä½†æ²¡æœ‰åŠ é”ï¼Œå°±å¯èƒ½æŠ›å‡ºpanic <br>2. æ€è·¯ä¸é”™ï¼Œä½†æˆ‘å¯¹ssa iräº†è§£ä¸å¤šï¼Œå¦‚æœä½ å¯¹ssa irå¾ˆäº†è§£ï¼Œå»ºè®®ä½ å°è¯•ä¸€ä¸‹ï¼Œæœ‰æˆæœåä¹Ÿå¯ä»¥åˆ†äº«å‡ºæ¥ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-22 13:44:34</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/kHoDdV15McW26tMCNnU8GSsUib9UWboAjVSe4nop5nPVt7qZNcUicCic3W50uaDHj0ibupXQtpvOUG4YaomBqHicVmg/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>KingOfDark</span>
  </div>
  <div class="_2_QraFYR_0">1. å¯¹äºgo buildçš„ç¼–è¯‘è¿‡ç¨‹ï¼Œæœ‰ç‚¹ç–‘é—®ï¼Œå°±æ¯”å¦‚è¿™é‡Œç¼–è¯‘ go build demo.go ï¼Œä¼šæŠŠä¾èµ–çš„åŒ…ä¹Ÿéƒ½ç»™é‡æ–°ç¼–è¯‘å—ï¼Ÿ è¿˜æ˜¯è¯´ä¾èµ–åŒ…çš„éƒ½æ˜¯æå‰ç¼–è¯‘å¥½çš„ï¼ˆæˆ–è€…è¯´åªä¼šæœ‰ä¸€æ¬¡ç¼–è¯‘ï¼Œä¹‹åä¸ä¼šé‡æ–°ç¼–è¯‘äº†ï¼Œåªéœ€è¦åœ¨é“¾æ¥å³å¯ï¼Ÿï¼‰<br><br>2. å¯¹äºæ€è€ƒé¢˜çš„ä½¿ç”¨build tagsï¼Œæœ‰ä¸¤ç§æ€è·¯ï¼š<br>ç¬¬ä¸€ç§æ€è·¯ï¼Œæ˜¯ trace.go æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼ˆæ–‡ä»¶åå¯ä»¥åˆ†åˆ«ä¸º dev_trace.goï¼Œ prod_trace.goï¼‰ï¼Œdev ç‰ˆæœ¬çš„trace æ˜¯æ­£å¸¸çš„æ‰“å°é€»è¾‘ï¼Œprod ç‰ˆæœ¬ç›´æ¥è¿”å›ç©ºå‡½æ•°ä½“<br>ç¬¬äºŒç§æ€è·¯ï¼Œæ˜¯ è¦ç¼–è¯‘&#47;è¿½è¸ªçš„goæºæ–‡ä»¶æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªå¸¦æœ‰traceå‡½æ•°ï¼Œä¸€ä¸ªä¸å¸¦traceå‡½æ•°ï¼ˆè¿™ä¸ªæ–¹æ³•å¥½åƒç”¨ä¸åˆ° build tag äº†ï¼Œä½†æ˜¯è¿™æ ·å¥½åƒæŠŠdeferçš„å¼€é”€ä¹Ÿçœå»äº†ï¼‰<br></div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: 1. å…³äºgoå¢é‡ç¼–è¯‘ï¼Œå¯ä»¥äº†è§£ä¸€ä¸‹ https:&#47;&#47;tonybai.com&#47;2022&#47;03&#47;21&#47;go-native-support-incremental-build <br>2. ç¬¬ä¸€ä¸ªæ€è·¯âœ…ã€‚ç¬¬äºŒç§æ€è·¯ç»´æŠ¤èµ·æ¥è¿‡äºéº»çƒ¦äº†ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-06-15 16:37:14</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/1f/64/8a/bc8cb43c.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>è·¯è¾¹çš„çŒª</span>
  </div>
  <div class="_2_QraFYR_0">var mgroup = make(map[uint64]int)<br>var mutex sync.Mutex<br><br>func Trace() func() {<br>	pc, _, _, ok := runtime.Caller(1)<br>	if !ok {<br>		fmt.Println(&quot;æŠ¥é”™&quot;)<br>	}<br>	funcccc := runtime.FuncForPC(pc)<br>	funname := funcccc.Name()<br>	gid := curGoroutineID()<br><br>	mutex.Lock()<br>	index := mgroup[gid]<br>	mgroup[gid] = index + 1<br>	mutex.Unlock()<br>	s := &quot;&quot;<br>	for i := 0; i &lt;= index; i++ {<br>		s = s + &quot;    &quot;<br>	}<br>	fmt.Printf(&quot;g[%05d]:%s-&gt; enter:%s\n&quot;, gid, s, funname)<br>	return func() {<br>		fmt.Printf(&quot;g[%05d]:%s&lt;- exit :%s\n&quot;, gid, s, funname)<br>	}<br>}<br><br>åˆ©ç”¨deferåé¢çš„è¡¨è¾¾å¼åœ¨å…¥æ ˆæ—¶æ±‚å€¼è¿™ä¸€ç‰¹æ€§ï¼Œç”¨ä¸€ä¸ªç¼©ç´§å˜é‡å°±è¡Œäº†ï¼Œé—­åŒ…ä¸­çš„ indents -1 æœ‰ç‚¹å¤šæ­¤ä¸€ä¸¾å§ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å—¯ï¼Œä¸é”™çš„æ€è·¯ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-05-10 00:59:01</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>lesserror</span>
  </div>
  <div class="_2_QraFYR_0">æ„Ÿè°¢å¤§ç™½è€å¸ˆï¼Œè¿™ä¸€è®²çš„å†…å®¹å¾ˆæœ‰å¯å‘æ€§ã€‚æœ‰å‡ ä¸ªå°ç–‘é—®ï¼ŒåŠ³çƒ¦æœ‰æ—¶é—´å›å¤ä¸€ä¸‹ï¼š<br><br>1. æ–‡ä¸­è¯´ï¼šâ€œäºæ˜¯å½“ foo å‡½æ•°è¿”å›åï¼Œè¿™ä¸ªé—­åŒ…å‡½æ•°å°±ä¼šè¢«æ‰§è¡Œã€‚â€ æˆ‘æƒ³çš„æ˜¯ï¼Œè¿™é‡Œæ˜¯ä¸æ˜¯ foo å‡½æ•°è¿”å›ä¹‹å‰ï¼Œé—­åŒ…å‡½æ•°å°±ä¼šè¢«æ‰§è¡Œå‘¢ï¼Ÿ   foo å‡½æ•°è¿”å›åï¼Œæ˜¯ä¸æ˜¯ä»£è¡¨è¿™ä¸ªå‡½æ•°å·²ç»æ‰§è¡Œå®Œæ¯•äº†ï¼Ÿ<br><br>2. ç¬¬ä¸€ä¸ªè¿”å›å€¼ä»£è¡¨çš„æ˜¯ç¨‹åºè®¡æ•°ï¼ˆpc)ã€‚æˆ‘æ‰“å°pcå˜é‡ï¼Œå‡ºæ¥çš„æ˜¯ç±»ä¼¼ï¼š 17343465ã€17343241ã€17343369Â·Â·Â·Â·Â·Â·ï¼Œè¿™ä¸ªè®¡æ•°ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå‘¢ï¼Œå†…å­˜åœ°å€å—ï¼Ÿ<br><br>3. æ–‡ä¸­çš„è¿™ä¸¤æ­¥æ“ä½œï¼š$go build github.com&#47;bigwhite&#47;instrument_trace&#47;cmd&#47;instrument<br>                               $instrument version<br>æˆ‘çš„ç†è§£æ˜¯ç¼–è¯‘ç”Ÿæˆäº†å¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶åï¼Œéœ€è¦æ”¾åˆ° ç±»ä¼¼ binç›®å½•ä¸­ï¼Œæ‰èƒ½å…¨å±€ æ‰§è¡Œ â€œinstrument versionâ€ å‘½ä»¤å§ï¼Ÿ æ„Ÿè§‰è€å¸ˆè¿™é‡Œè¿˜å°‘äº†ä¸€æ­¥æ“ä½œã€‚<br><br>4. ä¸å»ºè®®ä½¿ç”¨ Goroutine IDçš„æœ€å¤§åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ æ–‡ä¸­é“¾æ¥ä¸­çš„è®¨è®ºç»„å†…å®¹æ²¡æœ‰ä»”ç»†çœ‹å®Œã€‚<br><br>5. è¯¾åé—®é¢˜çš„æ¯”è¾ƒä¼˜è¶Šçš„å®ç°æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿæƒ³å¬åˆ°è€å¸ˆçš„ç­”æ¡ˆã€‚<br><br>psï¼šé—®é¢˜æœ‰ç‚¹å¤šï¼Œä½†æ˜¯ç¡®å®å±äºæˆ‘è¿™èŠ‚è¯¾çœ‹å®Œåçš„ç–‘æƒ‘ï¼Œè°¢è°¢è€å¸ˆè§£ç­”ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: 1. è¿™é‡Œæ‰€è°“çš„fooå‡½æ•°è¿”å›åï¼ŒæŒ‡çš„æ˜¯deferå‡½æ•°è¢«æ‰§è¡Œï¼Œdeferredå‡½æ•°å³æ˜¯é‚£ä¸ªé—­åŒ…å‡½æ•°ã€‚<br>2.pcæ˜¯ç¨‹åºè®¡æ•°å™¨ï¼Œå†¯ Â·è¯ºä¼Šæ›¼è®¡ç®—æœºä½“ç³»ç»“æ„ä¸­çš„ä¸€ä¸ªå¯„å­˜å™¨ã€‚å¯ä»¥è‡ªè¡Œgoogleæˆ–baiduä¸€ä¸‹ã€‚<br>3. go buildåï¼Œinstrumentç¨‹åºä¼šå‡ºç°åœ¨å½“å‰ç›®å½•ä¸‹ã€‚<br>4. æœ€å¤§åŸå› è¿˜æ˜¯é¿å…è¢«æ»¥ç”¨ã€‚é¿å…å†™å‡ºå¼ºä¾èµ–goroutine idçš„ä»£ç ã€‚å› ä¸ºå¼ºä¾èµ–goroutineå°†å¯¼è‡´ä»£ç ä¸å¥½ç§»æ¤ï¼ŒåŒæ—¶ä¹Ÿä¼šå¯¼è‡´å¹¶å‘æ¨¡å‹å¤æ‚åŒ–ã€‚<br>5. æç¤ºé‡Œæœ‰ï¼Œä½¿ç”¨build tagã€‚å…³äºbuild tagç”¨æ³•ï¼Œå¯ä»¥å‚è€ƒgoå®˜æ–¹æ–‡æ¡£ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-24 22:33:35</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/b5/e6/c67f12bd.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å·¦è€³æœµä¸œ</span>
  </div>
  <div class="_2_QraFYR_0">æˆ‘ç”Ÿæˆçš„ demo.go æ–‡ä»¶å’Œè€å¸ˆä¸€æ ·ï¼Œä½†æ‰§è¡Œçš„æ—¶å€™ä¸ºä»€ä¹ˆæŠ¥é”™ï¼š<br>examples\demo\demo.go:3:8: imported and not used: &quot;instrument_trace&quot;<br>examples\demo\demo.go:6:8: undefined: trace<br>examples\demo\demo.go:11:8: undefined: trace<br>examples\demo\demo.go:15:8: undefined: trace</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: demoä¸‹çš„go.modä¸­å†…å®¹æ˜¯å¦æ­£ç¡®ï¼Ÿ</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-22 16:25:06</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/ba/ce/fd45714f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>bearlu</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œè¿˜æœ‰å…¶ä»–æ–¹å¼è·å–Goroutine IDï¼Ÿè¿˜æ˜¯ä¸å»ºè®®ä½¿ç”¨Goroutine IDï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ä¸å»ºè®®ä½¿ç”¨ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-22 15:04:15</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ç½—æ°</span>
  </div>
  <div class="_2_QraFYR_0">å¹²è´§æ»¡æ»¡ï¼Œè¿™èŠ‚çš„ä»£ç æœ€å¥½æ‰‹åŠ¨ç å‡ºæ¥ï¼Œäº²è‡ªå¥½å¥½æ„Ÿå—ä¸€ä¸‹ã€‚æˆ‘ä»¬çº¿ä¸Šçš„ç¯å¢ƒåŸºæœ¬ä¸Šéƒ½æ˜¯ç¯å¢ƒå˜é‡æ§åˆ¶ï¼Œgo build å€’æ˜¯ä»æ¥æ²¡æœ‰ä½¿ç”¨è¿‡ï¼Œè¿™ä¸ªä¹Ÿå¯ä»¥å°è¯•ä¸€ä¸‹ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å—¯ï¼Œå¯ä»¥å¯¹æ¯”ä¸€ä¸‹ä¸¤ç§æ–¹æ³•å“ªä¸ªæ›´é€‚åˆã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-22 11:33:58</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/2d/7d/9d/ced762c5.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Bengå“å’”å•¦å’”</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆã€‚é—®å‡ ä¸ªæ–°æ‰‹é—®é¢˜ï¼›<br>1.å¦‚æœä¸€ä¸ªmoduleä¸‹å¾ˆå¤šä¸ªgoæ–‡ä»¶ï¼Œ.&#47;instrument.exe -w .\examples\demo\demo.goï¼Œä¸èƒ½æŠŠæ‰€æœ‰goæ–‡ä»¶çš„å‡½æ•°éƒ½æ³¨å…¥å—ï¼Œåªèƒ½ä¸€ä¸ªä¸ªgoæ–‡ä»¶å»æ‰§è¡Œä¹ˆï¼Ÿ<br>2.build tagå¯ä»¥è®²ä¸‹å—ï¼Œå‰é¢å¥½åƒæ²¡æœ‰è¿™ä¸ªç›¸å…³çš„è¯¾ç¨‹ï¼Œæˆ‘è‡ªå·±è¯•éªŒäº†ä¸‹ï¼Œå¯ä»¥åœ¨æ¯ä¸ªgoæ–‡ä»¶å¤´éƒ¨åŠ ä¸Šï¼š&#47;&#47;go:build devï¼Œç„¶åæ‰§è¡Œgo build  -tags &quot;dev&quot;ï¼Œå¦‚æœè¦å®ç°proç¯å¢ƒï¼Œæ˜¯ä¸æ˜¯å¾—æŠŠæ‰€æœ‰goæ–‡ä»¶å†å¤åˆ¶ä¸ªå‰¯æœ¬ï¼Ÿ<br>3.èƒ½ä¸èƒ½æŠŠinstrument.exeå·¥å…·æ·»åŠ ä¸ªä¸€é”®æ‹†å¸çš„åŠŸèƒ½å‘¢ï¼Œæµ‹è¯•ç¯å¢ƒå°±æ³¨å…¥ï¼Œä¸Šç”Ÿäº§ä¹‹å‰å°±æ‹†å¸</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: é—®é¢˜1ï¼šæ‰¹é‡æ³¨å…¥ å¯ä»¥è¯•è¯• https:&#47;&#47;github.com&#47;bigwhite&#47;functrace&#47;blob&#47;main&#47;scripts&#47;batch_add_trace.shè¿™ä¸ªè„šæœ¬ã€‚<br>é—®é¢˜2ï¼šbuild tagçœ‹çœ‹goå®˜æ–¹æ–‡æ¡£å§ã€‚ä¸éš¾ã€‚<br>é—®é¢˜3: æ¬¢è¿ä½ çš„prï¼Œhttps:&#47;&#47;github.com&#47;bigwhite&#47;functrace</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-12-04 19:20:08</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/2a/39/93/bcafe00f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>è‡ªç”±äºº</span>
  </div>
  <div class="_2_QraFYR_0">é—®é¢˜æˆ‘åœ¨å¶ç„¶é—´æ‰¾åˆ°äº†ï¼Œæˆ‘æŠŠä»£ç æ”¾åˆ°linuxä¸Šï¼Œç„¶åç”¨ go run trace.goå°±è¡Œäº†ï¼Œä¸è¿‡æœ‰ç‚¹å¥‡æ€ªï¼Œä¸ºå•¥windowsä¸è¡Œå‘¢ï¼Œæˆ‘åœ¨windowsä¸Šä½¿ç”¨çš„æ˜¯ideaæ‰§è¡Œçš„ï¼Œgo run go Build å¥½åƒéƒ½ä¸è¡Œ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æˆ‘å¹³æ—¶ä¸ç”¨windowsï¼Œä¹Ÿä¸ç”¨golandå¼€å‘ï¼Œæ‰€ä»¥è¿™ä¸ªé—®é¢˜ä¸å¥½å›ç­”ä½ ã€‚å“ªä½åŒå­¦èƒ½å¸®å¸®å¿™å‘¢ï¼Ÿå¯ä¸å¯èƒ½æ˜¯golandè®¾ç½®çš„é—®é¢˜å‘¢ï¼Ÿ</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-11-23 12:04:12</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/2a/39/93/bcafe00f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>è‡ªç”±äºº</span>
  </div>
  <div class="_2_QraFYR_0">g[00001]:   -&gt;main.A1<br>g[00006]:   -&gt;main.A2        <br>g[00001]:      -&gt;main.B1     <br>g[00006]:      -&gt;main.B2     <br>g[00001]:         -&gt;main.C1  <br>g[00006]:         -&gt;main.C2  <br>g[00001]:            -&gt;main.D<br>g[00001]:            &lt;-main.D<br>g[00001]:         &lt;-main.C1  <br>g[00001]:      &lt;-main.B1     <br>g[00001]:   &lt;-main.A1        <br>g[00006]:            -&gt;main.D<br>g[00006]:            &lt;-main.D<br>g[00006]:         &lt;-main.C2  <br>g[00006]:      &lt;-main.B2     <br>g[00006]:   &lt;-main.A2        <br>è¿™ä¸ªé¡ºåºä¹±æ˜¯gorountineè°ƒåº¦é—®é¢˜å§ï¼Œä¸ºå•¥è€å¸ˆçš„æ²¡ä¹±å‘¢ï¼Ÿæˆ‘çœ‹äº†ä»£ç éƒ½å·®ä¸å¤šå‘€ï¼Ÿå¯æœ‰å¤§ä½¬æœ‰æ—¶é—´è§£é‡Šä¸‹å—ï¼Ÿ<br></div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ä¹±åºæ˜¯å¯èƒ½çš„ã€‚ä½†æ¯ä¸ªgoroutineçš„æ‰§è¡Œæ˜¯æœ‰åºçš„ã€‚å¦‚æœè¦çœ‹æŸä¸ªgoroutineçš„æ‰§è¡Œé¡ºåºï¼Œå¯ä»¥é€šè¿‡grepå·¥å…·é€šè¿‡groutine idå°†å…¶è¿‡æ»¤å‡ºæ¥ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-11-23 11:48:00</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/2c/97/1f/2a68c980.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ä¸è¯´è¯è£…ç³•æ‰‹</span>
  </div>
  <div class="_2_QraFYR_0">æ‰“å¡ã€‚è‡ªåŠ¨æ³¨å…¥åé¢å°±çœ‹ä¸æ‡‚äº†ï¼Œä½œä¸ºä¸€ä¸ªGoåˆšä¸Šæ‰‹åŠå¹´çš„å°ç™½ï¼Œä¹Ÿæ²¡æœ‰å…¶ä»–ç¼–ç¨‹åŸºç¡€ï¼Œçœ‹ä¸æ‡‚è¿™ä¸ªæ­£å¸¸å—ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å¾ˆæ­£å¸¸ï¼Œä¸ç”¨ç°å¿ƒã€‚ç»§ç»­å‘ä¸‹çœ‹ï¼Œå®šæœŸå›å¤´å†å¤šåˆ·å‡ éã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-11-05 22:35:20</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://wx.qlogo.cn/mmopen/vi_32/wgMMrp1hvSB3E30KqZvMsj3KQdAI3T1uQM77LT7hZ65nVSjPGRg3AbUOyiahnssA6AIT5PAkyHFmlTBzUH9gdyQ/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>pythonbug</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆå¥½ï¼Œæˆ‘ä¸€å¼€å§‹å°±æ²¡çœ‹æ‡‚ã€‚ã€‚ã€‚å°±æ˜¯Trace(name string)è¿™ä¸ªä½œä¸ºdeferredå‡½æ•°ï¼Œä¸ºå•¥ä¼šå…ˆæ‰§è¡Œprintlnã€‚ä¸æ˜¯åº”è¯¥ç­‰å‡½æ•°æ‰§è¡Œåï¼Œå†æ‰§è¡Œé‡Œé¢çš„å†…å®¹ä¹ˆã€‚éš¾é“æ˜¯å› ä¸ºTrace(name string)è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªé—­åŒ…å‡½æ•°ï¼Œæ‰€ä»¥ä¸ä¸€æ ·å—</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ç¬¬23è®² è®²deferæ—¶è¯´è¿‡ä¸€ç‚¹ï¼šâ€œdefer å…³é”®å­—åé¢çš„è¡¨è¾¾å¼ï¼Œæ˜¯åœ¨å°† deferred å‡½æ•°æ³¨å†Œåˆ° deferred å‡½æ•°æ ˆçš„æ—¶å€™è¿›è¡Œæ±‚å€¼çš„ã€‚â€<br><br>è¿™ä¸€è®²ï¼Œdefer Trace(&quot;main&quot;)() &lt;=&gt; defer f()ï¼Œè€Œfå…¶å®æ˜¯Trace(&quot;main&quot;)çš„è¿”å›å€¼ï¼Œåœ¨æ³¨å†Œdeferredå‡½æ•°æ—¶ï¼Œä¼šå¯¹Trace(&quot;main&quot;)è¿›è¡Œæ±‚å€¼ï¼Œæ±‚å€¼ç»“æœä¸ºä¸€ä¸ªé—­åŒ…å‡½æ•°ã€‚ç»“æœå°±æ˜¯ï¼šè¿™ä¸ªé—­åŒ…å‡½æ•°è¢«æ³¨å†Œåˆ° deferred å‡½æ•°æ ˆä¸­äº†ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-10-14 17:55:08</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/19/2e/ca/469f7266.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>è èå¹é›ªâ€”Code</span>
  </div>
  <div class="_2_QraFYR_0">æ‰“å¡</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ğŸ‘</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-08-20 16:04:46</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/qhonwcQle1RBufvLdTm4MgSNl554GBXUZtNNH65oYajbbRLxKsZX4hM9vFtrLLpDM0H93ZNWRFAZSrIZC7yAsQ/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_as</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œæˆ‘è§‰å¾—é‚£ä¸ªmapåŠ é”å¥½åƒä¸éœ€è¦ï¼Œmapçš„ç¡®æ˜¯ä¸æ”¯æŒå¹¶å‘å†™ï¼Œä½†æˆ‘è§‰å¾—è¿™ä¸ªå¹¶å‘å†™ï¼Œåº”è¯¥æ˜¯ä¸æ”¯æŒå¤šä¸ªgorunineå¯¹åŒä¸€ä¸ªkeyå†™ï¼Œä½†æ˜¯ç°åœ¨è¿™ä¸ªé¡¹ç›®ï¼Œæ¯ä¸ªgorunineæ˜¯å¯¹å±äºè‡ªå·±çš„keyè¿›è¡Œæ“ä½œï¼Œå³æ¯ä¸ªkeyä»»ä½•æ—¶åˆ»æœ€å¤šåªä¼šè¢«ä¸€ä¸ªgorunineå†™ï¼Œä¸å­˜åœ¨å¹¶å‘é—®é¢˜</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: runtimeå±‚é¢å¯¹mapå¹¶å‘è¯»å†™çš„æ£€æµ‹æ˜¯æ•´ä½“çš„ï¼Œä¸ä¼šè€ƒè™‘goroutineæ˜¯å¦å„è‡ªè®¿é—®è‡ªå·±çš„æ•°æ®ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-04-26 17:53:03</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/4c/12/f0c145d4.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Rayjun</span>
  </div>
  <div class="_2_QraFYR_0">åœ¨æ—¥å¿—é‡Œé¢åŠ é”ä¹Ÿä¸æ˜¯ä¸€ä¸ªå¥½çš„æ–¹æ¡ˆå§</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: åœ¨æˆ‘çš„åˆè¡·é‡Œï¼Œç”Ÿäº§ç¯å¢ƒæ˜¯ä¸åº”è¯¥å¼€å¯è¯¥Traceçš„ï¼Œè¯¥Traceæ›´å¤šæ˜¯åœ¨æ—¥å¸¸dev&#47;debug&#47;read source codeæ—¶ä½¿ç”¨ã€‚å¯ä»¥é€šè¿‡go build -tagæ–¹å¼å¼€å¯å’Œå…³é—­Traceã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-03-20 20:35:44</div>
  </div>
</div>
</div>
</li>
</ul>