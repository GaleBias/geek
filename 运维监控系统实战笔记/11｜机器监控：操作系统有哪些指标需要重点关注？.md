<audio title="11ï½œæœºå™¨ç›‘æ§ï¼šæ“ä½œç³»ç»Ÿæœ‰å“ªäº›æŒ‡æ ‡éœ€è¦é‡ç‚¹å…³æ³¨ï¼Ÿ" src="https://static001.geekbang.org/resource/audio/95/67/95d36067770fd415106e7c3e9ffeb067.mp3" controls="controls"></audio> 
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ç§¦æ™“è¾‰ã€‚</p><p>å‰é¢ä¸¤è®²æˆ‘ä»æ–¹æ³•è®ºå’ŒæŠ€æœ¯å®ç°è§’åº¦ç»™ä½ ä»‹ç»äº†ç›‘æ§æ•°æ®çš„é‡‡é›†åŸç†åŠæ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•è®ºæ˜¯æˆ‘ä»¬æå®šåé¢å„ç§ç›‘æ§éœ€æ±‚çš„åŸºç¡€ï¼Œè¿™é‡Œä½ å¯ä»¥å†ç»“åˆæ€»ç»“å›¾å¤ä¹ ä¸€ä¸‹ã€‚æœ‰äº†è¿™äº›ç†è®ºåŸºç¡€ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥åŠ¨æ‰‹å®æ“äº†ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/2a/ef/2a99224e4000699bc14fe6d5445a93ef.png?wh=2104x1358" alt=""></p><p>ç›‘æ§æ–¹å‘é‡Œæˆ‘ä»¬æœ€è€³ç†Ÿèƒ½è¯¦çš„ï¼Œå°±æ˜¯æœºå™¨ç›‘æ§ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢è¯´çš„è®¾å¤‡ç›‘æ§ä¸­çš„ä¸€ç§ã€‚æœºå™¨æ˜¯è¿›ç¨‹è¿è¡Œçš„åŸºç¡€ç¯å¢ƒï¼Œåœ¨åˆ¶ä½œä¸­é—´ä»¶ã€åº”ç”¨ç›‘æ§ä»ªè¡¨ç›˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šæŠŠæœºå™¨æ ¸å¿ƒæŒ‡æ ‡ï¼Œæ¯”å¦‚CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œã€IOç­‰ï¼Œä½œä¸ºä»ªè¡¨ç›˜çš„ä¸€éƒ¨åˆ†ï¼ŒUSEæ–¹æ³•è®ºä¸»è¦å°±æ˜¯é’ˆå¯¹æœºå™¨ç›‘æ§æå‡ºçš„ï¼Œå…¶é‡è¦æ€§ä¸è¨€è€Œå–»ï¼Œæ‰€ä»¥ä»Šå¤©æˆ‘ä»¬å°±ä»æœºå™¨ç›‘æ§å¼€å§‹èŠèµ·ã€‚</p><h2>æœºå™¨ç›‘æ§æ‰‹æ®µ</h2><p>æœºå™¨å±‚é¢çš„ç›‘æ§åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå¸¦å†…ç›‘æ§å’Œå¸¦å¤–ç›‘æ§ã€‚å¸¦å†…ç›‘æ§å°±æ˜¯é€šè¿‡å¸¦å†…ç½‘ç»œæ¥ç›‘æ§ï¼Œä¸»è¦æ˜¯ä»¥åœ¨OSé‡Œéƒ¨ç½² Agent çš„æ–¹å¼ï¼Œæ¥è·å– OS çš„ CPUã€å†…å­˜ã€ç£ç›˜ã€IOã€ç½‘ç»œã€è¿›ç¨‹ç­‰ç›¸å…³ç›‘æ§æŒ‡æ ‡ã€‚éšç€äº‘æ—¶ä»£çš„åˆ°æ¥ï¼Œæ™®é€šè¿ç»´ç ”å‘äººå‘˜ä¸»è¦å…³æ³¨å¸¦å†…ç›‘æ§å³å¯ï¼ŒIDCè¿ç»´äººå‘˜æ‰ä¼šå…³æ³¨å¸¦å¤–ç›‘æ§ã€‚ä¸è¿‡ä¸ºäº†è®©ä½ çš„çŸ¥è¯†ç½‘ç»œæ›´åŠ å®Œæ•´ï¼Œå¸¦å¤–ç›‘æ§æˆ‘ä¹Ÿæµ…èŠå‡ å¥ã€‚</p><p>å¸¦å¤–ç›‘æ§èµ°çš„æ˜¯å¸¦å¤–ç½‘ç»œï¼Œé€šå¸¸å’Œä¸šåŠ¡ç½‘ç»œä¸äº’é€šï¼Œé€šè¿‡ IPMIã€SNMP ç­‰åè®®è·å–ç¡¬ä»¶å¥åº·çŠ¶å†µã€‚</p><p>IPMIå¯ç”¨äºç›‘æ§ç¡¬ä»¶çš„ç‰©ç†å‚æ•°ï¼Œå¦‚ç³»ç»Ÿæ¸©åº¦ã€é£æ‰‡é€Ÿåº¦ã€ç”µæºç”µå‹ç­‰ï¼Œå¯ä»¥æœ‰æ•ˆåœ°åˆ©ç”¨IPMIç›‘æ§ç¡¬ä»¶æ¸©åº¦ã€åŠŸè€—ã€å¯åŠ¨æˆ–å…³é—­æœåŠ¡å™¨å’Œç³»ç»Ÿï¼Œä»¥åŠè¿›è¡Œæ—¥å¿—è®°å½•ã€‚IPMIçš„ä¸€ä¸ªä¸»è¦äº®ç‚¹æ˜¯ï¼Œå®ƒçš„åŠŸèƒ½ç‹¬ç«‹äºæœåŠ¡å™¨çš„CPUå’Œæ“ä½œç³»ç»Ÿã€‚å› ä¸ºå›ºä»¶æ˜¯ç›´æ¥åœ¨æœåŠ¡å™¨ä¸»æ¿ä¸Šè¿è¡Œçš„ï¼Œæ‰€ä»¥ä¸ç®¡å®‰è£…çš„æ“ä½œç³»ç»Ÿæ˜¯ä»€ä¹ˆï¼Œå®ƒéƒ½å¯ä»¥ç”¨äºç®¡ç†å„ç§è¿œç¨‹ä½ç½®çš„æœåŠ¡å™¨ã€‚</p><!-- [[[read_end]]] --><p>BMCï¼ˆæœåŠ¡å™¨åŸºæ¿ç®¡ç†æ§åˆ¶å™¨ï¼‰ä¹Ÿå¯ä»¥å¼€å¯SNMPçš„æ”¯æŒï¼Œé€šè¿‡SNMP Trapåšç¡¬ä»¶ç›‘æ§æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ€è·¯ã€‚ä¸è¿‡ç›®å‰æ²¡æœ‰çœ‹åˆ°æ¯”è¾ƒå¥½çš„äº§å“ï¼Œå¯èƒ½ä¸€äº›è€ç‰Œçš„å›½å¤–ç›‘æ§äº§å“å¯ä»¥åšï¼Œä½†æ˜¯é‚£äº›äº§å“éƒ½åè€å¥—ä¸”æ”¶è´¹æ˜‚è´µã€‚ä¸è¿‡ç°åœ¨å¤§éƒ½åœ¨ä¸Šå…¬æœ‰äº‘ï¼Œä¼ ç»Ÿçš„SNMP Trapçš„ç›‘æ§ï¼Œå·²ç»æ˜¯ä¸€ä¸ªå­˜é‡éœ€æ±‚äº†ï¼Œä¸æ‡‚ä¹Ÿä¸ç”¨å¤ªè¿‡ç„¦è™‘ã€‚</p><p>æˆ‘ä»¬å†å›æ¥çœ‹å¸¦å†…ç›‘æ§ï¼Œå¸¸è§çš„ Agent æœ‰ Categrafã€Telegrafã€Grafana-agentã€Datadog-agentã€Node-exporter ç­‰ï¼Œè¿™ä¸€è®²æˆ‘ä»¬é™¤äº†ä»‹ç»åŸºæœ¬çš„CPUã€å†…å­˜ã€ç¡¬ç›˜ç›¸å…³çš„ç›‘æ§ï¼Œè¿˜ä¼šä»‹ç»ä¸€ä¸‹è¿›ç¨‹ç›‘æ§å’Œè‡ªå®šä¹‰ç›‘æ§è„šæœ¬ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©Categrafï¼Œç›¸å¯¹æ¯”è¾ƒæ–¹ä¾¿ã€‚</p><h2>Categraf ä»‹ç»</h2><p>Categraf ä½œä¸ºä¸€æ¬¾ Agent éœ€è¦éƒ¨ç½²åˆ°æ‰€æœ‰ç›®æ ‡æœºå™¨ä¸Šï¼Œå› ä¸ºé‡‡é›† CPUã€å†…å­˜ã€è¿›ç¨‹ç­‰æŒ‡æ ‡ï¼Œæ˜¯éœ€è¦è¯»å– OS é‡Œçš„ä¸€äº›ä¿¡æ¯çš„ï¼Œè¿œç¨‹è¯»å–ä¸äº†ã€‚é‡‡é›†åˆ°æ•°æ®ä¹‹åï¼Œè½¬æ¢æ ¼å¼ï¼Œä¼ è¾“ç»™ç›‘æ§æœåŠ¡ç«¯ã€‚</p><p>Categraf æ¨é€ç›‘æ§æ•°æ®åˆ°æœåŠ¡ç«¯ï¼Œèµ°çš„æ˜¯ Prometheus çš„ RemoteWrite åè®®ï¼Œæ˜¯åŸºäº Protobuf çš„ HTTP åè®®ï¼Œæ‰€ä»¥æ‰€æœ‰æ”¯æŒ RemoteWrite çš„åç«¯ï¼Œéƒ½å¯ä»¥å’Œ Categraf å¯¹æ¥ï¼Œæ¯”å¦‚ Prometheusã€Nightingaleã€TDEngineç­‰ã€‚</p><p>Categraf åœ¨ Github çš„ <a href="https://github.com/flashcatcloud/categraf/releases">Releases</a> é¡µé¢æä¾›äº†æ‰€æœ‰çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ¯ä¸ªç‰ˆæœ¬çš„å‘å¸ƒï¼Œéƒ½ä¼šæä¾› changelog å’ŒäºŒè¿›åˆ¶å‘å¸ƒåŒ…ã€‚Categrafé»˜è®¤æä¾› Linux å’Œ Windows ä¸¤ä¸ªå¹³å°çš„å‘å¸ƒåŒ…ï¼Œå½“ç„¶ï¼ŒCategraf ä¹Ÿå¯ä»¥è·‘åœ¨ macOS ä¸Šï¼Œå¦‚æœæœ‰å…´è¶£ä½ ä¹Ÿå¯ä»¥è‡ªè¡Œç¼–è¯‘æµ‹è¯•ã€‚</p><h2>Categraf é…ç½®</h2><p>ä¸ºäº†æ–¹ä¾¿çœ‹åˆ°æ•ˆæœï¼Œæˆ‘æŠŠ Categraf é‡‡é›†çš„æ•°æ®æ¨é€ç»™ Nightingaleï¼Œå³ n9e-server çš„ <code>/prometheus/v1/write</code> åœ°å€ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹ç›¸å…³çš„é…ç½®ã€‚</p><pre><code class="language-bash">[[writers]]
url = "http://127.0.0.1:19000/prometheus/v1/write"
</code></pre><p><span class="reference">æ³¨ï¼šCategraf çš„ä¸»é…ç½®æ–‡ä»¶æ˜¯åœ¨ conf ç›®å½•ä¸‹çš„ config.tomlï¼Œè§£å‹ç¼©å‘å¸ƒåŒ…å°±å¯ä»¥çœ‹åˆ°äº†ã€‚</span></p><p>å½“ç„¶ï¼Œå¦‚æœä½ æƒ³è®© Categraf æŠŠæ•°æ®æ¨ç»™ Prometheusï¼Œä¹Ÿå¯ä»¥ã€‚ä½†éœ€è¦æŠŠ127.0.0.1:19000 ä¿®æ”¹ä¸ºä½ çš„ç¯å¢ƒçš„ Prometheus åœ°å€ï¼Œè¿˜è¦ä¿®æ”¹ URL è·¯å¾„ï¼Œå› ä¸º Prometheus çš„ RemoteWrite æ•°æ®æ¥æ”¶åœ°å€æ˜¯ /api/v1/writeã€‚</p><p>æœ€åè¿˜è¦æ³¨æ„ï¼ŒPrometheus è¿›ç¨‹å¯åŠ¨çš„æ—¶å€™ï¼Œéœ€è¦å¢åŠ ä¸€ä¸ªå¯åŠ¨å‚æ•° <code>--enable-feature=remote-write-receiver</code>ï¼Œé‡å¯ Prometheus å°±èƒ½æ¥æ”¶ RemoteWrite æ•°æ®äº†ã€‚</p><p>é…ç½®å®Œå°±å¯ä»¥å¯åŠ¨äº†ï¼Œä¸è¿‡å¯åŠ¨ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•æµ‹è¯•ä¸€ä¸‹ã€‚é€šè¿‡ <code>./categraf --test</code> çœ‹çœ‹Categrafæœ‰æ²¡æœ‰æŠ¥é”™ï¼Œæ­£å¸¸æƒ…å†µä¼šåœ¨å‘½ä»¤è¡Œè¾“å‡ºé‡‡é›†åˆ°çš„ç›‘æ§æ•°æ®ï¼Œä¸‹é¢æ˜¯æˆ‘çš„ç¯å¢ƒä¸‹çš„è¿è¡Œç»“æœï¼Œä½ å¯ä»¥å‚è€ƒä¸‹ã€‚</p><pre><code class="language-plain">[root@tt-fc-dev01.nj categraf]# ./categraf --test --inputs mem:system
2022/11/05 09:14:31 main.go:110: I! runner.binarydir: /home/work/go/src/categraf
2022/11/05 09:14:31 main.go:111: I! runner.hostname: tt-fc-dev01.nj
2022/11/05 09:14:31 main.go:112: I! runner.fd_limits: (soft=655360, hard=655360)
2022/11/05 09:14:31 main.go:113: I! runner.vm_limits: (soft=unlimited, hard=unlimited)
2022/11/05 09:14:31 config.go:33: I! tracing disabled
2022/11/05 09:14:31 provider.go:63: I! use input provider: [local]
2022/11/05 09:14:31 agent.go:85: I! agent starting
2022/11/05 09:14:31 metrics_agent.go:93: I! input: local.mem started
2022/11/05 09:14:31 metrics_agent.go:93: I! input: local.system started
2022/11/05 09:14:31 prometheus_scrape.go:14: I! prometheus scraping disabled!
2022/11/05 09:14:31 agent.go:96: I! agent started
09:14:31 system_load_norm_5 agent_hostname=tt-fc-dev01.nj 0.3
09:14:31 system_load_norm_15 agent_hostname=tt-fc-dev01.nj 0.2675
09:14:31 system_uptime agent_hostname=tt-fc-dev01.nj 7307063
09:14:31 system_load1 agent_hostname=tt-fc-dev01.nj 1.66
09:14:31 system_load5 agent_hostname=tt-fc-dev01.nj 1.2
09:14:31 system_load15 agent_hostname=tt-fc-dev01.nj 1.07
09:14:31 system_n_cpus agent_hostname=tt-fc-dev01.nj 4
09:14:31 system_load_norm_1 agent_hostname=tt-fc-dev01.nj 0.415
09:14:31 mem_swap_free agent_hostname=tt-fc-dev01.nj 0
09:14:31 mem_used agent_hostname=tt-fc-dev01.nj 5248593920
09:14:31 mem_high_total agent_hostname=tt-fc-dev01.nj 0
09:14:31 mem_huge_pages_total agent_hostname=tt-fc-dev01.nj 0
09:14:31 mem_low_free agent_hostname=tt-fc-dev01.nj 0
...
</code></pre><p>æµ‹è¯•æ²¡é—®é¢˜ï¼Œå°±å¯ä»¥å¯åŠ¨äº†ã€‚é€šè¿‡ <code>nohup ./categraf &amp;&gt; stdout.log &amp;</code> ç®€å•å¯åŠ¨å³å¯ï¼Œå¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒï¼Œå»ºè®®ä½ ä½¿ç”¨ systemd æˆ– supervisor ç­‰æ‰˜ç®¡è¿›ç¨‹ã€‚</p><h2>å¯¼å…¥é…ç½®</h2><p>Categraf å†…ç½® <a href="https://github.com/flashcatcloud/categraf/blob/main/inputs/system/dashboard.json">Linux ç›‘æ§å¤§ç›˜</a>ï¼Œå¯¼å…¥ Nightingale å°±èƒ½çœ‹åˆ°æ•ˆæœï¼Œå½“ç„¶å®ƒä¹Ÿå†…ç½®äº†å‘Šè­¦è§„åˆ™ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹è§„åˆ™çš„ <a href="https://github.com/flashcatcloud/categraf/blob/main/inputs/system/alerts-linux.json">JSON æ–‡ä»¶</a>ã€‚ä¸‹é¢æ˜¯æˆ‘çš„ç¯å¢ƒçš„å¤§ç›˜æ•ˆæœå›¾ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/b9/b7/b9e1c30f7cce7a92byye0acd1cdc09b7.png?wh=1920x974" alt="å›¾ç‰‡"></p><p>èµ°å®Œä¸Šé¢çš„å‡ æ­¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ç›‘æ§æ•ˆæœäº†ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹è¿™äº›æ•°æ®æ˜¯æ€ä¹ˆæ¥çš„ã€‚</p><h2>Categraf æ’ä»¶</h2><p>Categraf å’Œ Telegrafã€Datadog-agent ç±»ä¼¼ï¼Œéƒ½æ˜¯æ’ä»¶æ¶æ„ï¼Œé‡‡é›†CPUæŒ‡æ ‡çš„æ˜¯ cpu æ’ä»¶ï¼Œé‡‡é›†å†…å­˜æŒ‡æ ‡çš„æ˜¯ mem æ’ä»¶ï¼Œé‡‡é›†è¿›ç¨‹æŒ‡æ ‡çš„æ˜¯ procstat æ’ä»¶ï¼Œæ¯ä¸ªæ’ä»¶éƒ½æœ‰ä¸€ä¸ªé…ç½®ç›®å½•ï¼Œåœ¨ conf ç›®å½•ä¸‹ï¼Œä»¥ input. æ‰“å¤´ã€‚</p><pre><code class="language-bash">ulric@localhost conf % ls
categraf.service&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; input.exec&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; input.mem&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.ntp&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.redis_sentinel
config.toml&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.greenplum&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.mongodb&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.nvidia_smi&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; input.rocketmq_offset
example.input.jolokia_agent input.http_response&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.mtail&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.oracle&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; input.snmp
input.arp_packet&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; input.ipvs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; input.mysql&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.phpfpm&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; input.sqlserver
input.conntrack&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.jenkins&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.net&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.ping&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; input.switch_legacy
input.cpu&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.kafka&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.net_response&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; input.postgresql&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; input.system
input.disk&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; input.kernel&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; input.netstat&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.processes&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.tomcat
input.diskio&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; input.kernel_vmstat&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.netstat_filter&nbsp; &nbsp; &nbsp; &nbsp; input.procstat&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; input.zookeeper
input.dns_query&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.kubernetes&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; input.nfsclient&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.prometheus&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; logs.toml
input.docker&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; input.linux_sysctl_fs&nbsp; &nbsp; &nbsp; &nbsp;input.nginx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.rabbitmq&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prometheus.toml
input.elasticsearch&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;input.logstash&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; input.nginx_upstream_check&nbsp; input.redis&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;traces.yaml
</code></pre><p>OSçš„å„ç±»æŒ‡æ ‡é‡‡é›†ï¼Œå¤§éƒ½æ˜¯è¯»å–çš„ <code>/proc</code> ç›®å½•ï¼Œ<a href="https://time.geekbang.org/column/article/624263">ä¸Šä¸€è®²</a>æˆ‘ä»¬å·²ç»ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚å¯¹äºå¸¸è§çš„æ’ä»¶ï¼ŒCategrafä¸­æœ‰å“ªäº›é…ç½®å¯ä»¥æ§åˆ¶å…¶è¡Œä¸ºï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·çœ‹ä¸€ä¸‹ã€‚</p><h3>cpu</h3><p>cpuæ’ä»¶çš„é…ç½®æ–‡ä»¶åœ¨input.cpuç›®å½•ï¼Œåªæœ‰ä¸¤ä¸ªé…ç½®é¡¹ï¼Œintervalå’Œcollect_per_cpuï¼Œå…¶ä¸­interval è¡¨ç¤ºé‡‡é›†é¢‘ç‡ï¼Œæ‰€æœ‰çš„æ’ä»¶éƒ½æœ‰è¿™ä¸ªé…ç½®ã€‚è€Œå’ŒCPUé‡‡é›†ç›¸å…³çš„é…ç½®å®é™…åªæœ‰ä¸€ä¸ªï¼Œå°±æ˜¯ collect_per_cpuï¼Œå®ƒç”¨äºæ§åˆ¶æ˜¯å¦é‡‡é›†æ¯ä¸ªå•æ ¸çš„æŒ‡æ ‡ã€‚é»˜è®¤å€¼æ˜¯ falseï¼Œè¡¨ç¤ºä¸é‡‡é›†å•æ ¸çš„æŒ‡æ ‡ï¼Œåªé‡‡é›†æ•´æœºçš„æŒ‡æ ‡ã€‚</p><p>CPUç›¸å…³çš„æŒ‡æ ‡ï¼Œæœ€æ ¸å¿ƒçš„å°±æ˜¯ä½¿ç”¨ç‡ã€‚å¤§å‹äº’è”ç½‘å…¬å¸ï¼Œä¸ºäº†åº”å¯¹çªå‘æµé‡ï¼ŒCPUçš„å¹³å‡åˆ©ç”¨ç‡ä¸€èˆ¬å°±æ˜¯30%å·¦å³ã€‚å¦‚æœå¹³æ—¶CPUåˆ©ç”¨ç‡æ€»æ˜¯è¶…è¿‡60%ï¼Œå°±æ¯”è¾ƒå±é™©äº†ã€‚</p><h3>mem</h3><p>memæ’ä»¶çš„é…ç½®æ–‡ä»¶åœ¨ input.mem ç›®å½•ï¼Œæ ¸å¿ƒé…ç½®åªæœ‰ä¸€ä¸ª collect_platform_fieldsï¼Œå®ƒè¡¨ç¤ºæ˜¯å¦é‡‡é›†å„ä¸ªå¹³å°ç‰¹æœ‰çš„æŒ‡æ ‡ï¼Œä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå†…å­˜ç›¸å…³çš„æŒ‡æ ‡ï¼ŒLinuxã€Windowsã€BSDã€Darwin éƒ½ä¸æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œå†…å­˜æ€»é‡ã€ä½¿ç”¨é‡è¿™ç±»æŒ‡æ ‡æ‰€æœ‰å¹³å°éƒ½æœ‰ï¼Œä½†æ˜¯å…¶ä½™å¾ˆå¤šæŒ‡æ ‡éƒ½æ˜¯å’Œå¹³å°ç›¸å…³çš„ï¼Œæ¯”å¦‚Linuxä¸‹ç‰¹æœ‰çš„ swapã€huge_page ç›¸å…³çš„æŒ‡æ ‡ï¼Œå…¶ä»–å¹³å°å°±æ˜¯æ²¡æœ‰çš„ã€‚</p><p>å†…å­˜ç›¸å…³çš„æŒ‡æ ‡ï¼Œæœ€æ ¸å¿ƒçš„æ˜¯å¯ç”¨ç‡ï¼Œå³ mem_available_percentã€‚æ–°ç‰ˆæœ¬çš„ OS å†…ç½® available æŒ‡æ ‡ï¼Œè€ç‰ˆæœ¬çš„å§‘ä¸”å¯ä»¥æŠŠ free + cached + buffer çœ‹åš availableã€‚è¿™ä¸ªå€¼å¦‚æœå°äº 30% å°±å¯ä»¥å‘ä¸ªä½çº§åˆ«å‘Šè­¦å‡ºæ¥äº†ï¼Œç„¶åç€æ‰‹æ‰©å®¹ã€‚</p><h3>disk</h3><p>diskæ’ä»¶çš„é…ç½®æ–‡ä»¶åœ¨ input.disk ç›®å½•ï¼Œé»˜è®¤ä¸ç”¨è°ƒæ•´ï¼Œå¦‚æœæŸä¸ªæŒ‚è½½ç‚¹ä¸æƒ³é‡‡é›†ï¼Œå¯ä»¥é…ç½®åˆ° ignore_mount_points ä¸­ï¼Œè¿™æ ·å°±ä¼šè‡ªåŠ¨å¿½ç•¥æ‰å¯¹åº”çš„æŒ‚è½½ç‚¹ã€‚</p><p>ç¡¬ç›˜ç›¸å…³çš„æŒ‡æ ‡ï¼Œä¸»è¦å…³æ³¨ç©ºé—´ä½¿ç”¨ç‡å’Œinodeä½¿ç”¨ç‡ã€‚å¯¹äºç©ºé—´ä½¿ç”¨ç‡ï¼Œ85%ä¸€åˆ€åˆ‡çš„å‘Šè­¦è§„åˆ™ä¸åˆé€‚ï¼Œå»ºè®®è€ƒè™‘å¤§ç©ºé—´çš„ç›˜å’Œå°ç©ºé—´çš„ç›˜åˆ†åˆ«å¯¹åº”ä¸åŒçš„å‘Šè­¦è§„åˆ™ã€‚æ¯”å¦‚ï¼š</p><pre><code class="language-bash">disk_used_percent{app="clickhouse"} &gt; 85
and
disk_total{app="clickhouse"}/1024/1024/1024 &lt; 300
</code></pre><p>è¿™ä¸ªè§„åˆ™ç”¨äº† and å…³é”®å­—ï¼Œé™¤äº†ä½¿ç”¨ç‡å¤§äº 85 ä¹‹å¤–ï¼ŒåˆåŠ äº†ä¸€ä¸ªé™åˆ¶æ¡ä»¶ï¼šæ€»é‡å°äº 300Gã€‚</p><h3>diskio</h3><p>diskioæ’ä»¶çš„é…ç½®æ–‡ä»¶åœ¨ input.diskio ç›®å½•ï¼Œé»˜è®¤ä¸ç”¨è°ƒæ•´ï¼Œå¦‚æœåªæƒ³é‡‡é›†æŸå‡ ä¸ªç›˜çš„ IO æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ devices é…ç½®è¿›è¡Œé™åˆ¶ã€‚</p><p>ç¡¬ç›˜IOç›¸å…³çš„æŒ‡æ ‡ï¼Œä¸»è¦å…³æ³¨è¯»å†™å»¶è¿Ÿï¼Œæ‰€è°“çš„ IO.UTIL è¿™ç§æŒ‡æ ‡åŸºæœ¬ä¸ç”¨å¤ªå…³æ³¨ã€‚è¿™ä¸ªé—®é¢˜ç½‘ç»œä¸Šè®¨è®ºæ¯”è¾ƒå¤šï¼Œä½ ä¹Ÿå¯ä»¥Googleä¸€ä¸‹ã€‚</p><h3>net</h3><p>netæ’ä»¶çš„é…ç½®æ–‡ä»¶åœ¨ input.net ç›®å½•ï¼Œé»˜è®¤ä¸ç”¨è°ƒæ•´ï¼Œå¦‚æœåªæƒ³é‡‡é›†æŸä¸ªç‰¹å®šç½‘å¡çš„æ•°æ®ï¼Œå¯ä»¥ä¿®æ”¹ interfaces é…ç½®ã€‚</p><p>ç°åœ¨çš„IDCç¯å¢ƒï¼ŒåŠ¨è¾„ä¸‡å…†ç½‘å¡ï¼Œæ™®é€šä¸šåŠ¡æ ¹æœ¬ä¸ç”¨æ‹…å¿ƒç½‘å¡è·‘æ»¡çš„é—®é¢˜ï¼Œåªæœ‰ä¸“é—¨ä½œä¸ºæ¥å…¥å±‚çš„æœºå™¨æ‰éœ€è¦é‡ç‚¹å…³æ³¨ã€‚ä¸è¿‡ç½‘å¡ä¸¢åŒ…æ˜¯éœ€è¦å…³æ³¨çš„ï¼Œæ¯”å¦‚é•¿æœŸæ¯ç§’å‡ åä¸ªä¸¢åŒ…ï¼Œå°±æœ‰ç†ç”±æ€€ç–‘æ˜¯ç¡¬ä»¶çš„é—®é¢˜äº†ã€‚</p><h3>netstat</h3><p>netstatæ’ä»¶çš„é…ç½®æ–‡ä»¶åœ¨ input.netstat ç›®å½•ï¼Œé»˜è®¤ä¸ç”¨è°ƒæ•´ï¼Œtcp_time_wait æŒ‡æ ‡å°±æ˜¯é è¿™ä¸ªæ’ä»¶é‡‡é›†çš„ã€‚</p><h3>processes</h3><p>processesæ’ä»¶çš„é…ç½®æ–‡ä»¶åœ¨ input.processes ç›®å½•ï¼Œé»˜è®¤ä¸ç”¨è°ƒæ•´ã€‚æœ€å¸¸è§çš„æŒ‡æ ‡æ˜¯è¿›ç¨‹æ€»é‡ï¼Œå¦‚æœæŸä¸ªæœºå™¨è¿›ç¨‹æ€»é‡è¶…è¿‡600ï¼Œå¤§æ¦‚ç‡æ˜¯æœ‰é—®é¢˜çš„ï¼Œå¸¸è§çš„åŸå› æ¯”å¦‚æŸä¸ª cron å†™â€œæŒ«â€äº†ï¼Œæ¯åˆ†é’Ÿ fork ä¸€ä¸ªè¿›ç¨‹ï¼Œä½†å°±æ˜¯ä¸é€€å‡ºï¼Œæ—¶é—´é•¿äº†å°±æŠŠæœºå™¨å‹å®äº†ã€‚</p><h3>conntrack</h3><p>conntrackæ’ä»¶çš„é…ç½®æ–‡ä»¶åœ¨ input.conntrack ç›®å½•ï¼Œé»˜è®¤ä¸ç”¨è°ƒæ•´ã€‚å¦‚æœä½ å·¥ä½œæ—¶é—´æ¯”è¾ƒä¹…ï¼Œåº”è¯¥é‡åˆ°è¿‡ conntrack table full çš„æŠ¥é”™å§ã€‚è¿™ä¸ªæ’ä»¶å°±æ˜¯ç”¨æ¥ç›‘æ§ conntrack çš„æƒ…å†µçš„ã€‚æˆ‘ä»¬å¯ä»¥é…ç½®ä¸€æ¡è¿™æ ·çš„å‘Šè­¦è§„åˆ™åŠæ—¶å‘ç°é—®é¢˜ï¼š<code>conntrack_ip_conntrack_count / ip_conntrack_max &gt; 0.8</code> å°±å¯ä»¥å‘Šè­¦ã€‚</p><h3>kernel_vmstat</h3><p>kernel_vmstat æ’ä»¶çš„é…ç½®æ–‡ä»¶åœ¨ input.kernel_vmstatï¼Œé‡‡é›†çš„æ˜¯ <code>/proc/vmstat</code> çš„æŒ‡æ ‡æ•°æ®ã€‚è¿™ä¸ªæ–‡ä»¶å†…å®¹æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥é…ç½®æ–‡ä»¶ä¸­ç»™äº†ä¸€ä¸ªç™½åå•ï¼Œä½ å¯ä»¥æŒ‰éœ€å¯ç”¨ï¼Œé»˜è®¤å¯ç”¨äº† oom_killã€‚è¿™æ ·ä¸€æ¥ï¼ŒOSå‘ç”ŸOOMï¼Œæˆ‘ä»¬å¯ä»¥åŠæ—¶çŸ¥é“ã€‚ä¸è¿‡è¿™éœ€è¦é«˜ç‰ˆæœ¬çš„å†…æ ¸ï¼Œä½ç‰ˆæœ¬æ˜¯æ²¡æœ‰çš„ã€‚ä½ç‰ˆæœ¬çš„OSå¯ä»¥é€šè¿‡ç›‘æ§å†…æ ¸æ—¥å¿—çš„â€œOut of memoryâ€å…³é”®å­—æ¥å®ç°OOMç›‘æ§ã€‚</p><h3>ntp</h3><p>ntpæ’ä»¶çš„é…ç½®æ–‡ä»¶åœ¨ input.ntp ç›®å½•ï¼Œéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­ç»™å‡º ntp server çš„åœ°å€ã€‚æ¯ä¸ªå…¬å¸éƒ½åº”è¯¥æœ‰å¯¹æ—¶æœºåˆ¶ï¼Œå¾ˆå¤šåˆ†å¸ƒå¼ç¨‹åºéƒ½æ˜¯é‡åº¦ä¾èµ–æ—¶é—´çš„ã€‚ç›‘æ§æŒ‡æ ‡æ˜¯ ntp_offset_msï¼Œé¡¾åæ€ä¹‰ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œä¸€èˆ¬è¿™ä¸ªå€¼ä¸èƒ½è¶…è¿‡ 1000ï¼Œä¹Ÿä¸èƒ½å°äº-1000ï¼Œéœ€è¦é…ç½®å‘Šè­¦è§„åˆ™ã€‚</p><h3>procstat</h3><p>procstatæ’ä»¶çš„é…ç½®æ–‡ä»¶åœ¨ input.procstat ç›®å½•ï¼Œç”¨äºç›‘æ§è¿›ç¨‹ã€‚è¿›ç¨‹ç›‘æ§ä¸»è¦æ˜¯ä¸¤ä¸ªæ–¹é¢ï¼Œä¸€ä¸ªæ˜¯è¿›ç¨‹å­˜æ´»æ€§ï¼Œä¸€ä¸ªæ˜¯è¿›ç¨‹å ç”¨çš„CPUã€å†…å­˜ã€æ–‡ä»¶å¥æŸ„ç­‰æ•°æ®ã€‚</p><p>å…¶ä¸­ç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯æ–‡ä»¶å¥æŸ„ï¼Œä¹Ÿå°±æ˜¯ fd ç›¸å…³çš„æŒ‡æ ‡ã€‚Linuxé»˜è®¤ç»™è¿›ç¨‹åˆ†é…çš„ fd æ•°é‡æ˜¯1024ï¼Œæœ‰äº›äººè°ƒæ•´äº† ulimit ä¹‹åå‘ç°ä¸å¥½ä½¿ï¼Œæ ¸å¿ƒåŸå› æ˜¯è¿›ç¨‹åœ¨ ulimit è°ƒæ•´ä¹‹å‰å°±å¯åŠ¨äº†ï¼Œæˆ–è€…æ˜¯å› ä¸º systemd å±‚é¢æ²¡æœ‰è°ƒå¥½ã€‚æ²¡å…³ç³»ï¼Œé€šè¿‡ fd è¿™ä¸ªç›‘æ§æŒ‡æ ‡ï¼Œæˆ‘ä»¬æœ€ç»ˆéƒ½å¯ä»¥å‘ç°é—®é¢˜ã€‚procstat_rlimit_num_fds_soft &lt; 2048 å°±å‘Šè­¦ï¼Œéœ€è¦é…ç½®è¿™ä¸ªè§„åˆ™ã€‚</p><h3>exec</h3><p>exec æ’ä»¶çš„é…ç½®æ–‡ä»¶åœ¨ input.exec ç›®å½•ï¼Œç”¨äºè‡ªå®šä¹‰ç›‘æ§è„šæœ¬ã€‚å› ä¸º Agent è™½ç„¶å†…ç½®äº†å¾ˆå¤šæ’ä»¶ï¼Œä½†æœ‰äº›é•¿å°¾éœ€æ±‚ä»ç„¶æ˜¯è§£å†³ä¸äº†çš„ï¼Œæ­¤æ—¶å°±éœ€è¦é€šè¿‡è‡ªå®šä¹‰ç›‘æ§è„šæœ¬æ¥æ‰©å±•ç›‘æ§é‡‡é›†èƒ½åŠ›ã€‚</p><p>ç›‘æ§è„šæœ¬å¯ä»¥æ˜¯Shellçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯Pythonã€Perlã€Rubyçš„ï¼Œåªè¦æœºå™¨ä¸Šæœ‰å¯¹åº”çš„æ‰§è¡Œç¯å¢ƒå°±å¯ä»¥ã€‚Agent ä¼š fork ä¸€ä¸ªè¿›ç¨‹æ¥æ‰§è¡Œï¼Œæˆªè·è¿›ç¨‹çš„ stdoutï¼ˆæ ‡å‡†è¾“å‡ºï¼‰ï¼Œè§£ææˆç›‘æ§æ•°æ®ç„¶åä¸ŠæŠ¥ã€‚æ‰€ä»¥è„šæœ¬é‡‡é›†åˆ°æ•°æ®ä¹‹åï¼Œè¦æ ¼å¼åŒ–æˆæŸä¸ªç‰¹å®šçš„æ ¼å¼ï¼Œæ‰“å°åˆ° stdoutã€‚Categraf æ”¯æŒä¸‰ç§æ ¼å¼ï¼šPrometheusã€Influxã€Falconï¼Œé»˜è®¤æ˜¯ Influx æ ¼å¼ã€‚</p><p>æˆ‘ä»¬ç®€å•ä¸¾ä¸ªä¾‹å­ï¼Œç›‘æ§æŸä¸ªç›®å½•çš„å¤§å°ã€‚</p><pre><code class="language-bash">#!/bin/sh

data1=`du -sb /data1`
data2=`du -sb /data2`

echo "du,dir=/data1 size=$data1"
echo "du,dir=/data2 size=$data2"
</code></pre><p>è¿™ä¸ªä¾‹å­ä½¿ç”¨çš„å°±æ˜¯ Influx è¾“å‡ºæ ¼å¼ï¼Œè¿™ä¸ªæ ¼å¼æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬<a href="https://time.geekbang.org/column/article/620800">ç¬¬2è®²</a>å·²ç»è¯¦ç»†ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é‡‡ç”¨ Prometheus çš„æ ¼å¼æˆ– Falcon çš„æ ¼å¼ã€‚æŠŠè¿™ä¸ªè„šæœ¬çš„è·¯å¾„é…ç½®åˆ° exec.toml ä¸­ï¼ŒCategraf å°±ä¼šå‘¨æœŸæ€§åœ°æ‰§è¡Œè¿™ä¸ªè„šæœ¬ï¼Œé‡‡é›†è¿™ä¸¤ä¸ªç›®å½•çš„å¤§å°äº†ã€‚<br>
<img src="https://static001.geekbang.org/resource/image/38/04/38a4ab67bb925eca00cba12e75794804.png?wh=1578x1432" alt="å›¾ç‰‡"></p><p>Categrafé‡Œä¸€äº›å¸¸è§çš„è·Ÿæœºå™¨ç›¸å…³çš„æ’ä»¶åŠé‡ç‚¹å…³æ³¨çš„æŒ‡æ ‡æˆ‘ä»¬å°±ä»‹ç»å®Œäº†ï¼Œæ’ä»¶æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥æœ€åæˆ‘ç»™ä½ æ•´ç†äº†ä¸€å¼ è¡¨æ ¼ï¼Œä½ å¯ä»¥å†å¯¹ç…§ç€è¿™å¼ è¡¨æ ¼ï¼Œå†åœ¨è„‘æµ·ä¸­å¤ç°ä¸€ä¸‹è¿™äº›çŸ¥è¯†ç‚¹ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©æˆ‘ä»¬é‡ç‚¹ä»‹ç»äº†æœºå™¨ç›‘æ§ï¼Œæœºå™¨ç›‘æ§çš„æ‰‹æ®µæœ‰ä¸¤ç§ï¼ŒåŸºäº Agent çš„è¿™ç§ç›‘æ§æ‰‹æ®µèµ°çš„æ˜¯å¸¦å†…ä¸šåŠ¡ç½‘ç»œï¼Œä¹Ÿå°±æ˜¯å¸¦å†…ç›‘æ§ï¼Œè¿™ç§æ–¹å¼æœ€ä¸ºå¸¸ç”¨ï¼›å¦å¤–ä¸€ç§æœºå™¨ç›‘æ§æ‰‹æ®µæ˜¯å¸¦å¤–ç›‘æ§ï¼Œèµ°çš„æ˜¯å¸¦å¤–ç½‘ç»œï¼Œé€šè¿‡ IPMIã€SNMP ç­‰åè®®ï¼Œå¸¸ç”¨äºé‡‡é›†ç¡¬ä»¶çš„ç‰©ç†æŒ‡æ ‡ï¼Œæ¯”å¦‚ç³»ç»Ÿæ¸©åº¦ã€é£æ‰‡é€Ÿåº¦ã€ç”µæºç”µå‹ç­‰ã€‚ç°åœ¨å·²ç»æ˜¯äº‘æ—¶ä»£ï¼Œä½¿ç”¨å…¬æœ‰äº‘çš„å…¬å¸è¶Šæ¥è¶Šå¤šï¼Œæ‰€ä»¥å°±ç®—ä½ ä¸äº†è§£å¸¦å¤–ç›‘æ§ï¼Œä¹Ÿæ²¡å…³ç³»ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨ Categraf ä½œä¸ºé‡‡é›†å™¨ï¼ŒæŠŠ Categraf é‡Œå¸¸è§çš„æœºå™¨ç›‘æ§æ’ä»¶éƒ½ä»‹ç»äº†ä¸€ä¸‹ï¼Œè¿™äº›æ’ä»¶å¯ä»¥å¸®æˆ‘ä»¬æå®šæœºå™¨å¸¸è§„æŒ‡æ ‡çš„é‡‡é›†ã€‚æ¯”å¦‚cpuæ’ä»¶å¯ä»¥ç›‘æ§CPUçš„ä½¿ç”¨ç‡ï¼Œmemæ’ä»¶å¯ä»¥ç”¨æ¥ç›‘æ§å†…å­˜çš„å¯ç”¨ç‡ï¼Œdiskæ’ä»¶å¯ä»¥ç”¨æ¥ç›‘æ§ç©ºé—´ä½¿ç”¨ç‡ï¼Œdiskioæ’ä»¶å¯ä»¥é‡‡é›†ç¡¬ç›˜IOç›¸å…³çš„æŒ‡æ ‡ï¼Œè¿˜æœ‰execå¯ä»¥ç”¨æ¥è‡ªå®šä¹‰ç›‘æ§è„šæœ¬ï¼Œç­‰ç­‰ã€‚æå®šè¿™äº›æ’ä»¶ï¼Œæœºå™¨æ–¹é¢çš„ç›‘æ§ä¹Ÿå°±ä¸æˆé—®é¢˜äº†ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/yy/cb/yyb2dbda85b408350ccc0a57a0ae15cb.jpg?wh=1592x1491" alt="å›¾ç‰‡"></p><h2>äº’åŠ¨æ—¶åˆ»</h2><p>åœ¨Categrafçš„æ’ä»¶éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä»‹ç»äº†ä¸€ç§è‡ªå®šä¹‰ç›‘æ§è„šæœ¬çš„æ–¹æ³•ï¼Œè¿™ç§æ–¹å¼çµæ´»åº¦å¾ˆé«˜ï¼Œåˆ°åº•å“ªäº›åœºæ™¯éœ€è¦è‡ªå®šä¹‰è„šæœ¬å‘¢ï¼Ÿæ¬¢è¿ä½ åœ¨è¯„è®ºåŒºç•™è¨€ï¼Œå¦‚æœèƒ½åŒæ—¶æä¾›è„šæœ¬é“¾æ¥ï¼Œé‚£å°±æ›´å¥½äº†ï¼Œæˆ‘ä»¬ç›¸äº’äº¤æµï¼Œæ‰“å¼€è§†é‡ã€‚ä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·å­¦ä¹ ã€‚æˆ‘ä»¬ä¸‹ä¸€è®²å†è§ï¼</p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/4f/b0/ab179368.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>hshopeful</span>
  </div>
  <div class="_2_QraFYR_0">éœ€è¦ä½¿ç”¨è‡ªå®šä¹‰è„šæœ¬çš„åœºæ™¯ï¼š<br>1ã€å¯ä»¥åœ¨è„šæœ¬é‡Œé¢é’ˆå¯¹ç°æœ‰çš„ç›‘æ§æŒ‡æ ‡è¿›è¡Œè¿ç®—å¾—åˆ°æ–°çš„ç›‘æ§æŒ‡æ ‡ï¼ˆæˆåŠŸç‡ï¼‰<br>2ã€å¯ä»¥åœ¨è„šæœ¬é‡Œé¢æ‰§è¡Œ sql å‘½ä»¤ä» mysql è·å–ä¸€äº›æœ‰æ„ä¹‰çš„ä¸šåŠ¡æŒ‡æ ‡ï¼Œå…¶ä»–å­˜å‚¨ç³»ç»Ÿç±»ä¼¼<br>3ã€å¯¹äºä¸€äº›ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼ˆä¸å¥½æ”¹ï¼‰ï¼Œæœ‰æš´éœ²æ–‡æœ¬æ ¼å¼çš„ç›‘æ§æŒ‡æ ‡ï¼ˆä½†æ˜¯ä¸ç¬¦åˆ prometheus çš„æ ¼å¼æ ‡å‡†ï¼‰ï¼Œå¯ä»¥é€šè¿‡è‡ªå®šä¹‰è„šæœ¬è¿›è¡Œæ ¼å¼è½¬æ¢</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ğŸ‘ğŸ»</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-02-01 19:42:31</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/22/13/67/910fb1dc.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>leeeo</span>
  </div>
  <div class="_2_QraFYR_0">è¯·é—®ä¸€ä¸‹ï¼šå¦‚æœä»éprometheuså‡çº§åˆ°prometheusæ¶æ„ï¼Œè€çš„ç›‘æ§çš„å†å²æ•°æ®å¦‚ä½•è¿ç§»åˆ°prometheusæ—¶åºæ•°æ®åº“ä¸­å‘¢ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å¤ªç¬¼ç»Ÿäº†æ²¡æ³•å›ç­”ã€‚ä¸€èˆ¬è¾ƒéš¾è¿ç§»ï¼Œä¸¤ä¸ªç³»ç»ŸåŒè·‘ä¸€æ®µæ—¶é—´</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-02-01 11:25:39</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/5d/11/e1f36640.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æ€€æœ”</span>
  </div>
  <div class="_2_QraFYR_0">ä¸šåŠ¡åœºæ™¯ã€‚ å¦‚ï¼šè§†é¢‘è½¬ç é˜Ÿåˆ— ã€è§†é¢‘è½¬ç æˆåŠŸ ã€æ”¯ä»˜æˆåŠŸç‡ ç­‰ç­‰</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ğŸ‘ğŸ»</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-02-01 02:10:30</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src=""
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ç‹å¿—å¹³</span>
  </div>
  <div class="_2_QraFYR_0">categraf ä¸æ”¯æŒé˜¿é‡Œäº‘æœåŠ¡å™¨å—=éƒ¨ç½²å—</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: categrafå¯ä»¥éƒ¨ç½²åœ¨é˜¿é‡Œäº‘çš„è™šæ‹Ÿæœºé‡Œ</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-03-14 16:45:43</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/bxaaILnBnJTuqJn7jwhI1L2vYibx3UeCagxDJhpe6FicX1dumtNaud7gxXoZD2dia1flbLaS5sfKzwo8TCyAicibib5A/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_97a20e</span>
  </div>
  <div class="_2_QraFYR_0">è¯·é—®categrafå¯¹åº”çš„grafanaä»ªè¡¨ç›˜é…ç½®æ–‡ä»¶æœ‰æä¾›å—</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: è¿˜æ²¡æœ‰</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-02-13 09:06:22</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/16/83/c8/5ce842f6.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>maybe</span>
  </div>
  <div class="_2_QraFYR_0">1ã€ä¸šåŠ¡ç›‘æ§ 2ã€ç°æœ‰æ’ä»¶ä¸èƒ½æ»¡è¶³ï¼Œéœ€è¦æ‰©å±•</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-02-12 22:37:25</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/28/a1/d8/42252c48.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>123</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œå¯¹äºåœ¨MacOSä¸Šå¯åŠ¨çš„docker categraf æ‹¿åˆ°çš„æ˜¯dockerå®¹å™¨å†…çš„æ•°æ®è€Œéå®¿ä¸»æœºçš„æ•°æ®</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å¯èƒ½Macä¸Šçš„å®¹å™¨å®é™…æ˜¯è™šæ‹Ÿæœºçš„åŸå› ï¼Œè™šæ‹Ÿæœºçš„éš”ç¦»æ€§æ›´å¥½ï¼Œè¿™ä¸€ä¸ªä¸ç”¨çº ç»“ï¼ŒMacé€šå¸¸åªæ˜¯ç”¨äºæµ‹è¯•ï¼Œç”Ÿäº§è¿˜æ˜¯Linux</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-02-10 09:32:11</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>é‚£æ—¶åˆ»</span>
  </div>
  <div class="_2_QraFYR_0">æˆ‘ä»¬ä¹‹å‰è¯¯è®¤ä¸ºIO.UTILæŒ‡æ ‡æ¥ç¡®è®¤ç£ç›˜æ˜¯å¦è´Ÿè·é‡æˆ–IOPSç“¶é¢ˆã€‚ç„¶åé€šè¿‡æŸ¥è¯¢èµ„æ–™ï¼Œçº æ­£äº†æˆ‘ä»¬çš„è®¤çŸ¥ã€‚<br><br>IO.UTILæ˜¯ç£ç›˜é¥±å’Œåº¦ï¼ˆsaturationï¼‰æŒ‡æ ‡ï¼Œè¡¨ç¤ºè¯¥è®¾å¤‡æœ‰I&#47;Oï¼ˆå³éç©ºé—²ï¼‰çš„æ—¶é—´æ¯”ç‡ï¼Œä¸è€ƒè™‘I&#47;Oæœ‰å¤šå°‘ï¼Œåªè€ƒè™‘æœ‰æ²¡æœ‰ã€‚ç”±äºç°ä»£ç¡¬ç›˜è®¾å¤‡ï¼ˆå¦‚RAID SSDï¼‰éƒ½æœ‰å¹¶è¡Œå¤„ç†å¤šä¸ªI&#47;Oè¯·æ±‚çš„èƒ½åŠ›ï¼Œæ‰€ä»¥%utilå³ä½¿è¾¾åˆ°100%ä¹Ÿä¸æ„å‘³ç€è®¾å¤‡é¥±å’Œäº†ã€‚<br><br>å¯¹äºç£ç›˜é¥±å’Œåº¦ï¼Œæˆ‘ä»¬å¯é€šè¿‡ IOPSï¼Œ CPUçš„ IOWAITï¼Œ Disk Latency (ç¡¬ç›˜å¹³å‡ï¼ˆè¯»å†™ï¼‰æ—¶é—´&#47;ï¼ˆè¯»å†™ï¼‰æ€»æ•°) æ¥ç»¼åˆè€ƒé‡ã€‚<br><br>çƒ¦è¯·è€å¸ˆçœ‹çœ‹æœ‰æœ¨æœ‰ç‘•ç–µçš„åœ°æ–¹ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å¦å¤–ï¼Œè™½ç„¶io.utilçš„æ„ä¹‰å’Œç›´è§‰è®¤çŸ¥ä¸åŒï¼Œå…¶å®ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªé‡è¦çš„å‚è€ƒï¼Œè‡³å°‘æˆ‘ä»¬çŸ¥é“io.utilå°äº99%çš„æƒ…å†µéƒ½ä¸å¤ªç”¨æ“å¿ƒ~</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-02-09 11:12:20</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/14/12/33/52b11198.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Kevin</span>
  </div>
  <div class="_2_QraFYR_0">categrafæ”¯æŒç±»ä¼¼äºnode_exporterçš„textfileè®¾ç½®metadataçš„åŠŸèƒ½å—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: è®¾ç½®metadataï¼Ÿæˆ‘æ²¡æœ‰å°è±¡node_exporterå¯ä»¥åšè¿™ä¸ªäº‹æƒ…ã€‚æˆ‘å°è±¡é‡Œnode_exporterå¯ä»¥è¯»å–textfileï¼Œä»ä¸­è§£æç›‘æ§æŒ‡æ ‡ã€‚Categrafä¸æ”¯æŒè¿™ç§æ–¹å¼ï¼ŒCategrafæ”¯æŒä¸¤ç§æ‰©å±•æœºåˆ¶ï¼Œä¸€ä¸ªæ˜¯æä¾›äº†HTTPæ¥å£ï¼Œæ¥æ”¶ç›‘æ§æŒ‡æ ‡ä¸ŠæŠ¥ï¼Œä¸€ä¸ªæ˜¯æä¾›äº†execæ’ä»¶ï¼Œæ”¯æŒè‡ªå®šä¹‰ç›‘æ§è„šæœ¬ï¼Œç›‘æ§è„šæœ¬è¾“å‡ºinfluxã€prometheusã€falconç­‰æ ¼å¼çš„æ•°æ®å°±å¯ä»¥å•¦</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-02-07 09:36:49</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>peter</span>
  </div>
  <div class="_2_QraFYR_0">è¯·æ•™è€å¸ˆä¸¤ä¸ªé—®é¢˜ï¼š<br>Q1ï¼šè®¾å¤‡ç›‘æ§åœ¨äº‘å¹³å°ä¸Šæ€ä¹ˆå®ç°ï¼Ÿ<br>æˆ‘çš„ç½‘ç«™è®¡åˆ’ç”¨é˜¿é‡Œäº‘ï¼Œè¯·é—®ï¼Œå¯¹äºè®¾å¤‡ç›‘æ§ï¼Œäº‘å¹³å°æ˜¯å¦æä¾›ï¼Ÿå¦‚æœæä¾›ï¼Œæ˜¯å¦è¶³å¤Ÿï¼Ÿ<br>Q2ï¼šå“ªä¸ªäº‘å¹³å°æ›´å¥½ï¼Ÿ<br>è€å¸ˆçš„å…¬å¸ï¼Œæ˜¯ç”¨äº‘å¹³å°å—ï¼Ÿè¿˜æ˜¯è‡ªå»ºæœºæˆ¿ï¼Ÿ å¦‚æœé€‰æ‹©äº‘å¹³å°ï¼Œç›®å‰å›½å†…çš„å‡ ä¸ªå¹³å°ï¼ŒåŒ…æ‹¬é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€åä¸ºäº‘ç­‰ï¼Œè€å¸ˆå€¾å‘äºé€‰æ‹©å“ªä¸€ä¸ªï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: 1ï¼Œä¸Šäº‘çš„è¯ï¼Œä¸€èˆ¬æœ€åŸºç¡€çš„ç›‘æ§éƒ¨åˆ†ï¼Œç”¨äº‘å‚å•†æä¾›çš„ç›‘æ§å°±å¤Ÿäº†ã€‚è™šæœºçš„ç›‘æ§äº‘å‚å•†éƒ½æ˜¯æä¾›çš„ã€‚ä¸è¿‡æ²¡æœ‰ datadog-agentã€categraf è¿™ç§é‡‡é›†å™¨å¥½ç”¨ï¼Œè¿™äº›é‡‡é›†å™¨èƒ½é‡‡é›†çš„å†…å®¹æ›´å¤šã€‚ä¸è¿‡æœ‰äº›äº‘ä¸Šå¯¹è±¡çš„ç›‘æ§æ•°æ®ï¼Œç¬¬ä¸‰æ–¹é‡‡é›†å™¨é‡‡é›†ä¸åˆ°ï¼Œæ¯”å¦‚LBçš„æ•°æ®ï¼Œåªèƒ½ä½¿ç”¨äº‘ç›‘æ§æä¾›çš„æ•°æ®<br>2ï¼Œäº‘å¹³å°çš„é€‰å‹æ¶‰åŠåˆ°å¾ˆå¤šå› ç´ ï¼Œä¸æ­¢æ˜¯æŠ€æœ¯å±‚é¢ï¼Œè¿˜æœ‰å•†åŠ¡å±‚é¢ï¼ŒæœåŠ¡å±‚é¢ï¼Œçº¯æŠ€æœ¯å±‚é¢çš„è¯ï¼Œä¸åŒçš„äº‘ä¹Ÿå„æœ‰æ‰€é•¿ï¼Œä»è§„æ¨¡ä¸Šæ¥çœ‹ï¼Œé˜¿é‡Œäº‘ç¡®å®æ›´å¤§ä¸€äº›</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-02-02 21:11:53</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/e3/12/fd02db2e.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>DBRE</span>
  </div>
  <div class="_2_QraFYR_0">è¯·é—®Categraf æ”¯æŒé€šè¿‡apiçš„æ–¹å¼æ¥ä¿®æ”¹è‡ªèº«é…ç½®å’Œæ’ä»¶é…ç½®å—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: config.tomlé‡Œæœ‰ä¸ªhttp_providerï¼Œé€šè¿‡è¿™ç§æ–¹å¼æ”¯æŒä»è¿œç«¯æ‹‰å–é…ç½®ï¼Œä¸è¿‡éœ€è¦è‡ªè¡Œå®ç°é…ç½®ç®¡ç†ï¼Œç„¶åå®ç°categrafè¦æ±‚çš„è¿™ä¸ªæ¥å£ï¼Œå°±å¯ä»¥å¯¹æ¥èµ·æ¥äº†ã€‚ä¹‹å‰æœ‰å‡ ä¸ªå…¬å¸å·²ç»è¿™ä¹ˆå¹²äº†ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-02-01 08:42:06</div>
  </div>
</div>
</div>
</li>
</ul>