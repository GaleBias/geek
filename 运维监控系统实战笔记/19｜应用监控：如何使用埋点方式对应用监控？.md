<audio title="19ï½œåº”ç”¨ç›‘æ§ï¼šå¦‚ä½•ä½¿ç”¨åŸ‹ç‚¹æ–¹å¼å¯¹åº”ç”¨ç›‘æ§ï¼Ÿ" src="https://static001.geekbang.org/resource/audio/7b/b9/7b2deceb2b42ac8d338884a96cf44fb9.mp3" controls="controls"></audio> 
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ç§¦æ™“è¾‰ã€‚</p><p>å‰é¢å‡ è®²æˆ‘ä»¬ä¸»è¦æ˜¯ä»‹ç»äº†å¸¸è§çš„ä¸­é—´ä»¶ã€æ•°æ®åº“çš„ç›‘æ§ï¼Œç»Ÿç§°ä¸ºç»„ä»¶ç›‘æ§ï¼Œæ ¹æ®<a href="https://time.geekbang.org/column/article/624099">ç¬¬ 9 è®²</a>ä¸­æˆ‘ä»¬å¯¹ç›‘æ§åšçš„åˆ†ç±»ï¼Œè¿˜æœ‰åº”ç”¨å’Œä¸šåŠ¡å±‚é¢çš„ç›‘æ§æ²¡æœ‰ä»‹ç»ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šç”¨ä¸¤è®²æ¥ä»‹ç»è¿™éƒ¨åˆ†å†…å®¹ã€‚</p><blockquote>
<p><span class="reference">ğŸ’¡ å› ä¸ºä¸šåŠ¡æŒ‡æ ‡çš„ç”Ÿæˆä¹Ÿéœ€è¦åº”ç”¨ç¨‹åºä¾§æ¥å®ç°ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªå±‚é¢çš„ç›‘æ§å¯ä»¥ç»Ÿç§°ä¸ºåº”ç”¨ç›‘æ§ã€‚</span></p>
</blockquote><p>åœ¨æŒ‡æ ‡ç›‘æ§çš„ä¸–ç•Œé‡Œï¼Œåº”ç”¨å’Œä¸šåŠ¡å±‚é¢çš„ç›‘æ§æœ‰ä¸¤ç§å…¸å‹æ‰‹æ®µï¼Œä¸€ç§æ˜¯åœ¨åº”ç”¨ç¨‹åºé‡ŒåŸ‹ç‚¹ï¼Œå¦ä¸€ç§æ˜¯åˆ†ææ—¥å¿—ï¼Œä»æ—¥å¿—ä¸­æå–æŒ‡æ ‡ã€‚åŸ‹ç‚¹çš„æ–¹å¼æ€§èƒ½æ›´å¥½ï¼Œä¹Ÿæ›´çµæ´»ï¼Œåªæ˜¯å¯¹åº”ç”¨ç¨‹åºæœ‰ä¸€å®šä¾µå…¥æ€§ï¼Œè€Œåˆ†ææ—¥å¿—çš„è¯å¯¹åº”ç”¨ç¨‹åºä¾µå…¥æ€§è¾ƒå°ï¼Œä½†ç”±äºé“¾è·¯è¾ƒé•¿ã€éœ€è¦åšæ–‡æœ¬åˆ†æå¤„ç†ï¼Œæ€§èƒ½è¾ƒå·®ï¼Œéœ€è¦æ›´å¤šç®—åŠ›æ”¯æŒã€‚è¿™ä¸€è®²æˆ‘ä»¬å…ˆæ¥ä»‹ç»ç¬¬ä¸€ç§æ–¹å¼ï¼Œä½¿ç”¨åŸ‹ç‚¹çš„æ–¹å¼åšåº”ç”¨å’Œä¸šåŠ¡ç›‘æ§ã€‚</p><h2>åŸ‹ç‚¹æ–¹å¼ä»‹ç»</h2><p>æ‰€è°“çš„åŸ‹ç‚¹ï¼Œå°±æ˜¯æŒ‡åº”ç”¨ç¨‹åºå†…åµŒäº†åŸ‹ç‚¹çš„ SDKï¼ˆä¸€ä¸ª lib åº“ï¼‰ï¼Œç„¶ååœ¨ä¸€äº›å…³é”®ä»£ç æµç¨‹é‡Œè°ƒç”¨ SDK æä¾›çš„æ–¹æ³•ï¼Œè®°å½•ä¸‹å„ç§å…³é”®æŒ‡æ ‡ã€‚æ¯”å¦‚æŸä¸ª HTTP æœåŠ¡ï¼Œæä¾›äº† 10 ä¸ªæ¥å£ï¼Œæ¯ä¸ªæ¥å£çš„å¤„ç†èŠ±è´¹äº†å¤šå°‘æ¯«ç§’ï¼Œå°±å¯ä»¥ä½œä¸ºæŒ‡æ ‡è®°å½•ä¸‹æ¥ã€‚</p><p>ä½ å¯èƒ½ä¼šç–‘æƒ‘ï¼Œæˆ‘çš„ç›‘æ§ç³»ç»Ÿå·²ç»æä¾›äº† PUSH æ¥å£äº†ï¼Œæ¯”å¦‚ Prometheus çš„ Pushgateway ç»„ä»¶ï¼Œåœ¨åº”ç”¨ç¨‹åºé‡Œç›´æ¥è°ƒç”¨ Pushgateway æ¥å£æ¨æ•°æ®ä¸å°±è¡Œäº†å—ï¼Ÿä¸ºä»€ä¹ˆè¿˜éœ€è¦ SDK å‘¢ï¼Ÿ</p><!-- [[[read_end]]] --><p>æ ¸å¿ƒåŸå› æ˜¯ SDK å¯ä»¥å¸®æˆ‘ä»¬å°è£…ä¸€äº›é€šç”¨çš„è®¡ç®—é€»è¾‘ã€‚æ¯”å¦‚æœ‰ä¸ªæŒ‡æ ‡æ˜¯ Summary ç±»å‹ï¼ˆ<a href="https://time.geekbang.org/column/article/620800">ç¬¬ 2 è®²</a>ä»‹ç»è¿‡è¿™ä¸ªæ•°æ®ç±»å‹ï¼‰ï¼Œå¯ä»¥æä¾›æŸä¸ªæ¥å£99åˆ†ä½çš„å»¶è¿Ÿæ•°æ®ã€‚å¦‚æœæ²¡æœ‰ SDKï¼Œæˆ‘ä»¬éœ€è¦æ€ä¹ˆåšå‘¢ï¼Ÿæ¯å½“è¿™ä¸ªæ¥å£å“åº”ä¸€æ¬¡è¯·æ±‚ï¼Œå°±è®°å½•ä¸€ä¸ªå»¶è¿Ÿæ—¶é—´ï¼Œç„¶åå­˜å…¥ä¸€ä¸ªå†…å­˜æ•°æ®ç»“æ„ï¼Œç­‰åˆ°ä¸€ä¸ªæ—¶é—´é—´éš”ï¼Œæ¯”å¦‚10ç§’é’Ÿï¼Œå°±æŠŠè¿™æ®µæ—¶é—´å†…æ‰€æœ‰çš„å»¶è¿Ÿæ•°æ®æ’ä¸ªåºï¼Œç„¶åå–99åˆ†ä½çš„å€¼ï¼Œæœ€åè°ƒç”¨ Pushgateway çš„æ¥å£æ¨è¿‡å»ã€‚å¾ˆéº»çƒ¦æ˜¯ä¸æ˜¯ï¼Ÿ</p><p>æˆ‘ä»¬éœ€è¦å‡†å¤‡è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„è¿˜éœ€è¦çº¿ç¨‹å®‰å…¨ã€‚å¦‚æœè¯·æ±‚éå¸¸é¢‘ç¹ï¼Œè€—æ—¶æ•°æ®å¾ˆå¤šï¼Œè¿˜å¾—è¿›è¡Œé™åˆ¶ï¼Œæ¯”å¦‚è¿™ä¸ªæ•°æ®ç»“æ„åªä¿å­˜1000ä¸ªè€—æ—¶æ•°æ®ã€‚ç„¶ååˆ°äº†æ—¶é—´é—´éš”ä¹‹åéœ€è¦æ’åºï¼Œè¿˜è¦ç»„ç»‡æˆç›‘æ§ç³»ç»Ÿéœ€è¦çš„æ•°æ®æ ¼å¼ï¼Œè¿˜éœ€è¦è°ƒç”¨ HTTP æ¥å£æ¨é€æ•°æ®ã€‚</p><p>è€Œ SDK å°±æ˜¯åšè¿™äº›é€šç”¨é€»è¾‘çš„ï¼Œåº”ç”¨ç¨‹åºè¦åšçš„ï¼Œå°±æ˜¯æ‹¿åˆ°å»¶è¿Ÿæ•°æ®ä¹‹åï¼Œè°ƒç”¨ SDK çš„æ–¹æ³•å‘ŠçŸ¥ SDKï¼Œè¯´åˆæœ‰ä¸€æ¬¡æ–°çš„æ¥å£è°ƒç”¨ï¼Œå»¶è¿Ÿæ•°æ®æ˜¯å¤šå°‘ï¼Œå“¥ä»¬åç»­å°±äº¤ç»™ä½ äº†ï¼ŒSDK å°±èƒ½å®Œæˆå‰©ä½™æ‰€æœ‰çš„äº‹æƒ…ã€‚</p><p>ä¸šç•Œæ¯”è¾ƒçŸ¥åçš„è·¨è¯­è¨€åŸ‹ç‚¹å·¥å…·æ˜¯ <a href="https://github.com/statsd/statsd">StatsD</a> å’Œ <a href="https://prometheus.io/docs/instrumenting/clientlibs/">Prometheus</a>ã€‚å½“ç„¶ï¼Œæœ‰äº›è¯­è¨€æœ‰è‡ªå·±ç”Ÿæ€çš„å¸¸ç”¨å·¥å…·ï¼Œæ¯”å¦‚ Java ç”Ÿæ€çš„ Micrometerï¼Œä¸è¿‡ä¸€èˆ¬å…¬å¸éƒ½ä¼šä½¿ç”¨å¤šç§è¯­è¨€ï¼Œè¿™äº›è·¨è¯­è¨€çš„åŸ‹ç‚¹æ–¹æ¡ˆé€šå¸¸ä½¿ç”¨é¢‘ç‡ä¼šæ›´é«˜ã€‚æ‰€ä»¥ï¼Œè¿™ä¸€è®²æˆ‘ä¼šåˆ†åˆ«ä»‹ç»è¿™ä¸¤ä¸ªæ–¹å¼ï¼Œè®©ä½ æœ‰ä¸ªå…¨é¢çš„è®¤è¯†ï¼Œæˆ‘ä»¬å…ˆä» StatsD å¼€å§‹ã€‚</p><h2>StatsD</h2><p>StatsD å¼€å§‹è¢«ç†ŸçŸ¥æ˜¯å› ä¸º<a href="https://www.etsy.com/codeascraft/measure-anything-measure-everything/">ã€ŠMeasure Anything, Measure Everythingã€‹</a>è¿™ç¯‡æ–‡ç« ï¼ŒEtsy çš„å·¥ç¨‹å¸ˆä½¿ç”¨ NodeJS å¼€æºäº†è¿™ä¸ª<a href="https://github.com/statsd/statsd">é¡¹ç›®</a>ã€‚</p><p>StatsD æœ‰ä¸ªå¾ˆå¤§çš„ç‰¹ç‚¹æ˜¯ä½¿ç”¨ UDP ä¼ è¾“åè®®ï¼Œå¤§éƒ¨åˆ†è®¡ç®—é€»è¾‘éƒ½æŒªåˆ°äº† StatsD çš„ Serverï¼ŒSDK å±‚é¢çš„å·¥ä½œéå¸¸è½»é‡ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/94/0d/94e9f7d2251d6241bb0f83308810230d.png?wh=2396x824" alt="" title="StatsD æ¶æ„å›¾"></p><p>StatsD SDK ä¸ StatsD Server ä¹‹é—´é€šä¿¡ä½¿ç”¨çš„æ˜¯UDP åè®®ï¼ŒUDP åè®®æ˜¯ fire-and-forgetï¼Œæ— éœ€å»ºç«‹è¿æ¥ï¼Œå³ä½¿ StatsD Server æŒ‚äº†ï¼Œä¹Ÿä¸å½±å“åº”ç”¨ç¨‹åºï¼Œè€Œå¯¹äºå»¶è¿Ÿåˆ†å¸ƒåŒºé—´è¿™æ ·çš„è®¡ç®—é€»è¾‘ï¼Œæ˜¯åœ¨ StatsD Server é‡Œè®¡ç®—çš„ï¼Œä¹Ÿä¸ä¼šå½±å“åº”ç”¨ç¨‹åºï¼Œæ‰€ä»¥æ•´ä¸ª StatsD çš„è®¾è®¡æ˜¯éå¸¸è½»é‡çš„ï¼Œå¯¹åº”ç”¨ç¨‹åºåŸºæœ¬æ²¡æœ‰å½±å“ã€‚</p><p>ç”±äº StatsD ç›¸å½“çŸ¥åï¼Œæ‰€ä»¥å¾ˆå¤šé‡‡é›†å™¨éƒ½å®ç°äº† StatsD çš„åè®®ï¼Œæ¯”å¦‚ Telegrafã€Datadog-agentï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå›¾ä¸Šçš„ StatsD Server æ˜¯å¯ä»¥æ¢æˆ Telegraf æˆ– Datadog-agent çš„ã€‚è¿™æ ·å°±ä¸ç”¨éƒ¨ç½²å¤ªå¤šè¿›ç¨‹ï¼Œä¸€ä¸ªé‡‡é›†å™¨åŒ…æ‰“å¤©ä¸‹ï¼Œå°±æ‹¿ Telegraf æ¥è¯´å§ï¼Œæ›¿æ¢åæ¶æ„å°±å˜æˆäº†è¿™æ ·ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/e4/fb/e45a7a5926bb491c5560bc16a5189cfb.png?wh=2126x1350" alt=""></p><p>ä¸‹é¢æˆ‘æ¥æ¼”ç¤ºä¸€ä¸‹ï¼Œç”¨ä¸€ä¸ªå°ç¨‹åºåšä¸ªåŸ‹ç‚¹ï¼Œè®©ä½ æœ‰ä¸ªæ„Ÿæ€§çš„è®¤è¯†ã€‚æˆ‘ä»¬å°±æŠŠ Telegraf å½“åš StatsD Server æ¥æ¥æ”¶åŸ‹ç‚¹æ•°æ®ï¼ŒTelegraf æ˜¯ InfluxData ä¸»å¯¼å¼€æºçš„ç›‘æ§é‡‡é›†å™¨ï¼Œæˆ‘ä¹‹å‰åšè¿‡ä¸€æ¬¡è°ƒç ”ï¼Œè°ƒç ”ç¬”è®°æˆ‘ä¹Ÿæ”¾åœ¨<a href="https://mp.weixin.qq.com/s/JeBa_YOJdsv_QOlCVDHdtw">è¿™é‡Œ</a>ï¼Œä¾›ä½ å‚è€ƒã€‚</p><p>Telegraf æä¾› StatsD çš„ input æ’ä»¶ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­æœç´¢ inputs.statsd å°±èƒ½æ‰¾åˆ°ç›¸å…³çš„é…ç½®æ®µäº†ï¼Œé‡Œè¾¹æœ‰è¯¦å°½çš„æ³¨é‡Šï¼Œæˆ‘å°±ä¸å†èµ˜è¿°äº†ï¼Œç›´æ¥ä¸Šé…ç½®æ ·ä¾‹ã€‚</p><pre><code class="language-yaml">[[inputs.statsd]]
protocol = "udp"
service_address = ":8125"
percentiles = [50.0, 90.0, 99.0, 99.9, 99.95, 100.0]
metric_separator = "_"
</code></pre><p>Telegrafé‡å¯ä¹‹åå°±ä¼šåœ¨ 8125 å¼€å¯ UDP ç›‘å¬ï¼Œæˆ‘ä»¬å†™çš„ç¨‹åºå°±å¯ä»¥å¾€è¿™ä¸ªåœ°å€æ¨é€ç›‘æ§æ•°æ®äº†ã€‚å› ä¸ºæˆ‘å¯¹ Go è¯­è¨€æ¯”è¾ƒç†Ÿæ‚‰ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ç»™ä½ æä¾›ä¸€ä¸ª Go åŸ‹ç‚¹çš„ä¾‹å­ã€‚</p><pre><code class="language-go">package main
import (
    "fmt"
    "math/rand"
    "net/http"
    "time"
    "github.com/smira/go-statsd"
)
var client *statsd.Client
func homeHandler(w http.ResponseWriter, r *http.Request) {
    start := time.Now()
    // random sleep
    num := rand.Int31n(100)
    time.Sleep(time.Duration(num) * time.Millisecond)
    fmt.Fprintf(w, "duration: %d", num)
    client.Incr("requests.counter,page=home", 1)
    client.PrecisionTiming("requests.latency,page=home", time.Since(start))
}
func main() {
    // init client
    client = statsd.NewClient("localhost:8125",
        statsd.TagStyle(statsd.TagFormatInfluxDB),
        statsd.MaxPacketSize(1400),
        statsd.MetricPrefix("http."),
        statsd.DefaultTags(statsd.StringTag("service", "n9e-webapi"), statsd.StringTag("region", "bj")),
    )
    defer client.Close()
    http.HandleFunc("/", homeHandler)
    http.ListenAndServe(":8000", nil)
}
</code></pre><p>è¿™ä¸ª Web æœåŠ¡åªæœ‰ä¸€ä¸ªæ ¹è·¯å¾„ï¼Œé€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯éšæœº sleep å‡ åä¸ªæ¯«ç§’å½“åšä¸šåŠ¡å¤„ç†æ—¶é—´ã€‚æ•´ä½“é€»è¾‘æ˜¯è¿™æ ·çš„ï¼šé¦–å…ˆï¼Œæˆ‘ä»¬è¦é€šè¿‡ statsd.NewClient åˆå§‹åŒ–ä¸€ä¸ª StatsD çš„å®¢æˆ·ç«¯ï¼Œå‚æ•°ä¸­æŒ‡å®šäº† StatsD çš„ Server åœ°å€ï¼ˆåœ¨è¿™ä¸ªä¾‹å­é‡Œå°±æ˜¯ Telegraf çš„ 8125ï¼‰ï¼ŒæŒ‡å®šäº†æ‰€æœ‰ç›‘æ§æŒ‡æ ‡çš„å‰ç¼€æ˜¯ <code>http.</code>ï¼Œè¿˜æŒ‡å®šäº†ä¸¤ä¸ªå…¨å±€ Tagï¼Œä¸€ä¸ªæ˜¯ <code>service=n9e-webapi</code>ï¼Œå¦ä¸€ä¸ªæ˜¯ <code>region=bj</code>ã€‚é€šè¿‡ TagStyle æŒ‡å®šè¦å‘é€çš„æ˜¯ InfluxDB æ ·å¼çš„æ ‡ç­¾ã€‚</p><p>ç„¶åï¼Œåœ¨è¯·æ±‚çš„å…·ä½“å¤„ç†é€»è¾‘é‡Œä¸ŠæŠ¥äº†ä¸¤ä¸ªç›‘æ§æŒ‡æ ‡ï¼Œä¸€ä¸ªæ˜¯ <code>requests.counter</code>ï¼Œå¦ä¸€ä¸ªæ˜¯ <code>requests.latency</code>ï¼Œå¹¶ä¸ºå®ƒä»¬æŒ‡å®šäº†ä¸€ä¸ªæŒ‡æ ‡çº§åˆ«çš„æ ‡ç­¾ <code>page=home</code>ï¼Œæ•´ä½“çœ‹èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚</p><p>Telegraf æ”¯æŒå¤šç§ output æ’ä»¶ï¼Œå¯ä»¥ä½¿ç”¨æ¯”è¾ƒå¿«æ·çš„ outputs.file æ’ä»¶ï¼ŒæŠŠç”Ÿæˆçš„æŒ‡æ ‡å†™åˆ° stdoutï¼Œæ¥éªŒè¯æ•ˆæœã€‚</p><pre><code class="language-go">[[outputs.file]]
files = ["stdout"]
</code></pre><p>è¯·æ±‚æ•°é‡å’Œè¯·æ±‚å»¶æ—¶éƒ½æ˜¯å…¸å‹çš„åº”ç”¨å±‚é¢çš„ç›‘æ§æŒ‡æ ‡ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦åšä¸šåŠ¡æŒ‡æ ‡ç›‘æ§ï¼Œæ¯”å¦‚è®¢å•é‡ç›‘æ§ï¼Œåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿå…¶å®é€»è¾‘æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œä»¿ç…§ <code>requests.counter</code> çš„å†™æ³•ï¼Œåšä¸€ä¸ªè®¢å•é‡çš„æŒ‡æ ‡ï¼Œæ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°è®¢å•çš„æ—¶å€™ï¼Œå°±ç»™è®¢å•é‡æŒ‡æ ‡ <code>+1</code>ã€‚ä¸€èˆ¬ä¸€ä¸ªæœåŠ¡ä¼šéƒ¨ç½²å¤šä¸ªå®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹éƒ½ç»Ÿè®¡äº†è‡ªå·±çš„è®¢å•é‡ï¼Œè¦è®¡ç®—æœ€è¿‘ä¸€åˆ†é’Ÿçš„è®¢å•æ•°é‡çš„è¯ï¼Œåªéœ€è¦åœ¨æœåŠ¡ç«¯ä½¿ç”¨ PromQL åšäºŒæ¬¡æ±‡æ€»è®¡ç®—ã€‚</p><p>StatsD çš„åŸ‹ç‚¹æ–¹å¼æˆ‘ä»¬å°±ä»‹ç»è¿™ä¹ˆå¤šï¼Œä¸‹é¢æˆ‘ä»¬ä»‹ç»ä¸€ä¸‹ Prometheus çš„åŸ‹ç‚¹æ–¹å¼ã€‚</p><h2>Prometheus</h2><p>Prometheus çš„åŸ‹ç‚¹æ–¹å¼è·Ÿ StatsD å¾ˆåƒï¼Œå¯¹äºè¯·æ±‚æ•°é‡å’Œå»¶è¿Ÿè¿™æ ·çš„ç›‘æ§æŒ‡æ ‡ï¼Œä¹Ÿæ˜¯åœ¨è¯·æ±‚å¤„ç†å®Œæˆä¹‹åï¼Œè°ƒç”¨ SDK çš„æ–¹æ³•è¿›è¡Œè®°å½•çš„ã€‚ä¸è¿‡ï¼Œå¦‚æœæ¯ä¸ªæ–¹æ³•éƒ½è¦åŠ è¿™ä¹ˆå‡ è¡Œä»£ç å°±æ˜¾å¾—å¤ªå†—ä½™äº†ï¼Œæœ€å¥½è¿˜æ˜¯é€šè¿‡ AOP çš„æ–¹å¼åšä¸€äº›åˆ‡é¢é€»è¾‘ï¼ŒNightingale çš„ Webapi æ¨¡å—å°±æ˜¯è¿™ä¹ˆå¹²çš„ï¼Œæˆ‘ç›´æ¥ç”¨è¿™ä¸ª<a href="https://github.com/ccfos/nightingale">ä»£ç </a>ç»™ä½ è®²è§£ã€‚</p><p>Webapi çš„èŒèƒ½æ˜¯æä¾›ä¸€ç³»åˆ— HTTP æ¥å£ç»™ JavaScript è°ƒç”¨ï¼Œæˆ‘ä»¬éœ€è¦ç›‘æ§è¿™äº›æ¥å£çš„è°ƒç”¨é‡ã€æˆåŠŸç‡ã€å»¶è¿Ÿæ•°æ®ã€‚åŸ‹ç‚¹ä¹‹å‰æˆ‘ä»¬å…ˆè§„åˆ’ä¸€ä¸‹æ ‡ç­¾ï¼Œæˆ‘ä»¬ç»™æ¯ä¸ª HTTP æ¥å£è§„åˆ’ 4 ä¸ªæ ‡ç­¾ã€‚</p><ul>
<li>serviceï¼šæœåŠ¡åç§°ï¼Œè¦æ±‚å…¨å±€å”¯ä¸€ï¼Œå¯ä»¥å’Œå…¶ä»–æœåŠ¡åŒºåˆ†å¼€ã€‚</li>
<li>codeï¼šHTTP è¿”å›çŠ¶æ€ç ï¼Œå¯ä»¥æ ¹æ®è¿™ä¸ªä¿¡æ¯å¾—çŸ¥ 4xx çš„æ¯”ä¾‹æ˜¯å¤šå°‘ï¼Œ5xx çš„æ¯”ä¾‹æ˜¯å¤šå°‘ï¼Œè®¡ç®—æˆåŠŸç‡ã€‚</li>
<li>pathï¼šæ¥å£è·¯å¾„ï¼Œæ¯”å¦‚ <code>/api/v1/users</code> ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬ä¼šåœ¨æ¥å£è·¯å¾„ä¸­æ”¾ç½® URL å‚æ•°ï¼Œæ¯”å¦‚ <code>/api/v1/user/23</code>ã€<code>/api/v1/user/12</code> æ˜¯è¯·æ±‚ id ä¸º 23 å’Œ 12 çš„ç”¨æˆ·ä¿¡æ¯ã€‚è¿™ä¸ªæ—¶å€™ä¸èƒ½ç›´æ¥æŠŠè¿™ä¸ª URL ä½œä¸ºæ¥å£è·¯å¾„çš„æ ‡ç­¾å€¼ï¼Œå¦åˆ™è¿™ä¸ªæŒ‡æ ‡é¢—ç²’åº¦å°±å¤ªç»†äº†ï¼Œåº”è¯¥æŠŠæ¥å£è·¯å¾„çš„æ ‡ç­¾å€¼è®¾ç½®æˆ <code>/api/v1/user/:id</code>ã€‚</li>
<li>methodï¼šHTTP æ–¹æ³•ï¼ŒGETã€POSTã€DELETEã€PUT ç­‰ã€‚</li>
</ul><p>Prometheus åŸ‹ç‚¹éœ€è¦æå‰æŠŠæŒ‡æ ‡å˜é‡å®šä¹‰å‡ºæ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„åŒ…æ¥æ”¾ç½®ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹<a href="https://github.com/ccfos/nightingale/blob/main/src/webapi/stat/stat.go">ç›¸å…³ä»£ç </a>ã€‚</p><pre><code class="language-go">package stat

import (
	"time"

	"github.com/prometheus/client_golang/prometheus"
)

const Service = "n9e-webapi"

var (
	labels = []string{"service", "code", "path", "method"}

	uptime = prometheus.NewCounterVec(
		prometheus.CounterOpts{
			Name: "uptime",
			Help: "HTTP service uptime.",
		}, []string{"service"},
	)

	RequestCounter = prometheus.NewCounterVec(
		prometheus.CounterOpts{
			Name: "http_request_count_total",
			Help: "Total number of HTTP requests made.",
		}, labels,
	)

	RequestDuration = prometheus.NewHistogramVec(
		prometheus.HistogramOpts{
			Buckets: []float64{.01, .1, 1, 10},
			Name:&nbsp; &nbsp; "http_request_duration_seconds",
			Help:&nbsp; &nbsp; "HTTP request latencies in seconds.",
		}, labels,
	)
)

func Init() {
	// Register the summary and the histogram with Prometheus's default registry.
	prometheus.MustRegister(
		uptime,
		RequestCounter,
		RequestDuration,
	)

	go recordUptime()
}

// recordUptime increases service uptime per second.
func recordUptime() {
	for range time.Tick(time.Second) {
		uptime.WithLabelValues(Service).Inc()
	}
}
</code></pre><p>uptime å˜é‡æ˜¯é¡ºæ‰‹ä¸ºä¹‹ï¼Œç»Ÿè®¡è¿›ç¨‹å¯åŠ¨äº†å¤šé•¿æ—¶é—´ï¼Œä¸ç”¨å¤ªå…³æ³¨ï¼ŒRequestCounter å’Œ RequestDurationï¼Œåˆ†åˆ«ç»Ÿè®¡è¯·æ±‚æµé‡å’Œè¯·æ±‚å»¶è¿Ÿã€‚Init æ–¹æ³•æ˜¯åœ¨ Webapi æ¨¡å—è¿›ç¨‹åˆå§‹åŒ–çš„æ—¶å€™è°ƒç”¨ï¼Œæ‰€ä»¥è¿›ç¨‹ä¸€èµ·ï¼Œå°±ä¼šè‡ªåŠ¨æ³¨å†Œå¥½ã€‚</p><p>ç„¶åæˆ‘ä»¬å†™ä¸€ä¸ª middlewareï¼Œåœ¨è¯·æ±‚è¿›æ¥çš„æ—¶å€™æ‹¦æˆªä¸€ä¸‹ï¼Œçœå¾—æ¯ä¸ªè¯·æ±‚éƒ½è¦å»ç»Ÿè®¡ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹ middleware æ–¹æ³•çš„<a href="https://github.com/ccfos/nightingale/blob/main/src/webapi/router/router.go#L20">ä»£ç </a>ã€‚</p><pre><code class="language-go">func stat() gin.HandlerFunc {
		return func(c *gin.Context) {
			start := time.Now()
			c.Next()
	
			code := fmt.Sprintf("%d", c.Writer.Status())
			method := c.Request.Method
			labels := []string{promstat.Service, code, c.FullPath(), method}
	
			promstat.RequestCounter.WithLabelValues(labels...).Inc()
			promstat.RequestDuration.WithLabelValues(labels...).Observe(float64(time.Since(start).Seconds()))
		}
	}
</code></pre><p>æœ‰äº†è¿™ä¸ª middleware ä¹‹åï¼Œnew å‡º gin çš„ engine çš„æ—¶å€™ï¼Œå°±ç«‹é©¬ Use ä¸€ä¸‹ã€‚</p><pre><code class="language-go">...
r := gin.New()
r.Use(stat())
...
</code></pre><p>æœ€åï¼Œç›‘æ§æ•°æ®è¦é€šè¿‡/metricsæ¥å£æš´éœ²å‡ºå»ï¼Œæˆ‘ä»¬è¦æš´éœ²è¿™ä¸ªè¯·æ±‚ç«¯ç‚¹ã€‚</p><pre><code class="language-go">import (
	...
	"github.com/prometheus/client_golang/prometheus/promhttp"
)
func configRoute(r *gin.Engine, version string) {
	...
	r.GET("/metrics", gin.WrapH(promhttp.Handler()))
}
</code></pre><p>è¿™æ ·ï¼Œæ¯ä¸ª Webapi æ¥å£çš„æµé‡å’ŒæˆåŠŸç‡éƒ½å¯ä»¥ç›‘æ§åˆ°äº†ã€‚å¦‚æœä½ ä¹Ÿéƒ¨ç½²äº† Nightingaleï¼Œè¯·æ±‚ Webapiï¼ˆé»˜è®¤æ˜¯18000ï¼‰çš„&nbsp;/metrics&nbsp;æ¥å£çœ‹çœ‹è¿”å›çš„å†…å®¹å§ã€‚</p><p>æ— è®ºæ˜¯StatsDï¼Œè¿˜æ˜¯ä½¿ç”¨Prometheusï¼Œæ€»ä¹‹é€šè¿‡åŸ‹ç‚¹æˆ‘ä»¬é‡‡é›†åˆ°äº†ç›‘æ§æŒ‡æ ‡ã€‚æ¥ä¸‹æ¥è¿™äº›æ•°æ®å¦‚ä½•è¿›å…¥ç›‘æ§æœåŠ¡ç«¯å‘¢ï¼Ÿæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªé€šè·¯å…¸å‹çš„æ„å»ºæ–¹å¼ã€‚</p><h2>æ•°æ®ä¼ è¾“é€šè·¯</h2><p>ä½¿ç”¨ StatsD çš„åŸ‹ç‚¹æ–¹å¼ï¼Œæ•°æ®é€šè¿‡ UDP æ¨ç»™ Telegrafï¼ŒTelegraf æ¨ç»™åç«¯ç›‘æ§ç³»ç»Ÿã€‚å¦‚æœæ˜¯é€šè¿‡ Prometheus çš„æ–¹å¼æ¥åŸ‹ç‚¹ï¼Œå°±æ˜¯æš´éœ² <code>/metrics</code> æ¥å£ï¼Œç­‰å¾…ç›‘æ§ç³»ç»Ÿæ¥æ‹‰ã€‚å¦‚æœåº”ç”¨æ˜¯éƒ¨ç½²åœ¨ç‰©ç†æœºæˆ–è™šæ‹Ÿæœºä¸Šï¼Œç›´æ¥é€šè¿‡æœ¬åœ°çš„ç›‘æ§ agent æ¥æ‹‰å–å³å¯ã€‚å¦‚æœåº”ç”¨æ˜¯éƒ¨ç½²åœ¨ Kubernetes çš„ Pod é‡Œï¼Œåˆ™æœ‰ä¸¤ç§åŠæ³•æ¥æ‹‰å–æ•°æ®ï¼Œä¸€ä¸ªæ˜¯ Sidecar æ¨¡å¼ï¼Œä¸€ä¸ªæ˜¯ä¸­å¿ƒç«¯æœåŠ¡å‘ç°çš„æ¨¡å¼ã€‚ä¸‹é¢è¿™ä¸ªç¤ºæ„å›¾å±•ç¤ºçš„æ˜¯ Sidecar æ¨¡å¼ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/13/d1/1309313e94e9a9f8a88344d74d3762d1.png?wh=2256x1232" alt="" title="Sidecar æ¨¡å¼"></p><p>å·¦ä¾§ Pod1 é‡Œæœ‰ä¸¤ä¸ªå®¹å™¨ï¼ŒApp é€šè¿‡ StatsD åŸ‹ç‚¹ï¼Œç„¶åé€šè¿‡ UDP æ¨ç»™ Telegrafï¼ŒTelegraf æ¥æ”¶åˆ°æ•°æ®ä¹‹ååšäºŒæ¬¡è®¡ç®—ï¼ŒæŠŠç»“æœæ¨ç»™ç›‘æ§æœåŠ¡ç«¯ï¼›å³ä¾§ Pod2 é‡Œä¹Ÿæœ‰ä¸¤ä¸ªå®¹å™¨ï¼ŒApp é€šè¿‡ Prometheus SDK åŸ‹ç‚¹ï¼Œæš´éœ² <code>/metrics</code> æ¥å£ï¼ŒCategraf é€šè¿‡è¿™ä¸ªæ¥å£æ‹‰å–æ•°æ®ï¼Œç„¶åæ¨ç»™ç›‘æ§æœåŠ¡ç«¯ã€‚</p><p>è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯æ¯”è¾ƒçµæ´»ï¼ŒPod å†…æ€ä¹ˆåšåº”ç”¨è‡ªå·±è¯´äº†ç®—ã€‚å³ä½¿ç»™ <code>/metrics</code> æ¥å£å¢åŠ ä¸€äº›è®¤è¯é‰´æƒã€æŒ‡æ ‡è¿‡æ»¤ã€æ‰©å±•æ ‡ç­¾çš„é€»è¾‘ï¼Œéƒ½ä¸å½±å“å…¶ä»–çš„ Podã€‚æ•°æ®æ˜¯æ¨ç»™ç›‘æ§æœåŠ¡ç«¯çš„ï¼Œç›‘æ§æœåŠ¡ç«¯æ¥æ”¶æ•°æ®çš„ç»„ä»¶å¯ä»¥åšæˆæ— çŠ¶æ€é›†ç¾¤ï¼Œå‰é¢æ¶è®¾è´Ÿè½½å‡è¡¡ï¼Œæ•´ä¸ªæ¶æ„éå¸¸ç®€å•ã€æ‰©å±•æ€§ä¹Ÿå¾ˆå¥½ã€‚å½“ç„¶ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œæ¯ä¸ª Pod é‡Œéƒ½ä¼´ç”Ÿ Sidecar agentï¼Œæµªè´¹èµ„æºã€‚</p><p>StatsD åŸ‹ç‚¹çš„æ–¹å¼åªèƒ½ä½¿ç”¨ Sidecaræ¨¡å¼ä¼ è¾“æ•°æ®ï¼Œè€ŒPrometheus SDK åŸ‹ç‚¹è¿˜æœ‰ç¬¬äºŒç§æ•°æ®æŠ“å–æ–¹å¼ï¼šä¸­å¿ƒç«¯æœåŠ¡å‘ç°æ¨¡å¼ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/a4/d8/a4e052ddd462710c05d2c21db88388d8.png?wh=1818x1324" alt="å›¾ç‰‡" title="ä¸­å¿ƒç«¯æœåŠ¡å‘ç°æ¨¡å¼"></p><p>æ¯ä¸ªåº”ç”¨å®¹å™¨éƒ½ç»Ÿä¸€æš´éœ² <code>/metrics</code> æ¥å£ï¼Œç›‘æ§æŠ“å–å™¨é€šè¿‡ Kubernetes æœåŠ¡å‘ç°æœºåˆ¶ï¼Œæ‰¾åˆ°æ‰€æœ‰çš„ Podï¼Œåˆ†åˆ«æŠ“å–å³å¯ã€‚ä¸è¿‡ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ Pod éƒ½æš´éœ²æŒ‡æ ‡æ•°æ®ï¼Œå³ä½¿æš´éœ²äº†ï¼Œæ¥å£è·¯å¾„ä¹Ÿæœªå¿…ä¸€å®šæ˜¯ <code>/metrics</code>ï¼Œè¿™å°±éœ€è¦æœ‰ä¸€ä¸ªæœºåˆ¶å’Œè§„èŒƒï¼Œé€šè¿‡è¿™ä¸ªæœºåˆ¶å‘Šè¯‰æŒ‡æ ‡æŠ“å–å™¨ï¼Œé€‰æ‹©å“ªä¸ªç±»å‹çš„ Pod æŠ“æ•°æ®ï¼ŒæŠ“æ•°æ®çš„æ—¶å€™ä½¿ç”¨å“ªä¸ªç«¯å£ã€å“ªä¸ªæ¥å£è·¯å¾„æ¥æŠ“ã€‚</p><p>ä¸€èˆ¬æˆ‘ä»¬ä½¿ç”¨ Pod æ³¨è§£æ¥æ‰¿æ¥è¿™ä¸ªè§„èŒƒï¼Œæ¯”å¦‚æˆ‘ä»¬åˆ¶å®šæ ‡å‡†ï¼šæ‰€æœ‰æƒ³è¦è¢«æŠ“å–ç›‘æ§æ•°æ®çš„ Pod éƒ½ç»Ÿä¸€æš´éœ²å¦‚ä¸‹æ³¨è§£ã€‚</p><pre><code class="language-go">prometheus.io/scrape=true
prometheus.io/metric_path=&lt;path&gt;
prometheus.io/scrape_port=&lt;port&gt;
</code></pre><p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥å†™æŠ“å– Job æ¥æŠ“å–è¿™ç±»æ•°æ®äº†ï¼Œä¸‹é¢æˆ‘ç»™å‡ºä¸€ä¸ªæ ·ä¾‹ã€‚</p><pre><code class="language-yaml">- job_name: "kubernetes-pods"
  kubernetes_sd_configs:
    - role: pod
  relabel_configs:
    # "prometheus.io/scrape = true" annotation.
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
      action: keep
      regex: true
    # "prometheus.io/metric_path = &lt;metric path&gt;" annotation.
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_metric_path]
      action: replace
      target_label: __metrics_path__
      regex: (.+)
    # "prometheus.io/scrape_port = &lt;port&gt;" annotation.
    - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_scrape_port]
      action: replace
      regex: ([^:]+)(?::\d+)?;(\d+)
      replacement: $1:$2
      target_label: __address__
    - action: labelmap
      regex: __meta_kubernetes_pod_label_(.+)
    - source_labels: [__meta_kubernetes_namespace]
      action: replace
      target_label: namespace
    - source_labels: [__meta_kubernetes_pod_name]
      action: replace
      target_label: pod
</code></pre><p>æˆ‘ä»¬åˆ†æä¸€ä¸‹ä¸­å¿ƒç«¯æœåŠ¡å‘ç°æœºåˆ¶çš„ä¼˜ç¼ºç‚¹ã€‚ä¼˜ç‚¹å¾ˆæ˜æ˜¾ï¼Œä¸éœ€è¦ sidecar çš„ agent äº†ï¼Œå¤§å¹…èŠ‚çœèµ„æºï¼Œç¼ºç‚¹æ˜¯æ‰€æœ‰çš„æŠ“å–è§„åˆ™éƒ½æ˜¯ç»Ÿä¸€çš„ï¼Œä¸å¥½ä¸ºæ¯ä¸ª Pod å•ç‹¬æŒ‡å®šä¸€äº›è®¤è¯æœºåˆ¶ã€è¿‡æ»¤è§„åˆ™ç­‰ã€‚ä¸æ˜¯è¯´ä¸èƒ½å¹²ï¼Œè€Œæ˜¯è¦åšçš„è¯å°±å¾—ä¿®æ”¹ä¸­å¿ƒç«¯è¿™ä¸ªç»Ÿä¸€çš„æŠ“å–è§„åˆ™ï¼Œéå¸¸ä¸æ–¹ä¾¿ï¼Œç¨æœ‰ä¸æ…è¿˜å®¹æ˜“æ”¹é”™ï¼Œå½±å“åˆ°åˆ«çš„Podã€‚</p><p>å½“ç„¶äº†ï¼Œä¸€èˆ¬æ¥è¯´ä¸æä¾›è¿™ä¸ªçµæ´»æ€§ä¹Ÿä¸æ˜¯å¤ªå¤§çš„é—®é¢˜ï¼Œå¤§å®¶éµç…§ä¸€ä¸ªç»Ÿä¸€çš„è§„èŒƒä¹ŸæŒºå¥½çš„ï¼Œå¦‚æœçœŸçš„æœ‰æŸä¸ª Pod éœ€è¦é¢å¤–åšä¸€äº›çµæ´»é…ç½®ï¼Œå¤§ä¸äº†å°±ä¸å¼€é‚£äº›æ³¨è§£ï¼Œä»ä½¿ç”¨ sidecar æ¨¡å¼å°±å¥½ã€‚è¿™ä¸¤ç§æ–¹å¼å¹¶ä¸ä¸€å®šè¦äºŒé€‰ä¸€ï¼ŒåŒæ—¶å¹¶ç”¨ä¹Ÿæ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚</p><p>åˆ°è¿™é‡Œï¼ŒåŸ‹ç‚¹ç›‘æ§çš„ä¸¤ç§æ‰‹æ®µå°±éƒ½ä»‹ç»å®Œäº†ï¼Œä¸‹é¢æˆ‘ä»¬åšä¸€ä¸ªå°ç»“ã€‚</p><h2>å°ç»“</h2><p>è¿™ä¸€è®²æˆ‘ä»¬ä»‹ç»äº†ä¸¤ç§åŸ‹ç‚¹ç›‘æ§åº”ç”¨çš„æ–¹å¼ï¼Œä¸€ä¸ªæ˜¯ StatsDï¼Œä¸€ä¸ªæ˜¯ Prometheusï¼Œè¿™ä¸¤ç§æ–¹å¼éƒ½æ˜¯è·¨è¯­è¨€çš„åŸ‹ç‚¹æ–¹æ¡ˆï¼Œä¸šç•Œåº”ç”¨å¹¿æ³›ã€‚StatsD æ˜¯æ¨æ¨¡å¼ï¼Œé‡‡ç”¨ UDP åè®®ï¼Œå„ç±»è®¡ç®—é€»è¾‘æŒªåˆ°äº† StatsD Server ä¸­ï¼Œå¯¹åº”ç”¨æœ¬èº«ä¸ä¼šé€ æˆå½±å“ã€‚Prometheus æ˜¯æ‹‰æ¨¡å¼ï¼ŒSDK çš„é€»è¾‘è·‘åœ¨åº”ç”¨è¿›ç¨‹é‡Œï¼Œå¯èƒ½å¯¹åº”ç”¨é€ æˆä¸€å®šå½±å“ï¼Œä¸è¿‡å·²ç»æœ‰å¾ˆå¤šå…¬å¸åšäº†ç”Ÿäº§éªŒè¯ï¼ŒPrometheus çš„ SDK è¿˜æ˜¯å¾ˆç¨³å®šçš„ï¼Œå¤§å¯æ”¾å¿ƒä½¿ç”¨ã€‚</p><p>å¯¹äº Prometheus SDK çš„åŸ‹ç‚¹æ–¹æ¡ˆï¼Œæœ‰ä¸¤ç§æ•°æ®æŠ“å–æ–¹å¼ï¼Œä¸€ä¸ªæ˜¯ Sidecar æ¨¡å¼ï¼Œçµæ´»ä½†æ˜¯å ç”¨èµ„æºå¤šï¼›ä¸€ä¸ªæ˜¯ä¸­å¿ƒç«¯æœåŠ¡å‘ç°æ¨¡å¼ï¼Œä¸é‚£ä¹ˆçµæ´»ä½†æ˜¯èµ„æºå ç”¨å¾—å°‘ï¼ŒæŠ€æœ¯ä¸Šæ²¡æœ‰éé»‘å³ç™½ï¼Œå»ºè®®ä½ æ ¹æ®å…·ä½“åœºæ™¯çµæ´»é€‰æ‹©ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/8f/6c/8f8c77346f64b8f850798a08238c0a6c.jpg?wh=2197x1573" alt=""></p><h2>äº’åŠ¨æ—¶åˆ»</h2><p>å¯¹äº Prometheus SDK åŸ‹ç‚¹æœºåˆ¶ï¼Œåœ¨ä½¿ç”¨ä¸­å¿ƒç«¯æŠ“å–æ–¹å¼çš„æ—¶å€™ï¼Œå¦‚æœç›®æ ‡ Pod é‡å¾ˆå¤§ï¼Œå•ä¸ªæŠ“å–å™¨å°±æŠ“ä¸è¿‡æ¥äº†ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦æœ‰ä¸ªåˆ†ç‰‡æœºåˆ¶ï¼Œç”¨å¤šä¸ªæŠ“å–å™¨æ¥æŠ“ï¼Œæ¯ä¸ªæŠ“å–å™¨æŠ“ä¸€éƒ¨åˆ†æŒ‡æ ‡ã€‚æˆ‘ä»¬åº”è¯¥æŒ‰ç…§å“ªäº›ç»´åº¦åšåˆ†ç‰‡å‘¢ï¼Ÿå…·ä½“é…ç½®æ ·ä¾‹æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿæ¬¢è¿ä½ ç•™è¨€åˆ†äº«ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·å­¦ä¹ ã€‚æˆ‘ä»¬ä¸‹ä¸€è®²å†è§ï¼</p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src=""
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_1a3949</span>
  </div>
  <div class="_2_QraFYR_0">å°è¯•å›ç­”ä¸€ä¸‹è¯¾åé¢˜ï¼š<br><br>åˆ†ç‰‡å¯ä»¥ä½¿ç”¨Prometheusçš„hashmodï¼Œlabelé€‰æ‹©å°½é‡éšæœºçš„ï¼Œæ¯”å¦‚addressï¼Œæˆ–è€…address+nameç­‰ç­‰<br><br>- job_name: &quot;pods&quot;<br>  ...<br>  relabel_configs:<br>  - source_labels: [__address__]<br>    modulus: 3<br>    target_label: __tmp_hash<br>    action: hashmod<br>  - source_labels: [__tmp_hash]<br>    regex: 1<br>    action: keep</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-02-20 11:32:41</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/16/20/fc/791d0f5e.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>CDS</span>
  </div>
  <div class="_2_QraFYR_0">èƒŒæ™¯ <br>1 åŒäº‹ä¸æ„¿æ„åŸ‹ç‚¹å¢åŠ ä»£ç  <br>2 ç›®å‰åªæ˜¯å¸Œæœ›çœ‹è§ç³»ç»Ÿï¼ˆubuntu 18.04ï¼‰å†…å„ä¸ªè¿›ç¨‹çš„èµ„æºï¼ˆcpu å†…å­˜ï¼‰çš„å¤§è‡´è¶‹åŠ¿<br>3 ç²¾åº¦è¦æ±‚ä¸ºç§’çº§<br>4 åªç›‘æ§æœ¬æœº ä¸ç›‘æ§å…¶ä»–æœºå™¨<br><br>è¯·é—®å¦‚ä¸‹æ–¹æ¡ˆæ˜¯å¦å¯è¡Œ<br>ä½¿ç”¨Prometheus SDK httpæ–¹å¼ æ‹‰å–å›ºå®šä¸€ä¸ªHTTPæ¥å£ ï¼ˆAæœåŠ¡ä¸Šçš„ï¼‰<br>AæœåŠ¡é€šè¿‡ç«¯å£æŸ¥è¯¢pid åœ¨ä½¿ç”¨topå‘½ä»¤å»æŸ¥è¯¢èµ„æºä½¿ç”¨æƒ…å†µ<br><br>å¦‚æœå¯è¡Œ githubä¸Šé¢æœ‰æ²¡æœ‰ç±»ä¼¼è¿™æ ·çš„é¡¹ç›®<br>å¦‚æœä¸å¯è¡Œ æ˜¯ä½¿ç”¨ebpfè¿›è¡Œç›‘æ§å—</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: categraf çš„ input.procstat æ’ä»¶å°±å¯ä»¥å“ˆï¼ŒæŒ‡å®šè¦ç›‘æ§çš„è¿›ç¨‹æ˜¯ä»€ä¹ˆï¼Œå°±å¯ä»¥é‡‡é›†è¿›ç¨‹çš„cpuã€memç­‰ä¿¡æ¯</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-03-29 09:14:27</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/c3/c9/a8e03342.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>x</span>
  </div>
  <div class="_2_QraFYR_0">åº”ç”¨è¿›ç¨‹é‡Œçš„sdkä¸€ç›´åœ¨è®¡ç®—å’Œä¿å­˜æ•°æ®ï¼Œé•¿æœŸæ²¡æœ‰prometheuså»è®¿é—®å®ƒçš„&#47;metricsæ¥å£ï¼Œä¼šæœ‰å†…å­˜é—®é¢˜å—</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ä¸ä¼šï¼Œè¿™ä¸ªå¤§å¯æ”¾å¿ƒ</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-03-09 15:55:54</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>peter</span>
  </div>
  <div class="_2_QraFYR_0">è¯·æ•™è€å¸ˆå‡ ä¸ªé—®é¢˜ï¼š<br>Q1ï¼šPod ä¸­çš„ Sidecar agentå°±æ˜¯æŒ‡Telegrafæˆ–Categrafå—ï¼Ÿ<br>Q2ï¼šSidecaræ–¹å¼çš„å›¾ä¸­ï¼ŒStatsDç”¨Telegraf;prometheusç”¨Categrafï¼Œè¿™æ˜¯ä¸€ç§å…¸å‹é…ç½®ï¼Ÿè¿˜æ˜¯è¯´å¿…é¡»è¿™æ ·ï¼Ÿï¼ˆæ¯”å¦‚ï¼ŒPrometheuså¯ä»¥ä½¿ç”¨Telegrafå—ï¼Ÿæˆ–è€…StatsDå¯ä»¥ä½¿ç”¨Categrafå—ï¼Ÿï¼‰<br>Q3ï¼šåº”ç”¨å±‚åŸ‹ç‚¹çš„Prometheusæ–¹å¼ï¼Œæ˜¯Prometheusè‡ªèº«å…·å¤‡çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œä¸æ˜¯å¦å¤–çš„ä¸€ä¸ªè½¯ä»¶ï¼Œå¯¹å—ï¼Ÿ<br>Q4ï¼šè€å¸ˆç»å†çš„å…¬å¸æ‰€ç”¨çš„åº”ç”¨å±‚åŸ‹ç‚¹æ–¹æ¡ˆï¼Œæ˜¯ç”¨å¼€æºæ¡†æ¶å¤šè¿˜æ˜¯è‡ªç ”çš„å¤šï¼Ÿæ¡†æ¶çš„è¯ï¼Œæ˜¯StatsDç”¨å¾—å¤šè¿˜æ˜¯Prometheusç”¨å¾—å¤šï¼Ÿ<br>Q5ï¼šæœ¬æ–‡çš„ä¸¤ç§åŸ‹ç‚¹æ–¹æ¡ˆé€‚ç”¨äºç§»åŠ¨ç«¯å—ï¼Ÿ<br>æ¯”å¦‚å®‰å“ã€iOSï¼Œå¯ä»¥ç”¨è¿™ä¸¤ç§æ–¹å¼å—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: 1ï¼Œæ˜¯<br>2ï¼Œcategrafç›®å‰ä¸æ”¯æŒæ¥æ”¶statsdåè®®çš„æ•°æ®<br>3ï¼Œæ˜¯åº”ç”¨å¼•å…¥lib<br>4ï¼Œå¼€æºçš„å¤šï¼Œstatsdå’Œproméƒ½æŒºå¤š<br>5ï¼Œé€‚ç”¨ï¼Œä½†æ˜¯ç«¯ä¸Šï¼Œmetricsæ²¡æœ‰é‚£ä¹ˆå…³é”®ï¼Œæ›´åº”è¯¥å¼•å…¥sentryä¹‹ç±»çš„æ–¹æ¡ˆåšäº‹ä»¶ç›‘æ§</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-02-20 10:41:20</div>
  </div>
</div>
</div>
</li>
</ul>