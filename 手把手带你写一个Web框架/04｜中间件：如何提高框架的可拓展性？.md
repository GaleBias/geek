<audio title="04ï½œä¸­é—´ä»¶ï¼šå¦‚ä½•æé«˜æ¡†æ¶çš„å¯æ‹“å±•æ€§ï¼Ÿ" src="https://static001.geekbang.org/resource/audio/19/d9/19969f47411ab91607a6accf69fbeed9.mp3" controls="controls"></audio> 
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯è½©è„‰åˆƒã€‚</p><p>åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å·²ç»å®Œæˆäº†Webæ¡†æ¶çš„åŸºç¡€éƒ¨åˆ†ï¼Œä½¿ç”¨net/httpå¯åŠ¨äº†ä¸€ä¸ªWebæœåŠ¡ï¼Œå¹¶ä¸”å®šä¹‰äº†è‡ªå·±çš„Contextï¼Œå¯ä»¥æ§åˆ¶è¯·æ±‚è¶…æ—¶ã€‚</p><p>ä¹‹å‰åœ¨è®²å…·ä½“å®ç°çš„æ—¶å€™ï¼Œæˆ‘ä»¬åå¤å¼ºè°ƒè¦æ³¨æ„ä»£ç çš„ä¼˜åŒ–ã€‚é‚£ä¹ˆå¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿå…·ä½“æ¥è¯´ï¼Œå¾ˆé‡è¦çš„ä¸€ç‚¹å°±æ˜¯å°è£…ã€‚æ‰€ä»¥ä»Šå¤©æˆ‘ä»¬å°±å›é¡¾ä¸€ä¸‹ä¹‹å‰å†™çš„ä»£ç ï¼Œçœ‹çœ‹å¦‚ä½•é€šè¿‡å°è£…æ¥è¿›ä¸€æ­¥æé«˜ä»£ç æ‰©å±•æ€§ã€‚</p><p>åœ¨ç¬¬äºŒè¯¾ï¼Œæˆ‘ä»¬åœ¨ä¸šåŠ¡æ–‡ä»¶å¤¹ä¸­çš„controller.goçš„é€»è¾‘ä¸­è®¾ç½®äº†ä¸€ä¸ªæœ‰è¶…æ—¶æ—¶é•¿çš„æ§åˆ¶å™¨ï¼š</p><pre><code class="language-go">func FooControllerHandler(c *framework.Context) error {
	...
    // åœ¨ä¸šåŠ¡é€»è¾‘å¤„ç†å‰ï¼Œåˆ›å»ºæœ‰å®šæ—¶å™¨åŠŸèƒ½çš„ context
	durationCtx, cancel := context.WithTimeout(c.BaseContext(), time.Duration(1*time.Second))
	defer cancel()

	go func() {
		...
		// æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘
        
		time.Sleep(10 * time.Second)
        // ...
              
		finish &lt;- struct{}{}
	}()
	// åœ¨ä¸šåŠ¡é€»è¾‘å¤„ç†åï¼Œæ“ä½œè¾“å‡ºé€»è¾‘...
    select {
	...
	case &lt;-finish:
		fmt.Println("finish")
	...
	}
	return nil
}
</code></pre><!-- [[[read_end]]] --><p>åœ¨æ­£å¼æ‰§è¡Œä¸šåŠ¡é€»è¾‘ä¹‹å‰ï¼Œåˆ›å»ºäº†ä¸€ä¸ªå…·æœ‰å®šæ—¶å™¨åŠŸèƒ½çš„ Contextï¼Œç„¶åå¼€å¯ä¸€ä¸ª Goroutine æ‰§è¡Œæ­£å¼çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶ä¸”ç›‘å¬å®šæ—¶å™¨å’Œä¸šåŠ¡é€»è¾‘ï¼Œå“ªä¸ªå…ˆå®Œæˆï¼Œå°±å…ˆè¾“å‡ºå†…å®¹ã€‚</p><p>é¦–å…ˆä»ä»£ç åŠŸèƒ½åˆ†æï¼Œè¿™ä¸ªæ§åˆ¶å™¨åƒç”±ä¸¤éƒ¨åˆ†ç»„æˆã€‚</p><p>ä¸€éƒ¨åˆ†æ˜¯<strong>ä¸šåŠ¡é€»è¾‘</strong>ï¼Œä¹Ÿå°±æ˜¯time.Sleepå‡½æ•°æ‰€ä»£è¡¨çš„é€»è¾‘ï¼Œåœ¨å®é™…ç”Ÿäº§è¿‡ç¨‹ä¸­ï¼Œè¿™é‡Œä¼šæœ‰å¾ˆé‡çš„ä¸šåŠ¡é€»è¾‘ä»£ç ï¼›è€Œå¦ä¸€éƒ¨åˆ†æ˜¯<strong>éä¸šåŠ¡é€»è¾‘</strong>ï¼Œæ¯”å¦‚åˆ›å»ºContextã€é€šé“ç­‰å¾…finishä¿¡å·ç­‰ã€‚å¾ˆæ˜æ˜¾ï¼Œè¿™ä¸ªéä¸šåŠ¡é€»è¾‘æ˜¯éå¸¸é€šç”¨çš„éœ€æ±‚ï¼Œå¯èƒ½åœ¨å¤šä¸ªæ§åˆ¶å™¨ä¸­éƒ½ä¼šä½¿ç”¨åˆ°ã€‚</p><p>è€Œä¸”è€ƒè™‘å¤ç”¨æ€§ï¼Œè¿™é‡Œåªæ˜¯å†™äº†ä¸€ä¸ªæ§åˆ¶å™¨ï¼Œé‚£å¦‚æœæœ‰å¤šä¸ªæ§åˆ¶å™¨å‘¢ï¼Œæˆ‘ä»¬éš¾é“è¦ä¸ºæ¯ä¸ªæ§åˆ¶å™¨éƒ½å†™ä¸Šè¿™ä¹ˆä¸€æ®µè¶…æ—¶ä»£ç å—ï¼Ÿé‚£å°±éå¸¸å†—ä½™äº†ã€‚</p><p>æ‰€ä»¥ï¼Œèƒ½ä¸èƒ½è®¾è®¡ä¸€ä¸ªæœºåˆ¶ï¼Œ<strong>å°†è¿™äº›éä¸šåŠ¡é€»è¾‘ä»£ç æŠ½è±¡å‡ºæ¥ï¼Œå°è£…å¥½ï¼Œæä¾›æ¥å£ç»™æ§åˆ¶å™¨ä½¿ç”¨</strong>ã€‚è¿™ä¸ªæœºåˆ¶çš„å®ç°ï¼Œå°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦è®²çš„ä¸­é—´ä»¶ã€‚</p><p>æ€ä¹ˆå®ç°è¿™ä¸ªä¸­é—´ä»¶å‘¢ï¼Ÿæˆ‘ä»¬å†è§‚å¯Ÿä¸€ä¸‹åˆšæ‰çš„ä»£ç æ‰¾æ‰¾æ€è·¯ã€‚</p><p>ä»£ç çš„ç»„ç»‡é¡ºåºå¾ˆæ¸…æ™°ï¼Œå…ˆé¢„å¤„ç†è¯·æ±‚ï¼Œå†å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œæœ€åå¤„ç†è¿”å›å€¼ï¼Œä½ å‘ç°æ²¡æœ‰è¿™ç§é¡ºåºï¼Œå…¶å®å¾ˆç¬¦åˆè®¾è®¡æ¨¡å¼ä¸­çš„è£…é¥°å™¨æ¨¡å¼ã€‚è£…é¥°å™¨æ¨¡å¼ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åœ¨æ ¸å¿ƒå¤„ç†æ¨¡å—çš„å¤–å±‚å¢åŠ ä¸€ä¸ªåˆä¸€ä¸ªçš„è£…é¥°ï¼Œç±»ä¼¼æ´‹è‘±ã€‚<img src="https://static001.geekbang.org/resource/image/f9/2c/f94ccc78af2ca491afe1591e674e3f2c.jpg?wh=1920x912" alt=""></p><p>ç°åœ¨ï¼ŒæŠ½è±¡å‡ºä¸­é—´ä»¶çš„æ€è·¯æ˜¯ä¸æ˜¯å°±å¾ˆæ¸…æ™°äº†ï¼ŒæŠŠæ ¸å¿ƒä¸šåŠ¡é€»è¾‘å…ˆå°è£…èµ·æ¥ï¼Œç„¶åä¸€å±‚ä¸€å±‚æ·»åŠ è£…é¥°ï¼Œæœ€ç»ˆè®©æ‰€æœ‰è¯·æ±‚æ­£åºä¸€å±‚å±‚é€šè¿‡è£…é¥°å™¨ï¼Œè¿›å…¥æ ¸å¿ƒå¤„ç†æ¨¡å—ï¼Œå†ååºé€€å‡ºè£…é¥°å™¨ã€‚åŸç†å°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œä¸éš¾ç†è§£ï¼Œæˆ‘ä»¬æ¥ç€çœ‹è¯¥å¦‚ä½•å®ç°ã€‚</p><h2>ä½¿ç”¨å‡½æ•°åµŒå¥—æ–¹å¼å®ç°ä¸­é—´ä»¶</h2><p>è£…é¥°å™¨æ¨¡å¼æ˜¯ä¸€å±‚ä¸€å±‚çš„ï¼Œæ‰€ä»¥å…·ä½“å®ç°å…¶å®ä¹Ÿä¸éš¾æƒ³åˆ°ï¼Œå°±æ˜¯ä½¿ç”¨å‡½æ•°åµŒå¥—ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å°è£…æ ¸å¿ƒçš„ä¸šåŠ¡é€»è¾‘ã€‚å°±æ˜¯è¯´ï¼Œè¿™ä¸ªä¸­é—´ä»¶çš„è¾“å…¥æ˜¯ä¸€ä¸ªæ ¸å¿ƒçš„ä¸šåŠ¡é€»è¾‘ ControllerHandlerï¼Œè¾“å‡ºä¹Ÿåº”è¯¥æ˜¯ä¸€ä¸ª ControllerHandlerã€‚æ‰€ä»¥<strong>å¯¹äºä¸€ä¸ªè¶…æ—¶æ§åˆ¶å™¨ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªä¸­é—´ä»¶ä¸º TimeoutHandler</strong>ã€‚</p><p>åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªtimeout.goæ–‡ä»¶æ¥å­˜æ”¾è¿™ä¸ªä¸­é—´ä»¶ã€‚</p><pre><code class="language-go">func TimeoutHandler(fun ControllerHandler, d time.Duration) ControllerHandler {
	// ä½¿ç”¨å‡½æ•°å›è°ƒ
	return func(c *Context) error {

		finish := make(chan struct{}, 1)
		panicChan := make(chan interface{}, 1)

		// æ‰§è¡Œä¸šåŠ¡é€»è¾‘å‰é¢„æ“ä½œï¼šåˆå§‹åŒ–è¶…æ—¶ context
		durationCtx, cancel := context.WithTimeout(c.BaseContext(), d)
		defer cancel()

		c.request.WithContext(durationCtx)

		go func() {
			defer func() {
				if p := recover(); p != nil {
					panicChan &lt;- p
				}
			}()
			// æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘
			fun(c)

			finish &lt;- struct{}{}
		}()
		// æ‰§è¡Œä¸šåŠ¡é€»è¾‘åæ“ä½œ
		select {
		case p := &lt;-panicChan:
			log.Println(p)
			c.responseWriter.WriteHeader(500)
		case &lt;-finish:
			fmt.Println("finish")
		case &lt;-durationCtx.Done():
			c.SetHasTimeout()
			c.responseWriter.Write([]byte("time out"))
		}
		return nil
	}
}
</code></pre><p>ä»”ç»†çœ‹ä¸‹è¿™æ®µä»£ç ï¼Œä¸­é—´ä»¶å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œè¿™ä¸ªåŒ¿åå‡½æ•°å®ç°äº†ControllerHandler å‡½æ•°ç»“æ„ï¼Œå‚æ•°ä¸ºContextï¼Œè¿”å›å€¼ä¸ºerrorã€‚</p><p>åœ¨è¿™ä¸ªåŒ¿åå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºäº†ä¸€ä¸ªå®šæ—¶å™¨Contextï¼Œç„¶åå¼€å¯ä¸€ä¸ªGoroutineï¼Œåœ¨Goroutineä¸­æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘ã€‚è¿™ä¸ªGoroutineä¼šåœ¨ä¸šåŠ¡é€»è¾‘æ‰§è¡Œç»“æŸåï¼Œé€šè¿‡ä¸€ä¸ªfinishçš„channelæ¥ä¼ é€’ç»“æŸä¿¡å·ï¼›ä¹Ÿä¼šåœ¨ä¸šåŠ¡å‡ºç°å¼‚å¸¸çš„æ—¶å€™ï¼Œé€šè¿‡panicChanæ¥ä¼ é€’å¼‚å¸¸ä¿¡å·ã€‚</p><p>è€Œåœ¨ä¸šåŠ¡é€»è¾‘ä¹‹å¤–çš„ä¸»Goroutineä¸­ï¼Œä¼šåŒæ—¶è¿›è¡Œå¤šä¸ªä¿¡å·çš„ç›‘å¬æ“ä½œï¼ŒåŒ…æ‹¬ç»“æŸä¿¡å·ã€å¼‚å¸¸ä¿¡å·ã€è¶…æ—¶ä¿¡å·ï¼Œè€—æ—¶æœ€çŸ­çš„ä¿¡å·åˆ°è¾¾åï¼Œè¯·æ±‚ç»“æŸã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†è®¾ç½®ä¸šåŠ¡è¶…æ—¶çš„ä»»åŠ¡ã€‚</p><p>äºæ˜¯åœ¨ä¸šåŠ¡æ–‡ä»¶å¤¹route.goä¸­ï¼Œè·¯ç”±æ³¨å†Œå°±å¯ä»¥ä¿®æ”¹ä¸ºï¼š</p><pre><code class="language-go">// åœ¨æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ UserLoginController ä¹‹å¤–ï¼Œå°è£…ä¸€å±‚ TimeoutHandler
core.Get("/user/login", framework.TimeoutHandler(UserLoginController, time.Second))
</code></pre><p>è¿™ç§å‡½æ•°åµŒå¥—æ–¹å¼ï¼Œè®©ä¸‹å±‚ä¸­é—´ä»¶æ˜¯ä¸Šå±‚ä¸­é—´ä»¶çš„å‚æ•°ï¼Œé€šè¿‡ä¸€å±‚å±‚åµŒå¥—å®ç°äº†ä¸­é—´ä»¶çš„è£…é¥°å™¨æ¨¡å¼ã€‚</p><p>ä½†æ˜¯ä½ å†æƒ³ä¸€æ­¥ï¼Œå°±ä¼šå‘ç°ï¼Œè¿™æ ·å®ç°çš„ä¸­é—´ä»¶æœºåˆ¶æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol>
<li><strong>ä¸­é—´ä»¶æ˜¯å¾ªç¯åµŒå¥—çš„</strong>ï¼Œå½“æœ‰å¤šä¸ªä¸­é—´ä»¶çš„æ—¶å€™ï¼Œæ•´ä¸ªåµŒå¥—é•¿åº¦å°±ä¼šéå¸¸é•¿ï¼Œéå¸¸ä¸ä¼˜é›…çš„ï¼Œæ¯”å¦‚ï¼š</li>
</ol><pre><code class="language-go">TimeoutHandler(LogHandler(recoveryHandler(UserLoginController)))
</code></pre><ol start="2">
<li>åˆšæ‰çš„å®ç°ï¼Œ<strong>åªèƒ½ä¸ºå•ä¸ªä¸šåŠ¡æ§åˆ¶å™¨è®¾ç½®ä¸­é—´ä»¶ï¼Œä¸èƒ½æ‰¹é‡è®¾ç½®</strong>ã€‚ä¸Šä¸€è¯¾æˆ‘ä»¬å¼€å‘çš„è·¯ç”±æ˜¯å…·æœ‰åŒå‰ç¼€åˆ†ç»„åŠŸèƒ½çš„ï¼ˆIGroupï¼‰ï¼Œéœ€è¦æ‰¹é‡ä¸ºæŸä¸ªåˆ†ç»„è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é•¿ã€‚</li>
</ol><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦å¯¹åˆšæ‰å®ç°çš„ç®€å•ä¸­é—´ä»¶ä»£ç åšä¸€äº›æ”¹è¿›ã€‚æ€ä¹ˆåšå‘¢ï¼Ÿ</p><h2>ä½¿ç”¨ pipeline æ€æƒ³æ”¹é€ ä¸­é—´ä»¶</h2><p>ä¸€å±‚å±‚åµŒå¥—ä¸å¥½ç”¨ï¼Œå¦‚æœæˆ‘ä»¬å°†æ¯ä¸ªæ ¸å¿ƒæ§åˆ¶å™¨æ‰€éœ€è¦çš„ä¸­é—´ä»¶ï¼Œä½¿ç”¨ä¸€ä¸ªæ•°ç»„é“¾æ¥ï¼ˆChainï¼‰èµ·æ¥ï¼Œå½¢æˆä¸€æ¡æµæ°´çº¿ï¼ˆPipelineï¼‰ï¼Œå°±èƒ½å®Œç¾è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜äº†ã€‚</p><p>è¯·æ±‚æµçš„æµå‘å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="https://static001.geekbang.org/resource/image/e1/2a/e1aa5937627e46c8b2b21e45426f342a.jpg?wh=1920x915" alt=""></p><p>è¿™ä¸ªPipelineæ¨¡å‹å’Œå‰é¢çš„æ´‹è‘±æ¨¡å‹ä¸ä¸€æ ·çš„ç‚¹åœ¨äºï¼Œ<strong>Middlewareä¸å†ä»¥ä¸‹ä¸€å±‚çš„ControllerHandlerä¸ºå‚æ•°äº†ï¼Œå®ƒåªéœ€è¦è¿”å›æœ‰è‡ªèº«ä¸­é—´ä»¶é€»è¾‘çš„ControllerHandler</strong>ã€‚</p><p>ä¹Ÿå°±æ˜¯åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„timeout.goä¸­ï¼Œæˆ‘ä»¬å°†Middlewareçš„å½¢å¼ä»åˆšæ‰çš„ï¼š</p><pre><code class="language-go">func TimeoutHandler(fun ControllerHandler, d time.Duration) ControllerHandler {
	// ä½¿ç”¨å‡½æ•°å›è°ƒ
	return func(c *Context) error {
   //...
    }
}
</code></pre><p>å˜æˆè¿™æ ·ï¼š</p><pre><code class="language-go">// è¶…æ—¶æ§åˆ¶å™¨å‚æ•°ä¸­ControllerHandlerç»“æ„å·²ç»å»æ‰
func Timeout(d time.Duration) framework.ControllerHandler {
	// ä½¿ç”¨å‡½æ•°å›è°ƒ
	return func(c *framework.Context) error {
      //...
    }
}
</code></pre><p>ä½†æ˜¯åœ¨ä¸­é—´ä»¶æ³¨å†Œçš„å›è°ƒå‡½æ•°ä¸­ï¼Œå¦‚ä½•è°ƒç”¨ä¸‹ä¸€ä¸ªControllerHandlerå‘¢ï¼Ÿåœ¨å›è°ƒå‡½æ•°ä¸­ï¼Œåªæœ‰framework.Context è¿™ä¸ªæ•°æ®ç»“æ„ä½œä¸ºå‚æ•°ã€‚</p><p>æ‰€ä»¥å°±éœ€è¦æˆ‘ä»¬åœ¨Contextè¿™ä¸ªæ•°æ®ç»“æ„ä¸­æƒ³ä¸€äº›åŠæ³•äº†ã€‚å›é¡¾ä¸‹ç›®å‰æœ‰çš„æ•°æ®ç»“æ„ï¼šCoreã€Contextã€Treeã€Nodeã€Groupã€‚<img src="https://static001.geekbang.org/resource/image/8e/7b/8ef582e74e9c5ca1c0f54e7c1d75a67b.jpg?wh=1920x1277" alt=""></p><p>å®ƒä»¬åŸºæœ¬ä¸Šéƒ½æ˜¯ä»¥ Core ä¸ºä¸­å¿ƒï¼Œåœ¨ Core ä¸­è®¾ç½®è·¯ç”± routerï¼Œå®ç°äº† Tree ç»“æ„ï¼Œåœ¨ Tree ç»“æ„ä¸­åŒ…å«è·¯ç”±èŠ‚ç‚¹ nodeï¼›åœ¨æ³¨å†Œè·¯ç”±çš„æ—¶å€™ï¼Œå°†å¯¹åº”çš„ä¸šåŠ¡æ ¸å¿ƒå¤„ç†é€»è¾‘ handler ï¼Œæ”¾åœ¨ node ç»“æ„çš„ handler å±æ€§ä¸­ã€‚</p><p>è€Œ Core ä¸­çš„ ServeHttp æ–¹æ³•ä¼šåˆ›å»º Context æ•°æ®ç»“æ„ï¼Œç„¶åServeHttpæ–¹æ³•å†æ ¹æ® Request-URI æŸ¥æ‰¾æŒ‡å®š nodeï¼Œå¹¶ä¸”å°† Context ç»“æ„å’Œ node ä¸­çš„æ§åˆ¶å™¨ ControllerHandler ç»“åˆèµ·æ¥æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘ã€‚</p><p>ç»“æ„éƒ½æ¢³ç†æ¸…æ¥šäº†ï¼Œæ€ä¹ˆæ”¹é€ æˆæµæ°´çº¿å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥<strong>å°†æ¯ä¸ªä¸­é—´ä»¶æ„é€ å‡ºæ¥çš„ ControllerHandler å’Œæœ€ç»ˆçš„ä¸šåŠ¡é€»è¾‘çš„ ControllerHandler ç»“åˆåœ¨ä¸€èµ·</strong>ï¼Œæˆä¸ºä¸€ä¸ª ControllerHandler æ•°ç»„ï¼Œä¹Ÿå°±æ˜¯æ§åˆ¶å™¨é“¾ã€‚åœ¨æœ€ç»ˆæ‰§è¡Œä¸šåŠ¡ä»£ç çš„æ—¶å€™ï¼Œèƒ½ä¸€ä¸ªä¸ªè°ƒç”¨æ§åˆ¶å™¨é“¾è·¯ä¸Šçš„æ§åˆ¶å™¨ã€‚</p><p>è¿™ä¸ªæƒ³æ³•å…¶å®æ˜¯éå¸¸è‡ªç„¶çš„ï¼Œå› ä¸ºä¸­é—´ä»¶ä¸­åˆ›é€ å‡ºæ¥çš„ControllerHandleråŒ¿åå‡½æ•°ï¼Œå’Œæœ€ç»ˆçš„æ§åˆ¶å™¨ä¸šåŠ¡é€»è¾‘ControllerHandlerï¼Œéƒ½æ˜¯<strong>åŒæ ·çš„ç»“æ„</strong>ï¼Œ<strong>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€‰ç”¨Controllerhanderçš„æ•°ç»„ï¼Œæ¥è¡¨ç¤ºæŸä¸ªè·¯ç”±çš„ä¸šåŠ¡é€»è¾‘</strong>ã€‚</p><p>å¯¹åº”åˆ°ä»£ç ä¸Šï¼Œæˆ‘ä»¬å…ˆææ¸…æ¥šä½¿ç”¨é“¾è·¯çš„æ–¹å¼ï¼Œå†çœ‹å¦‚ä½•æ³¨å†Œå’Œæ„é€ é“¾è·¯ã€‚</p><h3>å¦‚ä½•ä½¿ç”¨æ§åˆ¶å™¨é“¾è·¯</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬ç ”ç©¶ä¸‹å¦‚ä½•ä½¿ç”¨è¿™ä¸ªæ§åˆ¶å™¨é“¾è·¯ï¼Œå³å›¾ä¸­å³è¾¹éƒ¨åˆ†çš„æ”¹é€ ã€‚<br>
<img src="https://static001.geekbang.org/resource/image/49/c8/49c2d50b26d48e338c3acd2e1374f4c8.jpg?wh=1920x1277" alt=""></p><p>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹è·¯ç”±èŠ‚ç‚¹nodeã€‚</p><p>åœ¨nodeèŠ‚ç‚¹ä¸­å°†åŸå…ˆçš„Handlerï¼Œæ›¿æ¢ä¸ºæ§åˆ¶å™¨é“¾è·¯Handlersã€‚è¿™æ ·åœ¨å¯»æ‰¾è·¯ç”±èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå°±èƒ½æ‰¾åˆ°å¯¹åº”çš„æ§åˆ¶å™¨é“¾è·¯äº†ã€‚ä¿®æ”¹æ¡†æ¶æ–‡ä»¶å¤¹ä¸­å­˜æ”¾trieæ ‘çš„trie.goæ–‡ä»¶ï¼š</p><pre><code class="language-go">// ä»£è¡¨èŠ‚ç‚¹
type node struct {
	...
	handlers []ControllerHandler // ä¸­é—´ä»¶+æ§åˆ¶å™¨ 
    ...
}

</code></pre><p>ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬ä¿®æ”¹Contextç»“æ„ã€‚</p><p>ç”±äºæˆ‘ä»¬ä¸Šæ–‡æåˆ°ï¼Œåœ¨ä¸­é—´ä»¶æ³¨å†Œçš„å›è°ƒå‡½æ•°ä¸­ï¼Œåªæœ‰framework.Context è¿™ä¸ªæ•°æ®ç»“æ„ä½œä¸ºå‚æ•°ï¼Œæ‰€ä»¥åœ¨Contextä¸­ä¹Ÿéœ€è¦ä¿å­˜è¿™ä¸ªæ§åˆ¶å™¨é“¾è·¯(handlers)ï¼Œå¹¶ä¸”è¦è®°å½•ä¸‹å½“å‰æ‰§è¡Œåˆ°äº†å“ªä¸ªæ§åˆ¶å™¨ï¼ˆindexï¼‰ã€‚ä¿®æ”¹æ¡†æ¶æ–‡ä»¶å¤¹çš„context.goæ–‡ä»¶ï¼š</p><pre><code class="language-go">// Contextä»£è¡¨å½“å‰è¯·æ±‚ä¸Šä¸‹æ–‡
type Context struct {
	...

	// å½“å‰è¯·æ±‚çš„handleré“¾æ¡
	handlers []ControllerHandler
	index&nbsp; &nbsp; int // å½“å‰è¯·æ±‚è°ƒç”¨åˆ°è°ƒç”¨é“¾çš„å“ªä¸ªèŠ‚ç‚¹
}
</code></pre><p>ç¬¬ä¸‰æ­¥ï¼Œæ¥å®ç°é“¾æ¡è°ƒç”¨æ–¹å¼ã€‚</p><p>ä¸ºäº†æ§åˆ¶å®ç°é“¾æ¡çš„é€æ­¥è°ƒç”¨ï¼Œæˆ‘ä»¬ä¸ºContextå®ç°ä¸€ä¸ªNextæ–¹æ³•ã€‚è¿™ä¸ªNextæ–¹æ³•æ¯è°ƒç”¨ä¸€æ¬¡ï¼Œå°±å°†è¿™ä¸ªæ§åˆ¶å™¨é“¾è·¯çš„è°ƒç”¨æ§åˆ¶å™¨ï¼Œå¾€åç§»åŠ¨ä¸€æ­¥ã€‚ç»§ç»­åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„context.goæ–‡ä»¶é‡Œå†™ï¼š</p><pre><code class="language-go">// æ ¸å¿ƒå‡½æ•°ï¼Œè°ƒç”¨contextçš„ä¸‹ä¸€ä¸ªå‡½æ•°
func (ctx *Context) Next() error {
	ctx.index++
	if ctx.index &lt; len(ctx.handlers) {
		if err := ctx.handlers[ctx.index](ctx); err != nil {
			return err
		}
	}
	return nil
}
</code></pre><p>è¿™é‡Œæˆ‘å†å•°å—¦ä¸€ä¸‹ï¼ŒNext() å‡½æ•°æ˜¯æ•´ä¸ªé“¾è·¯æ‰§è¡Œçš„é‡ç‚¹ï¼Œè¦å¥½å¥½ç†è§£ï¼Œå®ƒé€šè¿‡ç»´æŠ¤Contextä¸­çš„ä¸€ä¸ªä¸‹æ ‡ï¼Œæ¥æ§åˆ¶é“¾è·¯ç§»åŠ¨ï¼Œè¿™ä¸ªä¸‹æ ‡è¡¨ç¤ºå½“å‰è°ƒç”¨Nextè¦æ‰§è¡Œçš„æ§åˆ¶å™¨åºåˆ—ã€‚</p><p>Next() å‡½æ•°ä¼šåœ¨æ¡†æ¶çš„ä¸¤ä¸ªåœ°æ–¹è¢«è°ƒç”¨ï¼š</p><ul>
<li>ç¬¬ä¸€ä¸ªæ˜¯åœ¨æ­¤æ¬¡è¯·æ±‚å¤„ç†çš„å…¥å£å¤„ï¼Œå³Coreçš„ServeHttpï¼›</li>
<li>ç¬¬äºŒä¸ªæ˜¯åœ¨æ¯ä¸ªä¸­é—´ä»¶çš„é€»è¾‘ä»£ç ä¸­ï¼Œç”¨äºè°ƒç”¨ä¸‹ä¸ªä¸­é—´ä»¶ã€‚<br>
<img src="https://static001.geekbang.org/resource/image/73/3c/73a80752cf6d94b90febd2e23e80bc3c.jpg?wh=1920x915" alt=""></li>
</ul><p>è¿™é‡Œè¦æ³¨æ„ï¼Œindexä¸‹æ ‡è¡¨ç¤ºå½“å‰è°ƒç”¨Nextè¦æ‰§è¡Œçš„æ§åˆ¶å™¨åºåˆ—ï¼Œå®ƒçš„<strong>åˆå§‹å€¼åº”è¯¥ä¸º-1ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šè‡ªå¢1</strong>ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™indexä¸º0ï¼Œå®šä½åˆ°æ§åˆ¶å™¨é“¾æ¡çš„ä¸‹æ ‡ä¸º0çš„æ§åˆ¶å™¨ï¼Œå³ç¬¬ä¸€ä¸ªæ§åˆ¶å™¨ã€‚</p><p>åœ¨æ¡†æ¶æ–‡ä»¶å¤¹context.goçš„åˆå§‹åŒ–Contextå‡½æ•°ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="language-go">// NewContext åˆå§‹åŒ–ä¸€ä¸ªContext
func NewContext(r *http.Request, w http.ResponseWriter) *Context {
	return &amp;Context{
		...
		index:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -1,
	}
}
</code></pre><p>è¢«è°ƒç”¨çš„ç¬¬ä¸€ä¸ªåœ°æ–¹ï¼Œåœ¨å…¥å£å¤„è°ƒç”¨çš„ä»£ç ï¼Œå†™åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„core.goæ–‡ä»¶ä¸­ï¼š</p><pre><code class="language-go">// æ‰€æœ‰è¯·æ±‚éƒ½è¿›å…¥è¿™ä¸ªå‡½æ•°, è¿™ä¸ªå‡½æ•°è´Ÿè´£è·¯ç”±åˆ†å‘
func (c *Core) ServeHTTP(response http.ResponseWriter, request *http.Request) {

	// å°è£…è‡ªå®šä¹‰context
	ctx := NewContext(request, response)

	// å¯»æ‰¾è·¯ç”±
	handlers := c.FindRouteByRequest(request)
	if handlers == nil {
		// å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè¿™é‡Œæ‰“å°æ—¥å¿—
		ctx.Json(404, "not found")
		return
	}

    // è®¾ç½®contextä¸­çš„handlerså­—æ®µ
	ctx.SetHandlers(handlers)

	// è°ƒç”¨è·¯ç”±å‡½æ•°ï¼Œå¦‚æœè¿”å›err ä»£è¡¨å­˜åœ¨å†…éƒ¨é”™è¯¯ï¼Œè¿”å›500çŠ¶æ€ç 
	if err := ctx.Next(); err != nil {
		ctx.Json(500, "inner error")
		return
	}
}
</code></pre><p>è¢«è°ƒç”¨çš„ç¬¬äºŒä¸ªä½ç½®åœ¨ä¸­é—´ä»¶ä¸­ï¼Œæ¯ä¸ªä¸­é—´ä»¶éƒ½é€šè¿‡è°ƒç”¨ context.Next æ¥è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­åˆ›å»ºmiddlewareç›®å½•ï¼Œå…¶ä¸­åˆ›å»ºä¸€ä¸ªtest.goå­˜æ”¾æˆ‘ä»¬çš„æµ‹è¯•ä¸­é—´ä»¶ï¼š</p><pre><code class="language-go">func Test1() framework.ControllerHandler {
	// ä½¿ç”¨å‡½æ•°å›è°ƒ
	return func(c *framework.Context) error {
		fmt.Println("middleware pre test1")
		c.Next()  // è°ƒç”¨Nextå¾€ä¸‹è°ƒç”¨ï¼Œä¼šè‡ªå¢contxt.index
		fmt.Println("middleware post test1")
		return nil
	}
}

func Test2() framework.ControllerHandler {
	// ä½¿ç”¨å‡½æ•°å›è°ƒ
	return func(c *framework.Context) error {
		fmt.Println("middleware pre test2")
		c.Next() // è°ƒç”¨Nextå¾€ä¸‹è°ƒç”¨ï¼Œä¼šè‡ªå¢contxt.index
		fmt.Println("middleware post test2")
		return nil
	}
}

</code></pre><h3>å¦‚ä½•æ³¨å†Œæ§åˆ¶å™¨é“¾è·¯</h3><p>å¦‚ä½•ä½¿ç”¨æ§åˆ¶å™¨é“¾è·¯ï¼Œæˆ‘ä»¬å°±è®²å®Œäº†ï¼Œå†çœ‹æ§åˆ¶å™¨é“¾è·¯å¦‚ä½•æ³¨å†Œï¼Œå°±æ˜¯ä¹‹å‰UMLå›¾çš„å·¦è¾¹éƒ¨åˆ†ã€‚<img src="https://static001.geekbang.org/resource/image/3c/b5/3c2012fcfcabcfc0159e4ecec2fdb8b5.jpg?wh=1920x1277" alt=""></p><p>å¾ˆæ˜æ˜¾ï¼Œç°æœ‰çš„å‡½æ•°æ²¡æœ‰åŒ…å«æ³¨å†Œä¸­é—´ä»¶é€»è¾‘ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸ºGroupå’ŒCoreä¸¤ä¸ªç»“æ„å¢åŠ æ³¨å†Œä¸­é—´ä»¶å…¥å£ï¼Œè¦è®¾è®¡ä¸¤ä¸ªåœ°æ–¹ï¼š</p><ul>
<li>Coreå’ŒGroupå•ç‹¬è®¾è®¡ä¸€ä¸ªUseå‡½æ•°ï¼Œä¸ºå…¶æ•°æ®ç»“æ„è´Ÿè´£çš„è·¯ç”±æ‰¹é‡è®¾ç½®ä¸­é—´ä»¶</li>
<li>ä¸ºCoreå’ŒGroupæ³¨å†Œå•ä¸ªè·¯ç”±çš„ Get / Post / Put / Delete å‡½æ•°ï¼Œè®¾ç½®ä¸­é—´ä»¶</li>
</ul><p>å…ˆçœ‹ä¸‹æ‰¹é‡è®¾ç½®ä¸­é—´ä»¶çš„Useå‡½æ•°ï¼Œæˆ‘ä»¬åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„core.goä¿®æ”¹ï¼š</p><pre><code class="language-go">// æ³¨å†Œä¸­é—´ä»¶
func (c *Core) Use(middlewares ...ControllerHandler) {
   c.middlewares = append(c.middlewares, middlewares...)
}
</code></pre><p>å’Œæ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„group.goä¸­ä¿®æ”¹ï¼š</p><pre><code class="language-go">// æ³¨å†Œä¸­é—´ä»¶
func (g *Group) Use(middlewares ...ControllerHandler) {
   g.middlewares = append(g.middlewares, middlewares...)
}
</code></pre><p>æ³¨æ„ä¸‹è¿™é‡Œçš„å‚æ•°ï¼Œä½¿ç”¨çš„æ˜¯Golangçš„å¯å˜å‚æ•°ï¼Œ<strong>è¿™ä¸ªå¯å˜å‚æ•°ä»£è¡¨ï¼Œæˆ‘å¯ä»¥ä¼ é€’0ï½nä¸ªControllerHandlerç±»å‹çš„å‚æ•°</strong>ï¼Œè¿™ä¸ªè®¾è®¡ä¼šå¢åŠ å‡½æ•°çš„æ˜“ç”¨æ€§ã€‚å®ƒåœ¨ä¸šåŠ¡æ–‡ä»¶å¤¹ä¸­ä½¿ç”¨èµ·æ¥çš„å½¢å¼æ˜¯è¿™æ ·çš„ï¼Œåœ¨main.goä¸­ï¼š</p><pre><code class="language-go">// coreä¸­ä½¿ç”¨useæ³¨å†Œä¸­é—´ä»¶
core.Use(
		middleware.Test1(),
		middleware.Test2())

// groupä¸­ä½¿ç”¨useæ³¨å†Œä¸­é—´ä»¶
subjectApi := core.Group("/subject")
subjectApi.Use(middleware.Test3())
</code></pre><p>å†çœ‹å•ä¸ªè·¯ç”±è®¾ç½®ä¸­é—´ä»¶çš„å‡½æ•°ï¼Œæˆ‘ä»¬ä¹Ÿä½¿ç”¨å¯å˜å‚æ•°ï¼Œæ”¹é€ æ³¨å†Œè·¯ç”±çš„å‡½æ•°ï¼ˆGet /Post /Delete /Putï¼‰ï¼Œç»§ç»­åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„core.goé‡Œä¿®æ”¹ï¼š</p><pre><code class="language-go">// Coreçš„Getæ–¹æ³•è¿›è¡Œæ”¹é€ 
func (c *Core) Get(url string, handlers ...ControllerHandler) {
	// å°†coreçš„middleware å’Œ handlersç»“åˆèµ·æ¥
	allHandlers := append(c.middlewares, handlers...)
	if err := c.router["GET"].AddRouter(url, allHandlers); err != nil {
		log.Fatal("add router error: ", err)
	}
}
... 
</code></pre><p>åŒæ—¶ä¿®æ”¹æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„group.goï¼š</p><pre><code class="language-go">// æ”¹é€ IGroup çš„æ‰€æœ‰æ–¹æ³•
type IGroup interface {
	// å®ç°HttpMethodæ–¹æ³•
	Get(string, ...ControllerHandler)
	Post(string, ...ControllerHandler)
	Put(string, ...ControllerHandler)
	Delete(string, ...ControllerHandler)
    //..
}

// æ”¹é€ Groupçš„Getæ–¹æ³•
func (g *Group) Get(uri string, handlers ...ControllerHandler) {
	uri = g.getAbsolutePrefix() + uri
	allHandlers := append(g.getMiddlewares(), handlers...)
	g.core.Get(uri, allHandlers...)
}

...
</code></pre><p>è¿™æ ·ï¼Œå›åˆ°ä¸šåŠ¡æ–‡ä»¶å¤¹ä¸­çš„router.goï¼Œæˆ‘ä»¬æ³¨å†Œè·¯ç”±çš„ä½¿ç”¨æ–¹æ³•å°±å¯ä»¥å˜æˆå¦‚ä¸‹å½¢å¼ï¼š</p><pre><code class="language-go">// æ³¨å†Œè·¯ç”±è§„åˆ™
func registerRouter(core *framework.Core) {
	// åœ¨coreä¸­ä½¿ç”¨middleware.Test3() ä¸ºå•ä¸ªè·¯ç”±å¢åŠ ä¸­é—´ä»¶
	core.Get("/user/login", middleware.Test3(), UserLoginController)

	// æ‰¹é‡é€šç”¨å‰ç¼€
	subjectApi := core.Group("/subject")
	{
        ...
        // åœ¨groupä¸­ä½¿ç”¨middleware.Test3() ä¸ºå•ä¸ªè·¯ç”±å¢åŠ ä¸­é—´ä»¶
		subjectApi.Get("/:id", middleware.Test3(), SubjectGetController)
	}
}
</code></pre><p>ä¸ç®¡æ˜¯é€šè¿‡æ‰¹é‡æ³¨å†Œä¸­é—´ä»¶ï¼Œè¿˜æ˜¯å•ä¸ªæ³¨å†Œä¸­é—´ä»¶ï¼Œæœ€ç»ˆéƒ½è¦æ±‡æ€»åˆ°è·¯ç”±èŠ‚ç‚¹nodeä¸­ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è°ƒç”¨äº†ä¸Šä¸€èŠ‚è¯¾æœ€ç»ˆå¢åŠ è·¯ç”±çš„å‡½æ•°Tree.AddRouterï¼ŒæŠŠå°†è¿™ä¸ªè¯·æ±‚å¯¹åº”çš„Coreç»“æ„é‡Œçš„ä¸­é—´ä»¶å’ŒGroupç»“æ„é‡Œçš„ä¸­é—´ä»¶ï¼Œéƒ½èšåˆèµ·æ¥ï¼Œæˆä¸ºæœ€ç»ˆè·¯ç”±èŠ‚ç‚¹çš„ä¸­é—´ä»¶ã€‚</p><p>èšåˆçš„é€»è¾‘åœ¨group.goå’Œcore.goä¸­éƒ½æœ‰ï¼Œå®é™…ä¸Šå°±æ˜¯<strong>å°†Handlerå’ŒMiddlewareä¸€èµ·æ”¾åœ¨ä¸€ä¸ªæ•°ç»„ä¸­</strong>ã€‚</p><pre><code class="language-go">// è·å–æŸä¸ªgroupçš„middleware
// è¿™é‡Œå°±æ˜¯è·å–é™¤äº†Get/Post/Put/Deleteä¹‹å¤–è®¾ç½®çš„middleware
func (g *Group) getMiddlewares() []ControllerHandler {
	if g.parent == nil {
		return g.middlewares
	}

	return append(g.parent.getMiddlewares(), g.middlewares...)
}

// å®ç°Getæ–¹æ³•
func (g *Group) Get(uri string, handlers ...ControllerHandler) {
	uri = g.getAbsolutePrefix() + uri
	allHandlers := append(g.getMiddlewares(), handlers...)
	g.core.Get(uri, allHandlers...)
}
</code></pre><p>åœ¨core.goæ–‡ä»¶å¤¹é‡Œå†™ï¼š</p><pre><code class="language-go">// åŒ¹é…GET æ–¹æ³•, å¢åŠ è·¯ç”±è§„åˆ™
func (c *Core) Get(url string, handlers ...ControllerHandler) {
	// å°†coreçš„middleware å’Œ handlersç»“åˆèµ·æ¥
	allHandlers := append(c.middlewares, handlers...)
	if err := c.router["GET"].AddRouter(url, allHandlers); err != nil {
		log.Fatal("add router error: ", err)
	}
}

</code></pre><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ pipeline æ€æƒ³å¯¹ä¸­é—´ä»¶çš„æ”¹é€ å°±å®Œæˆäº†, æœ€ç»ˆçš„UMLç±»å›¾å¦‚ä¸‹ï¼š<br>
<img src="https://static001.geekbang.org/resource/image/7f/ab/7f26e60d79ec987dba10a1b5045aa2ab.jpg?wh=1920x1277" alt=""></p><p>è®©æˆ‘ä»¬ç®€è¦å›é¡¾ä¸‹æ”¹é€ è¿‡ç¨‹ã€‚</p><p>ç¬¬ä¸€æ­¥ä½¿ç”¨æ§åˆ¶å™¨é“¾è·¯ï¼Œæˆ‘ä»¬<strong>æ”¹é€ äº†nodeå’ŒContextä¸¤ä¸ªæ•°æ®ç»“æ„</strong>ã€‚ä¸ºnodeå¢åŠ äº†handlersï¼Œå­˜æ”¾è¿™ä¸ªè·¯ç”±æ³¨å†Œçš„æ‰€æœ‰ä¸­é—´ä»¶ï¼›Contextä¹Ÿå¢åŠ äº†handlersï¼Œåœ¨Core.ServeHttpçš„å‡½æ•°ä¸­ï¼Œåˆ›å»ºContextç»“æ„ï¼Œå¯»æ‰¾åˆ°è¯·æ±‚å¯¹åº”çš„è·¯ç”±èŠ‚ç‚¹ï¼Œç„¶åæŠŠè·¯ç”±èŠ‚ç‚¹çš„handlersæ•°ç»„ï¼Œå¤åˆ¶åˆ°Contextä¸­çš„handlersã€‚</p><p>ä¸ºäº†å®ç°çœŸæ­£çš„é“¾è·¯è°ƒç”¨ï¼Œéœ€è¦åœ¨æ¡†æ¶çš„<strong>ä¸¤ä¸ªåœ°æ–¹è°ƒç”¨Context.Next() æ–¹æ³•</strong>ï¼Œä¸€ä¸ªæ˜¯å¯åŠ¨ä¸šåŠ¡é€»è¾‘çš„åœ°æ–¹ï¼Œä¸€ä¸ªæ˜¯æ¯ä¸ªä¸­é—´ä»¶çš„è°ƒç”¨ã€‚</p><p>ç¬¬äºŒæ­¥å¦‚ä½•æ³¨å†Œæ§åˆ¶å™¨é“¾è·¯ï¼Œæˆ‘ä»¬<strong>æ”¹é€ äº†Groupå’ŒCoreä¸¤ä¸ªæ•°æ®ç»“æ„ï¼Œä¸ºå®ƒä»¬å¢åŠ äº†æ³¨å†Œä¸­é—´ä»¶çš„å…¥å£</strong>ï¼Œä¸€å¤„æ˜¯æ‰¹é‡å¢åŠ ä¸­é—´ä»¶å‡½æ•°Useï¼Œä¸€å¤„æ˜¯åœ¨æ³¨å†Œå•ä¸ªè·¯ç”±çš„Get / Post / Delete / Putæ–¹æ³•ä¸­ï¼Œä¸ºå•ä¸ªè·¯ç”±è®¾ç½®ä¸­é—´ä»¶ã€‚åœ¨è®¾è®¡å…¥å£çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†å¯å˜å‚æ•°çš„è®¾è®¡ï¼Œæé«˜æ³¨å†Œå…¥å£çš„å¯ç”¨æ€§ã€‚</p><h2>åŸºæœ¬çš„ä¸­é—´ä»¶: Recovery</h2><p>æˆ‘ä»¬ç°åœ¨å·²ç»å°†ä¸­é—´ä»¶æœºåˆ¶æ­å»ºå¹¶è¿è¡Œèµ·æ¥äº†ï¼Œ ä½†æ˜¯å…·ä½“éœ€è¦å®ç°å“ªäº›ä¸­é—´ä»¶å‘¢ï¼Ÿè¿™è¦æ ¹æ®ä¸åŒéœ€æ±‚è¿›è¡Œä¸åŒçš„ç ”å‘ï¼Œæ˜¯ä¸ªé•¿æœŸè¯é¢˜ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬æ¼”ç¤ºä¸€ä¸ªæœ€åŸºæœ¬çš„ä¸­é—´ä»¶ï¼šRecoveryã€‚</p><p>ä¸­é—´ä»¶é‚£ä¹ˆå¤šï¼Œæ¯”å¦‚è¶…æ—¶ä¸­é—´ä»¶ã€ç»Ÿè®¡ä¸­é—´ä»¶ã€æ—¥å¿—ä¸­é—´ä»¶ï¼Œä¸ºä»€ä¹ˆæˆ‘è¯´Recoveryæ˜¯æœ€åŸºæœ¬çš„å‘¢ï¼Ÿç»™å‡ºæˆ‘çš„æƒ³æ³•ä¹‹å‰ï¼Œä½ å¯ä»¥å…ˆæ€è€ƒè¿™ä¸ªé—®é¢˜ï¼šåœ¨ç¼–å†™ä¸šåŠ¡æ ¸å¿ƒé€»è¾‘çš„æ—¶å€™ï¼Œå¦‚æœå‡ºç°äº†ä¸€ä¸ªpanicï¼Œè€Œä¸”åœ¨ä¸šåŠ¡æ ¸å¿ƒé€»è¾‘å‡½æ•°ä¸­æœªæ•è·å¤„ç†ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p><p>æˆ‘ä»¬è¿˜æ˜¯åŸºäºç¬¬ä¸€èŠ‚è¯¾è®²çš„net/httpçš„ä¸»æµç¨‹é€»è¾‘æ¥æ€è€ƒï¼Œå…³é”®ç»“è®ºæœ‰ä¸€ç‚¹æ˜¯ï¼Œ<strong>æ¯ä¸ªHTTPè¿æ¥éƒ½ä¼šå¼€å¯ä¸€ä¸ªGoroutineä¸ºå…¶æœåŠ¡</strong>ï¼Œæ‰€ä»¥å¾ˆæ˜æ˜¾ï¼Œ net/http çš„è¿›ç¨‹æ¨¡å‹æ˜¯å•è¿›ç¨‹ã€å¤šåç¨‹ã€‚<img src="https://static001.geekbang.org/resource/image/0f/ee/0fa86b64b6d1b1e96560420243ec6aee.jpg?wh=1920x1133" alt=""></p><p>åœ¨Golangçš„è¿™ç§æ¨¡å‹ä¸­ï¼Œæ¯ä¸ªåç¨‹æ˜¯ç‹¬ç«‹ä¸”å¹³ç­‰çš„ï¼Œå³ä½¿æ˜¯åˆ›å»ºå­åç¨‹çš„çˆ¶åç¨‹ï¼Œåœ¨Goroutine ä¸­ä¹Ÿæ— æ³•ç®¡ç†å­åç¨‹ã€‚æ‰€ä»¥ï¼Œ<strong>æ¯ä¸ªåç¨‹éœ€è¦è‡ªå·±ä¿è¯ä¸ä¼šå¤–æŠ›panic</strong>ï¼Œä¸€æ—¦å¤–æŠ›panicäº†ï¼Œæ•´ä¸ªè¿›ç¨‹å°±è®¤ä¸ºå‡ºç°å¼‚å¸¸ï¼Œä¼šç»ˆæ­¢è¿›ç¨‹ã€‚</p><p>è¿™ä¸€ç‚¹ææ¸…æ¥šäº†ï¼Œå†çœ‹Recoveryä¸ºä»€ä¹ˆå¿…å¤‡å°±å¾ˆç®€å•ã€‚åœ¨net/httpå¤„ç†ä¸šåŠ¡é€»è¾‘çš„åç¨‹ä¸­ï¼Œè¦æ•è·åœ¨è‡ªå·±è¿™ä¸ªåç¨‹ä¸­æŠ›å‡ºçš„panicï¼Œå°±å¿…é¡»è‡ªå·±å®ç° Recovery æœºåˆ¶ã€‚</p><p>è€ŒRecoveryä¸­é—´ä»¶å°±æ˜¯ç”¨æ¥ä¸ºæ¯ä¸ªåç¨‹å¢åŠ Recoveryæœºåˆ¶çš„ã€‚æˆ‘ä»¬åœ¨æ¡†æ¶çš„middlewareæ–‡ä»¶å¤¹ä¸­å¢åŠ recovery.goå­˜æ”¾è¿™ä¸ªä¸­é—´ä»¶ï¼š</p><pre><code class="language-go">// recoveryæœºåˆ¶ï¼Œå°†åç¨‹ä¸­çš„å‡½æ•°å¼‚å¸¸è¿›è¡Œæ•è·
func Recovery() framework.ControllerHandler {
	// ä½¿ç”¨å‡½æ•°å›è°ƒ
	return func(c *framework.Context) error {
		// æ ¸å¿ƒåœ¨å¢åŠ è¿™ä¸ªrecoveræœºåˆ¶ï¼Œæ•è·c.Next()å‡ºç°çš„panic
		defer func() {
			if err := recover(); err != nil {
				c.Json(500, err)
			}
		}()
		// ä½¿ç”¨nextæ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘
		c.Next()

		return nil
	}
}
</code></pre><p>è¿™ä¸ªä¸­é—´ä»¶å°±æ˜¯åœ¨context.Next() ä¹‹å‰è®¾ç½®äº†defer å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯æ•è·c.Next()ä¸­æŠ›å‡ºçš„å¼‚å¸¸panicã€‚ä¹‹ååœ¨ä¸šåŠ¡æ–‡ä»¶å¤¹ä¸­çš„main.goï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡Coreç»“æ„çš„Useæ–¹æ³•ï¼Œå¯¹æ‰€æœ‰çš„è·¯ç”±éƒ½è®¾ç½®è¿™ä¸ªä¸­é—´ä»¶ã€‚</p><pre><code class="language-go">core.Use(middleware.Recovery())
</code></pre><p>ä»Šå¤©æ‰€æœ‰ä»£ç çš„ç›®å½•ç»“æ„æˆªå›¾ï¼Œæˆ‘ä¹Ÿè´´åœ¨è¿™é‡Œä¾›ä½ å¯¹æ¯”æ£€æŸ¥ï¼Œä»£ç æ”¾åœ¨GitHubä¸Šçš„ <a href="https://github.com/gohade/coredemo/tree/geekbang/04/framework">04åˆ†æ”¯</a>é‡Œã€‚<br>
<img src="https://static001.geekbang.org/resource/image/b8/yy/b8a053e4650ec9560754383d0f3974yy.png?wh=784x1274" alt=""></p><h2>å°ç»“</h2><p>ä»Šå¤©æˆ‘ä»¬æœ€ç»ˆä¸ºè‡ªå·±çš„æ¡†æ¶å¢åŠ äº†ä¸­é—´ä»¶æœºåˆ¶ã€‚ä¸­é—´ä»¶æœºåˆ¶çš„æœ¬è´¨å°±æ˜¯è£…é¥°å™¨æ¨¡å‹ï¼Œå¯¹æ ¸å¿ƒçš„é€»è¾‘å‡½æ•°è¿›è¡Œè£…é¥°ã€å°è£…ï¼Œæ‰€ä»¥ä¸€å¼€å§‹æˆ‘ä»¬å°±ä½¿ç”¨å‡½æ•°åµŒå¥—çš„æ–¹å¼å®ç°äº†ä¸­é—´ä»¶æœºåˆ¶ã€‚</p><p>ä½†æ˜¯å®ç°ä¹‹åï¼Œæˆ‘ä»¬å‘ç°å‡½æ•°åµŒå¥—çš„å¼Šç«¯ï¼šä¸€æ˜¯ä¸ä¼˜é›…ï¼ŒäºŒæ˜¯æ— æ³•æ‰¹é‡è®¾ç½®ä¸­é—´ä»¶ã€‚æ‰€ä»¥æˆ‘ä»¬<strong>å¼•å…¥äº†pipelineçš„æ€æƒ³ï¼Œå°†æ‰€æœ‰ä¸­é—´ä»¶åšæˆä¸€ä¸ªé“¾æ¡ï¼Œé€šè¿‡è¿™ä¸ªé“¾æ¡çš„è°ƒç”¨ï¼Œæ¥å®ç°ä¸­é—´ä»¶æœºåˆ¶</strong>ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬é€‰äº†æœ€åŸºç¡€çš„Recoveryä¸­é—´ä»¶æ¼”ç¤ºå¦‚ä½•å…·ä½“å®ç°ï¼Œä¸€æ–¹é¢ä½œä¸ºä¸­é—´ä»¶æœºåˆ¶çš„ç¤ºä¾‹ï¼Œå¦ä¸€æ–¹é¢ï¼Œä¹Ÿåœ¨åŠŸèƒ½ä¸Šä¸ºæˆ‘ä»¬çš„æ¡†æ¶å¢å¼ºäº†å¥å£®æ€§ã€‚</p><p>ä¸­é—´ä»¶æœºåˆ¶æ˜¯æˆ‘ä»¬å¿…é¡»è¦æŒæ¡çš„æœºåˆ¶ï¼Œå¾ˆå¤šWebæ¡†æ¶ä¸­éƒ½æœ‰è¿™ä¸ªé€»è¾‘ã€‚<strong>åœ¨æ¶æ„å±‚é¢ï¼Œä¸­é—´ä»¶æœºåˆ¶å°±ç›¸å½“äºï¼Œåœ¨æ¯ä¸ªè¯·æ±‚çš„æ¨ªåˆ‡é¢ç»Ÿä¸€æ³¨å…¥äº†ä¸€ä¸ªé€»è¾‘</strong>ã€‚è¿™ç§ç»Ÿä¸€å¤„ç†çš„é€»è¾‘æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œæ¯”å¦‚ç»Ÿä¸€æ‰“å°æ—¥å¿—ã€ç»Ÿä¸€æ‰“ç‚¹åˆ°ç»Ÿè®¡ç³»ç»Ÿã€ç»Ÿä¸€åšæƒé™ç™»å½•éªŒè¯ç­‰ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>ç°åœ¨å¸Œæœ›èƒ½å¯¹æ¯ä¸ªè¯·æ±‚éƒ½è¿›è¡Œè¯·æ±‚æ—¶é•¿ç»Ÿè®¡ï¼Œæ‰€ä»¥æƒ³å†™ä¸€ä¸ªè¯·æ±‚æ—¶é•¿ç»Ÿè®¡çš„ä¸­é—´ä»¶ï¼Œåœ¨æ—¥å¿—ä¸­è¾“å‡ºè¯·æ±‚ URIã€è¯·æ±‚è€—æ—¶ã€‚ä¸çŸ¥é“ä½ å¦‚ä½•å®ç°å‘¢ï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒã€‚å¦‚æœä½ è§‰å¾—ä»Šå¤©çš„å†…å®¹å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œé‚€è¯·ä»–ä¸€èµ·å­¦ä¹ ï½</p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/88/a9/789fc9b0.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>skyhackvip</span>
  </div>
  <div class="_2_QraFYR_0">core.goä»£ç ä¸­æ·»åŠ ä¸­é—´ä»¶æœ‰äº›é—®é¢˜å§ï¼Ÿ<br>func (c *Core) Use(middlewares ...ControllerHandler) { c.middlewares = middlewares}<br>æ˜¯å¦åº”è¯¥æ”¹ä¸º<br>func (c *Core) Use(middlewares ...ControllerHandler) { c.middlewares = append(c.middlewares, middlewares...)}<br>å¦åˆ™æ·»åŠ å¤šä¸ªä¸‹é¢çš„ä¼šè¦†ç›–ä¸Šé¢çš„ã€‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-09-24 15:42:37</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>qinsi</span>
  </div>
  <div class="_2_QraFYR_0">æƒ³åˆ°å‡ ä¸ªç‚¹ï¼š<br><br>* ä¸­é—´ä»¶çš„æ³¨å†Œæ˜¯æœ‰é¡ºåºçš„ã€‚æ¯”å¦‚æœ€åæ‰æ³¨å†ŒRecoveryçš„è¯ï¼Œpipelineä¸­åœ¨Recoveryå‰é¢çš„ä¸­é—´ä»¶å¦‚æœpanicäº†è¿˜æ˜¯æ²¡æ³•recoverçš„<br>* ä¸­é—´ä»¶éœ€è¦æ˜¾å¼è°ƒç”¨ctx.Next()ï¼Œå¦‚æœå†™ä¸­é—´ä»¶æ—¶å¿˜è®°äº†çš„è¯pipelineå°±æ–­äº†ã€‚æˆ–è®¸å¯ä»¥æŠŠä¸­é—´ä»¶è¿›ä¸€æ­¥æ‹†æˆpreRequest()å’ŒpostRequest()ä¸¤éƒ¨åˆ†<br>* ä¸­é—´ä»¶æœ¬è´¨æ˜¯è£…é¥°å™¨æ¨¡å¼ï¼Œå¦‚æœèƒ½åƒJava&#47;Pythoné‡Œé‚£æ ·å†™è£…é¥°å™¨æ ‡æ³¨çš„è¯å¯èƒ½æ„å›¾æ›´æ˜æ˜¾</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: 1 æ˜¯çš„ï¼Œä¸­é—´ä»¶æ³¨å†Œæœ‰é¡ºåºï¼Œæ‰€ä»¥recoveryæ˜¯éœ€è¦æ”¾åœ¨ç¬¬ä¸€ä¸ªã€‚<br>2 è¿™ä¸ªæ˜¯å¯ä»¥è€ƒè™‘ï¼Œä½†æ˜¯åˆ†æˆä¸¤ä¸ªå‡½æ•°å’Œç°åœ¨ç”¨ä¸€ä¸ªå‡½æ•°åŒºåˆ«å°±æ˜¯æœ‰çš„å˜é‡æ˜¯æ²¡æœ‰åŠæ³•å†™åˆ°ä¸¤ä¸ªå‡½æ•°ä¸­çš„ï¼Œå‚æ•°ä¼ é€’æ¯”è¾ƒéº»çƒ¦ï¼Œæ¯”å¦‚æˆ‘è¦æ‰“å°è¯·æ±‚æ—¶é•¿ï¼Œæœ‰ä¸€ä¸ªå˜é‡ï¼Œstart_time, éœ€è¦åœ¨preRequestä¸­å†™ï¼ŒpostRequestä¸­è¯»ï¼Œç°åœ¨çš„æ–¹å¼å°±æ¯”è¾ƒç®€å•ã€‚åˆ†æˆä¸¤ä¸ªå‡½æ•°å°±éœ€è¦åœ¨postRequestä¸­ç”¨å‚æ•°ä¼ é€’ä¹‹ç±»çš„ã€‚<br>preRequest() ctxParam<br>postRequest(ctxParam)<br><br>3 æ³¨é‡Šæ¥è¡¨ç¤ºè£…é¥°å™¨ï¼Œç„¶åè¿è¡Œçš„æ—¶å€™è¯»å–æ³¨é‡Šæ¥æŒ‰éœ€åŠ è½½ã€‚è¿™ç§æ–¹å¼ä¹Ÿæ˜¯è¡Œçš„ï¼Œå°±æ˜¯å…·ä½“å®ç°çš„æ—¶å€™éœ€è¦è¯»å–â€œæ³¨é‡Šâ€æ¥æ˜ å°„ä¸­é—´ä»¶ï¼Œè¿™é‡Œå­˜åœ¨ä¸€ä¸ªåå°„çš„é€»è¾‘ï¼Œå¯èƒ½ä¼šé™ä½æ•ˆç‡ã€‚æ‰€ä»¥åœ¨golangä¸­è¿™ç§å®ç°ä¸å¤šè§ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-09-20 14:43:04</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/3d/70/a2202898.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>liyanfeng</span>
  </div>
  <div class="_2_QraFYR_0">è¯·æ•™ä¸€ä¸‹è€å¸ˆçš„UMLå›¾æ˜¯ç”¨å“ªä¸ªè½¯ä»¶ç”»çš„å“ˆï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å¯ç”¨å·¥å…·å¾ˆå¤šï¼Œdraw.io é‡‘å±±æ–‡æ¡£éƒ½èƒ½ç”¨</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-09-20 11:10:50</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/ed/0a/18201290.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Juniper</span>
  </div>
  <div class="_2_QraFYR_0">æ—¥å¸¸ä½¿ç”¨çš„webæ¡†æ¶ï¼Œä¸­é—´ä»¶æ˜¯åŸºæœ¬åŠŸèƒ½ä¹‹ä¸€ï¼Œé€šè¿‡è‡ªå·±å®ç°ä¸€éï¼Œæ˜ç™½å…¶ä¸­çš„åŸç†ï¼ŒåŠ æ·±å°è±¡ï¼Œä¸é”™</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-02-15 11:24:39</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/ff/a4/55520286.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>answerå®«</span>
  </div>
  <div class="_2_QraFYR_0">çœ‹ä¸€éæœ‰ç‚¹æ™•,è¦å¤šè¯»å‡ éäº†,è¯¾ç¨‹ä¸é”™,æ˜¯æˆ‘çš„ç›²ç‚¹</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-30 15:13:12</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å‹</span>
  </div>
  <div class="_2_QraFYR_0">æˆ‘çœ‹å¤§å®¶éƒ½è¯´ allHandlers := append(c.middlewares, handlers...) çš„å†™æ³•æœ‰é—®é¢˜ã€‚å…¶å®æ²¡é—®é¢˜ <br>å› ä¸ºæ¯æ¬¡æ‰©å®¹çš„æ—¶å€™ å¹¶æ²¡æœ‰èµ‹å€¼å›å» å³ :c.middwares  := append(c.middlewares, handlers...)<br>æ‰€ä»¥æ¯æ¬¡éƒ½æ˜¯æ‹¿æœªæ‰©å®¹çš„æ•°ç»„æ¥ å¹¶ä¸ä¼šå‡ºç°è¦†ç›–çš„æƒ…å†µ <br></div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ä¹‹å‰ç¡®å®æ˜¯æœ‰é—®é¢˜çš„ï¼Œå·²ç»ä¿®æ”¹è¿‡æ¥äº†</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-01 17:40:21</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src=""
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_8de965</span>
  </div>
  <div class="_2_QraFYR_0">è‡ªå·±å†™åç¢°åˆ°ä¸¤ä¸ªé—®é¢˜ï¼š<br>1.è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º2sï¼Œä¸šåŠ¡é‡Œä¹ŸSleepä¸¤ç§’ï¼Œå‡ºç°ä¸¤ä¸ªåç¨‹éƒ½è®¿é—®äº†c.JSONï¼Œç¨‹åºå´©æºƒï¼Œåœ¨timeouté‚£è¾¹åŠ äº†c.WriterMux().Lock()å¥½åƒæ²¡æœ‰ä½œç”¨<br>2.ä¸»åç¨‹é€šè¿‡setHasTimeoutè®¾ç½®è¶…æ—¶æ ‡è®°åï¼Œä¸šåŠ¡çš„é‚£ä¸ªåç¨‹è¿˜æ˜¯è¯»åˆ°çš„false,å¯¼è‡´time out å’Œ ok éƒ½è¾“å‡ºäº†ã€‚<br><br>æ‰å­¦ä¿©å‘¨Go,æœ‰è¯´å¾—ä¸å¯¹çš„åœ°æ–¹è§è°…</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-11-03 22:18:00</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/3d/70/a2202898.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>liyanfeng</span>
  </div>
  <div class="_2_QraFYR_0">è¿™ä¹ˆå¥½çš„è¯¾ï¼Œå¤§å®¶å¿«æ¥ä¹°ğŸ˜„ï¼Œç†Ÿæ‚‰åŠ æ„å¤–çš„æ„Ÿè§‰ï¼ŒçœŸå¥½</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ„Ÿè°¢æ”¯æŒï¼Œå¸Œæœ›èƒ½å¸®åŠ©åˆ°ä½ </p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-09-20 11:09:20</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/d4/d9/c3296187.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>airmyä¸¶</span>
  </div>
  <div class="_2_QraFYR_0">ä¸€éè·Ÿç€æ€è·¯å†™ä»£ç ï¼Œä¸€éçœ‹ginçš„æºç ï¼Œæ„Ÿè§‰è¿™ä¸ªè¯¾ç¨‹ä¸æ­¢åœ¨æ•™ä½ å†™æ¡†æ¶ï¼Œæ›´æ˜¯åœ¨å¸¦ä½ é˜…è¯»ginçš„æºç </div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-09-16 15:33:21</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/2a/85/35/0cfa2b84.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>é‚£äº›å¹´</span>
  </div>
  <div class="_2_QraFYR_0">æ”¯æŒï¼</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ„Ÿè°¢ï¼</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-13 21:05:58</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/1a/19/99/ba3719e1.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>The brain is a good thing</span>
  </div>
  <div class="_2_QraFYR_0">è¿™è¯¾ç¨‹çœŸçš„æ˜¯ï¼Œçœ‹ä¸€éå›æœ¬ä¸€æ¬¡ - by 2023<br></div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ„Ÿè°¢</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-02-18 23:32:51</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/1f/61/77/e4d198a6.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>MR.å‰ã„ï¼</span>
  </div>
  <div class="_2_QraFYR_0">giné‡Œé¢çš„Context.Nextæ–¹æ³•<br>æ‰§è¡Œçš„æ˜¯Forå¾ªç¯ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸­é—´ä»¶è°ƒç”¨ä¸è°ƒç”¨Nextæ–¹æ³•éƒ½ä¼šå¼ºåˆ¶æ‰§è¡Œä¸‹ä¸€ä¸ªfunc (ctx *Context)</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-12-17 14:51:35</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/2b/0a/23/c26f4e50.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Sunrise</span>
  </div>
  <div class="_2_QraFYR_0">core.go ä¸­ allHandlers := append(c.middlewares, handlers...) è¿™æ ·å†™ç»å¯¹æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸º allHandlers å¯èƒ½ä¼šå…±ç”¨åŒä¸€ä¸ªåº•å±‚æ•°ç»„ï¼Œåº”è¯¥è¿™æ ·å†™å§ï¼š<br>allHandlers := make([]ControllerHandler, len(c.middlewares)+len(handlers))<br>copy(allHandlers, append(c.middlewares, handlers...))</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-12-04 21:57:42</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK6xwUp8JiaFNPNSlNxubQlTgcxl02Yc1eiaOzvj75Wob9AYVdsYwAapowkkicenhV0Y02dW2yibPicHDg/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_96685a</span>
  </div>
  <div class="_2_QraFYR_0">ä½ å¥½ï¼Œä½œè€…ï¼Œæˆ‘åœ¨çº¿ä¸‹è‡ªå·±å®éªŒä¸­é—´ä»¶æ—¶ï¼Œåœ¨åµŒå¥—äº†å¤šä¸ªä¸­é—´ä»¶ä¹‹åï¼ŒRecoveryä¸­é—´ä»¶å¤±æ•ˆäº†ï¼Ÿæ²¡æœ‰æ•è·ä½å¼‚å¸¸ï¼Œå¦‚æœå†™ï¼Œæˆ‘å®šä¹‰çš„timeoutMiddlewareå¼‚å¸¸å¯ä»¥æ•è·åˆ°<br>å…·ä½“å†™æ³•å¦‚ä¸‹ï¼š<br>func timeoutMiddleware() framework.ControllerHandler {<br>	return func(c *framework.Context) error {<br>		timeoutCtx, cancelFunc := context.WithTimeout(c.BaseContext(), time.Second)<br>		defer cancelFunc()<br>		finish := make(chan struct{})<br>		go func() {<br>			c.Next()<br>			finish &lt;- struct{}{}<br>		}()<br>		select {<br>		case &lt;-timeoutCtx.Done():<br>			c.Json(500, &quot;time out&quot;)<br>			c.SetHasTimeout()<br>			return nil<br>		case &lt;-finish:<br>			fmt.Println(&quot;æ‰§è¡Œå®Œæ¯•&quot;)<br>		}<br>		return nil<br>	}<br>}<br><br>func Recovery() framework.ControllerHandler {<br>	return func(c *framework.Context) error {<br>		defer func() {<br>			if err := recover(); err != nil {<br>				fmt.Println(&quot;å¼‚å¸¸äº†&quot;, err)<br>				c.Json(500, err)<br>				return<br>			}<br>		}()<br>		fmt.Println(&quot;æ‰§è¡Œå¼‚å¸¸ä¸­é—´ä»¶&quot;)<br>		c.Next()<br><br>		return nil<br>	}<br>}<br><br>func registerRoute(core *framework.Core) {<br>	core.Use(middleware.Recovery())<br>	core.Get(&quot;&#47;user&#47;login&quot;, timeoutMiddleware(), UserLoginController)<br><br>	&#47;&#47;&#47;&#47; æ‰¹é‡é€šç”¨å‰ç¼€<br>	&#47;&#47;subjectApi := core.Group(&quot;&#47;subject&quot;)<br>	&#47;&#47;{<br>	&#47;&#47;	&#47;&#47; åŠ¨æ€è·¯ç”±<br>	&#47;&#47;	subjectApi.Delete(&quot;&#47;:id&quot;, SubjectDelController)<br>	&#47;&#47;	subjectApi.Put(&quot;&#47;:id&quot;, SubjectUpdateController)<br>	&#47;&#47;	subjectApi.Get(&quot;&#47;:id&quot;, SubjectGetController)<br>	&#47;&#47;	subjectApi.Get(&quot;&#47;list&#47;all&quot;, SubjectListController)<br>	&#47;&#47;}<br>}</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-11-09 16:24:59</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/56/89/30c2f416.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Tal.Huang</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆå¥½ï¼Œå…³äºåœ¨coreä¸­å­˜å‚¨middlewares<br>&#47;&#47; æ³¨å†Œä¸­é—´ä»¶<br>func (c *Core) Use(middlewares ...ControllerHandler) {<br>	fmt.Println(&quot;Core Use&quot;)<br>	c.middlewares = append(c.middlewares, middlewares...)<br>	fmt.Println(c.middlewares)<br>}<br><br>æ‰“å°å‘ç°å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°è¿™ä¸ªæ–¹æ³•ï¼Ÿ<br>Group Use<br>core Get<br>core Get<br>middleware pre test3<br>middleware pre test3<br>middleware post test3<br>middleware post test3<br><br>ä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-10-18 09:56:30</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src=""
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>jayqiyoung</span>
  </div>
  <div class="_2_QraFYR_0">å¦‚æœæ¯ä¸€èŠ‚è¯¾åé¢çš„æé—®ï¼Œä¸‹ä¸€èŠ‚èƒ½å¤Ÿç»™äº›è§£ç­”å°±å¥½äº†<br></div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ç¼–è¾‘å›å¤: åé¢æœ‰ç¯‡åŠ é¤ï¼Œç»Ÿä¸€æ•´ç†äº†ä¸€äº›ä½œä¸šé¢˜çš„æ€è·¯ï¼Œä½ å¯ä»¥çœ‹çœ‹ï½</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-09-26 13:52:36</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/rxz5aKicRkvqWmt6c6c7eayHvh577uibBTVQzcJKwSTqI9FaxZSRlx7NRVw4atWpqER8ncA5jErQb3wb4cPzZxlA/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_065895</span>
  </div>
  <div class="_2_QraFYR_0">è¯·æ±‚æ—¶é•¿ç»Ÿè®¡çš„ä¸­é—´ä»¶å®ç°ï¼š<br>func RecordRequsstTime() framework.ControllerHandler {<br>	&#47;&#47; ä½¿ç”¨å‡½æ•°å›è°ƒ<br>	return func(c *framework.Context) error {<br>		&#47;&#47; è·å–å¼€å§‹æ—¶é—´<br>		startT := time.Now()<br>		&#47;&#47; è¾“å‡ºè¯·æ±‚URI<br>		<br>		&#47;&#47; æ‰§è¡Œå…¶ä»–ä¸­é—´ä»¶å’Œå‡½æ•°å¤„ç†<br>		c.Next()<br>		&#47;&#47; è·å–å¤„ç†æ—¶é•¿<br>		tc := time.Since(startT)<br>		log.Println(tc)<br>		return nil<br>	}<br>}</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-03-06 14:18:18</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/21/41/37/b89f3d67.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æˆ‘åœ¨ç¡è§‰</span>
  </div>
  <div class="_2_QraFYR_0">æä¸€ä¸ªé—®é¢˜ï¼Œè¿™é‡Œé¢ gourpæœºæ„é¢˜é‡Œé¢å°è£…ä¸€ä¸ªGroupç±»å‹çš„parenté“¾è¡¨æœ‰ä»€ä¹ˆç”¨æ„ï¼Œæˆ‘ä¸éœ€è¦è¿™ä¸ªparentå­—æ®µä¹Ÿå®Œå…¨å®ç°äº†åŒæ ·çš„åŠŸèƒ½ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: è¿™ä¸ªä¸»è¦æ˜¯ä½¿ç”¨ä¸Šçš„æ–¹ä¾¿ï¼Œé“¾å¼æ–¹å¼ã€‚<br><br>æˆ‘å¯ä»¥å¤šå±‚åµŒå¥—group</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-21 20:46:27</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/21/41/37/b89f3d67.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æˆ‘åœ¨ç¡è§‰</span>
  </div>
  <div class="_2_QraFYR_0">core.Use( middleware.Test1()ï¼‰<br>è€å¸ˆä½ å¥½ã€‚é—®ä¸€ä¸ªé—®é¢˜ï¼Œ ä¸ºä»€ä¹ˆæ­¤å¤„çš„Test1ä¸€å®šè¦å®šä¹‰æˆè¿”å›ControllerHandleråŒ¿åå‡½æ•°çš„å‡½æ•°ï¼Œæˆ‘å®é™…ç›´æ¥æŠŠTest1å®šä¹‰æˆControllerHandlerç±»å‹çš„çš„å‡½æ•°æ‰§è¡Œèµ·æ¥ä¹Ÿæ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ˜¯è¿™æ ·çš„ï¼Œè¿™æ ·è®¾ç½®çš„è¯ï¼Œä½ å¯ä»¥åœ¨Test1çš„å‚æ•°ä¸­å¸¦ä»»ä½•å‚æ•°ï¼Œç„¶ååœ¨å…·ä½“çš„ControllerHandlerä¸­ä½¿ç”¨è¿™äº›å‚æ•°ï¼Œè€Œå¦‚æœä½ çš„Test1æ˜¯ControllerHandlerçš„è¯ï¼Œå‚æ•°å°±å·²ç»è¢«å›ºå®šäº†ï¼Œåç»­æ‰©å±•æ€§å°±ä¸æ˜¯å¾ˆå¥½<br></p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-14 16:59:46</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å‹</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆè¯·é—®  c.Nextæ˜¯å¯ä»¥æ•è·errorçš„ åœ¨æ•´ä¸ªé“¾è·¯ä¸­å¦‚æœä¸€å¤„åœ°æ–¹æŠ›å‡ºäº†error  ä½†æ˜¯åœ¨æœ€é¡¶å±‚ ServeHTTPä¸­çš„é‚£ä¸ªnextå¦‚æœè¿”å›nil é‚£ä¹ˆæ•´æ¡é“¾è·¯ä¸­çš„errorä¼šè¢«å¿½ç•¥æ‰<br>æˆ‘ä»¬åªåœ¨ timeoutä¸­åŠ å…¥äº† é”è¿™ä¸ªæ¦‚å¿µ å…¶å®è¿™ä¸ªå…¶å®è¿™ä¸ªåº”è¯¥å¯ä»¥æŠ½å‡ºæ¥ ç»Ÿä¸€åŠ ä¸Šä¸å…è®¸é‡å¤å†™responseWriter<br></div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: 1 ç¡®å®è¿™é‡Œæ›´ä¸¥è°¨çš„å†™æ³•æ˜¯åœ¨æ‰€æœ‰ä¸­é—´ä»¶çš„c.Next() éƒ½å¤„ç†error<br>2 ä½¿ç”¨é”ä¿è¯ responseWriter åªå†™ä¸€æ¬¡è‚¯å®šæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯æˆ‘è§‰å¾—è¿™ç§åªé™åˆ¶å†™ä¸€æ¬¡åè€Œä¹Ÿä¼šæœ‰é—®é¢˜ï¼Œä¼šä¸ä¼šæœ‰åœºæ™¯æœ‰çš„æ§åˆ¶å™¨å†™å†…å®¹ï¼Œæœ‰çš„ä¸­é—´ä»¶å†™headerå¤´è¿™ç§ã€‚è¿™ç§é™åˆ¶å¯ä»¥åŠ ï¼Œä½†æ˜¯åŠ çš„æ—¶å€™ä¼°è®¡è¦æ€è€ƒå¾ˆæ¸…æ¥š</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-01 17:53:50</div>
  </div>
</div>
</div>
</li>
</ul>