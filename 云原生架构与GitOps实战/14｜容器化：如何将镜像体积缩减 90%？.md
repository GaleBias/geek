<audio title="14ï½œå®¹å™¨åŒ–ï¼šå¦‚ä½•å°†é•œåƒä½“ç§¯ç¼©å‡ 90%ï¼Ÿ" src="https://static001.geekbang.org/resource/audio/16/92/166d0b64def8dcb1bf53224bfb014f92.mp3" controls="controls"></audio> 
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ç‹ç‚œã€‚ä»Šå¤©æ˜¯æˆ‘ä»¬å®¹å™¨åŒ–å®è·µçš„ç¬¬äºŒè¯¾ã€‚</p><p>å®¹å™¨åŒ–çš„å­¦ä¹ æ›²çº¿æ˜¯éå¸¸é™¡å³­çš„ï¼Œå¯¹äºåˆå­¦ Docker çš„åŒå­¦æ¥è¯´ï¼ŒçŸ­æ—¶é—´å†…å¾ˆéš¾é’ˆå¯¹å·²æœ‰ä¸šåŠ¡ç¼–å†™åˆé€‚çš„ Dockerfileã€‚æ‰€ä»¥ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ç›´æ¥ç»™å‡ºäº†ä¸åŒè¯­è¨€æ¥è¿‘ç”Ÿäº§å¯ç”¨çš„ Dockerfileï¼Œä½†æˆ‘å¹¶æ²¡æœ‰æ·±å…¥ä»‹ç»é‡Œé¢æ¶‰åŠçš„ä¸€äº›æ„å»ºæŠ€å·§ã€‚</p><p>åœ¨è¿™äº›æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ç”¨åˆ°æœ€å¤šçš„å°±æ˜¯é€šè¿‡â€œå¤šé˜¶æ®µâ€çš„æ–¹å¼æ¥æ„å»ºé•œåƒï¼Œä½†æ˜¯å¯¹äºâ€œå¤šé˜¶æ®µæ„å»ºâ€ï¼Œæˆ‘ä»¬åªçŸ¥é“äº†å®ƒçš„å…·ä½“ç”¨æ³•ï¼Œå¹¶æ²¡æœ‰è§£é‡Šä¸ºä»€ä¹ˆè¦ä½¿ç”¨å®ƒã€‚</p><p>åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒåªçŸ¥é“â€œå¤šé˜¶æ®µæ„å»ºâ€çš„ç”¨æ³•ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ä¸è¿‡åœ¨ç°å®ç”Ÿäº§è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½é¢ä¸´ä¸€ç³»åˆ—é—®é¢˜ï¼Œä¾‹å¦‚ï¼Œç”±äºå¯¹é•œåƒæ„å»ºè¿‡ç¨‹ä¸å¤Ÿç†Ÿæ‚‰ï¼Œå¾ˆå®¹æ˜“å‡ºç°æ„å»ºæ…¢ã€æ„å»ºé•œåƒè¿‡å¤§ç­‰é—®é¢˜ï¼Œè¿™ä¼šå¯¼è‡´æ¨é€é•œåƒå˜å¾—ç¼“æ…¢ï¼ŒåŒæ—¶ä¹Ÿä¼šå¯¼è‡´åœ¨ Kubernetes æ›´æ–°åº”ç”¨é•œåƒç‰ˆæœ¬æ—¶æ‹‰å–é•œåƒçš„è¿‡ç¨‹ä¹Ÿå˜å¾—ç¼“æ…¢ï¼Œä»è€Œå½±å“æ•´ä½“åº”ç”¨å‘å¸ƒæ•ˆç‡ã€‚æ‰€ä»¥ï¼Œå¦‚ä½•è¿›ä¸€æ­¥å€ŸåŠ©å¤šé˜¶æ®µæ„å»ºæ¥ä¼˜åŒ–é•œåƒå¤§å°å°±æ˜¾å¾—éå¸¸é‡è¦äº†ã€‚</p><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘å°†å¸¦ä½ æ·±å…¥äº†è§£â€œå¤šé˜¶æ®µæ„å»ºâ€ï¼Œé€šè¿‡å…·ä½“çš„å®è·µï¼Œè¿›ä¸€æ­¥ç†è§£å®ƒçš„æœ€é‡è¦ç‰¹æ€§ä¹‹ä¸€ï¼šå‡å°é•œåƒä½“ç§¯ã€‚åœ¨ç¼©å‡é•œåƒçš„å®æˆ˜è¿‡ç¨‹ä¸­ï¼Œæˆ‘è¿˜ä¼šä¸ºä½ è§£é‡Šåœ¨ä¸Šä¸€èŠ‚è¯¾ç”¨åˆ°çš„å…¶ä»–æ„å»ºæŠ€å·§ã€‚</p><p>åœ¨æ­£å¼å¼€å§‹ä»Šå¤©çš„å­¦ä¹ ä¹‹å‰ï¼Œä½ éœ€è¦ç¡®ä¿å·²ç»åœ¨æœ¬åœ°å®‰è£…äº† Dockerï¼Œå¹¶å°†æˆ‘æå‰å‡†å¤‡å¥½çš„ç¤ºä¾‹åº”ç”¨ä»“åº“å…‹éš†åˆ°æœ¬åœ°ï¼š<a href="https://github.com/lyzhang1999/gitops.git">https://github.com/lyzhang1999/gitops.git</a>ã€‚</p><!-- [[[read_end]]] --><h2>ä»æ„å»º Golang é•œåƒå¼€å§‹</h2><p>æˆ‘è¿˜æ˜¯ä»¥ä¸Šä¸€èŠ‚è¯¾ Golang çš„åº”ç”¨ä¸ºä¾‹ã€‚ä½ éœ€è¦å…ˆå°†ç¤ºä¾‹åº”ç”¨ä»“åº“å…‹éš†åˆ°æœ¬åœ°ï¼Œç„¶åè¿›å…¥ Golang ç¤ºä¾‹åº”ç”¨ã€‚</p><pre><code class="language-powershell">$ cd gitops/docker/13/golang
</code></pre><p>å¯¹äºå¤§å¤šæ•° Docker åˆå­¦è€…æ¥è¯´ï¼Œé¦–è¦ç›®æ ‡æ˜¯èƒ½å¤ŸæˆåŠŸæ„å»ºé•œåƒï¼Œæ‰€ä»¥ï¼Œå¤§éƒ¨åˆ†äººåœ¨æœ€å¼€å§‹ç¼–å†™çš„ Dockerfile çš„æ—¶å€™éƒ½ä»¥â€œèƒ½ç”¨â€ä½œä¸ºé¦–è¦ç›®æ ‡ï¼Œå†…å®¹å’Œ Golang åº”ç”¨ä¸­çš„ Dockerfile-1 æ–‡ä»¶ç±»ä¼¼ã€‚</p><pre><code class="language-powershell"># syntax=docker/dockerfile:1
FROM golang:1.17
WORKDIR /opt/app
COPY . .
RUN go build -o example
CMD ["/opt/app/example"]
</code></pre><p>è¿™ä¸ª Dockerfile æè¿°çš„æ„å»ºè¿‡ç¨‹éå¸¸ç®€å•ï¼Œæˆ‘ä»¬é¦–é€‰ Golang:1.17 ç‰ˆæœ¬çš„é•œåƒä½œä¸ºç¼–è¯‘ç¯å¢ƒï¼Œå°†æºç æ‹·è´åˆ°é•œåƒä¸­ï¼Œç„¶åè¿è¡Œ go build ç¼–è¯‘æºç ç”ŸæˆäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæœ€åé…ç½®å¯åŠ¨å‘½ä»¤ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ Dockerfile-1 æ–‡ä»¶æ¥æ„å»ºé•œåƒã€‚</p><pre><code class="language-powershell">$ docker build -t golang:1 -f Dockerfile-1 .
</code></pre><p>æ„å»ºæˆåŠŸåï¼Œä½¿ç”¨ docker images æ¥æŸ¥çœ‹é•œåƒå¤§å°ã€‚</p><pre><code class="language-powershell">$ docker images
REPOSITORY&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TAG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IMAGE ID&nbsp; &nbsp; &nbsp; &nbsp;CREATED&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SIZE
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;751ee3477c3d&nbsp; &nbsp;5 minutes ago&nbsp; &nbsp;903MB
</code></pre><p>ä»è¿”å›çš„ç»“æœæ¥çœ‹ï¼Œè¿™ä¸ª Dockerfile æ„å»ºçš„é•œåƒå¤§å°éå¸¸æƒŠäººï¼ŒGolang ç¤ºä¾‹ç¨‹åºä½¿ç”¨ go build å‘½ä»¤ç¼–è¯‘åï¼ŒäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å¤§çº¦ 6M å·¦å³ï¼Œä½†å®¹å™¨åŒ–ä¹‹åï¼Œé•œåƒè¾¾åˆ° 900Mï¼Œæ˜¾ç„¶æˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–é•œåƒå¤§å°ã€‚</p><h3>æ›¿æ¢åŸºç¡€é•œåƒ</h3><p>æ€ä¹ˆåšå‘¢ï¼Ÿæˆ‘ä»¬æ„å»ºçš„ Golang é•œåƒçš„å¤§å°å¾ˆå¤§ç¨‹åº¦æ˜¯ç”±å¼•å…¥çš„åŸºç¡€é•œåƒçš„å¤§å°å†³å®šçš„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ›¿æ¢åŸºç¡€é•œåƒæ˜¯ä¸€ä¸ªå¿«é€Ÿå¹¶ä¸”éå¸¸æœ‰æ•ˆçš„åŠæ³•ã€‚ä¾‹å¦‚ï¼Œå°† Golang:1.17 åŸºç¡€é•œåƒæ›¿æ¢ä¸º golang:1.17-alpine ç‰ˆæœ¬ã€‚</p><pre><code class="language-powershell"># syntax=docker/dockerfile:1
FROM golang:1.17-alpine
WORKDIR /opt/app
COPY . .
RUN go build -o example
CMD ["/opt/app/example"]
</code></pre><p>ä¸€èˆ¬æ¥è¯´ï¼ŒAlpine ç‰ˆæœ¬çš„é•œåƒç›¸æ¯”è¾ƒæ™®é€šé•œåƒæ¥è¯´åˆ é™¤äº†ä¸€äº›éå¿…éœ€çš„ç³»ç»Ÿåº”ç”¨ï¼Œæ‰€ä»¥é•œåƒä½“ç§¯æ›´å°ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ Dockerfile-2 æ–‡ä»¶æ¥æ„å»ºé•œåƒã€‚</p><pre><code class="language-powershell">$ docker build -t golang:2 -f Dockerfile-2 .
</code></pre><p>æ„å»ºæˆåŠŸåï¼ŒæŸ¥çœ‹é•œåƒå¤§å°ã€‚</p><pre><code class="language-powershell">$ docker images
REPOSITORY&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TAG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IMAGE ID&nbsp; &nbsp; &nbsp; &nbsp;CREATED&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SIZE
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bbaa9e935080&nbsp; &nbsp;4 minutes ago&nbsp; &nbsp; &nbsp; &nbsp; 408MB
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;751ee3477c3d&nbsp; &nbsp;5 minutes ago&nbsp; &nbsp; &nbsp; &nbsp; 903MB
</code></pre><p>é€šè¿‡å¯¹æ¯”å‘ç°ï¼Œæ–°çš„ Dockerfile-2 æ„å»ºçš„é•œåƒæ¯” Dockerfile-1 æ„å»ºçš„é•œåƒåœ¨å¤§å°ä¸Šç¼©å‡äº† 50%ï¼Œåªæœ‰ 408Mäº†ã€‚</p><h3>é‡æ–°æ€è€ƒ Dockerfile</h3><p>è®©æˆ‘ä»¬è¿›ä¸€æ­¥åˆ†æä¸€ä¸‹ Dockerfile-2 æ–‡ä»¶çš„å†…å®¹ã€‚</p><pre><code class="language-powershell"># syntax=docker/dockerfile:1
FROM golang:1.17-alpine
WORKDIR /opt/app
COPY . .
RUN go build -o example
CMD ["/opt/app/example"]
</code></pre><p>ä»è¿™æ®µ Dockerfile å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬åœ¨å®¹å™¨å†…è¿è¡Œäº† go build -o exampleï¼Œè¿™æ¡å‘½ä»¤å°†ä¼šç¼–è¯‘ç”ŸæˆäºŒè¿›åˆ¶çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç”±äºç¼–è¯‘çš„è¿‡ç¨‹ä¸­éœ€è¦ Golang ç¼–è¯‘å·¥å…·çš„æ”¯æŒï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¦ä½¿ç”¨ Golang é•œåƒä½œä¸ºåŸºç¡€é•œåƒï¼Œè¿™æ˜¯å¯¼è‡´é•œåƒä½“ç§¯è¿‡å¤§çš„ç›´æ¥åŸå› ã€‚</p><p>æ—¢ç„¶å¦‚æ­¤ï¼Œé‚£ä¹ˆæˆ‘èƒ½ä¸èƒ½ä¸åœ¨é•œåƒé‡Œç¼–è¯‘å‘¢ï¼Ÿè¿™æ ·ä¸ä¾èµ–é•œåƒçš„ç¼–è¯‘å·¥å…·ï¼Œå†ä½¿ç”¨ä¸€ä¸ªä½“ç§¯æ›´å°çš„é•œåƒæ¥è¿è¡Œç¨‹åºï¼Œæ„å»ºå‡ºæ¥çš„é•œåƒè‡ªç„¶å°±ä¼šå˜å°äº†ã€‚</p><p>æ€è·¯å®Œå…¨æ²¡é”™ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦æ€ä¹ˆåšå‘¢ï¼Ÿæœ€ç®€å•çš„åŠæ³•å°±æ˜¯åœ¨æœ¬åœ°å…ˆç¼–è¯‘å‡ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå†å°†å®ƒå¤åˆ¶åˆ°ä¸€ä¸ªæ›´å°ä½“ç§¯çš„ ubuntu é•œåƒå†…ã€‚</p><p>å…·ä½“åšæ³•æ˜¯ï¼Œé¦–å…ˆåœ¨æœ¬åœ°ä½¿ç”¨äº¤å‰ç¼–è¯‘ç”Ÿæˆ Linux å¹³å°çš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><pre><code class="language-powershell">$ CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o example .
$ ls -lh
-rwxr-xr-x&nbsp; 1 wangwei&nbsp; staff&nbsp; &nbsp;6.4M 10 10 16:58 example
......
</code></pre><p>æ¥ä¸‹æ¥ï¼Œä½¿ç”¨ Dockerfile-3 æ–‡ä»¶æ„å»ºé•œåƒã€‚</p><pre><code class="language-powershell"># syntax=docker/dockerfile:1
FROM ubuntu:latest
WORKDIR /opt/app
COPY example ./
CMD ["/opt/app/example"]
</code></pre><p>å› ä¸ºä¸å†éœ€è¦åœ¨å®¹å™¨é‡Œè¿›è¡Œç¼–è¯‘ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥å¼•å…¥äº†ä¸åŒ…å« Golang ç¼–è¯‘å·¥å…·çš„ ubuntu é•œåƒä½œä¸ºåŸºç¡€è¿è¡Œç¯å¢ƒï¼Œæ¥ä¸‹æ¥ä½¿ç”¨ docker build å‘½ä»¤æ„å»ºé•œåƒã€‚</p><pre><code class="language-powershell">$ docker build -t golang:3 -f Dockerfile-3 .
</code></pre><p>æ„å»ºå®Œæˆåï¼Œä½¿ç”¨ docker images æ¥æŸ¥çœ‹é•œåƒå¤§å°ã€‚</p><pre><code class="language-powershell">$ docker images
REPOSITORY&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TAG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IMAGE ID&nbsp; &nbsp; &nbsp; &nbsp;CREATED&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SIZE
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;b53404869778&nbsp; &nbsp;3 minutes ago&nbsp; &nbsp; &nbsp; &nbsp; 75.9MB
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bbaa9e935080&nbsp; &nbsp;4 minutes ago&nbsp; &nbsp; &nbsp; &nbsp; 408MB
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;751ee3477c3d&nbsp; &nbsp;5 minutes ago&nbsp; &nbsp; &nbsp; &nbsp; 903MB
</code></pre><p>ä»è¿”å›å†…å®¹å¯ä»¥çœ‹å‡ºï¼Œ<strong>è¿™ç§æ„å»ºæ–¹å¼ç”Ÿæˆçš„é•œåƒåªæœ‰ 76Mï¼Œåœ¨ä½“ç§¯ä¸Šæ¯”æœ€åˆçš„ 917M ç¼©å°äº†å‡ ä¹ 90% ã€‚</strong>é•œåƒçš„æœ€ç»ˆå¤§å°å°±ç›¸å½“äº ubuntu:latest çš„å¤§å°åŠ ä¸Š Golang äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°ã€‚</p><p>ä¸è¿‡ï¼Œè¿™ç§æ–¹å¼å°†åº”ç”¨çš„ç¼–è¯‘è¿‡ç¨‹æ‹†åˆ†åˆ°äº†å®¿ä¸»æœºä¸Šï¼Œ<strong>è¿™ä¼šè®© Dockerfile å¤±å»æè¿°åº”ç”¨ç¼–è¯‘å’Œæ‰“åŒ…çš„ä½œç”¨ï¼Œä¸æ˜¯ä¸€ä¸ªå¥½çš„å®è·µã€‚</strong></p><p>å…¶å®ï¼Œæˆ‘ä»¬ä»”ç»†åˆ†æä¸Šé¢çš„æ„å»ºæ–¹æ³•ï¼Œä¼šå‘ç°å®ƒçš„æœ¬è´¨æ˜¯æŠŠæ„å»ºå’Œè¿è¡Œæ‹†åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œæ„å»ºç”±æœ¬åœ°ç¯å¢ƒçš„ç¼–è¯‘å·¥å…·æä¾›æ”¯æŒï¼Œè¿è¡Œç”± ubuntu é•œåƒæä¾›æ”¯æŒã€‚</p><p>é‚£ä¹ˆï¼Œèƒ½ä¸èƒ½å°†è¿™ä¸ªæ€æƒ³è¿ç§»åˆ° Dockerfile çš„æ„å»ºè¿‡ç¨‹ä¸­å‘¢ï¼Ÿè¯´åˆ°è¿™é‡Œï¼Œæˆ‘ç›¸ä¿¡ä½ å·²ç»èƒ½è”æƒ³åˆ°æˆ‘ä»¬ä¸ŠèŠ‚è¯¾æåˆ°çš„â€œå¤šé˜¶æ®µæ„å»ºâ€äº†ï¼Œæ€è·¯æ˜¯ä¸æ˜¯éå¸¸ä¸€è‡´ï¼Ÿ</p><h2>å¤šé˜¶æ®µæ„å»º</h2><p>åœ¨æˆ‘ä»¬ä¸ŠèŠ‚è¯¾çš„é•œåƒæ„å»ºæ¡ˆä¾‹ä¸­ï¼Œå¤šé˜¶æ®µæ„å»ºçš„æœ¬è´¨å…¶å®å°±æ˜¯å°†é•œåƒæ„å»ºè¿‡ç¨‹æ‹†åˆ†æˆç¼–è¯‘è¿‡ç¨‹å’Œè¿è¡Œè¿‡ç¨‹ã€‚ç¬¬ä¸€ä¸ªé˜¶æ®µå¯¹åº”ç¼–è¯‘çš„è¿‡ç¨‹ï¼Œè´Ÿè´£ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼›ç¬¬äºŒä¸ªé˜¶æ®µå¯¹åº”è¿è¡Œè¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯æ‹·è´ç¬¬ä¸€é˜¶æ®µçš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶ä¸ºç¨‹åºæä¾›è¿è¡Œç¯å¢ƒï¼Œæœ€ç»ˆé•œåƒä¹Ÿå°±æ˜¯ç¬¬äºŒé˜¶æ®µç”Ÿæˆçš„é•œåƒå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://static001.geekbang.org/resource/image/7e/4a/7e722784a1f63e045b94fa019189184a.jpg?wh=1920x654" alt="å›¾ç‰‡"></p><p>é€šè¿‡è¿™å¼ åŸç†å›¾ï¼Œæˆ‘ç›¸ä¿¡ä½ å·²ç»å‘ç°äº†ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç»“è®ºã€‚ä»¥ Golang ç¤ºä¾‹åº”ç”¨ä¸ºä¾‹ï¼Œ<strong>å¤šé˜¶æ®µæ„å»ºå…¶å®å°±æ˜¯å°† Dockerfile-1 å’Œ Dockerfile-3 çš„å†…å®¹è¿›è¡Œåˆå¹¶é‡ç»„ï¼Œ</strong>æœ€ç»ˆå®Œæ•´çš„å¤šé˜¶æ®µæ„å»ºçš„ Dockerfile-4 å†…å®¹å¦‚ä¸‹ã€‚</p><pre><code class="language-yaml"># syntax=docker/dockerfile:1

# Step 1: build golang binary
FROM golang:1.17 as builder
WORKDIR /opt/app
COPY . .
RUN go build -o example

# Step 2: copy binary from step1
FROM ubuntu:latest
WORKDIR /opt/app
COPY --from=builder /opt/app/example ./example
CMD ["/opt/app/example"]
</code></pre><p>è¿™æ®µå†…å®¹é‡Œæœ‰ä¸¤ä¸ª FROM è¯­å¥ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªé˜¶æ®µçš„æ„å»ºè¿‡ç¨‹ã€‚</p><p>ç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯ä»ç¬¬ 4 è¡Œè‡³ç¬¬ 7 è¡Œï¼Œå®ƒçš„ä½œç”¨æ˜¯ç¼–è¯‘ç”ŸæˆäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå°±åƒæˆ‘ä»¬ä¹‹å‰åœ¨æœ¬åœ°æ‰§è¡Œçš„ç¼–è¯‘æ“ä½œä¸€æ ·ã€‚</p><p>ç¬¬äºŒé˜¶æ®µåœ¨ç¬¬ 10 è¡Œåˆ° 13 è¡Œï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†ç¬¬ä¸€é˜¶æ®µç”Ÿæˆçš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ°å½“å‰é˜¶æ®µï¼ŒæŠŠ ubuntu:latest ä½œä¸ºè¿è¡Œç¯å¢ƒï¼Œå¹¶è®¾ç½® CMD å¯åŠ¨å‘½ä»¤ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ docker build æ„å»ºé•œåƒï¼Œå¹¶å°†å…¶å‘½åä¸º golang:4ã€‚</p><pre><code class="language-powershell">$ docker build -t golang:4 -f Dockerfile-4 .
</code></pre><p>æ„å»ºå®Œæˆåï¼Œä½¿ç”¨ docker images æŸ¥çœ‹é•œåƒå¤§å°ã€‚</p><pre><code class="language-powershell">$ docker images
REPOSITORY&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TAG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IMAGE ID&nbsp; &nbsp; &nbsp; &nbsp;CREATED&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SIZE
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8d40b16bb409&nbsp; &nbsp;2 minutes ago&nbsp; &nbsp; &nbsp; &nbsp; 75.8MB
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;b53404869778&nbsp; &nbsp;3 minutes ago&nbsp; &nbsp; &nbsp; &nbsp; 75.9MB
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bbaa9e935080&nbsp; &nbsp;4 minutes ago&nbsp; &nbsp; &nbsp; &nbsp; 408MB
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;751ee3477c3d&nbsp; &nbsp;5 minutes ago&nbsp; &nbsp; &nbsp; &nbsp; 903MB
</code></pre><p>ä»è¿”å›ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œgolang:4 é•œåƒå¤§å°å’Œ golang:3 é•œåƒå¤§å°å‡ ä¹ä¸€è‡´ï¼Œå¤§çº¦ä¸º 76Mã€‚</p><p>åˆ°è¿™é‡Œï¼Œå¯¹é•œåƒå¤§å°çš„ä¼˜åŒ–å·²ç»åŸºæœ¬ä¸Šå®Œæˆäº†ï¼Œé•œåƒå¤§å°ä¹Ÿåœ¨å¯æ¥å—çš„èŒƒå›´å†…ã€‚åœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œ<strong>æˆ‘ä¹Ÿæ¨èä½ ä½¿ç”¨ ubuntu:latest ä½œä¸ºç¬¬äºŒé˜¶æ®µçš„ç¨‹åºè¿è¡Œé•œåƒã€‚</strong></p><p>ä¸è¿‡ï¼Œä¸ºäº†è®©ä½ æ·±å…¥ç†è§£å¤šé˜¶æ®µæ„å»ºï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°è¯•è¿›ä¸€æ­¥å‹ç¼©æ„å»ºçš„é•œåƒå¤§å°ã€‚</p><h3>è¿›ä¸€æ­¥å‹ç¼©</h3><p>å½“æˆ‘ä»¬ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºæ—¶ï¼Œæœ€ç»ˆç”Ÿæˆçš„é•œåƒå¤§å°å…¶å®å–å†³äºç¬¬äºŒé˜¶æ®µå¼•ç”¨çš„é•œåƒå¤§å°ï¼Œå®ƒåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­å¯¹åº”çš„æ˜¯ ubuntu:latest é•œåƒå¤§å°ã€‚</p><p>è¦è¿›ä¸€æ­¥ç¼©å°ä½“ç§¯ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­ä½¿ç”¨å…¶ä»–<strong>æ›´å°çš„é•œåƒ</strong>ä½œä¸ºç¬¬äºŒé˜¶æ®µçš„è¿è¡Œé•œåƒï¼Œè¿™å°±è¦è¯´åˆ° Alpine äº†ã€‚</p><p>Alpine é•œåƒæ˜¯ä¸“é—¨ä¸ºå®¹å™¨åŒ–å®šåˆ¶çš„ Linux å‘è¡Œç‰ˆï¼Œå®ƒçš„æœ€å¤§ç‰¹ç‚¹æ˜¯ä½“ç§¯éå¸¸å°ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°è¯•ä½¿ç”¨å®ƒï¼Œå°†ç¬¬äºŒé˜¶æ®µæ„å»ºçš„é•œåƒæ›¿æ¢ä¸º Alpine é•œåƒï¼Œä¿®æ”¹åçš„æ–‡ä»¶å‘½åä¸º Dockerfile-5ï¼Œå†…å®¹å¦‚ä¸‹ã€‚</p><pre><code class="language-yaml"># syntax=docker/dockerfile:1

# Step 1: build golang binary
FROM golang:1.17 as builder
WORKDIR /opt/app
COPY . .
RUN CGO_ENABLED=0 go build -o example

# Step 2: copy binary from step1
FROM alpine
WORKDIR /opt/app
COPY --from=builder /opt/app/example ./example
CMD ["/opt/app/example"]
</code></pre><p>ç”±äº Alpine é•œåƒå¹¶æ²¡æœ‰ glibcï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶æ—¶æŒ‡å®šäº† CGO_ENABLED=0ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ç¦ç”¨äº† CGOï¼Œè¿™æ ·ç¨‹åºæ‰èƒ½åœ¨ Alpine é•œåƒä¸­è¿è¡Œã€‚</p><p>æ¥ç€æˆ‘ä»¬ä½¿ç”¨ Dockerfile-5 æ„å»ºé•œåƒï¼Œå¹¶å°†é•œåƒå‘½åä¸º golang:5ã€‚</p><pre><code class="language-yaml">$ docker build -t golang:5 -f Dockerfile-5 .
</code></pre><p>æ„å»ºå®Œæˆåï¼Œä½¿ç”¨ docker images æŸ¥çœ‹é•œåƒå¤§å°ã€‚</p><pre><code class="language-powershell">$ â¯ docker images
REPOSITORY&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TAG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IMAGE ID&nbsp; &nbsp; &nbsp; &nbsp;CREATED&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SIZE
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;7b2de55bf367&nbsp; &nbsp;About a minute ago&nbsp; &nbsp;11.9MB
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8d40b16bb409&nbsp; &nbsp;2 minutes ago&nbsp; &nbsp; &nbsp; &nbsp; 75.8MB
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;b53404869778&nbsp; &nbsp;3 minutes ago&nbsp; &nbsp; &nbsp; &nbsp; 75.9MB
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bbaa9e935080&nbsp; &nbsp;4 minutes ago&nbsp; &nbsp; &nbsp; &nbsp; 408MB
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;751ee3477c3d&nbsp; &nbsp;5 minutes ago&nbsp; &nbsp; &nbsp; &nbsp; 903MB
</code></pre><p>ä»è¿”å›çš„ç»“æœæˆ‘ä»¬å¾—çŸ¥ï¼Œä½¿ç”¨ Alpine é•œåƒä½œä¸ºç¬¬äºŒé˜¶æ®µçš„è¿è¡Œé•œåƒåï¼Œé•œåƒå¤§å°ä» 76M é™ä½è‡³äº† 12Mã€‚</p><p>ä¸è¿‡ï¼Œç”±äº Alpine é•œåƒå’Œå¸¸è§„ Linux å‘è¡Œç‰ˆå­˜åœ¨ä¸€äº›å·®å¼‚ï¼Œä½œä¸ºåˆå­¦è€…ï¼Œæˆ‘å¹¶<strong>ä¸æ¨è</strong>ä½ åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹æŠŠ Alpine é•œåƒä½œä¸ºä¸šåŠ¡çš„è¿è¡Œé•œåƒï¼Œå…·ä½“åŸå› æˆ‘ä»¬è¿˜ä¼šåœ¨ä¸‹èŠ‚è¯¾åšæ·±å…¥ä»‹ç»ã€‚</p><h3>æé™å‹ç¼©</h3><p>ä»å‰é¢çš„æ“ä½œå¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæŠŠ Alpine é•œåƒä½œä¸ºç¬¬äºŒé˜¶æ®µçš„é•œåƒï¼Œå¾—åˆ°çš„é•œåƒå·²ç»è¶³å¤Ÿå°äº†ï¼Œç›¸æ¯”è¾ƒ 7M çš„å¯æ‰§è¡Œæ–‡ä»¶å¤§å°ï¼Œé•œåƒåªå¢åŠ äº† 5M å¤§å°ã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬æœ‰æ²¡æœ‰å¯èƒ½å†æç«¯ä¸€ç‚¹ï¼Œè®©å¤šé˜¶æ®µæ„å»ºçš„é•œåƒå¤§å°å’ŒäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°ä¿æŒä¸€è‡´å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠç¬¬äºŒä¸ªé˜¶æ®µçš„é•œåƒæ›¿æ¢ä¸ºä¸€ä¸ªâ€œç©ºé•œåƒâ€ï¼Œè¿™ä¸ªç©ºé•œåƒç§°ä¸º scratch é•œåƒï¼Œæˆ‘ä»¬å°† Dockerfile-4 ç¬¬äºŒé˜¶æ®µçš„æ„å»ºæ›¿æ¢ä¸º scratch é•œåƒï¼Œä¿®æ”¹åçš„æ–‡ä»¶å‘½åä¸º Dockerfile-6ï¼Œå†…å®¹å¦‚ä¸‹ã€‚</p><pre><code class="language-yaml"> # syntax=docker/dockerfile:1

# Step 1: build golang binary
FROM golang:1.17 as builder
WORKDIR /opt/app
COPY . .
RUN CGO_ENABLED=0 go build -o example

# Step 2: copy binary from step1
FROM scratch
WORKDIR /opt/app
COPY --from=builder /opt/app/example ./example
CMD ["/opt/app/example"]
</code></pre><p>æ³¨æ„ï¼Œç”±äº scratch é•œåƒä¸åŒ…å«ä»»ä½•å†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ç¼–è¯‘ Golang å¯æ‰§è¡Œæ–‡ä»¶çš„æ—¶å€™ç¦ç”¨äº† CGOï¼Œè¿™æ ·æ‰èƒ½è®©ç¼–è¯‘å‡ºæ¥çš„ç¨‹åºåœ¨ scratch é•œåƒä¸­è¿è¡Œã€‚</p><p>æ¥ç€ï¼Œæˆ‘ä»¬ä½¿ç”¨ docker build æ„å»ºè¿™ä¸ªé•œåƒï¼Œå°†å…¶å‘½åä¸º golang:5ï¼Œç„¶åå†æŸ¥çœ‹é•œåƒå¤§å°ï¼Œä½ ä¼šå‘ç°é•œåƒå’Œ Golang å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°æ˜¯ä¸€è‡´çš„ï¼Œåªæœ‰ 6.6Mã€‚</p><pre><code class="language-yaml">$ docker build -t golang:6 -f Dockerfile-6 .
$ docker images
REPOSITORY                      TAG               IMAGE ID       CREATED             SIZE
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 6&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;aa61f2cff23d&nbsp; &nbsp;35 seconds ago&nbsp; &nbsp; &nbsp; &nbsp;6.63MB
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;7b2de55bf367&nbsp; &nbsp;About a minute ago&nbsp; &nbsp;11.9MB
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8d40b16bb409&nbsp; &nbsp;2 minutes ago&nbsp; &nbsp; &nbsp; &nbsp; 75.8MB
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;b53404869778&nbsp; &nbsp;3 minutes ago&nbsp; &nbsp; &nbsp; &nbsp; 75.9MB
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bbaa9e935080&nbsp; &nbsp;4 minutes ago&nbsp; &nbsp; &nbsp; &nbsp; 408MB
golang&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;751ee3477c3d&nbsp; &nbsp;5 minutes ago&nbsp; &nbsp; &nbsp; &nbsp; 903MB
</code></pre><p>scratch é•œåƒæ˜¯ä¸€ä¸ªç©ºç™½é•œåƒï¼Œç”šè‡³è¿ shell éƒ½æ²¡æœ‰ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿæ— æ³•è¿›å…¥å®¹å™¨æŸ¥çœ‹æ–‡ä»¶æˆ–è¿›è¡Œè°ƒè¯•ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¦‚æœå¯¹å®‰å…¨æœ‰æé«˜çš„è¦æ±‚ï¼Œä½ å¯ä»¥è€ƒè™‘æŠŠ scratch ä½œä¸ºç¨‹åºçš„è¿è¡Œé•œåƒã€‚</p><h3>å¦‚ä½•å¤ç”¨æ„å»ºç¼“å­˜ï¼Ÿ</h3><p>åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ å·²ç»ç†è§£å¤šé˜¶æ®µæ„å»ºçš„å®é™…æ„ä¹‰äº†ã€‚ä¸è¿‡ï¼Œå› ä¸ºä¸Šé¢çš„ Dockerfile è¿˜å¯ä»¥åšè¿›ä¸€æ­¥çš„ä¼˜åŒ–ï¼Œæˆ‘è¿˜æƒ³å†æ’æ’­ä¸€ä¸ªçŸ¥è¯†ç‚¹ã€‚æ¯”å¦‚ï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µçš„æ„å»ºè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å…ˆæ˜¯ç”¨ COPY . .  çš„æ–¹å¼æ‹·è´äº†æºç ï¼Œåˆè¿›è¡Œäº†ç¼–è¯‘ï¼Œè¿™ä¼šäº§ç”Ÿä¸€ä¸ªç¼ºç‚¹ï¼Œé‚£å°±æ˜¯å¦‚æœåªæ˜¯æºç å˜äº†ï¼Œä½†ä¾èµ–å¹¶æ²¡æœ‰å˜ï¼ŒDocker å°†æ— æ³•å¤ç”¨ä¾èµ–çš„é•œåƒå±‚ç¼“å­˜ã€‚åœ¨å®é™…æ„å»ºè¿‡ç¨‹ä¸­ï¼Œä½ ä¼šå‘ç° Docker æ¯æ¬¡éƒ½ä¼šé‡æ–°ä¸‹è½½ Golang ä¾èµ–ã€‚</p><p>è¿™å°±å¼•å‡ºäº†å¦å¤–ä¸€ä¸ªæ„å»ºé•œåƒçš„å°æŠ€å·§ï¼š<strong>å°½é‡ä½¿ç”¨ Docker æ„å»ºç¼“å­˜</strong>ã€‚</p><p>è¦ä½¿ç”¨ Golang ä¾èµ–çš„ç¼“å­˜ï¼Œæœ€ç®€å•çš„åŠæ³•æ˜¯ï¼šå…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼Œå†ä¸‹è½½ä¾èµ–ï¼Œæœ€åå†å¤åˆ¶æºç è¿›è¡Œç¼–è¯‘ã€‚åŸºäºè¿™ç§æ€è·¯ï¼Œæˆ‘ä»¬å¯ä»¥å°†ç¬¬ä¸€é˜¶æ®µçš„æ„å»ºä¿®æ”¹å¦‚ä¸‹ã€‚</p><pre><code class="language-yaml"># Step 1: build golang binary
FROM golang:1.17 as builder
WORKDIR /opt/app
COPY go.* ./
RUN go mod download
COPY . .
RUN go build -o example
</code></pre><p>è¿™æ ·ï¼Œåœ¨æ¯æ¬¡ä»£ç å˜æ›´è€Œä¾èµ–ä¸å˜çš„æƒ…å†µä¸‹ï¼ŒDocker éƒ½ä¼šå¤ç”¨ç¬¬ 4 è¡Œå’Œç¬¬ 5 è¡Œäº§ç”Ÿçš„æ„å»ºç¼“å­˜ï¼Œè¿™å¯ä»¥åŠ é€Ÿé•œåƒæ„å»ºè¿‡ç¨‹ã€‚</p><h2>æ€»ç»“</h2><p>å¥½äº†ï¼Œæ€»ç»“ä¸€ä¸‹ã€‚è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¥æ„å»º Golang é•œåƒä¸ºä¾‹å­ï¼Œå‘ä½ å±•ç¤ºäº†å‡å°é•œåƒä½“ç§¯çš„å…·ä½“æ–¹æ³•ï¼Œä¸ç®¡æ˜¯æœ€å¸¸è§çš„æ›´æ¢åŸºç¡€é•œåƒï¼Œè¿˜æ˜¯å¤šé˜¶æ®µæ„å»ºï¼Œéƒ½å¯ä»¥æœ‰æ•ˆåœ°å‡å°é•œåƒä½“ç§¯ã€‚ä½†æ˜¯ä¸åŒæ„å»ºæ–¹æ³•å¯¹åº”çš„é•œåƒå¤§å°ä»ç„¶æœ‰å¾ˆå¤§å·®å¼‚ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/13/43/1328023a2be4dcb5848d2e898c06b743.jpg?wh=1920x921" alt="å›¾ç‰‡"></p><p>æ›´æ¢åŸºç¡€é•œåƒæ˜¯ä¸€ä¸ªç®€å•å¿«é€Ÿçš„æ–¹æ³•ï¼Œä½†è¿™ç§æ–¹æ³•èŠ‚çœçš„ç©ºé—´æœ‰é™ï¼Œå°¤å…¶æ˜¯å¯¹äºç¼–è¯‘å‹çš„è¯­è¨€æ¥è¯´ï¼Œå› ä¸ºåœ¨ç¼–è¯‘è¿‡ç¨‹éœ€è¦ç¼–è¯‘å·¥å…·é“¾çš„æ”¯æŒï¼Œä½†è¿™äº›å·¥å…·é“¾åªåœ¨ç¼–è¯‘è¿‡ç¨‹æœ‰ç”¨ï¼Œå› æ­¤å½“å¯åŠ¨é•œåƒæ—¶ï¼Œè¿™äº›å·¥å…·é™¤äº†å ç”¨ç©ºé—´ä»¥å¤–æ²¡æœ‰ä»»ä½•å®é™…çš„ä½œç”¨ã€‚</p><p>ä¸ºäº†è¿›ä¸€æ­¥ç¼©å°é•œåƒçš„ä½“ç§¯ï¼Œæˆ‘ä¸ºä½ ä»‹ç»äº†å¤šé˜¶æ®µé•œåƒæ„å»ºæ–¹æ³•ï¼Œå®ƒå·§å¦™åœ°å°†æ„å»ºå’Œè¿è¡Œç¯å¢ƒæ‹†åˆ†å¼€æ¥ï¼Œå¤§å¤§ç¼©å°äº†æœ€ç»ˆç”Ÿæˆçš„é•œåƒä½“ç§¯ã€‚<strong>åœ¨å®é™…å·¥ä½œä¸­ï¼Œæˆ‘å¼ºçƒˆæ¨èä½ ä½¿ç”¨å®ƒã€‚</strong></p><p>å¦å¤–ï¼Œæˆ‘è¿˜åœ¨å¤šé˜¶æ®µæ„å»ºä»‹ç»äº†ä¸€ç§å°½é‡åˆ©ç”¨ Docker ç¼“å­˜çš„æ„å»ºæŠ€å·§ï¼Œè™½ç„¶è¿™ç§æ–¹æ³•å¯¹äºç¼©å°é•œåƒæ²¡æœ‰å¸®åŠ©ï¼Œä½†å®ƒèƒ½å¤ŸåŠ å¿«é•œåƒæ„å»ºçš„é€Ÿåº¦ã€‚</p><p>ä¸è¿‡è¦å¼ºè°ƒçš„æ˜¯ï¼Œé•œåƒå¹¶ä¸æ˜¯è¶Šå°è¶Šå¥½ï¼Œæˆ‘ä»¬éœ€è¦åŒæ—¶å…¼é¡¾é•œåƒçš„å¯è°ƒè¯•ã€å®‰å…¨ã€å¯ç»´æŠ¤æ€§ç­‰è§’åº¦æ¥é€‰æ‹©åŸºç¡€é•œåƒï¼Œå¹¶å°†é•œåƒå¤§å°æ§åˆ¶åœ¨åˆç†çš„èŒƒå›´å†…ã€‚</p><p>æˆ‘ä¼šåœ¨ä¸‹ä¸€èŠ‚è¯¾è¯¦ç»†ä»‹ç»ä¸åŒåŸºç¡€é•œåƒä¹‹é—´çš„å·®å¼‚ä»¥åŠå¦‚ä½•é€‰æ‹©å®ƒä»¬ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åï¼Œç»™ä½ ç•™ä¸¤é“æ€è€ƒé¢˜å§ã€‚</p><ol>
<li>è¯·ä½ å°è¯•å°† Dockerfile-6 æ–‡ä»¶çš„ 13 è¡Œ CMD [â€œ/opt/app/exampleâ€] ä¿®æ”¹æˆ CMD /opt/app/exampleï¼Œé‡æ–°æ„å»ºé•œåƒåä½¿ç”¨ docker run å¯åŠ¨å®ƒï¼Œä½ ä¼šå¾—åˆ°ä»€ä¹ˆä¿¡æ¯ï¼Ÿåˆä¸ºä»€ä¹ˆè¿™ä¸¤ç§å†™æ³•ä¼šæœ‰å·®å¼‚å‘¢ï¼Ÿ</li>
<li>å¦‚æœä½ ç†Ÿæ‚‰ Golangï¼Œè¯·ä½ å°è¯•åˆ é™¤ Dockerfile-5 æ–‡ä»¶ç¬¬ 7 è¡Œçš„ CGO_ENABLED=0ï¼Œé‡æ–°æ„å»ºé•œåƒå¹¶å¯åŠ¨å®ƒï¼Œä½ ä¼šå¾—åˆ°ä»€ä¹ˆä¿¡æ¯ï¼Ÿæ­¤æ—¶ï¼Œå¦‚æœå†å°†ç¬¬ 10 è¡Œçš„ FROM alpine æ›¿æ¢ä¸º ubuntu é‡æ–°æ„å»ºå¹¶å¯åŠ¨å‘¢ï¼Ÿç»“åˆ Alpine é•œåƒçš„ç‰¹ç‚¹ï¼Œè¯·ä½ å°è¯•è§£é‡Šä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§ç°è±¡ï¼Ÿ</li>
</ol><p>æ¬¢è¿ä½ ç»™æˆ‘ç•™è¨€äº¤æµè®¨è®ºï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/23/52/66/3e4d4846.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>includestdio.h</span>
  </div>
  <div class="_2_QraFYR_0">1.ä¸åŠ []ä»£è¡¨ç”¨ &#47;bin&#47;sh æ‰§è¡Œ &#47;opt&#47;app&#47;example ï¼Œç”±äº scratch æ˜¯ç©ºé•œåƒï¼Œæ‰€ä»¥ä¼šæŠ¥é”™ï¼šexec: &quot;&#47;bin&#47;sh&quot;: stat &#47;bin&#47;sh: no such file or directory: unknown.ï¼ˆåŠ []ä»£è¡¨ä¸º ENTRYPOINT æä¾›å‚æ•°ï¼‰<br><br>2.å»æ‰ CGO_ENABLED=0 å¯åŠ¨å®¹å™¨åä¼šæç¤ºï¼šexec user process caused: no such file or directoryï¼Œalpine æ›´æ¢ ubuntu åè¿è¡Œæ­£å¸¸ã€‚åŸå› ï¼šå› ä¸º alpine é•œåƒä¸­æ²¡æœ‰ glibc ï¼Œä¸ç¦ç”¨ CGO çš„è¯ç¼–è¯‘ä¼šå¤±è´¥ï¼Œä¸ä¼šäº§ç”ŸäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‰€ä»¥æœ€ç»ˆCMD [&quot;&#47;opt&#47;app&#47;example&quot;] ä¼šæŠ¥é”™ï¼šno such file or directoryï¼ˆè€Œ ubuntu æœ¬èº«åŒ…å« glibc ï¼Œä¸ç¦ç”¨ CGO ç¼–è¯‘ä¹Ÿæ˜¯æ­£å¸¸çš„ï¼‰</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ğŸ‘ğŸ»éå¸¸æ­£ç¡®ï¼</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-01-09 09:16:50</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/a3/49/4a488f4c.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å†œæ°‘å›­ä¸</span>
  </div>
  <div class="_2_QraFYR_0">è¯·é—®è€å¸ˆï¼Œspring-bootçš„æ„å»ºæ–¹æ³•ç¯èƒ½ä¼˜åŒ–å—ï¼Ÿä¹‹å‰çš„å äº†284MBã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å¯ä»¥çš„ï¼Œä¸‹ä¸€èŠ‚è¯¾çš„å†…å®¹æœ‰æåˆ°ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-01-09 19:19:11</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/9d/84/171b2221.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>jeffery</span>
  </div>
  <div class="_2_QraFYR_0">é—®é¢˜1 æ›´æ”¹å image å¯ä»¥æ­£å¸¸æ„å»º ä½†runæŠ¥é”™<br>docker: Error response from daemon: failed to create shim: OCI runtime create failed: runc create failed: unable to start container process: exec: &quot;&#47;bin&#47;sh&quot;: stat &#47;bin&#47;sh: no such file or directory: unknown.<br>ERRO[0000] error waiting for container: context canceled <br>é—®é¢˜2 åˆ é™¤CGO_ENABLED=0 åå¯åŠ¨<br>docker run --publish 8080:8080 delete<br>exec &#47;opt&#47;app&#47;example: no such file or directory<br>é•œåƒæ„å»ºåå¤§å°<br>delete                          latest                  d968f205c52d   8 minutes ago    13.9MB<br>delete1                         latest                  cb6a0e65cda9   34 minutes ago   84.7MB<br>Alpine  ä¸å¸¦å¸¸è§„debug å‘½ä»¤<br></div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ğŸ‘ğŸ»å¯ä»¥ç»§ç»­æ·±å…¥è°ƒæŸ¥ä¸€ä¸‹ç¬¬ä¸€ä¸ªé—®é¢˜ä¸ºä»€ä¹ˆä¸¤ç§å†™æ³•ä¼šæœ‰å·®å¼‚ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-01-09 08:54:57</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/23/ac/06/5025dcd4.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Kyle</span>
  </div>
  <div class="_2_QraFYR_0">è¿™ä¸€æœŸå¬å¾—ç›¸å½“çˆ½ï¼Œå¯ä»¥è¯´æ˜¯æè‡´çš„ä½“ç§¯ä¼˜åŒ–äº†</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ„Ÿè°¢å¯¹è¯¾ç¨‹çš„è®¤å¯ï¼</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-04-20 19:31:23</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/cf/dc/f119f657.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>0ck0</span>
  </div>
  <div class="_2_QraFYR_0">æ¯”è¾ƒå…³å¿ƒ python ä¸šåŠ¡çš„é•œåƒå¦‚ä½•ä¼˜åŒ–</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ä¸‹ä¸€è®²é‡Œæœ‰æåˆ°ï¼Œä¸»è¦æ˜¯é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-01-11 16:43:01</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/14/64/08/0287f41f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>äº‰å…‰ Alan</span>
  </div>
  <div class="_2_QraFYR_0"> Alpine èƒ½å‹ç¼©å¤§å°ï¼Œä½†ä¹Ÿä¼šå¼•å…¥å¾ˆå¤šé—®é¢˜<br>1. æ–°çš„æ“ä½œç³»ç»Ÿçš„å®‰å…¨è¡¥ä¸ç»´æŠ¤<br>2. bugï¼Œæ¯”å¦‚glibcçš„å¯¼è‡´çš„å¾ˆå¤šé—®é¢˜<br><br><br>è¿™ä¸€å—å†å…·ä½“è½åœ°çš„æ—¶å€™æ€ä¹ˆæŠ‰æ‹©å‘¢ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ˜¯çš„ï¼ŒAlpine çš„c è¯­è¨€åº“å·®å¼‚ä¼šå¯¼è‡´å¾ˆå¤šå¥‡æ€ªçš„é—®é¢˜ã€‚<br><br>ç”Ÿäº§å®è·µä¸Šè¿˜æ˜¯æ¨èç”¨æ ‡å‡†çš„ Linux å‘è¡Œç‰ˆé•œåƒï¼Œæ¯”å¦‚ ubuntuï¼Œdebian ä¹‹ç±»çš„ï¼Œæ­¤å¤–ï¼Œslim ç‰ˆæœ¬çš„é•œåƒåœ¨å¤§éƒ¨åˆ†åœºæ™¯å·²ç»å¾ˆå°äº†ï¼Œæ²¡å¿…è¦è¿½æ±‚æé™çš„é•œåƒå¤§å°ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-01-10 21:55:35</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/14/54/21/0bac2254.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æ©™æ±</span>
  </div>
  <div class="_2_QraFYR_0">æˆ‘è‰¹ scrtchæ˜¯ä»€ä¹ˆï¼Œç«Ÿç„¶è¿˜æœ‰è¿™ç§é•œåƒ å­¦åˆ°äº†ï¼Œç›®å‰é¡¹ç›®ç”¨å•¥é•œåƒçš„éƒ½æœ‰ debian alpine ubuntu çœŸæ˜¯ä¹±ä¸ƒå…«ç³Ÿçš„ï¼Œé•œåƒå°±æ˜¯è¿˜ç¼ºç‚¹åŸºç¡€å·¥å…· æ¯”å¦‚ping ip ç­‰è¿™äº›ä¸åŒåº•åŒ…é‡Œé¢çš„åŸºç¡€åŒ…ä¹Ÿä¸åŒï¼Œå®‰è£…åé•œåƒå…¶å®ä¹ŸæŒºå¤§ï¼Œè¿˜æ¯”è¾ƒæœŸå¾…å‘¨ä¸‰ alpineçš„glibcå’Œmä»€ä¹ˆçš„ä¹‹å‰å°±ä¸€ç›´æ²¡æ‡‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-01-09 09:33:13</div>
  </div>
</div>
</div>
</li>
</ul>