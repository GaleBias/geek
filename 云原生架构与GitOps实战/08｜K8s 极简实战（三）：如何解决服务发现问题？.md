<audio title="08ï½œK8s æç®€å®æˆ˜ï¼ˆä¸‰ï¼‰ï¼šå¦‚ä½•è§£å†³æœåŠ¡å‘ç°é—®é¢˜ï¼Ÿ" src="https://static001.geekbang.org/resource/audio/2c/7f/2c2f05a23cf7bb27a3e4c87f3faa407f.mp3" controls="controls"></audio> 
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ç‹ç‚œã€‚</p><p>ä¸Šä¸€èŠ‚è¯¾ï¼Œæˆ‘å¸¦ä½ è®¤è¯†äº† K8s çš„å‡ ç§å·¥ä½œè´Ÿè½½ï¼Œå®ƒä»¬åŒ…æ‹¬ Deploymentã€StatefulSetã€DaemonSetã€Job å’Œ CronJobã€‚å…¶ä¸­ï¼ŒDeployment æ˜¯æˆ‘ä»¬åœ¨å®é™…å·¥ä½œä¸­æœ€å¸¸ç”¨çš„ä¸€ç§å·¥ä½œè´Ÿè½½ç±»å‹ã€‚</p><p>ç°ä»£ä¸šåŠ¡åº”ç”¨å‘å±•è‡³ä»Šï¼Œå¤§éƒ¨åˆ†ç³»ç»Ÿéƒ½é€æ¸å‘å±•æˆä¸ºäº†å¤§å‹çš„åˆ†å¸ƒå¼å¾®æœåŠ¡åº”ç”¨ã€‚æ¯ä¸€ä¸ªå¾®æœåŠ¡å„å¸å…¶èŒï¼Œç”¨æˆ·çš„ä¸€ä¸ªè¯·æ±‚å¾€å¾€éœ€è¦ç”±å¤šä¸ªå¾®æœåŠ¡ä¹‹é—´ç›¸äº’è°ƒç”¨æ‰èƒ½å¤Ÿå®Œæˆã€‚å½“åº”ç”¨è¿ç§»åˆ° K8s æ—¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå°†ä¸šåŠ¡ç³»ç»Ÿä¸­çš„æ¯ä¸€ä¸ªå¾®æœåŠ¡ä»¥æŸç§ K8s å·¥ä½œè´Ÿè½½çš„å½¢å¼è¿›è¡Œéƒ¨ç½²ï¼Œæ¯”å¦‚æœ€å¸¸è§çš„ Deploymentã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>åœ¨ K8s ç¯å¢ƒä¸‹ï¼Œå¾®æœåŠ¡ä¹‹é—´çš„è°ƒç”¨å¯ä»¥ç†è§£ä¸ºæ˜¯å·¥ä½œè´Ÿè½½ä¹‹é—´çš„è°ƒç”¨ã€‚</strong></p><p><strong>æ¢å¥è¯è¯´ï¼Œåœ¨ K8s ç¯å¢ƒä¸‹ï¼Œå¾®æœåŠ¡ä¹‹é—´çš„è°ƒç”¨å®é™…ä¸Šæ˜¯ Pod ä¹‹é—´çš„è°ƒç”¨ã€‚</strong></p><p>è¦è®© Pod ä¹‹é—´èƒ½å¤Ÿé¡ºåˆ©ç›¸äº’è°ƒç”¨ï¼Œæˆ‘ä»¬é¢ä¸´ä¸¤ä¸ªé‡è¦çš„æŒ‘æˆ˜ï¼š</p><ul>
<li>Pod ä¹‹é—´å¦‚ä½•æ‰¾åˆ°å¯¹æ–¹ï¼Ÿ</li>
<li>Pod åœ¨é‡å¯ã€æ›´æ–°ã€é”€æ¯çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚ä½•ç¡®ä¿ Pod ä¹‹é—´çš„è°ƒç”¨ä¸å—å½±å“ï¼Ÿ</li>
</ul><p>è¿™ä¸¤ä¸ªæŒ‘æˆ˜å®é™…ä¸Šéƒ½å¯ä»¥å½’ç»“ä¸ºåŒä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯<strong>æœåŠ¡å‘ç°</strong>ã€‚è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹ K8s åŸç”Ÿçš„æœåŠ¡å‘ç°æœºåˆ¶ï¼š<strong>Service</strong>ã€‚</p><p>æˆ‘è¿˜æ˜¯ä»ç¤ºä¾‹åº”ç”¨å‡ºå‘ï¼Œé‡ç‚¹å‘ä½ ä»‹ç» Service åˆ°åº•æ˜¯å¦‚ä½•å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜çš„ã€‚Service åœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸­å‡ºç°çš„é¢‘ç‡éå¸¸é«˜ï¼Œåœ¨å°†åº”ç”¨è¿ç§»åˆ° K8s çš„è¿‡ç¨‹ä¸­ï¼Œä½ ä¹Ÿä¸€å®šä¼šç”¨åˆ°è¿™ä¸ªå¯¹è±¡ã€‚æ‰€ä»¥ï¼Œæˆ‘å¸Œæœ›ä½ èƒ½å¤šèŠ±ç‚¹æ—¶é—´æ¥å­¦ä¹ è¿™èŠ‚è¯¾ã€‚</p><!-- [[[read_end]]] --><p>åœ¨å¼€å§‹å®è·µä¹‹å‰ï¼Œä½ éœ€è¦ç¡®ä¿å·²ç»æŒ‰ç…§æœ¬ç« çš„ç¬¬ä¸€è®²<a href="https://time.geekbang.org/column/article/614570">â€œç¤ºä¾‹åº”ç”¨ä»‹ç»â€</a>çš„å¼•å¯¼åœ¨æœ¬åœ° Kind é›†ç¾¤éƒ¨ç½²äº†ç¤ºä¾‹åº”ç”¨ã€‚</p><h2>Pod ä¹‹é—´å¦‚ä½•é€šä¿¡ï¼Ÿ</h2><h3>IP åœ°å€é€šä¿¡</h3><p>å¥½äº†ï¼Œæ¥ä¸‹æ¥ï¼Œè¯·ä½ å›ç­”ä¸€ä¸ªé—®é¢˜ã€‚å¦‚æœæŠŠ Pod å½“åšæ˜¯è¿è¡Œä¸šåŠ¡è¿›ç¨‹çš„è™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºä¹‹é—´è¦å¦‚ä½•é€šä¿¡ï¼Ÿ</p><p>æ˜¾ç„¶ï¼Œå¦‚æœè™šæ‹Ÿæœºå¤„äºåŒä¸€ä¸ª VPC ç½‘ç»œä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å†…ç½‘åœ°å€è¿›è¡Œè®¿é—®ï¼Œå¦‚æœä¸åœ¨åŒä¸€ä¸ª VPC ç½‘ç»œä¸‹ï¼Œæˆ‘ä»¬åˆ™å¯ä»¥ä½¿ç”¨å¤–ç½‘åœ°å€è¿›è¡Œè®¿é—®ã€‚</p><p>è€Œåœ¨ K8s é‡Œï¼Œæ¯ä¸€ä¸ª Pod å°±åƒè™šæ‹Ÿæœºä¸€æ ·éƒ½æ‹¥æœ‰ä¸€ä¸ªå”¯ä¸€çš„å†…ç½‘ IP åœ°å€ã€‚é€šè¿‡ IP åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥å®ç° Pod ä¹‹é—´çš„ç›¸äº’è°ƒç”¨ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä»ç„¶ä»¥ç¤ºä¾‹åº”ç”¨ä¸ºä¾‹ï¼Œè¿›ä¸€æ­¥éªŒè¯è¿™ä¸ªæƒ³æ³•ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬è·å–ç¤ºä¾‹åº”ç”¨åç«¯æœåŠ¡ Pod çš„ IPï¼Œå®ƒä»¬ä½äº example å‘½åç©ºé—´ä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ kubectl get pod -o wide å‘½ä»¤æ¥è·å–ï¼š</p><pre><code class="language-yaml">$ kubectl get pods --selector=app=backend -n example -o wide
NAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;READY&nbsp; &nbsp;STATUS&nbsp; &nbsp; RESTARTS&nbsp; &nbsp;AGE&nbsp; &nbsp;IP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NODE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;NOMINATED NODE&nbsp; &nbsp;READINESS GATES
backend-595666f99c-6b92g&nbsp; &nbsp;1/1&nbsp; &nbsp; &nbsp;Running&nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 14m&nbsp; &nbsp;10.244.0.10&nbsp; &nbsp;kind-control-plane&nbsp; &nbsp;&lt;none&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;none&gt;
backend-595666f99c-ppnc4&nbsp; &nbsp;1/1&nbsp; &nbsp; &nbsp;Running&nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 41s&nbsp; &nbsp;10.244.0.13&nbsp; &nbsp;kind-control-plane&nbsp; &nbsp;&lt;none&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;none&gt;
</code></pre><p>ä»è¿”å›ç»“æœä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Pod çš„ IP åœ°å€ä¿¡æ¯ã€‚ä¸ºäº†éªŒè¯ Pod ä¹‹é—´å¯ä»¥ä½¿ç”¨ IP åœ°å€è¿›è¡Œé€šä¿¡ï¼Œæˆ‘ä»¬å°è¯•è¿›å…¥åˆ°å‰ç«¯æœåŠ¡çš„ Podï¼Œç„¶åé€šè¿‡ wget æ¥è®¿é—®åç«¯æœåŠ¡ Pod çš„ä¸šåŠ¡æ¥å£ï¼Œä»¥æ­¤æ¥æ¨¡æ‹Ÿå‰ç«¯æœåŠ¡è¯·æ±‚åç«¯æœåŠ¡çš„è¿‡ç¨‹ã€‚ä½ å¯ä»¥ä½¿ç”¨ kubectl exec æ¥è·å–å‰ç«¯ Pod çš„å®¹å™¨ç»ˆç«¯ï¼š</p><pre><code class="language-yaml">$ kubectl exec -it $(kubectl get pods --selector=app=frontend -n example -o jsonpath="{.items[0].metadata.name}") -n example -- sh
/frontend # wget -O - http://10.244.0.10:5000/healthy
Connecting to 10.244.0.10:5000 (10.244.0.10:5000)
writing to stdout
{"healthy":true}
</code></pre><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åœ¨å‰ç«¯å®¹å™¨é‡Œä½¿ç”¨ wget è¯·æ±‚äº† IP ä¸º 10.244.0.10 çš„ Podï¼Œä¹Ÿå°±æ˜¯åç«¯æœåŠ¡ç¬¬ä¸€ä¸ª Pod backend-595666f99c-6b92g çš„ healthy æ¥å£ã€‚æ³¨æ„ï¼Œå› ä¸ºåœ¨å®¹å™¨é‡Œ Python ç¨‹åºç›‘å¬äº† 5000 ç«¯å£ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¯·æ±‚çš„ IP åœ°å€åé¢å¢åŠ äº†ç«¯å£å·ã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿”å›çš„ JSON ä¸º {â€œhealthyâ€:true} ï¼Œè¯´æ˜å‰ç«¯çš„ Pod å·²ç»æˆåŠŸå‘ IP ä¸º 10.244.0.10 çš„åç«¯ Pod å‘èµ·äº†è¯·æ±‚ã€‚</p><p>ä½ å¯èƒ½ä¼šé—®ï¼Œæ—¢ç„¶ Pod ä¹‹é—´å¯ä»¥é€šè¿‡ IP é€šä¿¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯ä¸æ˜¯åªéœ€è¦åœ¨ç¨‹åºé‡Œé¢å¯¹éœ€è¦è°ƒç”¨çš„ Pod çš„ IP è¿›è¡Œç¡¬ç¼–ç å°±å¯ä»¥äº†ï¼Ÿ<strong>ç„¶è€Œå¹¶ä¸æ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ã€‚</strong></p><p>ç°åœ¨ï¼Œæˆ‘ä»¬é¦–å…ˆä½¿ç”¨ exit å‘½ä»¤é€€å‡ºå‰ç«¯ Pod çš„ç»ˆç«¯ï¼Œè¿”å›å®¿ä¸»æœºç»ˆç«¯ï¼š</p><pre><code class="language-yaml">/frontend # exit
</code></pre><p>ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ kubectl delete pod æ¥åˆ é™¤ç¬¬ä¸€ä¸ª Pod backend-595666f99c-6b92gï¼š</p><pre><code class="language-yaml">$ kubectl delete pods backend-595666f99c-6b92g -n example
pod "backend-595666f99c-6b92g" deleted
</code></pre><p>æ¥ä¸‹æ¥ï¼Œé‡æ–°è·å–åç«¯æœåŠ¡çš„æ‰€æœ‰ Podï¼š</p><pre><code class="language-yaml">$ kubectl get pods --selector=app=backend -n example -o wide
NAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;READY&nbsp; &nbsp;STATUS&nbsp; &nbsp; RESTARTS&nbsp; &nbsp;AGE&nbsp; &nbsp;IP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NODE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;NOMINATED NODE&nbsp; &nbsp;READINESS GATES
backend-595666f99c-kfdmm&nbsp; &nbsp;1/1&nbsp; &nbsp; &nbsp;Running&nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 42s&nbsp; &nbsp;10.244.0.20&nbsp; &nbsp;kind-control-plane&nbsp; &nbsp;&lt;none&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;none&gt;
backend-595666f99c-ppnc4&nbsp; &nbsp;1/1&nbsp; &nbsp; &nbsp;Running&nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 28m&nbsp; &nbsp;10.244.0.13&nbsp; &nbsp;kind-control-plane&nbsp; &nbsp;&lt;none&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;none&gt;
</code></pre><p>æˆ‘ä»¬ä¼šå‘ç°ï¼Œåœ¨åˆ é™¤äº†ç¬¬ä¸€ä¸ª Pod backend-595666f99c-6b92g ä¹‹åï¼ŒReplicaSet é‡æ–°åˆ›å»ºäº†ä¸€ä¸ª Podï¼Œåå­—æ˜¯ backend-595666f99c-kfdmmã€‚åŒæ—¶ï¼ŒIP åœ°å€ç”±åŸæ¥çš„ 10.244.0.10 å˜æˆäº† 10.244.0.20ã€‚</p><p><strong>è¿™è¯´æ˜ Pod çš„ IP æ˜¯ä¸ç¨³å®šçš„ï¼Œ</strong>æˆ‘ä»¬ä¸èƒ½æŠŠ Pod IP ç”¨ä½œæœåŠ¡ä¹‹é—´çš„è°ƒç”¨åœ°å€ã€‚</p><p>é‚£æ€ä¹ˆæ‰èƒ½è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿåœ¨è§£ç­”è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆè¯·ä½ å›ç­”ä¸€ä¸ªé—®é¢˜ï¼šäº’è”ç½‘åŸŸåé™¤äº†å¥½è®°ã€æ–¹ä¾¿è®¿é—®ï¼Œè¿˜æœ‰ä»€ä¹ˆåŠŸèƒ½ï¼Ÿ</p><p>å¯¹ï¼Œå°±æ˜¯ <strong>DNS è§£æã€‚</strong>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨è®¿é—®ä¸€ä¸ªåŸŸåçš„æ—¶å€™ï¼ŒDNS æœåŠ¡å™¨é¦–å…ˆä¼šè§£æ IP åœ°å€ï¼Œå¹¶ä¸”è§£æçš„ IP åœ°å€æˆ‘ä»¬æ˜¯å¯ä»¥éšæ—¶æ›´æ¢çš„ã€‚è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯ï¼Œå½“æˆ‘ä»¬åšæ¶æ„è¿ç§»å°¤å…¶æ˜¯å½“ç½‘å…³ IP å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ç”¨æ–°çš„ IP æ›¿æ¢æ—§çš„ IP åœ°å€å°±å¯ä»¥äº†ã€‚è¿™æ ·ä¸€æ¥ï¼Œç”¨æˆ·æ°¸è¿œåªéœ€è¦å…³æ³¨åŸŸåå³å¯ï¼Œä¸éœ€è¦å…³æ³¨åŸŸåèƒŒåè®¿é—®çš„æ˜¯ä»€ä¹ˆ IP åœ°å€æˆ–å“ªå°æœåŠ¡å™¨ã€‚</p><p>å†è¯´å› K8sï¼Œé‚£æˆ‘ä»¬æ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥å€Ÿé‰´è¿™ç§æ€æƒ³ï¼Œåœ¨å‘å‡ºè¯·æ±‚æ—¶ä¸ç›´æ¥è®¿é—® Pod çš„ IPï¼Œè€Œæ˜¯è®¿é—®ä¸€ä¸ªåŸŸåï¼Œç„¶åå°†è¿™ä¸ªåŸŸåè¿›ä¸€æ­¥è§£ææˆ Pod çš„ IPï¼Œå®Œæˆåç»­è®¿é—®ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œå®ƒå°±æ˜¯ K8s Serviceã€‚</p><h2>Serviceï¼šåŸç”Ÿçš„æœåŠ¡å‘ç°æœºåˆ¶</h2><p>ä¸ºäº†è§£å†³ Pod IP ä¸ç¨³å®šçš„é—®é¢˜ï¼ŒService å°†ä¸€ç»„æ¥è‡ªåŒä¸€ä¸ª ReplicaSet åˆ›å»ºçš„ Pod ç»„åˆåœ¨ä¸€èµ·ï¼Œå¹¶æä¾› DNS çš„è®¿é—®èƒ½åŠ›ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒPod ä¹‹é—´å¯ä»¥é€šè¿‡ Service åŸŸåæ¥è¿›è¡Œè®¿é—®ï¼Œè¿™ç§è®¿é—®æ–¹å¼çš„å¥½å¤„æ˜¯ï¼Œæ— è®º Service èƒŒåä¸€ç»„çš„ Pod å¦‚ä½•å˜åŒ–ï¼Œå¯¹äºå…¶ä»–æœåŠ¡æ¥è¯´éƒ½æ˜¯é€æ˜çš„ï¼ŒæœåŠ¡åªéœ€è¦å…³æ³¨è®¿é—® Service å³å¯ï¼Œä¸ç”¨å…³å¿ƒè¿™ä¸ªæœåŠ¡æ˜¯ç”±å“ªä¸ª Pod æä¾›çš„ã€‚</p><p>è¿™ç§é›†ç¾¤å†…éƒ¨çš„ DNS èƒ½åŠ›éå¸¸é‡è¦ï¼Œå®ƒé™¤äº†èƒ½ä¸ºæˆ‘ä»¬æä¾›ç¨³å®šçš„è®¿é—®èƒ½åŠ›ï¼Œè¿˜èƒ½å¤Ÿæä¾›è´Ÿè½½å‡è¡¡å’Œä¼šè¯ä¿æŒçš„èƒ½åŠ›ã€‚Service çš„å·¥ä½œåŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://static001.geekbang.org/resource/image/46/5e/462a27fefc0f8a2b837b69c8420c4a5e.jpg?wh=1823x1230" alt="å›¾ç‰‡"></p><p>è§£é‡Šä¸€ä¸‹ã€‚Service åŒæ ·åœ¨é›†ç¾¤å†…æ‹¥æœ‰å”¯ä¸€çš„ IP åœ°å€ï¼Œå¹¶ä¸”è¿™ä¸ª IP æ˜¯ç¨³å®šçš„ã€‚æ­¤å¤–ï¼ŒService æœ¬èº«å¹¶æ²¡æœ‰ç›´æ¥æä¾›æœåŠ¡å‘ç°çš„èƒ½åŠ›ï¼Œå®ƒéœ€è¦å€ŸåŠ© Endpoints æ¥å®ç°ã€‚Endpoints è®°å½•äº†ä¸€ç»„ Pod çš„ IP åœ°å€ï¼ŒService åªéœ€è¦æŸ¥çœ‹è‡ªèº«æ‰€å¯¹åº”çš„ Endpoints ä¾¿èƒ½å¤Ÿæ‰¾åˆ°å…·ä½“çš„ Podã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæ— è®º Pod æ€ä¹ˆå˜ï¼ŒEndpoints éƒ½ä¼šå®æ—¶æ›´æ–°å®ƒå…³è”çš„ Pod IPï¼Œè¿™æ ·å°±å®ç°äº†æœåŠ¡å‘ç°çš„åŠŸèƒ½ã€‚</p><p>å€ŸåŠ© Service çš„æœåŠ¡å‘ç°å’Œç¨³å®šçš„ IP åœ°å€èƒ½åŠ›ï¼Œ<strong>æˆ‘ä»¬è®¿é—® Service IP å°±ç›¸å½“äºè®¿é—® Service æ‰€å…³è”çš„ Podã€‚</strong></p><h3><strong>ç¤ºä¾‹åº”ç”¨ï¼šService ç¤ºä¾‹</strong></h3><p>ç°åœ¨ï¼Œæˆ‘ä»¬å›åˆ°ç¤ºä¾‹åº”ç”¨ã€‚åœ¨<a href="https://time.geekbang.org/column/article/614570">â€œç¤ºä¾‹åº”ç”¨ä»‹ç»â€</a>ä¸­ï¼Œæˆ‘ä»¬å·²ç»æŠŠå‰åç«¯çš„ Service éƒ¨ç½²åˆ°äº†é›†ç¾¤ï¼Œè¿™é‡Œæˆ‘ä»¥ç¤ºä¾‹åº”ç”¨çš„åç«¯ Service ä¸ºä¾‹ï¼Œä¸ºä½ è¿›ä¸€æ­¥ä»‹ç» Serviceã€‚</p><p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ¥ä¸€èµ·çœ‹ä¸€ä¸‹ Service Manifest çš„å†…å®¹ï¼š</p><pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: backend-service
  labels:
    app: backend
spec:
  type: ClusterIP
  sessionAffinity: None
  selector:
    app: backend
  ports:
  - port: 5000
    targetPort: 5000
</code></pre><p>è¿™é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ selector å­—æ®µï¼Œè¿™æ˜¯ä¸€ä¸ª Pod é€‰æ‹©å™¨ï¼Œè¿™ä¸ªå­—æ®µè¡¨ç¤ºé€šè¿‡ Label åŒ¹é… Podï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œåªè¦æ˜¯ Label åŒ…å« app=backend çš„ Pod ï¼Œéƒ½ä¼šè¢«å½“æˆæ˜¯ backend-service çš„åŒä¸€ç»„é€»è¾‘ Podã€‚</p><p>è¿˜è®°å¾—æˆ‘ä»¬åç«¯çš„ Deployment Manifest å—ï¼ŸDeployment å®šä¹‰çš„ Pod Label å’Œè¿™é‡Œçš„ selector Label æ˜¯å¯¹åº”çš„ã€‚è¿™æ ·ï¼Œbackend-service å°±èƒ½å¤Ÿé€šè¿‡ Label æ ‡ç­¾æ¥åŒ¹é… backend Deployment åˆ›å»ºçš„æ‰€æœ‰ Pod å‰¯æœ¬äº†ï¼š</p><pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  ......
spec:
  ......
  template:
    metadata:
      labels:
        app: backend  # Pod Label å­—æ®µ
</code></pre><p>ç°åœ¨ï¼Œæˆ‘ä»¬å›åˆ° Service ï¼Œåœ¨å°† backend-service åº”ç”¨åˆ°é›†ç¾¤ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ª Service å¯¹è±¡ã€‚</p><p>åœ¨ Service Manifest ä¸­ï¼Œtype å­—æ®µä»£è¡¨ Service çš„ç±»å‹ï¼ŒClusterIP æ˜¯æˆ‘ä»¬åœ¨ä¸šåŠ¡åœºæ™¯é‡Œé¢æœ€å¸¸è§çš„ç±»å‹ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ NodePort å’Œ LoadBalancer ç±»å‹ï¼Œæˆ‘ä»¬ä¼šåœ¨åé¢å†è¯¦ç»†ä»‹ç»ã€‚</p><p>sessionAffinity å­—æ®µä»£è¡¨çš„å«ä¹‰æ˜¯ä¼šè¯ä¿æŒï¼Œå¦‚æœè®¾ç½®ä¸º Trueï¼Œé‚£ä¹ˆ Service åœ¨è½¬å‘è¯·æ±‚æ—¶ä¸å†ä½¿ç”¨è´Ÿè½½å‡è¡¡æ–¹å¼ï¼Œè€Œæ˜¯ä¼šé€šè¿‡å®¢æˆ·ç«¯ IP ä¼šè¯äº²å’Œæ€§çš„æ–¹å¼æ¥å°†è¯·æ±‚è½¬å‘åˆ°ä¹‹å‰è®¿é—®çš„ Pod ä¸Šï¼Œé€šè¿‡è¿™ç§æ–¹å¼æ¥æ›´å¥½åœ°é€‚é…ä¸€äº›è¦æ±‚ä¿æŒä¼šè¯çš„åº”ç”¨ã€‚</p><p>port å­—æ®µä»£è¡¨ Service ç›‘å¬ç«¯å£ï¼ŒtargetPort å­—æ®µä»£è¡¨å°†è¯·æ±‚è½¬å‘åˆ° Pod æ—¶çš„ç›®æ ‡ç«¯å£ã€‚</p><h3>Endpoint å¯¹è±¡</h3><p>é™¤äº† Service å¯¹è±¡ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜æåˆ°äº† Endpoints å¯¹è±¡ã€‚å½“æˆ‘ä»¬åœ¨ Service é‡Œä½¿ç”¨ Pod é€‰æ‹©å™¨æ—¶ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦ä¸»åŠ¨å»åˆ›å»º Endpoints å¯¹è±¡ã€‚åœ¨åˆ›å»º Service ä¹‹åï¼ŒK8s ä¼šè‡ªåŠ¨å¸®åŠ©æˆ‘ä»¬åˆ›å»º Endpointã€‚</p><p>ä½ å¯ä»¥é€šè¿‡ kubectl get Endpoints æ¥è·å–ç¤ºä¾‹åº”ç”¨çš„ Endpoints å¯¹è±¡ï¼š</p><pre><code class="language-yaml">$ kubectl get endpoints -n example
NAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ENDPOINTS&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;AGE
backend-service&nbsp; &nbsp; 10.244.0.13:5000,10.244.0.20:5000&nbsp; &nbsp;12h
frontend-service&nbsp; &nbsp;10.244.0.16:3000,10.244.0.9:3000&nbsp; &nbsp; 12h
pg-service&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10.244.0.8:5432&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;12h
</code></pre><p>ä»è¿”å›ç»“æœæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œbackend-service Endpoints è®°å½•çš„ IP æ­£å¥½æ˜¯ backend Pod çš„ IP åœ°å€ï¼ŒEndpoint è®°å½•äº† Pod å¯¹è±¡ä»¥åŠ IP åœ°å€ï¼Œä¸‹é¢æ˜¯ backend-service Endpoint çš„ Manifestï¼š</p><pre><code class="language-powershell">apiVersion: v1
kind: Endpoints
metadata:
&nbsp; name: backend-service
&nbsp; namespace: example
  ......
subsets:
&nbsp; - addresses:
&nbsp; &nbsp; &nbsp; - ip: 10.244.0.20
&nbsp; &nbsp; &nbsp; &nbsp; targetRef:
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kind: Pod
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; namespace: example
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name: backend-595666f99c-pdxbk
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ......
&nbsp; &nbsp; &nbsp; - ip: 10.244.0.13
&nbsp; &nbsp; &nbsp; &nbsp; targetRef:
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kind: Pod
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; namespace: example
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name: backend-66b9754d65-jxpnb
          ......
&nbsp; &nbsp; ports:
&nbsp; &nbsp; &nbsp; - port: 5000
&nbsp; &nbsp; &nbsp; &nbsp; protocol: TCP
</code></pre><h3>Service IP</h3><p>ç°åœ¨ï¼Œæˆ‘ä»¬çŸ¥é“äº† Service IP æ˜¯ç¨³å®šçš„ï¼Œå¹¶ä¸”å®ƒèƒ½ä¸ºæˆ‘ä»¬æŠ½è±¡ä¸€ç»„ Pod å®ç°è´Ÿè½½å‡è¡¡ã€‚è¿™å°±æ„å‘³ç€æˆ‘ä»¬åªéœ€è¦è®¿é—® Service IP å°±å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ Podã€‚æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹è¿™ä¸ªçŒœæƒ³ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬è·å–ç¤ºä¾‹åº”ç”¨çš„åç«¯ Service IP åœ°å€ï¼š</p><pre><code class="language-yaml">$ kubectl get service -n example
NAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TYPE&nbsp; &nbsp; &nbsp; &nbsp; CLUSTER-IP&nbsp; &nbsp; &nbsp; EXTERNAL-IP&nbsp; &nbsp;PORT(S)&nbsp; &nbsp; AGE
backend-service&nbsp; &nbsp; ClusterIP&nbsp; &nbsp;10.96.151.12&nbsp; &nbsp; &lt;none&gt;&nbsp; &nbsp; &nbsp; &nbsp; 5000/TCP&nbsp; &nbsp;12h
frontend-service&nbsp; &nbsp;ClusterIP&nbsp; &nbsp;10.96.173.32&nbsp; &nbsp; &lt;none&gt;&nbsp; &nbsp; &nbsp; &nbsp; 3000/TCP&nbsp; &nbsp;12h
pg-service&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ClusterIP&nbsp; &nbsp;10.96.191.239&nbsp; &nbsp;&lt;none&gt;&nbsp; &nbsp; &nbsp; &nbsp; 5432/TCP&nbsp; &nbsp;12h
</code></pre><p>ä»è¿”å›ç»“æœæˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œbackend-service çš„ IP åœ°å€æ˜¯ï¼š10.96.151.12ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•åœ¨å‰ç«¯ Pod å†…éƒ¨è®¿é—®è¿™ä¸ª IPã€‚</p><p>é¦–å…ˆï¼Œè¿›å…¥ç¤ºä¾‹åº”ç”¨çš„å‰ç«¯ Pod å®¹å™¨ç»ˆç«¯ï¼š</p><pre><code class="language-yaml">$ kubectl exec -it $(kubectl get pods --selector=app=frontend -n example -o jsonpath="{.items[0].metadata.name}") -n example -- sh
/frontend #
</code></pre><p>æ¥ä¸‹æ¥ï¼Œä½¿ç”¨ wget è¯·æ±‚ç¤ºä¾‹åº”ç”¨åç«¯çš„ /host_name æ¥å£ï¼Œè¿™ä¸ªæ¥å£å°†ä¼šè¿”å› Pod çš„åç§°ï¼š</p><pre><code class="language-yaml">/frontend # while true; do wget -q -O- http://10.96.151.12:5000/host_name &amp;&amp; sleep 1; done
{"host_name":"backend-595666f99c-pdxbk"}
{"host_name":"backend-595666f99c-jxpnb"}
{"host_name":"backend-595666f99c-pdxbk"}
{"host_name":"backend-595666f99c-jxpnb"}
</code></pre><p>ä¸Šé¢çš„ä»£ç ä¼šä»¥ 1 ç§’é’Ÿ 1 æ¬¡çš„é¢‘ç‡è¯·æ±‚åç«¯ Pod /host_name æ¥å£ï¼Œå¹¶æ‰“å°åç«¯æ¥å£çš„è¿”å›å†…å®¹ã€‚åœ¨è¿™ä¸ªè¯·æ±‚é‡Œé¢ï¼Œæˆ‘ä»¬è¿˜æŒ‡å®šäº† Service ç›‘å¬ç«¯å£ 5000ï¼Œä½ å¯ä»¥ä½¿ç”¨ ctrl+c ä¸­æ–­å¾ªç¯è¯·æ±‚ã€‚</p><p>ä»è¿”å›ç»“æœå¯ä»¥çœ‹å‡ºï¼Œå¯¹ Service IP çš„è¯·æ±‚è¢«è½¬å‘åˆ°äº†åç«¯çš„æ¯ä¸€ä¸ª Podï¼ŒPod åå­—äº¤æ›¿å‡ºç°ï¼Œè¯´æ˜è´Ÿè½½å‡è¡¡ä¹Ÿæ˜¯æ­£å¸¸å·¥ä½œçš„ã€‚</p><p>åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½è®¤ä¸º Service çš„ä»»åŠ¡å·²ç»å®Œæˆäº†ï¼Œ<strong>ä½†å…¶å®è¿™ç¦»èƒ½å¤Ÿå®é™…ä½¿ç”¨è¿˜å·®æœ€åä¸€æ­¥</strong>ã€‚</p><h3>Service åŸŸå</h3><p>å› ä¸ºï¼Œæˆ‘ä»¬åœ¨å†™ä¸šåŠ¡ä»£ç çš„æ—¶å€™æ˜¯ä¸çŸ¥é“è¢«è°ƒç”¨çš„ Service IP çš„åœ°å€çš„ï¼Œæˆ‘ä»¬åªæœ‰å°† Service éƒ¨ç½²åˆ°é›†ç¾¤æ‰èƒ½çŸ¥é“å®ƒã€‚ æ­¤å¤–ï¼Œå¦‚æœåˆ é™¤äº† Service é‡å»ºï¼ŒIP åœ°å€ä¹Ÿå°†ä¼šå‡ºç°å˜åŒ–ã€‚æœ€åï¼Œå½“æˆ‘ä»¬å°† K8s å¯¹è±¡ä» A é›†ç¾¤è¿ç§»åˆ° B é›†ç¾¤æ—¶ï¼ŒService IP ä¹Ÿä¼šäº§ç”Ÿå˜åŒ–ã€‚è¿™äº›é—®é¢˜ä¼šè®© Service IP å˜å¾—ä¸å¯é¢„æµ‹ï¼Œæœ€ç»ˆä½¿å¾—æˆ‘ä»¬åœ¨ç¼–ç é˜¶æ®µæ²¡åŠæ³•ä½¿ç”¨ Serviceã€‚</p><p>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªè·Ÿ IP æ— ç›´æ¥å…³ç³»çš„è®¿é—®æ–¹å¼ï¼Œé‚£å°±æ˜¯ <strong>Service åŸŸå</strong>ã€‚</p><p>è®©æˆ‘ä»¬å›åˆ°è¿™æ®µ Service Manifest å†…å®¹ï¼š</p><pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: backend-service
  labels:
    app: backend
spec:
  type: ClusterIP
  selector:
    app: backend
  ports:
  - port: 5000
    targetPort: 5000
</code></pre><p>åœ¨è¿™æ®µ Service Manifest å†…å®¹é‡Œï¼Œæˆ‘ä»¬å°†è¿™ä¸ª Service å‘½åä¸ºäº† backend-serviceï¼Œå®é™…ä¸Šè¿™å°±æ˜¯ <strong>Service çš„åŸŸå</strong>ã€‚</p><p>åœ¨ç¬¬ 6 è®²çš„è·¨å‘½åç©ºé—´é€šä¿¡çš„å†…å®¹é‡Œæˆ‘ä»¬æåˆ°ï¼ŒService åœ¨ K8s é›†ç¾¤å†…æœ‰è‡ªå·±ç‹¬ç«‹çš„åŸŸåï¼Œå®Œæ•´çš„æ ¼å¼æ˜¯ï¼š<code>{$service_name}.{$namespace}.svc.cluster.local</code>ã€‚åœ¨ç¤ºä¾‹åº”ç”¨çš„ä¾‹å­ä¸­ï¼Œbackend-service å®Œæ•´çš„åŸŸåæ˜¯ï¼š<code>backend-service.example.svc.cluster.local</code>ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨<strong>å‰ç«¯ Pod å®¹å™¨ç»ˆç«¯é‡Œ</strong>éªŒè¯è¿™ä¸ªçŒœæƒ³ã€‚</p><pre><code class="language-yaml">/frontend #while true; do wget -q -O- http://backend-service.example.svc.cluster.local:5000/host_name &amp;&amp; sleep 1; done
{"host_name":"backend-595666f99c-jxpnb"}
{"host_name":"backend-595666f99c-pdxbk"}
{"host_name":"backend-595666f99c-pdxbk"}
{"host_name":"backend-595666f99c-jxpnb"}
</code></pre><p>ä»è¿”å›ç»“æœæˆ‘ä»¬ä¼šå‘ç°ï¼Œè®¿é—® Service åŸŸåå’Œ Service çš„ IP æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œæœ€ç»ˆ backend æœåŠ¡çš„ Pod éƒ½èƒ½æ”¶åˆ°æˆ‘ä»¬å‘èµ·çš„è¯·æ±‚ï¼ŒPod å’Œ Service çš„è¯·æ±‚é“¾è·¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://static001.geekbang.org/resource/image/b5/37/b5dafde9e032b496748cd97a408c7137.jpg?wh=1920x1504" alt="å›¾ç‰‡"></p><p>å®é™…ä¸Šï¼Œå½“è¯·æ±‚å‘èµ·æ–¹å’Œç›®æ ‡ Service åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´ä¸‹æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœç•¥ namesapce.svc.cluster.localï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>åªéœ€è¦è¯·æ±‚ Service çš„å…¨ç§°å³ backend-service å°±å¯ä»¥äº†</strong>ï¼Œä½ å¯ä»¥åœ¨ frontend Pod é‡Œé¢ç»§ç»­éªŒè¯ï¼š</p><pre><code class="language-yaml">/frontend #while true; do wget -q -O- http://backend-service:5000/host_name &amp;&amp; sleep 1; done
{"host_name":"backend-595666f99c-jxpnb"}
{"host_name":"backend-595666f99c-pdxbk"}
{"host_name":"backend-595666f99c-pdxbk"}
{"host_name":"backend-595666f99c-jxpnb"}
</code></pre><p>Service çš„è¿™ç§ç‰¹æ€§å¯ä»¥ä¸ºæˆ‘ä»¬æä¾›å¯é¢„æµ‹ä¸”ä¸å˜çš„è¯·æ±‚ URLï¼Œæ— è®º Pod æ€ä¹ˆå˜åŒ–ï¼ŒService æ€»æ˜¯èƒ½ä¸ºæˆ‘ä»¬æä¾›æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡æœºåˆ¶ã€‚</p><p>æ€»ç»“æ¥è¯´ï¼Œè®¿é—® Service æœ‰ä¸‹é¢è¿™ä¸¤ç§æ–¹å¼ï¼š</p><ul>
<li>å¦‚æœè¯·æ±‚æ–¹å’Œè¢«è¯·æ±‚çš„ Service å¤„äºåŒä¸€ä¸ªå‘½åç©ºé—´ï¼Œé‚£ä¹ˆè¯·æ±‚ URL å°±ç­‰äº Service åç§°ï¼›</li>
<li>å¦‚æœè¯·æ±‚æ–¹å’Œè¢«è¯·æ±‚çš„ Service ä¸åœ¨ä¸€ä¸ªå‘½åç©ºé—´ä¸‹ï¼Œé‚£ä¹ˆè¯·æ±‚ URL ç­‰äº <code>{$service_name}.{$namespace}.svc.cluster.local</code> æˆ– <code>{$service_name}.{$namespace}</code>ã€‚</li>
</ul><h2>Service çš„ç±»å‹</h2><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºçš„ Service æ˜¯æœ€å¸¸ç”¨çš„ ClusterIP ç±»å‹ï¼ŒClusterIP ç±»å‹ä¼šä¸º Service åˆ›å»ºä¸€ä¸ª VIPï¼Œå¹¶ä¸”æä¾›é›†ç¾¤å†…è®¿é—®çš„èƒ½åŠ›ã€‚</p><p>ä¹‹å‰æˆ‘ä¹Ÿæœ‰æè¿‡ï¼ŒService çš„ç±»å‹é™¤äº† ClusterIP ä»¥å¤–ï¼Œè¿˜æœ‰ NodePortã€ExternalName å’Œ Loadbalancerï¼Œä¸‹é¢æˆ‘ä»¬åˆ†åˆ«ä»‹ç»ä¸€ä¸‹ã€‚</p><h3>NodePort</h3><p>NodePort å¯ä»¥å°† Service æš´éœ²åœ¨ K8s çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„ç«¯å£ä¸Šï¼Œé€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥ä½¿ç”¨èŠ‚ç‚¹ â€œIP+ç«¯å£å·â€çš„å½¢å¼æ¥è®¿é—®æœåŠ¡ã€‚</p><p>ä¸è¿‡ï¼Œç”±äºè¿™ç§æš´éœ²æ–¹å¼ä¼šä¾µå…¥åˆ°èŠ‚ç‚¹ï¼Œå¹¶ä¸”è¿˜éœ€è¦é…ç½®çš„ç«¯å£åœ¨èŠ‚ç‚¹ä¸Šæ²¡æœ‰è¢«å ç”¨ï¼Œæ‰€ä»¥æˆ‘å¹¶ä¸æ¨èè¿™ç§ Service æš´éœ²æ–¹å¼ï¼Œæˆ‘ä»¬åœ¨å®é™…å·¥ä½œä¸­ä¹Ÿä¸€èˆ¬ä¸ä¼šä½¿ç”¨è¿™ç§æ–¹å¼ã€‚</p><h3>Loadbalancer</h3><p>Loadbalancer æ˜¯ä¸€ç§é€šè¿‡è´Ÿè½½å‡è¡¡å™¨æ¥æš´éœ² Service çš„æ–¹æ³•ï¼Œé€šè¿‡è¿™ç§æš´éœ²æ–¹å¼ï¼ŒService ä¼šå’Œäº‘å‚å•†çš„è´Ÿè½½å‡è¡¡å™¨è¿æ¥èµ·æ¥ï¼Œä½¿å¾— Service å¯ä»¥é€šè¿‡è´Ÿè½½å‡è¡¡å™¨æä¾›çš„å¤–ç½‘ IP æ¥è¿›è¡Œè®¿é—®ã€‚</p><p>å¯¹äºä¸šåŠ¡æœåŠ¡ï¼Œæˆ‘ä¸æ¨èä½ ç›´æ¥ä½¿ç”¨ Loadbalancer æ¥æš´éœ²æœåŠ¡ã€‚é¦–å…ˆï¼Œå› ä¸º Loadbalancer å…·å¤‡ç‹¬ç«‹çš„ IP åœ°å€ï¼Œæ‰€ä»¥äº‘å‚å•†é€šå¸¸ä¼šæŒ‰ç…§â€œæ—¶é•¿+æµé‡â€çš„æ–¹å¼è®¡è´¹ï¼Œè¿™ä¼šå¸¦æ¥é«˜æ˜‚çš„æˆæœ¬ã€‚å…¶æ¬¡ï¼Œä¸€ä¸ª K8s é›†ç¾¤å†…é€šå¸¸ä¼šæœ‰å¤šä¸ªä¸šåŠ¡ Service éœ€è¦æš´éœ²ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼ä¼šå¼€é€šå¤šä¸ªè´Ÿè½½å‡è¡¡å™¨å®ä¾‹ï¼Œè¿™æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚</p><p>åœ¨å®é™…çš„ä¸šåŠ¡ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šåœ¨é›†ç¾¤å†…å®‰è£…ä¸€ä¸ªå…¥å£ç½‘å…³ï¼Œä¾‹å¦‚ Ingress-nginxï¼Œå®ƒä¼šè‡ªå¸¦ä¸€ä¸ª Loadbalancer ç±»å‹çš„ Serviceï¼Œç„¶åç”± Ingress-nginx æ¥ç»Ÿä¸€æ¥æ”¶å¤–éƒ¨è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚è½¬å‘åˆ°é›†ç¾¤å†…éƒ¨ã€‚æˆ‘ä»¬åªéœ€è¦é…ç½®åŸŸåæˆ–è·¯å¾„è§„åˆ™å³å¯å®ç°ä¸€ä¸ª Loadbalancer IP æš´éœ²é›†ç¾¤æ‰€æœ‰ Service çš„æ•ˆæœã€‚è¿™ç§æœåŠ¡æš´éœ²æ–¹å¼åé¢è¿˜ä¼šè¯¦ç»†ä»‹ç»ã€‚</p><h3>ExternalName</h3><p>ClusterIPã€NodePort å’Œ Loadbalancer ç±»å‹éƒ½æ˜¯é€šè¿‡ Pod é€‰æ‹©å™¨å°† Service å’Œ Pod å…³è”èµ·æ¥ï¼Œç„¶åå°†è¯·æ±‚è½¬å‘åˆ°å¯¹åº”çš„ Pod ä¸­çš„ã€‚è€Œ ExternalName ç±»å‹éå¸¸ç‰¹æ®Šï¼Œå®ƒä¸é€šè¿‡ Pod é€‰æ‹©å™¨å…³è” Pod ï¼Œè€Œæ˜¯å°† Service å’Œå¦å¤–ä¸€ä¸ªåŸŸåå…³è”èµ·æ¥ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ª ExternalName ç±»å‹çš„Service Manifest çš„ä¾‹å­ï¼š</p><pre><code class="language-powershell">apiVersion: v1
kind: Service
metadata:
  name: backend-service
  namespace: default
spec:
  type: ExternalName
  externalName: backend-service.example.svc.cluster.local
</code></pre><p>å½“å°†ä¸Šé¢çš„ Service åº”ç”¨åˆ°é›†ç¾¤ä¹‹åï¼Œåœ¨ default å‘½åç©ºé—´ä¸‹è®¿é—® <a href="http://backend-serivce:5000">http://backend-serivce:5000</a> æ—¶ï¼Œè¯·æ±‚å°†ä¼šè¢«è½¬å‘åˆ° example å‘½åç©ºé—´ä¸‹çš„ backend-serviceã€‚æˆ‘ä»¬ä¼šå‘ç°è™½ç„¶ç›®æ ‡ Service å’Œè¯·æ±‚å‘èµ·æ–¹ä¸åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´ä¸‹ï¼Œä½†å¯ä»¥é€šè¿‡è¿™ç§æ–¹æ³•å±è”½å®ƒä»¬åœ¨ä¸åŒå‘½åç©ºé—´çš„è°ƒç”¨å·®å¼‚ï¼Œä½¿å¾—ä¸¤ä¸ªæœåŠ¡çœ‹èµ·æ¥åƒæ˜¯åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´ä¸‹ã€‚</p><p>æ­¤å¤–ï¼Œå½“æˆ‘ä»¬éœ€è¦é€šè¿‡ Service åç§°çš„æ–¹å¼è¯·æ±‚å¤–éƒ¨æœåŠ¡æ—¶ï¼Œä¾‹å¦‚è¯·æ±‚åœ¨é›†ç¾¤å¤–çš„æ•°æ®åº“æœåŠ¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•ã€‚</p><h2>æ€»ç»“</h2><p>åœ¨è¿™èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä¸»è¦ä¸ºä½ ä»‹ç»äº† K8s ç¯å¢ƒä¸‹æœåŠ¡ä¹‹é—´æ˜¯å¦‚ä½•è¿›è¡Œè°ƒç”¨çš„ã€‚é€šè¿‡ Pod IP çš„æ–¹å¼è°ƒç”¨æœåŠ¡å­˜åœ¨ä¸€äº›æ— æ³•è§£å†³çš„é—®é¢˜ï¼Œä¾‹å¦‚ Pod IP æ— æ³•åœ¨ç¼–ç é˜¶æ®µæå‰é¢„çŸ¥ï¼ŒPod æ›´æ–°é•œåƒã€é©±é€å’Œé‡æ–°è°ƒåº¦éƒ½ä¼šå¯¼è‡´ Pod é‡å¯ï¼Œè¿›è€Œå¯¼è‡´ IP å‡ºç°å˜åŒ–ï¼Œé€šè¿‡ Service DNS åˆ™å¯ä»¥å®Œç¾åœ°è§£å†³æœåŠ¡å‘ç°å’ŒæœåŠ¡é—´è®¿é—®çš„é—®é¢˜ã€‚</p><p>é€šè¿‡æœ¬èŠ‚è¯¾çš„å®éªŒï¼Œæˆ‘ä»¬çŸ¥é“äº†åœ¨åˆ›å»º Service å¯¹è±¡ä¹‹åï¼ŒåŒæ—¶ä¹Ÿä¼šåˆ›å»º Endpoint å¯¹è±¡ï¼Œå®ƒä¹Ÿæ˜¯ Service å®ç°æœåŠ¡å‘ç°çš„å…³é”®ã€‚Service åŒæ ·æ‹¥æœ‰è‡ªå·±åœ¨é›†ç¾¤å†…éƒ¨çš„ IP åœ°å€ï¼Œåœ¨è¿›è¡ŒæœåŠ¡ä¹‹é—´çš„è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨ Serviceã€‚</p><p>åœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼ŒService çš„åŸŸåå†™æ³•ä¸€å…±æœ‰ä¸‰ç§ï¼Œå½“è¯·æ±‚æœåŠ¡ä¸è¢«è¯·æ±‚çš„ Service åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´ä¸‹æ—¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ Service åç§°ã€‚å½“è¯·æ±‚æœåŠ¡ä¸è¢«è¯·æ±‚ Service ä¸åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´ä¸‹æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ Service çš„å…¨ç§° <code>{$service_name}.{$namespace}.svc.cluster.local</code> æˆ–è€… <code>{$service_name}.{$namespace}</code> æ¥è¯·æ±‚ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬è¿˜ç®€å•ä»‹ç»äº†æœåŠ¡æš´éœ²çš„ä¸€äº›çŸ¥è¯†ç‚¹ï¼Œè¿™é‡Œä½ åªè¦äº†è§£ä¸€ä¸‹å°±å¯ä»¥äº†ï¼Œåé¢è¿˜ä¼šæœ‰æ›´è¯¦ç»†çš„ä»‹ç»ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åï¼Œç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜å§ã€‚</p><p>åœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ä»¥ Service çš„æ–¹å¼æ¥è®¿é—®ä¸€ä¸ªå¤–éƒ¨ IP åœ°å€ï¼Œä¾‹å¦‚ä» K8s é›†ç¾¤å†…ä»¥ Service çš„æ–¹å¼è®¿é—®å¤–éƒ¨æ•°æ®åº“ IPï¼Œè¯·ä½ å°è¯•å†™å‡ºå¯¹åº”çš„ Service å’Œ Endpointã€‚</p><p>æç¤ºï¼šService çš„ç±»å‹ä¸º clusterIPï¼ŒclusterIP å­—æ®µå€¼å¯ä»¥ä¸º Noneï¼ŒEndpoint çš„ addresses æ•°ç»„ä¸‹éœ€è¦ä¸€ä¸ªåŒ…å«æ•°æ®åº“ IP å­—æ®µçš„æ•°ç»„ã€‚</p><p>æ¬¢è¿ä½ ç»™æˆ‘ç•™è¨€äº¤æµè®¨è®ºï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/14/54/21/0bac2254.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æ©™æ±</span>
  </div>
  <div class="_2_QraFYR_0">æ€»ä¼šæœ‰ä¸çŸ¥é“çš„ä¸œè¥¿ï¼Œç”¨äº†è¿™ä¹ˆä¹…k8sæ‰çŸ¥é“ExternalName è¿™æ ·ææ•°æ®åº“æˆ–å…¶ä»–æœåŠ¡å°±å¯ä»¥æ ‡å‡†åŒ–äº† ç‰›é€¼ç‰›é€¼</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ˜¯çš„ï¼Œå¤–éƒ¨æœåŠ¡è°ƒç”¨ä¹Ÿå¯ä»¥é€šè¿‡ Service è®¿é—®ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-12-26 18:33:08</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/23/52/66/3e4d4846.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>includestdio.h</span>
  </div>
  <div class="_2_QraFYR_0">é€šè¿‡å®šä¹‰ä¸€ä¸ªæ— é€‰æ‹©ç¬¦çš„ headless service ï¼Œå¹¶è‡ªè¡Œåˆ›å»º ep ï¼Œé€šè¿‡ ep å°†é›†ç¾¤å¤–éƒ¨çš„æ•°æ®åº“ä¸å†…éƒ¨çš„ svc ç›¸å…³è”<br><br>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: db<br>  namespace: example<br>spec:<br>  ports:<br>    - port: 3306<br>      targetPort: 3306<br>---<br>apiVersion: v1<br>kind: Endpoints<br>metadata:<br>  name: db<br>  namespace: example<br>subsets:<br>  - addresses:<br>      - ip: 10.244.0.1<br>      - ip: 10.244.0.2<br>      - ip: 10.244.0.3<br>    ports:<br>      - port: 3306<br>        protocol: TCP</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: éå¸¸è¯¦ç»†ï¼Œè¿˜æåˆ°äº† headless service çš„çŸ¥è¯†ç‚¹ï¼</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-12-27 09:53:49</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ä¸€æ­¥</span>
  </div>
  <div class="_2_QraFYR_0">Service å’Œ Endpoints æ˜¯2ç§èµ„æºï¼Œåˆ›å»ºä¹‹åæ˜¯æ€ä¹ˆè¿›è¡Œå…³è”çš„ï¼Ÿ æ ¹æ®2ä¸ª å£°æ˜æ–‡ä»¶é‡Œé¢çš„ metadata.name æ˜¯å¦ä¸€è‡´ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ˜¯çš„ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-12-26 21:33:37</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/20/12/e4/57ade29a.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>dva</span>
  </div>
  <div class="_2_QraFYR_0">apiVersion: v1<br>kind: Service<br>metadata:<br>  name: mysql-svc<br>  namespace: example<br>spec:<br>  ports:<br>  - port: 3306<br>    targetPort: 3306<br>    protocol: TCP<br>    name: tcp<br>---<br>apiVersion: v1<br>kind: Endpoints<br>metadata:<br>  name: mysql-svc<br>  namespace: example<br>subsets:<br>  - addresses:<br>    - ip: 192.168.0.200<br>    ports:<br>    - port: 3306<br>      name: tcp<br><br># åœ¨ K8S ä¸­çš„å®¹å™¨ä½¿ç”¨ mysql-svc.example.svc.cluster.local:3306 å°±å¯ä»¥è®¿é—®åˆ° mysql äº†ã€‚<br></div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ­£ç¡®ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-12-26 18:52:51</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/2a/d1/34/03dc9e03.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æå¤š</span>
  </div>
  <div class="_2_QraFYR_0">æˆ‘ä¹Ÿæ˜¯ï¼Œä¹‹å‰æ²¡æ³¨æ„è¿‡ExternalNameã€‚è¿™æ ·ä¸€æ¥åœ¨ä¸€äº›å¾®æœåŠ¡çš„é…ç½®ä¸­ï¼Œå°±å¯ä»¥è¿›ä¸€æ­¥æŠŠæœåŠ¡å’Œä½¿ç”¨çš„ä¸­é—´ä»¶è§£è€¦ï¼ˆå°†ä¸€äº›ä¸­é—´ä»¶æœåŠ¡åœ°å€ç›´æ¥ç”¨é›†ç¾¤è®¿é—®åœ°å€è¡¨ç¤ºï¼‰ï¼Œåœ¨å®é™…éƒ¨ç½²çš„æ—¶å€™é€šè¿‡ExternalNameæ–¹å¼è®©å¾®æœåŠ¡è®¿é—®å…¶ä»–ä¸­é—´ä»¶ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ˜¯çš„ï¼Œå¾ˆå¥½çš„æ€è·¯ğŸ‘ğŸ»</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-01-08 10:31:53</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/8a/63/a5fda84d.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>çƒŸç«ä¸å </span>
  </div>
  <div class="_2_QraFYR_0">ä¸çŸ¥é“æˆ‘ç†è§£å¯¹äº†æ²¡ï¼Œåº”è¯¥æ˜¯è¿™ä¸ªæ„æ€å§ã€‚<br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: mysql<br>spec:<br>  ports:<br>  - port: 3306<br>    protocol: TCP<br>    targetPort: 3306<br>  type: ClusterIP<br><br>---<br>apiVersion: v1<br>kind: Endpoints<br>metadata:<br>  name: mysql<br>subsets:<br>- addresses:<br>  - ip: 192.168.0.xxx<br>  ports:<br>  - port: 3306<br>    protocol: TCP</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ­£ç¡®ï¼</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-12-26 17:47:35</div>
  </div>
</div>
</div>
</li>
</ul>