<audio title="49 _ æœåŠ¡æ²»ç†ï¼šå¦‚ä½•è¿›è¡Œé™æµã€ç†”æ–­ä¸è®¤è¯ï¼Ÿ" src="https://static001.geekbang.org/resource/audio/bd/1c/bd701ef0e0612f1ee4bd26370fac0d1c.mp3" controls="controls"></audio> 
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ‘å»ºå‹‹ã€‚</p><p>åœ¨ä¹‹å‰æˆ‘ä»¬å·²ç»å®Œæˆäº†Masterä¸Workerçš„æ ¸å¿ƒåŠŸèƒ½ã€‚åœ¨å¤§è§„æ¨¡å¾®æœåŠ¡é›†ç¾¤ä¸­ï¼Œä¸ºäº†ä¿è¯å¾®æœåŠ¡é›†ç¾¤æ­£å¸¸è¿è¡Œï¼Œè¿˜éœ€è¦æ·»åŠ è®¸å¤šé‡è¦çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬é™æµã€ç†”æ–­ã€è®¤è¯ä¸é‰´æƒã€‚è¿™èŠ‚è¯¾ï¼Œå°±è®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•å®ç°è¿™äº›åŠŸèƒ½ã€‚</p><h2>é™æµ</h2><p>é™æµæŒ‡çš„æ˜¯å¯¹ç»™å®šæ—¶é—´å†…å¯èƒ½å‘ç”Ÿçš„äº‹ä»¶çš„é¢‘ç‡è¿›è¡Œé™åˆ¶ã€‚ä¸€æ—¦è¯·æ±‚è¾¾åˆ°è§„å®šçš„ä¸Šé™ï¼Œæ­¤åè¿™æ®µæ—¶é—´å†…çš„è¯·æ±‚éƒ½å°†è¢«ä¸¢å¼ƒã€‚</p><p>é™æµå¯¹äºå…¬å…± API éå¸¸é‡è¦ï¼Œå®ƒæœ‰ä¸‹é¢å‡ ä¸ªä¼˜åŠ¿ã€‚</p><ul>
<li>æé«˜æœåŠ¡çš„å¯ç”¨æ€§å’Œå¯é æ€§ï¼Œå¹¶æœ‰åŠ©äºé˜²å¾¡æˆ–ç¼“è§£ä¸€äº›å¸¸è§çš„æ”»å‡»ï¼ˆDoSæ”»å‡»ã€ DDoSæ”»å‡»ã€æš´åŠ›ç ´è§£ã€æ’åº“æ”»å‡»ã€ç½‘é¡µçˆ¬å–ç­‰ï¼‰ã€‚</li>
<li>å¯ç”¨äºæˆæœ¬æ§åˆ¶ï¼Œé˜²æ­¢å®éªŒæˆ–é”™è¯¯é…ç½®çš„èµ„æºå¯¼è‡´çš„æ„å¤–è´¦å•ï¼ˆå°¤å…¶é€‚ç”¨äºäº‘å‚å•†ä¼šæŒ‰æ¬¡è®¡è´¹è¿™ç§æƒ…å†µï¼‰ã€‚</li>
<li>å…è®¸å¤šä¸ªç”¨æˆ·å…¬å¹³å…±äº«æœåŠ¡ã€‚<br>
é™æµæœ‰å¤šç§ç®—æ³•ï¼Œä¹‹å‰æˆ‘ä»¬å·²ç»å®ç°äº†ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œå…¶ä»–çš„ç®—æ³•è¿˜æœ‰å›ºå®šçª—å£ç®—æ³•ã€æ»‘åŠ¨æ—¥å¿—ç®—æ³•ã€æ¼æ¡¶ç®—æ³•ç­‰ï¼Œæ¯ç§ç®—æ³•éƒ½æœ‰å…¶ä¼˜ç‚¹å’Œç¼ºç‚¹ã€‚æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹æœ€ç»å…¸çš„å‡ ç§é™æµç®—æ³•ï¼Œæ–¹ä¾¿ä½ æ ¹æ®éœ€è¦é€‰æ‹©ç†æƒ³çš„é™æµæ–¹æ¡ˆã€‚</li>
</ul><h3>å›ºå®šçª—å£ç®—æ³•</h3><p>å›ºå®šçª—å£ç®—æ³•ï¼ˆFixed Window Algorithmï¼‰æŒ‡çš„æ˜¯ï¼Œé™åˆ¶å›ºå®šæ—¶é—´çª—å£å†…è¯·æ±‚çš„å¤„ç†ä¸ªæ•°ã€‚ä¾‹å¦‚æ¯å°æ—¶åªå…è®¸å¤„ç† 1000 ä¸ªè¯·æ±‚ï¼Œæˆ–æ¯åˆ†é’Ÿåªå…è®¸å¤„ç† 10 ä¸ªè¯·æ±‚ã€‚æ¯ä¸ªä¼ å…¥è¯·æ±‚éƒ½ä¼šå¢åŠ çª—å£çš„è®¡æ•°å™¨ï¼Œå¹¶ä¸”è®¡æ•°å™¨ä¼šåœ¨ä¸€æ®µæ—¶é—´åé‡ç½®ã€‚å¦‚æœè®¡æ•°å™¨è¶…è¿‡äº†é˜ˆå€¼ï¼Œåé¢çš„è¯·æ±‚å°†ä¼šè¢«ä¸¢å¼ƒï¼Œç›´åˆ°è®¡æ•°å™¨è¢«é‡ç½®ä¸ºæ­¢ã€‚</p><!-- [[[read_end]]] --><p>å›ºå®šçª—å£ç®—æ³•å¾ˆå®¹æ˜“å®ç°ï¼Œå¹¶ä¸”åœ¨é™åˆ¶è¯·æ±‚é€Ÿç‡æ–¹é¢åšå¾—å¾ˆå¥½ã€‚ä½†æ˜¯éšç€é™åˆ¶çš„é‡ç½®ï¼Œè¯¥ç®—æ³•ä¼šå‡ºç°ä¸´ç•Œé—®é¢˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæµé‡éƒ½é›†ä¸­åœ¨ä¸¤ä¸ªçª—å£çš„äº¤ç•Œå¤„ï¼Œé‚£ä¹ˆçªå‘æµé‡ä¼šæ˜¯è®¾ç½®ä¸Šé™çš„ä¸¤å€ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬è®¾ç½®æ¯å°æ—¶åªèƒ½å¤„ç† 1000 ä¸ªè¯·æ±‚ã€‚å¦‚æœè¿™ 1000 ä¸ªè¯·æ±‚éƒ½åˆšå¥½ä½äºç¬¬ä¸€ä¸ªå°æ—¶çš„æœ€åä¸€åˆ†é’Ÿï¼Œè€Œä¹‹åçš„1000ä¸ªè¯·æ±‚åˆåˆšå¥½å‡ºç°åœ¨ä¸‹ä¸€ä¸ªå°æ—¶çš„ç¬¬ä¸€åˆ†é’Ÿï¼Œå°±ä¼šå¯¼è‡´åœ¨è¿™çŸ­çŸ­çš„2åˆ†é’Ÿå†…ï¼ŒæœåŠ¡éœ€è¦æ‰¿å—2000ä¸ªè¯·æ±‚ï¼Œä½¿æœåŠ¡ä¸å ªé‡è´Ÿï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚</p><pre><code class="language-plain">// FixedWindowLimiter å›ºå®šçª—å£é™æµå™¨
type FixedWindowLimiter struct {
	limit    int           // çª—å£è¯·æ±‚ä¸Šé™
	window   time.Duration // çª—å£æ—¶é—´å¤§å°
	counter  int           // è®¡æ•°å™¨
	lastTime time.Time     // ä¸Šä¸€æ¬¡è¯·æ±‚çš„æ—¶é—´
	mutex    sync.Mutex    // é¿å…å¹¶å‘é—®é¢˜
}

func NewFixedWindowLimiter(limit int, window time.Duration) *FixedWindowLimiter {
	return &amp;FixedWindowLimiter{
		limit:    limit,
		window:   window,
		lastTime: time.Now(),
	}
}

func (l *FixedWindowLimiter) TryAcquire() error {
	l.mutex.Lock()
	defer l.mutex.Unlock()
	// è·å–å½“å‰æ—¶é—´
	now := time.Now()
	// å¦‚æœå½“å‰çª—å£å¤±æ•ˆï¼Œè®¡æ•°å™¨æ¸…0ï¼Œå¼€å¯æ–°çš„çª—å£
	if now.Sub(l.lastTime) &gt; l.window {
		l.counter = 0
		l.lastTime = now
	}
	// è‹¥åˆ°è¾¾çª—å£è¯·æ±‚ä¸Šé™ï¼Œè¯·æ±‚å¤±è´¥
	if l.counter &gt;= l.limit {
		return errors.New("reach max limit")
	}
	// è‹¥æ²¡åˆ°çª—å£è¯·æ±‚ä¸Šé™ï¼Œè®¡æ•°å™¨+1ï¼Œè¯·æ±‚æˆåŠŸ
	l.counter++
	return nil
}
</code></pre><h3>æ»‘åŠ¨æ—¥å¿—ç®—æ³•</h3><p>è¿˜æœ‰ä¸€ç§å¸¸è§çš„é™æµç®—æ³•æ˜¯æ»‘åŠ¨æ—¥å¿—ç®—æ³•ï¼ˆSliding Logï¼‰ã€‚å®ƒä¼šè®°å½•ä¸‹æ‰€æœ‰çš„è¯·æ±‚æ—¶é—´ç‚¹ï¼Œç³»ç»Ÿä¼šå°†è¿™äº›æ—¥å¿—å­˜å‚¨åœ¨æŒ‰ç…§æ—¶é—´å…ˆåæ¥æ’åºçš„é›†åˆä¸­ã€‚æ–°è¯·æ±‚åˆ°æ¥æ—¶ï¼Œä¼šå…ˆåˆ¤æ–­æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„è¯·æ±‚æ•°é‡æ˜¯å¦è¶…è¿‡é˜ˆå€¼ï¼Œè¶…å‡ºé˜ˆå€¼çš„è¯·æ±‚ä¼šè¢«ä¸¢å¼ƒã€‚</p><p>è¿™ç§æ–¹å¼é¿å…äº†å›ºå®šçª—å£ç®—æ³•å®¹æ˜“é‡åˆ°çš„è¯·æ±‚çªå˜é—®é¢˜ï¼Œé™æµæ¯”è¾ƒå‡†ç¡®ã€‚ä¸è¿‡å› ä¸ºå®ƒè¦è®°å½•ä¸‹æ¯æ¬¡è¯·æ±‚çš„æ—¶é—´ç‚¹ï¼Œæ‰€ä»¥ä¼šé¢å¤–æ¶ˆè€—å†…å­˜ä¸CPUã€‚ä¸‹é¢çš„ä»£ç ç»™å‡ºäº†æ»‘åŠ¨æ—¥å¿—ç®—æ³•çš„ç¤ºä¾‹ï¼Œåœ¨è¯¥ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šå¤šä¸ªé™é€Ÿç­–ç•¥ï¼Œä¾‹å¦‚ç­–ç•¥Aåœ¨1åˆ†é’Ÿå†…å…è®¸å¤„ç†100ä¸ªè¯·æ±‚ï¼Œå¹¶ä¸”ç­–ç•¥Båœ¨1å°æ—¶å†…å…è®¸å¤„ç†1000ä¸ªè¯·æ±‚ã€‚</p><pre><code class="language-plain">// ViolationStrategyError è¿èƒŒç­–ç•¥é”™è¯¯
type ViolationStrategyError struct {
	Limit  int           // çª—å£è¯·æ±‚ä¸Šé™
	Window time.Duration // çª—å£æ—¶é—´å¤§å°
}

func (e *ViolationStrategyError) Error() string {
	return fmt.Sprintf("violation strategy that limit = %d and window = %d", e.Limit, e.Window)
}

// SlidingLogLimiterStrategy æ»‘åŠ¨æ—¥å¿—é™æµå™¨çš„ç­–ç•¥
type SlidingLogLimiterStrategy struct {
	limit        int   // çª—å£è¯·æ±‚ä¸Šé™
	window       int64 // çª—å£æ—¶é—´å¤§å°
	smallWindows int64 // å°çª—å£æ•°é‡
}

func NewSlidingLogLimiterStrategy(limit int, window time.Duration) *SlidingLogLimiterStrategy {
	return &amp;SlidingLogLimiterStrategy{
		limit:  limit,
		window: int64(window),
	}
}

// SlidingLogLimiter æ»‘åŠ¨æ—¥å¿—é™æµå™¨
type SlidingLogLimiter struct {
	strategies  []*SlidingLogLimiterStrategy // æ»‘åŠ¨æ—¥å¿—é™æµå™¨ç­–ç•¥åˆ—è¡¨
	smallWindow int64                        // å°çª—å£æ—¶é—´å¤§å°
	counters    map[int64]int                // å°çª—å£è®¡æ•°å™¨
	mutex       sync.Mutex                   // é¿å…å¹¶å‘é—®é¢˜
}

func NewSlidingLogLimiter(smallWindow time.Duration, strategies ...*SlidingLogLimiterStrategy) (*SlidingLogLimiter, error) {
	// å¤åˆ¶ç­–ç•¥é¿å…è¢«ä¿®æ”¹
	strategies = append(make([]*SlidingLogLimiterStrategy, 0, len(strategies)), strategies...)

	// ä¸èƒ½ä¸è®¾ç½®ç­–ç•¥
	if len(strategies) == 0 {
		return nil, errors.New("must be set strategies")
	}

	// æ’åºç­–ç•¥ï¼Œçª—å£æ—¶é—´å¤§çš„æ’å‰é¢ï¼Œç›¸åŒçª—å£ä¸Šé™å¤§çš„æ’å‰é¢
	sort.Slice(strategies, func(i, j int) bool {
		a, b := strategies[i], strategies[j]
		if a.window == b.window {
			return a.limit &gt; b.limit
		}
		return a.window &gt; b.window
	})
	fmt.Println(strategies[0], strategies[1])

	for i, strategy := range strategies {
		// éšç€çª—å£æ—¶é—´å˜å°ï¼Œçª—å£ä¸Šé™ä¹Ÿåº”è¯¥å˜å°
		if i &gt; 0 {
			if strategy.limit &gt;= strategies[i-1].limit {
				return nil, errors.New("the smaller window should be the smaller limit")
			}
		}
		// çª—å£æ—¶é—´å¿…é¡»èƒ½å¤Ÿè¢«å°çª—å£æ—¶é—´æ•´é™¤
		if strategy.window%int64(smallWindow) != 0 {
			return nil, errors.New("window cannot be split by integers")
		}
		strategy.smallWindows = strategy.window / int64(smallWindow)
	}

	return &amp;SlidingLogLimiter{
		strategies:  strategies,
		smallWindow: int64(smallWindow),
		counters:    make(map[int64]int),
	}, nil
}

func (l *SlidingLogLimiter) TryAcquire() error {
	l.mutex.Lock()
	defer l.mutex.Unlock()

	// è·å–å½“å‰å°çª—å£å€¼
	currentSmallWindow := time.Now().UnixNano() / l.smallWindow * l.smallWindow
	// è·å–æ¯ä¸ªç­–ç•¥çš„èµ·å§‹å°çª—å£å€¼
	startSmallWindows := make([]int64, len(l.strategies))
	for i, strategy := range l.strategies {
		startSmallWindows[i] = currentSmallWindow - l.smallWindow*(strategy.smallWindows-1)
	}

	// è®¡ç®—æ¯ä¸ªç­–ç•¥å½“å‰çª—å£çš„è¯·æ±‚æ€»æ•°
	counts := make([]int, len(l.strategies))
	for smallWindow, counter := range l.counters {
		if smallWindow &lt; startSmallWindows[0] {
			delete(l.counters, smallWindow)
			continue
		}
		for i := range l.strategies {
			if smallWindow &gt;= startSmallWindows[i] {
				counts[i] += counter
			}
		}
	}

	// è‹¥åˆ°è¾¾å¯¹åº”ç­–ç•¥çª—å£è¯·æ±‚ä¸Šé™ï¼Œè¯·æ±‚å¤±è´¥ï¼Œè¿”å›è¿èƒŒçš„ç­–ç•¥
	for i, strategy := range l.strategies {
		if counts[i] &gt;= strategy.limit {
			return &amp;ViolationStrategyError{
				Limit:  strategy.limit,
				Window: time.Duration(strategy.window),
			}
		}
	}

	// è‹¥æ²¡åˆ°çª—å£è¯·æ±‚ä¸Šé™ï¼Œå½“å‰å°çª—å£è®¡æ•°å™¨+1ï¼Œè¯·æ±‚æˆåŠŸ
	l.counters[currentSmallWindow]++
	return nil
}
</code></pre><h3><strong>æ»‘åŠ¨çª—å£ç®—æ³•</strong></h3><p>æ»‘åŠ¨çª—å£ç®—æ³•ï¼ˆSliding Windowï¼‰æ˜¯ä¸€ç§æ··åˆæ–¹æ³•ï¼Œå®ƒæœ‰ç€å›ºå®šçª—å£ç®—æ³•çš„ä½å¤„ç†æˆæœ¬ï¼Œå¹¶ä¸”å’Œæ»‘åŠ¨æ—¥å¿—ç®—æ³•ä¸€æ ·ï¼Œè¡¨å¾äº†åœ¨è¿ç»­çš„æ—¶é—´èŒƒå›´å†…çš„è¯·æ±‚é‡ã€‚</p><p>å’Œå›ºå®šçª—å£ç®—æ³•ä¸€æ ·ï¼Œæ»‘åŠ¨çª—å£ç®—æ³•ä¼šä¸ºæ¯ä¸ªå›ºå®šçª—å£è®¾ç½®ä¸€ä¸ªè®¡æ•°å™¨ã€‚æ¥ä¸‹æ¥ï¼Œå®ƒä¼šæ ¹æ®å½“å‰æ—¶é—´æˆ³è®¡ç®—å‰ä¸€ä¸ªçª—å£è¯·æ±‚ç‡çš„åŠ æƒå€¼ï¼Œä»¥å¹³æ»‘çªå‘æµé‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå½“å‰çª—å£ç»è¿‡äº†25%çš„æ—¶é—´ï¼Œåˆ™å½“å‰çª—å£çš„è®¡æ•°æƒé‡ä¸º25%ï¼Œè€Œå‰ä¸€ä¸ªçª—å£çš„è®¡æ•°åŠ æƒä¸º75%ã€‚</p><p>æ»‘åŠ¨çª—å£ç®—æ³•éœ€è¦ç»Ÿè®¡çš„æ•°æ®é‡æ¯”æ»‘åŠ¨æ—¥å¿—ç®—æ³•å°‘å¾ˆå¤šï¼Œå¹¶ä¸”åœ¨å¤§å‹åˆ†å¸ƒå¼é›†ç¾¤ä¸­ä»ç„¶å…·æœ‰è¾ƒå¼ºçš„æ‰©å±•æ€§ã€‚</p><p>æ»‘åŠ¨çª—å£ç®—æ³•çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚åœ¨è¿™æ®µå®ä¾‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°†ä¸€ä¸ªå›ºå®šçª—å£åˆ‡å‰²ä¸ºäº†è®¸å¤šå°çª—å£ã€‚ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æŠŠä¸€ä¸ªå›ºå®šçª—å£åˆ†ä¸ºäº†10ä¸ªå°çª—å£ï¼Œè®¡æ•°å°±æŒ‰ç…§æ—¶é—´åˆ†å¸ƒåœ¨è¿™äº›å°çª—å£ä¸­ã€‚å‡è®¾å½“å‰çª—å£çš„æ—¶é—´è¿‡å»äº†20%ï¼Œé‚£ä¹ˆå½“å‰çª—å£çš„è®¡æ•°æƒé‡ä¸º20%ï¼Œè€Œå‰ä¸€ä¸ªçª—å£çš„è®¡æ•°åŠ æƒä¸º80%ã€‚åœ¨è®¡æ•°æ—¶ï¼Œåªè¦å°†å½“å‰å›ºå®šçª—å£çš„ä¸¤ä¸ªå°çª—å£ä¸ä¸Šä¸€ä¸ªçª—å£çš„æœ€å8ä¸ªå°çª—å£çš„æ•°é‡åŠ èµ·æ¥ï¼Œå¹¶å°†è¯¥æ•°é‡ä¸é˜ˆå€¼åšå¯¹æ¯”å³å¯ã€‚</p><pre><code class="language-plain">
// SlidingWindowLimiter æ»‘åŠ¨çª—å£é™æµå™¨
type SlidingWindowLimiter struct {
	limit        int           // çª—å£è¯·æ±‚ä¸Šé™
	window       int64         // çª—å£æ—¶é—´å¤§å°
	smallWindow  int64         // å°çª—å£æ—¶é—´å¤§å°
	smallWindows int64         // å°çª—å£æ•°é‡
	counters     map[int64]int // å°çª—å£è®¡æ•°å™¨
	mutex        sync.Mutex    // é¿å…å¹¶å‘é—®é¢˜
}

func NewSlidingWindowLimiter(limit int, window, smallWindow time.Duration) (*SlidingWindowLimiter, error) {
	// çª—å£æ—¶é—´å¿…é¡»èƒ½å¤Ÿè¢«å°çª—å£æ—¶é—´æ•´é™¤
	if window%smallWindow != 0 {
		return nil, errors.New("window cannot be split by integers")
	}

	return &amp;SlidingWindowLimiter{
		limit:        limit,
		window:       int64(window),
		smallWindow:  int64(smallWindow),
		smallWindows: int64(window / smallWindow),
		counters:     make(map[int64]int),
	}, nil
}

func (l *SlidingWindowLimiter) TryAcquire() bool {
	l.mutex.Lock()
	defer l.mutex.Unlock()

	// è·å–å½“å‰å°çª—å£å€¼
	currentSmallWindow := time.Now().UnixNano() / l.smallWindow * l.smallWindow
	// è·å–èµ·å§‹å°çª—å£å€¼
	startSmallWindow := currentSmallWindow - l.smallWindow*(l.smallWindows-1)

	// è®¡ç®—å½“å‰çª—å£çš„è¯·æ±‚æ€»æ•°
	var count int
	for smallWindow, counter := range l.counters {
		if smallWindow &lt; startSmallWindow {
			delete(l.counters, smallWindow)
		} else {
			count += counter
		}
	}

	// è‹¥åˆ°è¾¾çª—å£è¯·æ±‚ä¸Šé™ï¼Œè¯·æ±‚å¤±è´¥
	if count &gt;= l.limit {
		return false
	}
	// è‹¥æ²¡åˆ°çª—å£è¯·æ±‚ä¸Šé™ï¼Œå½“å‰å°çª—å£è®¡æ•°å™¨+1ï¼Œè¯·æ±‚æˆåŠŸ
	l.counters[currentSmallWindow]++
	return true
}
</code></pre><h3><strong>æ¼æ¡¶ç®—æ³•</strong></h3><p>æ¼æ¡¶ç®—æ³•ï¼ˆLeaky Bucketï¼‰åˆ©ç”¨é˜Ÿåˆ—æä¾›äº†ä¸€ç§ç®€å•ã€ç›´è§‚çš„æ–¹æ³•æ¥é™åˆ¶è¯·æ±‚çš„é€Ÿç‡ã€‚</p><p>æ¯ä¸€ä¸ªè¯·æ±‚éƒ½åƒä¸€æ»´æ°´ï¼Œè¯·æ±‚å‘å‡ºä¹‹åä¼šå…ˆè¢«æ”¾åˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆæ¼æ¡¶ï¼‰ä¸­ï¼Œæ¡¶åº•æœ‰ä¸€ä¸ªå­”ï¼Œä¸æ–­åœ°æ¼å‡ºæ°´æ»´ã€‚è¿™å°±å¥½åƒæ¶ˆè´¹è€…ä¸æ–­åœ°åœ¨æ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„å†…å®¹ï¼Œæ¶ˆè´¹çš„é€Ÿç‡ï¼ˆæ¼å‡ºçš„é€Ÿåº¦ï¼‰ç­‰äºé™æµé˜ˆå€¼ã€‚æ¼æ¡¶æœ‰å¤§å°ä¹‹åˆ†ï¼Œå®ƒå¯¹åº”çš„æ˜¯é˜Ÿåˆ—çš„å®¹é‡ï¼Œå¦‚æœè¯·æ±‚çš„é€Ÿç‡å¤§äºäº†æ¶ˆè´¹çš„é€Ÿç‡ï¼Œè¯·æ±‚ä¼šè¢«æš‚å­˜åœ¨æ¡¶ä¸­ã€‚å½“è¯·æ±‚å †ç§¯åˆ°è¶…è¿‡æŒ‡å®šå®¹é‡æ—¶ï¼Œå°±åƒæ˜¯æ°´æº¢å‡ºäº†ä¸€æ ·ï¼Œä¼šè§¦å‘æ‹’ç»ç­–ç•¥ã€‚</p><p>æ¼æ¡¶ç®—æ³•ä¸­çš„æ¶ˆè´¹å¤„ç†æ€»æ˜¯èƒ½ä»¥æ’å®šçš„é€Ÿåº¦è¿›è¡Œï¼Œè¿™å¯ä»¥å¾ˆå¥½åœ°ä¿æŠ¤è‡ªèº«ç³»ç»Ÿä¸è¢«çªå¦‚å…¶æ¥çš„æµé‡å†²å®ã€‚ä½†æ˜¯ï¼Œçªå‘æµé‡å¯èƒ½ä¼šä½¿æ—§è¯·æ±‚å¡«æ»¡é˜Ÿåˆ—ï¼Œå¯¼è‡´æœ€è¿‘çš„è¯·æ±‚å¾—ä¸åˆ°å¤„ç†ã€‚æ­¤å¤–ï¼Œå®ƒä¹Ÿä¸èƒ½ä¿è¯è¯·æ±‚ä¸€å®šä¼šåœ¨æŸä¸ªæ—¶é—´æ®µå†…å¾—åˆ°å¤„ç†ã€‚æ¼æ¡¶ç®—æ³•çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚</p><pre><code class="language-plain">// LeakyBucketLimiter æ¼æ¡¶é™æµå™¨
type LeakyBucketLimiter struct {
	peakLevel       int        // æœ€é«˜æ°´ä½
	currentLevel    int        // å½“å‰æ°´ä½
	currentVelocity int        // æ°´æµé€Ÿåº¦/ç§’
	lastTime        time.Time  // ä¸Šæ¬¡æ”¾æ°´æ—¶é—´
	mutex           sync.Mutex // é¿å…å¹¶å‘é—®é¢˜
}

func NewLeakyBucketLimiter(peakLevel, currentVelocity int) *LeakyBucketLimiter {
	return &amp;LeakyBucketLimiter{
		peakLevel:       peakLevel,
		currentVelocity: currentVelocity,
		lastTime:        time.Now(),
	}
}

func (l *LeakyBucketLimiter) TryAcquire() bool {
	l.mutex.Lock()
	defer l.mutex.Unlock()

	// å°è¯•æ”¾æ°´
	now := time.Now()
	// è·ç¦»ä¸Šæ¬¡æ”¾æ°´çš„æ—¶é—´
	interval := now.Sub(l.lastTime)
	if interval &gt;= time.Second {
		// å½“å‰æ°´ä½-è·ç¦»ä¸Šæ¬¡æ”¾æ°´çš„æ—¶é—´(ç§’)*æ°´æµé€Ÿåº¦
		l.currentLevel = maxInt(0, l.currentLevel-int(interval/time.Second)*l.currentVelocity)
		l.lastTime = now
	}

	// è‹¥åˆ°è¾¾æœ€é«˜æ°´ä½ï¼Œè¯·æ±‚å¤±è´¥
	if l.currentLevel &gt;= l.peakLevel {
		return false
	}
	// è‹¥æ²¡æœ‰åˆ°è¾¾æœ€é«˜æ°´ä½ï¼Œå½“å‰æ°´ä½+1ï¼Œè¯·æ±‚æˆåŠŸ
	l.currentLevel++
	return true
}

func maxInt(a, b int) int {
	if a &gt; b {
		return a
	}
	return b
}
</code></pre><h3>ç”¨ go-micro å®ç°é™æµ</h3><p>é™¤äº†å¸¸è§çš„é™æµç®—æ³•ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨go-microæ¡†æ¶æ¥å®ç°é™æµã€‚è¿™ä¹Ÿæ˜¯ä½¿ç”¨å¾®æœåŠ¡æ¡†æ¶çš„åˆä¸€å¥½å¤„ï¼Œå› ä¸ºæ¡†æ¶ä¸­é€šå¸¸æœ‰é…å¥—çš„é™æµåŠŸèƒ½ã€‚åœ¨go-microçš„æ’ä»¶åº“ä¸­å°è£…äº† <a href="http://github.com/juju/ratelimit">github.com/juju/ratelimit</a> å’Œ <a href="http://go.uber.org/ratelimit">go.uber.org/ratelimit</a> ä¸¤ä¸ªé™æµåº“ï¼Œåˆ†åˆ«æä¾›äº†é™æµçš„ä»¤ç‰Œæ¡¶ç®—æ³•å’Œæ¼æ¡¶ç®—æ³•ã€‚è€Œä¸”å®ƒä»¬æ—¢å¯ä»¥åœ¨go-microçš„å®¢æˆ·ç«¯ä¸­ä¹Ÿå¯ä»¥åœ¨æœåŠ¡å™¨ä¸­ä½¿ç”¨ã€‚</p><p>è¦åœ¨ go-micro GRPC API ä¸­ä½¿ç”¨é™æµåŠŸèƒ½ï¼Œé¦–å…ˆè¦å¯¼å…¥ <a href="https://github.com/go-micro/plugins/tree/main/v4/wrapper/ratelimiter">go-micro é™æµçš„æ’ä»¶åº“</a>ï¼ŒåŒæ—¶å¯¼å…¥ä¸å…¶é…å¥—çš„ç¬¬ä¸‰æ–¹é™æµåº“ï¼š<a href="http://github.com/juju/ratelimit">github.com/juju/ratelimit</a>ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œratelimit.NewBucketWithRateå¯ä»¥è®¾ç½®ä»¤ç‰Œæ¡¶çš„å‚æ•°ã€‚å…¶ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºçš„æ˜¯é€Ÿåº¦ï¼Œåœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸º0.5ï¼Œè¡¨ç¤ºæ¯ç§’é’Ÿæ”¾å…¥çš„ä»¤ç‰Œä¸ªæ•°ä¸º0.5ä¸ªã€‚ç¬¬äºŒä¸ªå‚æ•°ä¸ºæ¡¶çš„å¤§å°ã€‚</p><pre><code class="language-plain">import (
	ratePlugin "github.com/go-micro/plugins/v4/wrapper/ratelimiter/ratelimit"
	"github.com/juju/ratelimit"
)
func RunGRPCServer(m *master.Master, logger *zap.Logger, reg registry.Registry, cfg ServerConfig) {
	b := ratelimit.NewBucketWithRate(0.5, 1)
	service := micro.NewService(
		...
		micro.WrapHandler(ratePlugin.NewHandlerWrapper(b, false))
	)
</code></pre><p>micro.WrapHandleråŒ…è£…äº†go-microçš„Serverç«¯è®¾ç½®çš„é™æµä¸­é—´ä»¶ã€‚ratePlugin.NewHandlerWrapperçš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºä¹‹å‰è®¾ç½®çš„ä»¤ç‰Œæ¡¶ï¼Œç¬¬äºŒä¸ªå‚æ•°å¯ä»¥æŒ‡å®šå½“è¯·æ±‚é€Ÿç‡è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œæ˜¯å¦å µå¡ä½ã€‚æ­¤å¤„ä¸ºfalseï¼Œè¡¨ç¤ºä¸å µå¡å¹¶ç«‹å³è¿”å›é”™è¯¯ã€‚<br>
è¿™ä¸ªä¸­é—´ä»¶çš„åŸç†ä¹Ÿå¾ˆç®€å•ï¼Œå®ƒåœ¨è¿›è¡Œå®é™…çš„GRPCæ–¹æ³•ä¹‹å‰å…ˆè°ƒç”¨äº†é™æµå‡½æ•°ã€‚</p><pre><code class="language-plain">func NewHandlerWrapper(b *ratelimit.Bucket, wait bool) server.HandlerWrapper {
	fn := limit(b, wait, "go.micro.server")

	return func(h server.HandlerFunc) server.HandlerFunc {
		return func(ctx context.Context, req server.Request, rsp interface{}) error {
			if err := fn(); err != nil {
				return err
			}
			return h(ctx, req, rsp)
		}
	}
}
</code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ£€éªŒä¸€ä¸‹æœåŠ¡é™æµçš„æ•ˆæœã€‚</p><p>å¯åŠ¨MasteræœåŠ¡ï¼Œå¹¶å¿«é€Ÿåœ°è°ƒç”¨ä¸¤æ¬¡æœåŠ¡ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œä¼šå‘ç°ç¬¬äºŒæ¬¡è°ƒç”¨æ—¶ï¼ŒæœåŠ¡è¿”å›429çŠ¶æ€ç ï¼Œå¹¶æç¤ºå¤„ç†çš„è¯·æ±‚å¤ªå¤šã€‚ç­‰å¾…ä¸€ç§’åå†æ¬¡è°ƒç”¨ï¼Œå‘ç°åˆå¯ä»¥æ­£å¸¸è¿è¡Œäº†ï¼Œè¿™å°±è¯´æ˜é™æµåŠŸèƒ½æ˜¯æ­£å¸¸çš„ã€‚</p><pre><code class="language-plain">Â» curl -H "content-type: application/json" -d '{"id":"zjx","name": "douban_book_list"}' &lt;http://localhost:8082/crawler/resource&gt;         
{"code":2, "message":"no worker nodes", "details":[]}

Â» curl -H "content-type: application/json" -d '{"id":"zjx","name": "douban_book_list"}' &lt;http://localhost:8082/crawler/resource&gt;   
{"code":2, "message":"{\\"id\\":\\"go.micro.server\\",\\"code\\":429,\\"detail\\":\\"too many request\\",\\"status\\":\\"Too Many Requests\\"}", "details":[{"@type":"type.googleapis.com/errors.Error", "id":"go.micro.server", "code":429, "detail":"too many request", "status":"Too Many Requests"}]}
</code></pre><h2>ç†”æ–­å™¨</h2><p>å®ç°äº†é™æµä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ç†”æ–­ã€‚æˆ‘ä»¬æ˜¯é€šè¿‡ç†”æ–­å™¨æ¥å®ç°ç†”æ–­çš„ã€‚ç†”æ–­å™¨æ˜¯å½“ä¾èµ–çš„ä¸‹æ¸¸æœåŠ¡å¼‚å¸¸æ—¶ï¼Œè´Ÿè´£åœ¨ä¸€æ®µæ—¶é—´å†…ç¦æ­¢è®¿é—®ä¾èµ–æœåŠ¡çš„ä¸€ç§ç³»ç»Ÿç»„ä»¶ï¼Œå®ƒå¯ä»¥é˜²æ­¢æœ‰é—®é¢˜çš„ä¾èµ–æœåŠ¡æ‹–å®è‡ªèº«ç³»ç»Ÿã€‚ç†”æ–­å™¨æœ‰ä¸‹é¢ä¸‰ä¸ªçŠ¶æ€ã€‚</p><ul>
<li>ç†”æ–­å™¨å…³é—­çŠ¶æ€ï¼Œè¡¨æ˜å½“å‰æœåŠ¡å¯ä»¥æ­£å¸¸è®¿é—®ä¸‹æ¸¸çš„ä¾èµ–æœåŠ¡ã€‚</li>
<li>ç†”æ–­å™¨æ‰“å¼€çŠ¶æ€ï¼Œè¡¨æ˜å½“å‰ä¸‹æ¸¸çš„ä¾èµ–æœåŠ¡æœ‰é—®é¢˜ï¼Œå°†è¢«ç¦æ­¢è®¿é—®ã€‚</li>
<li>ç†”æ–­å™¨åŠå¼€çŠ¶æ€ï¼Œå½“å‰é˜¶æ®µä¼šå°è¯•è®©ä¸€éƒ¨åˆ†è¯·æ±‚è®¿é—®ä¸‹æ¸¸ä¾èµ–æœåŠ¡ï¼Œå¦‚æœèƒ½å¤Ÿæ­£å¸¸è®¿é—®ï¼Œåˆ™ä¼šè¿›å…¥ç†”æ–­å™¨å…³é—­çŠ¶æ€ã€‚å¦‚æœä»ç„¶æ— æ³•æ­£å¸¸è®¿é—®ï¼Œåˆ™ä¼šç»´æŒç†”æ–­å™¨æ‰“å¼€çŠ¶æ€ã€‚</li>
</ul><p><img src="https://static001.geekbang.org/resource/image/31/32/31d56857de16aaa260636e659d181632.jpg?wh=1920x860" alt="å›¾ç‰‡"></p><p>ç¤¾åŒºä¸­å·²ç»æœ‰ä¸€äº›éå¸¸ä¼˜ç§€çš„å¼€æºç†”æ–­ç»„ä»¶äº†ï¼Œä¾‹å¦‚&nbsp;<a href="https://github.com/afex/hystrix-go/">hystrix-go</a>ã€<a href="https://github.com/sony/gobreaker">gobreaker</a>ã€<a href="https://github.com/alibaba/Sentinel">Sentinel</a>ã€‚Micro ä¹Ÿæä¾›äº†å¯¹ä¸Šè¿°ç†”æ–­ç»„ä»¶è¿›è¡Œäº†ç®€å•å°è£…çš„æ’ä»¶ï¼ŒåŒ…æ‹¬&nbsp;<a href="https://github.com/go-micro/plugins/tree/main/v4/wrapper/breaker/hystrix">hystrix æ’ä»¶</a>å’Œ <a href="https://github.com/go-micro/plugins/tree/main/v4/wrapper/breaker/gobreaker">gobreaker æ’ä»¶</a>ã€‚</p><h3>go-micoå®ç°ç†”æ–­å™¨</h3><p>æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹å¦‚ä½•åœ¨go-microä¸­ä½¿ç”¨ç†”æ–­å™¨ã€‚æ–¹æ³•éå¸¸ç®€å•ï¼Œè°ƒç”¨micro.WrapClientç”¨äºæ³¨å…¥GRPC clientçš„ä¸­é—´ä»¶ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†<a href="https://github.com/go-micro/plugins/tree/main/v4/wrapper/breaker/hystrix">hystrix æ’ä»¶</a>æ§åˆ¶ç†”æ–­å™¨çš„è¡Œä¸ºã€‚</p><pre><code class="language-plain">import (
	"github.com/go-micro/plugins/v4/wrapper/breaker/c"
)

func RunGRPCServer(m *master.Master, logger *zap.Logger, reg registry.Registry, cfg ServerConfig) {
	service := micro.NewService(
		...
		micro.WrapClient(hystrix.NewClientWrapper()),
	)
}
</code></pre><p>ä¹‹åï¼Œæ‰€æœ‰ä»æ­¤micro clientå‘å‡ºçš„æœåŠ¡è°ƒç”¨éƒ½ä¼šå—åˆ°ç†”æ–­æ’ä»¶çš„é™åˆ¶å’Œä¿æŠ¤ã€‚å½“å¤±è´¥æ¬¡æ•°è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œè°ƒç”¨æ–¹ä¼šç«‹å³æ¥æ”¶åˆ°ç†”æ–­é”™è¯¯ã€‚ç†”æ–­å™¨çš„é…ç½®å‚æ•°ä½äº<code>hystrix-go</code>  åº“ä¸­ï¼Œé»˜è®¤çš„ 5 ä¸ªé‡è¦é…ç½®å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code class="language-plain">	DefaultTimeout = 1000
	DefaultMaxConcurrent = 10
	DefaultVolumeThreshold = 20
	DefaultSleepWindow = 5000
	DefaultErrorPercentThreshold = 50
</code></pre><p>å…¶ä¸­ï¼Œ<code>DefaultTimeout</code> ä¸ºè¯·æ±‚çš„è¶…æ—¶æ—¶é—´ï¼Œ<code>DefaultMaxConcurrent</code> ä¸ºæœ€å¤§çš„å¹¶å‘æ•°é‡ã€‚<br>
<code>DefaultVolumeThreshold</code> ä¸ºè§¦å‘æ–­è·¯å™¨çš„æœ€å°æ•°é‡ï¼Œå¦‚æœæ²¡æœ‰è§¦å‘æ–­è·¯å™¨çš„æœ€å°æ•°é‡ï¼Œå°±ä¸ç”¨ç†”æ–­ï¼Œè¿™é¿å…äº†ä½å³°æœŸçš„å¹²æ‰°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå½“å‰åªæœ‰ä¸€ä¸ªè¯·æ±‚ï¼Œå¹¶ä¸”è®¿é—®å¤±è´¥äº†ï¼Œé‚£ä¹ˆå½“å‰çš„å¤±è´¥ç‡å°±æ˜¯100%ï¼Œè¿™ç§æƒ…å†µä¸‹ç«‹å³ç†”æ–­æœåŠ¡æ˜¯ä¸åˆç†çš„ã€‚</p><p><code>DefaultSleepWindow</code>ä¸ºæ–­è·¯å™¨æ‰“å¼€çŠ¶æ€æ—¶ï¼Œå®ƒä¼šå‘Šè¯‰æˆ‘ä»¬éœ€è¦ç­‰å¾…å¤šé•¿æ—¶é—´å†æ¬¡æ£€æµ‹å½“å‰é“¾è·¯çš„çŠ¶æ€ã€‚<code>DefaultErrorPercentThreshold</code>ä¸ºå¤±è´¥ç‡çš„é˜ˆå€¼ï¼Œå½“å¤±è´¥ç‡è¶…è¿‡è¯¥é˜ˆå€¼æ—¶ï¼Œå°†è§¦å‘ç†”æ–­ã€‚</p><p>åœ¨go-microå½“ä¸­ï¼Œå¯¹ç†”æ–­é…ç½®çš„ç»´åº¦æ˜¯æ¥å£çº§åˆ«çš„ï¼Œè¿™ä¸€ç‚¹å¯ä»¥ä»<a href="https://github.com/micro/go-plugins/tree/master/wrapper/breaker/hystrix">hystrix æ’ä»¶</a>åº“ä¸­æŸ¥çœ‹åˆ°ï¼Œhystrix.DoC çš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯ç†”æ–­çš„ç»´åº¦ã€‚ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ Master æ·»åŠ èµ„æºçš„æ¥å£ï¼Œç†”æ–­çš„ç»´åº¦ä¸ºï¼šgo.micro.server.master.CrawlerMaster.AddResourceã€‚</p><pre><code class="language-plain">func (cw *clientWrapper) Call(ctx context.Context, req client.Request, rsp interface{}, opts ...client.CallOption) error {
	var err error
	herr := hystrix.DoC(ctx, req.Service()+"."+req.Endpoint(), func(c context.Context) error {
		err = cw.Client.Call(c, req, rsp, opts...)
		if cw.filter != nil {
			if cw.filter(ctx, err) {
				return nil
			}
		}
		return err
	}, cw.fallback)
	if herr != nil {
		return herr
	}
	// return original error
	return err
}
</code></pre><p>æˆ‘ä»¬å¯ä»¥è°ƒç”¨æ’ä»¶åº“å°è£…çš„<code>hystrix. ConfigureCommand</code>å‡½æ•°ä¿®æ”¹æŸä¸€ä¸ªæ¥å£çš„ç†”æ–­é…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ä¹Ÿå¯ä»¥è°ƒç”¨<code>hystrix.ConfigureDefault</code> å‡½æ•°ä¿®æ”¹æ‰€æœ‰æ¥å£çš„é»˜è®¤ç†”æ–­å‚æ•°ã€‚</p><pre><code class="language-plain">hystrix.ConfigureCommand("go.micro.server.master.CrawlerMaster.AddResource", hystrix.CommandConfig{
		Timeout:                10000,
		MaxConcurrentRequests:  100,
		RequestVolumeThreshold: 10,
		SleepWindow:            6000,
		ErrorPercentThreshold:  30,
	})
</code></pre><h2>è®¤è¯ä¸é‰´æƒ</h2><p>åœ¨è®¿é—®å¾®æœåŠ¡é›†ç¾¤çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿˜æ—¶å¸¸éœ€è¦è¿›è¡Œç”¨æˆ·çš„è®¤è¯ï¼ˆAuthenticationï¼‰ä¸é‰´æƒï¼ˆAuthorizationï¼‰ã€‚</p><p>è®¤è¯çš„ç›®çš„æ˜¯æ£€æŸ¥ç”¨æˆ·çš„èº«ä»½æ˜¯å¦åˆæ³•ï¼Œé˜²æ­¢åŒ¿åç”¨æˆ·è®¿é—®ç­‰ã€‚è€Œé‰´æƒæ˜¯ä¸ºäº†æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™æ“ä½œè¯·æ±‚çš„èµ„æºã€‚</p><p>è®¤è¯é€šå¸¸æ˜¯è®¿é—®æœåŠ¡çš„ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬æ¯”è¾ƒå¸¸è§çš„æ–¹å¼æ˜¯é€šè¿‡ç”¨æˆ·åå’Œå¯†ç æ¥éªŒè¯ç”¨æˆ·çš„æœ‰æ•ˆæ€§ã€‚ä¸è¿‡ï¼Œä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç æ˜¯æ¯”è¾ƒç¹çè€—æ—¶çš„ï¼šåœ¨æœåŠ¡ç«¯æˆ‘ä»¬é€šå¸¸éœ€è¦è€ƒè™‘ç”¨å¯†æ–‡æ¥å­˜å‚¨å¯†ç ï¼Œè¿˜éœ€è¦æ“ä½œæ•°æ®åº“ã€‚</p><p>å› æ­¤ä»æ€§èƒ½å’Œå®‰å…¨æ€§çš„è§’åº¦è€ƒè™‘ï¼Œåœ¨å®è·µä¸­ï¼Œå½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡å®Œæˆèº«ä»½éªŒè¯ä¹‹åï¼ŒæœåŠ¡å™¨ä¼šä¸ºæˆ‘ä»¬å‘é€ä¸€ä¸ªå‡­è¯ï¼Œå³ä¸€ä¸ªTokenã€‚ä¹‹åï¼Œå®¢æˆ·ç«¯è®¿é—®æœåŠ¡å™¨æ—¶éƒ½éœ€è¦å¸¦ä¸Šè¿™ä¸€ä¸ªTokenã€‚åªè¦Tokenåˆæ³•ä¸”åœ¨æœ‰æ•ˆæœŸå†…ï¼Œå°±å¯ä»¥å¿«é€Ÿåœ°å®ŒæˆéªŒè¯äº†ã€‚Tokençš„æœ‰æ•ˆæœŸé€šå¸¸æ¯”è¾ƒçŸ­ï¼Œè¿™æ ·å³ä¾¿é»‘å®¢åœ¨ä»¥åè·å–äº†Tokenï¼Œè¯¥Tokenä¹Ÿå·²ç»å˜å¾—æ— æ•ˆäº†ã€‚è€Œåˆ©ç”¨Tokenè¿›è¡Œèº«ä»½è®¤è¯è½åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨çš„å°±æ˜¯JWTã€‚</p><p>JWTï¼ˆJson Web Tokenï¼‰æ˜¯åŸºäº JSON çš„å¼€æ”¾æ ‡å‡†ï¼ˆRFC 7519ï¼‰å®šä¹‰çš„ä¸€ç§ç´§å‡‘ã€ç‹¬ç«‹çš„æ ¼å¼ï¼Œä½¿ç”¨å®ƒå¯ä»¥åœ¨å„æ–¹ä¹‹é—´å®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯ã€‚JWTå¯ä»¥ä½¿ç”¨å¯¹ç§°åŠ å¯†ç®—æ³•ï¼ˆHMACç®—æ³•ï¼‰æˆ–è€…éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼ˆRSAï¼ŒECDSAï¼‰è¿›è¡Œç­¾åã€‚ä¸€èˆ¬æˆ‘ä»¬ä¼šæ›´å¤šä½¿ç”¨éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œå› ä¸ºå®ƒæ›´å®‰å…¨ä¸”èƒ½å¤ŸéªŒè¯ä¿¡æ¯çš„å®Œæ•´æ€§ã€‚JWTå¯ä»¥ç”¨äºä¸‹é¢å‡ ç§åœºæ™¯ã€‚</p><ul>
<li>
<p>å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰<br>
SSOæ˜¯ä¸€ç§èº«ä»½éªŒè¯è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥è®©ç”¨æˆ·é€šè¿‡ä¸€æ¬¡æ€§ç”¨æˆ·èº«ä»½éªŒè¯ç™»å½•å¤šä¸ªåº”ç”¨ç¨‹åºå’Œç½‘ç«™ã€‚JWTå¯ä»¥å®ç°å•ç‚¹ç™»å½•æ˜¯å› ä¸ºJWTçš„å¼€é”€å¾ˆå°ï¼Œå¹¶ä¸”èƒ½å¤Ÿè½»æ¾è·¨åŸŸä½¿ç”¨ã€‚</p>
</li>
<li>
<p>ä¿¡æ¯äº¤æ¢<br>
JWTæ˜¯ä¸€ç§åœ¨å„æ–¹ä¹‹é—´å®‰å…¨ä¼ è¾“ä¿¡æ¯çš„å¥½æ–¹æ³•ã€‚å› ä¸º JWT å¯ä»¥ä½¿ç”¨å…¬é’¥/ç§é’¥å¯¹ç­¾åè¿›è¡ŒéªŒè¯ï¼Œä½ å¯ä»¥ç¡®å®šå‘é€è€…çš„çœŸå®èº«ä»½ã€‚æ­¤å¤–ï¼Œç”±äºç­¾åä¸­åŒ…å«äº†å…·ä½“çš„å†…å®¹ï¼Œå› æ­¤ä½ è¿˜å¯ä»¥éªŒè¯å†…å®¹æ˜¯å¦è¢«ç¯¡æ”¹ã€‚</p>
</li>
</ul><p>æˆ‘ä»¬å†æ¥çœ‹ä¸‹JWTçš„ç»„æˆã€‚JWTç”± Headerã€Payloadã€Signature ä¸‰ä¸ªå¯¹è±¡ç»„æˆï¼Œæ­£å¦‚ä¸‹é¢è¿™ä¸ªæ¼”ç¤ºç½‘ç«™ä¸€æ ·ï¼Œå·¦è¾¹ä¸ºç¼–ç åçš„ä¿¡æ¯ï¼Œå³è¾¹ä¸ºç¼–ç å‰çš„ä¸‰ä¸ªå¯¹è±¡ã€‚æ¯ä¸ªå¯¹è±¡éƒ½æ˜¯ä¸€ä¸ª JSON ç»“æ„ä½“ã€‚</p><p>ç¬¬ä¸€ä¸ªå¯¹è±¡æ˜¯ Headerï¼Œå®ƒåŒ…å« alg å’Œ typ ä¸¤ä¸ªå­—æ®µï¼Œalg è¡¨ç¤ºç­¾åçš„ç®—æ³•ï¼Œtyp è¡¨ç¤ºç±»å‹ï¼ˆ JWTï¼‰ã€‚</p><p>ç¬¬äºŒå¯¹è±¡æ˜¯ Payloadï¼Œå®ƒè¡¨ç¤ºè½½è·ï¼ŒåŒ…å«ç”¨æˆ·åã€è¿‡æœŸæ—¶é—´ç­‰ä¿¡æ¯ï¼Œå¯ä»¥è‡ªå®šä¹‰æ·»åŠ å­—æ®µã€‚</p><p>ç¬¬ä¸‰ä¸ªå¯¹è±¡æ˜¯ç­¾åã€‚å®ƒé¦–å…ˆå°† Headerã€Payload ä½¿ç”¨ base64 url ç¼–ç ï¼Œç„¶åå°†ç¼–ç åçš„å­—ç¬¦ä¸²ç”¨"."è¿æ¥åœ¨ä¸€èµ·ï¼Œæœ€åç”¨æˆ‘ä»¬é€‰æ‹©çš„ç®—æ³•è¿›è¡Œç­¾åã€‚</p><p><img src="https://static001.geekbang.org/resource/image/27/b2/275b69yya01a13f67d212e1e62d838b2.png?wh=1920x1039" alt="å›¾ç‰‡"></p><p>ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒJWTä¸­åŒ…å«äº†æœåŠ¡å™¨è®¤è¯éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯ï¼Œåœ¨æœåŠ¡å™¨ä¸­åªéœ€è¦æœ‰å¯¹åº”çš„ç§é’¥è¿›è¡Œè§£å¯†ï¼Œå°±å¯ä»¥çŸ¥é“ä¿¡æ¯çš„å®Œæ•´æ€§ï¼Œç”¨æˆ·çš„æœ‰æ•ˆæ€§ï¼Œè¿˜å¯ä»¥é¢å¤–åœ°ä¼ é€’ä¸€äº›å…¶ä»–ä¿¡æ¯ã€‚</p><p>åœ¨å®è·µä¸­ï¼Œè®¤è¯ä¸€èˆ¬åˆ†ä¸ºä¸‹é¢ä¸‰æ­¥ã€‚</p><ol>
<li>å®¢æˆ·ç«¯ä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç è®¿é—®æœåŠ¡å™¨çš„ç™»å½•æ¥å£ã€‚</li>
<li>å½“æœåŠ¡å™¨è®¤è¯æˆåŠŸåï¼Œç”ŸæˆJWTã€‚</li>
<li>å®¢æˆ·ç«¯åœ¨ä¹‹åçš„è¯·æ±‚ä¸­ï¼Œéƒ½å¸¦ä¸ŠJWTï¼Œç”±æœåŠ¡å™¨å¯¹Tokenè¿›è¡ŒéªŒè¯ã€‚</li>
</ol><p>ç¬¬ä¸€æ­¥å’Œç¬¬äºŒæ­¥å¯èƒ½æ˜¯åœ¨å•ç‹¬çš„æˆæƒæœåŠ¡ä¸­åšçš„ï¼Œè€Œç¬¬ä¸‰æ­¥åˆ™éœ€è¦å¯¹åº”çš„æœåŠ¡æä¾›Tokençš„æ ¡éªŒæ”¯æŒã€‚</p><p>go-microä¸­ä¹Ÿæä¾›äº†å¯¹äºJWTçš„æ”¯æŒï¼Œå¯ä»¥è½»æ¾åœ°ç”Ÿæˆå¹¶æ ¡éªŒJWTã€‚è¯´åˆ°è¿™å„¿ï¼Œä½ å¾ˆå®¹æ˜“æƒ³åˆ°ä¸­é—´ä»¶ï¼Œæ²¡é”™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªä¸­é—´ä»¶æ¥æä¾›å¯¹JWTçš„æ ¡éªŒã€‚ä¸‹é¢æ˜¯æˆ‘ç”Ÿæˆçš„ä¸€ä¸ªæ ¡éªŒJWT tokençš„ä¸­é—´ä»¶ã€‚</p><pre><code class="language-plain">func NewAuthWrapper(service micro.Service) server.HandlerWrapper {
	return func(h server.HandlerFunc) server.HandlerFunc {
		return func(ctx context.Context, req server.Request, rsp interface{}) error {
			// Fetch metadata from context (request headers).
			md, b := metadata.FromContext(ctx)
			if !b {
				return errors.New("no metadata found")
			}

			// Get auth header.
			authHeader, ok := md["Authorization"]
			if !ok || !strings.HasPrefix(authHeader, auth.BearerScheme) {
				return errors.New("no auth token provided")
			}

			// Extract auth token.
			token := strings.TrimPrefix(authHeader, auth.BearerScheme)

			// Extract account from token.
			a := service.Options().Auth
			_, err := a.Inspect(token)
			if err != nil {
				return errors.New("auth token invalid")
			}

			return h(ctx, req, rsp)
		}
	}
}
</code></pre><p>å…¶ä¸­ï¼Œservice.Options().Authæ˜¯ go-micro æä¾›çš„è®¤è¯ä¸é‰´æƒçš„æ¥å£ã€‚</p><pre><code class="language-plain">type Auth interface {
	// Init the auth
	Init(opts ...Option)
	// Options set for auth
	Options() Options
	// Generate a new account
	Generate(id string, opts ...GenerateOption) (*Account, error)
	// Inspect a token
	Inspect(token string) (*Account, error)
	// Token generated using refresh token or credentials
	Token(opts ...TokenOption) (*Token, error)
	// String returns the name of the implementation
	String() string
} 
</code></pre><p>è€Œè¦ä½¿ç”¨JWTæ’ä»¶åŠŸèƒ½ï¼Œéœ€è¦å¯¼å…¥go-microçš„jwtæ’ä»¶åº“ï¼Œå¹¶è®¾ç½®ä¹‹å‰å¤„ç†JWTçš„ä¸­é—´ä»¶å³å¯ã€‚</p><pre><code class="language-plain">import (
	_ "github.com/go-micro/plugins/v4/auth/jwt"
)

var (
	name    = "helloworld"
	version = "latest"
)

func main() {

	// Create service
	srv := micro.NewService(...)

	srv.Init(
		micro.Name(name),
		micro.Version(version),
		micro.WrapHandler(NewAuthWrapper(srv)),
	)
</code></pre><p>go-microè¿˜æä¾›åŸºäºJWTçš„ä¸€äº›åŸºæœ¬çš„æˆæƒèƒ½åŠ›ï¼Œé™åˆ¶ç”¨æˆ·è®¿é—®çš„è·¯ç”±ã€æœåŠ¡å’Œèµ„æºã€‚è¿™äº›èƒ½åŠ›æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œå°±ä¸å†è®¨è®ºäº†ã€‚</p><h2>æ€»ç»“</h2><p>æ€»ç»“ä¸€ä¸‹ï¼Œè¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å®è·µäº†ä¿è¯å¤§è§„æ¨¡å¾®æœåŠ¡é›†ç¾¤æ­£å¸¸è¿è¡Œéœ€è¦å…·å¤‡çš„é‡è¦åŠŸèƒ½ï¼Œå³é™æµã€ç†”æ–­ä¸è®¤è¯ã€‚</p><p>é™æµæŒ‡çš„æ˜¯é™åˆ¶ç»™å®šæ—¶é—´å†…äº‹ä»¶å‘ç”Ÿçš„é¢‘ç‡ï¼Œè¿™èƒ½å¤Ÿä¿è¯å¤–éƒ¨çš„è¯·æ±‚å§‹ç»ˆä½äºæœåŠ¡å™¨èƒ½å¤Ÿæ‰¿è½½çš„èŒƒå›´å†…ã€‚è¿™èŠ‚è¯¾æˆ‘ä»¬ä»‹ç»äº†å‡ ç§ç»å…¸çš„é™æµç®—æ³•å’ŒåŸç†ï¼Œå®ƒä»¬å„æœ‰ç‰¹ç‚¹ï¼Œéœ€è¦æ ¹æ®å®é™…ä¸šåŠ¡åœºæ™¯è¿›è¡Œé€‰æ‹©ã€‚</p><p>ç†”æ–­ç±»ä¼¼äºæ–­è·¯å™¨ï¼Œå½“å‘ç°ä¾èµ–æœåŠ¡å¼‚å¸¸æ—¶ï¼Œå®ƒå¯ä»¥åœ¨ä¸€æ®µæ—¶é—´å†…ç¦æ­¢è®¿é—®ä¾èµ–æœåŠ¡ï¼Œé˜²æ­¢ä¾èµ–æœåŠ¡æ‹–å®è‡ªèº«æˆ–è€…è¿”å›é”™è¯¯çš„æ•°æ®ã€‚</p><p>è€Œè®¤è¯ä¸é‰´æƒç”¨äºæ£€æŸ¥è®¿é—®è€…çš„èº«ä»½ä¸æƒé™ï¼Œç²¾å‡†å¯¹è®¿é—®è€…è¿›è¡Œæƒé™çš„æ§åˆ¶ï¼Œé˜²æ­¢è¶Šæƒçš„æ“ä½œã€‚</p><p>è¿™å‡ ç§èƒ½åŠ›ä¿è¯äº†å¾®æœåŠ¡é›†ç¾¤çš„æ­£å¸¸è¿è¡Œï¼Œæ˜¯å¤§è§„æ¨¡å¾®æœåŠ¡é›†ç¾¤ä¸­å¿…ä¸å¯å°‘çš„æ²»ç†æ‰‹æ®µã€‚æˆ‘ä»¬è¿˜åˆ†åˆ«è®²è§£äº†å¦‚ä½•ç”¨go-microæ¡†æ¶æ¥å®ç°è¿™äº›èƒ½åŠ›ã€‚go-microå¾®æœåŠ¡æ¡†æ¶æœ‰ç€ä¸°å¯Œçš„æ’ä»¶åº“ï¼Œèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®ç°è¿™äº›æ²»ç†åŠŸèƒ½ï¼Œè®©å¼€å‘è€…æ›´å…³æ³¨äºå¼€å‘æ ¸å¿ƒçš„ä¸šåŠ¡é€»è¾‘ã€‚</p><h2>è¯¾åé¢˜</h2><p>æœ€åï¼Œè¿˜æ˜¯ç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜ã€‚</p><p>å¸¸è§çš„æƒé™æ§åˆ¶æ–¹å¼æœ‰å“ªäº›ï¼Ÿkubernetesä¸etcdä¸ºä»€ä¹ˆéƒ½é€‰æ‹©äº†RBACè¿›è¡Œæƒé™æ§åˆ¶ï¼Ÿ</p><p>æ¬¢è¿ä½ ç»™æˆ‘ç•™è¨€äº¤æµè®¨è®ºï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/15/32/fe/c2179924.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>mantra</span>
  </div>
  <div class="_2_QraFYR_0">æ–‡æ¡£ä¸­ç»™çš„å„ç±»æ’ä»¶åœ°å€éƒ½ä¸å¯¹ã€‚æ¯”å¦‚ï¼Œâ€œhystrix æ’ä»¶â€çš„åœ°å€æ­£ç¡®çš„æ˜¯ https:&#47;&#47;github.com&#47;go-micro&#47;plugins&#47;tree&#47;main&#47;v4&#47;wrapper&#47;breaker&#47;hystrix è€Œä¸æ˜¯ https:&#47;&#47;github.com&#47;micro&#47;go-plugins&#47;tree&#47;master&#47;wrapper&#47;breaker&#47;hystrixã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ğŸ‘ğŸ»å°½å¿«ä¼šä¿®å¤</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-02-02 08:57:45</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/7f/d3/b5896293.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Realm</span>
  </div>
  <div class="_2_QraFYR_0">åœ¨Kubernetesä¸­ï¼Œæˆæƒæœ‰ï¼š<br>- ABACï¼ˆåŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼‰ã€<br>- RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰ã€<br>- Webhookã€<br>- Nodeã€<br>- AlwaysDenyï¼ˆä¸€ç›´æ‹’ç»ï¼‰å’Œ<br>- AlwaysAllowï¼ˆä¸€ç›´å…è®¸ï¼‰<br>è¿™6ç§æ¨¡å¼ã€‚<br><br>ä»1.6ç‰ˆæœ¬èµ·ï¼ŒKubernetes é»˜è®¤å¯ç”¨RBACè®¿é—®æ§åˆ¶ç­–ç•¥ã€‚ä»1.8å¼€å§‹ï¼ŒRBACå·²ä½œä¸ºç¨³å®šçš„åŠŸèƒ½ã€‚é€šè¿‡è®¾ç½®â€“authorization-mode=RBACï¼Œå¯ç”¨RABCã€‚æ‰€ä»¥RBACä¹Ÿå°±æˆäº†ä¸€ç§é»˜è®¤é€‰ç”¨çš„æˆæƒæ¨¡å¼ã€‚<br><br>RBACä¸‰è¦ç´ ï¼šç”¨æˆ·ã€è§’è‰²ã€æƒé™ã€‚<br>ç”¨æˆ·ä¸è§’è‰²å…³è”ï¼Œæ ¹æ®è§„åˆ™èµ‹äºˆè§’è‰²ç›¸å…³çš„æƒé™ï¼Œæ•´ä½“æ¯”è¾ƒçµæ´»ï¼Œæ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§è¾ƒé«˜ã€‚<br><br>etcdä¼°è®¡ä¹Ÿæ˜¯è¿™ä¸ªåŸå› .</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-02-07 15:28:38</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/1a/3a/de/ed40f1bb.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>èƒ¡å†›</span>
  </div>
  <div class="_2_QraFYR_0">å¸Œæœ›èƒ½åœ¨æ¯ä¸ªç®—æ³•ä»‹ç»ä¸­ç»™ä¸ªç¤ºæ„å›¾ï¼Œçº¯æ–‡å­—ç‰ˆä¸å¦‚å›¾ç‰‡ç›´è§‚æ˜“ç†è§£ğŸ™„</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ğŸ‘Œ</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-02-06 08:30:09</div>
  </div>
</div>
</div>
</li>
</ul>