<audio title="35 _ æ•ˆç‡ç¥å™¨ï¼šå¦‚ä½•è®¾è®¡å’Œå®ç°ä¸€ä¸ªå‘½ä»¤è¡Œå®¢æˆ·ç«¯å·¥å…·ï¼Ÿ" src="https://static001.geekbang.org/resource/audio/a2/27/a250cabb45d0193986496aafda569727.mp3" controls="controls"></audio> 
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å­”ä»¤é£ã€‚ä»Šå¤©æˆ‘ä»¬æ¥èŠèŠï¼Œå¦‚ä½•å®ç°ä¸€ä¸ªå‘½ä»¤è¡Œå®¢æˆ·ç«¯å·¥å…·ã€‚</p><p>å¦‚æœä½ ç”¨è¿‡Kubernetesã€Istioã€etcdï¼Œé‚£ä½ ä¸€å®šç”¨è¿‡è¿™äº›å¼€æºé¡¹ç›®æ‰€æä¾›çš„å‘½ä»¤è¡Œå·¥å…·ï¼škubectlã€istioctlã€etcdctlã€‚ä¸€ä¸ª <code>xxx</code> é¡¹ç›®ï¼Œä¼´éšç€ä¸€ä¸ª <code>xxxctl</code> å‘½ä»¤è¡Œå·¥å…·ï¼Œè¿™ä¼¼ä¹å·²ç»æˆä¸ºä¸€ç§è¶‹åŠ¿ï¼Œåœ¨ä¸€äº›å¤§å‹ç³»ç»Ÿä¸­æ›´æ˜¯å¸¸è§ã€‚æä¾› <code>xxxctl</code> å‘½ä»¤è¡Œå·¥å…·æœ‰è¿™ä¸¤ä¸ªå¥½å¤„ï¼š</p><ul>
<li>å®ç°è‡ªåŠ¨åŒ–ï¼šå¯ä»¥é€šè¿‡åœ¨è„šæœ¬ä¸­è°ƒç”¨ <code>xxxctl</code> å·¥å…·ï¼Œå®ç°è‡ªåŠ¨åŒ–ã€‚</li>
<li>æé«˜æ•ˆç‡ï¼šé€šè¿‡å°†åº”ç”¨çš„åŠŸèƒ½å°è£…æˆå‘½ä»¤å’Œå‚æ•°ï¼Œæ–¹ä¾¿è¿ç»´ã€å¼€å‘äººå‘˜åœ¨LinuxæœåŠ¡å™¨ä¸Šè°ƒç”¨ã€‚</li>
</ul><p>å…¶ä¸­ï¼Œkubectlå‘½ä»¤è®¾è®¡çš„åŠŸèƒ½æœ€ä¸ºå¤æ‚ï¼Œä¹Ÿæ˜¯éå¸¸ä¼˜ç§€çš„å‘½ä»¤è¡Œå·¥å…·ï¼ŒIAMé¡¹ç›®çš„iamctlå®¢æˆ·ç«¯å·¥å…·å°±æ˜¯ä»¿ç…§kubectlæ¥å®ç°çš„ã€‚è¿™ä¸€è®²ï¼Œæˆ‘å°±é€šè¿‡å‰–æiamctlå‘½ä»¤è¡Œå·¥å…·çš„å®ç°ï¼Œæ¥ä»‹ç»ä¸‹å¦‚ä½•å®ç°ä¸€ä¸ªä¼˜ç§€çš„å®¢æˆ·ç«¯å·¥å…·ã€‚</p><h2>å¸¸è§å®¢æˆ·ç«¯ä»‹ç»</h2><p>åœ¨ä»‹ç»iamctlå‘½ä»¤è¡Œå·¥å…·çš„å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹å¸¸è§çš„å®¢æˆ·ç«¯ã€‚</p><p>å®¢æˆ·ç«¯åˆå«ç”¨æˆ·ç«¯ï¼Œä¸åç«¯æœåŠ¡ç›¸å¯¹åº”ï¼Œå®‰è£…åœ¨å®¢æˆ·æœºä¸Šï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨è¿™äº›å®¢æˆ·ç«¯è®¿é—®åç«¯æœåŠ¡ã€‚ä¸åŒçš„å®¢æˆ·ç«¯é¢å‘çš„äººç¾¤ä¸åŒï¼Œæ‰€èƒ½æä¾›çš„è®¿é—®èƒ½åŠ›ä¹Ÿæœ‰å·®å¼‚ã€‚å¸¸è§çš„å®¢æˆ·ç«¯æœ‰ä¸‹é¢è¿™å‡ ç§ï¼š</p><ul>
<li>å‰ç«¯ï¼ŒåŒ…æ‹¬æµè§ˆå™¨ã€æ‰‹æœºåº”ç”¨ï¼›</li>
<li>SDKï¼›</li>
<li>å‘½ä»¤è¡Œå·¥å…·ï¼›</li>
<li>å…¶ä»–ç»ˆç«¯ã€‚</li>
</ul><!-- [[[read_end]]] --><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å°±æ¥åˆ†åˆ«ä»‹ç»ä¸‹ã€‚</p><p>æµè§ˆå™¨å’Œæ‰‹æœºåº”ç”¨æä¾›ä¸€ä¸ªäº¤äº’ç•Œé¢ä¾›ç”¨æˆ·è®¿é—®åç«¯æœåŠ¡ï¼Œä½¿ç”¨ä½“éªŒæœ€å¥½ï¼Œé¢å‘çš„äººç¾¤æ˜¯æœ€ç»ˆçš„ç”¨æˆ·ã€‚è¿™ä¸¤ç±»å®¢æˆ·ç«¯ä¹Ÿç§°ä¸ºå‰ç«¯ã€‚å‰ç«¯ç”±å‰ç«¯å¼€å‘äººå‘˜è¿›è¡Œå¼€å‘ï¼Œå¹¶é€šè¿‡APIæ¥å£ï¼Œè°ƒç”¨åç«¯çš„æœåŠ¡ã€‚åç«¯å¼€å‘äººå‘˜ä¸éœ€è¦å…³æ³¨è¿™ä¸¤ç±»å®¢æˆ·ç«¯ï¼Œåªéœ€è¦å…³æ³¨å¦‚ä½•æä¾›APIæ¥å£å³å¯ã€‚</p><p>SDKï¼ˆSoftware Development Kitï¼‰ä¹Ÿæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œä¾›å¼€å‘è€…è°ƒç”¨ã€‚å¼€å‘è€…è°ƒç”¨APIæ—¶ï¼Œå¦‚æœæ˜¯é€šè¿‡HTTPåè®®ï¼Œéœ€è¦ç¼–å†™HTTPçš„è°ƒç”¨ä»£ç ã€HTTPè¯·æ±‚åŒ…çš„å°è£…å’Œè¿”å›åŒ…çš„è§£å°ï¼Œè¿˜è¦å¤„ç†HTTPçš„çŠ¶æ€ç ï¼Œä½¿ç”¨èµ·æ¥ä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚SDKå…¶å®æ˜¯å°è£…äº†APIæ¥å£çš„ä¸€ç³»åˆ—å‡½æ•°é›†åˆï¼Œå¼€å‘è€…é€šè¿‡è°ƒç”¨SDKä¸­çš„å‡½æ•°è°ƒç”¨APIæ¥å£ï¼Œæä¾›SDKä¸»è¦æ˜¯æ–¹ä¾¿å¼€å‘è€…è°ƒç”¨ï¼Œå‡å°‘å·¥ä½œé‡ã€‚</p><p>å‘½ä»¤è¡Œå·¥å…·æ˜¯å¯ä»¥åœ¨æ“ä½œç³»ç»Ÿä¸Šæ‰§è¡Œçš„ä¸€ä¸ªäºŒè¿›åˆ¶ç¨‹åºï¼Œæä¾›äº†ä¸€ç§æ¯”SDKå’ŒAPIæ¥å£æ›´æ–¹ä¾¿å¿«æ·çš„è®¿é—®åç«¯æœåŠ¡çš„é€”å¾„ï¼Œä¾›è¿ç»´æˆ–è€…å¼€å‘äººå‘˜åœ¨æœåŠ¡å™¨ä¸Šç›´æ¥æ‰§è¡Œä½¿ç”¨ï¼Œæˆ–è€…åœ¨è‡ªåŠ¨åŒ–è„šæœ¬ä¸­è°ƒç”¨ã€‚</p><p>è¿˜æœ‰å…¶ä»–å„ç±»å®¢æˆ·ç«¯ï¼Œè¿™é‡Œæˆ‘åˆ—ä¸¾ä¸€äº›å¸¸è§çš„ã€‚</p><ul>
<li>ç»ˆç«¯è®¾å¤‡ï¼šPOSæœºã€å­¦ä¹ æœºã€æ™ºèƒ½éŸ³ç®±ç­‰ã€‚</li>
<li>ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºï¼šé€šè¿‡è°ƒç”¨APIæ¥å£æˆ–è€…SDKï¼Œè°ƒç”¨æˆ‘ä»¬æä¾›çš„åç«¯æœåŠ¡ï¼Œä»è€Œå®ç°è‡ªèº«çš„åŠŸèƒ½ã€‚</li>
<li>è„šæœ¬ï¼šè„šæœ¬ä¸­é€šè¿‡APIæ¥å£æˆ–è€…å‘½ä»¤è¡Œå·¥å…·ï¼Œè°ƒç”¨æˆ‘ä»¬æä¾›çš„åç«¯æœåŠ¡ï¼Œå®ç°è‡ªåŠ¨åŒ–ã€‚</li>
</ul><p>è¿™äº›å…¶ä»–çš„å„ç±»å®¢æˆ·ç«¯ï¼Œéƒ½æ˜¯é€šè¿‡è°ƒç”¨APIæ¥å£ä½¿ç”¨åç«¯æœåŠ¡çš„ï¼Œå®ƒä»¬è·Ÿå‰ç«¯ä¸€æ ·ï¼Œä¹Ÿä¸éœ€è¦åå°å¼€å‘äººå‘˜å¼€å‘ã€‚</p><p>éœ€è¦åå°å¼€å‘äººå‘˜æŠ•å…¥å·¥ä½œé‡è¿›è¡Œç ”å‘çš„å®¢æˆ·ç«¯æ˜¯SDKå’Œå‘½ä»¤è¡Œå·¥å…·ã€‚è¿™ä¸¤ç±»å®¢æˆ·ç«¯å·¥å…·æœ‰ä¸ªè°ƒç”¨å’Œè¢«è°ƒç”¨çš„é¡ºåºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://static001.geekbang.org/resource/image/e9/91/e97e547bec77dc7129615b11792f1291.jpg?wh=1920x568" alt="å›¾ç‰‡"></p><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œå‘½ä»¤è¡Œå·¥å…·å’ŒSDKæœ€ç»ˆéƒ½æ˜¯é€šè¿‡APIæ¥å£è°ƒç”¨åç«¯æœåŠ¡çš„ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥ä¿è¯æœåŠ¡çš„ä¸€è‡´æ€§ï¼Œå¹¶å‡å°‘ä¸ºé€‚é…å¤šä¸ªå®¢æˆ·ç«¯æ‰€å¸¦æ¥çš„é¢å¤–å¼€å‘å·¥ä½œé‡ã€‚</p><h2>å¤§å‹ç³»ç»Ÿå®¢æˆ·ç«¯ï¼ˆxxxctlï¼‰çš„ç‰¹ç‚¹</h2><p>é€šè¿‡å­¦ä¹ kubectlã€istioctlã€etcdctlè¿™äº›ä¼˜ç§€çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ä»¥å‘ç°ä¸€ä¸ªå¤§å‹ç³»ç»Ÿçš„å‘½ä»¤è¡Œå·¥å…·ï¼Œé€šå¸¸å…·æœ‰ä¸‹é¢è¿™äº›ç‰¹ç‚¹ï¼š</p><ul>
<li>æ”¯æŒå‘½ä»¤å’Œå­å‘½ä»¤ï¼Œå‘½ä»¤/å­å‘½åæœ‰è‡ªå·±ç‹¬æœ‰çš„å‘½ä»¤è¡Œå‚æ•°ã€‚</li>
<li>æ”¯æŒä¸€äº›ç‰¹æ®Šçš„å‘½ä»¤ã€‚æ¯”å¦‚æ”¯æŒcompletionå‘½ä»¤ï¼Œcompletionå‘½ä»¤å¯ä»¥è¾“å‡ºbash/zshè‡ªåŠ¨è¡¥å…¨è„šæœ¬ï¼Œå®ç°å‘½ä»¤è¡ŒåŠå‚æ•°çš„è‡ªåŠ¨è¡¥å…¨ã€‚è¿˜æ”¯æŒ versionå‘½ä»¤ï¼Œversionå‘½ä»¤ä¸ä»…å¯ä»¥è¾“å‡ºå®¢æˆ·ç«¯çš„ç‰ˆæœ¬ï¼Œè¿˜å¯ä»¥è¾“å‡ºæœåŠ¡ç«¯çš„ç‰ˆæœ¬ï¼ˆå¦‚æœæœ‰éœ€è¦ï¼‰ã€‚</li>
<li>æ”¯æŒå…¨å±€optionï¼Œå…¨å±€optionå¯ä»¥ä½œä¸ºæ‰€æœ‰å‘½ä»¤åŠå­å‘½ä»¤çš„å‘½ä»¤è¡Œå‚æ•°ã€‚</li>
<li>æ”¯æŒ-h/helpï¼Œ-h/helpå¯ä»¥æ‰“å°xxxctlçš„å¸®åŠ©ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š</li>
</ul><pre><code class="language-bash">$ iamctl -h
iamctl controls the iam platform, is the client side tool for iam platform.

&nbsp;Find more information at:
https://github.com/marmotedu/iam/blob/master/docs/guide/en-US/cmd/iamctl/iamctl.md

Basic Commands:
&nbsp; info&nbsp; &nbsp; &nbsp; &nbsp; Print the host information
&nbsp; color&nbsp; &nbsp; &nbsp; &nbsp;Print colors supported by the current terminal
&nbsp; new&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Generate demo command code
&nbsp; jwt&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;JWT command-line tool

Identity and Access Management Commands:
&nbsp; user&nbsp; &nbsp; &nbsp; &nbsp; Manage users on iam platform
&nbsp; secret&nbsp; &nbsp; &nbsp; Manage secrets on iam platform
&nbsp; policy&nbsp; &nbsp; &nbsp; Manage authorization policies on iam platform

Troubleshooting and Debugging Commands:
&nbsp; validate&nbsp; &nbsp; Validate the basic environment for iamctl to run

Settings Commands:
&nbsp; set&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Set specific features on objects
&nbsp; completion&nbsp; Output shell completion code for the specified shell (bash or zsh)

Other Commands:
&nbsp; version&nbsp; &nbsp; &nbsp;Print the client and server version information

Usage:
&nbsp; iamctl [flags] [options]

Use "iamctl &lt;command&gt; --help" for more information about a given command.
Use "iamctl options" for a list of global command-line options (applies to all commands).
</code></pre><ul>
<li>æ”¯æŒ <code>xxxctl help [command | command subcommand] [command | command subcommand] -h</code> ï¼Œæ‰“å°å‘½ä»¤/å­å‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯ï¼Œæ ¼å¼é€šå¸¸ä¸º <code>å‘½ä»¤æè¿° + ä½¿ç”¨æ–¹æ³•</code>  ã€‚ä¾‹å¦‚ï¼š</li>
</ul><pre><code class="language-bash">$ istioctl help register
Registers a service instance (e.g. VM) joining the mesh
&nbsp;
Usage:
&nbsp; istioctl register &lt;svcname&gt; &lt;ip&gt; [name1:]port1 [name2:]port2 ... [flags]
</code></pre><p>é™¤æ­¤ä¹‹å¤–ï¼Œä¸€ä¸ªå¤§å‹ç³»ç»Ÿçš„å‘½ä»¤è¡Œå·¥å…·è¿˜å¯ä»¥æ”¯æŒä¸€äº›æ›´é«˜é˜¶çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šæ”¯æŒå‘½ä»¤åˆ†ç»„ï¼Œæ”¯æŒé…ç½®æ–‡ä»¶ï¼Œæ”¯æŒå‘½ä»¤çš„ä½¿ç”¨exampleï¼Œç­‰ç­‰ã€‚</p><p>åœ¨Goç”Ÿæ€ä¸­ï¼Œå¦‚æœæˆ‘ä»¬è¦æ‰¾ä¸€ä¸ªç¬¦åˆä¸Šé¢æ‰€æœ‰ç‰¹ç‚¹çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œé‚£é<a href="https://github.com/kubernetes/kubernetes/blob/master/cmd/kubectl/">kubectl</a>è«å±ã€‚å› ä¸ºæˆ‘ä»Šå¤©è¦é‡ç‚¹è®²çš„iamctlå®¢æˆ·ç«¯å·¥å…·ï¼Œå°±æ˜¯ä»¿ç…§å®ƒæ¥å®ç°çš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸å±•å¼€ä»‹ç»kubectläº†ï¼Œä¸è¿‡è¿˜æ˜¯å»ºè®®ä½ è®¤çœŸç ”ç©¶ä¸‹kubectlçš„å®ç°ã€‚</p><h2>iamctlçš„æ ¸å¿ƒå®ç°</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å°±æ¥ä»‹ç»IAMç³»ç»Ÿè‡ªå¸¦çš„iamctlå®¢æˆ·ç«¯å·¥å…·ï¼Œå®ƒæ˜¯ä»¿ç…§kubectlæ¥å®ç°çš„ï¼Œèƒ½å¤Ÿæ»¡è¶³ä¸€ä¸ªå¤§å‹ç³»ç»Ÿå®¢æˆ·ç«¯å·¥å…·çš„éœ€æ±‚ã€‚æˆ‘ä¼šä»iamctlçš„åŠŸèƒ½ã€ä»£ç ç»“æ„ã€å‘½ä»¤è¡Œé€‰é¡¹å’Œé…ç½®æ–‡ä»¶è§£æ4ä¸ªæ–¹é¢æ¥ä»‹ç»ã€‚</p><h3>iamctlçš„åŠŸèƒ½</h3><p>iamctlå°†å‘½ä»¤è¿›è¡Œäº†åˆ†ç±»ã€‚è¿™é‡Œï¼Œæˆ‘ä¹Ÿå»ºè®®ä½ å¯¹å‘½ä»¤è¿›è¡Œåˆ†ç±»ï¼Œå› ä¸ºé€šè¿‡åˆ†ç±»ï¼Œä¸ä»…å¯ä»¥ååŠ©ä½ ç†è§£å‘½ä»¤çš„ç”¨é€”ï¼Œè¿˜èƒ½å¸®ä½ å¿«é€Ÿå®šä½æŸç±»å‘½ä»¤ã€‚å¦å¤–ï¼Œå½“å‘½ä»¤å¾ˆå¤šæ—¶ï¼Œåˆ†ç±»ä¹Ÿå¯ä»¥ä½¿å‘½ä»¤çœ‹èµ·æ¥æ›´è§„æ•´ã€‚</p><p>iamctlå®ç°çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p><p><img src="https://static001.geekbang.org/resource/image/1d/da/1dee217f8be94ae1c3c1d9b29d627eda.jpg?wh=1920x1696" alt="å›¾ç‰‡"></p><p>æ›´è¯¦ç»†çš„åŠŸèƒ½ï¼Œä½ å¯ä»¥å‚è€ƒ <code>iamctl -h</code> ã€‚æˆ‘å»ºè®®ä½ åœ¨å®ç°xxxctlå·¥å…·æ—¶ï¼Œè€ƒè™‘å®ç°ä¸‹é¢è¿™å‡ ä¸ªåŠŸèƒ½ã€‚</p><ul>
<li>APIåŠŸèƒ½ï¼šå¹³å°å…·æœ‰çš„APIåŠŸèƒ½ï¼Œéƒ½èƒ½é€šè¿‡xxxctlæ–¹ä¾¿åœ°è¿›è¡Œè°ƒç”¨ã€‚</li>
<li>å·¥å…·ï¼šä¸€äº›ä½¿ç”¨IAMç³»ç»Ÿæ—¶æœ‰ç”¨çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ç­¾å‘JWT Tokenã€‚</li>
<li>versionã€completionã€validateå‘½ä»¤ã€‚</li>
</ul><h3>ä»£ç ç»“æ„</h3><p>iamctlå·¥å…·çš„mainå‡½æ•°ä½äº<a href="https://github.com/marmotedu/iam/blob/v1.0.6/cmd/iamctl/iamctl.go">iamctl.go</a>æ–‡ä»¶ä¸­ã€‚å‘½ä»¤çš„å®ç°å­˜æ”¾åœ¨<a href="https://github.com/marmotedu/iam/blob/v1.0.6/internal/iamctl/cmd/cmd.go">internal/iamctl/cmd/cmd.go</a>æ–‡ä»¶ä¸­ã€‚iamctlçš„å‘½ä»¤ç»Ÿä¸€å­˜æ”¾åœ¨<a href="https://github.com/marmotedu/iam/tree/v1.0.6/internal/iamctl/cmd">internal/iamctl/cmd</a>ç›®å½•ä¸‹ï¼Œæ¯ä¸ªå‘½ä»¤éƒ½æ˜¯ä¸€ä¸ªGoåŒ…ï¼ŒåŒ…åå³ä¸ºå‘½ä»¤åï¼Œå…·ä½“å®ç°å­˜æ”¾åœ¨ <code>internal/iamctl/cmd/&lt;å‘½ä»¤&gt;/&lt;å‘½ä»¤&gt;.go</code> æ–‡ä»¶ä¸­ã€‚å¦‚æœå‘½ä»¤æœ‰å­å‘½ä»¤ï¼Œåˆ™å­å‘½ä»¤çš„å®ç°å­˜æ”¾åœ¨ <code>internal/iamctl/cmd/&lt;å‘½ä»¤&gt;/&lt;å‘½ä»¤&gt;_&lt;å­å‘½ä»¤&gt;.go</code> æ–‡ä»¶ä¸­ã€‚</p><p>ä½¿ç”¨è¿™ç§ä»£ç ç»„ç»‡æ–¹å¼ï¼Œå³ä½¿æ˜¯åœ¨å‘½ä»¤å¾ˆå¤šçš„æƒ…å†µä¸‹ï¼Œä¹Ÿèƒ½è®©ä»£ç äº•ç„¶æœ‰åºï¼Œæ–¹ä¾¿å®šä½å’Œç»´æŠ¤ä»£ç ã€‚</p><h3>å‘½ä»¤è¡Œé€‰é¡¹</h3><p>æ·»åŠ å‘½ä»¤è¡Œé€‰é¡¹çš„ä»£ç åœ¨<a href="https://github.com/marmotedu/iam/blob/v1.0.6/internal/iamctl/cmd/cmd.go#L41-L130">NewIAMCtlCommand</a>å‡½æ•°ä¸­ï¼Œæ ¸å¿ƒä»£ç ä¸ºï¼š</p><pre><code class="language-go">flags := cmds.PersistentFlags()
...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
iamConfigFlags := genericclioptions.NewConfigFlags(true).WithDeprecatedPasswordFlag().WithDeprecatedSecretFlag()
iamConfigFlags.AddFlags(flags)&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
matchVersionIAMConfigFlags := cmdutil.NewMatchVersionFlags(iamConfigFlags)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
matchVersionIAMConfigFlags.AddFlags(cmds.PersistentFlags())
</code></pre><p><code>NewConfigFlags(true)</code> è¿”å›å¸¦æœ‰é»˜è®¤å€¼çš„å‚æ•°ï¼Œå¹¶é€šè¿‡ <code>iamConfigFlags.AddFlags(flags)</code> æ·»åŠ åˆ°cobraçš„å‘½ä»¤è¡Œflagä¸­ã€‚</p><p><code>NewConfigFlags(true)</code> è¿”å›ç»“æ„ä½“ç±»å‹çš„å€¼éƒ½æ˜¯æŒ‡é’ˆç±»å‹ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼šç¨‹åºå¯ä»¥åˆ¤æ–­å‡ºæ˜¯å¦æŒ‡å®šäº†æŸä¸ªå‚æ•°ï¼Œä»è€Œå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ å‚æ•°ã€‚ä¾‹å¦‚ï¼šå¯ä»¥é€šè¿‡ <code>WithDeprecatedPasswordFlag()</code> å’Œ <code>WithDeprecatedSecretFlag()</code> æ·»åŠ å¯†ç å’Œå¯†é’¥è®¤è¯å‚æ•°ã€‚</p><p><code>NewMatchVersionFlags</code> æŒ‡å®šæ˜¯å¦éœ€è¦æœåŠ¡ç«¯ç‰ˆæœ¬å’Œå®¢æˆ·ç«¯ç‰ˆæœ¬ä¸€è‡´ã€‚å¦‚æœä¸ä¸€è‡´ï¼Œåœ¨è°ƒç”¨æœåŠ¡æ¥å£æ—¶ä¼šæŠ¥é”™ã€‚</p><h3>é…ç½®æ–‡ä»¶è§£æ</h3><p>iamctléœ€è¦è¿æ¥iam-apiserverï¼Œæ¥å®Œæˆç”¨æˆ·ã€ç­–ç•¥å’Œå¯†é’¥çš„å¢åˆ æ”¹æŸ¥ï¼Œå¹¶ä¸”éœ€è¦è¿›è¡Œè®¤è¯ã€‚è¦å®Œæˆè¿™äº›åŠŸèƒ½ï¼Œéœ€è¦æœ‰æ¯”è¾ƒå¤šçš„é…ç½®é¡¹ã€‚è¿™äº›é…ç½®é¡¹å¦‚æœæ¯æ¬¡éƒ½åœ¨å‘½ä»¤è¡Œé€‰é¡¹æŒ‡å®šï¼Œä¼šå¾ˆéº»çƒ¦ï¼Œä¹Ÿå®¹æ˜“å‡ºé”™ã€‚</p><p>æœ€å¥½çš„æ–¹å¼æ˜¯ä¿å­˜åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œå¹¶åŠ è½½é…ç½®æ–‡ä»¶ã€‚åŠ è½½é…ç½®æ–‡ä»¶çš„ä»£ç ä½äºNewIAMCtlCommandå‡½æ•°ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code>_ = viper.BindPFlags(cmds.PersistentFlags())
cobra.OnInitialize(func() {
    genericapiserver.LoadConfig(viper.GetString(genericclioptions.FlagIAMConfig), &quot;iamctl&quot;)
})  

</code></pre><p>iamctlä¼šæŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§åŠ è½½é…ç½®æ–‡ä»¶ï¼š</p><ol>
<li>å‘½ä»¤è¡Œå‚ <code>--iamconfig</code> æŒ‡å®šçš„é…ç½®æ–‡ä»¶ã€‚</li>
<li>å½“å‰ç›®å½•ä¸‹çš„iamctl.yamlæ–‡ä»¶ã€‚</li>
<li><code>$HOME/.iam/iamctl.yaml</code> æ–‡ä»¶ã€‚</li>
</ol><p>è¿™ç§åŠ è½½æ–¹å¼å…·æœ‰ä¸¤ä¸ªå¥½å¤„ã€‚é¦–å…ˆæ˜¯å¯ä»¥æ‰‹åŠ¨æŒ‡å®šä¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œè¿™åœ¨å¤šç¯å¢ƒã€å¤šé…ç½®ä¸‹å°¤ä¸ºé‡è¦ã€‚å…¶æ¬¡æ˜¯æ–¹ä¾¿ä½¿ç”¨ï¼Œå¯ä»¥æŠŠé…ç½®å­˜æ”¾åœ¨é»˜è®¤çš„åŠ è½½è·¯å¾„ä¸­ï¼Œåœ¨æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œå°±ä¸ç”¨å†æŒ‡å®š <code>--iamconfig</code> å‚æ•°ã€‚</p><p>åŠ è½½å®Œé…ç½®æ–‡ä»¶ä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡ <code>viper.Get&lt;Type&gt;()</code> å‡½æ•°æ¥è·å–é…ç½®ã€‚ä¾‹å¦‚ï¼Œiamctlä½¿ç”¨äº†ä»¥ä¸‹ <code>viper.Get&lt;Type&gt;</code> æ–¹æ³•ï¼š</p><p><img src="https://static001.geekbang.org/resource/image/8b/42/8bce5d0b9ab45b5238d70b73175cf642.png?wh=1920x813" alt="å›¾ç‰‡"></p><h2>iamctlä¸­å­å‘½ä»¤æ˜¯å¦‚ä½•æ„å»ºçš„ï¼Ÿ</h2><p>è®²å®Œäº†iamctlå‘½ä»¤è¡Œå·¥å…·çš„æ ¸å¿ƒå®ç°ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹iamctlå‘½ä»¤è¡Œå·¥å…·ä¸­ï¼Œå­å‘½ä»¤æ˜¯å¦‚ä½•æ„å»ºçš„ã€‚</p><p>å‘½ä»¤è¡Œå·¥å…·çš„æ ¸å¿ƒæ˜¯å‘½ä»¤ï¼Œæœ‰å¾ˆå¤šç§æ–¹æ³•å¯ä»¥æ„å»ºä¸€ä¸ªå‘½ä»¤ï¼Œä½†è¿˜æ˜¯æœ‰ä¸€äº›æ¯”è¾ƒå¥½çš„æ„å»ºæ–¹æ³•ï¼Œå€¼å¾—æˆ‘ä»¬å»å‚è€ƒã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘æ¥ä»‹ç»ä¸‹å¦‚ä½•ç”¨æ¯”è¾ƒå¥½çš„æ–¹å¼å»æ„å»ºå‘½ä»¤ã€‚</p><h3>å‘½ä»¤æ„å»º</h3><p>å‘½ä»¤è¡Œå·¥å…·çš„æ ¸å¿ƒèƒ½åŠ›æ˜¯æä¾›å„ç±»å‘½ä»¤ï¼Œæ¥å®Œæˆä¸åŒåŠŸèƒ½ï¼Œæ¯ä¸ªå‘½ä»¤æ„å»ºçš„æ–¹å¼å¯ä»¥å®Œå…¨ä¸åŒï¼Œä½†æœ€å¥½èƒ½æŒ‰ç›¸åŒçš„æ–¹å¼å»æ„å»ºï¼Œå¹¶æŠ½è±¡æˆä¸€ä¸ªæ¨¡å‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://static001.geekbang.org/resource/image/1e/93/1e78d2f387be0bcbae573d486e391e93.jpg?wh=1920x916" alt="å›¾ç‰‡"></p><p>ä½ å¯ä»¥å°†ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·æä¾›çš„å‘½ä»¤è¿›è¡Œåˆ†ç»„ã€‚æ¯ä¸ªåˆ†ç»„åŒ…å«å¤šä¸ªå‘½ä»¤ï¼Œæ¯ä¸ªå‘½ä»¤åˆå¯ä»¥å…·æœ‰å¤šä¸ªå­å‘½ä»¤ï¼Œå­å‘½ä»¤å’Œçˆ¶å‘½ä»¤åœ¨æ„å»ºæ–¹å¼ä¸Šå®Œå…¨ä¸€è‡´ã€‚</p><p>æ¯ä¸ªå‘½ä»¤å¯ä»¥æŒ‰ä¸‹é¢çš„å››ç§æ–¹å¼æ„å»ºã€‚å…·ä½“ä»£ç ä½ å¯ä»¥å‚è€ƒ<a href="https://github.com/marmotedu/iam/blob/v1.0.6/internal/iamctl/cmd/user/user_update.go">internal/iamctl/cmd/user/user_update.go</a>ã€‚</p><ul>
<li>é€šè¿‡ <code>NewCmdXyz</code> å‡½æ•°åˆ›å»ºå‘½ä»¤æ¡†æ¶ã€‚ <code>NewCmdXyz</code> å‡½æ•°é€šè¿‡åˆ›å»ºä¸€ä¸ª <code>cobra.Command</code> ç±»å‹çš„å˜é‡æ¥åˆ›å»ºå‘½ä»¤ï¼›é€šè¿‡æŒ‡å®š <code>cobra.Command</code> ç»“æ„ä½“ç±»å‹çš„Shortã€Longã€Exampleå­—æ®µï¼Œæ¥æŒ‡å®šè¯¥å‘½ä»¤çš„ä½¿ç”¨æ–‡æ¡£<code>iamctl -h</code> ã€è¯¦ç»†ä½¿ç”¨æ–‡æ¡£<code>iamctl xyz -h</code> å’Œä½¿ç”¨ç¤ºä¾‹ã€‚</li>
<li>é€šè¿‡ <code>cmd.Flags().XxxxVar</code> æ¥ç»™è¯¥å‘½ä»¤æ·»åŠ å‘½ä»¤è¡Œé€‰é¡¹ã€‚</li>
<li>ä¸ºäº†åœ¨ä¸æŒ‡å®šå‘½ä»¤è¡Œå‚æ•°æ—¶ï¼Œèƒ½å¤ŸæŒ‰ç…§é»˜è®¤çš„æ–¹å¼æ‰§è¡Œå‘½ä»¤ï¼Œå¯ä»¥é€šè¿‡ <code>NewXyzOptions</code> å‡½æ•°è¿”å›ä¸€ä¸ªè®¾ç½®äº†é»˜è®¤é€‰é¡¹çš„ <code>XyzOptions</code> ç±»å‹çš„å˜é‡ã€‚</li>
<li><code>XyzOptions</code> é€‰é¡¹å…·æœ‰ Complete ã€Validate å’Œ Run ä¸‰ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«å®Œæˆé€‰é¡¹è¡¥å…¨ã€é€‰é¡¹éªŒè¯å’Œå‘½ä»¤æ‰§è¡Œã€‚å‘½ä»¤çš„æ‰§è¡Œé€»è¾‘å¯ä»¥åœ¨ <code>func (o *XyzOptions) Run(args []string) error</code> å‡½æ•°ä¸­ç¼–å†™ã€‚</li>
</ul><p>æŒ‰ç›¸åŒçš„æ–¹å¼å»æ„å»ºå‘½ä»¤ï¼ŒæŠ½è±¡æˆä¸€ä¸ªé€šç”¨æ¨¡å‹ï¼Œè¿™ç§æ–¹å¼æœ‰ä¸‹é¢å››ä¸ªå¥½å¤„ã€‚</p><ul>
<li>å‡å°‘ç†è§£æˆæœ¬ï¼šç†è§£ä¸€ä¸ªå‘½ä»¤çš„æ„å»ºæ–¹å¼ï¼Œå°±å¯ä»¥ç†è§£å…¶ä»–å‘½ä»¤çš„æ„å»ºæ–¹å¼ã€‚</li>
<li>æé«˜æ–°å‘½ä»¤çš„å¼€å‘æ•ˆç‡ï¼šå¯ä»¥å¤ç”¨å…¶ä»–å‘½ä»¤çš„å¼€å‘æ¡†æ¶ï¼Œæ–°å‘½ä»¤åªéœ€å¡«å†™ä¸šåŠ¡é€»è¾‘å³å¯ã€‚</li>
<li>è‡ªåŠ¨ç”Ÿæˆå‘½ä»¤ï¼šå¯ä»¥æŒ‰ç…§è§„å®šçš„å‘½ä»¤æ¨¡å‹ï¼Œè‡ªåŠ¨ç”Ÿæˆæ–°çš„å‘½ä»¤ã€‚</li>
<li>æ˜“ç»´æŠ¤ï¼šå› ä¸ºæ‰€æœ‰çš„å‘½ä»¤éƒ½æ¥è‡ªäºåŒä¸€ä¸ªå‘½ä»¤æ¨¡å‹ï¼Œæ‰€ä»¥å¯ä»¥ä¿æŒä¸€è‡´çš„ä»£ç é£æ ¼ï¼Œæ–¹ä¾¿åæœŸç»´æŠ¤ã€‚</li>
</ul><h3>è‡ªåŠ¨ç”Ÿæˆå‘½ä»¤</h3><p>ä¸Šé¢è®²åˆ°ï¼Œè‡ªåŠ¨ç”Ÿæˆå‘½ä»¤æ¨¡å‹çš„å¥½å¤„ä¹‹ä¸€æ˜¯å¯ä»¥è‡ªåŠ¨ç”Ÿæˆå‘½ä»¤ï¼Œä¸‹é¢è®©æˆ‘ä»¬æ¥å…·ä½“çœ‹ä¸‹ã€‚</p><p>iamctlè‡ªå¸¦äº†å‘½ä»¤ç”Ÿæˆå·¥å…·ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹çœ‹ç”Ÿæˆæ–¹æ³•ï¼Œä¸€å…±å¯ä»¥åˆ†æˆ5æ­¥ã€‚è¿™é‡Œå‡è®¾ç”Ÿæˆ <code>xyz</code> å‘½ä»¤ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œæ–°å»ºä¸€ä¸ª <code>xyz</code> ç›®å½•ï¼Œç”¨æ¥å­˜æ”¾ <code>xyz</code> å‘½ä»¤æºç ï¼š</p><pre><code class="language-bash">$ mkdir internal/iamctl/cmd/xyz
</code></pre><p>ç¬¬äºŒæ­¥ï¼Œåœ¨xyzç›®å½•ä¸‹ï¼Œä½¿ç”¨ <code>iamctl new</code> å‘½ä»¤ç”Ÿæˆ <code>xyz</code> å‘½ä»¤æºç ï¼š</p><pre><code class="language-bash">$ cd internal/iamctl/cmd/xyz/
$ iamctl new xyz
Command file generated: xyz.go
</code></pre><p>ç¬¬ä¸‰æ­¥ï¼Œå°† <code>xyz</code>  å‘½ä»¤æ·»åŠ åˆ°rootå‘½ä»¤ä¸­ï¼Œå‡è®¾ <code>xyz</code> å±äº <code>Settings Commands</code> å‘½ä»¤åˆ†ç»„ã€‚</p><p>åœ¨ <code>NewIAMCtlCommand</code> å‡½æ•°ä¸­ï¼Œæ‰¾åˆ° <code>Settings Commands</code> åˆ†ç»„ï¼Œå°† <code>NewCmdXyz</code> è¿½åŠ åˆ°Commandsæ•°ç»„åé¢ï¼š</p><pre><code class="language-go">&nbsp; &nbsp; &nbsp; &nbsp;{
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Message: "Settings Commands:",
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Commands: []*cobra.Command{
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set.NewCmdSet(f, ioStreams),
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; completion.NewCmdCompletion(ioStreams.Out, ""),
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xyz.NewCmdXyz(f, ioStreams),
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },
&nbsp; &nbsp; &nbsp; &nbsp; },&nbsp;
</code></pre><p>ç¬¬å››æ­¥ï¼Œç¼–è¯‘iamctlï¼š</p><pre><code class="language-bash">$ make build BINS=iamctl  
</code></pre><p>ç¬¬äº”æ­¥ï¼Œæµ‹è¯•ï¼š</p><pre><code class="language-bash">$ iamctl xyz -h
A longer description that spans multiple lines and likely contains examples and usage of using your command. For
example:
&nbsp;
&nbsp;Cobra is a CLI library for Go that empowers applications. This application is a tool to generate the needed files to
quickly create a Cobra application.
&nbsp;
Examples:
&nbsp; # Print all option values for xyz
&nbsp; iamctl xyz marmotedu marmotedupass
&nbsp;
Options:
&nbsp; -b, --bool=false: Bool option.
&nbsp; -i, --int=0: Int option.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --slice=[]: String slice option.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --string='default': String option.
&nbsp;
Usage:
&nbsp; iamctl xyz USERNAME PASSWORD [options]
&nbsp;
Use "iamctl options" for a list of global command-line options (applies to all commands).
$ iamctl xyz marmotedu marmotedupass
The following is option values:
==&gt; --string: default(complete)
==&gt; --slice: []
==&gt; --int: 0
==&gt; --bool: false
&nbsp;
The following is args values:
==&gt; username: marmotedu
==&gt; password: marmotedupass
</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œç»è¿‡çŸ­çŸ­çš„å‡ æ­¥ï¼Œå°±æ·»åŠ äº†ä¸€ä¸ªæ–°çš„å‘½ä»¤ <code>xyz</code> ã€‚ <code>iamctl new</code> å‘½ä»¤ä¸ä»…å¯ä»¥ç”Ÿæˆä¸å¸¦å­å‘½ä»¤çš„å‘½ä»¤ï¼Œè¿˜å¯ä»¥ç”Ÿæˆå¸¦æœ‰å­å‘½ä»¤çš„å‘½ä»¤ï¼Œç”Ÿæˆæ–¹å¼å¦‚ä¸‹ï¼š</p><pre><code class="language-bash">$ iamctl new -g xyz
Command file generated: xyz.go
Command file generated: xyz_subcmd1.go
Command file generated: xyz_subcmd2.go
</code></pre><h3>å‘½ä»¤è‡ªåŠ¨è¡¥å…¨</h3><p>cobraä¼šæ ¹æ®æ³¨å†Œçš„å‘½ä»¤è‡ªåŠ¨ç”Ÿæˆè¡¥å…¨è„šæœ¬ï¼Œå¯ä»¥è¡¥å…¨çˆ¶å‘½ä»¤ã€å­å‘½ä»¤å’Œé€‰é¡¹å‚æ•°ã€‚åœ¨bashä¸‹ï¼Œå¯ä»¥æŒ‰ä¸‹é¢çš„æ–¹å¼é…ç½®è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œç”Ÿæˆè‡ªåŠ¨è¡¥å…¨è„šæœ¬ï¼š</p><pre><code class="language-bash">$ iamctl completion bash &gt; ~/.iam/completion.bash.inc
</code></pre><p>ç¬¬äºŒæ­¥ï¼Œç™»é™†æ—¶åŠ è½½bashï¼Œè‡ªåŠ¨è¡¥å…¨è„šæœ¬ï¼š</p><pre><code class="language-bash">$ echo "source '$HOME/.iam/completion.bash.inc'" &gt;&gt; $HOME/.bash_profile
$ source $HOME/.bash_profile
</code></pre><p>ç¬¬ä¸‰æ­¥ï¼Œæµ‹è¯•è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ï¼š</p><pre><code class="language-bash">$ iamctl xy&lt;TAB&gt; # æŒ‰TABé”®ï¼Œè‡ªåŠ¨è¡¥å…¨ä¸ºï¼šiamctl xyz
$ iamctl xyz --b&lt;TAB&gt; # æŒ‰TABé”®ï¼Œè‡ªåŠ¨è¡¥å…¨ä¸ºï¼šiamctl xyz --bool
</code></pre><h3>æ›´å‹å¥½çš„è¾“å‡º</h3><p>åœ¨å¼€å‘å‘½ä»¤æ—¶ï¼Œå¯ä»¥é€šè¿‡ä¸€äº›æŠ€å·§æ¥æé«˜ä½¿ç”¨ä½“éªŒã€‚æˆ‘ç»å¸¸ä¼šåœ¨è¾“å‡ºä¸­æ‰“å°ä¸€äº›å½©è‰²è¾“å‡ºï¼Œæˆ–è€…å°†ä¸€äº›è¾“å‡ºä»¥è¡¨æ ¼çš„å½¢å¼è¾“å‡ºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://static001.geekbang.org/resource/image/74/42/74ef80708c853c20811e1e7bed7bde42.png?wh=651x226" alt="å›¾ç‰‡"></p><p>è¿™é‡Œï¼Œä½¿ç”¨ <code>github.com/olekukonko/tablewriter</code> åŒ…æ¥å®ç°è¡¨æ ¼åŠŸèƒ½ï¼Œä½¿ç”¨ <code>github.com/fatih/color</code> åŒ…æ¥æ‰“å°å¸¦è‰²å½©çš„å­—ç¬¦ä¸²ã€‚å…·ä½“ä½¿ç”¨æ–¹æ³•ï¼Œä½ å¯ä»¥å‚è€ƒ<a href="https://github.com/marmotedu/iam/blob/v1.0.6/internal/iamctl/cmd/validate/validate.go">internal/iamctl/cmd/validate/validate.go</a>æ–‡ä»¶ã€‚</p><p><code>github.com/fatih/color</code> åŒ…å¯ä»¥ç»™å­—ç¬¦ä¸²æ ‡ç¤ºé¢œè‰²ï¼Œå­—ç¬¦ä¸²å’Œé¢œè‰²çš„å¯¹åº”å…³ç³»å¯é€šè¿‡ <code>iamctl color</code> æ¥æŸ¥çœ‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://static001.geekbang.org/resource/image/47/b9/47593869e1b10b15a35e16c661d818b9.png?wh=991x672" alt="å›¾ç‰‡"></p><h2>iamctlæ˜¯å¦‚ä½•è¿›è¡ŒAPIè°ƒç”¨çš„ï¼Ÿ</h2><p>ä¸Šé¢æˆ‘ä»‹ç»äº†iamctlå‘½ä»¤çš„æ„å»ºæ–¹å¼ï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹iamctlæ˜¯å¦‚ä½•è¯·æ±‚æœåŠ¡ç«¯APIæ¥å£çš„ã€‚</p><p>Goåç«¯æœåŠ¡çš„åŠŸèƒ½é€šå¸¸é€šè¿‡APIæ¥å£æ¥å¯¹å¤–æš´éœ²ï¼Œä¸€ä¸ªåç«¯æœåŠ¡å¯èƒ½ä¾›å¾ˆå¤šä¸ªç»ˆç«¯ä½¿ç”¨ï¼Œæ¯”å¦‚æµè§ˆå™¨ã€å‘½ä»¤è¡Œå·¥å…·ã€æ‰‹æœºç­‰ã€‚ä¸ºäº†ä¿æŒåŠŸèƒ½çš„ä¸€è‡´æ€§ï¼Œè¿™äº›ç»ˆç«¯éƒ½ä¼šè°ƒç”¨åŒä¸€å¥—APIæ¥å®Œæˆç›¸åŒçš„åŠŸèƒ½ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://static001.geekbang.org/resource/image/fb/bb/fb6de4f63454dd6471e023d73b8548bb.jpg?wh=1920x742" alt="å›¾ç‰‡"></p><p>å¦‚æœå‘½ä»¤è¡Œå·¥å…·éœ€è¦ç”¨åˆ°åç«¯æœåŠ¡çš„åŠŸèƒ½ï¼Œä¹Ÿéœ€è¦é€šè¿‡APIè°ƒç”¨çš„æ–¹å¼ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼ŒGoåç«¯æœåŠ¡å¯¹å¤–æš´éœ²çš„æ‰€æœ‰APIåŠŸèƒ½ï¼Œéƒ½å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå·¥å…·æ¥å®Œæˆã€‚ä¸€ä¸ªAPIæ¥å£å¯¹åº”ä¸€ä¸ªå‘½ä»¤ï¼ŒAPIæ¥å£çš„å‚æ•°æ˜ å°„åˆ°å‘½ä»¤çš„å‚æ•°ã€‚</p><p>è¦è°ƒç”¨æœåŠ¡ç«¯çš„APIæ¥å£ï¼Œæœ€ä¾¿æ·çš„æ–¹æ³•æ˜¯é€šè¿‡SDKæ¥è°ƒç”¨ï¼Œå¯¹äºä¸€äº›æ²¡æœ‰å®ç°SDKçš„æ¥å£ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨ã€‚æ‰€ä»¥ï¼Œåœ¨å‘½ä»¤è¡Œå·¥å…·ä¸­ï¼Œéœ€è¦æ”¯æŒä»¥ä¸‹ä¸¤ç§è°ƒç”¨æ–¹å¼ï¼š</p><ul>
<li>é€šè¿‡SDKè°ƒç”¨æœåŠ¡ç«¯ API æ¥å£ã€‚</li>
<li>ç›´æ¥è°ƒç”¨æœåŠ¡ç«¯çš„APIæ¥å£ï¼ˆæœ¬ä¸“æ æ˜¯REST APIæ¥å£ï¼‰ã€‚</li>
</ul><p>iamctlé€šè¿‡<a href="https://github.com/marmotedu/iam/blob/v1.0.6/internal/iamctl/cmd/cmd.go#L82">cmdutil.NewFactory</a>åˆ›å»ºä¸€ä¸ª <code>Factory</code> ç±»å‹çš„å˜é‡ <code>f</code> ï¼Œ <code>Factory</code> å®šä¹‰ä¸ºï¼š</p><pre><code class="language-go">type Factory interface {
&nbsp; &nbsp; genericclioptions.RESTClientGetter
&nbsp; &nbsp; IAMClientSet() (*marmotedu.Clientset, error)
&nbsp; &nbsp; RESTClient() (*restclient.RESTClient, error)
}
</code></pre><p>å°†å˜é‡ <code>f</code> ä¼ å…¥åˆ°å‘½ä»¤ä¸­ï¼Œåœ¨å‘½ä»¤ä¸­ä½¿ç”¨Factoryæ¥å£æä¾›çš„ <code>RESTClient()</code> å’Œ <code>IAMClientSet()</code> æ–¹æ³•ï¼Œåˆ†åˆ«è¿”å›RESTful APIå®¢æˆ·ç«¯å’ŒSDKå®¢æˆ·ç«¯ï¼Œä»è€Œä½¿ç”¨å®¢æˆ·ç«¯æä¾›çš„æ¥å£å‡½æ•°ã€‚ä»£ç å¯å‚è€ƒ<a href="https://github.com/marmotedu/iam/blob/v1.0.6/internal/iamctl/cmd/version/version.go">internal/iamctl/cmd/version/version.go</a>ã€‚</p><h3>å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶</h3><p>å¦‚æœè¦åˆ›å»ºRESTful APIå®¢æˆ·ç«¯å’ŒSDKçš„å®¢æˆ·ç«¯ï¼Œéœ€è¦è°ƒç”¨ <code>f.ToRESTConfig()</code> å‡½æ•°è¿”å› <code>*github.com/marmotedu/marmotedu-sdk-go/rest.Config</code> ç±»å‹çš„é…ç½®å˜é‡ï¼Œç„¶åå†åŸºäº <code>rest.Config</code> ç±»å‹çš„é…ç½®å˜é‡åˆ›å»ºå®¢æˆ·ç«¯ã€‚</p><p><code>f.ToRESTConfig</code> å‡½æ•°æœ€ç»ˆæ˜¯è°ƒç”¨<a href="https://github.com/marmotedu/iam/blob/v1.0.6/pkg/cli/genericclioptions/config_flags.go#L92-L98">toRawIAMConfigLoader</a>å‡½æ•°æ¥ç”Ÿæˆé…ç½®çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="language-go">func (f *ConfigFlags) toRawIAMConfigLoader() clientcmd.ClientConfig {
&nbsp; &nbsp; config := clientcmd.NewConfig()
&nbsp; &nbsp; if err := viper.Unmarshal(&amp;config); err != nil {
&nbsp; &nbsp; &nbsp; &nbsp; panic(err)
&nbsp; &nbsp; }

&nbsp; &nbsp; return clientcmd.NewClientConfigFromConfig(config)
}
</code></pre><p><code>toRawIAMConfigLoader</code> è¿”å› <code>clientcmd.ClientConfig</code> ç±»å‹çš„å˜é‡ï¼Œ <code>clientcmd.ClientConfig</code> ç±»å‹æä¾›äº† <code>ClientConfig</code> æ–¹æ³•ï¼Œç”¨æ¥è¿”å›<code>*rest.Config</code>ç±»å‹çš„å˜é‡ã€‚</p><p>åœ¨ <code>toRawIAMConfigLoader</code> å‡½æ•°å†…éƒ¨ï¼Œé€šè¿‡ <code>viper.Unmarshal</code> å°†viperä¸­å­˜å‚¨çš„é…ç½®è§£æåˆ° <code>clientcmd.Config</code> ç±»å‹çš„ç»“æ„ä½“å˜é‡ä¸­ã€‚viperä¸­å­˜å‚¨çš„é…ç½®ï¼Œæ˜¯åœ¨cobraå‘½ä»¤å¯åŠ¨æ—¶é€šè¿‡LoadConfigå‡½æ•°åŠ è½½çš„ï¼Œä»£ç å¦‚ä¸‹ï¼ˆä½äº <code>NewIAMCtlCommand</code> å‡½æ•°ä¸­ï¼‰ï¼š</p><pre><code class="language-go">cobra.OnInitialize(func() {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; genericapiserver.LoadConfig(viper.GetString(genericclioptions.FlagIAMConfig), "config")
})&nbsp;
</code></pre><p>ä½ å¯ä»¥é€šè¿‡ <code>--config</code> é€‰é¡¹ï¼ŒæŒ‡å®šé…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚</p><h3>SDKè°ƒç”¨</h3><p>é€šè¿‡<a href="https://github.com/marmotedu/iam/blob/v1.0.6/internal/iamctl/cmd/util/factory_client_access.go#L41-L47">IAMClient</a>è¿”å›SDKå®¢æˆ·ç«¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="language-go">func (f *factoryImpl) IAMClient() (*iam.IamClient, error) {
	clientConfig, err := f.ToRESTConfig()
	if err != nil {
		return nil, err
	}
	return iam.NewForConfig(clientConfig)
}
</code></pre><p><code>marmotedu.Clientset</code> æä¾›äº†iam-apiserverçš„æ‰€æœ‰æ¥å£ã€‚</p><h3>REST APIè°ƒç”¨</h3><p>é€šè¿‡<a href="https://github.com/marmotedu/iam/blob/v1.0.6/internal/iamctl/cmd/util/factory_client_access.go#L49-L56">RESTClient()</a>è¿”å›RESTful APIå®¢æˆ·ç«¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="language-go">func (f *factoryImpl) RESTClient() (*restclient.RESTClient, error) {
	clientConfig, err := f.ToRESTConfig()
	if err != nil {
		return nil, err
	}
	setIAMDefaults(clientConfig)
	return restclient.RESTClientFor(clientConfig)
}
</code></pre><p>å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼è®¿é—®RESTful APIæ¥å£ï¼š</p><pre><code class="language-go">serverVersion *version.Info

client, _ := f.RESTClient()
if err := client.Get().AbsPath("/version").Do(context.TODO()).Into(&amp;serverVersion); err != nil {
&nbsp; &nbsp; return err
}
</code></pre><p>ä¸Šé¢çš„ä»£ç è¯·æ±‚äº†iam-apiserverçš„/versionæ¥å£ï¼Œå¹¶å°†è¿”å›ç»“æœä¿å­˜åœ¨ <code>serverVersion</code> å˜é‡ä¸­ã€‚</p><h2>æ€»ç»“</h2><p>è¿™ä¸€è®²ï¼Œæˆ‘ä¸»è¦å‰–æäº†iamctlå‘½ä»¤è¡Œå·¥å…·çš„å®ç°ï¼Œè¿›è€Œå‘ä½ ä»‹ç»äº†å¦‚ä½•å®ç°ä¸€ä¸ªä¼˜ç§€çš„å®¢æˆ·ç«¯å·¥å…·ã€‚</p><p>å¯¹äºä¸€ä¸ªå¤§å‹ç³»ç»Ÿ <code>xxx</code> æ¥è¯´ï¼Œé€šå¸¸éœ€è¦æœ‰ä¸€ä¸ª <code>xxxctl</code> å‘½ä»¤è¡Œå·¥å…·ï¼Œ <code>xxxctl</code> å‘½ä»¤è¡Œå·¥å…·å¯ä»¥æ–¹ä¾¿å¼€å‘ã€è¿ç»´ä½¿ç”¨ç³»ç»ŸåŠŸèƒ½ï¼Œå¹¶èƒ½å®ç°åŠŸèƒ½è‡ªåŠ¨åŒ–ã€‚</p><p>IAMé¡¹ç›®å‚è€ƒkubectlï¼Œå®ç°äº†å‘½ä»¤è¡Œå·¥å…· iamctlã€‚iamctlé›†æˆäº†å¾ˆå¤šåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡iamctlå­å‘½ä»¤æ¥ä½¿ç”¨è¿™äº›åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡iamctlå¯¹ç”¨æˆ·ã€å¯†é’¥å’Œç­–ç•¥è¿›è¡ŒCURDæ“ä½œï¼›å¯ä»¥è®¾ç½®iamctlè‡ªåŠ¨è¡¥å…¨è„šæœ¬ï¼›å¯ä»¥æŸ¥çœ‹IAMç³»ç»Ÿçš„ç‰ˆæœ¬ä¿¡æ¯ã€‚ç”šè‡³ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ <code>iamctl new</code> å‘½ä»¤ï¼Œå¿«é€Ÿåˆ›å»ºä¸€ä¸ªiamctlå­å‘½ä»¤æ¨¡æ¿ã€‚</p><p>iamctlä½¿ç”¨äº†cobraã€pflagã€viperåŒ…æ¥æ„å»ºï¼Œæ¯ä¸ªå­å‘½ä»¤åˆåŒ…å«äº†ä¸€äº›åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚çŸ­æè¿°ã€é•¿æè¿°ã€ä½¿ç”¨ç¤ºä¾‹ã€å‘½ä»¤è¡Œé€‰é¡¹ã€é€‰é¡¹æ ¡éªŒç­‰ã€‚iamctlå‘½ä»¤å¯ä»¥åŠ è½½ä¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œæ¥è¿æ¥ä¸åŒçš„å®¢æˆ·ç«¯ã€‚iamctlé€šè¿‡SDKè°ƒç”¨ã€REST APIè°ƒç”¨ä¸¤ç§æ–¹å¼æ¥è°ƒç”¨æœåŠ¡ç«¯APIæ¥å£ã€‚</p><h2>è¯¾åç»ƒä¹ </h2><ol>
<li>å°è¯•åœ¨ <code>iamctl</code> ä¸­æ·»åŠ ä¸€ä¸ª <code>cliprint</code> å­å‘½ä»¤ï¼Œè¯¥å­å‘½ä»¤ä¼šè¯»å–å¹¶æ‰“å°å‘½ä»¤è¡Œé€‰é¡¹ã€‚</li>
<li>æ€è€ƒä¸‹ï¼Œè¿˜æœ‰å“ªäº›å¥½çš„å‘½ä»¤è¡Œå·¥å…·æ„å»ºæ–¹å¼ï¼Œæ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ã€‚</li>
</ol><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²è§ã€‚</p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/87/64/3882d90d.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>yandongxiao</span>
  </div>
  <div class="_2_QraFYR_0">æ€»ç»“ï¼š<br>iamctl å·¥å…·çš„å®ç°å‚è€ƒäº† kubectl å‘½ä»¤çš„å®ç°<br>å¯¹åŠŸèƒ½å’Œé€‰é¡¹è¿›è¡Œåˆ†ç»„<br>ä»£ç ç»“æ„çš„ç»„ç»‡æ–¹å¼ï¼šinternal&#47;iamctl&#47;cmd&#47;&lt;å‘½ä»¤&gt;&#47;&lt;å‘½ä»¤&gt;_&lt;å­å‘½ä»¤&gt;.go <br>å­å‘½ä»¤çš„æ„å»ºæ–¹å¼ï¼šå¯æ‰‹åŠ¨æ‰©å±•ä¹Ÿå¯ä½¿ç”¨iamctl new è‡ªåŠ¨ç”Ÿæˆã€‚ä¿è¯æ„å»ºå‘½ä»¤æ–¹å¼çš„ä¸€è‡´æ€§ã€‚<br>iamctl æ”¯æŒé€šè¿‡ RESTClient å’Œ SDK ä¸¤ç§æ–¹å¼è°ƒç”¨åç«¯æœåŠ¡ï¼Œf cmdutil.Factory ä½œä¸ºå‘½ä»¤å®ç°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ŒæŒ‰éœ€å®ä¾‹åŒ–å®¢æˆ·ç«¯ã€‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-04 15:46:21</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/1f/26/34/891dd45b.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å®™æ–¯</span>
  </div>
  <div class="_2_QraFYR_0">æœ‰cmdä¸ºä»€ä¹ˆè¿˜å•ç‹¬åˆ†å‰²å‡ºæ¥ä¸€ä¸ªtoolså‘¢ï¼Ÿtoolsæ„Ÿè§‰æ”¾åˆ°cmdé‡Œé¢ä¹Ÿæ˜¯å¯ä»¥çš„</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: toolsè¯´æ˜æ˜¯å·¥å…·ï¼Œcmd&amp;#47;ä¸‹çš„ç¨‹åºéƒ½å±äºiamæœåŠ¡ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-11-11 09:38:26</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/28/83/17/df99b53d.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>éšé£è€Œè¿‡</span>
  </div>
  <div class="_2_QraFYR_0">è¿™å¥—å‘½ä»¤è¡ŒåŸºæœ¬é€šç”¨ï¼Œè¿˜å­¦åˆ°å¤§å‹å¼€æºé¡¹ç›®çš„å‘½ä»¤è¡Œå·¥å…·çš„æ„å»ºï¼Œæˆ‘ä¸€èˆ¬å¼€å‘éƒ½æ˜¯äº›shellè„šæœ¬ï¼Œæ²¡æƒ³åˆ°cobraã€pflagã€viper åŒ…æ¥æ„å»ºçš„æ›´å¥½ä½¿ï¼Œæ•ˆç‡è¿˜æ›´é«˜</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-09-08 14:42:18</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æˆ‘æ¥ä¹Ÿ</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆçš„é¡¹ç›®çœŸå…¨ï¼Œè¿ ctl éƒ½æœ‰äº†ã€‚ğŸ˜<br>æœ¬åœ°ä¸€ä¸ª make å‘½ä»¤ï¼Œå°±æ„å»ºå‡ºæ¥äº†å¯¹åº”æ¶æ„çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚<br><br>æœ‰ä¸ªåœ°æ–¹æ¯”è¾ƒå¥½å¥‡ï¼Œå’¨è¯¢ä¸€ä¸‹è€å¸ˆï¼š<br>è€å¸ˆçš„ zsh è¡¥å…¨è„šæœ¬æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Œä¸ºä»€ä¹ˆæ˜¯åœ¨ä»£ç ä¸­å®šä¹‰çš„å¸¸é‡ï¼Ÿ<br>https:&#47;&#47;github.com&#47;marmotedu&#47;iam&#47;blob&#47;922885b4a502c589785eb08a61522ca03bc8ba55&#47;internal&#47;iamctl&#47;cmd&#47;completion&#47;completion.go#L139-L163<br><br>è€Œ ko çš„ zsh è¡¥å…¨æ˜¯å®Œå…¨æœ‰ä»£ç è‡ªåŠ¨ç”Ÿæˆçš„ï¼š<br>https:&#47;&#47;github.com&#47;google&#47;ko&#47;blob&#47;0af2e5e8a9107523c287d7c67af874d3837cc39f&#47;pkg&#47;commands&#47;completion.go#L35<br><br>é‡ç‚¹æ¥äº†ï¼š<br>ko çš„ bash è¡¥å…¨æ˜¯å¯ä»¥æ­£å¸¸å·¥ä½œçš„ï¼Œä½† zsh è¡¥å…¨åœ¨æˆ‘è¿™æœ‰ç‚¹ä¸æ­£å¸¸ã€‚<br>    ï¼ˆæŒ‰äº†Tagè™½ç„¶èƒ½å‡ºæç¤ºï¼Œä½†æœ‰å…¶ä»–é”™è¯¯ã€‚ä¸çŸ¥é“å“ªæ¥çš„ï¼Œä¹Ÿä¸å¥½è°ƒè¯•ã€‚ï¼‰<br>è€å¸ˆçš„ zsh è¡¥å…¨æ˜¯å¥½ä½¿çš„ï¼</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: zshè„šæœ¬æ˜¯cobraæ¡†æ¶è‡ªåŠ¨ç”Ÿæˆçš„ã€‚å¦‚æœç”Ÿæˆçš„zshè‡ªåŠ¨è¡¥å…¨è„šæœ¬æœ‰é—®é¢˜ï¼Œå¯èƒ½è¯´æ˜æ²¡æœ‰æ­£ç¡®ä½¿ç”¨cobraæˆ–è€…cobraæœ‰é—®é¢˜ï¼Œæè®®googleä¸‹</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-14 19:35:21</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/43/cf/118c4ef5.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>lunar</span>
  </div>
  <div class="_2_QraFYR_0">ä¸€ä¸ªç››è€å¸ˆï¼Œä¸€ä¸ªè¿™ä¸ªè€å¸ˆï¼Œæ˜¯çœŸå†™ä»£ç å•Šï¼ï¼ï¼å¯èƒ½æ˜¯å¯¹cliå¼€å‘ä¸ç†Ÿæ‚‰ï¼Œçœ‹ä»£ç é‡Œç”¨äº†viper, ç›´æ¥å…ˆçœ‹viper è¿·çªäº†ä¸¤å¤©,è¿˜æ˜¯å…ˆçœ‹cobraå§</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-09-12 02:06:34</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/7a/d2/4ba67c0c.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Sch0ng</span>
  </div>
  <div class="_2_QraFYR_0">å‘½ä»¤è¡Œå®¢æˆ·ç«¯å·¥å…·æ˜¯å¤§å‹é¡¹ç›®äº¤äº’å’Œç®¡ç†çš„ä¸€éƒ¨åˆ†ã€‚<br>åˆå­¦åˆ°äº†ä¸€ä¸ªæœ€ä½³å®è·µï¼ŒèµğŸ‘</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-17 23:57:24</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æˆ‘æ¥ä¹Ÿ</span>
  </div>
  <div class="_2_QraFYR_0">æœ‰æ–°çš„å‘ç°ï¼š<br>ko è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ä¸­ï¼ŒåµŒå¥—äº†ä¸­æ‹¬å·ï¼Œå°±ä¼šå¯¼è‡´è¡¥å…¨å¤±è´¥ã€‚<br><br>ko completion zsh ç”Ÿæˆçš„ä»£ç æ˜¯è¿™æ ·ï¼š<br> &#39;--platform[Which platform to use when pulling a multi-platform base. Format: all | &lt;os&gt;[&#47;&lt;arch&gt;[&#47;&lt;variant&gt;]][,platform]*]:&#39; \<br><br>è¿™ä¸ªåœ¨ä½¿ç”¨ Tab è¡¥å…¨æ—¶å°±ä¼šæŠ¥é”™ï¼š<br>_arguments:comparguments:325: invalid option definition: --platform[Which platform to use when pulling a multi-platform base. Format: all | &lt;os&gt;[&#47;&lt;arch&gt;[&#47;&lt;variant&gt;]][,platform]*]:<br><br>å¦‚æœæ‰‹åŠ¨å°†ä¸Šé¢ç”Ÿæˆçš„ä»£ç æ”¹æˆï¼š<br>&#39;--platform[Which platform to use when pulling a multi-platform base. Format: all | &lt;os&gt;&lt;&#47;&lt;arch&gt;&lt;&#47;&lt;variant&gt;&gt;&gt;&lt;,platform&gt;*]:&#39; \<br><br>å†ä½¿ç”¨ ko apply --&lt;Tab&gt; æ—¶ï¼Œå°±ä¸ä¼šé‡åˆ°ä¸Šé¢çš„é”™è¯¯äº†ã€‚<br><br>ç°åœ¨å°±åªå‰©ä¸‹æœ€åä¸€ä¸ªé—®é¢˜äº†ï¼š<br>ko è¡¥å…¨æ—¶ï¼Œå‡ºç°çš„é”™è¯¯ä¸çŸ¥é“å“ªæ¥çš„ï¼Œæ¯”è¾ƒå°´å°¬ã€‚<br><br>âœ  zsh âœ— autoload exec<br>âœ  zsh âœ— ko ap&lt;Tab&gt;<br>(eval):6: exec: function definition file not found<br>Error: required flag(s) &quot;image&quot; not set<br>âœ  zsh âœ— ko apply --help<br><br></div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ç‰›æ‰¹ï¼</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-14 19:45:51</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>pedro</span>
  </div>
  <div class="_2_QraFYR_0">cool!</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-14 09:35:33</div>
  </div>
</div>
</div>
</li>
</ul>