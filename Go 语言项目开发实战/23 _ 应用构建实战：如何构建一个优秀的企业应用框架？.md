<audio title="23 _ åº”ç”¨æ„å»ºå®æˆ˜ï¼šå¦‚ä½•æ„å»ºä¸€ä¸ªä¼˜ç§€çš„ä¼ä¸šåº”ç”¨æ¡†æ¶ï¼Ÿ" src="https://static001.geekbang.org/resource/audio/e4/aa/e4da01ced3ee7e1e56a9b17dba7e0eaa.mp3" controls="controls"></audio> 
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å­”ä»¤é£ã€‚ä»Šå¤©æˆ‘ä»¬æ¥èŠèŠå¼€å‘åº”ç”¨å¿…é¡»è¦åšçš„é‚£äº›äº‹å„¿ã€‚</p><p>åº”ç”¨å¼€å‘æ˜¯è½¯ä»¶å¼€å‘å·¥ç¨‹å¸ˆæœ€æ ¸å¿ƒçš„å·¥ä½œã€‚åœ¨æˆ‘è¿™ 7 å¹´çš„ Go å¼€å‘ç”Ÿæ¶¯ä¸­ï¼Œæˆ‘æ„å»ºäº†å¤§å¤§å°å°ä¸ä¸‹ 50 ä¸ªåç«¯åº”ç”¨ï¼Œæ·±è°™å…¶ä¸­çš„ç—›ç‚¹ï¼Œæ¯”å¦‚ï¼š</p><ul>
<li>é‡å¤é€ è½®å­ã€‚åŒæ ·çš„åŠŸèƒ½å´æ¯æ¬¡éƒ½è¦é‡æ–°å¼€å‘ï¼Œæµªè´¹éå¸¸å¤šçš„æ—¶é—´å’Œç²¾åŠ›ä¸è¯´ï¼Œæ¯æ¬¡å®ç°çš„ä»£ç è´¨é‡æ›´æ˜¯å‚å·®ä¸é½ã€‚</li>
<li>ç†è§£æˆæœ¬é«˜ã€‚ç›¸åŒçš„åŠŸèƒ½ï¼Œæœ‰ N ä¸ªæœåŠ¡å¯¹åº”ç€ N ç§ä¸åŒçš„å®ç°æ–¹å¼ï¼Œå¦‚æœåŠŸèƒ½å‡çº§ï¼Œæˆ–è€…æœ‰æ–°æˆå‘˜åŠ å…¥ï¼Œéƒ½å¯èƒ½å¾—é‡æ–°ç†è§£ N æ¬¡ã€‚</li>
<li>åŠŸèƒ½å‡çº§çš„å¼€å‘å·¥ä½œé‡å¤§ã€‚ä¸€ä¸ªåº”ç”¨ç”± N ä¸ªæœåŠ¡ç»„æˆï¼Œå¦‚æœè¦å‡çº§å…¶ä¸­çš„æŸä¸ªåŠŸèƒ½ï¼Œä½ éœ€è¦åŒæ—¶æ›´æ–° N ä¸ªæœåŠ¡çš„ä»£ç ã€‚</li>
</ul><p>æƒ³è¦è§£å†³ä¸Šé¢è¿™äº›é—®é¢˜ï¼Œä¸€ä¸ªæ¯”è¾ƒå¥½çš„æ€è·¯æ˜¯ï¼š<strong>æ‰¾å‡ºç›¸åŒçš„åŠŸèƒ½ï¼Œç„¶åç”¨ä¸€ç§ä¼˜é›…çš„æ–¹å¼å»å®ç°å®ƒï¼Œå¹¶é€šè¿‡ Go åŒ…çš„å½¢å¼ï¼Œä¾›æ‰€æœ‰çš„æœåŠ¡ä½¿ç”¨ã€‚</strong></p><p>å¦‚æœä½ ä¹Ÿé¢ä¸´è¿™äº›é—®é¢˜ï¼Œå¹¶ä¸”æ­£åœ¨å¯»æ‰¾è§£å†³æ–¹æ³•ï¼Œé‚£ä¹ˆä½ å¯ä»¥è®¤çœŸå­¦ä¹ ä»Šå¤©è¿™ä¸€è®²ã€‚æˆ‘ä¼šå¸¦ä½ æ‰¾å‡ºæœåŠ¡çš„é€šç”¨åŠŸèƒ½ï¼Œå¹¶ç»™å‡ºä¼˜é›…çš„æ„å»ºæ–¹å¼ï¼Œå¸®åŠ©ä½ ä¸€åŠ³æ°¸é€¸åœ°è§£å†³è¿™äº›é—®é¢˜ã€‚åœ¨æé«˜å¼€å‘æ•ˆç‡çš„åŒæ—¶ï¼Œä¹Ÿèƒ½æé«˜ä½ çš„ä»£ç è´¨é‡ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆæ¥åˆ†æå¹¶æ‰¾å‡º Go æœåŠ¡é€šç”¨çš„åŠŸèƒ½ã€‚</p><h2>æ„å»ºåº”ç”¨çš„åŸºç¡€ï¼šåº”ç”¨çš„ä¸‰å¤§åŸºæœ¬åŠŸèƒ½</h2><p>æˆ‘ä»¬ç›®å‰è§åˆ°çš„ Go åç«¯æœåŠ¡ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥åˆ†ä¸º API æœåŠ¡å’Œé API æœåŠ¡ä¸¤ç±»ã€‚</p><ul>
<li>API æœåŠ¡ï¼šé€šè¿‡å¯¹å¤–æä¾› HTTP/RPC æ¥å£æ¥å®ŒæˆæŒ‡å®šçš„åŠŸèƒ½ã€‚æ¯”å¦‚è®¢å•æœåŠ¡ï¼Œé€šè¿‡è°ƒç”¨åˆ›å»ºè®¢å•çš„ API æ¥å£ï¼Œæ¥åˆ›å»ºå•†å“è®¢å•ã€‚</li>
<li>é API æœåŠ¡ï¼šé€šè¿‡ç›‘å¬ã€å®šæ—¶è¿è¡Œç­‰æ–¹å¼ï¼Œè€Œä¸æ˜¯é€šè¿‡ API è°ƒç”¨æ¥å®ŒæˆæŸäº›ä»»åŠ¡ã€‚æ¯”å¦‚æ•°æ®å¤„ç†æœåŠ¡ï¼Œå®šæ—¶ä» Redis ä¸­è·å–æ•°æ®ï¼Œå¤„ç†åå­˜å…¥åç«¯å­˜å‚¨ä¸­ã€‚å†æ¯”å¦‚æ¶ˆæ¯å¤„ç†æœåŠ¡ï¼Œç›‘å¬æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚ NSQ/Kafka/RabbitMQï¼‰ï¼Œæ”¶åˆ°æ¶ˆæ¯åè¿›è¡Œå¤„ç†ã€‚</li>
</ul><!-- [[[read_end]]] --><p>å¯¹äº API æœåŠ¡å’Œé API æœåŠ¡æ¥è¯´ï¼Œå®ƒä»¬çš„å¯åŠ¨æµç¨‹åŸºæœ¬ä¸€è‡´ï¼Œéƒ½å¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼š</p><ol>
<li>åº”ç”¨æ¡†æ¶çš„æ„å»ºï¼Œè¿™æ˜¯æœ€åŸºç¡€çš„ä¸€æ­¥ã€‚</li>
<li>åº”ç”¨åˆå§‹åŒ–ã€‚</li>
<li>æœåŠ¡å¯åŠ¨ã€‚</li>
</ol><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://static001.geekbang.org/resource/image/2a/9e/2a4ef770df3df2439ae595ef301e4d9e.png?wh=3075x1819" alt=""></p><p>å›¾ä¸­ï¼Œå‘½ä»¤è¡Œç¨‹åºã€å‘½ä»¤è¡Œå‚æ•°è§£æå’Œé…ç½®æ–‡ä»¶è§£æï¼Œæ˜¯æ‰€æœ‰æœåŠ¡éƒ½éœ€è¦å…·å¤‡çš„åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½æœ‰æœºç»“åˆåˆ°ä¸€èµ·ï¼Œå…±åŒæ„æˆäº†åº”ç”¨æ¡†æ¶ã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦æ„å»ºçš„ä»»ä½•ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œè‡³å°‘è¦å…·å¤‡å‘½ä»¤è¡Œç¨‹åºã€å‘½ä»¤è¡Œå‚æ•°è§£æå’Œé…ç½®æ–‡ä»¶è§£æè¿™ 3 ç§åŠŸèƒ½ã€‚</p><ul>
<li><strong>å‘½ä»¤è¡Œç¨‹åº</strong>ï¼šç”¨æ¥å¯åŠ¨ä¸€ä¸ªåº”ç”¨ã€‚å‘½ä»¤è¡Œç¨‹åºéœ€è¦å®ç°è¯¸å¦‚åº”ç”¨æè¿°ã€helpã€å‚æ•°æ ¡éªŒç­‰åŠŸèƒ½ã€‚æ ¹æ®éœ€è¦ï¼Œè¿˜å¯ä»¥å®ç°å‘½ä»¤è‡ªåŠ¨è¡¥å…¨ã€æ‰“å°å‘½ä»¤è¡Œå‚æ•°ç­‰é«˜çº§åŠŸèƒ½ã€‚</li>
<li><strong>å‘½ä»¤è¡Œå‚æ•°è§£æ</strong>ï¼šç”¨æ¥åœ¨å¯åŠ¨æ—¶æŒ‡å®šåº”ç”¨ç¨‹åºçš„å‘½ä»¤è¡Œå‚æ•°ï¼Œä»¥æ§åˆ¶åº”ç”¨çš„è¡Œä¸ºã€‚</li>
<li><strong>é…ç½®æ–‡ä»¶è§£æ</strong>ï¼šç”¨æ¥è§£æä¸åŒæ ¼å¼çš„é…ç½®æ–‡ä»¶ã€‚</li>
</ul><p>å¦å¤–ï¼Œä¸Šè¿° 3 ç±»åŠŸèƒ½è·Ÿä¸šåŠ¡å…³ç³»ä¸å¤§ï¼Œå¯ä»¥æŠ½è±¡æˆä¸€ä¸ªç»Ÿä¸€çš„æ¡†æ¶ã€‚åº”ç”¨åˆå§‹åŒ–ã€åˆ›å»º API/é API æœåŠ¡ã€å¯åŠ¨æœåŠ¡ï¼Œè·Ÿä¸šåŠ¡è”ç³»æ¯”è¾ƒç´§å¯†ï¼Œéš¾ä»¥æŠ½è±¡æˆä¸€ä¸ªç»Ÿä¸€çš„æ¡†æ¶ã€‚</p><h2>iam-apiserver æ˜¯å¦‚ä½•æ„å»ºåº”ç”¨æ¡†æ¶çš„ï¼Ÿ</h2><p>è¿™é‡Œï¼Œæˆ‘é€šè¿‡è®²è§£ iam-apiserver çš„åº”ç”¨æ„å»ºæ–¹å¼ï¼Œæ¥ç»™ä½ è®²è§£ä¸‹å¦‚ä½•æ„å»ºåº”ç”¨ã€‚iam-apiserver ç¨‹åºçš„ main å‡½æ•°ä½äº <a href="https://github.com/marmotedu/iam/blob/master/cmd/iam-apiserver/apiserver.go">apiserver.go</a> æ–‡ä»¶ä¸­ï¼Œå…¶æ„å»ºä»£ç å¯ä»¥ç®€åŒ–ä¸ºï¼š</p><pre><code>import (
    ...
    &quot;github.com/marmotedu/iam/internal/apiserver&quot;
    &quot;github.com/marmotedu/iam/pkg/app&quot;
)

func main() {
    ...
    apiserver.NewApp(&quot;iam-apiserver&quot;).Run()
}

const commandDesc = `The IAM API server validates and configures data ...`

// NewApp creates a App object with default parameters.
func NewApp(basename string) *app.App {
    opts := options.NewOptions()
    application := app.NewApp(&quot;IAM API Server&quot;,
        basename,
        app.WithOptions(opts),
        app.WithDescription(commandDesc),
        app.WithDefaultValidArgs(),
        app.WithRunFunc(run(opts)),
    )

    return application
}

func run(opts *options.Options) app.RunFunc {
    return func(basename string) error {
        log.Init(opts.Log)
        defer log.Flush()

        cfg, err := config.CreateConfigFromOptions(opts)
        if err != nil {
            return err
        }

        return Run(cfg)
    }
}
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡è°ƒç”¨åŒ… <code>github.com/marmotedu/iam/pkg/app</code> æ¥æ„å»ºåº”ç”¨çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å°†æ„å»ºåº”ç”¨çš„åŠŸèƒ½æŠ½è±¡æˆäº†ä¸€ä¸ª Go åŒ…ï¼Œé€šè¿‡ Go åŒ…å¯ä»¥æé«˜ä»£ç çš„å°è£…æ€§å’Œå¤ç”¨æ€§ã€‚iam-authz-server å’Œ iam-pump ç»„ä»¶ä¹Ÿéƒ½æ˜¯é€šè¿‡ <code>github.com/marmotedu/iam/pkg/app</code> æ¥æ„å»ºåº”ç”¨çš„ã€‚</p><p>æ„å»ºåº”ç”¨çš„æµç¨‹ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦åˆ›å»ºä¸€ä¸ª application å®ä¾‹å³å¯ï¼š</p><pre><code>opts := options.NewOptions()
application := app.NewApp(&quot;IAM API Server&quot;,
    basename,
    app.WithOptions(opts),
    app.WithDescription(commandDesc),
    app.WithDefaultValidArgs(),
    app.WithRunFunc(run(opts)),
)
</code></pre><p>åœ¨åˆ›å»ºåº”ç”¨å®ä¾‹æ—¶ï¼Œæˆ‘ä¼ å…¥äº†ä¸‹é¢è¿™äº›å‚æ•°ã€‚</p><ul>
<li>IAM API Serverï¼šåº”ç”¨çš„ç®€çŸ­æè¿°ã€‚</li>
<li>basenameï¼šåº”ç”¨çš„äºŒè¿›åˆ¶æ–‡ä»¶åã€‚</li>
<li>optsï¼šåº”ç”¨çš„å‘½ä»¤è¡Œé€‰é¡¹ã€‚</li>
<li>commandDescï¼šåº”ç”¨çš„è¯¦ç»†æè¿°ã€‚</li>
<li>run(opts)ï¼šåº”ç”¨çš„å¯åŠ¨å‡½æ•°ï¼Œåˆå§‹åŒ–åº”ç”¨ï¼Œå¹¶æœ€ç»ˆå¯åŠ¨ HTTP å’Œ GRPC Web æœåŠ¡ã€‚</li>
</ul><p>åˆ›å»ºåº”ç”¨æ—¶ï¼Œä½ è¿˜å¯ä»¥æ ¹æ®éœ€è¦æ¥é…ç½®åº”ç”¨å®ä¾‹ï¼Œæ¯”å¦‚ iam-apiserver ç»„ä»¶åœ¨åˆ›å»ºåº”ç”¨æ—¶ï¼ŒæŒ‡å®šäº† <code>WithDefaultValidArgs</code> æ¥æ ¡éªŒå‘½ä»¤è¡Œéé€‰é¡¹å‚æ•°çš„é»˜è®¤æ ¡éªŒé€»è¾‘ã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼Œiam-apiserver é€šè¿‡ç®€å•çš„å‡ è¡Œä»£ç ï¼Œå°±åˆ›å»ºå‡ºäº†ä¸€ä¸ªåº”ç”¨ã€‚ä¹‹æ‰€ä»¥è¿™ä¹ˆæ–¹ä¾¿ï¼Œæ˜¯å› ä¸ºåº”ç”¨æ¡†æ¶çš„æ„å»ºä»£ç éƒ½å°è£…åœ¨äº† <code>github.com/marmotedu/iam/pkg/app</code> åŒ…ä¸­ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥é‡ç‚¹çœ‹ä¸‹ <code>github.com/marmotedu/iam/pkg/app</code> åŒ…æ˜¯å¦‚ä½•å®ç°çš„ã€‚ä¸ºäº†æ–¹ä¾¿æè¿°ï¼Œæˆ‘åœ¨ä¸‹æ–‡ä¸­ç»Ÿç§°ä¸º App åŒ…ã€‚</p><h2>App åŒ…è®¾è®¡å’Œå®ç°</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ App åŒ…ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼š</p><pre><code>[colin@dev iam]$ ls pkg/app/
app.go  cmd.go  config.go  doc.go  flag.go  help.go  options.go
</code></pre><p><code>pkg/app</code> ç›®å½•ä¸‹çš„ 5 ä¸ªä¸»è¦æ–‡ä»¶æ˜¯ app.goã€cmd.goã€config.goã€flag.goã€options.goï¼Œåˆ†åˆ«å®ç°äº†åº”ç”¨ç¨‹åºæ¡†æ¶ä¸­çš„åº”ç”¨ã€å‘½ä»¤è¡Œç¨‹åºã€å‘½ä»¤è¡Œå‚æ•°è§£æã€é…ç½®æ–‡ä»¶è§£æå’Œå‘½ä»¤è¡Œé€‰é¡¹ 5 ä¸ªéƒ¨åˆ†ï¼Œå…·ä½“å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://static001.geekbang.org/resource/image/ea/12/ea3a0e20854b23fce7a654ce5f207512.png?wh=2378x828" alt=""></p><p>æˆ‘å†æ¥è§£é‡Šä¸‹è¿™å¼ å›¾ã€‚åº”ç”¨ç”±å‘½ä»¤è¡Œç¨‹åºã€å‘½ä»¤è¡Œå‚æ•°è§£æã€é…ç½®æ–‡ä»¶è§£æä¸‰éƒ¨åˆ†ç»„æˆï¼Œå‘½ä»¤è¡Œå‚æ•°è§£æåŠŸèƒ½é€šè¿‡å‘½ä»¤è¡Œé€‰é¡¹æ¥æ„å»ºï¼ŒäºŒè€…é€šè¿‡æ¥å£è§£è€¦åˆï¼š</p><pre><code>type CliOptions interface {    
    // AddFlags adds flags to the specified FlagSet object.    
    // AddFlags(fs *pflag.FlagSet)    
    Flags() (fss cliflag.NamedFlagSets)    
    Validate() []error    
}    
</code></pre><p>é€šè¿‡æ¥å£ï¼Œåº”ç”¨å¯ä»¥å®šåˆ¶è‡ªå·±ç‹¬æœ‰çš„å‘½ä»¤è¡Œå‚æ•°ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹å¦‚ä½•å…·ä½“æ„å»ºåº”ç”¨çš„æ¯ä¸€éƒ¨åˆ†ã€‚</p><h3>ç¬¬ 1 æ­¥ï¼šæ„å»ºåº”ç”¨</h3><p>APP åŒ…æä¾›äº† <a href="https://github.com/marmotedu/iam/blob/v1.0.4/pkg/app/app.go#L157">NewApp</a> å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªåº”ç”¨ï¼š</p><pre><code>func NewApp(name string, basename string, opts ...Option) *App {
    a := &amp;App{
        name:     name,
        basename: basename,
    }
 
    for _, o := range opts {
        o(a)
    }
 
    a.buildCommand()
 
    return a
}
</code></pre><p>NewApp ä¸­ä½¿ç”¨äº†è®¾è®¡æ¨¡å¼ä¸­çš„é€‰é¡¹æ¨¡å¼ï¼Œæ¥åŠ¨æ€åœ°é…ç½® APPï¼Œæ”¯æŒ WithRunFuncã€WithDescriptionã€WithValidArgs ç­‰é€‰é¡¹ã€‚</p><h3>ç¬¬ 2 æ­¥ï¼šå‘½ä»¤è¡Œç¨‹åºæ„å»º</h3><p>è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ Cobra åŒ…æ¥æ„å»ºåº”ç”¨çš„å‘½ä»¤è¡Œç¨‹åºã€‚</p><p>NewApp æœ€ç»ˆä¼šè°ƒç”¨ <a href="https://github.com/marmotedu/iam/blob/v1.0.4/pkg/app/app.go#L172">buildCommand</a> æ–¹æ³•æ¥åˆ›å»º Cobra Command ç±»å‹çš„å‘½ä»¤ï¼Œå‘½ä»¤çš„åŠŸèƒ½é€šè¿‡æŒ‡å®š Cobra Command ç±»å‹çš„å„ä¸ªå­—æ®µæ¥å®ç°ã€‚é€šå¸¸å¯ä»¥æŒ‡å®šï¼šUseã€Shortã€Longã€SilenceUsageã€SilenceErrorsã€RunEã€Args ç­‰å­—æ®µã€‚</p><p>åœ¨ buildCommand å‡½æ•°ä¸­ï¼Œä¹Ÿä¼šæ ¹æ®åº”ç”¨çš„è®¾ç½®æ·»åŠ ä¸åŒçš„å‘½ä»¤è¡Œå‚æ•°ï¼Œä¾‹å¦‚ï¼š</p><pre><code>if !a.noConfig {
    addConfigFlag(a.basename, namedFlagSets.FlagSet(&quot;global&quot;))
} 
</code></pre><p>ä¸Šè¿°ä»£ç çš„æ„æ€æ˜¯ï¼šå¦‚æœæˆ‘ä»¬è®¾ç½®äº† <code>noConfig=false</code>ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨å‘½ä»¤è¡Œå‚æ•° global åˆ†ç»„ä¸­æ·»åŠ ä»¥ä¸‹å‘½ä»¤è¡Œé€‰é¡¹ï¼š</p><pre><code>-c, --config FILE                                                        Read configuration from specified FILE, support JSON, TOML, YAML, HCL, or Java properties formats.
</code></pre><p>ä¸ºäº†æ›´åŠ æ˜“ç”¨å’Œäººæ€§åŒ–ï¼Œå‘½ä»¤è¿˜å…·æœ‰å¦‚ä¸‹ 3 ä¸ªåŠŸèƒ½ã€‚</p><ul>
<li>å¸®åŠ©ä¿¡æ¯ï¼šæ‰§è¡Œ <code>-h/--help</code> æ—¶ï¼Œè¾“å‡ºçš„å¸®åŠ©ä¿¡æ¯ã€‚é€šè¿‡ <code>cmd.SetHelpFunc</code> å‡½æ•°å¯ä»¥æŒ‡å®šå¸®åŠ©ä¿¡æ¯ã€‚</li>
<li>ä½¿ç”¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰ï¼šå½“ç”¨æˆ·æä¾›æ— æ•ˆçš„æ ‡å¿—æˆ–å‘½ä»¤æ—¶ï¼Œå‘ç”¨æˆ·æ˜¾ç¤ºâ€œä½¿ç”¨ä¿¡æ¯â€ã€‚é€šè¿‡ <code>cmd.SetUsageFunc</code> å‡½æ•°ï¼Œå¯ä»¥æŒ‡å®šä½¿ç”¨ä¿¡æ¯ã€‚å¦‚æœä¸æƒ³æ¯æ¬¡è¾“é”™å‘½ä»¤æ‰“å°ä¸€å¤§å † usage ä¿¡æ¯ï¼Œä½ å¯ä»¥é€šè¿‡è®¾ç½® <code>SilenceUsage: true</code> æ¥å…³é—­æ‰ usageã€‚</li>
<li>ç‰ˆæœ¬ä¿¡æ¯ï¼šæ‰“å°åº”ç”¨çš„ç‰ˆæœ¬ã€‚çŸ¥é“åº”ç”¨çš„ç‰ˆæœ¬å·ï¼Œå¯¹æ•…éšœæ’æŸ¥éå¸¸æœ‰å¸®åŠ©ã€‚é€šè¿‡ <code>verflag.AddFlags</code> å¯ä»¥æŒ‡å®šç‰ˆæœ¬ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼ŒApp åŒ…é€šè¿‡ <code>github.com/marmotedu/component-base/pkg/version</code> æŒ‡å®šäº†ä»¥ä¸‹ç‰ˆæœ¬ä¿¡æ¯ï¼š</li>
</ul><pre><code>$ ./iam-apiserver --version
  gitVersion: v0.3.0
   gitCommit: ccc31e292f66e6bad94efb1406b5ced84e64675c
gitTreeState: dirty
   buildDate: 2020-12-17T12:24:37Z
   goVersion: go1.15.1
    compiler: gc
    platform: linux/amd64
$ ./iam-apiserver --version=raw
version.Info{GitVersion:&quot;v0.3.0&quot;, GitCommit:&quot;ccc31e292f66e6bad94efb1406b5ced84e64675c&quot;, GitTreeState:&quot;dirty&quot;, BuildDate:&quot;2020-12-17T12:24:37Z&quot;, GoVersion:&quot;go1.15.1&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;}
</code></pre><p>æ¥ä¸‹æ¥ï¼Œå†æ¥çœ‹ä¸‹åº”ç”¨éœ€è¦å®ç°çš„å¦å¤–ä¸€ä¸ªé‡è¦åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯å‘½ä»¤è¡Œå‚æ•°è§£æã€‚</p><h3>ç¬¬ 3 æ­¥ï¼šå‘½ä»¤è¡Œå‚æ•°è§£æ</h3><p>App åŒ…åœ¨æ„å»ºåº”ç”¨å’Œæ‰§è¡Œåº”ç”¨ä¸¤ä¸ªé˜¶æ®µæ¥å®ç°å‘½ä»¤è¡Œå‚æ•°è§£æã€‚</p><p><strong>æˆ‘ä»¬å…ˆçœ‹æ„å»ºåº”ç”¨è¿™ä¸ªé˜¶æ®µã€‚</strong>App åŒ…åœ¨ <a href="https://github.com/marmotedu/iam/blob/v1.0.4/pkg/app/app.go#L172">buildCommand</a> æ–¹æ³•ä¸­é€šè¿‡ä»¥ä¸‹ä»£ç æ®µï¼Œç»™åº”ç”¨æ·»åŠ äº†å‘½ä»¤è¡Œå‚æ•°ï¼š</p><pre><code>var namedFlagSets cliflag.NamedFlagSets
if a.options != nil {
    namedFlagSets = a.options.Flags()
    fs := cmd.Flags()
    for _, f := range namedFlagSets.FlagSets {
        fs.AddFlagSet(f)
    }
 
    ...
}
 
if !a.noVersion {
    verflag.AddFlags(namedFlagSets.FlagSet(&quot;global&quot;))
}
if !a.noConfig {
    addConfigFlag(a.basename, namedFlagSets.FlagSet(&quot;global&quot;))
}
globalflag.AddGlobalFlags(namedFlagSets.FlagSet(&quot;global&quot;), cmd.Name())
</code></pre><p>namedFlagSets ä¸­å¼•ç”¨äº† Pflag åŒ…ï¼Œä¸Šè¿°ä»£ç å…ˆé€šè¿‡ <code>a.options.Flags()</code> åˆ›å»ºå¹¶è¿”å›äº†ä¸€æ‰¹ FlagSetï¼Œ<code>a.options.Flags()</code> å‡½æ•°ä¼šå°† FlagSet è¿›è¡Œåˆ†ç»„ã€‚é€šè¿‡ä¸€ä¸ª for å¾ªç¯ï¼Œå°† namedFlagSets ä¸­ä¿å­˜çš„ FlagSet æ·»åŠ åˆ° Cobra åº”ç”¨æ¡†æ¶ä¸­çš„ FlagSet ä¸­ã€‚</p><p>buildCommand è¿˜ä¼šæ ¹æ®åº”ç”¨çš„é…ç½®ï¼Œé€‰æ‹©æ€§æ·»åŠ ä¸€äº› flagã€‚ä¾‹å¦‚ï¼Œåœ¨ global åˆ†ç»„ä¸‹æ·»åŠ  <code>--version</code> å’Œ <code>--config</code> é€‰é¡¹ã€‚</p><p>æ‰§è¡Œ <code>-h</code> æ‰“å°å‘½ä»¤è¡Œå‚æ•°å¦‚ä¸‹ï¼š</p><pre><code>..
 
Usage:
  iam-apiserver [flags]
 
Generic flags:
 
      --server.healthz               Add self readiness check and install /healthz router. (default true)
      --server.max-ping-count int    The max number of ping attempts when server failed to startup. (default 3)
 
...
 
Global flags:
 
  -h, --help                     help for iam-apiserver
      --version version[=true]   Print version information and quit.
</code></pre><p>è¿™é‡Œæœ‰ä¸¤ä¸ªæŠ€å·§ï¼Œä½ å¯ä»¥å€Ÿé‰´ã€‚</p><p>ç¬¬ä¸€ä¸ªæŠ€å·§ï¼Œ<strong>å°† flag åˆ†ç»„</strong>ã€‚</p><p>ä¸€ä¸ªå¤§å‹ç³»ç»Ÿï¼Œå¯èƒ½ä¼šæœ‰å¾ˆå¤šä¸ª flagï¼Œä¾‹å¦‚ kube-apiserver å°±æœ‰ 200 å¤šä¸ª flagï¼Œè¿™æ—¶å¯¹ flag åˆ†ç»„å°±å¾ˆæœ‰å¿…è¦äº†ã€‚é€šè¿‡åˆ†ç»„ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¿«åœ°å®šä½åˆ°éœ€è¦çš„åˆ†ç»„åŠè¯¥åˆ†ç»„å…·æœ‰çš„æ ‡å¿—ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æƒ³äº†è§£ MySQL æœ‰å“ªäº›æ ‡å¿—ï¼Œå¯ä»¥æ‰¾åˆ° MySQL åˆ†ç»„ï¼š</p><pre><code>Mysql flags:
 
      --mysql.database string
                Database name for the server to use.
      --mysql.host string
                MySQL service host address. If left blank, the following related mysql options will be ignored. (default &quot;127.0.0.1:3306&quot;)
      --mysql.log-mode int
                Specify gorm log level. (default 1)
      ...
</code></pre><p>ç¬¬äºŒä¸ªæŠ€å·§ï¼Œ<strong>flag çš„åå­—å¸¦æœ‰å±‚çº§å…³ç³»</strong>ã€‚è¿™æ ·ä¸ä»…å¯ä»¥çŸ¥é“è¯¥ flag å±äºå“ªä¸ªåˆ†ç»„ï¼Œè€Œä¸”èƒ½å¤Ÿé¿å…é‡åã€‚ä¾‹å¦‚ï¼š</p><pre><code>$ ./iam-apiserver -h |grep host
      --mysql.host string                         MySQL service host address. If left blank, the following related mysql options will be ignored. (default &quot;127.0.0.1:3306&quot;)
      --redis.host string                   Hostname of your Redis server. (default &quot;127.0.0.1&quot;)
</code></pre><p>å¯¹äº MySQL å’Œ Redisï¼Œ éƒ½å¯ä»¥æŒ‡å®šç›¸åŒçš„ host æ ‡å¿—ï¼Œé€šè¿‡ <code>--mysql.host</code> ä¹Ÿå¯ä»¥çŸ¥é“è¯¥ flag éš¶å±äº mysql åˆ†ç»„ï¼Œä»£è¡¨çš„æ˜¯ MySQL çš„ hostã€‚</p><p><strong>æˆ‘ä»¬å†çœ‹åº”ç”¨æ‰§è¡Œé˜¶æ®µã€‚</strong>è¿™æ—¶ä¼šé€šè¿‡ viper.Unmarshalï¼Œå°†é…ç½® Unmarshal åˆ° Options å˜é‡ä¸­ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ Options å˜é‡ä¸­çš„å€¼ï¼Œæ¥æ‰§è¡Œåé¢çš„ä¸šåŠ¡é€»è¾‘ã€‚</p><p>æˆ‘ä»¬ä¼ å…¥çš„ Options æ˜¯ä¸€ä¸ªå®ç°äº† <a href="https://github.com/marmotedu/iam/blob/v1.0.4/pkg/app/options.go#L13">CliOptions</a> æ¥å£çš„ç»“æ„ä½“å˜é‡ï¼ŒCliOptions æ¥å£å®šä¹‰ä¸ºï¼š</p><pre><code>type CliOptions interface {
    Flags() (fss cliflag.NamedFlagSets)
    Validate() []error
}
</code></pre><p>å› ä¸º Options å®ç°äº† Validate æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥åœ¨åº”ç”¨æ¡†æ¶ä¸­è°ƒç”¨ Validate æ–¹æ³•æ¥æ ¡éªŒå‚æ•°æ˜¯å¦åˆæ³•ã€‚å¦å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç ï¼Œæ¥åˆ¤æ–­é€‰é¡¹æ˜¯å¦å¯è¡¥å…¨å’Œæ‰“å°ï¼šå¦‚æœå¯ä»¥è¡¥å…¨ï¼Œåˆ™è¡¥å…¨é€‰é¡¹ï¼›å¦‚æœå¯ä»¥æ‰“å°ï¼Œåˆ™æ‰“å°é€‰é¡¹çš„å†…å®¹ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>func (a *App) applyOptionRules() error {
    if completeableOptions, ok := a.options.(CompleteableOptions); ok {  
        if err := completeableOptions.Complete(); err != nil {
            return err                     
        }                                                    
    }                    
                                                                               
    if errs := a.options.Validate(); len(errs) != 0 {                           
        return errors.NewAggregate(errs)                                            
    }                                                            
                                        
    if printableOptions, ok := a.options.(PrintableOptions); ok &amp;&amp; !a.silence {
        log.Infof(&quot;%v Config: `%s`&quot;, progressMessage, printableOptions.String())
    }                                                     
                                                                                                                                    
    return nil                                                                                                                      
}       
</code></pre><p>é€šè¿‡é…ç½®è¡¥å…¨ï¼Œå¯ä»¥ç¡®ä¿ä¸€äº›é‡è¦çš„é…ç½®é¡¹å…·æœ‰é»˜è®¤å€¼ï¼Œå½“è¿™äº›é…ç½®é¡¹æ²¡æœ‰è¢«é…ç½®æ—¶ï¼Œç¨‹åºä¹Ÿä»ç„¶èƒ½å¤Ÿæ­£å¸¸å¯åŠ¨ã€‚ä¸€ä¸ªå¤§å‹é¡¹ç›®ï¼Œæœ‰å¾ˆå¤šé…ç½®é¡¹ï¼Œæˆ‘ä»¬ä¸å¯èƒ½å¯¹æ¯ä¸€ä¸ªé…ç½®é¡¹éƒ½è¿›è¡Œé…ç½®ã€‚æ‰€ä»¥ï¼Œç»™é‡è¦é…ç½®é¡¹è®¾ç½®é»˜è®¤å€¼ï¼Œå°±æ˜¾å¾—å¾ˆé‡è¦äº†ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ iam-apiserver æä¾›çš„ Validate æ–¹æ³•ï¼š</p><pre><code>func (s *ServerRunOptions) Validate() []error {
    var errs []error

    errs = append(errs, s.GenericServerRunOptions.Validate()...)
    errs = append(errs, s.GrpcOptions.Validate()...)
    errs = append(errs, s.InsecureServing.Validate()...)
    errs = append(errs, s.SecureServing.Validate()...)
    errs = append(errs, s.MySQLOptions.Validate()...)
    errs = append(errs, s.RedisOptions.Validate()...)
    errs = append(errs, s.JwtOptions.Validate()...)
    errs = append(errs, s.Log.Validate()...)
    errs = append(errs, s.FeatureOptions.Validate()...)

    return errs
}
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªé…ç½®åˆ†ç»„ï¼Œéƒ½å®ç°äº† <code>Validate()</code> å‡½æ•°ï¼Œå¯¹è‡ªå·±è´Ÿè´£çš„é…ç½®è¿›è¡Œæ ¡éªŒã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œç¨‹åºä¼šæ›´åŠ æ¸…æ™°ã€‚å› ä¸ºåªæœ‰é…ç½®æä¾›è€…æ‰æ›´æ¸…æ¥šå¦‚ä½•æ ¡éªŒè‡ªå·±çš„é…ç½®é¡¹ï¼Œæ‰€ä»¥æœ€å¥½çš„åšæ³•æ˜¯å°†é…ç½®çš„æ ¡éªŒæ”¾æƒç»™é…ç½®æä¾›è€…ï¼ˆåˆ†ç»„ï¼‰ã€‚</p><h3>ç¬¬ 4 æ­¥ï¼šé…ç½®æ–‡ä»¶è§£æ</h3><p>åœ¨ buildCommand å‡½æ•°ä¸­ï¼Œé€šè¿‡addConfigFlagè°ƒç”¨ï¼Œæ·»åŠ äº† <code>-c, --config FILE</code> å‘½ä»¤è¡Œå‚æ•°ï¼Œç”¨æ¥æŒ‡å®šé…ç½®æ–‡ä»¶ï¼š</p><pre><code>addConfigFlag(a.basename, namedFlagSets.FlagSet(&quot;global&quot;))
</code></pre><p>addConfigFlagå‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>func addConfigFlag(basename string, fs *pflag.FlagSet) {
    fs.AddFlag(pflag.Lookup(configFlagName))

    viper.AutomaticEnv()
    viper.SetEnvPrefix(strings.Replace(strings.ToUpper(basename), &quot;-&quot;, &quot;_&quot;, -1))
    viper.SetEnvKeyReplacer(strings.NewReplacer(&quot;.&quot;, &quot;_&quot;, &quot;-&quot;, &quot;_&quot;))

    cobra.OnInitialize(func() {
        if cfgFile != &quot;&quot; {
            viper.SetConfigFile(cfgFile)
        } else {
            viper.AddConfigPath(&quot;.&quot;)

            if names := strings.Split(basename, &quot;-&quot;); len(names) &gt; 1 {
                viper.AddConfigPath(filepath.Join(homedir.HomeDir(), &quot;.&quot;+names[0]))
            }

            viper.SetConfigName(basename)
        }

        if err := viper.ReadInConfig(); err != nil {
            _, _ = fmt.Fprintf(os.Stderr, &quot;Error: failed to read configuration file(%s): %v\n&quot;, cfgFile, err)
            os.Exit(1)
        }
    })
}
</code></pre><p>addConfigFlag å‡½æ•°ä¸­ï¼ŒæŒ‡å®šäº† Cobra Command åœ¨æ‰§è¡Œå‘½ä»¤ä¹‹å‰ï¼Œéœ€è¦åšçš„åˆå§‹åŒ–å·¥ä½œï¼š</p><pre><code>func() {
	if cfgFile != &quot;&quot; {
		viper.SetConfigFile(cfgFile)
	} else {
		viper.AddConfigPath(&quot;.&quot;)

		if names := strings.Split(basename, &quot;-&quot;); len(names) &gt; 1 {
			viper.AddConfigPath(filepath.Join(homedir.HomeDir(), &quot;.&quot;+names[0]))
		}

		viper.SetConfigName(basename)
	}

	if err := viper.ReadInConfig(); err != nil {
		_, _ = fmt.Fprintf(os.Stderr, &quot;Error: failed to read configuration file(%s): %v\n&quot;, cfgFile, err)
		os.Exit(1)
	}
}
</code></pre><p>ä¸Šè¿°ä»£ç å®ç°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ul>
<li>å¦‚æœå‘½ä»¤è¡Œå‚æ•°ä¸­æ²¡æœ‰æŒ‡å®šé…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼Œåˆ™åŠ è½½é»˜è®¤è·¯å¾„ä¸‹çš„é…ç½®æ–‡ä»¶ï¼Œé€šè¿‡ viper.AddConfigPathã€viper.SetConfigName æ¥è®¾ç½®é…ç½®æ–‡ä»¶æœç´¢è·¯å¾„å’Œé…ç½®æ–‡ä»¶åã€‚é€šè¿‡è®¾ç½®é»˜è®¤çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥ä½¿æˆ‘ä»¬ä¸ç”¨æºå¸¦ä»»ä½•å‘½ä»¤è¡Œå‚æ•°ï¼Œå³å¯è¿è¡Œç¨‹åºã€‚</li>
<li>æ”¯æŒç¯å¢ƒå˜é‡ï¼Œé€šè¿‡ viper.SetEnvPrefix æ¥è®¾ç½®ç¯å¢ƒå˜é‡å‰ç¼€ï¼Œé¿å…è·Ÿç³»ç»Ÿä¸­çš„ç¯å¢ƒå˜é‡é‡åã€‚é€šè¿‡ viper.SetEnvKeyReplacer é‡å†™äº† Env é”®ã€‚</li>
</ul><p>ä¸Šé¢ï¼Œæˆ‘ä»¬ç»™åº”ç”¨æ·»åŠ äº†é…ç½®æ–‡ä»¶çš„å‘½ä»¤è¡Œå‚æ•°ï¼Œå¹¶è®¾ç½®åœ¨å‘½ä»¤æ‰§è¡Œå‰ï¼Œè¯»å–é…ç½®æ–‡ä»¶ã€‚åœ¨å‘½ä»¤æ‰§è¡Œæ—¶ï¼Œä¼šå°†é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®é¡¹å’Œå‘½ä»¤è¡Œå‚æ•°ç»‘å®šï¼Œå¹¶å°† Viper çš„é…ç½® Unmarshal åˆ°ä¼ å…¥çš„ Options ä¸­ï¼š</p><pre><code>if !a.noConfig {    
    if err := viper.BindPFlags(cmd.Flags()); err != nil {    
        return err    
    }    
    
    if err := viper.Unmarshal(a.options); err != nil {    
        return err    
    }  
}  
</code></pre><p>Viper çš„é…ç½®æ˜¯å‘½ä»¤è¡Œå‚æ•°å’Œé…ç½®æ–‡ä»¶é…ç½® merge åçš„é…ç½®ã€‚å¦‚æœåœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šäº† MySQL çš„ host é…ç½®ï¼Œå¹¶ä¸”ä¹ŸåŒæ—¶æŒ‡å®šäº† <code>--mysql.host</code> å‚æ•°ï¼Œåˆ™ä¼šä¼˜å…ˆå–å‘½ä»¤è¡Œå‚æ•°è®¾ç½®çš„å€¼ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸åŒäº YAML æ ¼å¼çš„åˆ†çº§æ–¹å¼ï¼Œé…ç½®é¡¹æ˜¯é€šè¿‡ç‚¹å· <code>.</code> æ¥åˆ†çº§çš„ã€‚</p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸæ„å»ºäº†ä¸€ä¸ªä¼˜ç§€çš„åº”ç”¨æ¡†æ¶ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹è¿™ä¸ªåº”ç”¨æ¡†æ¶å…·æœ‰å“ªäº›ä¼˜ç‚¹å§ã€‚</p><h2>è¿™æ ·æ„å»ºçš„åº”ç”¨ç¨‹åºï¼Œæœ‰å“ªäº›ä¼˜ç§€ç‰¹æ€§ï¼Ÿ</h2><p>å€ŸåŠ© Cobra è‡ªå¸¦çš„èƒ½åŠ›ï¼Œæ„å»ºå‡ºçš„åº”ç”¨å¤©ç„¶å…·å¤‡å¸®åŠ©ä¿¡æ¯ã€ä½¿ç”¨ä¿¡æ¯ã€å­å‘½ä»¤ã€å­å‘½ä»¤è‡ªåŠ¨è¡¥å…¨ã€éé€‰é¡¹å‚æ•°æ ¡éªŒã€å‘½ä»¤åˆ«åã€PreRunã€PostRun ç­‰åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½å¯¹äºä¸€ä¸ªåº”ç”¨æ¥è¯´æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</p><p>Cobra å¯ä»¥é›†æˆ Pflagï¼Œé€šè¿‡å°†åˆ›å»ºçš„ Pflag FlagSet ç»‘å®šåˆ° Cobra å‘½ä»¤çš„ FlagSet ä¸­ï¼Œä½¿å¾— Pflag æ”¯æŒçš„æ ‡å¿—èƒ½ç›´æ¥é›†æˆåˆ° Cobra å‘½ä»¤ä¸­ã€‚é›†æˆåˆ°å‘½ä»¤ä¸­æœ‰å¾ˆå¤šå¥½å¤„ï¼Œä¾‹å¦‚ï¼š<code>cobra -h</code> å¯ä»¥æ‰“å°å‡ºæ‰€æœ‰è®¾ç½®çš„ flagï¼ŒCobra Command å‘½ä»¤æä¾›çš„ GenBashCompletion æ–¹æ³•ï¼Œå¯ä»¥å®ç°å‘½ä»¤è¡Œé€‰é¡¹çš„è‡ªåŠ¨è¡¥å…¨ã€‚</p><p>é€šè¿‡ viper.BindPFlags å’Œ viper.ReadInConfig å‡½æ•°ï¼Œå¯ä»¥ç»Ÿä¸€é…ç½®æ–‡ä»¶ã€å‘½ä»¤è¡Œå‚æ•°çš„é…ç½®é¡¹ï¼Œä½¿å¾—åº”ç”¨çš„é…ç½®é¡¹æ›´åŠ æ¸…æ™°å¥½è®°ã€‚é¢å¯¹ä¸åŒåœºæ™¯å¯ä»¥é€‰æ‹©ä¸åŒçš„é…ç½®æ–¹å¼ï¼Œä½¿é…ç½®æ›´åŠ çµæ´»ã€‚ä¾‹å¦‚ï¼šé…ç½® HTTPS çš„ç»‘å®šç«¯å£ï¼Œå¯ä»¥é€šè¿‡ <code>--secure.bind-port</code> é…ç½®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶é…ç½®ï¼ˆå‘½ä»¤è¡Œå‚æ•°ä¼˜å…ˆäºé…ç½®æ–‡ä»¶ï¼‰ï¼š</p><pre><code>secure:    
    bind-port: 8080
</code></pre><p>å¯ä»¥é€šè¿‡ <code>viper.GetString("secure.bind-port")</code> è¿™ç±»æ–¹å¼è·å–åº”ç”¨çš„é…ç½®ï¼Œè·å–æ–¹å¼æ›´åŠ çµæ´»ï¼Œè€Œä¸”å…¨å±€å¯ç”¨ã€‚</p><p>å°†åº”ç”¨æ¡†æ¶çš„æ„å»ºæ–¹æ³•å®ç°æˆäº†ä¸€ä¸ª Go åŒ…ï¼Œé€šè¿‡ Go åŒ…å¯ä»¥æé«˜åº”ç”¨æ„å»ºä»£ç çš„å°è£…æ€§å’Œå¤ç”¨æ€§ã€‚</p><h2>å¦‚æœä½ æƒ³è‡ªå·±æ„å»ºåº”ç”¨ï¼Œéœ€è¦æ³¨æ„äº›ä»€ä¹ˆï¼Ÿ</h2><p>å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–æ–¹å¼æ„å»ºä½ çš„åº”ç”¨ç¨‹åºã€‚æ¯”å¦‚ï¼Œæˆ‘å°±è§è¿‡å¾ˆå¤šå¼€å‘è€…ä½¿ç”¨å¦‚ä¸‹æ–¹å¼æ¥æ„å»ºåº”ç”¨ï¼šç›´æ¥åœ¨ <code>main.go</code> æ–‡ä»¶ä¸­é€šè¿‡ <code>gopkg.in/yaml.v3</code> åŒ…è§£æé…ç½®ï¼Œé€šè¿‡ Go æ ‡å‡†åº“çš„ flag åŒ…ç®€å•åœ°æ·»åŠ ä¸€äº›å‘½ä»¤è¡Œå‚æ•°ï¼Œä¾‹å¦‚<code>--help</code>ã€<code>--config</code>ã€<code>--version</code>ã€‚</p><p>ä½†æ˜¯ï¼Œåœ¨ä½ è‡ªå·±ç‹¬ç«‹æ„å»ºåº”ç”¨ç¨‹åºæ—¶ï¼Œå¾ˆå¯èƒ½ä¼šè¸©è¿™ä¹ˆ 3 ä¸ªå‘ï¼š</p><ul>
<li>æ„å»ºçš„åº”ç”¨åŠŸèƒ½ç®€å•ï¼Œæ‰©å±•æ€§å·®ï¼Œå¯¼è‡´åæœŸæ‰©å±•å¤æ‚ã€‚</li>
<li>æ„å»ºçš„åº”ç”¨æ²¡æœ‰å¸®åŠ©ä¿¡æ¯å’Œä½¿ç”¨ä¿¡æ¯ï¼Œæˆ–è€…ä¿¡æ¯æ ¼å¼æ‚ä¹±ï¼Œå¢åŠ åº”ç”¨çš„ä½¿ç”¨éš¾åº¦ã€‚</li>
<li>å‘½ä»¤è¡Œé€‰é¡¹å’Œé…ç½®æ–‡ä»¶æ”¯æŒçš„é…ç½®é¡¹ç›¸äº’ç‹¬ç«‹ï¼Œå¯¼è‡´é…åˆåº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œä¸çŸ¥é“è¯¥ä½¿ç”¨å“ªç§æ–¹å¼æ¥é…ç½®ã€‚</li>
</ul><p>åœ¨æˆ‘çœ‹æ¥ï¼Œå¯¹äºå°çš„åº”ç”¨ï¼Œè‡ªå·±æ ¹æ®éœ€è¦æ„å»ºæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å¯¹äºä¸€ä¸ªå¤§å‹é¡¹ç›®çš„è¯ï¼Œè¿˜æ˜¯åœ¨åº”ç”¨å¼€å‘ä¹‹åˆï¼Œå°±é‡‡ç”¨ä¸€äº›åŠŸèƒ½å¤šã€æ‰©å±•æ€§å¼ºçš„ä¼˜ç§€åŒ…ã€‚è¿™æ ·ï¼Œä»¥åéšç€åº”ç”¨çš„è¿­ä»£ï¼Œå¯ä»¥é›¶æˆæœ¬åœ°è¿›è¡ŒåŠŸèƒ½æ·»åŠ å’Œæ‰©å±•ï¼ŒåŒæ—¶ä¹Ÿèƒ½ä½“ç°æˆ‘ä»¬çš„ä¸“ä¸šæ€§å’ŒæŠ€æœ¯æ·±åº¦ï¼Œæé«˜ä»£ç è´¨é‡ã€‚</p><p>å¦‚æœä½ æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œä¸€å®šè¦è‡ªå·±æ„å»ºåº”ç”¨æ¡†æ¶ï¼Œé‚£ä¹ˆæˆ‘æœ‰ä»¥ä¸‹å‡ ä¸ªå»ºè®®ï¼š</p><ul>
<li>åº”ç”¨æ¡†æ¶åº”è¯¥æ¸…æ™°æ˜“è¯»ã€æ‰©å±•æ€§å¼ºã€‚</li>
<li>åº”ç”¨ç¨‹åºåº”è¯¥è‡³å°‘æ”¯æŒå¦‚ä¸‹å‘½ä»¤è¡Œé€‰é¡¹ï¼š<code>-h</code> æ‰“å°å¸®åŠ©ä¿¡æ¯ï¼›<code>-v</code> æ‰“å°åº”ç”¨ç¨‹åºçš„ç‰ˆæœ¬ï¼›<code>-c</code> æ”¯æŒæŒ‡å®šé…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚</li>
<li>å¦‚æœä½ çš„åº”ç”¨æœ‰å¾ˆå¤šå‘½ä»¤è¡Œé€‰é¡¹ï¼Œé‚£ä¹ˆå»ºè®®æ”¯æŒ <code>--secure.bind-port</code> è¿™æ ·çš„é•¿é€‰é¡¹ï¼Œé€šè¿‡é€‰é¡¹åå­—ï¼Œå°±å¯ä»¥çŸ¥é“é€‰é¡¹çš„ä½œç”¨ã€‚</li>
<li>é…ç½®æ–‡ä»¶ä½¿ç”¨ <code>yaml</code> æ ¼å¼ï¼Œ<code>yaml</code> æ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œèƒ½æ”¯æŒå¤æ‚çš„é…ç½®ï¼Œè¿˜æ¸…æ™°æ˜“è¯»ã€‚</li>
<li>å¦‚æœä½ æœ‰å¤šä¸ªæœåŠ¡ï¼Œé‚£ä¹ˆè¦ä¿æŒæ‰€æœ‰æœåŠ¡çš„åº”ç”¨æ„å»ºæ–¹å¼æ˜¯ä¸€è‡´çš„ã€‚</li>
</ul><h2>æ€»ç»“</h2><p>ä¸€ä¸ªåº”ç”¨æ¡†æ¶ç”±å‘½ä»¤ã€å‘½ä»¤è¡Œå‚æ•°è§£æã€é…ç½®æ–‡ä»¶è§£æ 3 éƒ¨åˆ†åŠŸèƒ½ç»„æˆï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Cobra æ¥æ„å»ºå‘½ä»¤ï¼Œé€šè¿‡ Pflag æ¥è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œé€šè¿‡ Viper æ¥è§£æé…ç½®æ–‡ä»¶ã€‚ä¸€ä¸ªé¡¹ç›®ï¼Œå¯èƒ½åŒ…å«å¤šä¸ªåº”ç”¨ï¼Œè¿™äº›åº”ç”¨éƒ½éœ€è¦é€šè¿‡ Cobraã€Viperã€Pflag æ¥æ„å»ºã€‚ä¸ºäº†ä¸é‡å¤é€ è½®å­ï¼Œç®€åŒ–åº”ç”¨çš„æ„å»ºï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™äº›åŠŸèƒ½å®ç°ä¸ºä¸€ä¸ª Go åŒ…ï¼Œæ–¹ä¾¿ç›´æ¥è°ƒç”¨æ„å»ºåº”ç”¨ã€‚</p><p>IAM é¡¹ç›®çš„åº”ç”¨éƒ½æ˜¯é€šè¿‡ <code>github.com/marmotedu/iam/pkg/app</code> åŒ…æ¥æ„å»ºçš„ï¼Œåœ¨æ„å»ºæ—¶ï¼Œè°ƒç”¨ App åŒ…æä¾›çš„ NewApp å‡½æ•°ï¼Œæ¥æ„å»ºä¸€ä¸ªåº”ç”¨ï¼š</p><pre><code>func NewApp(basename string) *app.App {
    opts := options.NewOptions()
    application := app.NewApp(&quot;IAM API Server&quot;,
        basename,
        app.WithOptions(opts),
        app.WithDescription(commandDesc),
        app.WithDefaultValidArgs(),
        app.WithRunFunc(run(opts)),
    )

    return application
}
</code></pre><p>åœ¨æ„å»ºåº”ç”¨æ—¶ï¼Œåªéœ€è¦æä¾›åº”ç”¨ç®€çŸ­/è¯¦ç»†æè¿°ã€åº”ç”¨äºŒè¿›åˆ¶æ–‡ä»¶åç§°å’Œå‘½ä»¤è¡Œé€‰é¡¹å³å¯ã€‚App åŒ…ä¼šæ ¹æ® Options æä¾›çš„ <code>Flags()</code> æ–¹æ³•ï¼Œæ¥ç»™åº”ç”¨æ·»åŠ å‘½ä»¤è¡Œé€‰é¡¹ã€‚å‘½ä»¤è¡Œé€‰é¡¹ä¸­æä¾›äº† <code>-c, --config</code> é€‰é¡¹æ¥æŒ‡å®šé…ç½®æ–‡ä»¶ï¼ŒApp åŒ…ä¹Ÿä¼šåŠ è½½å¹¶è§£æè¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œå¹¶å°†é…ç½®æ–‡ä»¶å’Œå‘½ä»¤è¡Œé€‰é¡¹ç›¸åŒé…ç½®é¡¹è¿›è¡Œ Mergeï¼Œæœ€ç»ˆå°†é…ç½®é¡¹çš„å€¼ä¿å­˜åœ¨ä¼ å…¥çš„ Options å˜é‡ä¸­ï¼Œä¾›ä¸šåŠ¡ä»£ç ä½¿ç”¨ã€‚</p><p>æœ€åï¼Œå¦‚æœä½ æƒ³è‡ªå·±æ„å»ºåº”ç”¨ï¼Œæˆ‘ç»™å‡ºäº†ä¸€äº›æˆ‘çš„å»ºè®®ï¼šè®¾è®¡ä¸€ä¸ªæ¸…æ™°æ˜“è¯»ã€æ˜“æ‰©å±•çš„åº”ç”¨æ¡†æ¶ï¼›æ”¯æŒä¸€äº›å¸¸è§çš„é€‰é¡¹ï¼Œä¾‹å¦‚ <code>-h</code>ï¼Œ <code>-v</code>ï¼Œ <code>-c</code> ç­‰ï¼›å¦‚æœåº”ç”¨çš„å‘½ä»¤è¡Œé€‰é¡¹æ¯”è¾ƒå¤šï¼Œå»ºè®®ä½¿ç”¨ <code>--secure.bind-port</code> è¿™æ ·çš„é•¿é€‰é¡¹ã€‚</p><h2>è¯¾åç»ƒä¹ </h2><ol>
<li>é™¤äº† Cobraã€Viperã€Pflag ä¹‹å¤–ï¼Œä½ è¿˜é‡åˆ°è¿‡å“ªäº›æ¯”è¾ƒä¼˜ç§€çš„åŒ…æˆ–è€…å·¥å…·ï¼Œå¯ä»¥ç”¨æ¥æ„å»ºåº”ç”¨æ¡†æ¶ï¼Ÿæ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ã€‚</li>
<li>ç ”ç©¶ä¸‹ iam-apiserver çš„å‘½ä»¤è¡Œé€‰é¡¹ <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/options/options.go">Options</a> æ˜¯å¦‚ä½•é€šè¿‡ Options çš„ Flags()æ–¹æ³•æ¥å®ç° Flag åˆ†ç»„çš„ï¼Œå¹¶æ€è€ƒä¸‹è¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ã€‚</li>
</ol><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºã€‚å½“ç„¶äº†ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™ä¸€è®²åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œä»–ä»¬çš„ä¸€äº›æƒ³æ³•æˆ–è®¸ä¼šè®©ä½ æœ‰æ›´å¤§çš„æ”¶è·ã€‚æˆ‘ä»¬ä¸‹ä¸€è®²è§ï¼</p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKotsBr2icbYNYlRSlicGUD1H7lulSTQUAiclsEz9gnG5kCW9qeDwdYtlRMXic3V6sj9UrfKLPJnQojag/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ppd0705</span>
  </div>
  <div class="_2_QraFYR_0">è¿˜æ²¡å†™è¿‡å¤§åº”ç”¨ï¼Œæ„Ÿè§‰è¿™ä¸ªæ¡†æ¶æœ‰ç‚¹å¤æ‚ï¼Œæ…¢æ…¢å“</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å€¼å¾—ä¸€å“ï¼</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-08 15:12:54</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src=""
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek8292</span>
  </div>
  <div class="_2_QraFYR_0">å¤ªç‰›äº†ï¼Œä¸€ä¸ªè¿™ä¸ªå¯ä»¥ç ”ç©¶åˆ°è¿™ä¹ˆç»†ï¼Œç»™è·ªäº†</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-09-16 17:01:50</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/7a/d2/4ba67c0c.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Sch0ng</span>
  </div>
  <div class="_2_QraFYR_0">æ„å»ºä¸€ä¸ªä¼˜ç§€çš„ä¼ä¸šåº”ç”¨æ¡†æ¶ï¼Œä¸€æ¬¡æŠ•å…¥å¤šæ¬¡ä½¿ç”¨ï¼Œå¾ˆåˆ’ç®—ã€‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-12 23:20:24</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLsia5hqVlTLn17lUBwSpSUzraib7MSH3gOUNWOx8qUwpz3Lp6gFtkIibOMUAouyMGj5RIeTcePUfNkw/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>jg4igianshu</span>
  </div>
  <div class="_2_QraFYR_0">666ï¼›å¹´å‡7ä¸ªé¡¹ç›®æœˆå‡0.6ä¸ªé¡¹ç›®ï¼</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-11 09:08:46</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/17/53/f9/8acc210d.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>äºŒçš„æ ¹æ¯”æ–¹</span>
  </div>
  <div class="_2_QraFYR_0">è°¢è°¢è€å¸ˆï¼Œæœ‰ä¸ªé—®é¢˜æ˜¯ä¸€èˆ¬æ¡†æ¶éƒ½éµå¾ªâ€œä¾èµ–å€’ç½®â€åŸåˆ™ï¼Œè¯·é—®goåº”ç”¨åœ¨æ„å»ºæ—¶åº”è¯¥è€ƒè™‘é‚£äº›ç‚¹ï¼Œè°¢è°¢</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: è¿™é‡Œå…¶å®å°±æ˜¯è¦æ±‚ï¼Œç¼–ç¨‹æ—¶ï¼Œè¦é¢å‘æ¥å£ç¼–ç¨‹ï¼Œè€Œéé¢å‘è¿‡ç¨‹ç¼–ç¨‹ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-07-25 11:45:56</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/5T98QoeVBeoicz3ReKg5mykgib9lxibUziaupmUk7h9L67uGlco3qoT0oXrVfObUytbtFImjrxtiaNvIn0Grs5A7png/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>é›ªæ«</span>
  </div>
  <div class="_2_QraFYR_0">ç…§ç€é¡¹ç›®æŠ„éƒ½æ„Ÿè§‰æœ‰ç‚¹è´¹åŠ²ï¼Œæ‰€ä»¥è¦æŠŠè¿™ä¸ªé¡¹ç›®åƒé€çš„è¯ï¼Œå¤§æ¦‚éœ€è¦å¤šä¹…çš„æ—¶é—´ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ä¸å¥½è¯´ï¼Œåˆ†äººï¼Œè¿˜åˆ†æ¯å¤©æŠ•å…¥çš„æ—¶é—´</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-04-08 22:52:18</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>lesserror</span>
  </div>
  <div class="_2_QraFYR_0">å­”è€æ¿ï¼ŒåƒCobraã€Viperã€Pflagè¿™ä¸‰ä¸ªåŒ…ï¼Œæ˜¯å¾ˆå¤šçŸ¥åé¡¹ç›®éƒ½ä½¿ç”¨çš„æ–¹æ¡ˆå—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å¯¹çš„ï¼Œåƒkubernetesã€istioã€dockerã€etcdç­‰éƒ½ç”¨çš„æ˜¯è¿™äº›ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-10-16 14:37:16</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/f4/0a/616e3532.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å¥³å¹²éƒ¨</span>
  </div>
  <div class="_2_QraFYR_0">åƒimè¿™ç§å³æ—¶é€šè®¯ç±»çš„ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥å½’ç±»åˆ°æ¶ˆæ¯å¤„ç†æœåŠ¡ä¸­å»</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: è¿˜ä¸èƒ½å§ï¼Œæˆ‘ç†è§£åƒcmqã€kafkaè¿™ç±»æ‰æ˜¯æ¶ˆæ¯å¤„ç†æœåŠ¡ã€‚<br><br>imæ›´å¤šæŒ‡çš„ç›´æ¥é¢å‘ç”¨æˆ·çš„èŠå¤©å·¥å…·ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-07-19 02:16:09</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/43/2d/af86d73f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>enjoylearning</span>
  </div>
  <div class="_2_QraFYR_0">goçš„åº”ç”¨éƒ½å¸¦ä¸ªå‘½ä»¤è¡Œè°ƒç”¨ï¼Œè¿™è²Œä¼¼æ˜¯ä¸€ç§è®¾è®¡åçˆ±ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-12-29 21:14:31</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/4b/11/d7e08b5b.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>dll</span>
  </div>
  <div class="_2_QraFYR_0">çœ‹å®Œäº† çœŸçš„ä¸é”™</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-10-13 08:27:14</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/27/d7/f9/4c08ed90.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>é‚µåº·</span>
  </div>
  <div class="_2_QraFYR_0">æƒ³é—®ä¸€ä¸‹ï¼Œå¦‚ä½•å®ç°å‘½ä»¤è¡Œè¡¥å…¨åŠŸèƒ½ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: cobraè‡ªå¸¦çš„ã€‚iamctl completion bash ä¼šè¾“å‡ºbashçš„è‡ªåŠ¨è¡¥å…¨è„šæœ¬</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-06-10 08:56:58</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/2d/66/35/c3fa51c0.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æˆ‘è¦å»å–å†°æ·‡æ·‹</span>
  </div>
  <div class="_2_QraFYR_0">github.com&#47;marmotedu&#47;component-base&#47;pkg&#47;cli&#47;flag è€å¸ˆè¿™ä¸ªé¡¹ç›®404äº†</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: è®¿é—®githubï¼Œè¦è®¿é—®ï¼šhttps:&#47;&#47;github.com&#47;marmotedu&#47;component-base&#47;tree&#47;master&#47;pkg&#47;cli&#47;flag</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-04-19 08:11:03</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/0c/46/dfe32cf4.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å¤šé€‰å‚æ•°</span>
  </div>
  <div class="_2_QraFYR_0">åƒ kubernete è¿™æ ·çš„æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯é‡‡ç”¨ç±»ä¼¼çš„åº”ç”¨æ„å»ºæ–¹æ³•ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ä¸€æ ·çš„æ„å»ºæ–¹æ³•</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-29 11:20:17</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/87/64/3882d90d.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>yandongxiao</span>
  </div>
  <div class="_2_QraFYR_0">æ€»ç»“ï¼š<br>1. å¦‚ä½•å°† viperã€pflagã€cobra ç»“åˆèµ·æ¥ï¼Œæ„å»ºå‡ºåº”ç”¨æ¡†æ¶ï¼Ÿ<br>2. åº”ç”¨æ¡†æ¶ä¸»è¦ä»å‘½ä»¤è¡Œæˆ–è€…é…ç½®æ–‡ä»¶ï¼Œè§£æå‚æ•°ï¼›æä¾› --help, --version ç­‰è¾…åŠ©æ€§å‘½ä»¤ï¼›è°ƒç”¨æ–¹ä»ç„¶ä»¥structæ–¹å¼ç»„ç»‡è¿™äº›æ•°æ®ã€‚<br>3. å¯¹å‘½ä»¤è¡Œå‚æ•°è¿›è¡Œåˆ†ç»„ï¼Œ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: 666</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-11-27 14:52:18</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/21/5f/e2/e6d3d9bf.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>XI</span>
  </div>
  <div class="_2_QraFYR_0">app.go é‡Œé¢ buildCommand() æ–¹æ³•æŠ¥é”™äº†ï¼Œ<br>171è¡Œ	cliflag.InitFlags() ï¼Œæ²¡æœ‰å‚æ•°ï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ªå‚æ•°<br>func (a *App) buildCommand() {<br>	cliflag.InitFlags()<br><br>	cmd := cobra.Command{<br>		Use:   FormatBaseName(a.basename),<br>		Short: a.name,<br>		Long:  a.description,<br>		&#47;&#47; stop printing usage when the command errors<br>		SilenceUsage:  true,<br>		SilenceErrors: true,<br>		Args:          a.args,<br>	}<br>	&#47;&#47; cmd.SetUsageTemplate(usageTemplate)<br>	cmd.SetOut(os.Stdout)<br>	cmd.SetErr(os.Stderr)<br>	cmd.Flags().SortFlags = true<br></div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ‹‰ä¸‹æœ€æ–°çš„masteråˆ†æ”¯ï¼Œæ˜¯æœ‰çš„</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-10-18 13:57:17</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/21/5f/f8/1d16434b.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>é™ˆéº’æ–‡</span>
  </div>
  <div class="_2_QraFYR_0">æ¯ç« éƒ½å¾ˆæœ‰çš„æ¶ˆåŒ–ï¼ŒåŠ æ²¹ğŸ’ª</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: åŠ æ²¹ï¼</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-19 13:58:12</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/04/60/64d166b6.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Fan</span>
  </div>
  <div class="_2_QraFYR_0">50 ä¸ªåç«¯åº”ç”¨éƒ½æœ‰å•¥ç±»å‹çš„å‘€ï¼Ÿåˆ†äº«ä¸‹å¯å¥½ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å¤ªå¤šäº†ï¼Œæ¯”è¾ƒå¤§çš„æ¯”å¦‚äº‘å‡½æ•°ã€å®¹å™¨æœåŠ¡ã€åˆå§‹åŒ–ç³»ç»Ÿã€ç½‘å…³ã€å¾®æœåŠ¡ç­‰ç­‰</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-12 18:52:24</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>helloworld</span>
  </div>
  <div class="_2_QraFYR_0">â€œä¾‹å¦‚ï¼šé…ç½® HTTPS çš„ç»‘å®šç«¯å£ï¼Œå¯ä»¥é€šè¿‡ --secure.bind-port é…ç½®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶é…ç½®ï¼ˆå‘½ä»¤è¡Œå‚æ•°ä¼˜å…ˆäºé…ç½®æ–‡ä»¶ï¼‰ï¼š<br>secure:    <br>    bind-address: 0.0.0.0â€ï¼Œæ–‡ä¸­è¿™å—å‰åæ²¡å‘¼åº”ä¸Š.</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ„Ÿè°¢åé¦ˆï¼Œæˆ‘ä»¬æ›´æ–°ä¸‹å“ˆ</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-07-21 23:44:18</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erRavHNiaicxIIrTK5JjKyCNaSKN2MhnM2X0IuNpcoDoyn0OUOqYgdEb0brT9QgibAKyjBP3R3x0W3Jw/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>huntersudo</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆå¥½ï¼Œæœ€åä¸€éƒ¨åˆ†ï¼Œç¬¬ 4 æ­¥ï¼šé…ç½®æ–‡ä»¶è§£æï¼Œæºç éƒ¨åˆ†ï¼Œå¾—è¿™æ ·è´´å‡ºæ¥ï¼Œæ‰èƒ½å’Œä¸‹æ–‡å¯¹çš„ä¸Š<br>func addConfigFlag(basename string, fs *pflag.FlagSet) {<br>	fs.AddFlag(pflag.Lookup(configFlagName))<br><br>	viper.AutomaticEnv()<br>	viper.SetEnvPrefix(strings.Replace(strings.ToUpper(basename), &quot;-&quot;, &quot;_&quot;, -1))<br>	viper.SetEnvKeyReplacer(strings.NewReplacer(&quot;.&quot;, &quot;_&quot;, &quot;-&quot;, &quot;_&quot;))<br><br>	cobra.OnInitialize(func() {<br>		if cfgFile != &quot;&quot; {<br>			viper.SetConfigFile(cfgFile)<br>		} else {<br>			viper.AddConfigPath(&quot;.&quot;)<br><br>			if names := strings.Split(basename, &quot;-&quot;); len(names) &gt; 1 {<br>				viper.AddConfigPath(filepath.Join(homedir.HomeDir(), &quot;.&quot;+names[0]))<br>			}<br><br>			viper.SetConfigName(basename)<br>		}<br><br>		if err := viper.ReadInConfig(); err != nil {<br>			_, _ = fmt.Fprintf(os.Stderr, &quot;Error: failed to read configuration file(%s): %v\n&quot;, cfgFile, err)<br>			os.Exit(1)<br>		}<br>	})<br>}</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ„Ÿè°¢åé¦ˆï¼Œæˆ‘ä»¬é€‚é…ä¸‹ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-07-19 18:40:59</div>
  </div>
</div>
</div>
</li>
</ul>