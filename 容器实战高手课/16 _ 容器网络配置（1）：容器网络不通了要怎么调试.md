<audio title="16 _ å®¹å™¨ç½‘ç»œé…ç½®ï¼ˆ1ï¼‰ï¼šå®¹å™¨ç½‘ç»œä¸é€šäº†è¦æ€ä¹ˆè°ƒè¯•" src="https://static001.geekbang.org/resource/audio/1f/b0/1f203869198452ac1f50c85cbb1476b0.mp3" controls="controls"></audio> 
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ç¨‹è¿œã€‚</p><p>åœ¨ä¸Šä¸€è®²ï¼Œæˆ‘ä»¬è®²äº†Network Namespaceéš”ç¦»äº†ç½‘ç»œè®¾å¤‡ï¼ŒIPåè®®æ ˆå’Œè·¯ç”±è¡¨ï¼Œä»¥åŠé˜²ç«å¢™è§„åˆ™ï¼Œé‚£å®¹å™¨Network Namespaceé‡Œçš„å‚æ•°æ€ä¹ˆå»é…ç½®ï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»å¾ˆæ¸…æ¥šäº†ã€‚</p><p>å…¶å®å¯¹äºç½‘ç»œé…ç½®çš„é—®é¢˜ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªæœ€éœ€è¦å…³å¿ƒçš„å†…å®¹ï¼Œé‚£å°±æ˜¯å®¹å™¨å’Œå¤–é¢çš„å®¹å™¨æˆ–è€…èŠ‚ç‚¹æ˜¯æ€ä¹ˆé€šè®¯çš„ï¼Œè¿™å°±æ¶‰åŠåˆ°äº†å®¹å™¨ç½‘ç»œæ¥å£é…ç½®çš„é—®é¢˜äº†ã€‚</p><p>æ‰€ä»¥è¿™ä¸€è®²å‘¢ï¼Œæˆ‘ä»¬å°±æ¥èŠä¸€èŠï¼Œå®¹å™¨Network Namespaceé‡Œå¦‚ä½•é…ç½®ç½‘ç»œæ¥å£ï¼Œè¿˜æœ‰å½“å®¹å™¨ç½‘ç»œä¸é€šçš„æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆå»åšä¸€ä¸ªç®€å•è°ƒè¯•ã€‚</p><h2>é—®é¢˜å†ç°</h2><p>åœ¨å‰é¢çš„è¯¾ç¨‹é‡Œï¼Œæˆ‘ä»¬ä¸€ç›´æ˜¯ç”¨ <code>docker run</code> è¿™ä¸ªå‘½ä»¤æ¥å¯åŠ¨å®¹å™¨çš„ã€‚å®¹å™¨å¯åŠ¨äº†ä¹‹åï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œåœ¨å®¹å™¨é‡Œé¢æœ‰ä¸€ä¸ª"eth0"çš„ç½‘ç»œæ¥å£ï¼Œæ¥å£ä¸Šä¹Ÿé…ç½®äº†ä¸€ä¸ªIPåœ°å€ã€‚</p><p>ä¸è¿‡å‘¢ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ä»å®¹å™¨é‡Œè®¿é—®å¤–é¢çš„ä¸€ä¸ªIPåœ°å€ï¼Œæ¯”å¦‚è¯´39.106.233.176ï¼ˆè¿™ä¸ªæ˜¯æå®¢æ—¶é—´ç½‘å€å¯¹åº”çš„IPï¼‰ï¼Œç»“æœå°±å‘ç°æ˜¯ä¸èƒ½pingé€šçš„ã€‚</p><p>è¿™æ—¶æˆ‘ä»¬å¯èƒ½ä¼šæƒ³åˆ°ï¼Œåˆ°åº•æ˜¯ä¸æ˜¯å®¹å™¨å†…å‡ºäº†é—®é¢˜ï¼Œåœ¨å®¹å™¨é‡Œæ— æ³•è®¿é—®ï¼Œä¼šä¸ä¼šå®¿ä¸»æœºä¹Ÿä¸€æ ·ä¸è¡Œå‘¢ï¼Ÿ</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦éªŒè¯ä¸€ä¸‹ï¼Œé¦–å…ˆæˆ‘ä»¬é€€å‡ºå®¹å™¨ï¼Œç„¶ååœ¨å®¿ä¸»æœºçš„Network Namespaceä¸‹ï¼Œå†è¿è¡Œ <code>ping 39.106.233.176</code>ï¼Œç»“æœå°±ä¼šå‘ç°åœ¨å®¿ä¸»æœºä¸Šï¼Œå´æ˜¯å¯ä»¥è¿é€šè¿™ä¸ªåœ°å€çš„ã€‚</p><!-- [[[read_end]]] --><pre><code class="language-shell"># docker run -d --name if-test centos:8.1.1911 sleep 36000
244d44f94dc2931626194c6fd3f99cec7b7c4bf61aafc6c702551e2c5ca2a371
# docker exec -it if-test bash
 
[root@244d44f94dc2 /]# ip addr
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
808: eth0@if809: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default
    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
       valid_lft forever preferred_lft forever
 
[root@244d44f94dc2 /]# ping 39.106.233.176       ### å®¹å™¨ä¸­æ— æ³•pingé€š
PING 39.106.233.176 (39.106.233.176) 56(84) bytes of data.
^C
--- 39.106.233.176 ping statistics ---
9 packets transmitted, 0 received, 100% packet loss, time 185ms
 
[root@244d44f94dc2 /]# exit             ###é€€å‡ºå®¹å™¨
exit
 
# ping 39.106.233.176                        ### å®¿ä¸»æœºä¸Šå¯ä»¥pingé€š
PING 39.106.233.176 (39.106.233.176) 56(84) bytes of data.
64 bytes from 39.106.233.176: icmp_seq=1 ttl=78 time=296 ms
64 bytes from 39.106.233.176: icmp_seq=2 ttl=78 time=306 ms
64 bytes from 39.106.233.176: icmp_seq=3 ttl=78 time=303 ms
^C
--- 39.106.233.176 ping statistics ---
4 packets transmitted, 3 received, 25% packet loss, time 7ms
rtt min/avg/max/mdev = 296.059/301.449/305.580/4.037 ms
</code></pre><p>é‚£ä¹ˆç¢°åˆ°è¿™ç§å®¹å™¨å†…ç½‘ç»œä¸é€šçš„é—®é¢˜ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆåˆ†æè°ƒè¯•å‘¢ï¼Ÿæˆ‘ä»¬è¿˜æ˜¯éœ€è¦å…ˆæ¥ç†è§£ä¸€ä¸‹ï¼Œå®¹å™¨Network Namespaceé‡Œçš„ç½‘ç»œæ¥å£æ˜¯æ€ä¹ˆé…ç½®çš„ã€‚</p><h2>åŸºæœ¬æ¦‚å¿µ</h2><p>åœ¨è®²è§£å®¹å™¨çš„ç½‘ç»œæ¥å£é…ç½®ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå»ºç«‹ä¸€ä¸ªæ•´ä½“çš„è®¤è¯†ï¼Œææ¸…æ¥šå®¹å™¨ç½‘ç»œæ¥å£åœ¨ç³»ç»Ÿæ¶æ„ä¸­å¤„äºå“ªä¸ªä½ç½®ã€‚</p><p>ä½ å¯ä»¥çœ‹ä¸€ä¸‹æˆ‘ç»™ä½ ç”»çš„è¿™å¼ å›¾ï¼Œå›¾é‡Œå±•ç¤ºçš„æ˜¯å®¹å™¨æœ‰è‡ªå·±çš„Network Namespaceï¼Œeth0 æ˜¯è¿™ä¸ªNetwork Namespaceé‡Œçš„ç½‘ç»œæ¥å£ã€‚è€Œå®¿ä¸»æœºä¸Šä¹Ÿæœ‰è‡ªå·±çš„eth0ï¼Œå®¿ä¸»æœºä¸Šçš„eth0å¯¹åº”ç€çœŸæ­£çš„ç‰©ç†ç½‘å¡ï¼Œå¯ä»¥å’Œå¤–é¢é€šè®¯ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/68/98/6848619c9d4db810560fe1a712fb2d98.jpeg?wh=1920*1408" alt=""></p><p>é‚£ä½ å¯ä»¥å…ˆæƒ³æƒ³ï¼Œæˆ‘ä»¬è¦è®©å®¹å™¨Network Namespaceä¸­çš„æ•°æ®åŒ…æœ€ç»ˆå‘é€åˆ°ç‰©ç†ç½‘å¡ä¸Šï¼Œéœ€è¦å®Œæˆå“ªäº›æ­¥éª¤å‘¢ï¼Ÿä»å›¾ä¸Šçœ‹ï¼Œæˆ‘ä»¬å¤§è‡´å¯ä»¥çŸ¥é“åº”è¯¥åŒ…æ‹¬è¿™ä¸¤æ­¥ã€‚</p><p><strong>ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯è¦è®©æ•°æ®åŒ…ä»å®¹å™¨çš„Network Namespaceå‘é€åˆ°Host Network Namespaceä¸Šã€‚</strong></p><p><strong>ç¬¬äºŒæ­¥ï¼Œæ•°æ®åŒ…å‘åˆ°äº†Host Network Namespaceä¹‹åï¼Œè¿˜è¦è§£å†³æ•°æ®åŒ…æ€ä¹ˆä»å®¿ä¸»æœºä¸Šçš„eth0å‘é€å‡ºå»çš„é—®é¢˜ã€‚</strong></p><p>å¥½ï¼Œæ•´ä½“çš„æ€è·¯å·²ç»ç†æ¸…æ¥šäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åšå…·ä½“åˆ†æã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€æ­¥ï¼Œæ€ä¹ˆè®©æ•°æ®åŒ…ä»å®¹å™¨çš„Network Namespaceå‘é€åˆ°Host Network Namespaceä¸Šé¢ã€‚</p><p>ä½ å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹<a href="https://docs.docker.com/network/">Docker ç½‘ç»œçš„æ–‡æ¡£</a>æˆ–è€…<a href="https://kubernetes.io/docs/concepts/cluster-administration/networking/">Kubernetesç½‘ç»œçš„æ–‡æ¡£</a>ï¼Œè¿™äº›æ–‡æ¡£é‡Œé¢ä»‹ç»äº†å¾ˆå¤šç§å®¹å™¨ç½‘ç»œé…ç½®çš„æ–¹å¼ã€‚</p><p>ä¸è¿‡å¯¹äºå®¹å™¨ä»è‡ªå·±çš„Network Namespaceè¿æ¥åˆ°Host Network Namespaceçš„æ–¹æ³•ï¼Œä¸€èˆ¬æ¥è¯´å°±åªæœ‰ä¸¤ç±»è®¾å¤‡æ¥å£ï¼šä¸€ç±»æ˜¯<a href="https://man7.org/linux/man-pages/man4/veth.4.html">veth</a>ï¼Œå¦å¤–ä¸€ç±»æ˜¯macvlan/ipvlanã€‚</p><p>åœ¨è¿™äº›æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æœ€å¤šçš„å°±æ˜¯vethçš„æ–¹å¼ï¼Œç”¨Dockerå¯åŠ¨çš„å®¹å™¨ç¼ºçœçš„ç½‘ç»œæ¥å£ç”¨çš„ä¹Ÿæ˜¯è¿™ä¸ªvethã€‚æ—¢ç„¶å®ƒè¿™ä¹ˆå¸¸è§ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ç”¨vethä½œä¸ºä¾‹å­æ¥è¯¦ç»†è®²è§£ã€‚è‡³äºå¦å¤–ä¸€ç±»macvlan/ipvlançš„æ–¹å¼ï¼Œæˆ‘ä»¬åœ¨ä¸‹ä¸€è®²é‡Œä¼šè®²åˆ°ã€‚</p><p>é‚£ä»€ä¹ˆæ˜¯vethå‘¢ï¼Ÿä¸ºäº†æ–¹ä¾¿ä½ æ›´å¥½åœ°ç†è§£ï¼Œæˆ‘ä»¬å…ˆæ¥æ¨¡æ‹Ÿä¸€ä¸‹Dockerä¸ºå®¹å™¨å»ºç«‹eth0ç½‘ç»œæ¥å£çš„è¿‡ç¨‹ï¼ŒåŠ¨æ‰‹æ“ä½œä¸€ä¸‹ï¼Œè¿™æ ·å‘¢ï¼Œä½ å°±å¯ä»¥å¾ˆå¿«æ˜ç™½ä»€ä¹ˆæ˜¯vethäº†ã€‚</p><p>å¯¹äºè¿™ä¸ªæ¨¡æ‹Ÿæ“ä½œå‘¢ï¼Œæˆ‘ä»¬ä¸»è¦ç”¨åˆ°çš„æ˜¯<a href="https://man7.org/linux/man-pages/man8/ip-netns.8.html">ip netns</a> è¿™ä¸ªå‘½ä»¤ï¼Œé€šè¿‡å®ƒæ¥å¯¹Network Namespaceåšæ“ä½œã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆå¯åŠ¨ä¸€ä¸ªä¸å¸¦ç½‘ç»œé…ç½®çš„å®¹å™¨ï¼Œå’Œæˆ‘ä»¬ä¹‹å‰çš„å‘½ä»¤æ¯”è¾ƒï¼Œä¸»è¦æ˜¯å¤šåŠ ä¸Šäº†"--network none"å‚æ•°ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ ·åœ¨å¯åŠ¨çš„å®¹å™¨ä¸­ï¼ŒNetwork Namespaceé‡Œå°±åªæœ‰loopbackä¸€ä¸ªç½‘ç»œè®¾å¤‡ï¼Œè€Œæ²¡æœ‰äº†eth0ç½‘ç»œè®¾å¤‡äº†ã€‚</p><pre><code class="language-shell"># docker run -d --name if-test --network none centos:8.1.1911 sleep 36000
cf3d3105b11512658a025f5b401a09c888ed3495205f31e0a0d78a2036729472
# docker exec -it if-test ip addr
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
</code></pre><p>å®Œæˆåˆšæ‰çš„è®¾ç½®ä»¥åï¼Œæˆ‘ä»¬å°±åœ¨è¿™ä¸ªå®¹å™¨çš„Network Namespaceé‡Œå»ºç«‹vethï¼Œä½ å¯ä»¥æ‰§è¡Œä¸€ä¸‹åé¢çš„è¿™ä¸ªè„šæœ¬ã€‚</p><pre><code class="language-shell">pid=$(ps -ef | grep "sleep 36000" | grep -v grep | awk '{print $2}')
echo $pid
ln -s /proc/$pid/ns/net /var/run/netns/$pid
 
# Create a pair of veth interfaces
ip link add name veth_host type veth peer name veth_container
# Put one of them in the new net ns
ip link set veth_container netns $pid
 
# In the container, setup veth_container
ip netns exec $pid ip link set veth_container name eth0
ip netns exec $pid ip addr add 172.17.1.2/16 dev eth0
ip netns exec $pid ip link set eth0 up
ip netns exec $pid ip route add default via 172.17.0.1
 
# In the host, set veth_host up
ip link set veth_host up
</code></pre><p>æˆ‘åœ¨è¿™é‡Œè§£é‡Šä¸€ä¸‹ï¼Œè¿™ä¸ªvethçš„å»ºç«‹è¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ã€‚</p><p>é¦–å…ˆå‘¢ï¼Œæˆ‘ä»¬å…ˆæ‰¾åˆ°è¿™ä¸ªå®¹å™¨é‡Œè¿è¡Œçš„è¿›ç¨‹"sleep 36000"çš„pidï¼Œé€šè¿‡ "/proc/$pid/ns/net"è¿™ä¸ªæ–‡ä»¶å¾—åˆ°Network Namespaceçš„IDï¼Œè¿™ä¸ªNetwork Namespace IDæ—¢æ˜¯è¿™ä¸ªè¿›ç¨‹çš„ï¼Œä¹ŸåŒæ—¶å±äºè¿™ä¸ªå®¹å™¨ã€‚</p><p>ç„¶åæˆ‘ä»¬åœ¨"/var/run/netns/"çš„ç›®å½•ä¸‹å»ºç«‹ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘è¿™ä¸ªå®¹å™¨çš„Network Namespaceã€‚å®Œæˆè¿™æ­¥æ“ä½œä¹‹åï¼Œåœ¨åé¢çš„"ip netns"æ“ä½œé‡Œï¼Œå°±å¯ä»¥ç”¨pidçš„å€¼ä½œä¸ºè¿™ä¸ªå®¹å™¨çš„Network Namesapceçš„æ ‡è¯†äº†ã€‚</p><p>æ¥ä¸‹æ¥å‘¢ï¼Œæˆ‘ä»¬ç”¨ <code>ip link</code> å‘½ä»¤æ¥å»ºç«‹ä¸€å¯¹vethçš„è™šæ‹Ÿè®¾å¤‡æ¥å£ï¼Œåˆ†åˆ«æ˜¯veth_containerå’Œveth_hostã€‚ä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œveth_containerè¿™ä¸ªæ¥å£ä¼šè¢«æ”¾åœ¨å®¹å™¨Network Namespaceé‡Œï¼Œè€Œveth_hostä¼šæ”¾åœ¨å®¿ä¸»æœºçš„Host Network Namespaceã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åé¢çš„å‘½ä»¤ä¹Ÿå¾ˆå¥½ç†è§£äº†ï¼Œå°±æ˜¯ç”¨ <code>ip link set veth_container netns $pid</code> æŠŠveth_containerè¿™ä¸ªæ¥å£æ”¾å…¥åˆ°å®¹å™¨çš„Network Namespaceä¸­ã€‚</p><p>å†ç„¶åæˆ‘ä»¬è¦æŠŠveth_containeré‡æ–°å‘½åä¸ºeth0ï¼Œå› ä¸ºè¿™æ—¶å€™æ¥å£å·²ç»åœ¨å®¹å™¨çš„Network Namesapceé‡Œäº†ï¼Œeth0å°±ä¸ä¼šå’Œå®¿ä¸»æœºä¸Šçš„eth0å†²çªäº†ã€‚</p><p>æœ€åå¯¹å®¹å™¨å†…çš„eht0ï¼Œæˆ‘ä»¬è¿˜è¦åšåŸºæœ¬çš„ç½‘ç»œIPå’Œç¼ºçœè·¯ç”±é…ç½®ã€‚å› ä¸ºveth_hostå·²ç»åœ¨å®¿ä¸»æœºçš„Host Network Namespaceäº†ï¼Œå°±ä¸éœ€è¦æˆ‘ä»¬åšä»€ä¹ˆäº†ï¼Œè¿™æ—¶æˆ‘ä»¬åªéœ€è¦upä¸€ä¸‹è¿™ä¸ªæ¥å£å°±å¯ä»¥äº†ã€‚</p><p>é‚£åˆšæ‰è¿™äº›æ“ä½œå®Œæˆä»¥åï¼Œæˆ‘ä»¬å°±å»ºç«‹äº†ä¸€å¯¹vethè™šæ‹Ÿè®¾å¤‡æ¥å£ã€‚æˆ‘ç»™ä½ ç”»äº†ä¸€å¼ ç¤ºæ„å›¾ï¼Œå›¾é‡Œç›´è§‚å±•ç¤ºäº†è¿™å¯¹æ¥å£åœ¨å®¹å™¨å’Œå®¿ä¸»æœºä¸Šçš„ä½ç½®ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/56/89/569287c365c99d3778858b7bc42b5989.jpeg?wh=1920*1339" alt=""></p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹vethçš„å®šä¹‰äº†ï¼Œå…¶å®å®ƒä¹Ÿå¾ˆç®€å•ã€‚vethå°±æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„ç½‘ç»œè®¾å¤‡ï¼Œä¸€èˆ¬éƒ½æ˜¯æˆå¯¹åˆ›å»ºï¼Œè€Œä¸”è¿™å¯¹è®¾å¤‡æ˜¯ç›¸äº’è¿æ¥çš„ã€‚å½“æ¯ä¸ªè®¾å¤‡åœ¨ä¸åŒçš„Network Namespacesçš„æ—¶å€™ï¼ŒNamespaceä¹‹é—´å°±å¯ä»¥ç”¨è¿™å¯¹vethè®¾å¤‡æ¥è¿›è¡Œç½‘ç»œé€šè®¯äº†ã€‚</p><p>æ¯”å¦‚è¯´ï¼Œä½ å¯ä»¥æ‰§è¡Œä¸‹é¢çš„è¿™æ®µä»£ç ï¼Œè¯•è¯•åœ¨veth_hostä¸ŠåŠ ä¸Šä¸€ä¸ªIPï¼Œ172.17.1.1/16ï¼Œç„¶åä»å®¹å™¨é‡Œå°±å¯ä»¥pingé€šè¿™ä¸ªIPäº†ã€‚è¿™ä¹Ÿè¯æ˜äº†ä»å®¹å™¨åˆ°å®¿ä¸»æœºå¯ä»¥åˆ©ç”¨è¿™å¯¹vethæ¥å£æ¥é€šè®¯äº†ã€‚</p><pre><code class="language-shell"># ip addr add 172.17.1.1/16 dev veth_host
# docker exec -it if-test ping 172.17.1.1
PING 172.17.1.1 (172.17.1.1) 56(84) bytes of data.
64 bytes from 172.17.1.1: icmp_seq=1 ttl=64 time=0.073 ms
64 bytes from 172.17.1.1: icmp_seq=2 ttl=64 time=0.092 ms
^C
--- 172.17.1.1 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 30ms
rtt min/avg/max/mdev = 0.073/0.082/0.092/0.013 ms
</code></pre><p>å¥½äº†ï¼Œè¿™æ ·æˆ‘ä»¬å®Œæˆäº†ç¬¬ä¸€æ­¥ï¼Œé€šè¿‡ä¸€å¯¹vethè™šæ‹Ÿè®¾å¤‡ï¼Œå¯ä»¥è®©æ•°æ®åŒ…ä»å®¹å™¨çš„ Network Namespaceå‘é€åˆ°Host Network Namespaceä¸Šã€‚</p><p>é‚£ä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹ç¬¬äºŒæ­¥ï¼Œ æ•°æ®åŒ…åˆ°äº†Host Network Namespaceä¹‹åå‘¢ï¼Œæ€ä¹ˆæŠŠå®ƒä»å®¿ä¸»æœºä¸Šçš„eth0å‘é€å‡ºå»?</p><p>å…¶å®è¿™ä¸€æ­¥å‘¢ï¼Œå°±æ˜¯ä¸€ä¸ªæ™®é€šLinuxèŠ‚ç‚¹ä¸Šæ•°æ®åŒ…è½¬å‘çš„é—®é¢˜äº†ã€‚è¿™é‡Œæˆ‘ä»¬è§£å†³é—®é¢˜çš„æ–¹æ³•æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚è¯´ç”¨natæ¥åšä¸ªè½¬å‘ï¼Œæˆ–è€…å»ºç«‹Overlayç½‘ç»œå‘é€ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®proxy arpåŠ è·¯ç”±çš„æ–¹æ³•æ¥å®ç°ã€‚</p><p>å› ä¸ºè€ƒè™‘åˆ°ç½‘ç»œç¯å¢ƒçš„é…ç½®ï¼ŒåŒæ—¶Dockerç¼ºçœä½¿ç”¨çš„æ˜¯ <strong>bridge + nat</strong>çš„è½¬å‘æ–¹å¼ï¼Œ é‚£æˆ‘ä»¬å°±åœ¨åˆšæ‰è®²çš„ç¬¬ä¸€æ­¥åŸºç¡€ä¸Šï¼Œå†æ‰‹åŠ¨å®ç°ä¸€ä¸‹bridge+natçš„è½¬å‘æ–¹å¼ã€‚å¯¹äºå…¶ä»–çš„é…ç½®æ–¹æ³•ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹Dockeræˆ–è€…Kubernetesç›¸å…³çš„æ–‡æ¡£ã€‚</p><p>Dockerç¨‹åºåœ¨èŠ‚ç‚¹ä¸Šå®‰è£…å®Œä¹‹åï¼Œå°±ä¼šè‡ªåŠ¨å»ºç«‹äº†ä¸€ä¸ªdocker0çš„bridge interfaceã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æŠŠç¬¬ä¸€æ­¥ä¸­å»ºç«‹çš„veth_hostè¿™ä¸ªè®¾å¤‡ï¼Œæ¥å…¥åˆ°docker0è¿™ä¸ªbridgeä¸Šã€‚</p><p>è¿™é‡Œæˆ‘è¦æé†’ä½ æ³¨æ„ä¸€ä¸‹ï¼Œå¦‚æœä¹‹å‰ä½ åœ¨veth_hostä¸Šè®¾ç½®äº†IPçš„ï¼Œå°±éœ€å…ˆè¿è¡Œä¸€ä¸‹"ip addr delete 172.17.1.1/16 dev veth_host"ï¼ŒæŠŠIPä»veth_hostä¸Šåˆ é™¤ã€‚</p><pre><code># ip addr delete 172.17.1.1/16 dev veth_host 
ip link set veth_host master docker0
</code></pre><p>è¿™ä¸ªå‘½ä»¤æ‰§è¡Œå®Œä¹‹åï¼Œå®¹å™¨å’Œå®¿ä¸»æœºçš„ç½‘ç»œé…ç½®å°±ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™ç§é…ç½®æ˜¯ä»€ä¹ˆæ ·å‘¢ï¼Ÿä½ å¯ä»¥å‚è€ƒä¸€ä¸‹é¢è¿™å¼ å›¾çš„æè¿°ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/a0/69/a006f0707d02d38917983523c9356869.jpeg?wh=1920*1331" alt=""></p><p>ä»è¿™å¼ ç¤ºæ„å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œå®¹å™¨å’Œdocker0ç»„æˆäº†ä¸€ä¸ªå­ç½‘ï¼Œdocker0ä¸Šçš„IPå°±æ˜¯è¿™ä¸ªå­ç½‘çš„ç½‘å…³IPã€‚</p><p>å¦‚æœæˆ‘ä»¬è¦è®©å­ç½‘é€šè¿‡å®¿ä¸»æœºä¸Šeth0å»è®¿é—®å¤–ç½‘çš„è¯ï¼Œé‚£ä¹ˆåŠ ä¸Šiptablesçš„è§„åˆ™å°±å¯ä»¥äº†ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢è¿™æ¡è§„åˆ™ã€‚</p><pre><code>iptables -P FORWARD ACCEPT
</code></pre><p>å¥½äº†ï¼Œè¿›è¡Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡bridge+natçš„é…ç½®ï¼Œä¼¼ä¹å·²ç»å®Œæˆäº†ç¬¬äºŒæ­¥â€”â€”è®©æ•°æ®ä»å®¿ä¸»æœºçš„eth0å‘é€å‡ºå»ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬è¿™æ ·é…ç½®ï¼ŒçœŸçš„å¯ä»¥è®©å®¹å™¨é‡Œå‘é€æ•°æ®åŒ…åˆ°å¤–ç½‘äº†å—ï¼Ÿè¿™éœ€è¦æˆ‘ä»¬åšä¸ªæµ‹è¯•ï¼Œå†é‡æ–°å°è¯•ä¸‹è¿™ä¸€è®²å¼€å§‹çš„æ“ä½œï¼Œä»å®¹å™¨é‡Œpingå¤–ç½‘çš„IPï¼Œè¿™æ—¶å€™ï¼Œä½ ä¼šå‘ç°è¿˜æ˜¯pingä¸é€šã€‚</p><p>å…¶å®å‘¢ï¼Œåšåˆ°è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬é€šè¿‡è‡ªå·±çš„é€æ­¥æ“ä½œå‘¢ï¼Œé‡ç°äº†è¿™ä¸€è®²äº†æœ€å¼€å§‹çš„é—®é¢˜ã€‚</p><h2>è§£å†³é—®é¢˜</h2><p>æ—¢ç„¶ç°åœ¨æˆ‘ä»¬æ¸…æ¥šäº†ï¼Œåœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šå®¹å™¨å’Œå®¿ä¸»æœºä¸Šçš„ç½‘ç»œé…ç½®æ˜¯æ€ä¹ˆä¸€å›äº‹ã€‚é‚£ä¹ˆè¦è°ƒè¯•è¿™ä¸ªé—®é¢˜å‘¢ï¼Œä¹Ÿæœ‰äº†æ€è·¯ï¼Œå…³é”®å°±æ˜¯æ‰¾åˆ°æ•°æ®åŒ…ä¼ åˆ°å“ªä¸ªç¯èŠ‚æ—¶å‘ç”Ÿäº†ä¸­æ–­ã€‚</p><p>é‚£æœ€ç›´æ¥çš„æ–¹æ³•å‘¢ï¼Œå°±æ˜¯åœ¨å®¹å™¨ä¸­ç»§ç»­pingå¤–ç½‘çš„IP 39.106.233.176ï¼Œç„¶ååœ¨å®¹å™¨çš„eth0 (veth_container)ï¼Œå®¹å™¨å¤–çš„veth_hostï¼Œdocker0ï¼Œå®¿ä¸»æœºçš„eth0è¿™ä¸€æ¡æ•°æ®åŒ…çš„è·¯å¾„ä¸Šè¿è¡Œtcpdumpã€‚</p><p>è¿™æ ·å°±å¯ä»¥æŸ¥åˆ°ï¼Œåˆ°åº•åœ¨å“ªä¸ªè®¾å¤‡æ¥å£ä¸Šæ²¡æœ‰æ”¶åˆ°pingçš„icmpåŒ…ã€‚æˆ‘æŠŠtcpdumpè¿è¡Œçš„ç»“æœæˆ‘åˆ—åˆ°äº†ä¸‹é¢ã€‚</p><p>å®¹å™¨çš„eth0ï¼š</p><pre><code class="language-shell"># ip netns exec $pid tcpdump -i eth0 host 39.106.233.176 -nn
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
00:47:29.934294 IP 172.17.1.2 &gt; 39.106.233.176: ICMP echo request, id 71, seq 1, length 64
00:47:30.934766 IP 172.17.1.2 &gt; 39.106.233.176: ICMP echo request, id 71, seq 2, length 64
00:47:31.958875 IP 172.17.1.2 &gt; 39.106.233.176: ICMP echo request, id 71, seq 3, length 64
</code></pre><p>veth_hostï¼š</p><pre><code class="language-shell"># tcpdump -i veth_host host 39.106.233.176 -nn
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on veth_host, link-type EN10MB (Ethernet), capture size 262144 bytes
00:48:01.654720 IP 172.17.1.2 &gt; 39.106.233.176: ICMP echo request, id 71, seq 32, length 64
00:48:02.678752 IP 172.17.1.2 &gt; 39.106.233.176: ICMP echo request, id 71, seq 33, length 64
00:48:03.702827 IP 172.17.1.2 &gt; 39.106.233.176: ICMP echo request, id 71, seq 34, length 64
</code></pre><p>docker0ï¼š</p><pre><code class="language-shell"># tcpdump -i docker0 host 39.106.233.176 -nn
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on docker0, link-type EN10MB (Ethernet), capture size 262144 bytes
00:48:20.086841 IP 172.17.1.2 &gt; 39.106.233.176: ICMP echo request, id 71, seq 50, length 64
00:48:21.110765 IP 172.17.1.2 &gt; 39.106.233.176: ICMP echo request, id 71, seq 51, length 64
00:48:22.134839 IP 172.17.1.2 &gt; 39.106.233.176: ICMP echo request, id 71, seq 52, length 64
</code></pre><p>host eth0ï¼š</p><pre><code class="language-shell"># tcpdump -i eth0 host 39.106.233.176 -nn
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
^C
0 packets captured
0 packets received by filter
0 packets dropped by kernel
</code></pre><p>é€šè¿‡ä¸Šé¢çš„è¾“å‡ºç»“æœï¼Œæˆ‘ä»¬å‘ç°icmpåŒ…åˆ°è¾¾äº†docker0ï¼Œä½†æ˜¯æ²¡æœ‰åˆ°è¾¾å®¿ä¸»æœºä¸Šçš„eth0ã€‚</p><p>å› ä¸ºæˆ‘ä»¬å·²ç»é…ç½®äº†iptables natçš„è½¬å‘ï¼Œè¿™ä¸ªä¹Ÿå¯ä»¥é€šè¿‡æŸ¥çœ‹iptablesçš„natè¡¨ç¡®è®¤ä¸€ä¸‹ï¼Œæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå…·ä½“çš„æ“ä½œå‘½ä»¤å¦‚ä¸‹ï¼š</p><pre><code class="language-shell"># iptables -L  -t nat
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination
DOCKER     all  --  anywhere             anywhere             ADDRTYPE match dst-type LOCAL
 
Chain INPUT (policy ACCEPT)
target     prot opt source               destination
 
Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination
MASQUERADE  all  --  172.17.0.0/16        anywhere
 
Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination
DOCKER     all  --  anywhere            !127.0.0.0/8          ADDRTYPE match dst-type LOCAL
 
Chain DOCKER (2 references)
target     prot opt source               destination
RETURN     all  --  anywhere             anywhere
</code></pre><p>é‚£ä¹ˆä¼šæ˜¯ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå› ä¸ºè¿™é‡Œéœ€è¦åšä¸¤ä¸ªç½‘ç»œè®¾å¤‡æ¥å£ä¹‹é—´çš„æ•°æ®åŒ…è½¬å‘ï¼Œä¹Ÿå°±æ˜¯ä»docker0æŠŠæ•°æ®åŒ…è½¬å‘åˆ°eth0ä¸Šï¼Œä½ å¯èƒ½æƒ³åˆ°äº†Linuxåè®®æ ˆé‡Œçš„ä¸€ä¸ªå¸¸ç”¨å‚æ•°ip_forwardã€‚</p><p>æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ï¼Œå®ƒçš„å€¼æ˜¯0ï¼Œå½“æˆ‘ä»¬æŠŠå®ƒæ”¹æˆ1ä¹‹åï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä»å®¹å™¨ä¸­pingé€šå¤–ç½‘39.106.233.176è¿™ä¸ªIPäº†ï¼</p><pre><code class="language-shell"># cat /proc/sys/net/ipv4/ip_forward
0
# echo 1 &gt; /proc/sys/net/ipv4/ip_forward
 
# docker exec -it if-test ping 39.106.233.176
PING 39.106.233.176 (39.106.233.176) 56(84) bytes of data.
64 bytes from 39.106.233.176: icmp_seq=1 ttl=77 time=359 ms
64 bytes from 39.106.233.176: icmp_seq=2 ttl=77 time=346 ms
^C
--- 39.106.233.176 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1ms
rtt min/avg/max/mdev = 345.889/352.482/359.075/6.593 ms
</code></pre><h2>é‡ç‚¹å°ç»“</h2><p>è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä¸»è¦è§£å†³çš„é—®é¢˜æ˜¯å¦‚ä½•ç»™å®¹å™¨é…ç½®ç½‘ç»œæ¥å£ï¼Œè®©å®¹å™¨å¯ä»¥å’Œå¤–é¢é€šè®¯ï¼›åŒæ—¶æˆ‘ä»¬è¿˜å­¦ä¹ äº†å½“å®¹å™¨ç½‘ç»œä¸é€šçš„æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆæ¥åšä¸€ä¸ªç®€å•è°ƒè¯•ã€‚</p><p>è§£å†³å®¹å™¨ä¸å¤–ç•Œé€šè®¯çš„é—®é¢˜å‘¢ï¼Œä¸€å…±éœ€è¦å®Œæˆä¸¤æ­¥ã€‚ç¬¬ä¸€æ­¥æ˜¯ï¼Œæ€ä¹ˆè®©æ•°æ®åŒ…ä»å®¹å™¨çš„Network Namespaceå‘é€åˆ°Host Network Namespaceä¸Šï¼›ç¬¬äºŒæ­¥ï¼Œæ•°æ®åŒ…åˆ°äº†Host Network Namespaceä¹‹åï¼Œè¿˜éœ€è¦è®©å®ƒå¯ä»¥ä»å®¿ä¸»æœºçš„eth0å‘é€å‡ºå»ã€‚</p><p>æˆ‘ä»¬æƒ³è®©æ•°æ®ä»å®¹å™¨Netowrk Namespaceå‘é€åˆ°Host Network Namespaceï¼Œå¯ä»¥ç”¨é…ç½®ä¸€å¯¹vethè™šæ‹Ÿç½‘ç»œè®¾å¤‡çš„æ–¹æ³•å®ç°ã€‚è€Œè®©æ•°æ®åŒ…ä»å®¿ä¸»æœºçš„eth0å‘é€å‡ºå»ï¼Œå°±ç”¨å¯bridge+natçš„æ–¹å¼å®Œæˆã€‚</p><p>è¿™é‡Œæˆ‘è®²çš„æ˜¯æœ€åŸºæœ¬çš„ä¸€ç§é…ç½®ï¼Œä½†å®ƒä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„ä¸€ä¸ªç½‘ç»œé…ç½®ã€‚é’ˆå¯¹å…¶ä»–ä¸åŒéœ€è¦ï¼Œå®¹å™¨ç½‘ç»œè¿˜æœ‰å¾ˆå¤šç§ã€‚é‚£ä½ å­¦ä¹ å®Œè¿™ä¸€è®²ï¼Œäº†è§£äº†åŸºæœ¬çš„æ¦‚å¿µå’Œæ“ä½œä¹‹åå‘¢ï¼Œè¿˜å¯ä»¥æŸ¥çœ‹æ›´å¤šçš„ç½‘ä¸Šèµ„æ–™ï¼Œå­¦ä¹ ä¸åŒçš„ç½‘ç»œé…ç½®ã€‚</p><p>é‡åˆ°å®¹å™¨ä¸­ç½‘ç»œä¸é€šçš„æƒ…å†µï¼Œæˆ‘ä»¬å…ˆè¦ç†è§£è‡ªå·±çš„å®¹å™¨ä»¥åŠå®¹å™¨åœ¨å®¿ä¸»æœºä¸Šçš„é…ç½®ï¼Œé€šè¿‡å¯¹ä¸»è¦è®¾å¤‡ä¸Šåštcpdumpå¯ä»¥æ‰¾åˆ°å…·ä½“åœ¨å“ªä¸€æ­¥æ•°æ®åŒ…åœæ­¢äº†è½¬å‘ã€‚</p><p>ç„¶åæˆ‘ä»¬ç»“åˆå†…æ ¸ç½‘ç»œé…ç½®å‚æ•°ï¼Œè·¯ç”±è¡¨ä¿¡æ¯ï¼Œé˜²ç«å¢™è§„åˆ™ï¼Œä¸€èˆ¬éƒ½å¯ä»¥å®šä½å‡ºæ ¹æœ¬åŸå› ï¼Œæœ€ç»ˆè§£å†³è¿™ç§ç½‘ç»œå®Œå…¨ä¸é€šçš„é—®é¢˜ã€‚</p><p>ä½†æ˜¯å¦‚æœæ˜¯ç½‘ç»œå¶å°”ä¸¢åŒ…çš„é—®é¢˜ï¼Œè¿™ä¸ªå°±éœ€è¦ç”¨åˆ°å…¶ä»–çš„ä¸€äº›å·¥å…·æ¥åšåˆ†æäº†ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¼šåœ¨ä¹‹åçš„ç« èŠ‚åšè®²è§£ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æˆ‘ä»¬è¿™ä¸€è®²çš„ä¾‹å­å‘¢ï¼Œå®ç°äº†ä»å®¹å™¨è®¿é—®å¤–é¢çš„IPã€‚é‚£ä¹ˆå¦‚æœè¦å®ç°èŠ‚ç‚¹å¤–çš„ç¨‹åºæ¥è®¿é—®å®¹å™¨çš„IPï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆé…ç½®ç½‘ç»œå‘¢ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒå’Œé—®é¢˜ã€‚å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¯å‘ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œä¸€èµ·å­¦ä¹ è¿›æ­¥ã€‚</p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/1b/90/9c/288e4db2.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>è‰¯å‡¯å°”</span>
  </div>
  <div class="_2_QraFYR_0">å®ç°èŠ‚ç‚¹å¤–çš„ç¨‹åºæ¥è®¿é—®å®¹å™¨ï¼š<br><br>iptables -t nat -A PREROUTING -d ã€å®¿ä¸»æœºipã€‘ -p tcp -m tcp --dport ã€å®¿ä¸»æœºæ˜ å°„ç«¯å£ã€‘ -j DNAT --to-destination ã€å®¹å™¨ipã€‘:ã€å®¹å™¨ç«¯å£ã€‘<br><br>åˆ©ç”¨DNATï¼Œè®¿é—®å®¿ä¸»æœºip+å®¿ä¸»æœºæ˜ å°„ç«¯å£ï¼Œå³å¯è®¿é—®å®¹å™¨<br></div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-12-21 08:43:48</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æˆ‘æ¥ä¹Ÿ</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆä¸€è·¯tcpdumpçš„æ“ä½œå¾ˆçŠ€åˆ©ï¼Œç‰¹åˆ«æ˜¯æŠ“å®¹å™¨ä¸­çš„æ•°æ®åŒ…çš„é‚£ä¸ªæ“ä½œï¼š<br><br>  ip netns exec $pid tcpdump -i eth0 host 39.106.233.176 -nn<br><br>ä»¥å‰ä¸ºäº†åœ¨å®¹å™¨ä¸­æŠ“åŒ…ï¼Œè¿˜è¦åœ¨å®¹å™¨ä¸­å®‰è£…tcpdumpï¼Œä»å›½å¤–çš„æºæ‹‰æ•°æ®åˆæ…¢ï¼Œå³ä½¿æ¢äº†å›½å†…çš„æºï¼Œä½†æ¯æ¬¡é‡å»ºå®¹å™¨ååˆå¾—å†æ¥ä¸€æ¬¡ã€‚<br>æçš„æˆ‘ä¸“é—¨å‡†å¤‡äº†ä¸€ä¸ªè°ƒè¯•ç”¨çš„åŸºç¡€å®¹å™¨ï¼ŒæŠŠå„ç§å¸¸ç”¨çš„å·¥å…·éƒ½ç»™è£…ä¸Šï¼ŒåŒ…æ‹¬æˆ‘çš„vimã€‚ğŸ˜„</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: @æˆ‘æ¥ä¹Ÿ<br>æŠŠè°ƒè¯•å·¥å…·éƒ½æ”¾åˆ°ä¸€ä¸ªåŸºç¡€å®¹å™¨ä¸­ä¹ŸæŒºå¥½çš„ã€‚<br></p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-01-05 00:00:24</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/14/64/08/0287f41f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>äº‰å…‰ Alan</span>
  </div>
  <div class="_2_QraFYR_0">ä½ å¥½ï¼Œè€å¸ˆï¼Œæˆ‘ç½‘ç»œæ¯”è¾ƒå¼±ï¼Œçœ‹äº†æ–‡ç« æœ‰ä¸¤ä¸ªåœ°æ–¹æ²¡çœ‹æ‡‚<br>1.docker0 å’Œvethè¿æ¥ï¼Œæ˜¯å¯ä»¥ç†è§£ä¸ºdocker0æ˜¯ä¸ªäº¤æ¢æœºï¼Œæ‰€æœ‰è¿æ¥docker0çš„ç½‘å¡å¯ä»¥äºŒå±‚é€šä¿¡ï¼Ÿ<br><br>2.ä¸ºä»€ä¹ˆè¿æ¥åˆ°docker0ï¼Œå¼€å¯forwardå°±é€šäº†ï¼Ÿèƒ½è®²ä¸€ä¸‹åŸç†å—ï¼Ÿ æ˜¯åˆ°è¾¾docker0çš„åŒ…ä¼šç»è¿‡postroutingé“¾ï¼Œç„¶åç»è¿‡æœ¬åœ°è·¯ç”±åï¼Œéœ€è¦èµ°forwardé“¾å‡ºå»ï¼Œæ‰€ä»¥éœ€è¦å¼€forwardä¸ºacceptå¹¶ä¸”å¼€å¯forwardå—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: &gt; 1<br>å¯¹çš„ä½ å¯ä»¥ç†è§£ä¸ºdocker0æ˜¯ä¸€ä¸ªL2äº¤æ¢æœºã€‚<br><br>&gt; 2<br>ip_forwardå°±æ˜¯æ‰“å¼€Linuxç±»ä¼¼è·¯ç”±å™¨çš„åŠŸèƒ½ï¼Œå…è®¸æ•°æ®åŒ…ä»ä¸€ä¸ªæ¥å£è¿›å…¥ï¼Œæ ¹æ®è·¯ç”±ä»å¦å¤–ä¸€ä¸ªæ¥å£å‡ºå»ã€‚è¿™ä¸ªå’Œä½ è¯´çš„iptablesé‡Œçš„postrouting&#47;forwardé“¾æ²¡æœ‰å…³ç³»</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-12-27 00:15:28</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/37/3b/495e2ce6.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>é™ˆæ–¯ä½³</span>
  </div>
  <div class="_2_QraFYR_0">è¿™ç¯‡ç½‘ç»œè°ƒè¯•å¤ªç¡¬æ ¸äº†ï¼ï¼ä¸€ç›´è§‰å¾—ï¼Œå®¹å™¨å°±æ˜¯Linuxçš„é«˜çº§çŸ¥è¯†ï¼Œå®¹å™¨é€šäº†ï¼ŒLinuxçš„å†…å®¹ä½ å°±æ‰€å‘æŠ«é¡äº†</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: @é™ˆæ–¯ä½³<br>æ˜¯è¿™æ ·çš„ï¼</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-02-04 17:11:42</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/23/81/60/71ed6ac7.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>è°¢å“ˆå“ˆ</span>
  </div>
  <div class="_2_QraFYR_0">1ï¼Œå®¿ä¸»æœºä¸Šé…ç½®å®¹å™¨ç½‘æ®µçš„è·¯ç”±<br>2ï¼ŒDNATï¼Œåœ¨natè¡¨çš„PREROUTINGé“¾åšå¥½åŒ…ä¼ªè£…åˆ°è¾¾å®¹å™¨</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-12-21 21:06:01</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/4Lprf2mIWpJOPibgibbFCicMtp5bpIibyLFOnyOhnBGbusrLZC0frG0FGWqdcdCkcKunKxqiaOHvXbCFE7zKJ8TmvIA/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_c2089d</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆæœ‰ä¸ªé—®é¢˜æƒ³å’¨è¯¢ä¸€ä¸‹ä½ ï¼Œæˆ‘æœ‰ä¸ªFTPçš„å®¹å™¨ï¼Œftpçš„é…ç½®æ˜¯é…ç½®äº†127.0.0.1åœ°å€ï¼Œè€Œæˆ‘å®¿ä¸»æœºæ˜¯192.168.1.21çš„ipï¼Œæˆ‘è¿æ¥ftpæœåŠ¡çš„æ—¶å€™ç”¨å®¿ä¸»æœºçš„ipå»è¿æ¥ä¼šæœ‰é—®é¢˜ï¼Ÿï¼Ÿï¼Ÿæˆ‘ç°åœ¨æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯è¢«åŠ¨æ¨¡å¼è¿æ¥ä¸Šå»ä½†LISTå‘½ä»¤æ•°æ®æ²¡è¿”å›ï¼Œä½†æ˜¯ä¸»åŠ¨æ¨¡å¼å¯ä»¥ï¼Œæƒ³é—®ä¸‹å’Œä¸Šé¢é…ç½®æœ‰å…³ç³»ï¼Ÿï¼Ÿå¦‚æœæ²¡å…³ç³»æˆ‘ä¸Šé¢çš„é…ç½®ä¼šå¼•èµ·ä»€ä¹ˆé—®é¢˜ï¼Ÿï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: 127.0.0.1 æ˜¯ localhost IP, æ¯ä¸ªnamespaceé‡Œéƒ½æœ‰ä¸€ä¸ªã€‚å¦‚æœä»å®¿ä¸»æœºçš„host network namespaceé‡Œå»è®¿é—®127.0.0.1åªæ˜¯ host network namespaceé‡Œçš„ï¼Œä¸ä¼šè®¿é—®åˆ°å®¹å™¨ network namespaceçš„127.0.0.1</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-03-09 17:27:29</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKzqiaZnBw2myRWY802u48Rw3W2zDtKoFQ6vN63m4FdyjibM21FfaOYe8MbMpemUdxXJeQH6fRdVbZA/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>kissingers</span>
  </div>
  <div class="_2_QraFYR_0">å¦‚æœeth0 ä¹ŸåŠ åˆ°docker0 bridgeï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™æ˜¯é€šè¿‡äºŒå±‚è½¬å‘æˆ–è€…æ´ªæ³›çš„æ–¹å¼è¿é€šå¤–ç½‘ã€‚å¦‚æœeth0ä¸åŠ åˆ°docker0çš„è¯é‚£ä¹ˆåˆ©ç”¨çš„æ˜¯host çš„è·¯ç”±è½¬å‘äº†ã€‚è¿™æ ·ç†è§£å¯¹å—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-06-20 17:24:40</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqzh2c5OGpQSPx4SNC9L7q2bgnncjlPfUXk48FuE8ud7LzkH4fhrPw0ENwueqh7UkuU8DibhoCz5iaw/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>moonberry</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆæ‚¨å¥½ï¼Œè¯·é—®iptables åˆ—å‡ºçš„NATè¡¨æ˜¯dockeré»˜è®¤é…ç½®çš„å—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: éœ€è¦è‡ªå·±åŠ ä¸€æ¡ â€œiptables -P FORWARD ACCEPTâ€ï¼Œ å…¶å®ƒçš„æ˜¯é»˜è®¤çš„é…ç½®ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-03-01 17:12:24</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src=""
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_ba556d</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œèƒ½å¸®å¿™è§£å†³ä¸€ä¸‹ï¼Œæˆ‘åœ¨ä¸¤å°vmwareworkè™šæ‹Ÿæœºå®‰è£…centos7.6ï¼Œåˆ†åˆ«åˆ›å»ºç‰©ç†ç½‘å¡å­æ¥å£ï¼Œå¹¶å…³è”äº†macvlanï¼Œä½†æ˜¯ARPä¼ è¾“ä¸€ç›´å‡ºé—®é¢˜ï¼Œç»‘å®šé™æ€å°±å¯ä»¥pingé€šï¼Œä¸çŸ¥æ˜¯ä»€ä¹ˆåŸå› ï¼Œèƒ½å¸®å¿™è§£ç­”ä¸€ä¸‹å—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: @Geek_ba556d<br>ä¸å¥½æ„æ€ï¼Œè¿™ä¸ªéœ€è¦çœ‹åˆ°ç°åœºç¯å¢ƒæ‰èƒ½è¿›ä¸€æ­¥åˆ†æã€‚ä¸è¿‡ï¼Œä½ è¯´arpå‡ºé—®é¢˜ï¼Œé‚£ä¹ˆå¯ä»¥å…ˆåœ¨ä¸»è¦æ¥å£dumpä¸€ä¸‹arp request æˆ–è€… arp replyçš„åŒ…ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-01-04 07:24:28</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/c4/03/f753fda7.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>JianXu</span>
  </div>
  <div class="_2_QraFYR_0">ä»¥æˆ‘ä»¬è®¾è®¡çš„system diagnostics ä¸ºä¾‹å­ï¼Œæˆ‘ä»¬æ˜¯æ€ä¹ˆè‡ªåŠ¨æ¨ç®—å‡º æ•°æ®è·¯å¾„æ˜¯ container vethâ€”&gt; host veth â€”&gt; docker 0 â€”&gt; host eth0 å‘¢ï¼Ÿä»è€Œåœ¨è¿™æ¡è·¯å¾„ä¸Šåšæ¶ˆæ¯æå–å‘¢ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æˆ‘ä»¬ç”¨bpf trace ä¸»è¦çš„å†…æ ¸stackçš„æ”¶å‘å‡½æ•°ï¼Œdumpå‡ºnetwork namespace idå’Œdevice nameï¼Œ å°±å¯ä»¥çœ‹å‡ºè¿™æ¡è·¯å¾„äº†ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-08-14 09:24:42</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/1f/99/38/37b8a8c8.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>PageNotFound</span>
  </div>
  <div class="_2_QraFYR_0">å¤–éƒ¨ç½‘ç»œè®¿é—®å®¹å™¨å†…æœåŠ¡ï¼š<br>sudo iptables -t nat -A DOCKER ! -i docker0 -p tcp -m tcp --dport [hostPort] -j DNAT --to-destination [containerIP]:[containerPort]</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-05-14 22:47:48</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKhKicPfmH6FDtria1aViaaiaDC0n9nwsuh5LnSJlVvLkMrVZYoXnYT19ZdJ3lh8BUyYSDox1ibTAxnzjw/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å¾å–†</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œæˆ‘åšå®éªŒçš„æ—¶å€™è·Ÿç€åšå‘ç°pingä¸é€šå¤–ç½‘ï¼Œåæ¥æŠŠveth_hostæ¡¥æ¥åˆ°docker0ç½‘ç»œé€šäº†ï¼Œæ˜¯è€å¸ˆåœ¨è¯¾ç¨‹é‡Œæ²¡å†™ä¸Šè¿˜æ˜¯å…¶ä»–åŸå› ï¼Œæ±‚æ•™ä¸€ä¸‹</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-11 12:43:26</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/24/70/4e7751f3.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>è¶…çº§èŠ’æœå†°</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œvethæ˜¯æ€ä¹ˆé…å¯¹çš„ï¼Œåˆ›å»ºä¹‹åè‡ªåŠ¨é…å¯¹å—ã€‚å¦‚æœå»ºäº†4ä¸ªvethï¼Œé…å¯¹è§„åˆ™æ˜¯æ€ä¹ˆæ ·çš„</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-09-11 16:16:21</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/10/bb/f1061601.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Demon.Lee</span>
  </div>
  <div class="_2_QraFYR_0">è¯·æ•™è€å¸ˆå’Œå°ä¼™ä¼´ä»¬ä¸€ä¸ªé—®é¢˜ï¼Œä¸çŸ¥é“ä½ ä»¬æ˜¯å¦é‡åˆ°è¿‡ï¼š<br>ä¸€ä¸ªç®€å•çš„ k8s é›†ç¾¤ï¼ˆ1ä¸ª master ï¼Œ2ä¸ª workerï¼‰ ï¼Œmaster çš„ ip ä¸º 10.5.xx.xxï¼Œ2 ä¸ª worker çš„ ip ä¸º 192.168.100.xxã€‚<br><br>æœ‰ä¸€ä¸ª pod æš´éœ²äº†ä¸€ä¸ª https ç«¯å£ï¼ˆæ¯”å¦‚443ï¼‰ï¼Œç„¶å é€šè¿‡ curl https:&#47;&#47;xxx:443&#47;apis&#47;xxx è®¿é—®ï¼ˆè°ƒç”¨æ˜¯ä¼šå¸¦ä¸Štokenï¼‰ï¼Œå¦‚æœè¿™ä¸ª pod ä¸åœ¨ master èŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆåœ¨ master èŠ‚ç‚¹ä¸Šå‘èµ·è¯·æ±‚åä¸€ç›´æ²¡ååº”ï¼Œç›´åˆ°è¶…æ—¶ã€‚è€Œåœ¨ 2 ä¸ª worker èŠ‚ç‚¹å‘èµ·è¯·æ±‚ï¼Œåˆ™å¯ä»¥æ­£å¸¸è¿”å›ã€‚<br>å¦‚æœå°†è¿™ä¸ª pod å¼ºåˆ¶è°ƒåº¦åˆ° master èŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆåœ¨ master èŠ‚ç‚¹ä¸Šå‘èµ·è¯·æ±‚ï¼Œå¯ä»¥æ­£å¸¸è¿”å›ï¼Œä½†åœ¨  2 ä¸ª worker èŠ‚ç‚¹å‘èµ·è¯·æ±‚ï¼Œä¼šè¶…æ—¶æ— å“åº”ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: @Demon.Lee<br>ä½ æè¿°äº†k8s é›†ç¾¤èŠ‚ç‚¹ï¼Œä¸è¿‡æ²¡æœ‰æè¿°podç½‘ç»œé…ç½®æ–¹å¼ã€‚åœ¨åˆ†æè¿™ä¸ªé—®é¢˜å‰ï¼Œä½ å¯ä»¥æŠŠé›†ç¾¤çš„ç½‘ç»œæ‹“æ‰‘å’Œpodåœ¨èŠ‚ç‚¹ä¸Šçš„ç½‘ç»œæ‹“æ‰‘åˆ†æä¸€éï¼Œç„¶åå†åˆ†æå…·ä½“çš„é—®é¢˜ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-04 20:23:56</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/19/7c/bb/635a2710.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å¾å°‘æ–‡</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆçš„æ€è·¯æˆ‘çœ‹æ˜ç™½äº†ã€‚æˆ‘å·²ç»è‡ªå·±å®ç°äº†ä¸€ä¸ªå®¹å™¨æ²™ç®±ï¼Œç”¨net namespaceè¿›è¡Œäº†ç½‘ç»œçš„éš”ç¦»ï¼Œç°åœ¨æƒ³é…ç½®å®ƒçš„ç½‘ç»œåŠŸèƒ½ã€‚å®¿ä¸»æœºå·²ç»å¯ä»¥è¿é€šå¤–ç½‘ï¼Œæˆ‘åœ¨hostä¸Šåˆ›å»ºäº†ä¸€ä¸ªç½‘æ¡¥ï¼Œç„¶ååœ¨hostå’Œæ²™ç®±é‡Œæ”¾ç½®äº†veth0å’Œveth1ã€‚ä½†æ˜¯è¿˜æ²¡æœ‰è®¾ç½®hostä¸Šçš„SNATå’ŒDNATã€‚ç°åœ¨æ²™ç®±å’Œhostå·²ç»å¯ä»¥pingé€šï¼Œä¹Ÿå¯ä»¥é€šè¿‡tcpé€šä¿¡ã€‚ä½†æ˜¯æ²™ç®±å†…è¿˜æ˜¯æ— æ³•è®¿é—®å¤–ç½‘ï¼Œä½†æ˜¯ä¸çŸ¥é“å…·ä½“å¦‚ä½•è®¾ç½®SNATå’ŒDNATï¼Œè€å¸ˆèƒ½ç»™ç‚¹æŒ‡å¯¼å—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: @å¾å°‘æ–‡<br>å¯ä»¥æ‰¾ä¸€äº›iptablesç›¸å…³çš„æ–‡æ¡£çœ‹ä¸€ä¸‹ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-07-07 10:16:44</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/23/73/0c/214bbd5e.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ç™¾é‡Œè‹±éª</span>
  </div>
  <div class="_2_QraFYR_0">èŠ‚ç‚¹å¤–è®¿é—®å®¹å™¨å†…ipï¼š<br>1. å‰ææ˜¯æ­£å¸¸å¯åŠ¨å®¹å™¨å’Œå®¿ä¸»æœºå¯ä»¥é€šè¿‡VETHå’Œdocker0ç½‘æ¡¥äº’é€šï¼Œä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´äº’é€š<br>2. åœ¨å¤–éƒ¨çš„èŠ‚ç‚¹é…ç½®iptables(DNAT)è§„åˆ™ï¼š<br>sudo iptables -t nat -A PREROUTING -d 172.17.0.10(å®¹å™¨çš„çœŸå®ip) -j DNAT --to-destination 172.31.27.61(èŠ‚ç‚¹çš„çœŸå®ip)<br>3.ä¹‹åå³å¯ä»å¤–éƒ¨æœºå™¨ç›´æ¥ä¸containerå†…ipäº¤äº’<br><br>åè¿‡æ¥éœ€è¦ï¼Œå®¹å™¨èŠ‚ç‚¹æœ¬åœ°åšSNATï¼Œå¦åˆ™æ•°æ®åŒ…åªèƒ½è¿‡å»å›ä¸æ¥</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-05-20 11:20:25</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/4Lprf2mIWpJOPibgibbFCicMtp5bpIibyLFOnyOhnBGbusrLZC0frG0FGWqdcdCkcKunKxqiaOHvXbCFE7zKJ8TmvIA/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_c2089d</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œè¿™æ®µæ—¶é—´é‡åˆ°è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼Œæƒ³é—®ä¸‹é‡åˆ°è¿™ç§é—®é¢˜åº”è¯¥æ€ä¹ˆæ‰¾åŸå› :ä»€ä¹ˆæ—¥å¿—éƒ½çœ‹ä¸äº†<br><br>adding interface vethbad9e82 to bridge docker0 failed: could not find bridge docker0: no such network interface&quot;</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ç”¨&quot;ip link show type bridge&quot;å‘½ä»¤çœ‹ä¸€ä¸‹ docker0 interfaceæ˜¯ä¸æ˜¯å­˜åœ¨ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-04-24 10:46:39</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/c4/92/338b5609.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Roy Liang</span>
  </div>
  <div class="_2_QraFYR_0">ç”¨tcpdumpæŠ“åŒ…æ’æŸ¥é—®é¢˜çš„æ€è·¯å€¼å¾—å‚è€ƒï¼ŒåŒæ—¶ç†è§£äº†ç¤ºæ„å›¾ä¸Šçš„æ•°æ®é“¾è·¯ä¸­æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„ä½œç”¨</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: èµï¼</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-03-30 16:40:35</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src=""
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_41a96e</span>
  </div>
  <div class="_2_QraFYR_0">[root@tyy-node06 ~]# ln -s &#47;proc&#47;$pid&#47;ns&#47;net &#47;var&#47;run&#47;netns&#47;$pid<br>ln: failed to create symbolic link â€˜&#47;var&#47;run&#47;netns&#47;24847â€™: No such file or directoryï¼Œç›®å½•&#47;var&#47;run&#47;netns&#47;ä¸å­˜åœ¨è¦æ‰‹åŠ¨åˆ›å»ºå—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ˜¯çš„ï¼Œå¦‚æœ&#47;var&#47;run&#47;netns ä¸å­˜åœ¨ï¼Œäº‹å…ˆå»ºä¸€ä¸‹ã€‚ `mkdir -p &#47;var&#47;run&#47;netns`</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-03-03 17:31:15</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/14/64/08/0287f41f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>äº‰å…‰ Alan</span>
  </div>
  <div class="_2_QraFYR_0">æˆ‘çš„ç†è§£<br>å¤–éƒ¨è®¿é—®å®¹å™¨ï¼Œä¸€ä¸ªåŒ…åœ¨ä¸»æœºä¸Šçš„å¤„ç†å¤§æ¦‚æ˜¯<br>ç»è¿‡postroutingé“¾ï¼Œæœ¬åœ°è·¯ç”±ï¼Œinput&#47;forwordã€‚ã€‚ã€‚<br><br>æ‰€ä»¥å¦‚æœéœ€è¦ä¸»æœºè®¿é—®å®¹å™¨<br>æ–¹æ¡ˆä¸€<br>1.å¯ä»¥åœ¨postroutingé“¾å¢åŠ ç›®çš„åœ°æ˜¯docker0çš„ç½‘ç»œæ¥æ”¶<br>2.ç»è¿‡è·¯ç”±çš„æ—¶å€™ï¼Œå­˜åœ¨docker0ç›´é€šè·¯ç”±ï¼Œä¼šæ¥æ”¶å¤„ç†<br>ä½†è¿™æ ·åªèƒ½æ˜¯æœ¬ä¸»æœºè®¿é—®ï¼Œå¦‚æœæ˜¯å…¶ä»–ä¸»æœºï¼Œè¿˜éœ€è¦åœ¨å…¶ä»–ä¸»æœºé…ç½®ï¼ŒæŠŠåˆ°è¯¥docker0çš„åŒ…å‘è¿‡æ¥(æ¯”å¦‚å€ŸåŠ©overlayç­‰)<br><br>æ–¹æ¡ˆäºŒ<br>åšnatï¼Œè®¿é—®ä¸»æœºæŸç«¯å£çš„æµé‡è½¬ç»™å®¹å™¨çš„æŸä¸ªç«¯å£ï¼Œåˆ™<br>1.åœ¨postroutingé“¾å¢åŠ dnatå³å¯<br><br>è€å¸ˆå¯¹å—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-12-27 00:29:55</div>
  </div>
</div>
</div>
</li>
</ul>