<audio title="02 _ æ—¥å¿—ï¼ˆä¸Šï¼‰ï¼šæ—¥å¿—ç©¶ç«Ÿæ˜¯å¦‚ä½•åŠ è½½æ—¥å¿—æ®µçš„ï¼Ÿ" src="https://static001.geekbang.org/resource/audio/59/d4/59545895a0902d128c0f04221eced3d4.mp3" controls="controls"></audio> 
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚ä»Šå¤©æˆ‘æ¥è®²è®²Kafkaæºç çš„æ—¥å¿—ï¼ˆLogï¼‰å¯¹è±¡ã€‚</p><p>ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬å­¦ä¹ äº†æ—¥å¿—æ®µéƒ¨åˆ†çš„æºç ï¼Œä½ å¯ä»¥è®¤ä¸ºï¼Œ<strong>æ—¥å¿—æ˜¯æ—¥å¿—æ®µçš„å®¹å™¨ï¼Œé‡Œé¢å®šä¹‰äº†å¾ˆå¤šç®¡ç†æ—¥å¿—æ®µçš„æ“ä½œ</strong>ã€‚å¦ç‡åœ°è¯´ï¼Œå¦‚æœçœ‹Kafkaæºç å´ä¸çœ‹Logï¼Œå°±è·Ÿä½ ä¹°äº†è¿™é—¨è¯¾å´ä¸çŸ¥é“ä½œè€…æ˜¯è°ä¸€æ ·ã€‚åœ¨æˆ‘çœ‹æ¥ï¼ŒLogå¯¹è±¡æ˜¯Kafkaæºç ï¼ˆç‰¹åˆ«æ˜¯Brokerç«¯ï¼‰æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œæ²¡æœ‰ä¹‹ä¸€ã€‚</p><p>å®ƒåˆ°åº•æœ‰å¤šé‡è¦å‘¢ï¼Ÿæˆ‘å’Œä½ åˆ†äº«ä¸€ä¸ªä¾‹å­ï¼Œä½ å…ˆæ„Ÿå—ä¸‹ã€‚æˆ‘æœ€è¿‘æ­£åœ¨ä¿®å¤ä¸€ä¸ªKafkaçš„Bugï¼ˆ<a href="https://issues.apache.org/jira/browse/KAFKA-9157">KAFKA-9157</a>ï¼‰ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒKafkaçš„Compactionæ“ä½œä¼šäº§ç”Ÿå¾ˆå¤šç©ºçš„æ—¥å¿—æ®µæ–‡ä»¶ã€‚å¦‚æœè¦é¿å…è¿™äº›ç©ºæ—¥å¿—æ®µæ–‡ä»¶è¢«åˆ›å»ºå‡ºæ¥ï¼Œå°±å¿…é¡»ææ‡‚åˆ›å»ºæ—¥å¿—æ®µæ–‡ä»¶çš„åŸç†ï¼Œè€Œè¿™äº›ä»£ç æ°æ°å°±åœ¨Logæºç ä¸­ã€‚</p><p>æ—¢ç„¶Logæºç è¦ç®¡ç†æ—¥å¿—æ®µå¯¹è±¡ï¼Œé‚£ä¹ˆå®ƒå°±å¿…é¡»å…ˆæŠŠæ‰€æœ‰æ—¥å¿—æ®µå¯¹è±¡åŠ è½½åˆ°å†…å­˜é‡Œé¢ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿä»Šå¤©ï¼Œæˆ‘å°±å¸¦ä½ å­¦ä¹ ä¸‹æ—¥å¿—åŠ è½½æ—¥å¿—æ®µçš„è¿‡ç¨‹ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹Logå¯¹è±¡çš„æºç ç»“æ„ã€‚</p><h2>Logæºç ç»“æ„</h2><p>Logæºç ä½äºKafka coreå·¥ç¨‹çš„logæºç åŒ…ä¸‹ï¼Œæ–‡ä»¶åæ˜¯Log.scalaã€‚æ€»ä½“ä¸Šï¼Œè¯¥æ–‡ä»¶å®šä¹‰äº†10ä¸ªç±»å’Œå¯¹è±¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://static001.geekbang.org/resource/image/81/ce/8126a191f63d9abea860d71992b0aece.jpg?wh=863*606" alt=""></p><p>é‚£ä¹ˆï¼Œè¿™10ä¸ªç±»å’Œå¯¹è±¡éƒ½æ˜¯åšä»€ä¹ˆçš„å‘¢ï¼Ÿæˆ‘å…ˆç»™ä½ ç®€å•ä»‹ç»ä¸€ä¸‹ï¼Œä½ å¯ä»¥å¯¹å®ƒä»¬æœ‰ä¸ªå¤§è‡´çš„äº†è§£ã€‚</p><!-- [[[read_end]]] --><p>ä¸è¿‡ï¼Œåœ¨ä»‹ç»ä¹‹å‰ï¼Œæˆ‘å…ˆæä¸€å¥ï¼Œå›¾ä¸­æ‹¬å·é‡Œçš„Cè¡¨ç¤ºClassï¼ŒOè¡¨ç¤ºObjectã€‚è¿˜è®°å¾—æˆ‘åœ¨ä¸ŠèŠ‚è¯¾æåˆ°è¿‡çš„ä¼´ç”Ÿå¯¹è±¡å—ï¼Ÿæ²¡é”™ï¼ŒåŒæ—¶å®šä¹‰åŒåçš„Classå’ŒObjectï¼Œå°±å±äºScalaä¸­çš„ä¼´ç”Ÿå¯¹è±¡ç”¨æ³•ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¼´ç”Ÿå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯LogAppendInfoã€Logå’ŒRollParamsã€‚</p><p><strong>1.LogAppendInfo</strong></p><ul>
<li>LogAppendInfoï¼ˆCï¼‰ï¼šä¿å­˜äº†ä¸€ç»„å¾…å†™å…¥æ¶ˆæ¯çš„å„ç§å…ƒæ•°æ®ä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œè¿™ç»„æ¶ˆæ¯ä¸­ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ä½ç§»å€¼æ˜¯å¤šå°‘ã€æœ€åä¸€æ¡æ¶ˆæ¯çš„ä½ç§»å€¼æ˜¯å¤šå°‘ï¼›å†æ¯”å¦‚ï¼Œè¿™ç»„æ¶ˆæ¯ä¸­æœ€å¤§çš„æ¶ˆæ¯æ—¶é—´æˆ³åˆæ˜¯å¤šå°‘ã€‚æ€»ä¹‹ï¼Œè¿™é‡Œé¢çš„æ•°æ®éå¸¸ä¸°å¯Œï¼ˆä¸‹èŠ‚è¯¾æˆ‘å†å…·ä½“è¯´è¯´ï¼‰ã€‚</li>
<li>LogAppendInfoï¼ˆOï¼‰: å¯ä»¥ç†è§£ä¸ºå…¶å¯¹åº”ä¼´ç”Ÿç±»çš„å·¥å‚æ–¹æ³•ç±»ï¼Œé‡Œé¢å®šä¹‰äº†ä¸€äº›å·¥å‚æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºç‰¹å®šçš„LogAppendInfoå®ä¾‹ã€‚</li>
</ul><p><strong>2.Log</strong></p><ul>
<li>Logï¼ˆCï¼‰: Logæºç ä¸­æœ€æ ¸å¿ƒçš„ä»£ç ã€‚è¿™é‡Œæˆ‘å…ˆå–ä¸ªå…³å­ï¼Œä¸€ä¼šå„¿ç»†èŠã€‚</li>
<li>Logï¼ˆOï¼‰ï¼šåŒç†ï¼ŒLogä¼´ç”Ÿç±»çš„å·¥å‚æ–¹æ³•ï¼Œå®šä¹‰äº†å¾ˆå¤šå¸¸é‡ä»¥åŠä¸€äº›è¾…åŠ©æ–¹æ³•ã€‚</li>
</ul><p><strong>3.RollParams</strong></p><ul>
<li>RollParamsï¼ˆCï¼‰ï¼šå®šä¹‰ç”¨äºæ§åˆ¶æ—¥å¿—æ®µæ˜¯å¦åˆ‡åˆ†ï¼ˆRollï¼‰çš„æ•°æ®ç»“æ„ã€‚</li>
<li>RollParamsï¼ˆOï¼‰ï¼šåŒç†ï¼ŒRollParamsä¼´ç”Ÿç±»çš„å·¥å‚æ–¹æ³•ã€‚</li>
</ul><p>é™¤äº†è¿™3ç»„ä¼´ç”Ÿå¯¹è±¡ä¹‹å¤–ï¼Œè¿˜æœ‰4ç±»æºç ã€‚</p><ul>
<li>LogMetricNamesï¼šå®šä¹‰äº†Logå¯¹è±¡çš„ç›‘æ§æŒ‡æ ‡ã€‚</li>
<li>LogOffsetSnapshotï¼šå°è£…åˆ†åŒºæ‰€æœ‰ä½ç§»å…ƒæ•°æ®çš„å®¹å™¨ç±»ã€‚</li>
<li>LogReadInfoï¼šå°è£…è¯»å–æ—¥å¿—è¿”å›çš„æ•°æ®åŠå…¶å…ƒæ•°æ®ã€‚</li>
<li>CompletedTxnï¼šè®°å½•å·²å®Œæˆäº‹åŠ¡çš„å…ƒæ•°æ®ï¼Œä¸»è¦ç”¨äºæ„å»ºäº‹åŠ¡ç´¢å¼•ã€‚</li>
</ul><h2>Log Class &amp; Object</h2><p>ä¸‹é¢ï¼Œæˆ‘ä¼šæŒ‰ç…§è¿™äº›ç±»å’Œå¯¹è±¡çš„é‡è¦ç¨‹åº¦ï¼Œå¯¹å®ƒä»¬ä¸€ä¸€è¿›è¡Œæ‹†è§£ã€‚é¦–å…ˆï¼Œå’±ä»¬å…ˆè¯´è¯´Logç±»åŠå…¶ä¼´ç”Ÿå¯¹è±¡ã€‚</p><p>è€ƒè™‘åˆ°ä¼´ç”Ÿå¯¹è±¡å¤šç”¨äºä¿å­˜é™æ€å˜é‡å’Œé™æ€æ–¹æ³•ï¼ˆæ¯”å¦‚é™æ€å·¥å‚æ–¹æ³•ç­‰ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å…ˆçœ‹ä¼´ç”Ÿå¯¹è±¡ï¼ˆå³Log Objectï¼‰çš„å®ç°ã€‚æ¯•ç«Ÿï¼ŒæŸ¿å­å…ˆæ‰¾è½¯çš„æï¼</p><pre><code>object Log {
  val LogFileSuffix = &quot;.log&quot;
  val IndexFileSuffix = &quot;.index&quot;
  val TimeIndexFileSuffix = &quot;.timeindex&quot;
  val ProducerSnapshotFileSuffix = &quot;.snapshot&quot;
  val TxnIndexFileSuffix = &quot;.txnindex&quot;
  val DeletedFileSuffix = &quot;.deleted&quot;
  val CleanedFileSuffix = &quot;.cleaned&quot;
  val SwapFileSuffix = &quot;.swap&quot;
  val CleanShutdownFile = &quot;.kafka_cleanshutdown&quot;
  val DeleteDirSuffix = &quot;-delete&quot;
  val FutureDirSuffix = &quot;-future&quot;
â€¦â€¦
}
</code></pre><p>è¿™æ˜¯Log Objectå®šä¹‰çš„æ‰€æœ‰å¸¸é‡ã€‚å¦‚æœæœ‰é¢è¯•å®˜é—®ä½ Kafkaä¸­å®šä¹‰äº†å¤šå°‘ç§æ–‡ä»¶ç±»å‹ï¼Œä½ å¯ä»¥è‡ªè±ªåœ°æŠŠè¿™äº›è¯´å‡ºæ¥ã€‚è€³ç†Ÿèƒ½è¯¦çš„.logã€.indexã€.timeindexå’Œ.txnindexæˆ‘å°±ä¸è§£é‡Šäº†ï¼Œæˆ‘ä»¬æ¥äº†è§£ä¸‹å…¶ä»–å‡ ç§æ–‡ä»¶ç±»å‹ã€‚</p><ul>
<li>.snapshotæ˜¯Kafkaä¸ºå¹‚ç­‰å‹æˆ–äº‹åŠ¡å‹Produceræ‰€åšçš„å¿«ç…§æ–‡ä»¶ã€‚é‰´äºæˆ‘ä»¬ç°åœ¨è¿˜å¤„äºé˜…è¯»æºç çš„åˆçº§é˜¶æ®µï¼Œäº‹åŠ¡æˆ–å¹‚ç­‰éƒ¨åˆ†çš„æºç æˆ‘å°±ä¸è¯¦ç»†å±•å¼€è®²äº†ã€‚</li>
<li>.deletedæ˜¯åˆ é™¤æ—¥å¿—æ®µæ“ä½œåˆ›å»ºçš„æ–‡ä»¶ã€‚ç›®å‰åˆ é™¤æ—¥å¿—æ®µæ–‡ä»¶æ˜¯å¼‚æ­¥æ“ä½œï¼ŒBrokerç«¯æŠŠæ—¥å¿—æ®µæ–‡ä»¶ä».logåç¼€ä¿®æ”¹ä¸º.deletedåç¼€ã€‚å¦‚æœä½ çœ‹åˆ°ä¸€å¤§å †.deletedåç¼€çš„æ–‡ä»¶åï¼Œåˆ«æ…Œï¼Œè¿™æ˜¯Kafkaåœ¨æ‰§è¡Œæ—¥å¿—æ®µæ–‡ä»¶åˆ é™¤ã€‚</li>
<li>.cleanedå’Œ.swapéƒ½æ˜¯Compactionæ“ä½œçš„äº§ç‰©ï¼Œç­‰æˆ‘ä»¬è®²åˆ°Cleanerçš„æ—¶å€™å†è¯´ã€‚</li>
<li>-deleteåˆ™æ˜¯åº”ç”¨äºæ–‡ä»¶å¤¹çš„ã€‚å½“ä½ åˆ é™¤ä¸€ä¸ªä¸»é¢˜çš„æ—¶å€™ï¼Œä¸»é¢˜çš„åˆ†åŒºæ–‡ä»¶å¤¹ä¼šè¢«åŠ ä¸Šè¿™ä¸ªåç¼€ã€‚</li>
<li>-futureæ˜¯ç”¨äºå˜æ›´ä¸»é¢˜åˆ†åŒºæ–‡ä»¶å¤¹åœ°å€çš„ï¼Œå±äºæ¯”è¾ƒé«˜é˜¶çš„ç”¨æ³•ã€‚</li>
</ul><p>æ€»ä¹‹ï¼Œè®°ä½è¿™äº›å¸¸é‡å§ã€‚è®°ä½å®ƒä»¬çš„ä¸»è¦ä½œç”¨æ˜¯ï¼Œä»¥åä¸è¦è¢«é¢è¯•å®˜å”¬ä½ï¼å¼€ç©ç¬‘ï¼Œå…¶å®è¿™äº›å¸¸é‡æœ€é‡è¦çš„åœ°æ–¹å°±åœ¨äºï¼Œå®ƒä»¬èƒ½å¤Ÿè®©ä½ äº†è§£Kafkaå®šä¹‰çš„å„ç§æ–‡ä»¶ç±»å‹ã€‚</p><p>Log Objectè¿˜å®šä¹‰äº†è¶…å¤šçš„å·¥å…·ç±»æ–¹æ³•ã€‚ç”±äºå®ƒä»¬éƒ½å¾ˆç®€å•ï¼Œè¿™é‡Œæˆ‘åªç»™å‡ºä¸€ä¸ªæ–¹æ³•çš„æºç ï¼Œæˆ‘ä»¬ä¸€èµ·è¯»ä¸€ä¸‹ã€‚</p><pre><code>def filenamePrefixFromOffset(offset: Long): String = {
    val nf = NumberFormat.getInstance()
    nf.setMinimumIntegerDigits(20)
    nf.setMaximumFractionDigits(0)
    nf.setGroupingUsed(false)
    nf.format(offset)
  }
</code></pre><p>è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯<strong>é€šè¿‡ç»™å®šçš„ä½ç§»å€¼è®¡ç®—å‡ºå¯¹åº”çš„æ—¥å¿—æ®µæ–‡ä»¶å</strong>ã€‚Kafkaæ—¥å¿—æ–‡ä»¶å›ºå®šæ˜¯20ä½çš„é•¿åº¦ï¼ŒfilenamePrefixFromOffsetæ–¹æ³•å°±æ˜¯ç”¨å‰é¢è¡¥0çš„æ–¹å¼ï¼ŒæŠŠç»™å®šä½ç§»å€¼æ‰©å……æˆä¸€ä¸ªå›ºå®š20ä½é•¿åº¦çš„å­—ç¬¦ä¸²ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ç»™å®šä¸€ä¸ªä½ç§»å€¼æ˜¯12345ï¼Œé‚£ä¹ˆBrokerç«¯ç£ç›˜ä¸Šå¯¹åº”çš„æ—¥å¿—æ®µæ–‡ä»¶åå°±åº”è¯¥æ˜¯00000000000000012345.logã€‚æ€ä¹ˆæ ·ï¼Œå¾ˆç®€å•å§ï¼Ÿå…¶ä»–çš„å·¥å…·ç±»æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘å°±ä¸ä¸€ä¸€å±•å¼€è¯´äº†ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹Logæºç éƒ¨åˆ†çš„é‡å¤´æˆï¼š<strong>Logç±»</strong>ã€‚è¿™æ˜¯ä¸€ä¸ª2000å¤šè¡Œçš„å¤§ç±»ã€‚æ”¾çœ¼æ•´ä¸ªKafkaæºç ï¼ŒåƒLogè¿™ä¹ˆå¤§çš„ç±»ä¹Ÿä¸å¤šè§ï¼Œè¶³è§å®ƒçš„é‡è¦ç¨‹åº¦ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹è¿™ä¸ªç±»çš„å®šä¹‰ï¼š</p><pre><code>class Log(@volatile var dir: File,
          @volatile var config: LogConfig,
          @volatile var logStartOffset: Long,
          @volatile var recoveryPoint: Long,
          scheduler: Scheduler,
          brokerTopicStats: BrokerTopicStats,
          val time: Time,
          val maxProducerIdExpirationMs: Int,
          val producerIdExpirationCheckIntervalMs: Int,
          val topicPartition: TopicPartition,
          val producerStateManager: ProducerStateManager,
          logDirFailureChannel: LogDirFailureChannel) extends Logging with KafkaMetricsGroup {
â€¦â€¦
}
</code></pre><p>çœ‹ç€å¥½åƒæœ‰å¾ˆå¤šå±æ€§ï¼Œä½†å…¶å®ï¼Œä½ åªéœ€è¦è®°ä½ä¸¤ä¸ªå±æ€§çš„ä½œç”¨å°±å¤Ÿäº†ï¼š<strong>dirå’ŒlogStartOffset</strong>ã€‚dirå°±æ˜¯è¿™ä¸ªæ—¥å¿—æ‰€åœ¨çš„æ–‡ä»¶å¤¹è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯<strong>ä¸»é¢˜åˆ†åŒºçš„è·¯å¾„</strong>ã€‚è€ŒlogStartOffsetï¼Œè¡¨ç¤º<strong>æ—¥å¿—çš„å½“å‰æœ€æ—©ä½ç§»</strong>ã€‚dirå’ŒlogStartOffsetéƒ½æ˜¯volatile varç±»å‹ï¼Œè¡¨ç¤ºå®ƒä»¬çš„å€¼æ˜¯å˜åŠ¨çš„ï¼Œè€Œä¸”å¯èƒ½è¢«å¤šä¸ªçº¿ç¨‹æ›´æ–°ã€‚</p><p>ä½ å¯èƒ½å¬è¿‡æ—¥å¿—çš„å½“å‰æœ«ç«¯ä½ç§»ï¼Œä¹Ÿå°±æ˜¯Log End Offsetï¼ˆLEOï¼‰ï¼Œå®ƒæ˜¯è¡¨ç¤ºæ—¥å¿—ä¸‹ä¸€æ¡å¾…æ’å…¥æ¶ˆæ¯çš„ä½ç§»å€¼ï¼Œè€Œè¿™ä¸ªLog Start Offsetæ˜¯è·Ÿå®ƒç›¸åçš„ï¼Œå®ƒè¡¨ç¤ºæ—¥å¿—å½“å‰å¯¹å¤–å¯è§çš„æœ€æ—©ä¸€æ¡æ¶ˆæ¯çš„ä½ç§»å€¼ã€‚æˆ‘ç”¨ä¸€å¼ å›¾æ¥æ ‡è¯†å®ƒä»¬çš„åŒºåˆ«ï¼š</p><p><img src="https://static001.geekbang.org/resource/image/38/b4/388672f6dab8571f272ed47c9679c2b4.jpg?wh=4000*2250" alt=""></p><p>å›¾ä¸­ç»¿è‰²çš„ä½ç§»å€¼3æ˜¯æ—¥å¿—çš„Log Start Offsetï¼Œè€Œä½ç§»å€¼15è¡¨ç¤ºLEOã€‚å¦å¤–ï¼Œä½ç§»å€¼8æ˜¯é«˜æ°´ä½å€¼ï¼Œå®ƒæ˜¯åŒºåˆ†å·²æäº¤æ¶ˆæ¯å’Œæœªæäº¤æ¶ˆæ¯çš„åˆ†æ°´å²­ã€‚</p><p>æœ‰æ„æ€çš„æ˜¯ï¼ŒLog End Offsetå¯ä»¥ç®€ç§°ä¸ºLEOï¼Œä½†Log Start Offsetå´ä¸èƒ½ç®€ç§°ä¸ºLSOã€‚å› ä¸ºåœ¨Kafkaä¸­ï¼ŒLSOç‰¹æŒ‡Log Stable Offsetï¼Œå±äºKafkaäº‹åŠ¡çš„æ¦‚å¿µã€‚è¿™ä¸ªè¯¾ç¨‹ä¸­ä¸ä¼šæ¶‰åŠLSOï¼Œä½ åªéœ€è¦çŸ¥é“Log Start Offsetä¸ç­‰äºLSOå³å¯ã€‚</p><p>Logç±»çš„å…¶ä»–å±æ€§ä½ æš‚æ—¶ä¸ç”¨ç†ä¼šï¼Œå› ä¸ºå®ƒä»¬è¦ä¹ˆæ˜¯å¾ˆæ˜æ˜¾çš„å·¥å…·ç±»å±æ€§ï¼Œæ¯”å¦‚timerå’Œschedulerï¼Œè¦ä¹ˆæ˜¯é«˜é˜¶ç”¨æ³•æ‰ä¼šç”¨åˆ°çš„é«˜çº§å±æ€§ï¼Œæ¯”å¦‚producerStateManagerå’ŒlogDirFailureChannelã€‚å·¥å…·ç±»çš„ä»£ç å¤§å¤šæ˜¯åšè¾…åŠ©ç”¨çš„ï¼Œè·³è¿‡å®ƒä»¬ä¹Ÿä¸å¦¨ç¢æˆ‘ä»¬ç†è§£Kafkaçš„æ ¸å¿ƒåŠŸèƒ½ï¼›è€Œé«˜é˜¶åŠŸèƒ½ä»£ç è®¾è®¡å¤æ‚ï¼Œå­¦ä¹ æˆæœ¬é«˜ï¼Œæ€§ä»·æ¯”ä¸é«˜ã€‚</p><p>å…¶å®ï¼Œé™¤äº†Logç±»ç­¾åå®šä¹‰çš„è¿™äº›å±æ€§ä¹‹å¤–ï¼ŒLogç±»è¿˜å®šä¹‰äº†ä¸€äº›å¾ˆé‡è¦çš„å±æ€§ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š</p><pre><code>    @volatile private var nextOffsetMetadata: LogOffsetMetadata = _
    @volatile private var highWatermarkMetadata: LogOffsetMetadata = LogOffsetMetadata(logStartOffset)
    private val segments: ConcurrentNavigableMap[java.lang.Long, LogSegment] = new ConcurrentSkipListMap[java.lang.Long, LogSegment]
    @volatile var leaderEpochCache: Option[LeaderEpochFileCache] = None
</code></pre><p>ç¬¬ä¸€ä¸ªå±æ€§nextOffsetMetadataï¼Œå®ƒå°è£…äº†ä¸‹ä¸€æ¡å¾…æ’å…¥æ¶ˆæ¯çš„ä½ç§»å€¼ï¼Œä½ åŸºæœ¬ä¸Šå¯ä»¥æŠŠè¿™ä¸ªå±æ€§å’ŒLEOç­‰åŒèµ·æ¥ã€‚</p><p>ç¬¬äºŒä¸ªå±æ€§highWatermarkMetadataï¼Œæ˜¯åˆ†åŒºæ—¥å¿—é«˜æ°´ä½å€¼ã€‚å…³äºé«˜æ°´ä½çš„æ¦‚å¿µï¼Œæˆ‘ä»¬åœ¨<a href="https://time.geekbang.org/column/intro/100029201">ã€ŠKafkaæ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜ã€‹</a>è¿™ä¸ªè¯¾ç¨‹ä¸­åšè¿‡è¯¦ç»†è§£é‡Šï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹<a href="https://time.geekbang.org/column/article/112118">è¿™ç¯‡æ–‡ç« </a>ï¼ˆä¸‹èŠ‚è¯¾æˆ‘è¿˜ä¼šå†å…·ä½“ç»™ä½ ä»‹ç»ä¸‹ï¼‰ã€‚</p><p>ç¬¬ä¸‰ä¸ªå±æ€§segmentsï¼Œæˆ‘è®¤ä¸ºè¿™æ˜¯Logç±»ä¸­æœ€é‡è¦çš„å±æ€§ã€‚å®ƒä¿å­˜äº†åˆ†åŒºæ—¥å¿—ä¸‹æ‰€æœ‰çš„æ—¥å¿—æ®µä¿¡æ¯ï¼Œåªä¸è¿‡æ˜¯ç”¨Mapçš„æ•°æ®ç»“æ„æ¥ä¿å­˜çš„ã€‚Mapçš„Keyå€¼æ˜¯æ—¥å¿—æ®µçš„èµ·å§‹ä½ç§»å€¼ï¼ŒValueåˆ™æ˜¯æ—¥å¿—æ®µå¯¹è±¡æœ¬èº«ã€‚Kafkaæºç ä½¿ç”¨ConcurrentNavigableMapæ•°æ®ç»“æ„æ¥ä¿å­˜æ—¥å¿—æ®µå¯¹è±¡ï¼Œå°±å¯ä»¥å¾ˆè½»æ¾åœ°åˆ©ç”¨è¯¥ç±»æä¾›çš„çº¿ç¨‹å®‰å…¨å’Œå„ç§æ”¯æŒæ’åºçš„æ–¹æ³•ï¼Œæ¥ç®¡ç†æ‰€æœ‰æ—¥å¿—æ®µå¯¹è±¡ã€‚</p><p>ç¬¬å››ä¸ªå±æ€§æ˜¯Leader Epoch Cacheå¯¹è±¡ã€‚Leader Epochæ˜¯ç¤¾åŒºäº0.11.0.0ç‰ˆæœ¬å¼•å…¥æºç ä¸­çš„ï¼Œä¸»è¦æ˜¯ç”¨æ¥åˆ¤æ–­å‡ºç°Failureæ—¶æ˜¯å¦æ‰§è¡Œæ—¥å¿—æˆªæ–­æ“ä½œï¼ˆTruncationï¼‰ã€‚ä¹‹å‰é é«˜æ°´ä½æ¥åˆ¤æ–­çš„æœºåˆ¶ï¼Œå¯èƒ½ä¼šé€ æˆå‰¯æœ¬é—´æ•°æ®ä¸ä¸€è‡´çš„æƒ…å½¢ã€‚è¿™é‡Œçš„Leader Epoch Cacheæ˜¯ä¸€ä¸ªç¼“å­˜ç±»æ•°æ®ï¼Œé‡Œé¢ä¿å­˜äº†åˆ†åŒºLeaderçš„Epochå€¼ä¸å¯¹åº”ä½ç§»å€¼çš„æ˜ å°„å…³ç³»ï¼Œæˆ‘å»ºè®®ä½ æŸ¥çœ‹ä¸‹LeaderEpochFileCacheç±»ï¼Œæ·±å…¥åœ°äº†è§£ä¸‹å®ƒçš„å®ç°åŸç†ã€‚</p><p>æŒæ¡äº†è¿™äº›åŸºæœ¬å±æ€§ä¹‹åï¼Œæˆ‘ä»¬çœ‹ä¸‹Logç±»çš„åˆå§‹åŒ–é€»è¾‘ï¼š</p><pre><code> locally {
        val startMs = time.milliseconds
    
    
        // create the log directory if it doesn't exist
        Files.createDirectories(dir.toPath)
    
    
        initializeLeaderEpochCache()
    
    
        val nextOffset = loadSegments()
    
    
        /* Calculate the offset of the next message */
        nextOffsetMetadata = LogOffsetMetadata(nextOffset, activeSegment.baseOffset, activeSegment.size)
    
    
        leaderEpochCache.foreach(_.truncateFromEnd(nextOffsetMetadata.messageOffset))
    
    
        logStartOffset = math.max(logStartOffset, segments.firstEntry.getValue.baseOffset)
    
    
        // The earliest leader epoch may not be flushed during a hard failure. Recover it here.
        leaderEpochCache.foreach(_.truncateFromStart(logStartOffset))
    
    
        // Any segment loading or recovery code must not use producerStateManager, so that we can build the full state here
        // from scratch.
        if (!producerStateManager.isEmpty)
          throw new IllegalStateException(&quot;Producer state must be empty during log initialization&quot;)
        loadProducerState(logEndOffset, reloadFromCleanShutdown = hasCleanShutdownFile)
    
    
        info(s&quot;Completed load of log with ${segments.size} segments, log start offset $logStartOffset and &quot; +
          s&quot;log end offset $logEndOffset in ${time.milliseconds() - startMs} 
</code></pre><p>åœ¨è¯¦ç»†è§£é‡Šè¿™æ®µåˆå§‹åŒ–ä»£ç ä¹‹å‰ï¼Œæˆ‘ä½¿ç”¨ä¸€å¼ å›¾æ¥è¯´æ˜å®ƒåˆ°åº•åšäº†ä»€ä¹ˆï¼š</p><p><img src="https://static001.geekbang.org/resource/image/a1/a8/a10b81680a449e5b1d8882939061f7a8.jpg?wh=2284*1285" alt=""></p><p>è¿™é‡Œæˆ‘ä»¬é‡ç‚¹è¯´è¯´ç¬¬ä¸‰æ­¥ï¼Œå³åŠ è½½æ—¥å¿—æ®µçš„å®ç°é€»è¾‘ï¼Œä»¥ä¸‹æ˜¯loadSegmentsçš„å®ç°ä»£ç ï¼š</p><pre><code> private def loadSegments(): Long = {
        // first do a pass through the files in the log directory and remove any temporary files
        // and find any interrupted swap operations
        val swapFiles = removeTempFilesAndCollectSwapFiles()
    
    
        // Now do a second pass and load all the log and index files.
        // We might encounter legacy log segments with offset overflow (KAFKA-6264). We need to split such segments. When
        // this happens, restart loading segment files from scratch.
        retryOnOffsetOverflow {
          // In case we encounter a segment with offset overflow, the retry logic will split it after which we need to retry
          // loading of segments. In that case, we also need to close all segments that could have been left open in previous
          // call to loadSegmentFiles().
          logSegments.foreach(_.close())
          segments.clear()
          loadSegmentFiles()
        }
    
    
        // Finally, complete any interrupted swap operations. To be crash-safe,
        // log files that are replaced by the swap segment should be renamed to .deleted
        // before the swap file is restored as the new segment file.
        completeSwapOperations(swapFiles)
    
    
        if (!dir.getAbsolutePath.endsWith(Log.DeleteDirSuffix)) {
          val nextOffset = retryOnOffsetOverflow {
            recoverLog()
          }
    
    
          // reset the index size of the currently active log segment to allow more entries
          activeSegment.resizeIndexes(config.maxIndexSize)
          nextOffset
        } else {
           if (logSegments.isEmpty) {
              addSegment(LogSegment.open(dir = dir,
                baseOffset = 0,
                config,
                time = time,
                fileAlreadyExists = false,
                initFileSize = this.initFileSize,
                preallocate = false))
           }
          0
        }

</code></pre><p>è¿™æ®µä»£ç ä¼šå¯¹åˆ†åŒºæ—¥å¿—è·¯å¾„éå†ä¸¤æ¬¡ã€‚</p><p>é¦–å…ˆï¼Œå®ƒä¼šç§»é™¤ä¸Šæ¬¡Failureé—ç•™ä¸‹æ¥çš„å„ç§ä¸´æ—¶æ–‡ä»¶ï¼ˆåŒ…æ‹¬.cleanedã€.swapã€.deletedæ–‡ä»¶ç­‰ï¼‰ï¼ŒremoveTempFilesAndCollectSwapFilesæ–¹æ³•å®ç°äº†è¿™ä¸ªé€»è¾‘ã€‚</p><p>ä¹‹åï¼Œå®ƒä¼šæ¸…ç©ºæ‰€æœ‰æ—¥å¿—æ®µå¯¹è±¡ï¼Œå¹¶ä¸”å†æ¬¡éå†åˆ†åŒºè·¯å¾„ï¼Œé‡å»ºæ—¥å¿—æ®µsegments Mapå¹¶åˆ é™¤æ— å¯¹åº”æ—¥å¿—æ®µæ–‡ä»¶çš„å­¤ç«‹ç´¢å¼•æ–‡ä»¶ã€‚</p><p>å¾…æ‰§è¡Œå®Œè¿™ä¸¤æ¬¡éå†ä¹‹åï¼Œå®ƒä¼šå®Œæˆæœªå®Œæˆçš„swapæ“ä½œï¼Œå³è°ƒç”¨completeSwapOperationsæ–¹æ³•ã€‚ç­‰è¿™äº›éƒ½åšå®Œä¹‹åï¼Œå†è°ƒç”¨recoverLogæ–¹æ³•æ¢å¤æ—¥å¿—æ®µå¯¹è±¡ï¼Œç„¶åè¿”å›æ¢å¤ä¹‹åçš„åˆ†åŒºæ—¥å¿—LEOå€¼ã€‚</p><p>å¦‚æœä½ ç°åœ¨è§‰å¾—æœ‰ç‚¹è’™ï¼Œä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘æŠŠè¿™æ®µä»£ç å†è¿›ä¸€æ­¥æ‹†è§£ä¸‹ï¼Œä»¥æ›´å°çš„ç²’åº¦è·Ÿä½ è®²ä¸‹å®ƒä»¬åšäº†ä»€ä¹ˆã€‚ç†è§£äº†è¿™æ®µä»£ç ä¹‹åï¼Œä½ å¤§è‡´å°±èƒ½ææ¸…æ¥šå¤§éƒ¨åˆ†çš„åˆ†åŒºæ—¥å¿—æ“ä½œäº†ã€‚æ‰€ä»¥ï¼Œè¿™éƒ¨åˆ†ä»£ç ç»å¯¹å€¼å¾—æˆ‘ä»¬å¤šèŠ±ä¸€ç‚¹æ—¶é—´å»å­¦ä¹ ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ç¬¬ä¸€æ­¥ï¼ŒremoveTempFilesAndCollectSwapFilesæ–¹æ³•çš„å®ç°ã€‚æˆ‘ç”¨æ³¨é‡Šçš„æ–¹å¼è¯¦ç»†è§£é‡Šäº†æ¯è¡Œä»£ç çš„ä½œç”¨ï¼š</p><pre><code> private def removeTempFilesAndCollectSwapFiles(): Set[File] = {
    
    // åœ¨æ–¹æ³•å†…éƒ¨å®šä¹‰ä¸€ä¸ªåä¸ºdeleteIndicesIfExistçš„æ–¹æ³•ï¼Œç”¨äºåˆ é™¤æ—¥å¿—æ–‡ä»¶å¯¹åº”çš„ç´¢å¼•æ–‡ä»¶
    
    def deleteIndicesIfExist(baseFile: File, suffix: String = &quot;&quot;): Unit = {
    
    info(s&quot;Deleting index files with suffix $suffix for baseFile $baseFile&quot;)
    
    val offset = offsetFromFile(baseFile)
    
    Files.deleteIfExists(Log.offsetIndexFile(dir, offset, suffix).toPath)
    
    Files.deleteIfExists(Log.timeIndexFile(dir, offset, suffix).toPath)
    
    Files.deleteIfExists(Log.transactionIndexFile(dir, offset, suffix).toPath)
    
    }
    
    var swapFiles = Set[File]()
    
    var cleanFiles = Set[File]()
    
    var minCleanedFileOffset = Long.MaxValue
    
    // éå†åˆ†åŒºæ—¥å¿—è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
    
    for (file &lt;- dir.listFiles if file.isFile) {
    
    if (!file.canRead) // å¦‚æœä¸å¯è¯»ï¼Œç›´æ¥æŠ›å‡ºIOException
    
    throw new IOException(s&quot;Could not read file $file&quot;)
    
    val filename = file.getName
    
    if (filename.endsWith(DeletedFileSuffix)) { // å¦‚æœä»¥.deletedç»“å°¾
    
    debug(s&quot;Deleting stray temporary file ${file.getAbsolutePath}&quot;)
    
    Files.deleteIfExists(file.toPath) // è¯´æ˜æ˜¯ä¸Šæ¬¡Failureé—ç•™ä¸‹æ¥çš„æ–‡ä»¶ï¼Œç›´æ¥åˆ é™¤
    
    } else if (filename.endsWith(CleanedFileSuffix)) { // å¦‚æœä»¥.cleanedç»“å°¾
    
    minCleanedFileOffset = Math.min(offsetFromFileName(filename), minCleanedFileOffset) // é€‰å–æ–‡ä»¶åä¸­ä½ç§»å€¼æœ€å°çš„.cleanedæ–‡ä»¶ï¼Œè·å–å…¶ä½ç§»å€¼ï¼Œå¹¶å°†è¯¥æ–‡ä»¶åŠ å…¥å¾…åˆ é™¤æ–‡ä»¶é›†åˆä¸­
    
    cleanFiles += file
    
    } else if (filename.endsWith(SwapFileSuffix)) { // å¦‚æœä»¥.swapç»“å°¾
    
    val baseFile = new File(CoreUtils.replaceSuffix(file.getPath, SwapFileSuffix, &quot;&quot;))
    
    info(s&quot;Found file ${file.getAbsolutePath} from interrupted swap operation.&quot;)
    
    if (isIndexFile(baseFile)) { // å¦‚æœè¯¥.swapæ–‡ä»¶åŸæ¥æ˜¯ç´¢å¼•æ–‡ä»¶
    
    deleteIndicesIfExist(baseFile) // åˆ é™¤åŸæ¥çš„ç´¢å¼•æ–‡ä»¶
    
    } else if (isLogFile(baseFile)) { // å¦‚æœè¯¥.swapæ–‡ä»¶åŸæ¥æ˜¯æ—¥å¿—æ–‡ä»¶
    
    deleteIndicesIfExist(baseFile) // åˆ é™¤æ‰åŸæ¥çš„ç´¢å¼•æ–‡ä»¶
    
    swapFiles += file // åŠ å…¥å¾…æ¢å¤çš„.swapæ–‡ä»¶é›†åˆä¸­
    
    }
    
    }
    
    }
    
    // ä»å¾…æ¢å¤swapé›†åˆä¸­æ‰¾å‡ºé‚£äº›èµ·å§‹ä½ç§»å€¼å¤§äºminCleanedFileOffsetå€¼çš„æ–‡ä»¶ï¼Œç›´æ¥åˆ æ‰è¿™äº›æ— æ•ˆçš„.swapæ–‡ä»¶
    
    val (invalidSwapFiles, validSwapFiles) = swapFiles.partition(file =&gt; offsetFromFile(file) &gt;= minCleanedFileOffset)
    
    invalidSwapFiles.foreach { file =&gt;
    
    debug(s&quot;Deleting invalid swap file ${file.getAbsoluteFile} minCleanedFileOffset: $minCleanedFileOffset&quot;)
    
    val baseFile = new File(CoreUtils.replaceSuffix(file.getPath, SwapFileSuffix, &quot;&quot;))
    
    deleteIndicesIfExist(baseFile, SwapFileSuffix)
    
    Files.deleteIfExists(file.toPath)
    
    }
    
    // Now that we have deleted all .swap files that constitute an incomplete split operation, let's delete all .clean files
    
    // æ¸…é™¤æ‰€æœ‰å¾…åˆ é™¤æ–‡ä»¶é›†åˆä¸­çš„æ–‡ä»¶
    
    cleanFiles.foreach { file =&gt;
    
    debug(s&quot;Deleting stray .clean file ${file.getAbsolutePath}&quot;)
    
    Files.deleteIfExists(file.toPath)
    
    }
    
    // æœ€åè¿”å›å½“å‰æœ‰æ•ˆçš„.swapæ–‡ä»¶é›†åˆ
    
    validSwapFiles
    
    }
</code></pre><p>æ‰§è¡Œå®Œäº†removeTempFilesAndCollectSwapFilesé€»è¾‘ä¹‹åï¼Œæºç å¼€å§‹æ¸…ç©ºå·²æœ‰æ—¥å¿—æ®µé›†åˆï¼Œå¹¶é‡æ–°åŠ è½½æ—¥å¿—æ®µæ–‡ä»¶ã€‚è¿™å°±æ˜¯ç¬¬äºŒæ­¥ã€‚è¿™é‡Œè°ƒç”¨çš„ä¸»è¦æ–¹æ³•æ˜¯loadSegmentFilesã€‚</p><pre><code>   private def loadSegmentFiles(): Unit = {
    
    // æŒ‰ç…§æ—¥å¿—æ®µæ–‡ä»¶åä¸­çš„ä½ç§»å€¼æ­£åºæ’åˆ—ï¼Œç„¶åéå†æ¯ä¸ªæ–‡ä»¶
    
    for (file &lt;- dir.listFiles.sortBy(_.getName) if file.isFile) {
    
    if (isIndexFile(file)) { // å¦‚æœæ˜¯ç´¢å¼•æ–‡ä»¶
    
    val offset = offsetFromFile(file)
    
    val logFile = Log.logFile(dir, offset)
    
    if (!logFile.exists) { // ç¡®ä¿å­˜åœ¨å¯¹åº”çš„æ—¥å¿—æ–‡ä»¶ï¼Œå¦åˆ™è®°å½•ä¸€ä¸ªè­¦å‘Šï¼Œå¹¶åˆ é™¤è¯¥ç´¢å¼•æ–‡ä»¶
    
    warn(s&quot;Found an orphaned index file ${file.getAbsolutePath}, with no corresponding log file.&quot;)
    
    Files.deleteIfExists(file.toPath)
    
    }
    
    } else if (isLogFile(file)) { // å¦‚æœæ˜¯æ—¥å¿—æ–‡ä»¶
    
    val baseOffset = offsetFromFile(file)
    
    val timeIndexFileNewlyCreated = !Log.timeIndexFile(dir, baseOffset).exists()
    
    // åˆ›å»ºå¯¹åº”çš„LogSegmentå¯¹è±¡å®ä¾‹ï¼Œå¹¶åŠ å…¥segmentsä¸­
    
    val segment = LogSegment.open(dir = dir,
    
    baseOffset = baseOffset,
    
    config,
    
    time = time,
    
    fileAlreadyExists = true)
    
    try segment.sanityCheck(timeIndexFileNewlyCreated)
    
    catch {
    
    case _: NoSuchFileException =&gt;
    
    error(s&quot;Could not find offset index file corresponding to log file ${segment.log.file.getAbsolutePath}, &quot; +
    
    &quot;recovering segment and rebuilding index files...&quot;)
    
    recoverSegment(segment)
    
    case e: CorruptIndexException =&gt;
    
    warn(s&quot;Found a corrupted index file corresponding to log file ${segment.log.file.getAbsolutePath} due &quot; +
    
    s&quot;to ${e.getMessage}}, recovering segment and rebuilding index files...&quot;)
    
    recoverSegment(segment)
    
    }
    
    addSegment(segment)
    
    }
    
    }
    
    }

</code></pre><p>ç¬¬ä¸‰æ­¥æ˜¯å¤„ç†ç¬¬ä¸€æ­¥è¿”å›çš„æœ‰æ•ˆ.swapæ–‡ä»¶é›†åˆã€‚completeSwapOperationsæ–¹æ³•å°±æ˜¯åšè¿™ä»¶äº‹çš„ï¼š</p><pre><code>  private def completeSwapOperations(swapFiles: Set[File]): Unit = {
    
    // éå†æ‰€æœ‰æœ‰æ•ˆ.swapæ–‡ä»¶
    
    for (swapFile &lt;- swapFiles) {
    
    val logFile = new File(CoreUtils.replaceSuffix(swapFile.getPath, SwapFileSuffix, &quot;&quot;)) // è·å–å¯¹åº”çš„æ—¥å¿—æ–‡ä»¶
    
    val baseOffset = offsetFromFile(logFile) // æ‹¿åˆ°æ—¥å¿—æ–‡ä»¶çš„èµ·å§‹ä½ç§»å€¼
    
    // åˆ›å»ºå¯¹åº”çš„LogSegmentå®ä¾‹
    
    val swapSegment = LogSegment.open(swapFile.getParentFile,
    
    baseOffset = baseOffset,
    
    config,
    
    time = time,
    
    fileSuffix = SwapFileSuffix)
    
    info(s&quot;Found log file ${swapFile.getPath} from interrupted swap operation, repairing.&quot;)
    
    // æ‰§è¡Œæ—¥å¿—æ®µæ¢å¤æ“ä½œ
    
    recoverSegment(swapSegment)
    
    // We create swap files for two cases:
    
    // (1) Log cleaning where multiple segments are merged into one, and
    
    // (2) Log splitting where one segment is split into multiple.
    
    //
    
    // Both of these mean that the resultant swap segments be composed of the original set, i.e. the swap segment
    
    // must fall within the range of existing segment(s). If we cannot find such a segment, it means the deletion
    
    // of that segment was successful. In such an event, we should simply rename the .swap to .log without having to
    
    // do a replace with an existing segment.
    
    // ç¡®è®¤ä¹‹å‰åˆ é™¤æ—¥å¿—æ®µæ˜¯å¦æˆåŠŸï¼Œæ˜¯å¦è¿˜å­˜åœ¨è€çš„æ—¥å¿—æ®µæ–‡ä»¶
    
    val oldSegments = logSegments(swapSegment.baseOffset, swapSegment.readNextOffset).filter { segment =&gt;
    
    segment.readNextOffset &gt; swapSegment.baseOffset
    
    }
    
    // å°†ç”Ÿæˆçš„.swapæ–‡ä»¶åŠ å…¥åˆ°æ—¥å¿—ä¸­ï¼Œåˆ é™¤æ‰swapä¹‹å‰çš„æ—¥å¿—æ®µ
    
    replaceSegments(Seq(swapSegment), oldSegments.toSeq, isRecoveredSwapFile = true)
    
    }
    
    }

</code></pre><p>æœ€åä¸€æ­¥æ˜¯recoverLogæ“ä½œï¼š</p><pre><code> private def recoverLog(): Long = {
        // if we have the clean shutdown marker, skip recovery
        // å¦‚æœä¸å­˜åœ¨ä»¥.kafka_cleanshutdownç»“å°¾çš„æ–‡ä»¶ã€‚é€šå¸¸éƒ½ä¸å­˜åœ¨
        if (!hasCleanShutdownFile) {
          // è·å–åˆ°ä¸Šæ¬¡æ¢å¤ç‚¹ä»¥å¤–çš„æ‰€æœ‰unflushedæ—¥å¿—æ®µå¯¹è±¡
          val unflushed = logSegments(this.recoveryPoint, Long.MaxValue).toIterator
          var truncated = false
    
    
          // éå†è¿™äº›unflushedæ—¥å¿—æ®µ
          while (unflushed.hasNext &amp;&amp; !truncated) {
            val segment = unflushed.next
            info(s&quot;Recovering unflushed segment ${segment.baseOffset}&quot;)
            val truncatedBytes =
              try {
                // æ‰§è¡Œæ¢å¤æ—¥å¿—æ®µæ“ä½œ
                recoverSegment(segment, leaderEpochCache)
              } catch {
                case _: InvalidOffsetException =&gt;
                  val startOffset = segment.baseOffset
                  warn(&quot;Found invalid offset during recovery. Deleting the corrupt segment and &quot; +
                    s&quot;creating an empty one with starting offset $startOffset&quot;)
                  segment.truncateTo(startOffset)
              }
            if (truncatedBytes &gt; 0) { // å¦‚æœæœ‰æ— æ•ˆçš„æ¶ˆæ¯å¯¼è‡´è¢«æˆªæ–­çš„å­—èŠ‚æ•°ä¸ä¸º0ï¼Œç›´æ¥åˆ é™¤å‰©ä½™çš„æ—¥å¿—æ®µå¯¹è±¡
              warn(s&quot;Corruption found in segment ${segment.baseOffset}, truncating to offset ${segment.readNextOffset}&quot;)
              removeAndDeleteSegments(unflushed.toList, asyncDelete = true)
              truncated = true
            }
          }
        }
    
    
        // è¿™äº›éƒ½åšå®Œä¹‹åï¼Œå¦‚æœæ—¥å¿—æ®µé›†åˆä¸ä¸ºç©º
        if (logSegments.nonEmpty) {
          val logEndOffset = activeSegment.readNextOffset
          if (logEndOffset &lt; logStartOffset) { // éªŒè¯åˆ†åŒºæ—¥å¿—çš„LEOå€¼ä¸èƒ½å°äºLog Start Offsetå€¼ï¼Œå¦åˆ™åˆ é™¤è¿™äº›æ—¥å¿—æ®µå¯¹è±¡
            warn(s&quot;Deleting all segments because logEndOffset ($logEndOffset) is smaller than logStartOffset ($logStartOffset). &quot; +
              &quot;This could happen if segment files were deleted from the file system.&quot;)
            removeAndDeleteSegments(logSegments, asyncDelete = true)
          }
        }
    
    
        // è¿™äº›éƒ½åšå®Œä¹‹åï¼Œå¦‚æœæ—¥å¿—æ®µé›†åˆä¸ºç©ºäº†
        if (logSegments.isEmpty) {
        // è‡³å°‘åˆ›å»ºä¸€ä¸ªæ–°çš„æ—¥å¿—æ®µï¼Œä»¥logStartOffsetä¸ºæ—¥å¿—æ®µçš„èµ·å§‹ä½ç§»ï¼Œå¹¶åŠ å…¥æ—¥å¿—æ®µé›†åˆä¸­
          addSegment(LogSegment.open(dir = dir,
            baseOffset = logStartOffset,
            config,
            time = time,
            fileAlreadyExists = false,
            initFileSize = this.initFileSize,
            preallocate = config.preallocate))
        }
    
    
        // æ›´æ–°ä¸Šæ¬¡æ¢å¤ç‚¹å±æ€§ï¼Œå¹¶è¿”å›
        recoveryPoint = activeSegment.readNextOffset
        recoveryPoint
</code></pre><h2>æ€»ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘é‡ç‚¹å‘ä½ ä»‹ç»äº†Kafkaçš„Logæºç ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p><ol>
<li><strong>Logæ–‡ä»¶çš„æºç ç»“æ„</strong>ï¼šä½ å¯ä»¥çœ‹ä¸‹ä¸‹é¢çš„å¯¼å›¾ï¼Œå®ƒå±•ç¤ºäº†Logç±»æ–‡ä»¶çš„æ¶æ„ç»„æˆï¼Œä½ è¦é‡ç‚¹æŒæ¡Logç±»åŠå…¶ç›¸å…³æ–¹æ³•ã€‚</li>
<li><strong>åŠ è½½æ—¥å¿—æ®µæœºåˆ¶</strong>ï¼šæˆ‘ç»“åˆæºç é‡ç‚¹åˆ†æäº†æ—¥å¿—åœ¨åˆå§‹åŒ–æ—¶æ˜¯å¦‚ä½•åŠ è½½æ—¥å¿—æ®µçš„ã€‚å‰é¢è¯´è¿‡äº†ï¼Œæ—¥å¿—æ˜¯æ—¥å¿—æ®µçš„å®¹å™¨ï¼Œå¼„æ˜ç™½å¦‚ä½•åŠ è½½æ—¥å¿—æ®µæ˜¯åç»­å­¦ä¹ æ—¥å¿—æ®µç®¡ç†çš„å‰ææ¡ä»¶ã€‚</li>
</ol><p><img src="https://static001.geekbang.org/resource/image/dd/fc/dd2bf4882021d969accb14c0017d9dfc.jpg?wh=2543*3019" alt=""></p><p>æ€»çš„æ¥è¯´ï¼Œè™½ç„¶æ´‹æ´‹æ´’æ´’å‡ åƒå­—ï¼Œä½†æˆ‘ä¹Ÿåªè®²äº†æœ€é‡è¦çš„éƒ¨åˆ†ã€‚æˆ‘å»ºè®®ä½ å¤šçœ‹å‡ éLog.scalaä¸­åŠ è½½æ—¥å¿—æ®µçš„ä»£ç ï¼Œè¿™å¯¹åé¢æˆ‘ä»¬ç†è§£Kafka Brokerç«¯æ—¥å¿—æ®µç®¡ç†åŸç†å¤§æœ‰è£¨ç›Šã€‚åœ¨ä¸‹èŠ‚è¯¾ï¼Œæˆ‘ä¼šç»§ç»­è®¨è®ºæ—¥å¿—éƒ¨åˆ†çš„æºç ï¼Œå¸¦ä½ å­¦ä¹ å¸¸è§çš„Kafkaæ—¥å¿—æ“ä½œã€‚</p><h2>è¯¾åè®¨è®º</h2><p>Logæºç ä¸­æœ‰ä¸ªmaybeIncrementHighWatermarkæ–¹æ³•ï¼Œä½ èƒ½è¯´è¯´å®ƒçš„å®ç°åŸç†å—ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºç•…æ‰€æ¬²è¨€ï¼Œè·Ÿæˆ‘äº¤æµè®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚</p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æ›¾è½¼éºŸ</span>
  </div>
  <div class="_2_QraFYR_0">å…ˆå›ç­”è€å¸ˆçš„é—®é¢˜maybeIncrementHighWatermarkçš„å®ç°ï¼š<br>ã€é¦–å…ˆéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ä¸ªå†…å®¹ã€‘ï¼š<br>1ã€è¿™ä¸ªæ–¹æ³•æ˜¯é€šè¿‡leaderLogè¿™ä¸ªå®ä¾‹å»è°ƒç”¨çš„ï¼Œå½“HWæ›´æ–°çš„æ—¶å€™followerå°±ä¼šæ›´æ–°è‡ªèº«çš„HWã€‚<br><br>2ã€leaderLog æ˜¯åœ¨Partition.scalaä¸­çš„ï¼Œæ˜¯åˆ†åŒºç»´åº¦çš„æ¦‚å¿µã€‚<br><br>3ã€maybeIncrementHighWatermarkçš„å…¥å‚æ˜¯newHighWatermarkï¼Œæ˜¯æ–°çš„HWæ ‡è®°ï¼Œä½†æ˜¯å¯èƒ½æ˜¯æ›´æ–°ä¹Ÿå¯èƒ½ä¸æ˜¯ã€‚<br><br>ã€ä¸‹é¢æ¥è¯´å®ç°ã€‘<br>åœ¨maybeIncrementHighWatermarkä¸­ä¼šå…ˆå»åˆ¤æ–­æ–°çš„newHighWatermark.messageOffsetæ˜¯å¦å¤§äºå½“å‰çš„LEOï¼Œå¦‚æœå¤§äºè‚¯å®šä¸åˆç†ï¼Œå› ä¸ºæ–°çš„HWä¸å¯èƒ½è·‘åœ¨LEOå‰é¢<br><br>ç„¶åè·å–å½“å‰é«˜æ°´ä½çš„åç§»é‡å’Œå…ƒæ•°æ®ã€‚å¦‚æœåç§»å…ƒæ•°æ®ä¸æ˜¯ï¼Œå·²çŸ¥ï¼Œå°†åœ¨ç´¢å¼•ä¸­æ‰§è¡ŒæŸ¥æ‰¾å¹¶ç¼“å­˜ç»“æœï¼Œå¹¶èµ‹å€¼ç»™oldHighWatermarkã€‚<br><br>æœ€åè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœï¼ˆoldHighWatermark.messageOffsetå°äºnewHighWatermark.messageOffsetï¼‰<br>åˆ™è·Ÿæ–°HWçš„å…ƒæ•°æ®<br><br>æˆ–è€…å¦‚æœï¼ˆoldHighWatermark.messageOffset ç­‰äº newHighWatermark.messageOffsetï¼‰å¹¶ä¸”å½“å‰segmentBaseOffsetå°äºnewHighWatermark.segmentBaseOffset<br>ä¹Ÿä¼šæ›´æ–°HWçš„å…ƒæ•°æ®<br><br>æœ€åè¿™ä¸ªè¿‡ç¨‹æ˜¯åœ¨synchronizedçš„åŒ…å›´ä¸‹è¿›è¡Œçš„ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ğŸ‘ğŸ‘ğŸ‘</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-04-18 22:13:51</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>èƒ¡å¤•</span>
  </div>
  <div class="_2_QraFYR_0">ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚æˆ‘æ¥å…¬å¸ƒä¸ŠèŠ‚è¯¾çš„â€œè¯¾åè®¨è®ºâ€é¢˜ç­”æ¡ˆå•¦ï½<br><br>ä¸ŠèŠ‚è¯¾ï¼Œå’±ä»¬é‡ç‚¹äº†è§£äº†æ—¥å¿—æ®µå¯¹è±¡ï¼Œè¯¾åæˆ‘è®©ä½ æ€è€ƒä¸‹å¦‚æœç»™å®šä½ç§»å€¼è¿‡å¤§truncateToæ–¹æ³•çš„å®ç°ã€‚å…³äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘çš„çœ‹æ³•å¾ˆç®€å•ã€‚å¦‚æœtruncateToçš„è¾“å…¥offsetè¿‡å¤§ä»¥è‡³äºè¶…è¿‡äº†è¯¥æ—¥å¿—æ®µå½“å‰æœ€å¤§çš„æ¶ˆæ¯ä½ç§»å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•ä¸ä¼šæ‰§è¡Œä»»ä½•æˆªæ–­æ“ä½œï¼Œå› ä¸ºä¸ä¼šæœ‰æœºä¼šè°ƒç”¨log.truncateTo(mapping.position)<br><br>okayï¼Œä½ æ˜¯æ€ä¹ˆè€ƒè™‘çš„å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä¸€èµ·è®¨è®ºä¸‹ã€‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-04-23 10:32:04</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src=""
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_47baf9</span>
  </div>
  <div class="_2_QraFYR_0">åœ¨trunkåˆ†æ”¯æäº¤è®°å½•ï¼ˆcommitId=db1f581da7f3440cfd5be93800b4a9a2d7327a35ï¼‰ä¸Š Log.scalaå·²ç»åœ¨2021-08-13 7:10è¢«é‡å‘½åä¸ºUnifiedLog.scalaï¼Œå¸Œæœ›å¤§å®¶çœ‹ä¸“æ çš„æ—¶å€™æ³¨æ„ç‚¹</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ˜¯å•Šï¼Œæ„Ÿæ…¨Kafkaä»£ç ä¾ç„¶åœ¨ä¿æŒæ´»åŠ›åœ°æ›´æ–°ç€</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-09-20 17:05:06</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/01/46/faf75ba6.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>èŠ±å¼€æˆæµ·</span>
  </div>
  <div class="_2_QraFYR_0">æœ‰ä¸¤ä¸ªç–‘é—®è¯·è€å¸ˆå¸®å¿™çœ‹ä¸‹ï¼š<br>1ã€ä¸ºä»€ä¹ˆbrokeré‡å¯è¦é‡å»ºæ‰€æœ‰çš„ç´¢å¼•æ–‡ä»¶ï¼Ÿ<br>2ã€LogSegmentçš„log: FileRecords è¡¨ç¤ºçš„æ˜¯æ¶ˆæ¯å†…å®¹ï¼ŒåŠ è½½æ—¥å¿—æ®µæ—¶å€™ï¼Œä»€ä¹ˆæœºåˆ¶ä½¿æœ‰é™å†…å­˜åŠ è½½æ‰€æœ‰segmentï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: 1. è¿™äº›å†™çš„ç¡®å®æœ‰ç‚¹é—®é¢˜ã€‚åº”è¯¥æ˜¯åˆ é™¤å­¤ç«‹çš„ç´¢å¼•æ–‡ä»¶<br>2. åº”è¯¥è¯´æ˜¯JVM GCæœºåˆ¶ï¼šï¼‰ FileRocordsè¡¨ç¤ºæ—¥å¿—æ®µå¯¹è±¡çš„åº•å±‚ç‰©ç†æ–‡ä»¶ï¼Œå·²åŠ è½½å®Œæˆçš„æ—¥å¿—æ®µå¯¹è±¡å¯¹åº”çš„FileRecordsæ˜¯å¯ä»¥è¢«GCçš„ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-04-30 23:39:30</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/15/de/65/51147fb6.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>åŒ—çº¬8â„ƒ</span>
  </div>
  <div class="_2_QraFYR_0">å¤ªéš¾äº†ğŸ˜‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å“ˆå“ˆï¼ŒåšæŒåšæŒï¼</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-04-16 09:24:24</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/33/78/cf112171.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ä½ ç…å•¥ï¼Ÿæ²¡è§è¿‡è¿™ä¹ˆå¸…çš„å“ˆå£«å¥‡å—</span>
  </div>
  <div class="_2_QraFYR_0">æ¸…é™¤ä¸Šä¸€æ¬¡failureç•™ä¸‹çš„æ–‡ä»¶ï¼Œè¿™ä¸ªfailureæƒ…å†µæ˜¯æŒ‡ä»€ä¹ˆæƒ…å†µä¸‹å‘ç”Ÿçš„failureæƒ…å†µï¼Œæ˜¯èŠ‚ç‚¹æŒ‚äº†é‡å¯æ—¶çš„failureè¿˜æ˜¯å…¶ä»–æƒ…å†µï¼Œèƒ½ä¸¾ä¸ªğŸŒ°å—</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: brokerç¢°åˆ°çš„ä»»ä½•å¤±è´¥</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-05-08 11:16:21</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/18/22/d7/ae0ed31f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>äº‘è¶…</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œé—®ä¸€ä¸ªè¯­æ³•ä¸Šçš„é—®é¢˜ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ç‰‡æ®µä¸­çš„locally{xxx}  ï¼Œè¿™ä¸ªlocallyçš„ä½œç”¨æ˜¯ä»€ä¹ˆå•Šï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ç±»ä¼¼äºjavaä¸­çš„é™æ€ä»£ç å—ï¼Œå¤šç”¨äºç±»æˆ–Objectåˆå§‹åŒ–æ‰§è¡Œä¸€æ®µä»£ç ä¹‹ç”¨</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-10-19 23:39:16</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/1a/9a/25/3e5e942b.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å¼ å­æ¶µ</span>
  </div>
  <div class="_2_QraFYR_0"> def maybeIncrementHighWatermark(newHighWatermark: LogOffsetMetadata): Option[LogOffsetMetadata] = {<br>    if (newHighWatermark.messageOffset &gt; logEndOffset)  &#47;&#47;å¯¹é«˜æ°´ä½çš„å€¼è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœnewé«˜æ°´ä½å¤§äºLEOï¼Œåˆ™æŠ¥é”™<br>      throw new IllegalArgumentException(s&quot;High watermark $newHighWatermark update exceeds current &quot; +<br>        s&quot;log end offset $logEndOffsetMetadata&quot;)<br>    lock.synchronized {<br>      val oldHighWatermark = fetchHighWatermarkMetadata<br>      if (oldHighWatermark.messageOffset &lt; newHighWatermark.messageOffset ||<br>        (oldHighWatermark.messageOffset == newHighWatermark.messageOffset &amp;&amp; oldHighWatermark.onOlderSegment(newHighWatermark))) {<br>        &#47;&#47;è‹¥oldé«˜æ°´ä½offsetå°äºnewé«˜æ°´ä½offset<br>        &#47;&#47; æˆ–è€…ï¼ˆoldé«˜æ°´ä½offsetç­‰äºnewé«˜æ°´ä½offsetï¼Œä¸”å½“å‰segmentBaseOffsetå°äºnewé«˜æ°´ä½çš„segmentBaseOffsetï¼‰<br>        &#47;&#47;åˆ™æ›´æ–°é«˜æ°´ä½å€¼<br>        updateHighWatermarkMetadata(newHighWatermark)<br>        Some(oldHighWatermark)<br>      } else {<br>        None<br>      }<br>    }<br>  }</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-07-24 13:35:41</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/15/67/49/864dba17.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ä¸œé£ç¬¬ä¸€æ</span>
  </div>
  <div class="_2_QraFYR_0">å…ˆå›ç­”è€å¸ˆçš„é—®é¢˜ï¼š<br>å¦‚æœHWå¤§äºLEOï¼Œé‚£ä¹ˆç›´æ¥æŠ›å‡ºIllegalArgumentExceptionå¼‚å¸¸ï¼›<br>å¦åˆ™åšå¦‚ä¸‹æ“ä½œï¼š<br>1. æ‹¿åˆ°HWçš„LogOffsetMetadata<br>2. å½“å­˜åœ¨ä»¥ä¸‹æƒ…å†µçš„æ—¶å€™ï¼Œæ›´æ–°HWï¼Œå¹¶ä¸”è¿”å›æ›´æ–°ä¹‹å‰çš„HW<br>	a. old HWçš„ä½ç§»å°äºnew HW<br>	b. old HWçš„ä½ç§»ç­‰äºnew HW, å¹¶ä¸”old HWçš„åŸºå‡†ä½ç§»å°äºnew HWçš„åŸºå‡†ä½ç§»ï¼Œè¿™ç§æƒ…å†µè¯´æ˜ï¼Œnew HWå¯¹åº”çš„segmentæ˜¯ä¸€ä¸ªæ–°çš„segment<br>3. å¦‚æœold HWçš„ä½ç§»å¤§äºç­‰äºnew HWï¼Œç›´æ¥è¿”å›None<br><br>å†è¯·æ•™è€å¸ˆä¸€ä¸ªé—®é¢˜ï¼ŒLeaderEpochFileCacheä¸­æœ‰è¿™æ ·ä¸€è¡Œä»£ç ï¼š<br>private var epochs: ArrayBuffer[EpochEntry] = inWriteLock(lock) ......<br>å…¶å®å°±æ˜¯åˆå§‹åŒ–epochsï¼Œæˆ‘ç†è§£è¿™è¾¹æ˜¯è¯»leader-epoch-checkpointæ–‡ä»¶ï¼Œä¸ºä»€ä¹ˆè¦ç”¨inWriteLockå†™é”ï¼Œè€Œä¸æ˜¯inReadLockã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: é¦–å…ˆæˆ‘è¦å£°æ˜ï¼Œæºç å†™å¾—ä¹Ÿä¸ä¸€å®šå°±æ˜¯å¯¹çš„ï¼æˆ‘ä»¬å®Œå…¨å¯ä»¥é’ˆå¯¹æºç ä¸­å¯èƒ½çš„é—®é¢˜å¼€æ”¾è®¨è®ºå“ˆã€‚<br><br>åœ¨LeaderEpochFileCacheä¸­ï¼Œé’ˆå¯¹epochsçš„æ›´æ–°å’Œèµ‹å€¼å…¨éƒ¨éƒ½åœ¨write lockä¸‹ï¼Œè¯»å–epochç”¨read lockã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-04-26 17:23:37</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æ›¾è½¼éºŸ</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆä¸‹é¢æˆ‘æƒ³é—®ä¸€ä¸‹æˆ‘çš„ä¸€äº›é—®é¢˜ï¼š<br>1ã€ä¸ºä»€ä¹ˆè¦éå†ä¸¤æ¬¡æ–‡ä»¶è·¯å¾„å‘¢ï¼Ÿæˆ‘çœ‹äº†ä¸€ä¸‹ï¼Œå¦‚æœåœ¨åˆ é™¤çš„æ—¶å€™é¡ºä¾¿å»åŠ è½½segmentä¼šæœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿè¿™æ ·æ˜¯å¦å¯ä»¥æé«˜åŠ è½½æ•ˆç‡å‘¢ï¼Ÿ<br>2ã€æˆ‘çœ‹äº†ä¸€ä¸‹åœ¨removeTempFilesAndCollectSwapFilesæ–¹æ³•ä¸­minCleanedFileOffsetæ˜¯ä»æ–‡ä»¶åfilenameä¸Šé¢è¯»å–çš„ï¼Œå¦‚æœæˆ‘ä¿®æ”¹äº†æ–‡ä»¶åçš„offsetå¤§å°ä¼šå‡ºç°ä»€ä¹ˆæ„æƒ³ä¸åˆ°çš„æƒ…å†µå‘¢ï¼Ÿ<br>3ã€æˆ‘å‘ç°segmentsæ˜¯ä½¿ç”¨ConcurrentNavigableMapï¼Œè€Œè¿™é‡Œçš„ConcurrentNavigableMapæ˜¯ä½¿ç”¨JDKçš„ConcurrentSkipListMapï¼Œä½¿ç”¨è·³è¡¨çš„ç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨offsetèŒƒå›´æŸ¥è¯¢segmentsä¸­çš„å¯¹è±¡å—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: 1. å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘è§‰å¾—ä¹Ÿæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚æˆ‘è§‰å¾—ä½œè€…æ›´å¤šæ˜¯ä¸ºäº†æŠŠä¸åŒé€»è¾‘è¿›è¡Œäº†åˆ†ç»„å¯¼è‡´éå†å¤šæ¬¡<br>2. å¯èƒ½é€ æˆBrokerçš„å´©æºƒï¼Œæ— æ³•å¯åŠ¨ã€‚å› ä¸ºæˆ‘ä»¬å…¬å¸æœ‰å°ä¼™ä¼´è¿™ä¹ˆå¹²è¿‡ï¼šï¼ˆ<br>3. å¯¹çš„ï¼Œè¿™æ ·å¯ä»¥å¿«é€Ÿæ ¹æ®ç»™å®šoffsetæ‰¾åˆ°å¯¹åº”çš„ä¸€ä¸Šä¸€ä¸‹æ—¥å¿—æ®µå¯¹è±¡</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-04-18 22:27:55</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/14/5b/b6/f404b490.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æˆ‘æ˜¯å°é˜Ÿé•¿</span>
  </div>
  <div class="_2_QraFYR_0">   &#47;&#47; è¿™äº›éƒ½åšå®Œä¹‹åï¼Œå¦‚æœæ—¥å¿—æ®µé›†åˆä¸ä¸ºç©º<br>   &#47;&#47; éªŒè¯åˆ†åŒºæ—¥å¿—çš„LEOå€¼ä¸èƒ½å°äºLog Start Offsetå€¼ï¼Œå¦åˆ™åˆ é™¤è¿™äº›æ—¥å¿—æ®µå¯¹è±¡<br><br><br>æƒ³é—®ä¸‹ä»€ä¹ˆæ—¶å€™æ‰ä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å½“åº•å±‚æ—¥å¿—æ–‡ä»¶è¢«åˆ é™¤æˆ–æŸåçš„è¯å°±å¯èƒ½å‡ºç°è¿™ç§æƒ…å†µï¼Œå› ä¸ºæ— æ³•è¯»å–æ–‡ä»¶å»è·å–LEOäº†ã€‚ä½ å¯ä»¥ç”¨2.0ç‰ˆæœ¬åšä¸ªè¯•éªŒï¼š<br>1. å‘æ¶ˆæ¯åˆ°åˆ†åŒºæ—¥å¿—<br>2. ä½¿ç”¨Adminçš„DeleteRecordså‘½ä»¤é©±åŠ¨Log start offsetå‰è¿›<br>3. å…³é—­Broker<br>4. åˆ é™¤æ—¥å¿—è·¯å¾„<br>5. é‡å¯Broker</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-04-17 16:00:30</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/14/5b/b6/f404b490.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æˆ‘æ˜¯å°é˜Ÿé•¿</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œæ‰¾å‡ºéœ€è¦æ¢å¤çš„swapï¼Œç›´æ¥æ¢å¤å®Œæˆä¸å°±è¡Œäº†ä¹ˆï¼Œä¸ºä»€ä¹ˆè¿˜æœ‰ä¸‹é¢çš„æ“ä½œå‘¢ï¼Ÿ<br><br><br>&#47;&#47; We create swap files for two cases:<br>&#47;&#47; (1) Log cleaning where multiple segments are merged into one, and<br>&#47;&#47; (2) Log splitting where one segment is split into multiple.<br>&#47;&#47;<br>&#47;&#47; Both of these mean that the resultant swap segments be composed of the original set, i.e. the swap segment<br>&#47;&#47; must fall within the range of existing segment(s). If we cannot find such a segment, it means the deletion<br>&#47;&#47; of that segment was successful. In such an event, we should simply rename the .swap to .log without having to<br>&#47;&#47; do a replace with an existing segment.<br>&#47;&#47; ç¡®è®¤ä¹‹å‰åˆ é™¤æ—¥å¿—æ®µæ˜¯å¦æˆåŠŸï¼Œæ˜¯å¦è¿˜å­˜åœ¨è€çš„æ—¥å¿—æ®µæ–‡ä»¶<br>val oldSegments = logSegments(swapSegment.baseOffset, swapSegment.readNextOffset).filter { segment =&gt;<br>segment.readNextOffset &gt; swapSegment.baseOffset<br>}<br>&#47;&#47; å¦‚æœå­˜åœ¨ï¼Œç›´æ¥æŠŠ.swapæ–‡ä»¶é‡å‘½åæˆ.log<br>replaceSegments(Seq(swapSegment), oldSegments.toSeq, isRecoveredSwapFile = </div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: é¦–å…ˆï¼Œä¸ç®¡æ˜¯å¦è¦è¿‡æ»¤å‡ºç¬¦åˆæ¡ä»¶çš„oldSegmentsï¼Œå›å¤ä¹‹åéƒ½è¦è¿›è¡Œæ›¿æ¢ï¼Œè¿™ä¸ªä½ å®é™…ä¸Šè¿™æ˜¯å› ä¸ºå‡çº§Brokerç‰ˆæœ¬è€Œåšçš„é˜²å¾¡æ€§ç¼–ç¨‹ã€‚åœ¨è€çš„ç‰ˆæœ¬ä¸­ï¼Œä»£ç å†™å…¥æ¶ˆæ¯åå¹¶ä¸ä¼šå¯¹ä½ç§»å€¼è¿›è¡Œæ ¡éªŒã€‚å› æ­¤log cleanerè€ä»£ç å¯èƒ½å†™å…¥ä¸€ä¸ªéå¸¸å¤§çš„ä½ç§»å€¼ï¼ˆå¤§äºInt.MAX_VALUEï¼‰ã€‚å½“brokerå‡çº§åï¼Œè¿™äº›æ—¥å¿—æ®µå°±ä¸èƒ½æ­£å¸¸è¢«compactäº†ï¼Œå› ä¸ºä½ç§»å€¼è¶Šç•Œäº†ï¼ˆæ–°ç‰ˆæœ¬åŠ å…¥äº†ä½ç§»æ ¡éªŒï¼‰<br><br>ä»£ç éœ€è¦å»æœå¯»åœ¨swap start offsetå’Œswap LEOä¹‹é—´çš„æ‰€æœ‰æ—¥å¿—æ®µå¯¹è±¡ï¼Œä½†è¿™è¿˜ä¸å¤Ÿï¼Œè¿˜è¦ä¿è¯è¿™äº›æ—¥å¿—æ®µçš„LEOæ¯”swapçš„base offsetå¤§æ‰è¡Œæ˜¯åŒæ„çš„å§ï¼Ÿå¦åˆ™</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-04-17 15:36:59</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/a0/cb/aab3b3e7.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å¼ ä¸‰ä¸°</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆèƒ½å¦è§£é‡Šä¸‹ä¸ºä½•åŠ è½½å®Œæ—¥å¿—æ®µè¿˜è¦æ¢å¤æ—¥å¿—æ®µå‘¢ï¼Ÿ åŠ è½½éš¾é“ä¸æ˜¯åŠ è½½äº†æ‰€æœ‰æ—¥å¿—æ®µä¹ˆï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-04-10 10:19:06</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/28/d9/be/2af79055.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>loserwangï¼Œno ssp</span>
  </div>
  <div class="_2_QraFYR_0">maybeIncrementHighWatermarkç”¨åˆ°äº†lock, çœ‹æ³¨é‡Šæ˜¯å¯¹logçš„æ‰€æœ‰updateéƒ½ç”¨è¿™ä¸ªé”ï¼Œæ˜¯ä¸æ˜¯é”çš„ç²’åº¦æ¯”è¾ƒé«˜ï¼Œè€Œä¸”è¯»çš„æ—¶å€™ä¸ç”¨é”æ˜¯å¦ä¼šä¸ä¸€è‡´ï¼ˆpsï¼šå¯¹é”è¿™ä¸€å—ä¸€å‘ä¸æ¸…æ¥šï¼‰</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-12-03 17:32:02</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/27/00/f5/596e8e84.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ã€‚ã€‚ã€‚</span>
  </div>
  <div class="_2_QraFYR_0">æ¢å¤ç‚¹æ˜¯å•¥å•Š  æ–‡ä¸­å¥½åƒæ²¡æœ‰æåˆ°è€å¸ˆ<br></div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-07-19 19:45:33</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/19/f8/e0/d6e3cc8f.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>qgaye</span>
  </div>
  <div class="_2_QraFYR_0">&#47;&#47; ä»å¾…æ¢å¤swapé›†åˆä¸­æ‰¾å‡ºé‚£äº›èµ·å§‹ä½ç§»å€¼å¤§äºminCleanedFileOffsetå€¼çš„æ–‡ä»¶ï¼Œç›´æ¥åˆ æ‰è¿™äº›æ— æ•ˆçš„.swapæ–‡ä»¶<br>è¯·é—®ä¸ºä»€ä¹ˆè¦åˆ é™¤ä½ç§»å€¼å¤§äºminCleanedFileOffsetçš„æ–‡ä»¶å‘¢</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-22 01:59:41</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/11/be/7d/40f6361e.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>é‚“æ–Œ</span>
  </div>
  <div class="_2_QraFYR_0">ä½ å¥½ï¼Œæˆ‘çš„Windows10ç³»ç»Ÿåœ¨å¯åŠ¨æºç çš„æ—¶å€™å‡ºç°java.nio.file.AccessDeniedExceptionå¼‚å¸¸ï¼Œé”™è¯¯ä¿¡æ¯ï¼šError while writing to checkpoint file C:\tmp\kafka\kafka-logs\recovery-point-offset-checkpoint (kafka.server.LogDirFailureChannel)å’Œ<br>Failed to create or validate data directory C:\tmp\kafka-logs (kafka.server.LogDirFailureChannel)ã€‚<br>æˆ‘å·²ç»æ’æŸ¥äº†ç›®å½•å’Œæ–‡ä»¶çš„æƒé™éƒ½æ˜¯å®Œå…¨æ§åˆ¶ï¼Œç”šè‡³é‡è£…ç³»ç»Ÿéƒ½æ²¡æœ‰è§£å†³ï¼Œè¯·æ•™ä¸€ä¸‹ï¼Œè¿™ä¸ªé”™è¯¯è¿˜æœ‰ä»€ä¹ˆåŠæ³•è§£å†³å—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æœ€å¥½è¿˜æ˜¯åˆ«æ”¾åœ¨windowsä¸Šäº†ï¼Œæœ‰å„ç§å„æ ·çš„é—®é¢˜</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-05-12 09:14:08</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/19/aa/6b/ab9a072a.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å¯¹ä¸é”™</span>
  </div>
  <div class="_2_QraFYR_0">è¯·é—®åˆ†åŒºä¸Logä¹‹é—´çš„å…³ç³»æ˜¯ä¸€å¯¹å¤šå—?</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ä¸€å¯¹ä¸€ã€‚logä¸‹é¢åˆ†å¤šä¸ªsegment</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-09-25 17:37:16</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/76/53/21d62a23.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>é²Â·æœ¬</span>
  </div>
  <div class="_2_QraFYR_0">ç”¨æ³¨é‡Šçš„æ–¹å¼ç»™å‡ºæˆ‘çš„ç†è§£: <br><br>def maybeIncrementHighWatermark(newHighWatermark: LogOffsetMetadata): Option[LogOffsetMetadata] = {<br>    &#47;&#47;å¦‚æœæœŸæœ›è®¾ç½®çš„é«˜æ°´ä½offset &gt; endOffset æ— æ•ˆå€¼,æŠ›å‡ºå¼‚å¸¸<br>    if (newHighWatermark.messageOffset &gt; logEndOffset)<br>      throw new IllegalArgumentException(s&quot;High watermark $newHighWatermark update exceeds current &quot; +<br>        s&quot;log end offset $logEndOffsetMetadata&quot;)<br><br>    lock.synchronized {<br>      &#47;&#47;è·å–è€çš„é«˜æ°´ä½å…ƒæ•°æ®<br>      val oldHighWatermark = fetchHighWatermarkMetadata<br><br>      &#47;&#47; Ensure that the high watermark increases monotonically. We also update the high watermark when the new<br>      &#47;&#47; offset metadata is on a newer segment, which occurs whenever the log is rolled to a new segment.<br>      &#47;&#47;ä»¥ä¸‹åœºæ™¯ä¼šæ‰§è¡Œé«˜æ°´ä½å…ƒæ•°æ®çš„æ›´æ–°<br>      &#47;&#47;å¦‚æœè€çš„é«˜æ°´ä½offset &lt; æ–°çš„é«˜æ°´ä½offset æˆ–è€…<br>      &#47;&#47;è€çš„é«˜æ°´ä½offset == æ–°çš„é«˜æ°´ä½offset å¹¶ä¸” è€çš„é«˜æ°´ä½å…ƒæ•°æ®çš„baseoffå°äºæ–°çš„é«˜æ°´ä½å…ƒæ•°æ®çš„baseoffset(ä¹Ÿå°±æ˜¯è™½ç„¶é«˜æ°´ä½æ²¡å˜,ä½†æ˜¯æ—¥å¿—æ®µå‘ç”Ÿäº†æ»šåŠ¨)<br>      if (oldHighWatermark.messageOffset &lt; newHighWatermark.messageOffset ||<br>        (oldHighWatermark.messageOffset == newHighWatermark.messageOffset &amp;&amp; oldHighWatermark.onOlderSegment(newHighWatermark))) {<br>        updateHighWatermarkMetadata(newHighWatermark)<br>        Some(oldHighWatermark)<br>      } else {<br>        None<br>      }<br>    }<br>  }</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-08-25 16:04:36</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/1e/a6/3e/3d18f35a.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ä¸‰é¢—è±†å­</span>
  </div>
  <div class="_2_QraFYR_0">è¯·é—®ä¸€ä¸‹ï¼š<br>1ã€æ£€æŸ¥ç‚¹æ˜¯æ ¹æ®ä»€ä¹ˆä¾æ®æ¥å»ºç«‹çš„å‘¢ï¼Ÿæ˜¯å®šæ—¶ä»»åŠ¡ï¼Œè¿˜æ˜¯ä»€ä¹ˆã€‚<br>2ã€â€œunflushedæ—¥å¿—æ®µâ€è®°å½•çš„æ˜¯æœªæäº¤ä½ç§»çš„æ—¥å¿—å—ï¼Ÿå¦‚æœæ˜¯å·²ç»æäº¤ä½ç§»çš„æ—¥å¿—ï¼Œåˆ æ‰è¿™äº›æ—¥å¿—æ®µå¯¹è±¡ï¼Œä¸å°±æ˜ å°„ä¸åˆ°è¿™äº›æ—¥å¿—äº†å—ï¼Ÿå¦‚æœæ˜¯æœªæäº¤ä½ç§»çš„æ—¥å¿—ï¼Œé‚£å·²ç»æäº¤ä½ç§»çš„æ—¥å¿—ä¸€å®šåœ¨recoveryPointä¹‹å†…å—ï¼Œä¸ºä»€ä¹ˆï¼Ÿ<br>è°¢è°¢ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: 1ã€å®šæ—¶ä»»åŠ¡<br>2ã€unflushedè®°å½•çš„æ˜¯æœªå†™å…¥åˆ°æ£€æŸ¥ç‚¹æ–‡ä»¶çš„æ—¥å¿—æ®µã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2020-08-18 20:07:06</div>
  </div>
</div>
</div>
</li>
</ul>